import React, { useState, useEffect, useRef } from 'react';
import axios from 'axios';
import mammoth from 'mammoth';
import * as pdfjsLib from 'pdfjs-dist';
import html2pdf from 'html2pdf.js';
import { THEMES, getTheme } from './themes';

// Configure PDF.js worker (pdfjs-dist 5.x uses .mjs files)
pdfjsLib.GlobalWorkerOptions.workerSrc = `//unpkg.com/pdfjs-dist@${pdfjsLib.version}/build/pdf.worker.min.mjs`;

const API = process.env.REACT_APP_API_URL || 'http://localhost:8000/api';

// ==================== GLOBAL TOAST NOTIFICATION SYSTEM ====================
// Global toast function - can be called from anywhere
if (!window.showAppToast) {
  window.showAppToast = (message, type = 'info') => {
    window.dispatchEvent(new CustomEvent('app-toast', { detail: { message, type } }));
  };
}

// Smart toast that auto-detects message type
const showToast = (message) => {
  const msgLower = (message || '').toLowerCase();
  let type = 'info';

  if (msgLower.includes('error') || msgLower.includes('failed') || msgLower.includes('erro') ||
      msgLower.includes('please') || msgLower.includes('cannot') || msgLower.includes('invalid') ||
      msgLower.includes('required') || msgLower.includes('missing') || msgLower.includes('falha')) {
    type = 'error';
  } else if (msgLower.includes('success') || msgLower.includes('‚úÖ') || msgLower.includes('sent') ||
             msgLower.includes('created') || msgLower.includes('uploaded') || msgLower.includes('saved') ||
             msgLower.includes('approved') || msgLower.includes('deleted') || msgLower.includes('copied') ||
             msgLower.includes('enviado') || msgLower.includes('sucesso') || msgLower.includes('criado')) {
    type = 'success';
  }

  window.showAppToast(message, type);
};

const ToastContainer = () => {
  const [toasts, setToasts] = useState([]);

  useEffect(() => {
    const handleToast = (e) => {
      const { message, type } = e.detail;
      const id = Date.now();
      setToasts(prev => [...prev, { id, message, type }]);

      // Auto-remove after 5 seconds
      setTimeout(() => {
        setToasts(prev => prev.filter(t => t.id !== id));
      }, 5000);
    };

    window.addEventListener('app-toast', handleToast);
    return () => window.removeEventListener('app-toast', handleToast);
  }, []);

  const removeToast = (id) => {
    setToasts(prev => prev.filter(t => t.id !== id));
  };

  if (toasts.length === 0) return null;

  return (
    <div className="fixed top-4 right-4 z-[9999] flex flex-col gap-2">
      {toasts.map((toast) => {
        const bgColor = toast.type === 'success' ? 'bg-green-500' : toast.type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        const icon = toast.type === 'success' ? '‚úì' : toast.type === 'error' ? '‚úï' : '‚Ñπ';

        return (
          <div
            key={toast.id}
            className={`${bgColor} text-white px-6 py-4 rounded-lg shadow-xl flex items-center gap-3 max-w-md`}
            style={{ animation: 'slideIn 0.3s ease-out' }}
          >
            <span className="text-xl font-bold">{icon}</span>
            <span className="flex-1">{toast.message}</span>
            <button onClick={() => removeToast(toast.id)} className="text-white/80 hover:text-white text-xl font-bold ml-2">&times;</button>
          </div>
        );
      })}
      <style>{`
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `}</style>
    </div>
  );
};

// ==================== UTC DATE HELPER - NEW YORK TIMEZONE ====================
// All dates/times displayed in EST/EDT (America/New_York)
const NY_TIMEZONE = 'America/New_York';

// Parse dates from backend as UTC (backend sends UTC timestamps without 'Z' suffix)
const parseUTCDate = (dateStr) => {
  if (!dateStr) return null;
  // If the string doesn't have timezone info (no Z or +/-offset), treat it as UTC
  if (typeof dateStr === 'string' && !dateStr.endsWith('Z') && !dateStr.match(/[+-]\d{2}:\d{2}$/)) {
    return new Date(dateStr + 'Z');
  }
  return new Date(dateStr);
};

// Format a date string from backend to New York timezone display
const formatDateLocal = (dateStr, options = {}) => {
  if (!dateStr) return '-';
  const date = parseUTCDate(dateStr);
  if (isNaN(date.getTime())) return '-';
  return date.toLocaleDateString('en-US', { ...options, timeZone: NY_TIMEZONE });
};

// Format a datetime string from backend to New York timezone display
const formatDateTimeLocal = (dateStr) => {
  if (!dateStr) return '-';
  const date = parseUTCDate(dateStr);
  if (isNaN(date.getTime())) return '-';
  return date.toLocaleString('en-US', { timeZone: NY_TIMEZONE });
};

// Get current date in New York timezone (for form inputs)
const getNYDate = () => {
  return new Date().toLocaleDateString('en-US', { timeZone: NY_TIMEZONE });
};

// Get current datetime in New York timezone
const getNYDateTime = () => {
  return new Date().toLocaleString('en-US', { timeZone: NY_TIMEZONE });
};

// Get current date as ISO string in NY timezone (YYYY-MM-DD format)
const getNYDateISO = () => {
  const options = { timeZone: NY_TIMEZONE, year: 'numeric', month: '2-digit', day: '2-digit' };
  const parts = new Intl.DateTimeFormat('en-CA', options).formatToParts(new Date());
  const year = parts.find(p => p.type === 'year').value;
  const month = parts.find(p => p.type === 'month').value;
  const day = parts.find(p => p.type === 'day').value;
  return `${year}-${month}-${day}`;
};

// Extract date and time components in NY timezone from a UTC date string
// Returns { date: 'YYYY-MM-DD', time: 'HH:MM' } in NY timezone
const getDateTimePartsInNY = (dateStr) => {
  if (!dateStr) {
    // Return current date/time in NY
    const now = new Date();
    const dateOpts = { timeZone: NY_TIMEZONE, year: 'numeric', month: '2-digit', day: '2-digit' };
    const timeOpts = { timeZone: NY_TIMEZONE, hour: '2-digit', minute: '2-digit', hour12: false };
    const dateParts = new Intl.DateTimeFormat('en-CA', dateOpts).formatToParts(now);
    const timeParts = new Intl.DateTimeFormat('en-GB', timeOpts).formatToParts(now);
    const year = dateParts.find(p => p.type === 'year').value;
    const month = dateParts.find(p => p.type === 'month').value;
    const day = dateParts.find(p => p.type === 'day').value;
    const hour = timeParts.find(p => p.type === 'hour').value;
    const minute = timeParts.find(p => p.type === 'minute').value;
    return { date: `${year}-${month}-${day}`, time: `${hour}:${minute}` };
  }
  // Parse the date as UTC
  const utcDate = parseUTCDate(dateStr);
  // Format in NY timezone
  const dateOpts = { timeZone: NY_TIMEZONE, year: 'numeric', month: '2-digit', day: '2-digit' };
  const timeOpts = { timeZone: NY_TIMEZONE, hour: '2-digit', minute: '2-digit', hour12: false };
  const dateParts = new Intl.DateTimeFormat('en-CA', dateOpts).formatToParts(utcDate);
  const timeParts = new Intl.DateTimeFormat('en-GB', timeOpts).formatToParts(utcDate);
  const year = dateParts.find(p => p.type === 'year').value;
  const month = dateParts.find(p => p.type === 'month').value;
  const day = dateParts.find(p => p.type === 'day').value;
  const hour = timeParts.find(p => p.type === 'hour').value;
  const minute = timeParts.find(p => p.type === 'minute').value;
  return { date: `${year}-${month}-${day}`, time: `${hour}:${minute}` };
};

// Convert NY timezone date/time parts to UTC ISO string for backend
// Takes { date: 'YYYY-MM-DD', time: 'HH:MM' } in NY timezone and returns UTC datetime string
const convertNYToUTC = (datePart, timePart) => {
  // Create a date string that will be interpreted as NY time
  const nyDateTimeStr = `${datePart}T${timePart || '17:00'}:00`;
  // Create date in NY timezone using Intl API
  const formatter = new Intl.DateTimeFormat('en-US', {
    timeZone: NY_TIMEZONE,
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
  });
  // Parse the NY time and convert to UTC
  // We need to find the UTC time that corresponds to this NY time
  const [year, month, day] = datePart.split('-').map(Number);
  const [hour, minute] = (timePart || '17:00').split(':').map(Number);

  // Create a date object and adjust for NY timezone offset
  // First, create a rough date to determine the offset
  const roughDate = new Date(year, month - 1, day, hour, minute, 0);
  const nyFormatted = formatter.format(roughDate);

  // Use a more reliable approach: create the date and find when it matches NY time
  // Try different UTC times until we find one that displays as our target NY time
  const targetNY = `${datePart} ${timePart || '17:00'}`;

  // Start with a guess (NY is UTC-5 or UTC-4 depending on DST)
  let testDate = new Date(Date.UTC(year, month - 1, day, hour + 5, minute, 0));

  // Check if this gives us the right NY time, adjust if needed
  const checkFormatter = new Intl.DateTimeFormat('en-CA', {
    timeZone: NY_TIMEZONE,
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', hour12: false
  });

  // Try offsets from +4 to +6 hours (covers EST and EDT)
  for (let offset = 4; offset <= 6; offset++) {
    testDate = new Date(Date.UTC(year, month - 1, day, hour + offset, minute, 0));
    const testParts = checkFormatter.formatToParts(testDate);
    const testYear = testParts.find(p => p.type === 'year').value;
    const testMonth = testParts.find(p => p.type === 'month').value;
    const testDay = testParts.find(p => p.type === 'day').value;
    const testHour = testParts.find(p => p.type === 'hour').value;
    const testMinute = testParts.find(p => p.type === 'minute').value;
    const testNY = `${testYear}-${testMonth}-${testDay} ${testHour}:${testMinute}`;
    if (testNY === targetNY) {
      // Found the right UTC time
      return testDate.toISOString().slice(0, 19); // Remove 'Z' and milliseconds
    }
  }

  // Fallback: return the original string (shouldn't happen)
  return nyDateTimeStr;
};

// ==================== PDF HASH UTILITIES ====================
// Calculate SHA-256 hash of an ArrayBuffer using Web Crypto API
const calculateSHA256 = async (arrayBuffer) => {
  const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
};

// Generate PDF from HTML content and return both blob and hash
// Uses a visible iframe approach for more reliable rendering
const generatePdfWithHash = async (htmlContent, filename, options = {}) => {
  const defaultOptions = {
    margin: [10, 10, 10, 10],
    filename: filename || 'document.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: {
      scale: 2,
      useCORS: true,
      allowTaint: true,
      letterRendering: true,
      logging: false,
      windowWidth: 816, // 8.5in at 96dpi
      windowHeight: 1056 // 11in at 96dpi
    },
    jsPDF: {
      unit: 'mm',
      format: 'letter',
      orientation: 'portrait'
    },
    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
  };

  const mergedOptions = { ...defaultOptions, ...options };

  // Create a temporary iframe for more reliable rendering
  // Iframes render content more reliably than hidden divs
  const iframe = document.createElement('iframe');
  iframe.style.position = 'fixed';
  iframe.style.left = '0';
  iframe.style.top = '0';
  iframe.style.width = '8.5in';
  iframe.style.height = '11in';
  iframe.style.border = 'none';
  iframe.style.opacity = '0.01'; // Nearly invisible but still renders
  iframe.style.pointerEvents = 'none';
  iframe.style.zIndex = '-9999';
  document.body.appendChild(iframe);

  try {
    // Write content to iframe
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    iframeDoc.open();
    iframeDoc.write(htmlContent);
    iframeDoc.close();

    // Wait for iframe content to load
    await new Promise(resolve => {
      if (iframeDoc.readyState === 'complete') {
        resolve();
      } else {
        iframe.onload = resolve;
        setTimeout(resolve, 3000); // Fallback timeout
      }
    });

    // Wait for all images in iframe to load
    const images = iframeDoc.querySelectorAll('img');
    if (images.length > 0) {
      await Promise.all(Array.from(images).map(img => {
        return new Promise((resolve) => {
          if (img.complete && img.naturalHeight !== 0) {
            resolve();
          } else {
            img.onload = resolve;
            img.onerror = () => {
              console.warn('Image failed to load:', img.src?.substring(0, 100));
              resolve();
            };
            setTimeout(resolve, 5000);
          }
        });
      }));
    }

    // Extra delay for rendering
    await new Promise(resolve => setTimeout(resolve, 500));

    // Generate PDF from iframe body
    const pdfBlob = await html2pdf()
      .set(mergedOptions)
      .from(iframeDoc.body)
      .outputPdf('blob');

    // Calculate hash from blob
    const arrayBuffer = await pdfBlob.arrayBuffer();
    const pdfHash = await calculateSHA256(arrayBuffer);

    return { blob: pdfBlob, hash: pdfHash };
  } finally {
    // Clean up
    document.body.removeChild(iframe);
  }
};

// Update PDF hash in backend after PDF generation
// CRITICAL: This hash enables digital signature verification - if not saved, PDF cannot be verified
const updatePdfHashInBackend = async (certificationId, pdfHash, adminKey) => {
  try {
    const response = await axios.post(
      `${API}/certifications/${certificationId}/update-pdf-hash?admin_key=${adminKey}&pdf_hash=${pdfHash}`
    );
    console.log('‚úÖ PDF hash registered for verification:', response.data);
    return { success: true, data: response.data };
  } catch (err) {
    console.error('‚ùå CRITICAL: Failed to register PDF hash for verification:', err);
    // Return error info so caller can handle it
    return {
      success: false,
      error: err.response?.data?.detail || err.message || 'Failed to register PDF hash'
    };
  }
};

// ==================== ERROR MESSAGE SANITIZATION ====================
// Sanitize error messages to hide internal URLs and sensitive information
const sanitizeErrorMessage = (errorMsg) => {
  if (!errorMsg) return 'An error occurred';
  let sanitized = String(errorMsg);
  // Remove Render URLs
  sanitized = sanitized.replace(/https?:\/\/[a-zA-Z0-9-]+\.onrender\.com[^\s]*/g, '[server]');
  // Remove localhost URLs
  sanitized = sanitized.replace(/https?:\/\/localhost[:\d]*[^\s]*/g, '[server]');
  // Remove MongoDB connection strings
  sanitized = sanitized.replace(/mongodb(\+srv)?:\/\/[^\s]+/g, '[database]');
  // Remove stack traces (lines starting with "at ")
  sanitized = sanitized.replace(/\s+at\s+.+/g, '');
  return sanitized;
};

// ==================== UNIFIED CSS STYLES FOR PDF GENERATION ====================
// SIMPLIFIED - Uses inline styles in HTML for maximum reliability
const getUnifiedPdfStyles = (pageSizeCSS = 'Letter') => `
    @page {
        size: ${pageSizeCSS};
        margin: 0.7in 0.75in 0.7in 0.75in;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: Georgia, 'Times New Roman', serif;
        font-size: 12px;
        line-height: 1.6;
        color: #333;
        background: white;
    }
    img { max-width: 100%; height: auto; }
    table { border-collapse: collapse; width: 100%; }
    td, th { border: 1px solid #333; padding: 5px 6px; font-size: 10pt; }
    @media print {
        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .page-break { page-break-before: always; }
    }
`;

// Helper function to generate letterhead HTML with INLINE STYLES (guaranteed to work)
const getLetterheadHTML = (logoLeft, logoRight) => `
<table style="width: 100%; border: none; border-collapse: collapse; margin-bottom: 8px;">
    <tr>
        <td style="width: 120px; vertical-align: middle; border: none; padding: 0;">
            ${logoLeft
              ? `<img src="${logoLeft}" alt="Logo" style="max-width: 110px; max-height: 50px; object-fit: contain;" />`
              : `<div style="font-size: 11px; color: #2563eb; font-weight: bold;">LEGACY<br/><span style="font-weight: normal; font-size: 9px;">TRANSLATIONS</span></div>`}
        </td>
        <td style="text-align: center; vertical-align: middle; border: none; padding: 0 15px;">
            <div style="font-weight: bold; color: #2563eb; font-size: 14px;">Legacy Translations</div>
            <div style="font-size: 9px; color: #333; line-height: 1.3;">867 Boylston Street ¬∑ 5th Floor ¬∑ #2073 ¬∑ Boston, MA ¬∑ 02116</div>
            <div style="font-size: 9px; color: #333;">(857) 316-7770 ¬∑ contact@legacytranslations.com</div>
        </td>
        <td style="width: 80px; text-align: right; vertical-align: middle; border: none; padding: 0;">
            ${logoRight
              ? `<img src="${logoRight}" alt="ATA" style="max-width: 75px; max-height: 50px; object-fit: contain;" />`
              : `<div style="font-size: 9px; color: #666; font-style: italic; text-align: right;">ata<br/><span style="font-size: 8px;">Member # 275993</span></div>`}
        </td>
    </tr>
</table>
<div style="width: 100%; height: 2px; background: linear-gradient(to right, #3B82F6, #60A5FA); margin-bottom: 20px;"></div>`;

// ==================== CONSTANTS ====================
const STATUS_COLORS = {
  'Quote': 'bg-slate-100 text-slate-700',
  'Confirmed': 'bg-blue-100 text-blue-700',
  'In progress': 'bg-yellow-100 text-yellow-700',
  'Completed': 'bg-green-100 text-green-700',
  'Client Review': 'bg-sky-100 text-sky-700',
  'Delivered': 'bg-blue-100 text-blue-700',
  'received': 'bg-slate-100 text-slate-700',
  'in_translation': 'bg-yellow-100 text-yellow-700',
  'review': 'bg-blue-100 text-blue-700',
  'pending_pm_review': 'bg-sky-100 text-sky-700',
  'pending_admin_approval': 'bg-blue-100 text-blue-700',
  'pending_admin_review': 'bg-indigo-100 text-indigo-700',
  'finalized_pending_admin': 'bg-purple-100 text-purple-700',
  'client_review': 'bg-sky-100 text-sky-700',
  'ready': 'bg-green-100 text-green-700',
  'delivered': 'bg-blue-100 text-blue-700',
  'final': 'bg-indigo-100 text-indigo-700'
};

const PAYMENT_COLORS = {
  'pending': 'bg-yellow-100 text-yellow-700',
  'paid': 'bg-green-100 text-green-700',
  'overdue': 'bg-red-100 text-red-700'
};

const FLAGS = {
  'english': 'üá∫üá∏', 'spanish': 'üá™üá∏', 'french': 'üá´üá∑', 'german': 'üá©üá™',
  'portuguese': 'üáßüá∑', 'italian': 'üáÆüáπ', 'chinese': 'üá®üá≥', 'japanese': 'üáØüáµ',
  'korean': 'üá∞üá∑', 'arabic': 'üá∏üá¶', 'russian': 'üá∑üá∫', 'dutch': 'üá≥üá±',
  'Portuguese': 'üáßüá∑', 'Portuguese (Brazil)': 'üáßüá∑', 'English (USA)': 'üá∫üá∏', 'French': 'üá´üá∑',
  'Arabic (Saudi Arabia)': 'üá∏üá¶', 'Spanish': 'üá™üá∏'
};

const LANGUAGES = [
  // Primary Languages (Top 3)
  "English", "Spanish", "Portuguese",
  // All other languages in alphabetical order
  "Afrikaans", "Albanian", "Amharic", "Arabic", "Arabic (Saudi Arabia)", "Armenian",
  "Azerbaijani", "Basque", "Belarusian", "Bengali", "Bosnian", "Bulgarian",
  "Burmese", "Cape Verdean Creole", "Catalan", "Chinese (Simplified)", "Chinese (Traditional)",
  "Croatian", "Czech", "Danish", "Dutch", "English (UK)", "English (USA)",
  "Esperanto", "Estonian", "Filipino/Tagalog", "Finnish", "French", "French (Canada)",
  "French (France)", "Galician", "Georgian", "German", "Greek", "Gujarati",
  "Haitian Creole", "Hebrew", "Hindi", "Hungarian", "Icelandic", "Igbo",
  "Indonesian", "Irish", "Italian", "Japanese", "Kazakh", "Khmer",
  "Korean", "Lao", "Latin", "Latvian", "Lithuanian", "Luxembourgish",
  "Macedonian", "Malay", "Maltese", "Mongolian", "Nepali", "Norwegian",
  "Papiamento", "Persian/Farsi", "Polish", "Portuguese (Brazil)", "Portuguese (Portugal)",
  "Punjabi", "Romanian", "Russian", "Scottish Gaelic", "Serbian", "Slovak",
  "Slovenian", "Somali", "Spanish (Latin America)", "Spanish (Spain)", "Swahili",
  "Swedish", "Tamil", "Telugu", "Thai", "Turkish", "Ukrainian",
  "Urdu", "Uzbek", "Vietnamese", "Welsh", "Yoruba", "Zulu"
];

const TRANSLATORS = [
  { name: "Admin (Self)", title: "Administrator", isAdmin: true },
  { name: "Beatriz Paiva", title: "Managing Director" },
  { name: "Ana Clara", title: "Project Manager" },
  { name: "Yasmin Costa", title: "Certified Translator" },
  { name: "Noemi Santos", title: "Senior Translator" }
];

const PROJECT_MANAGERS = [
  { name: "Ana Clara", title: "Project Manager" },
  { name: "Beatriz Paiva", title: "Managing Director" }
];

// Document Types for translation projects
const DOCUMENT_TYPES = [
  { value: '', label: '-- Select Document Type --' },
  { value: 'birth_certificate', label: 'Certid√£o de Nascimento / Birth Certificate' },
  { value: 'marriage_certificate', label: 'Certid√£o de Casamento / Marriage Certificate' },
  { value: 'vaccination_card', label: 'Cart√£o de Vacina / Vaccination Card' },
  { value: 'divorce_certificate', label: 'Div√≥rcio / Divorce Certificate' },
  { value: 'rg', label: 'RG (Brazilian ID)' },
  { value: 'cnh', label: 'CNH (Brazilian Driver\'s License)' },
  { value: 'dmv', label: 'DMV Document' },
  { value: 'rmv', label: 'RMV Document' },
  { value: 'passport', label: 'Passaporte / Passport' },
  { value: 'diploma', label: 'Diploma / Academic Degree' },
  { value: 'transcript', label: 'Hist√≥rico Escolar / Academic Transcript' },
  { value: 'power_of_attorney', label: 'Procura√ß√£o / Power of Attorney' },
  { value: 'criminal_record', label: 'Antecedentes Criminais / Criminal Record' },
  { value: 'medical_report', label: 'Relat√≥rio M√©dico / Medical Report' },
  { value: 'contract', label: 'Contrato / Contract' },
  { value: 'immigration_doc', label: 'Documento de Imigra√ß√£o / Immigration Document' },
  { value: 'other', label: 'Outros / Other' }
];

// Document Categories for uploaded files
const DOCUMENT_CATEGORIES = [
  { value: '', label: '-- Select Category --' },
  { value: 'financial', label: 'Financial' },
  { value: 'educational', label: 'Educational' },
  { value: 'personal', label: 'Personal Documents' },
  { value: 'bank_statement', label: 'Bank Statement' },
  { value: 'legal', label: 'Legal' },
  { value: 'medical', label: 'Medical' },
  { value: 'immigration', label: 'Immigration' },
  { value: 'business', label: 'Business' },
  { value: 'government', label: 'Government' },
  { value: 'other', label: 'Other' }
];

// ==================== SVG ICONS (Professional/Minimal) ====================
const EditIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
  </svg>
);

const AssignIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
  </svg>
);

const RefreshIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
  </svg>
);

const NoteIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
  </svg>
);

const MemoIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
  </svg>
);

const ClockIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
);

const DocumentIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
  </svg>
);

const SendIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
  </svg>
);

const PlayIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="currentColor" viewBox="0 0 24 24">
    <path d="M8 5v14l11-7z" />
  </svg>
);

const EyeIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
    <path strokeLinecap="round" strokeLinejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
  </svg>
);

const SearchIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
  </svg>
);

const MailIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
  </svg>
);

const TrashIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
  </svg>
);

const CheckIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
  </svg>
);

const UploadIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
  </svg>
);

const WriteIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
  </svg>
);

const DownloadIcon = ({ className = "w-3 h-3" }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
  </svg>
);

// ==================== ADMIN LOGIN ====================
const AdminLogin = ({ onLogin }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  const [loading, setLoading] = useState(false);
  const [useAdminKey, setUseAdminKey] = useState(false); // Fallback to admin key login
  const [adminKey, setAdminKey] = useState('');
  const [showForgotPassword, setShowForgotPassword] = useState(false);
  const [forgotEmail, setForgotEmail] = useState('');

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setSuccess('');
    setLoading(true);

    try {
      if (useAdminKey) {
        // Legacy admin key login (for backward compatibility)
        const response = await axios.get(`${API}/admin/orders?admin_key=${adminKey}`);
        if (response.data) {
          onLogin({ adminKey, role: 'admin', name: 'Admin', email: 'admin@legacy.com' });
        }
      } else {
        // New user-based login
        const response = await axios.post(`${API}/admin/auth/login`, { email, password });
        if (response.data && response.data.token) {
          onLogin({
            adminKey: response.data.token,
            token: response.data.token,
            role: response.data.role,
            name: response.data.name,
            email: response.data.email,
            id: response.data.id,
            translator_type: response.data.translator_type
          });
        }
      }
    } catch (err) {
      setError(err.response?.data?.detail || 'Invalid credentials');
    } finally {
      setLoading(false);
    }
  };

  const handleForgotPassword = async (e) => {
    e.preventDefault();
    setError('');
    setSuccess('');
    setLoading(true);

    try {
      await axios.post(`${API}/admin/auth/forgot-password`, { email: forgotEmail });
      setSuccess('If an account exists with this email, a password reset link has been sent.');
      setForgotEmail('');
    } catch (err) {
      setError(err.response?.data?.detail || 'Error sending reset email');
    } finally {
      setLoading(false);
    }
  };

  // Forgot password modal
  if (showForgotPassword) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center">
        <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
          <div className="text-center mb-6">
            <div className="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-3">
              <span className="text-xl text-white">üîë</span>
            </div>
            <h1 className="text-xl font-bold text-gray-800">Reset Password</h1>
            <p className="text-xs text-gray-500">Enter your email to receive a reset link</p>
          </div>

          {error && (
            <div className="mb-3 p-2 bg-red-100 text-red-700 rounded text-xs text-center">
              {error}
            </div>
          )}

          {success && (
            <div className="mb-3 p-2 bg-green-100 text-green-700 rounded text-xs text-center">
              {success}
            </div>
          )}

          <form onSubmit={handleForgotPassword} className="space-y-3">
            <div>
              <label className="block text-xs font-medium text-gray-700 mb-1">Email</label>
              <input
                type="email"
                required
                className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                value={forgotEmail}
                onChange={(e) => setForgotEmail(e.target.value)}
                placeholder="your@email.com"
              />
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400 text-sm font-medium"
            >
              {loading ? 'Sending...' : 'Send Reset Link'}
            </button>
          </form>

          <div className="mt-4 text-center">
            <button
              onClick={() => { setShowForgotPassword(false); setError(''); setSuccess(''); }}
              className="text-blue-600 hover:underline text-xs"
            >
              ‚Üê Back to Login
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-900 flex items-center justify-center">
      <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
        <div className="text-center mb-6">
          <div className="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-3">
            <span className="text-xl text-white">üîê</span>
          </div>
          <h1 className="text-xl font-bold text-gray-800">Admin Panel</h1>
          <p className="text-xs text-gray-500">Legacy Translations</p>
        </div>

        {error && (
          <div className="mb-3 p-2 bg-red-100 text-red-700 rounded text-xs text-center">
            {error}
          </div>
        )}

        {success && (
          <div className="mb-3 p-2 bg-green-100 text-green-700 rounded text-xs text-center">
            {success}
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-3">
          {useAdminKey ? (
            <div>
              <label className="block text-xs font-medium text-gray-700 mb-1">Admin Key</label>
              <input
                type="password"
                required
                className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                value={adminKey}
                onChange={(e) => setAdminKey(e.target.value)}
                placeholder="Enter admin key..."
              />
            </div>
          ) : (
            <>
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Email</label>
                <input
                  type="email"
                  required
                  className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="your@email.com"
                />
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Password</label>
                <input
                  type="password"
                  required
                  className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                />
              </div>
            </>
          )}

          <button
            type="submit"
            disabled={loading}
            className="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400 text-sm font-medium"
          >
            {loading ? 'Verifying...' : 'Login'}
          </button>
        </form>

        <div className="mt-4 text-center space-y-2">
          {!useAdminKey && (
            <button
              onClick={() => setShowForgotPassword(true)}
              className="text-blue-600 hover:underline text-xs block w-full"
            >
              Forgot Password?
            </button>
          )}
          <button
            onClick={() => setUseAdminKey(!useAdminKey)}
            className="text-gray-500 hover:text-blue-600 text-xs"
          >
            {useAdminKey ? '‚Üê Login with email' : 'Use admin key instead'}
          </button>
          <div>
            <a href="/" className="text-blue-600 hover:underline text-xs">‚Üê Back to Partner Portal</a>
          </div>
        </div>
      </div>
    </div>
  );
};

// ==================== NOTIFICATION BELL ====================
const NotificationBell = ({ adminKey, user, onNotificationClick }) => {
  const [notifications, setNotifications] = useState([]);
  const [unreadCount, setUnreadCount] = useState(0);
  const [showDropdown, setShowDropdown] = useState(false);

  const fetchNotifications = async () => {
    if (!user?.token) return;
    try {
      const response = await axios.get(`${API}/admin/notifications?admin_key=${adminKey}&token=${user.token}`);
      setNotifications(response.data.notifications || []);
      setUnreadCount(response.data.unread_count || 0);
    } catch (err) {
      console.error('Failed to fetch notifications:', err);
    }
  };

  useEffect(() => {
    fetchNotifications();
    // Poll for new notifications every 30 seconds
    const interval = setInterval(fetchNotifications, 30000);
    return () => clearInterval(interval);
  }, [user?.token]);

  const markAsRead = async (notifId) => {
    try {
      await axios.put(`${API}/admin/notifications/${notifId}/read?admin_key=${adminKey}&token=${user.token}`);
      fetchNotifications();
    } catch (err) {
      console.error('Failed to mark as read:', err);
    }
  };

  const markAllRead = async () => {
    try {
      await axios.put(`${API}/admin/notifications/read-all?admin_key=${adminKey}&token=${user.token}`);
      fetchNotifications();
    } catch (err) {
      console.error('Failed to mark all as read:', err);
    }
  };

  return (
    <div className="relative">
      <button
        onClick={() => setShowDropdown(!showDropdown)}
        className="relative p-2 text-slate-300 hover:text-white hover:bg-slate-700 rounded"
      >
        üîî
        {unreadCount > 0 && (
          <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] font-bold w-4 h-4 rounded-full flex items-center justify-center">
            {unreadCount > 9 ? '9+' : unreadCount}
          </span>
        )}
      </button>

      {showDropdown && (
        <div className="absolute left-full top-0 ml-2 w-72 bg-white rounded-lg shadow-xl z-50 text-gray-800 max-h-96 overflow-hidden">
          <div className="p-2 border-b bg-gray-50 flex justify-between items-center">
            <span className="font-bold text-xs">Notifications</span>
            {unreadCount > 0 && (
              <button onClick={markAllRead} className="text-[10px] text-blue-600 hover:text-blue-800">
                Mark all read
              </button>
            )}
          </div>
          <div className="max-h-72 overflow-y-auto">
            {notifications.length === 0 ? (
              <div className="p-4 text-center text-gray-500 text-xs">No notifications</div>
            ) : (
              notifications.map((notif) => (
                <div
                  key={notif.id}
                  onClick={() => { markAsRead(notif.id); if (onNotificationClick) onNotificationClick(notif); }}
                  className={`p-2 border-b cursor-pointer hover:bg-gray-50 ${!notif.is_read ? 'bg-blue-50' : ''}`}
                >
                  <div className="flex items-start">
                    <span className="text-sm mr-2">
                      {notif.type === 'project_assigned' ? 'üìã' : notif.type === 'revision_requested' ? 'üîÑ' : 'üìå'}
                    </span>
                    <div className="flex-1">
                      <div className="font-medium text-xs">{notif.title}</div>
                      <div className="text-[10px] text-gray-600 mt-0.5">{notif.message}</div>
                      <div className="text-[9px] text-gray-400 mt-1">
                        {formatDateTimeLocal(notif.created_at)}
                      </div>
                    </div>
                    {!notif.is_read && <span className="w-2 h-2 bg-blue-500 rounded-full"></span>}
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      )}
    </div>
  );
};

// ==================== HORIZONTAL TOP BAR ====================
const TopBar = ({
  activeTab,
  setActiveTab,
  onLogout,
  user,
  adminKey,
  pendingZelleCount = 0,
  unreadNotifCount = 0,
  pendingZelleInvoices = [],
  invoiceNotifications = [],
  onRefreshNotifications,
  currentTheme = 'legacy',
  setCurrentTheme,
  theme
}) => {
  const [showNotifDropdown, setShowNotifDropdown] = useState(false);

  const totalNotifCount = pendingZelleCount + unreadNotifCount;

  const handleApproveZelle = async (invoiceId) => {
    if (!window.confirm('Approve this Zelle payment?')) return;
    try {
      await axios.put(`${API}/admin/invoice-payments/${invoiceId}/approve-zelle?admin_key=${adminKey}`);
      showToast('Payment approved!');
      if (onRefreshNotifications) onRefreshNotifications();
    } catch (err) {
      showToast('Error: ' + (err.response?.data?.detail || err.message));
    }
  };

  const handleRejectZelle = async (invoiceId) => {
    const reason = prompt('Rejection reason (optional):');
    if (reason === null) return;
    try {
      await axios.put(`${API}/admin/invoice-payments/${invoiceId}/reject-zelle?admin_key=${adminKey}&reason=${encodeURIComponent(reason)}`);
      showToast('Payment rejected');
      if (onRefreshNotifications) onRefreshNotifications();
    } catch (err) {
      showToast('Error: ' + (err.response?.data?.detail || err.message));
    }
  };

  const handleMarkRead = async (notifId) => {
    try {
      await axios.put(`${API}/admin/invoice-notifications/${notifId}/read?admin_key=${adminKey}`);
      if (onRefreshNotifications) onRefreshNotifications();
    } catch (err) {
      console.error('Error marking notification as read:', err);
    }
  };

  // Define menu items with role-based access
  const allMenuItems = [
    { id: 'projects', label: 'Projects', icon: 'üìã', roles: ['admin', 'sales'] },
    { id: 'new-quote', label: 'New Quote', icon: 'üìù', roles: ['sales'] },
    { id: 'translation', label: 'Translation', icon: '‚úçÔ∏è', roles: ['admin', 'pm', 'translator'] },
    { id: 'production', label: 'Reports', icon: 'üìä', roles: ['admin'] },
    { id: 'finances', label: 'Finances', icon: 'üí∞', roles: ['admin'] },
    { id: 'followups', label: 'Follow-ups', icon: 'üîî', roles: ['admin'] },
    { id: 'pm-dashboard', label: 'PM Dashboard', icon: 'üéØ', roles: ['pm'] },
    { id: 'sales-control', label: 'Sales', icon: 'üìà', roles: ['admin'] },
    { id: 'users', label: 'Translators', icon: 'üë•', roles: ['admin'] },
    { id: 'settings', label: 'Settings', icon: '‚öôÔ∏è', roles: ['admin'] },
    { id: 'mia-bot', label: 'MIA Bot', icon: 'ü§ñ', roles: ['admin'], isExternal: true }
  ];

  // Filter menu items based on user role
  const userRole = user?.role || 'admin';
  const menuItems = allMenuItems.filter(item => item.roles.includes(userRole));

  // Role display names and colors
  const roleConfig = {
    admin: { label: 'Admin', color: 'bg-red-500' },
    pm: { label: 'Project Manager', color: 'bg-blue-500' },
    translator: { label: 'Translator', color: 'bg-green-500' },
    sales: { label: 'Sales', color: 'bg-blue-500' }
  };

  const roleInfo = roleConfig[userRole] || roleConfig.admin;

  return (
    <div className="bg-slate-800 text-white flex items-center justify-between px-4 py-2 text-xs">
      {/* Logo and Brand */}
      <div className="flex items-center space-x-3">
        <div className="flex items-center space-x-2">
          <div className="w-8 h-8 bg-blue-500 rounded flex items-center justify-center text-sm">üåê</div>
          <div>
            <div className="font-bold text-sm">Legacy Admin</div>
          </div>
        </div>
      </div>

      {/* Navigation Menu */}
      <nav className="flex items-center space-x-1">
        {menuItems.map((item) => (
          <button
            key={item.id}
            onClick={() => setActiveTab(item.id)}
            className={`flex items-center px-3 py-1.5 rounded transition-colors ${
              activeTab === item.id
                ? item.id === 'mia-bot' ? 'bg-blue-600 text-white' : 'bg-blue-600 text-white'
                : item.id === 'mia-bot'
                ? 'text-blue-300 hover:bg-blue-700 bg-blue-900/50'
                : 'text-slate-300 hover:bg-slate-700'
            }`}
          >
            <span className="mr-1.5">{item.icon}</span>
            <span>{item.label}</span>
          </button>
        ))}
      </nav>

      {/* User Info and Actions */}
      <div className="flex items-center space-x-3">
        {/* Notification Bell - Only for admin */}
        {userRole === 'admin' && (
          <div className="relative">
            <button
              onClick={() => setShowNotifDropdown(!showNotifDropdown)}
              className="relative p-2 text-slate-300 hover:bg-slate-700 rounded transition-colors"
              title="Invoice Notifications"
            >
              <span className="text-lg">üîî</span>
              {totalNotifCount > 0 && (
                <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center">
                  {totalNotifCount > 9 ? '9+' : totalNotifCount}
                </span>
              )}
            </button>

            {/* Notification Dropdown */}
            {showNotifDropdown && (
              <div className="absolute right-0 mt-2 w-96 bg-white rounded-lg shadow-xl border z-50 max-h-[80vh] overflow-hidden">
                <div className="p-3 border-b bg-gray-50 flex justify-between items-center">
                  <h3 className="font-bold text-gray-800 text-sm">Invoice Notifications</h3>
                  <button
                    onClick={() => setShowNotifDropdown(false)}
                    className="text-gray-500 hover:text-gray-700"
                  >
                    ‚úï
                  </button>
                </div>

                <div className="overflow-y-auto max-h-[60vh]">
                  {/* Pending Zelle Section */}
                  {pendingZelleInvoices.length > 0 && (
                    <div className="border-b">
                      <div className="px-3 py-2 bg-purple-50 text-purple-800 text-xs font-bold flex items-center justify-between">
                        <span>üè¶ Pending Zelle Verification</span>
                        <span className="bg-purple-600 text-white rounded-full px-2 py-0.5 text-[10px]">
                          {pendingZelleInvoices.length}
                        </span>
                      </div>
                      {pendingZelleInvoices.map((inv) => (
                        <div key={inv.id} className="p-3 border-b hover:bg-gray-50">
                          <div className="flex justify-between items-start">
                            <div>
                              <div className="font-mono text-xs font-medium">{inv.invoice_number}</div>
                              <div className="text-xs text-gray-600">{inv.partner_company}</div>
                              <div className="text-[10px] text-gray-400">
                                {inv.zelle_submitted_at ? new Date(inv.zelle_submitted_at).toLocaleString() : ''}
                              </div>
                            </div>
                            <div className="text-right">
                              <div className="font-bold text-sm text-gray-800">${inv.total_amount?.toFixed(2)}</div>
                              {inv.zelle_receipt_url && (
                                <a
                                  href={inv.zelle_receipt_url}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="text-[10px] text-blue-600 hover:underline"
                                >
                                  View Receipt
                                </a>
                              )}
                            </div>
                          </div>
                          <div className="flex gap-2 mt-2">
                            <button
                              onClick={() => handleApproveZelle(inv.id)}
                              className="flex-1 px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                            >
                              ‚úì Approve
                            </button>
                            <button
                              onClick={() => handleRejectZelle(inv.id)}
                              className="flex-1 px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700"
                            >
                              ‚úï Reject
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}

                  {/* Recent Notifications */}
                  {invoiceNotifications.length > 0 && (
                    <div>
                      <div className="px-3 py-2 bg-gray-50 text-gray-700 text-xs font-bold">
                        Recent Activity
                      </div>
                      {invoiceNotifications.slice(0, 8).map((notif) => (
                        <div
                          key={notif.id}
                          className={`p-3 border-b hover:bg-gray-50 cursor-pointer ${!notif.is_read ? 'bg-blue-50' : ''}`}
                          onClick={() => !notif.is_read && handleMarkRead(notif.id)}
                        >
                          <div className="flex items-start gap-2">
                            <span className="text-sm">
                              {notif.type === 'invoice_stripe_paid' && 'üí≥'}
                              {notif.type === 'invoice_zelle_receipt' && 'üè¶'}
                              {notif.type === 'invoice_payment_approved' && '‚úÖ'}
                            </span>
                            <div className="flex-1">
                              <div className="text-xs font-medium text-gray-800">{notif.title}</div>
                              <div className="text-[10px] text-gray-500">{notif.message}</div>
                              <div className="text-[10px] text-gray-400 mt-1">
                                {new Date(notif.created_at).toLocaleString()}
                              </div>
                            </div>
                            {!notif.is_read && (
                              <span className="w-2 h-2 bg-blue-500 rounded-full"></span>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}

                  {/* Empty State */}
                  {pendingZelleInvoices.length === 0 && invoiceNotifications.length === 0 && (
                    <div className="p-6 text-center text-gray-500 text-sm">
                      No notifications
                    </div>
                  )}
                </div>

                {/* Footer */}
                <div className="p-2 border-t bg-gray-50">
                  <button
                    onClick={() => {
                      setActiveTab('finances');
                      setShowNotifDropdown(false);
                    }}
                    className="w-full text-center text-xs text-blue-600 hover:text-blue-800 py-1"
                  >
                    View all in Finances ‚Üí Partners
                  </button>
                </div>
              </div>
            )}
          </div>
        )}

        {user && (
          <div className="flex items-center space-x-2">
            <div className={`px-3 py-1 ${roleInfo.color} rounded text-[10px] font-medium text-center`}>
              {roleInfo.label}
            </div>
            {(userRole === 'pm' || userRole === 'translator') && user.name && (
              <span className="text-white text-[11px]">
                Welcome, {user.name.split(' ')[0]}
              </span>
            )}
          </div>
        )}

        {/* Brand/Theme Selector */}
        {setCurrentTheme && userRole === 'admin' && (
          <div className="flex items-center">
            <select
              value={currentTheme}
              onChange={(e) => setCurrentTheme(e.target.value)}
              className="px-2 py-1 text-[10px] bg-gray-800 text-white border border-gray-600 rounded cursor-pointer hover:bg-gray-700"
              title="Switch brand theme"
            >
              <option value="legacy">Legacy</option>
            </select>
          </div>
        )}

        <button
          onClick={onLogout}
          className="px-2 py-1.5 text-red-400 hover:bg-red-900/30 rounded text-xs"
        >
          üö™ Logout
        </button>
      </div>
    </div>
  );
};

// ==================== SEARCH BAR ====================
const SearchBar = ({ value, onChange, placeholder }) => (
  <div className="relative">
    <input
      type="text"
      value={value}
      onChange={(e) => onChange(e.target.value)}
      placeholder={placeholder || "Search by name or email..."}
      className="w-64 px-3 py-1.5 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 pl-8"
    />
    <span className="absolute left-2.5 top-1.5 text-gray-400 text-xs">üîç</span>
  </div>
);

// ==================== CURRENCY DATA (SHARED) ====================
const CURRENCIES = {
  BRL: { name: 'Brazilian Real', symbol: 'R$', country: 'Brazil', flag: 'üáßüá∑' },
  USD: { name: 'US Dollar', symbol: '$', country: 'USA', flag: 'üá∫üá∏' },
  CAD: { name: 'Canadian Dollar', symbol: 'CA$', country: 'Canada', flag: 'üá®üá¶' },
  EUR: { name: 'Euro', symbol: '‚Ç¨', country: 'Eurozone', flag: 'üá™üá∫' },
  GBP: { name: 'British Pound', symbol: '¬£', country: 'UK', flag: 'üá¨üáß' },
  MXN: { name: 'Mexican Peso', symbol: '$', country: 'Mexico', flag: 'üá≤üáΩ' },
  ARS: { name: 'Argentine Peso', symbol: '$', country: 'Argentina', flag: 'üá¶üá∑' },
  CLP: { name: 'Chilean Peso', symbol: '$', country: 'Chile', flag: 'üá®üá±' },
  COP: { name: 'Colombian Peso', symbol: '$', country: 'Colombia', flag: 'üá®üá¥' },
  PEN: { name: 'Peruvian Sol', symbol: 'S/', country: 'Peru', flag: 'üáµüá™' },
  NOK: { name: 'Norwegian Krone', symbol: 'kr', country: 'Norway', flag: 'üá≥üá¥' },
  SEK: { name: 'Swedish Krona', symbol: 'kr', country: 'Sweden', flag: 'üá∏üá™' },
  DKK: { name: 'Danish Krone', symbol: 'kr', country: 'Denmark', flag: 'üá©üá∞' },
  CHF: { name: 'Swiss Franc', symbol: 'CHF', country: 'Switzerland', flag: 'üá®üá≠' },
  JPY: { name: 'Japanese Yen', symbol: '¬•', country: 'Japan', flag: 'üáØüáµ' },
  CNY: { name: 'Chinese Yuan', symbol: '¬•', country: 'China', flag: 'üá®üá≥' },
  KRW: { name: 'South Korean Won', symbol: '‚Ç©', country: 'South Korea', flag: 'üá∞üá∑' },
  INR: { name: 'Indian Rupee', symbol: '‚Çπ', country: 'India', flag: 'üáÆüá≥' },
  AUD: { name: 'Australian Dollar', symbol: 'A$', country: 'Australia', flag: 'üá¶üá∫' },
  NZD: { name: 'New Zealand Dollar', symbol: 'NZ$', country: 'New Zealand', flag: 'üá≥üáø' },
  ZAR: { name: 'South African Rand', symbol: 'R', country: 'South Africa', flag: 'üáøüá¶' },
  RUB: { name: 'Russian Ruble', symbol: '‚ÇΩ', country: 'Russia', flag: 'üá∑üá∫' },
  TRY: { name: 'Turkish Lira', symbol: '‚Ç∫', country: 'Turkey', flag: 'üáπüá∑' },
  PLN: { name: 'Polish Zloty', symbol: 'z≈Ç', country: 'Poland', flag: 'üáµüá±' },
  CZK: { name: 'Czech Koruna', symbol: 'Kƒç', country: 'Czech Republic', flag: 'üá®üáø' },
  HUF: { name: 'Hungarian Forint', symbol: 'Ft', country: 'Hungary', flag: 'üá≠üá∫' },
  ILS: { name: 'Israeli Shekel', symbol: '‚Ç™', country: 'Israel', flag: 'üáÆüá±' },
  SGD: { name: 'Singapore Dollar', symbol: 'S$', country: 'Singapore', flag: 'üá∏üá¨' },
  HKD: { name: 'Hong Kong Dollar', symbol: 'HK$', country: 'Hong Kong', flag: 'üá≠üá∞' },
  PHP: { name: 'Philippine Peso', symbol: '‚Ç±', country: 'Philippines', flag: 'üáµüá≠' },
  THB: { name: 'Thai Baht', symbol: '‡∏ø', country: 'Thailand', flag: 'üáπüá≠' },
  MYR: { name: 'Malaysian Ringgit', symbol: 'RM', country: 'Malaysia', flag: 'üá≤üáæ' },
  IDR: { name: 'Indonesian Rupiah', symbol: 'Rp', country: 'Indonesia', flag: 'üáÆüá©' },
  VND: { name: 'Vietnamese Dong', symbol: '‚Ç´', country: 'Vietnam', flag: 'üáªüá≥' },
  AED: { name: 'UAE Dirham', symbol: 'ÿØ.ÿ•', country: 'UAE', flag: 'üá¶üá™' },
  SAR: { name: 'Saudi Riyal', symbol: 'Ô∑º', country: 'Saudi Arabia', flag: 'üá∏üá¶' },
  EGP: { name: 'Egyptian Pound', symbol: '¬£', country: 'Egypt', flag: 'üá™üá¨' },
  NGN: { name: 'Nigerian Naira', symbol: '‚Ç¶', country: 'Nigeria', flag: 'üá≥üá¨' },
  KES: { name: 'Kenyan Shilling', symbol: 'KSh', country: 'Kenya', flag: 'üá∞üá™' }
};

const RATE_SOURCES = [
  { id: 'xe.com', name: 'XE.com', url: 'https://www.xe.com/currencyconverter/' },
  { id: 'google', name: 'Google Finance', url: 'https://www.google.com/finance/' },
  { id: 'bloomberg', name: 'Bloomberg', url: 'https://www.bloomberg.com/markets/currencies' },
  { id: 'businessinsider', name: 'Business Insider', url: 'https://markets.businessinsider.com/currencies' },
  { id: 'oanda', name: 'OANDA', url: 'https://www.oanda.com/currency-converter/' }
];

const LANGUAGE_TO_CURRENCY = {
  'Portuguese': 'BRL',
  'English': 'USD',
  'Spanish': 'MXN',
  'French': 'EUR',
  'German': 'EUR',
  'Italian': 'EUR',
  'Dutch': 'EUR',
  'Norwegian': 'NOK',
  'Swedish': 'SEK',
  'Danish': 'DKK',
  'Finnish': 'EUR',
  'Japanese': 'JPY',
  'Chinese': 'CNY',
  'Korean': 'KRW',
  'Russian': 'RUB',
  'Arabic': 'AED',
  'Hebrew': 'ILS',
  'Turkish': 'TRY',
  'Polish': 'PLN',
  'Czech': 'CZK',
  'Hungarian': 'HUF',
  'Thai': 'THB',
  'Vietnamese': 'VND',
  'Indonesian': 'IDR',
  'Malay': 'MYR',
  'Hindi': 'INR',
  'Greek': 'EUR',
  'Romanian': 'EUR',
  'Ukrainian': 'EUR',
  'Bulgarian': 'EUR'
};

const getCurrencyFromLanguage = (language) => {
  return LANGUAGE_TO_CURRENCY[language] || 'USD';
};

// ==================== TRANSLATION WORKSPACE ====================
const TranslationWorkspace = ({ adminKey, selectedOrder, onBack, user }) => {
  // User role checks
  const isAdmin = user?.role === 'admin';
  const isPM = user?.role === 'pm';
  const isTranslator = user?.role === 'translator';
  const isInHouseTranslator = isTranslator && user?.translator_type === 'in_house';
  const isContractor = isTranslator && user?.translator_type !== 'in_house';  // Contractors have limited DELIVER tab access

  // State
  const [activeSubTab, setActiveSubTab] = useState('start');
  const [showProjectMenu, setShowProjectMenu] = useState(false);

  // Assigned orders for translator
  const [assignedOrders, setAssignedOrders] = useState([]);
  const [loadingAssigned, setLoadingAssigned] = useState(false);
  const [selectedProjectFiles, setSelectedProjectFiles] = useState([]); // Files for selected project
  const [loadingProjectFiles, setLoadingProjectFiles] = useState(false);
  const [selectedFileId, setSelectedFileId] = useState(null); // Currently loaded file
  const [allProjectFiles, setAllProjectFiles] = useState([]); // All files from all projects for individual view
  const [viewMode, setViewMode] = useState('files'); // 'projects' or 'files' - default to files view

  // Translator messages
  const [translatorMessages, setTranslatorMessages] = useState([]);
  const [showTranslatorMessages, setShowTranslatorMessages] = useState(false);
  const [showApiKey, setShowApiKey] = useState(false);

  // Translator Chat Widget state (for sending messages to Admin/PM)
  const [showTranslatorChat, setShowTranslatorChat] = useState(false);
  const [translatorChatMessage, setTranslatorChatMessage] = useState('');
  const [sendingTranslatorMessage, setSendingTranslatorMessage] = useState(false);
  const [adminPmList, setAdminPmList] = useState([]);
  const [selectedAdminPm, setSelectedAdminPm] = useState('');
  const [selectedCoverLetter, setSelectedCoverLetter] = useState('default');
  const [customCoverLetters, setCustomCoverLetters] = useState(() => {
    const saved = localStorage.getItem('custom_cover_letters');
    return saved ? JSON.parse(saved) : [];
  });

  // Certificate Template state - for customizing certificate body text while keeping header/logos/signature
  const [selectedCertificateTemplate, setSelectedCertificateTemplate] = useState(() => {
    return localStorage.getItem('selected_certificate_template') || 'default';
  });
  const [customCertificateTemplates, setCustomCertificateTemplates] = useState(() => {
    const saved = localStorage.getItem('custom_certificate_templates');
    return saved ? JSON.parse(saved) : [];
  });

  // State for fillable template mode in Translation tab
  const [selectedFillableTemplate, setSelectedFillableTemplate] = useState(null);
  const [fillableTemplateData, setFillableTemplateData] = useState({});
  const [showTemplatePreview, setShowTemplatePreview] = useState(false);

  // Predefined certificate templates with body text only (header, logos, signature are setote)
  // Template Categories for organization
  const TEMPLATE_CATEGORIES = {
    'certificates': { name: 'Certificates', icon: 'üìú', description: 'Standard translation certificates' },
    'rmv-forms': { name: 'RMV / DMV Forms', icon: 'üöó', description: 'Motor vehicle forms' },
    'brazil-docs': { name: 'Brazilian Documents', icon: 'üáßüá∑', description: 'Brazilian official documents' },
    'education': { name: 'Education', icon: 'üéì', description: 'Academic documents' }
  };

  const CERTIFICATE_TEMPLATES = {
    'default': {
      name: 'Default',
      description: 'Standard Certificate',
      category: 'certificates',
      bodyParagraphs: [
        'We, <strong>Legacy Translations Inc.</strong>, a professional translation services company and an <strong>American Translators Association (ATA) Member (No. 275993)</strong>, having no relation to the client, hereby certify that the attached {{targetLanguage}} translation of the {{sourceLanguage}} document was performed by us and is, to the best of our knowledge and belief, a <strong>true, complete, and accurate translation</strong> of the original document submitted.',
        'This certification attests <strong>only to the accuracy and completeness of the translation</strong>. We do not certify or guarantee the authenticity of the original document, nor the truthfulness of the statements contained therein. <strong>Legacy Translations Inc.</strong> assumes no responsibility or liability for the manner in which this translation is used by the client or any third party, including governmental, educational, or legal institutions.',
        'I, <strong>Beatriz Paiva</strong>, hereby certify that this translation has been <strong>reviewed and proofread</strong> and that the attached translated document is a <strong>faithful and authentic representation</strong> of the original document.',
        'A copy of the translated document and the original file(s) provided are attached hereto and form an integral part of this certification.'
      ]
    },
    'rmv-ma': {
      name: 'RMV Massachusetts',
      description: 'MA Registry',
      category: 'certificates',
      isForm: true,
      formHTML: `
        <div style="font-family: 'Georgia', 'Times New Roman', serif; font-size: 12px; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 32px; background: white;">

          <!-- Header with logos -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px;">
            <div style="width: 128px;">
              {{LOGO_LEFT}}
            </div>
            <div style="text-align: center; flex: 1; padding: 0 16px;">
              <div style="font-weight: bold; color: #2563eb; font-size: 14px; font-style: italic;">Legacy Translations</div>
              <div style="font-size: 9px; color: #666;">867 Boylston Street ¬∑ 5th Floor ¬∑ #2073 ¬∑ Boston, MA ¬∑ 02116</div>
              <div style="font-size: 9px; color: #666;">(857) 316-7770 ¬∑ contact@legacytranslations.com</div>
            </div>
            <div style="width: 80px; text-align: right;">
              {{LOGO_RIGHT}}
            </div>
          </div>

          <!-- Blue line -->
          <div style="width: 100%; height: 2px; background: #93c5fd; margin-bottom: 16px;"></div>

          <!-- Order Number -->
          <div style="text-align: right; margin-bottom: 24px; font-size: 14px;">
            <span>Order # </span>
            <input type="text" id="rmv-order-number" value="P6287" style="font-weight: bold; border: 2px solid #60a5fa; background: #eff6ff; padding: 2px 8px; width: 180px; text-align: center; font-size: 14px; font-family: Georgia, serif;" />
          </div>

          <!-- Main Title -->
          <h1 style="text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 40px; letter-spacing: 0.5px; color: #1a365d;">
            CERTIFICATION OF TRANSLATION ACCURACY AND COMPLETION
          </h1>

          <p style="text-align: justify; margin-bottom: 50px; line-height: 2; font-size: 14px;">
            I hereby certify that this is a true and complete original translation from <input type="text" id="rmv-source-language" value="Portuguese" style="font-weight: bold; border: none; border-bottom: 1px solid #000; font-size: 14px; font-family: 'Times New Roman', Times, serif; padding: 2px 5px; background: transparent; width: 100px; text-align: center;" /> into English of a
            <input type="text" id="rmv-document-type" value="Birth Certificate" style="font-weight: bold; border: none; border-bottom: 1px solid #000; font-size: 14px; font-family: 'Times New Roman', Times, serif; padding: 2px 5px; background: transparent; width: 140px; text-align: center;" />. This translation was performed by a qualified professional translator fluent in the source language, authorized by Legacy Translations (ATA member
            under # 275993). I understand that the original document and this certified translation may be
            presented to the Massachusetts Registry of Motor Vehicles (RMV) in support of an application for a
            permit, license, or Identification Card, and I further understand that false statements to the RMV
            may be punished by fine, imprisonment, or both (M.G.L. Chapter 90, Section 24).
          </p>

          <div style="margin-top: 40px;">
            <div style="margin-bottom: 20px; display: flex; align-items: baseline;">
              <label style="font-weight: bold; font-style: italic; min-width: 280px;">Applicant's Name:</label>
              <input type="text" id="rmv-applicant-name" style="flex: 1; border: none; border-bottom: 1px solid #000; font-size: 14px; font-family: 'Times New Roman', Times, serif; padding: 2px 5px; background: transparent;" placeholder="Enter applicant name" />
            </div>

            <div style="margin-bottom: 20px; display: flex; align-items: baseline;">
              <label style="font-weight: bold; font-style: italic; min-width: 280px;">Address:</label>
              <input type="text" id="rmv-address" value="867 Boylston Street ¬∑ 5th Floor ¬∑ #2073 ¬∑ Boston, MA ¬∑ 02116" style="flex: 1; border: none; border-bottom: 1px solid #000; font-size: 14px; font-family: 'Times New Roman', Times, serif; padding: 2px 5px; background: transparent;" />
            </div>

            <div style="margin-bottom: 20px; display: flex; align-items: baseline;">
              <label style="font-weight: bold; font-style: italic; min-width: 280px;">Phone:</label>
              <input type="text" id="rmv-phone" value="(857) 316-7770" style="flex: 1; border: none; border-bottom: 1px solid #000; font-size: 14px; font-family: 'Times New Roman', Times, serif; padding: 2px 5px; background: transparent;" />
            </div>
          </div>

          <!-- Signature Section -->
          <div style="margin-top: 60px; display: flex; justify-content: space-between; align-items: flex-end;">
            <div style="display: inline-block;">
              <!-- Empty signature line for manual signing -->
              <div style="border-bottom: 1px solid #000; width: 200px; height: 40px; margin-bottom: 4px;"></div>
              <div style="font-style: italic; font-size: 13px; color: #1a365d;">Beatriz Paiva</div>
              <div style="font-size: 12px; margin-top: 8px;">Authorized Representative</div>
              <div style="font-size: 12px;">Legacy Translations Inc.</div>
              <div style="font-size: 12px; margin-top: 12px;">
                Dated: <input type="text" id="rmv-date" value="${new Date().toLocaleDateString('en-US', { timeZone: 'America/New_York' })}" style="font-weight: bold; border: 2px solid #60a5fa; background: #eff6ff; padding: 2px 8px; width: 100px; font-size: 12px; font-family: Georgia, serif;" />
              </div>
            </div>
            <div style="text-align: center;">
              {{LOGO_STAMP}}
            </div>
          </div>
        </div>
      `
    },
    'dmv-fl': {
      name: 'DMV Florida',
      description: 'FL DMV',
      category: 'certificates',
      bodyParagraphs: [
        'We, <strong>Legacy Translations Inc.</strong>, a professional translation services company and an <strong>American Translators Association (ATA) Member (No. 275993)</strong>, hereby certify that the attached English translation of the {{sourceLanguage}} <strong>Driver\'s License / Identification Document</strong> was performed by us and is, to the best of our knowledge and belief, a <strong>true, complete, and accurate translation</strong> of the original document submitted.',
        'This translation is being provided for use with the <strong>Florida Department of Highway Safety and Motor Vehicles (FLHSMV)</strong> for the purpose of driver\'s license application, identification verification, or other official purposes as required by the State of Florida.',
        'This certification attests <strong>only to the accuracy and completeness of the translation</strong>. We do not certify or guarantee the authenticity of the original document, nor the truthfulness of the statements contained therein. <strong>Legacy Translations Inc.</strong> assumes no responsibility or liability for the manner in which this translation is used.',
        'I, <strong>Beatriz Paiva</strong>, hereby certify that this translation has been <strong>reviewed and proofread</strong> and that the attached translated document is a <strong>faithful and authentic representation</strong> of the original document.',
        'A copy of the translated document and the original file(s) provided are attached hereto and form an integral part of this certification.'
      ]
    },
    'uscis': {
      name: 'USCIS Immigration',
      description: 'Immigration',
      category: 'certificates',
      bodyParagraphs: [
        'We, <strong>Legacy Translations Inc.</strong>, a professional translation services company and an <strong>American Translators Association (ATA) Member (No. 275993)</strong>, hereby certify that the attached English translation of the {{sourceLanguage}} document was performed by us and is, to the best of our knowledge and belief, a <strong>true, complete, and accurate translation</strong> of the original document submitted.',
        'This translation is being provided for use with the <strong>United States Citizenship and Immigration Services (USCIS)</strong> and complies with the USCIS translation requirements as specified in 8 CFR 103.2(b)(3).',
        'I, <strong>Beatriz Paiva</strong>, am competent to translate from {{sourceLanguage}} to English, and hereby certify that this translation is complete and accurate to the best of my knowledge and ability.',
        'This certification attests <strong>only to the accuracy and completeness of the translation</strong>. We do not certify or guarantee the authenticity of the original document, nor the truthfulness of the statements contained therein.',
        'A copy of the translated document and the original file(s) provided are attached hereto and form an integral part of this certification.'
      ]
    },
    'education': {
      name: 'WES/ECE',
      description: 'Academic Eval',
      category: 'education',
      bodyParagraphs: [
        'We, <strong>Legacy Translations Inc.</strong>, a professional translation services company and an <strong>American Translators Association (ATA) Member (No. 275993)</strong>, hereby certify that the attached English translation of the {{sourceLanguage}} <strong>academic document(s)</strong> was performed by us and is, to the best of our knowledge and belief, a <strong>true, complete, and accurate translation</strong> of the original document submitted.',
        'This translation is suitable for submission to <strong>credential evaluation services</strong> such as World Education Services (WES), Educational Credential Evaluators (ECE), and similar organizations, as well as educational institutions in the United States.',
        'This certification attests <strong>only to the accuracy and completeness of the translation</strong>. We do not certify or guarantee the authenticity of the original document, nor the truthfulness of the statements contained therein. <strong>Legacy Translations Inc.</strong> assumes no responsibility or liability for the manner in which this translation is used.',
        'I, <strong>Beatriz Paiva</strong>, hereby certify that this translation has been <strong>reviewed and proofread</strong> and that the attached translated document is a <strong>faithful and authentic representation</strong> of the original document.',
        'A copy of the translated document and the original file(s) provided are attached hereto and form an integral part of this certification.'
      ]
    },
    'rmv-foreign-dl': {
      name: "Foreign DL Form",
      description: 'LIC114',
      category: 'rmv-forms',
      isForm: true,
      formHTML: `
        <div style="font-family: Arial, sans-serif; font-size: 11px; line-height: 1.4; max-width: 750px; margin: 0 auto; padding: 20px;">
          <!-- Header -->
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="width: 50px; height: 50px; border: 1px solid #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; text-align: center;">MA State Seal</div>
              <div style="display: flex; gap: 2px;">
                <div style="background: #000; color: #fff; padding: 5px 8px; font-weight: bold;">r</div>
                <div style="background: #c00; color: #fff; padding: 5px 8px; font-weight: bold;">m</div>
                <div style="background: #006; color: #fff; padding: 5px 8px; font-weight: bold;">v</div>
              </div>
              <div style="font-size: 8px; color: #666;">REGISTRY OF MOTOR VEHICLES</div>
            </div>
            <div>
              <div style="font-size: 18px; font-weight: bold;">Translation into English</div>
              <div style="font-size: 16px; font-weight: bold;">of a Foreign Driver License</div>
            </div>
            <div style="border: 1px solid #000; width: 100px; height: 120px; display: flex; align-items: center; justify-content: center; font-size: 10px; text-align: center;">Attach photo here</div>
          </div>

          <!-- Yellow Box Notice -->
          <div style="background: #fff3cd; border: 1px solid #000; padding: 10px; margin-bottom: 15px; font-style: italic; font-size: 10px;">
            <p style="margin: 0 0 5px 0;"><em>Massachusetts General Law (Chapter 90, Section 10) was changed July 2018. Everyone operating a motor vehicle in Massachusetts with a foreign driver's license that is not written in English must carry either this completed translation, an International Driving Permit (IDP) issued from the country that issued the license, or an alternative translation document that contains a photo and English translation that closely matches the information from an IDP.</em></p>
            <p style="margin: 0; font-weight: bold;"><em>This form must be completed <u>for</u> an applicant who does not have an IDP or alternative translation document and whose license is not written in English.</em></p>
          </div>

          <!-- Qualified Translator Section -->
          <div style="margin-bottom: 15px;">
            <p style="font-weight: bold; margin-bottom: 10px;">All information below must be completed by a <u>qualified</u> translator.</p>

            <p style="margin-bottom: 10px;">I hereby certify that this is a true and complete original translation from (original language)</p>
            <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
              <input type="text" placeholder="Original Language" style="border: none; border-bottom: 1px solid #000; width: 150px; padding: 2px;" contenteditable="true" />
              <span>into English of a driver's license issued by the Country of</span>
              <input type="text" placeholder="Country" style="border: none; border-bottom: 1px solid #000; width: 150px; padding: 2px;" contenteditable="true" />
              <span>.</span>
            </div>

            <p style="margin-bottom: 10px;">I further certify that I speak the language of the original driver's license fluently and I (check one):</p>

            <div style="margin-left: 20px; margin-bottom: 8px;">
              <div style="display: flex; align-items: flex-start; gap: 8px; margin-bottom: 5px;">
                <input type="checkbox" style="margin-top: 3px;" />
                <span>Work for a college, university, or private language school. Name, Address, and Department:</span>
              </div>
              <input type="text" placeholder="" style="border: none; border-bottom: 1px solid #000; width: 100%; padding: 2px; margin-left: 20px;" contenteditable="true" />
            </div>

            <div style="margin-left: 20px; margin-bottom: 8px;">
              <div style="display: flex; align-items: flex-start; gap: 8px; margin-bottom: 5px;">
                <input type="checkbox" style="margin-top: 3px;" />
                <span>Work for a local consulate. Name and Address of Consulate:</span>
              </div>
              <input type="text" placeholder="" style="border: none; border-bottom: 1px solid #000; width: 100%; padding: 2px; margin-left: 20px;" contenteditable="true" />
            </div>

            <div style="margin-left: 20px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" style="margin-top: 0;" />
              <span>Am a Massachusetts bilingual notary public ---------------------------- (place official notary seal below)</span>
            </div>

            <div style="margin-left: 20px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" style="margin-top: 0;" checked />
              <span>Am a member of the American Translators Association</span>
            </div>
          </div>

          <!-- Licensee Information Box -->
          <div style="border: 1px solid #000; padding: 10px; margin-bottom: 15px;">
            <p style="font-weight: bold; margin: 0 0 5px 0;">Licensee Information:</p>
            <p style="font-style: italic; margin: 0 0 10px 0; font-size: 10px;">In translating information fields from the license into English, I find the following is indicated on the license:</p>

            <div style="margin-bottom: 8px; display: flex; align-items: center;">
              <span style="width: 220px;">Country where the license was issued:</span>
              <input type="text" placeholder="" style="border: none; border-bottom: 1px solid #000; flex: 1; padding: 2px;" contenteditable="true" />
            </div>

            <div style="margin-bottom: 8px; display: flex; align-items: center;">
              <span style="width: 220px;">Full name of the license holder:</span>
              <input type="text" placeholder="" style="border: none; border-bottom: 1px solid #000; flex: 1; padding: 2px;" contenteditable="true" />
            </div>

            <div style="margin-bottom: 8px; display: flex; align-items: center;">
              <span style="width: 220px;">Date of birth (month/ day/ year):</span>
              <input type="text" placeholder="" style="border: none; border-bottom: 1px solid #000; flex: 1; padding: 2px;" contenteditable="true" />
            </div>

            <div style="margin-bottom: 8px; display: flex; align-items: center;">
              <span style="width: 220px;">Place of residence on license:</span>
              <input type="text" placeholder="" style="border: none; border-bottom: 1px solid #000; flex: 1; padding: 2px;" contenteditable="true" />
            </div>

            <div style="margin-bottom: 8px; display: flex; align-items: center;">
              <span style="width: 250px;">Type of vehicle for which the license is valid:</span>
              <input type="text" placeholder="" style="border: none; border-bottom: 1px solid #000; flex: 1; padding: 2px;" contenteditable="true" />
            </div>

            <div style="margin-bottom: 8px; display: flex; align-items: center; gap: 20px;">
              <div style="display: flex; align-items: center; flex: 1;">
                <span style="width: 150px;">Driver license number:</span>
                <input type="text" placeholder="" style="border: none; border-bottom: 1px solid #000; flex: 1; padding: 2px;" contenteditable="true" />
              </div>
              <div style="display: flex; align-items: center; flex: 1;">
                <span style="width: 100px;">Class of license:</span>
                <input type="text" placeholder="" style="border: none; border-bottom: 1px solid #000; flex: 1; padding: 2px;" contenteditable="true" />
              </div>
            </div>

            <div style="margin-bottom: 8px; display: flex; align-items: center; gap: 20px;">
              <div style="display: flex; align-items: center; flex: 1;">
                <span style="width: 120px;">License issue date:</span>
                <input type="text" placeholder="" style="border: none; border-bottom: 1px solid #000; flex: 1; padding: 2px;" contenteditable="true" />
              </div>
              <div style="display: flex; align-items: center; flex: 1;">
                <span style="width: 150px;">License expiration date:</span>
                <input type="text" placeholder="" style="border: none; border-bottom: 1px solid #000; flex: 1; padding: 2px;" contenteditable="true" />
              </div>
            </div>

            <p style="font-weight: bold; margin: 10px 0 0 0; font-size: 10px;"><u>Note: A passport-sized photo of the person depicted on the license must be securely attached to this document in the area provided in the top right corner.</u></p>
          </div>

          <!-- Translator Attestation Box -->
          <div style="border: 1px solid #000; padding: 10px; margin-bottom: 10px;">
            <p style="font-weight: bold; margin: 0 0 5px 0;">Translator Attestation:</p>
            <p style="margin: 0 0 10px 0; font-size: 10px;">I understand that the original driver's license document for this certified translation and the translation itself may be relied on by law enforcement officers and/or other drivers (in the event of a crash) to properly identify the individual shown on the driver's license and I further understand that false statements may be punished by fine, imprisonment, or both (M.G.L. Chapter 90, Section 24).</p>

            <div style="margin-bottom: 8px; display: flex; align-items: center; gap: 20px;">
              <div style="display: flex; align-items: center; flex: 2;">
                <span style="width: 180px;">Translator's name (printed):</span>
                <input type="text" value="Beatriz Paiva" style="border: none; border-bottom: 1px solid #000; flex: 1; padding: 2px;" contenteditable="true" />
              </div>
              <div style="display: flex; align-items: center; flex: 1;">
                <span style="width: 40px;">Date:</span>
                <input type="text" placeholder="" style="border: none; border-bottom: 1px solid #000; flex: 1; padding: 2px;" contenteditable="true" />
              </div>
            </div>

            <div style="margin-bottom: 8px; display: flex; align-items: center;">
              <span style="width: 150px;">Translator's full address:</span>
              <input type="text" value="867 Boylston Street, 5th Floor, #2073, Boston, MA 02116" style="border: none; border-bottom: 1px solid #000; flex: 1; padding: 2px;" contenteditable="true" />
            </div>

            <div style="margin-bottom: 8px; display: flex; align-items: center;">
              <span style="width: 220px;">Translator's tel. number/ Email address:</span>
              <input type="text" value="(857) 316-7770 / contact@legacytranslations.com" style="border: none; border-bottom: 1px solid #000; flex: 1; padding: 2px;" contenteditable="true" />
            </div>

            <p style="margin: 5px 0;">Signed under the penalties of perjury:</p>

            <div style="margin-bottom: 5px; display: flex; align-items: center;">
              <span style="width: 150px;">Translator's signature:</span>
              <div style="border-bottom: 1px solid #000; flex: 1; height: 30px;"></div>
            </div>
          </div>

          <div style="text-align: right; font-size: 9px; color: #666;">LIC114_1118</div>
        </div>
      `
    },
    'rmv-formulario': {
      name: "RMV Formul√°rio",
      description: 'Tradu√ß√£o CNH',
      category: 'rmv-forms',
      isForm: true,
      formHTML: `
        <div style="font-family: Arial, sans-serif; font-size: 11px; line-height: 1.4; max-width: 750px; margin: 0 auto; padding: 20px; background: #fff;">
          <!-- Header -->
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; border-bottom: 2px solid #003366; padding-bottom: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="width: 55px; height: 55px; border: 2px solid #003366; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 7px; text-align: center; color: #003366; font-weight: bold;">
                <div>Commonwealth<br/>of<br/>Massachusetts</div>
              </div>
              <div style="display: flex; gap: 2px;">
                <div style="background: #000; color: #fff; padding: 6px 10px; font-weight: bold; font-size: 14px;">r</div>
                <div style="background: #cc0000; color: #fff; padding: 6px 10px; font-weight: bold; font-size: 14px;">m</div>
                <div style="background: #003366; color: #fff; padding: 6px 10px; font-weight: bold; font-size: 14px;">v</div>
              </div>
              <div style="font-size: 9px; color: #666; text-transform: uppercase;">Registry of<br/>Motor Vehicles</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 20px; font-weight: bold; color: #003366;">Translation into English</div>
              <div style="font-size: 16px; font-weight: bold; color: #003366;">of a Foreign Driver License</div>
            </div>
            <div style="border: 2px solid #000; width: 110px; height: 130px; display: flex; align-items: center; justify-content: center; font-size: 10px; text-align: center; color: #666;">
              <div>Attach<br/>passport-sized<br/>photo here</div>
            </div>
          </div>

          <!-- Yellow Box Notice -->
          <div style="background: #fff8dc; border: 2px solid #d4a800; padding: 12px; margin-bottom: 15px; font-size: 10px;">
            <p style="margin: 0 0 8px 0; font-style: italic;"><em>Massachusetts General Law (Chapter 90, Section 10) was changed July 2018. Everyone operating a motor vehicle in Massachusetts with a foreign driver's license that is not written in English must carry either this completed translation, an International Driving Permit (IDP) issued from the country that issued the license, or an alternative translation document that contains a photo and English translation that closely matches the information from an IDP.</em></p>
            <p style="margin: 0; font-weight: bold; font-style: italic;"><em>This form must be completed <u>for</u> an applicant who does not have an IDP or alternative translation document and whose license is not written in English.</em></p>
          </div>

          <!-- Qualified Translator Section -->
          <div style="margin-bottom: 15px;">
            <p style="font-weight: bold; margin-bottom: 12px; font-size: 12px;">All information below must be completed by a <u>qualified</u> translator.</p>

            <p style="margin-bottom: 8px;">I hereby certify that this is a true and complete original translation from (original language)</p>
            <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 12px; flex-wrap: wrap;">
              <input type="text" style="border: none; border-bottom: 2px solid #003366; width: 180px; padding: 4px; font-size: 11px; background: #f8f9fa;" />
              <span>into English of a driver's license issued by the Country of</span>
              <input type="text" style="border: none; border-bottom: 2px solid #003366; width: 180px; padding: 4px; font-size: 11px; background: #f8f9fa;" />
            </div>

            <p style="margin-bottom: 10px;">I further certify that I speak the language of the original driver's license fluently and I (check one):</p>

            <div style="margin-left: 25px; margin-bottom: 10px;">
              <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px;">
                <input type="checkbox" style="margin-top: 4px; width: 16px; height: 16px;" />
                <span>Work for a college, university, or private language school. Name, Address, and Department:</span>
              </div>
              <input type="text" style="border: none; border-bottom: 2px solid #003366; width: calc(100% - 30px); padding: 4px; margin-left: 26px; font-size: 11px; background: #f8f9fa;" />
            </div>

            <div style="margin-left: 25px; margin-bottom: 10px;">
              <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px;">
                <input type="checkbox" style="margin-top: 4px; width: 16px; height: 16px;" />
                <span>Work for a local consulate. Name and Address of Consulate:</span>
              </div>
              <input type="text" style="border: none; border-bottom: 2px solid #003366; width: calc(100% - 30px); padding: 4px; margin-left: 26px; font-size: 11px; background: #f8f9fa;" />
            </div>

            <div style="margin-left: 25px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" style="width: 16px; height: 16px;" />
              <span>Am a Massachusetts bilingual notary public <span style="color: #666;">------------------------</span> (place official notary seal below)</span>
            </div>

            <div style="margin-left: 25px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" checked style="width: 16px; height: 16px;" />
              <span><strong>Am a member of the American Translators Association</strong></span>
            </div>
          </div>

          <!-- Licensee Information Box -->
          <div style="border: 2px solid #003366; padding: 15px; margin-bottom: 15px; background: #fafafa;">
            <p style="font-weight: bold; margin: 0 0 5px 0; font-size: 13px; color: #003366;">Licensee Information:</p>
            <p style="font-style: italic; margin: 0 0 12px 0; font-size: 10px; color: #555;">In translating information fields from the license into English, I find the following is indicated on the license:</p>

            <div style="margin-bottom: 10px; display: flex; align-items: center;">
              <span style="width: 240px; font-weight: 500;">Country where the license was issued:</span>
              <input type="text" style="border: none; border-bottom: 2px solid #003366; flex: 1; padding: 4px; font-size: 11px; background: #fff;" />
            </div>

            <div style="margin-bottom: 10px; display: flex; align-items: center;">
              <span style="width: 240px; font-weight: 500;">Full name of the license holder:</span>
              <input type="text" style="border: none; border-bottom: 2px solid #003366; flex: 1; padding: 4px; font-size: 11px; background: #fff;" />
            </div>

            <div style="margin-bottom: 10px; display: flex; align-items: center;">
              <span style="width: 240px; font-weight: 500;">Date of birth (month/day/year):</span>
              <input type="text" style="border: none; border-bottom: 2px solid #003366; flex: 1; padding: 4px; font-size: 11px; background: #fff;" />
            </div>

            <div style="margin-bottom: 10px; display: flex; align-items: center;">
              <span style="width: 240px; font-weight: 500;">Place of residence on license:</span>
              <input type="text" style="border: none; border-bottom: 2px solid #003366; flex: 1; padding: 4px; font-size: 11px; background: #fff;" />
            </div>

            <div style="margin-bottom: 10px; display: flex; align-items: center;">
              <span style="width: 270px; font-weight: 500;">Type of vehicle for which the license is valid:</span>
              <input type="text" style="border: none; border-bottom: 2px solid #003366; flex: 1; padding: 4px; font-size: 11px; background: #fff;" />
            </div>

            <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 25px;">
              <div style="display: flex; align-items: center; flex: 1;">
                <span style="width: 160px; font-weight: 500;">Driver license number:</span>
                <input type="text" style="border: none; border-bottom: 2px solid #003366; flex: 1; padding: 4px; font-size: 11px; background: #fff;" />
              </div>
              <div style="display: flex; align-items: center; flex: 1;">
                <span style="width: 110px; font-weight: 500;">Class of license:</span>
                <input type="text" style="border: none; border-bottom: 2px solid #003366; flex: 1; padding: 4px; font-size: 11px; background: #fff;" />
              </div>
            </div>

            <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 25px;">
              <div style="display: flex; align-items: center; flex: 1;">
                <span style="width: 130px; font-weight: 500;">License issue date:</span>
                <input type="text" style="border: none; border-bottom: 2px solid #003366; flex: 1; padding: 4px; font-size: 11px; background: #fff;" />
              </div>
              <div style="display: flex; align-items: center; flex: 1;">
                <span style="width: 160px; font-weight: 500;">License expiration date:</span>
                <input type="text" style="border: none; border-bottom: 2px solid #003366; flex: 1; padding: 4px; font-size: 11px; background: #fff;" />
              </div>
            </div>

            <p style="font-weight: bold; margin: 12px 0 0 0; font-size: 10px; color: #cc0000;"><u>Note: A passport-sized photo of the person depicted on the license must be securely attached to this document in the area provided in the top right corner.</u></p>
          </div>

          <!-- Translator Attestation Box -->
          <div style="border: 2px solid #003366; padding: 15px; margin-bottom: 10px; background: #fafafa;">
            <p style="font-weight: bold; margin: 0 0 8px 0; font-size: 13px; color: #003366;">Translator Attestation:</p>
            <p style="margin: 0 0 12px 0; font-size: 10px; line-height: 1.5;">I understand that the original driver's license document for this certified translation and the translation itself may be relied on by law enforcement officers and/or other drivers (in the event of a crash) to properly identify the individual shown on the driver's license and I further understand that false statements may be punished by fine, imprisonment, or both (M.G.L. Chapter 90, Section 24).</p>

            <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 25px;">
              <div style="display: flex; align-items: center; flex: 2;">
                <span style="width: 190px; font-weight: 500;">Translator's name (printed):</span>
                <input type="text" value="Beatriz Paiva" style="border: none; border-bottom: 2px solid #003366; flex: 1; padding: 4px; font-size: 11px; background: #fff; font-weight: bold;" />
              </div>
              <div style="display: flex; align-items: center; flex: 1;">
                <span style="width: 50px; font-weight: 500;">Date:</span>
                <input type="text" style="border: none; border-bottom: 2px solid #003366; flex: 1; padding: 4px; font-size: 11px; background: #fff;" />
              </div>
            </div>

            <div style="margin-bottom: 10px; display: flex; align-items: center;">
              <span style="width: 160px; font-weight: 500;">Translator's full address:</span>
              <input type="text" value="867 Boylston Street, 5th Floor, #2073, Boston, MA 02116" style="border: none; border-bottom: 2px solid #003366; flex: 1; padding: 4px; font-size: 11px; background: #fff;" />
            </div>

            <div style="margin-bottom: 10px; display: flex; align-items: center;">
              <span style="width: 235px; font-weight: 500;">Translator's tel. number / Email address:</span>
              <input type="text" value="(857) 316-7770 / contact@legacytranslations.com" style="border: none; border-bottom: 2px solid #003366; flex: 1; padding: 4px; font-size: 11px; background: #fff;" />
            </div>

            <p style="margin: 8px 0; font-weight: 500;">Signed under the penalties of perjury:</p>

            <div style="margin-bottom: 5px; display: flex; align-items: flex-end;">
              <span style="width: 160px; font-weight: 500;">Translator's signature:</span>
              <div style="border-bottom: 2px solid #003366; flex: 1; height: 35px; background: #fff;"></div>
            </div>
          </div>

          <div style="text-align: right; font-size: 9px; color: #666; margin-top: 5px;">LIC114_1118</div>
        </div>
      `
    },
    'rmv-documents': {
      name: "RMV Certification",
      description: 'Translation Accuracy',
      category: 'rmv-forms',
      isForm: true,
      formHTML: `
        <div style="font-family: 'Times New Roman', Times, serif; font-size: 14px; line-height: 2; max-width: 700px; margin: 0 auto; padding: 60px 50px; background: #fff;">

          <!-- Title -->
          <h1 style="text-align: center; font-size: 15px; font-weight: bold; margin-bottom: 60px; letter-spacing: 0.5px;">
            CERTIFICATION OF TRANSLATION ACCURACY AND COMPLETION
          </h1>

          <!-- Main Certification Paragraph -->
          <p style="text-align: justify; text-indent: 50px; margin-bottom: 40px; line-height: 2;">
            I hereby certify that this is a true and complete original translation from <strong><span style="border-bottom: 1px solid #000; display: inline-block; min-width: 80px; padding: 0 5px;" contenteditable="true">Spanish</span></strong> into English of a <strong><span style="border-bottom: 1px solid #000; display: inline-block; min-width: 120px; padding: 0 5px;" contenteditable="true">Birth Certificate</span></strong> that I have translated. I further certify that I speak the language of the original document fluently and I am a translator and sole proprietor of Legacy Translations LLC (ATA member under # 275993). I understand that the original document and this certified translation may be presented to the Massachusetts Registry of Motor Vehicles (RMV) in support of an application for a permit, license, or Identification Card, and I further understand that false statements to the RMV may be punished by fine, imprisonment, or both (M.G.L. Chapter 90, Section 24).
          </p>

          <!-- Blank Space -->
          <div style="height: 80px;"></div>

          <!-- Fields Section -->
          <div style="margin-top: 40px; line-height: 2.2;">
            <p style="margin-bottom: 18px;">
              <strong>Applicant's Name:</strong> <span style="border-bottom: 1px solid #000; display: inline-block; min-width: 420px; padding: 0 5px;" contenteditable="true">&nbsp;</span>
            </p>

            <p style="margin-bottom: 18px;">
              <strong>Translator's Full Address:</strong> <span style="border-bottom: 1px solid #000; display: inline-block; min-width: 350px; padding: 0 5px;" contenteditable="true">867 Boylston Street, 5th Floor, #2073, Boston, MA 02116</span>
            </p>

            <p style="margin-bottom: 18px;">
              <strong>Translator's Telephone Number:</strong> <span style="border-bottom: 1px solid #000; display: inline-block; min-width: 300px; padding: 0 5px;" contenteditable="true">(857) 316-7770</span>
            </p>

            <p style="margin-bottom: 18px;">
              <strong>Translator's Name:</strong> <span style="border-bottom: 1px solid #000; display: inline-block; min-width: 380px; padding: 0 5px;" contenteditable="true">Beatriz Paiva</span>
            </p>

            <p style="margin-bottom: 10px;">
              <strong>Translator's Signature:</strong> <span style="border-bottom: 1px solid #000; display: inline-block; min-width: 250px; height: 22px;">&nbsp;</span>
              <strong style="margin-left: 40px;">Date:</strong><span style="border-bottom: 1px solid #000; display: inline-block; min-width: 150px; padding: 0 5px;" contenteditable="true">&nbsp;</span>
            </p>
          </div>

        </div>
      `
    },
    'cnh-brasil': {
      name: "CNH Brasil",
      description: 'Driver License',
      category: 'brazil-docs',
      isForm: true,
      formHTML: `
        <div style="font-family: Arial, sans-serif; font-size: 10px; line-height: 1.3; max-width: 800px; margin: 0 auto; padding: 0; background: #fff;">

          <!-- Green Header -->
          <div style="background: linear-gradient(135deg, #006847 0%, #004d35 100%); color: #fff; padding: 8px 15px; display: flex; align-items: center; justify-content: space-between;">
            <div>
              <div style="font-size: 14px; font-weight: bold;">REP√öBLICA FEDERATIVA DO BRASIL</div>
              <div style="font-size: 9px;">MINIST√âRIO DOS TRANSPORTES</div>
              <div style="font-size: 9px;">SECRETARIA NACIONAL DE TR√ÇNSITO - SENATRAN</div>
            </div>
            <div style="font-size: 16px; font-weight: bold; color: #ffdf00;">gov.br</div>
          </div>

          <!-- Main Card -->
          <div style="border: 2px solid #006847; margin: 10px; padding: 0;">

            <!-- Card Header -->
            <div style="background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%); padding: 8px 10px; border-bottom: 2px solid #006847; display: flex; align-items: center; justify-content: space-between;">
              <div style="text-align: center; flex: 1;">
                <div style="font-size: 9px; font-weight: bold;">REP√öBLICA FEDERATIVA DO BRASIL</div>
                <div style="font-size: 8px;">MINIST√âRIO DOS TRANSPORTES</div>
                <div style="font-size: 8px;">SECRETARIA NACIONAL DE TR√ÇNSITO</div>
              </div>
              <div style="background: #006847; color: #fff; padding: 5px 10px; border-radius: 3px; font-weight: bold; font-size: 12px;">BR</div>
            </div>

            <!-- Title -->
            <div style="background: #006847; color: #fff; text-align: center; padding: 5px; font-size: 10px; font-weight: bold;">
              CARTEIRA NACIONAL DE HABILITA√á√ÉO / DRIVER LICENSE / PERMISO DE CONDUCCI√ìN
            </div>

            <!-- Main Content -->
            <div style="display: flex; padding: 10px; gap: 10px;">

              <!-- Left: Photo and Barcode -->
              <div style="width: 120px;">
                <div style="border: 1px solid #000; height: 150px; display: flex; align-items: center; justify-content: center; background: #f9f9f9; margin-bottom: 8px;">
                  <span style="font-size: 8px; color: #666; text-align: center;">Photo<br/>3x4</span>
                </div>
                <div style="writing-mode: vertical-rl; text-orientation: mixed; font-size: 8px; background: #000; color: #fff; padding: 3px; text-align: center;">
                  V√ÅLIDO EM TODO O TERRIT√ìRIO NACIONAL
                </div>
                <div style="margin-top: 5px; font-size: 9px; text-align: center;" contenteditable="true">5005512811</div>
              </div>

              <!-- Right: Information Fields -->
              <div style="flex: 1;">

                <!-- Row 1: Name and First License -->
                <div style="display: flex; gap: 10px; margin-bottom: 6px;">
                  <div style="flex: 2;">
                    <div style="font-size: 7px; color: #666;">2+9 NOME E SOBRENOME / NAME AND SURNAME / NOMBRE Y APELLIDOS</div>
                    <div style="border-bottom: 1px solid #ccc; padding: 2px; font-weight: bold; font-size: 10px;" contenteditable="true"></div>
                  </div>
                  <div style="width: 80px;">
                    <div style="font-size: 7px; color: #666;">1¬™ HABILITA√á√ÉO / FIRST LICENSE</div>
                    <div style="border-bottom: 1px solid #ccc; padding: 2px; font-size: 10px;" contenteditable="true"></div>
                  </div>
                </div>

                <!-- Row 2: Birth Date/Place -->
                <div style="margin-bottom: 6px;">
                  <div style="font-size: 7px; color: #666;">3 DATA, LOCAL E UF DE NASCIMENTO / DATE AND PLACE OF BIRTH</div>
                  <div style="border-bottom: 1px solid #ccc; padding: 2px; font-size: 10px;" contenteditable="true"></div>
                </div>

                <!-- Row 3: Issue Date, Validity, ACC -->
                <div style="display: flex; gap: 10px; margin-bottom: 6px;">
                  <div style="flex: 1;">
                    <div style="font-size: 7px; color: #666;">4a DATA EMISS√ÉO / ISSUE DATE</div>
                    <div style="border-bottom: 1px solid #ccc; padding: 2px; font-size: 10px;" contenteditable="true"></div>
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 7px; color: #666;">4b VALIDADE / EXPIRY DATE</div>
                    <div style="border-bottom: 1px solid #ccc; padding: 2px; font-size: 10px; color: #c00;" contenteditable="true"></div>
                  </div>
                  <div style="width: 60px;">
                    <div style="font-size: 7px; color: #666;">ACC</div>
                    <div style="border: 1px solid #000; padding: 2px; font-size: 10px; text-align: center; background: #f0f0f0;" contenteditable="true">P</div>
                  </div>
                </div>

                <!-- Row 4: ID Document -->
                <div style="margin-bottom: 6px;">
                  <div style="font-size: 7px; color: #666;">4c DOC IDENTIDADE / ORG EMISSOR / UF - ID DOCUMENT / ISSUING AUTHORITY</div>
                  <div style="border-bottom: 1px solid #ccc; padding: 2px; font-size: 10px;" contenteditable="true"></div>
                </div>

                <!-- Row 5: CPF, Registration, Category -->
                <div style="display: flex; gap: 10px; margin-bottom: 6px;">
                  <div style="flex: 1;">
                    <div style="font-size: 7px; color: #666;">4d CPF</div>
                    <div style="border-bottom: 1px solid #ccc; padding: 2px; font-size: 10px;" contenteditable="true"></div>
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 7px; color: #666;">5 N¬∫ REGISTRO / REGISTRATION NUMBER</div>
                    <div style="border-bottom: 1px solid #ccc; padding: 2px; font-size: 10px; color: #c00;" contenteditable="true"></div>
                  </div>
                  <div style="width: 50px;">
                    <div style="font-size: 7px; color: #666;">9 CAT/HAB</div>
                    <div style="border: 1px solid #c00; padding: 2px; font-size: 12px; text-align: center; font-weight: bold; color: #c00; background: #fff0f0;" contenteditable="true">B</div>
                  </div>
                </div>

                <!-- Row 6: Nationality -->
                <div style="margin-bottom: 6px;">
                  <div style="font-size: 7px; color: #666;">10 NACIONALIDADE / NATIONALITY</div>
                  <div style="border-bottom: 1px solid #ccc; padding: 2px; font-size: 10px;" contenteditable="true">BRASILEIRO(A) / BRAZILIAN</div>
                </div>

                <!-- Row 7: Parents -->
                <div style="margin-bottom: 6px;">
                  <div style="font-size: 7px; color: #666;">8 FILIA√á√ÉO / PARENTS</div>
                  <div style="border-bottom: 1px solid #ccc; padding: 2px; font-size: 10px;" contenteditable="true"></div>
                  <div style="border-bottom: 1px solid #ccc; padding: 2px; font-size: 10px;" contenteditable="true"></div>
                </div>

                <!-- Row 8: Signature -->
                <div>
                  <div style="font-size: 7px; color: #666;">7 ASSINATURA DO PORTADOR / HOLDER'S SIGNATURE</div>
                  <div style="border: 1px solid #ccc; height: 30px; background: #fafafa;"></div>
                </div>

              </div>
            </div>

            <!-- Categories Table -->
            <div style="padding: 10px; border-top: 1px solid #ccc;">
              <div style="display: flex; gap: 20px;">
                <table style="border-collapse: collapse; font-size: 8px; flex: 1;">
                  <tr>
                    <td style="border: 1px solid #000; padding: 2px 5px; background: #f0f0f0;">ACC</td>
                    <td style="border: 1px solid #000; padding: 2px 10px;" contenteditable="true"></td>
                    <td style="border: 1px solid #000; padding: 2px 5px; background: #f0f0f0;">D</td>
                    <td style="border: 1px solid #000; padding: 2px 10px;" contenteditable="true"></td>
                  </tr>
                  <tr>
                    <td style="border: 1px solid #000; padding: 2px 5px; background: #f0f0f0;">A</td>
                    <td style="border: 1px solid #000; padding: 2px 10px;" contenteditable="true"></td>
                    <td style="border: 1px solid #000; padding: 2px 5px; background: #f0f0f0;">D1</td>
                    <td style="border: 1px solid #000; padding: 2px 10px;" contenteditable="true"></td>
                  </tr>
                  <tr>
                    <td style="border: 1px solid #000; padding: 2px 5px; background: #f0f0f0;">A1</td>
                    <td style="border: 1px solid #000; padding: 2px 10px;" contenteditable="true"></td>
                    <td style="border: 1px solid #000; padding: 2px 5px; background: #f0f0f0;">BE</td>
                    <td style="border: 1px solid #000; padding: 2px 10px;" contenteditable="true"></td>
                  </tr>
                  <tr>
                    <td style="border: 1px solid #000; padding: 2px 5px; background: #f0f0f0;">A2</td>
                    <td style="border: 1px solid #000; padding: 2px 10px;" contenteditable="true"></td>
                    <td style="border: 1px solid #000; padding: 2px 5px; background: #f0f0f0;">CE</td>
                    <td style="border: 1px solid #000; padding: 2px 10px;" contenteditable="true"></td>
                  </tr>
                  <tr>
                    <td style="border: 1px solid #000; padding: 2px 5px; background: #f0f0f0;">B</td>
                    <td style="border: 1px solid #000; padding: 2px 10px;" contenteditable="true"></td>
                    <td style="border: 1px solid #000; padding: 2px 5px; background: #f0f0f0;">C1E</td>
                    <td style="border: 1px solid #000; padding: 2px 10px;" contenteditable="true"></td>
                  </tr>
                  <tr>
                    <td style="border: 1px solid #000; padding: 2px 5px; background: #f0f0f0;">B1</td>
                    <td style="border: 1px solid #000; padding: 2px 10px;" contenteditable="true"></td>
                    <td style="border: 1px solid #000; padding: 2px 5px; background: #f0f0f0;">DE</td>
                    <td style="border: 1px solid #000; padding: 2px 10px;" contenteditable="true"></td>
                  </tr>
                  <tr>
                    <td style="border: 1px solid #000; padding: 2px 5px; background: #f0f0f0;">C</td>
                    <td style="border: 1px solid #000; padding: 2px 10px;" contenteditable="true"></td>
                    <td style="border: 1px solid #000; padding: 2px 5px; background: #f0f0f0;">D1E</td>
                    <td style="border: 1px solid #000; padding: 2px 10px;" contenteditable="true"></td>
                  </tr>
                  <tr>
                    <td style="border: 1px solid #000; padding: 2px 5px; background: #f0f0f0;">C1</td>
                    <td style="border: 1px solid #000; padding: 2px 10px;" contenteditable="true"></td>
                    <td style="border: 1px solid #000; padding: 2px 5px; background: #f0f0f0;"></td>
                    <td style="border: 1px solid #000; padding: 2px 10px;"></td>
                  </tr>
                </table>

                <!-- Observations -->
                <div style="flex: 1;">
                  <div style="font-size: 7px; color: #666; margin-bottom: 3px;">12 OBSERVA√á√ïES / OBSERVATIONS / OBSERVACIONES</div>
                  <div style="border: 1px solid #ccc; min-height: 80px; padding: 5px; font-size: 9px;" contenteditable="true">EAR</div>
                </div>
              </div>
            </div>

            <!-- Footer with Location -->
            <div style="display: flex; justify-content: space-between; padding: 8px 10px; border-top: 1px solid #ccc; background: #f5f5f5;">
              <div>
                <div style="font-size: 7px; color: #666;">LOCAL / PLACE</div>
                <div style="font-size: 10px;" contenteditable="true">S√ÉO PAULO, SP</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 7px; color: #666;">ASSINADO DIGITALMENTE / DIGITALLY SIGNED</div>
                <div style="font-size: 8px;">DEPARTAMENTO ESTADUAL DE TR√ÇNSITO</div>
                <div style="font-size: 9px;" contenteditable="true">15575604402</div>
                <div style="font-size: 9px;" contenteditable="true">SP027650816</div>
              </div>
            </div>

          </div>

          <!-- State Name -->
          <div style="text-align: center; margin: 10px 0;">
            <div style="font-size: 18px; font-weight: bold;" contenteditable="true">S√ÉO PAULO</div>
          </div>

          <!-- QR Code Section -->
          <div style="margin: 10px; padding: 15px; border: 1px solid #ccc; display: flex; gap: 20px;">
            <div>
              <div style="font-weight: bold; margin-bottom: 10px;">QR-CODE</div>
              <div style="width: 120px; height: 120px; border: 1px solid #000; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #666;">
                QR Code<br/>Area
              </div>
            </div>
            <div style="flex: 1; font-size: 9px; line-height: 1.5;">
              <p>Documento assinado com certificado digital em conformidade com a Medida Provis√≥ria n¬∫ 2200-2/2001. Sua validade poder√° ser confirmada por meio do programa Assinador Serpro.</p>
              <p style="margin-top: 10px;">As orienta√ß√µes to instalar o Assinador Serpro e realizar a valida√ß√£o do document digital est√£o dispon√≠veis em:<br/>
              <strong>https://www.serpro.gov.br/assinador-digital</strong></p>
              <div style="margin-top: 15px; text-align: right;">
                <span style="font-weight: bold; color: #006847;">SERPRO</span> / <span style="font-weight: bold;">SENATRAN</span>
              </div>
            </div>
          </div>

          <!-- Legend -->
          <div style="margin: 10px; padding: 10px; background: #f5f5f5; font-size: 7px; line-height: 1.6; border: 1px solid #ddd;">
            <div><strong>2+9.</strong> Nome e Sobrenome / Name and Surname / Nombre y Apellidos - <strong>1¬™ Habilita√ß√£o</strong> - Primeira Habilita√ß√£o / First Driver License / Primera Licencia de Conducir - <strong>3.</strong> Data e Local de Nascimento / Date and Place of Birth (DD/MM/YYYY) / Fecha y Lugar de Nacimiento - <strong>4a.</strong> Data de Emiss√£o / Issuing Date (DD/MM/YYYY) / Fecha de Emisi√≥n - <strong>4b.</strong> Data de Validade / Expiration Date (DD/MM/YYYY) / Golido Hasta - <strong>ACC</strong> - Autoriza√ß√£o to Conduzir Ciclomotor / Moped Authorization / Autorizaci√≥n Ciclomotor - <strong>4c.</strong> Documento de Identifica√ß√£o / Identity Document / Documento de Identificaci√≥n - √ìrg√£o emissor / Issuing Authority / Autoridad Emisora - <strong>4d.</strong> CPF - <strong>5.</strong> N√∫mero de registro da CNH / Driver License Number / N√∫mero de Permiso de Conducir - <strong>9.</strong> Categoria de Ve√≠culos de Carteira de Habilita√ß√£o / Driver license Class / Categor√≠a de Permiso de Conducir - Nacionalidade / Nationality / Nacionalidad - <strong>8.</strong> Filia√ß√£o / Filiation / Filiaci√≥n - <strong>12.</strong> Observa√ß√µes / Observations / Observaciones - Local / Place / Lugar</div>
          </div>

          <!-- MRZ Code -->
          <div style="margin: 10px; padding: 10px; background: #fff; font-family: 'Courier New', monospace; font-size: 11px; letter-spacing: 1px; border: 1px solid #000;">
            <div contenteditable="true">I&lt;BRA0897718O1&lt;218&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</div>
            <div contenteditable="true">0501068F2604228BRA&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;4</div>
            <div contenteditable="true">SURNAME&lt;&lt;GIVEN&lt;NAMES&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</div>
          </div>

        </div>
      `
    }
  };

  const [files, setFiles] = useState([]);
  const [ocrResults, setOcrResults] = useState([]);
  const [ocrViewMode, setOcrViewMode] = useState('text'); // 'text' or 'html' for layout view
  const [translationResults, setTranslationResults] = useState([]);
  const [isProcessing, setIsProcessing] = useState(false);
  const [processingStatus, setProcessingStatus] = useState('');
  const [selectedResultIndex, setSelectedResultIndex] = useState(0);
  const [translationEditMode, setTranslationEditMode] = useState(false); // Edit mode for in-house translators in TRANSLATION tab

  // Proofreading state (admin only)
  const [proofreadingResult, setProofreadingResult] = useState(null);
  const [isProofreading, setIsProofreading] = useState(false);
  const [proofreadingError, setProofreadingError] = useState('');
  const [highlightedErrorIndex, setHighlightedErrorIndex] = useState(null);
  const [highlightedPmErrorIndex, setHighlightedPmErrorIndex] = useState(null);

  // Rejection modal state (PM/Admin)
  const [showRejectModal, setShowRejectModal] = useState(false);
  const [availableTranslators, setAvailableTranslators] = useState([]);
  const [loadingTranslators, setLoadingTranslators] = useState(false);
  const [selectedTranslatorForReject, setSelectedTranslatorForReject] = useState('');
  const [rejectReason, setRejectReason] = useState('');

  // Restore session modal state
  const [showRestoreModal, setShowRestoreModal] = useState(false);
  const [restoreSessionData, setRestoreSessionData] = useState(null);
  const [restorePromptsDisabled, setRestorePromptsDisabled] = useState(() =>
    localStorage.getItem('translation_restore_disabled') === 'true'
  );

  // Config state - initialize from selectedOrder if available
  const [sourceLanguage, setSourceLanguage] = useState('Portuguese (Brazil)');
  const [targetLanguage, setTargetLanguage] = useState('English');
  const [documentType, setDocumentType] = useState('Birth Certificate');
  const [orderNumber, setOrderNumber] = useState('');
  const [selectedTranslator, setSelectedTranslator] = useState(TRANSLATORS[0].name);
  const [savedTranslatorName, setSavedTranslatorName] = useState(''); // Saved translator name from database - DO NOT change on UI selection
  const [translationDate, setTranslationDate] = useState(new Date().toLocaleDateString('en-US', { timeZone: 'America/New_York' }));
  const [claudeApiKey, setClaudeApiKey] = useState('');
  const [pageFormat, setPageFormat] = useState('letter'); // 'letter' or 'a4'
  const [translationType, setTranslationType] = useState('certified'); // 'certified' or 'sworn'
  const [generalInstructions, setGeneralInstructions] = useState('');
  const [includeCover, setIncludeCover] = useState(true);
  const [includeLetterhead, setIncludeLetterhead] = useState(true);
  const [includeOriginal, setIncludeOriginal] = useState(true);
  const [includeVerificationPage, setIncludeVerificationPage] = useState(true);
  const [includeCertification, setIncludeCertification] = useState(true);
  const [certificationData, setCertificationData] = useState(null);
  const [originalImages, setOriginalImages] = useState([]); // base64 images of originals

  // Workflow Mode: 'ai', 'external', or 'ocr'
  const [workflowMode, setWorkflowMode] = useState('ai');
  const [documentCategory, setDocumentCategory] = useState('general'); // 'financial', 'education', 'general', 'personal'
  const [externalOriginalImages, setExternalOriginalImages] = useState([]); // Original document images
  const [externalTranslationText, setExternalTranslationText] = useState(''); // External translation text
  const [externalTranslationImages, setExternalTranslationImages] = useState([]); // External translation as images (if PDF)

  // Correction state
  const [correctionCommand, setCorrectionCommand] = useState('');
  const [applyingCorrection, setApplyingCorrection] = useState(false);
  const [claudeNotes, setClaudeNotes] = useState(''); // Notes/changes made by Claude

  // Send to Projects state
  const [availableOrders, setAvailableOrders] = useState([]);
  const [selectedOrderId, setSelectedOrderId] = useState('');
  const [sendingToProjects, setSendingToProjects] = useState(false);
  const [sendDestination, setSendDestination] = useState('pending_admin_approval'); // 'pending_admin_approval', 'pm', or 'finalize_admin'

  // Resources state
  const [instructions, setInstructions] = useState([]);
  const [glossaries, setGlossaries] = useState([]);
  const [showInstructionModal, setShowInstructionModal] = useState(false);
  const [showGlossaryModal, setShowGlossaryModal] = useState(false);
  const [editingInstruction, setEditingInstruction] = useState(null);
  const [editingGlossary, setEditingGlossary] = useState(null);
  const [instructionForm, setInstructionForm] = useState({ sourceLang: 'All Languages', targetLang: 'All Languages', title: '', content: '', field: 'All Fields', documentType: 'All Documents' });
  const [glossaryForm, setGlossaryForm] = useState({
    name: '',
    sourceLang: 'Portuguese (Brazil)',
    targetLang: 'English',
    bidirectional: true,  // Create entries for both directions
    field: 'All Fields',
    terms: []
  });
  const [newTerm, setNewTerm] = useState({ source: '', target: '', notes: '' });
  const [termSearchQuery, setTermSearchQuery] = useState(''); // Search filter for glossary terms
  const [resourcesFilter, setResourcesFilter] = useState({ language: 'All Languages', field: 'All Fields' });

  // Glossary Upload Modal state
  const [showGlossaryUploadModal, setShowGlossaryUploadModal] = useState(false);
  const [glossaryUploadFile, setGlossaryUploadFile] = useState(null);
  const [glossaryUploadConfig, setGlossaryUploadConfig] = useState({
    name: '',
    sourceLang: 'Portuguese (Brazil)',
    targetLang: 'English',
    field: 'All Fields',
    bidirectional: true
  });

  // Translation Memory state
  const [translationMemories, setTranslationMemories] = useState([]);
  const [tmFilter, setTmFilter] = useState({ sourceLang: '', targetLang: '', field: '' });

  // TM Upload Modal state
  const [showTmUploadModal, setShowTmUploadModal] = useState(false);
  const [tmUploadFile, setTmUploadFile] = useState(null);
  const [tmUploadConfig, setTmUploadConfig] = useState({
    sourceLang: 'Portuguese (Brazil)',
    targetLang: 'English',
    field: 'General'
  });

  // TM Edit Modal state
  const [showTmEditModal, setShowTmEditModal] = useState(false);
  const [editingTmEntry, setEditingTmEntry] = useState(null);
  const [tmEditForm, setTmEditForm] = useState({
    source: '',
    target: '',
    sourceLang: '',
    targetLang: '',
    field: 'General'
  });

  // Translator's Note for Financial Documents (Bank Statements, Tax Returns)
  const [translatorNoteEnabled, setTranslatorNoteEnabled] = useState(false);
  const [translatorNoteSettings, setTranslatorNoteSettings] = useState({
    sourceCurrency: 'BRL',
    targetCurrency: 'USD',
    exchangeRate: '',
    rateDate: new Date().toISOString().split('T')[0],
    rateSource: 'xe.com',
    convertValues: true,
    customNote: ''
  });
  const [fetchingRate, setFetchingRate] = useState(false);

  // Fetch exchange rate from API (ExchangeRate-API for real-time rates)
  const fetchExchangeRate = async () => {
    setFetchingRate(true);
    try {
      // Using ExchangeRate-API (more accurate, real-time rates)
      const response = await fetch(
        `https://api.exchangerate-api.com/v4/latest/${translatorNoteSettings.targetCurrency}`
      );
      const data = await response.json();
      if (data.rates && data.rates[translatorNoteSettings.sourceCurrency]) {
        setTranslatorNoteSettings(prev => ({
          ...prev,
          exchangeRate: data.rates[translatorNoteSettings.sourceCurrency].toFixed(4),
          rateDate: data.date || new Date().toISOString().split('T')[0]
        }));
      } else {
        throw new Error('Rate not found');
      }
    } catch (error) {
      // Fallback to Frankfurter API (ECB rates)
      try {
        const response = await fetch(
          `https://api.frankfurter.app/latest?from=${translatorNoteSettings.targetCurrency}&to=${translatorNoteSettings.sourceCurrency}`
        );
        const data = await response.json();
        if (data.rates && data.rates[translatorNoteSettings.sourceCurrency]) {
          setTranslatorNoteSettings(prev => ({
            ...prev,
            exchangeRate: data.rates[translatorNoteSettings.sourceCurrency].toFixed(4),
            rateDate: data.date || new Date().toISOString().split('T')[0]
          }));
        }
      } catch (err) {
        console.error('Error fetching exchange rate:', err);
        showToast('Could not fetch exchange rate. Please enter manually.');
      }
    } finally {
      setFetchingRate(false);
    }
  };

  // Generate Translator's Note text
  const generateTranslatorNote = () => {
    const src = CURRENCIES[translatorNoteSettings.sourceCurrency];
    const tgt = CURRENCIES[translatorNoteSettings.targetCurrency];
    const rate = translatorNoteSettings.exchangeRate;
    // Fix: Parse date directly to avoid timezone conversion issues
    const dateParts = translatorNoteSettings.rateDate.split('-');
    const date = `${dateParts[1]}/${dateParts[2]}/${dateParts[0]}`; // MM/DD/YYYY format
    const source = RATE_SOURCES.find(s => s.id === translatorNoteSettings.rateSource);

    // Format: NOK 10.19 ‚âà US$1.00
    const noteText = `[TRANSLATOR'S NOTE: Converting ${src.name} into ${tgt.name} (Source: ${source?.url || 'https://www.xe.com/currencyconverter/'}), on this date ${date}, ${translatorNoteSettings.sourceCurrency} ${src.symbol}${rate} is equivalent (‚âà) to ${tgt.symbol}1.00 (One ${tgt.name}) / the corresponding total available balance in ${tgt.currency || 'dollar'} is between brackets [ ] below].`;

    return noteText;
  };

  // Convert a value from source to target currency
  const convertCurrencyValue = (value, addBrackets = true) => {
    if (!translatorNoteSettings.exchangeRate || !value) return value;
    const numValue = parseFloat(String(value).replace(/[^0-9.-]/g, ''));
    if (isNaN(numValue)) return value;
    const converted = numValue / parseFloat(translatorNoteSettings.exchangeRate);
    const tgt = CURRENCIES[translatorNoteSettings.targetCurrency];
    const formattedConverted = converted.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    if (addBrackets) {
      return `[<strong>${tgt.symbol}${formattedConverted}</strong>]`;
    }
    return `${tgt.symbol}${formattedConverted}`;
  };

  // Logo states (base64)
  const [logoLeft, setLogoLeft] = useState('');
  const [logoRight, setLogoRight] = useState('');
  const [logoStamp, setLogoStamp] = useState('');
  const [signatureImage, setSignatureImage] = useState('');

  // Certificate Header Info
  const [certCompanyName, setCertCompanyName] = useState('Legacy Translations Inc.');
  const [certCompanyAddress, setCertCompanyAddress] = useState('123 Business St, Suite 100');
  const [certCompanyPhone, setCertCompanyPhone] = useState('+1 (555) 123-4567');
  const [certCompanyEmail, setCertCompanyEmail] = useState('contact@legacytranslations.com');

  // Refs
  const fileInputRef = useRef(null);
  const logoLeftInputRef = useRef(null);
  const logoRightInputRef = useRef(null);
  const logoStampInputRef = useRef(null);
  const signatureInputRef = useRef(null);
  const originalTextRef = useRef(null);
  const translatedTextRef = useRef(null);
  const uploadOriginalRef = useRef(null);
  const uploadOcrRef = useRef(null);
  const editableRef = useRef(null);
  const externalOriginalInputRef = useRef(null);
  const externalTranslationInputRef = useRef(null);

  // OCR Editor state
  const [ocrFontFamily, setOcrFontFamily] = useState('monospace');
  const [ocrFontSize, setOcrFontSize] = useState('12px');
  const [useClaudeOcr, setUseClaudeOcr] = useState(false); // Default to AWS Textract
  const [ocrSpecialCommands, setOcrSpecialCommands] = useState('Maintain the EXACT original layout and formatting. Preserve all line breaks, spacing, and document structure. Extract tables with proper alignment.');

  // Approval checkboxes state
  const [approvalChecks, setApprovalChecks] = useState({
    projectNumber: false,
    languageCorrect: false,
    proofread: false,
    namesAccurate: false,
    formattingPreserved: false,
    translatorNotes: false,
    readyForDelivery: false
  });
  const [saveToTM, setSaveToTM] = useState(true); // Save to Translation Memory on approval

  // Quick Package state (for ready translations)
  const [quickPackageMode, setQuickPackageMode] = useState(false);
  const [quickTranslationFiles, setQuickTranslationFiles] = useState([]); // Ready translation files (images)
  const [quickTranslationHtml, setQuickTranslationHtml] = useState(''); // HTML content for translation (from Word/HTML/TXT)
  const [quickTranslationType, setQuickTranslationType] = useState('images'); // 'images' or 'html'
  const [quickOriginalFiles, setQuickOriginalFiles] = useState([]); // Original document files
  const [quickPackageLoading, setQuickPackageLoading] = useState(false); // Loading state for uploads
  const [quickPackageProgress, setQuickPackageProgress] = useState(''); // Progress message

  // Review view mode: 'preview' shows rendered HTML, 'edit' shows raw code
  const [reviewViewMode, setReviewViewMode] = useState('preview');

  // Proofreading view mode: 'preview' shows highlighted errors, 'edit' allows editing
  const [proofreadingViewMode, setProofreadingViewMode] = useState('preview');

  // Bulk upload state for glossary
  const [bulkTermsText, setBulkTermsText] = useState('');

  // Unsaved changes indicator
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
  const [lastSavedTime, setLastSavedTime] = useState(null);

  // Auto-save to localStorage - save critical workflow data (without large image data)
  useEffect(() => {
    // Only save if there's actual data to save
    if (originalImages.length > 0 || translationResults.length > 0 || orderNumber) {
      // Don't save large base64 image data - only save metadata to avoid quota issues
      const workflowData = {
        // Save image count and filenames only, not the actual base64 data
        originalImagesCount: originalImages.length,
        originalImagesNames: originalImages.map(img => img.filename || 'document'),
        // Save translation text only (not images) - limit to 500KB
        translationResults: translationResults.map(r => ({
          ...r,
          translatedText: r.translatedText?.substring(0, 500000) || '' // Limit text size
        })),
        orderNumber,
        documentType,
        sourceLanguage,
        targetLanguage,
        workflowMode,
        activeSubTab,
        // Don't save externalOriginalImages base64 data
        externalOriginalImagesCount: externalOriginalImages?.length || 0,
        externalTranslationText: externalTranslationText?.substring(0, 500000) || '', // Limit text size
        timestamp: Date.now()
      };

      try {
        localStorage.setItem('translation_workflow_autosave', JSON.stringify(workflowData));
        setLastSavedTime(new Date());
        setHasUnsavedChanges(false);
      } catch (e) {
        // localStorage quota exceeded - silently fail, don't block the user
        console.warn('Autosave failed (storage quota exceeded):', e.message);
        // Try to clear old autosave data to free space
        try {
          localStorage.removeItem('translation_workflow_autosave');
        } catch (clearError) {
          console.warn('Failed to clear autosave:', clearError);
        }
      }
    }
  }, [originalImages, translationResults, orderNumber, documentType, sourceLanguage, targetLanguage, workflowMode, activeSubTab, externalOriginalImages, externalTranslationText]);

  // Restore from localStorage on mount
  useEffect(() => {
    // Check if user disabled restore prompts
    if (restorePromptsDisabled) {
      // Clear any old autosave data silently
      localStorage.removeItem('translation_workflow_autosave');
      return;
    }

    const savedData = localStorage.getItem('translation_workflow_autosave');
    if (savedData) {
      try {
        const data = JSON.parse(savedData);
        // Only restore if data is less than 24 hours old
        const isRecent = data.timestamp && (Date.now() - data.timestamp) < 24 * 60 * 60 * 1000;
        // Check for restorable data (translation text, settings, etc. - not images since we don't save them)
        const hasRestorableData = data.translationResults?.length > 0 || data.orderNumber || data.originalImagesCount > 0;
        if (isRecent && hasRestorableData) {
          // Show modal instead of window.confirm
          setRestoreSessionData(data);
          setShowRestoreModal(true);
        }
      } catch (e) {
        console.error('Failed to restore autosave:', e);
        localStorage.removeItem('translation_workflow_autosave');
      }
    }
  }, []); // Run only on mount

  // Handle restore session actions
  const handleRestoreSession = (action) => {
    if (action === 'restore' && restoreSessionData) {
      // Restore translation results (text only)
      if (restoreSessionData.translationResults?.length > 0) setTranslationResults(restoreSessionData.translationResults);
      if (restoreSessionData.orderNumber) setOrderNumber(restoreSessionData.orderNumber);
      if (restoreSessionData.documentType) setDocumentType(restoreSessionData.documentType);
      if (restoreSessionData.sourceLanguage) setSourceLanguage(restoreSessionData.sourceLanguage);
      if (restoreSessionData.targetLanguage) setTargetLanguage(restoreSessionData.targetLanguage);
      if (restoreSessionData.workflowMode) setWorkflowMode(restoreSessionData.workflowMode);
      if (restoreSessionData.externalTranslationText) setExternalTranslationText(restoreSessionData.externalTranslationText);
      // Note: originalImages and externalOriginalImages are NOT restored (too large for localStorage)
      setProcessingStatus(restoreSessionData.originalImagesCount > 0
        ? '‚úÖ Session restored! Please re-upload original documents.'
        : '‚úÖ Previous session restored successfully!');
    } else if (action === 'discard') {
      // Clear old data
      localStorage.removeItem('translation_workflow_autosave');
    } else if (action === 'never') {
      // Disable restore prompts and clear data
      localStorage.setItem('translation_restore_disabled', 'true');
      localStorage.removeItem('translation_workflow_autosave');
      setRestorePromptsDisabled(true);
    }
    setShowRestoreModal(false);
    setRestoreSessionData(null);
  };

  // Clear autosave when workflow is complete (sent to PM/Admin/Client)
  const clearAutosave = () => {
    localStorage.removeItem('translation_workflow_autosave');
    setHasUnsavedChanges(false);
  };

  // Handle workflow mode change with confirmation if there's existing data
  const handleWorkflowModeChange = (newMode) => {
    if (newMode === workflowMode) return; // No change

    // Check if there's existing work that might be lost
    const hasExistingWork = translationResults.length > 0 ||
                            originalImages.length > 0 ||
                            externalOriginalImages.length > 0 ||
                            externalTranslationText;

    if (hasExistingWork) {
      const modeNames = {
        'ai': 'AI Translation',
        'external': 'External Translation',
        'ocr': 'OCR (CAT Tool)',
        'template': 'Fill Template'
      };
      const confirmed = window.confirm(
        `‚ö†Ô∏è Switching to "${modeNames[newMode]}" mode.\n\n` +
        `You have existing work that may be affected.\n` +
        `Your data will be preserved, but the view will change.\n\n` +
        `Continue?`
      );
      if (!confirmed) return;
    }

    setWorkflowMode(newMode);
  };

  // Auto-transfer external translation data when navigating to Review tab
  useEffect(() => {
    if (activeSubTab === 'review' && workflowMode === 'external') {
      // Check if we have external data that needs to be transferred
      if (externalOriginalImages.length > 0 && (externalTranslationText || externalTranslationImages.length > 0)) {
        // Only transfer if translationResults is empty (not already transferred)
        if (translationResults.length === 0) {
          const results = [];

          if (externalTranslationText) {
            // Split text by page breaks if present
            const textPages = externalTranslationText.split(/---\s*Page\s*Break\s*---/i).map(t => t.trim()).filter(t => t);

            externalOriginalImages.forEach((img, idx) => {
              results.push({
                original: img.data,
                translatedText: textPages[idx] || textPages[0] || externalTranslationText,
                filename: img.filename || `page_${idx + 1}`
              });
            });
          } else if (externalTranslationImages.length > 0) {
            externalOriginalImages.forEach((origImg, idx) => {
              const transImg = externalTranslationImages[idx] || externalTranslationImages[0];
              results.push({
                original: origImg.data,
                translatedText: `<div style="text-align:center;"><img src="${transImg.data}" style="max-width:100%; height:auto;" alt="Translation page ${idx + 1}" /></div>`,
                filename: origImg.filename || `page_${idx + 1}`
              });
            });
          }

          if (results.length > 0) {
            setTranslationResults(results);
            setProcessingStatus('‚úÖ External translation loaded');

            // Also populate Quick Package data
            if (externalTranslationText) {
              const html = `<div style="white-space: pre-wrap; font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.6;">${externalTranslationText}</div>`;
              setQuickTranslationHtml(html);
              setQuickTranslationType('html');
            }
          }
        }
      }
    }
  }, [activeSubTab, workflowMode, externalOriginalImages, externalTranslationText, externalTranslationImages, translationResults.length]);

  // Auto-transfer external translation data when navigating to Proofreading tab
  useEffect(() => {
    if (activeSubTab === 'proofreading' && workflowMode === 'external') {
      // Check if we have external data that needs to be transferred
      if (externalOriginalImages.length > 0 && (externalTranslationText || externalTranslationImages.length > 0)) {
        // Only transfer if translationResults is empty (not already transferred)
        if (translationResults.length === 0) {
          const results = [];

          if (externalTranslationText) {
            // Split text by page breaks if present
            const textPages = externalTranslationText.split(/---\s*Page\s*Break\s*---/i).map(t => t.trim()).filter(t => t);

            externalOriginalImages.forEach((img, idx) => {
              results.push({
                original: img.data,
                translatedText: textPages[idx] || textPages[0] || externalTranslationText,
                filename: img.filename || `page_${idx + 1}`
              });
            });
          } else if (externalTranslationImages.length > 0) {
            externalOriginalImages.forEach((origImg, idx) => {
              const transImg = externalTranslationImages[idx] || externalTranslationImages[0];
              results.push({
                original: origImg.data,
                translatedText: `<div style="text-align:center;"><img src="${transImg.data}" style="max-width:100%; height:auto;" alt="Translation page ${idx + 1}" /></div>`,
                filename: origImg.filename || `page_${idx + 1}`
              });
            });
          }

          if (results.length > 0) {
            setTranslationResults(results);
            setProcessingStatus('‚úÖ External translation loaded for proofreading');

            // Also populate Quick Package data
            if (externalTranslationText) {
              const html = `<div style="white-space: pre-wrap; font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.6;">${externalTranslationText}</div>`;
              setQuickTranslationHtml(html);
              setQuickTranslationType('html');
            }
          }
        }
      }
    }
  }, [activeSubTab, workflowMode, externalOriginalImages, externalTranslationText, externalTranslationImages, translationResults.length]);

  // Load saved API key, logos, instructions and resources
  useEffect(() => {
    // Load saved logos from localStorage as fallback
    const savedLogoLeft = localStorage.getItem('logo_left');
    const savedLogoRight = localStorage.getItem('logo_right');
    const savedLogoStamp = localStorage.getItem('logo_stamp');
    const savedSignature = localStorage.getItem('signature_image');
    if (savedLogoLeft) setLogoLeft(savedLogoLeft);
    if (savedLogoRight) setLogoRight(savedLogoRight);
    if (savedLogoStamp) setLogoStamp(savedLogoStamp);
    if (savedSignature) setSignatureImage(savedSignature);

    // Load saved certificate header info
    const savedCertCompanyName = localStorage.getItem('cert_company_name');
    const savedCertCompanyAddress = localStorage.getItem('cert_company_address');
    const savedCertCompanyPhone = localStorage.getItem('cert_company_phone');
    const savedCertCompanyEmail = localStorage.getItem('cert_company_email');
    if (savedCertCompanyName) setCertCompanyName(savedCertCompanyName);
    if (savedCertCompanyAddress) setCertCompanyAddress(savedCertCompanyAddress);
    if (savedCertCompanyPhone) setCertCompanyPhone(savedCertCompanyPhone);
    if (savedCertCompanyEmail) setCertCompanyEmail(savedCertCompanyEmail);

    // Load saved general instructions
    const savedInstructions = localStorage.getItem('general_instructions');
    if (savedInstructions) setGeneralInstructions(savedInstructions);

    // Load saved page format and translation type
    const savedPageFormat = localStorage.getItem('page_format');
    const savedTranslationType = localStorage.getItem('translation_type');
    if (savedPageFormat) setPageFormat(savedPageFormat);
    if (savedTranslationType) setTranslationType(savedTranslationType);

    // Load API key from localStorage first (will be replaced by backend key if available)
    const savedKey = localStorage.getItem('claude_api_key');
    if (savedKey) setClaudeApiKey(savedKey);

    fetchResources();
    fetchAvailableOrders();
  }, []);

  // Load shared API key from backend when adminKey is available
  useEffect(() => {
    if (adminKey) {
      loadSharedApiKey();
    }
  }, [adminKey]);

  // Load shared assets (logos, stamp, signature) from backend for all users
  useEffect(() => {
    const loadSharedAssets = async () => {
      if (!adminKey) return;
      try {
        const response = await axios.get(`${API}/admin/shared-assets?admin_key=${adminKey}`);
        if (response.data) {
          if (response.data.logo_left) setLogoLeft(response.data.logo_left);
          if (response.data.logo_right) setLogoRight(response.data.logo_right);
          if (response.data.logo_stamp) setLogoStamp(response.data.logo_stamp);
          if (response.data.signature_image) setSignatureImage(response.data.signature_image);
        }
      } catch (error) {
        console.log('Could not load shared assets from backend, using localStorage fallback');
      }
    };
    loadSharedAssets();
  }, [adminKey]);

  // Function to save an individual asset to backend (admin only)
  const saveAssetToBackend = async (assetType, value) => {
    if (!adminKey) {
      setProcessingStatus('‚ùå User not logged in');
      return false;
    }
    if (user?.role !== 'admin') {
      setProcessingStatus('‚ùå Only admin can save shared assets');
      return false;
    }
    try {
      const assetData = { [assetType]: value };
      await axios.put(`${API}/admin/shared-assets?admin_key=${adminKey}`, assetData);
      setProcessingStatus(`‚úÖ ${assetType === 'logo_left' ? 'Left logo' : assetType === 'logo_right' ? 'Center logo' : assetType === 'logo_stamp' ? 'Stamp' : assetType === 'signature_image' ? 'Signature' : assetType} salvo!`);
      return true;
    } catch (error) {
      console.error('Error saving asset:', error);
      setProcessingStatus(`‚ùå Falha ao salvar ${assetType}`);
      return false;
    }
  };

  // Pre-fill from selectedOrder when coming from Projects
  useEffect(() => {
    if (selectedOrder) {
      // Set order number
      setOrderNumber(selectedOrder.order_number || '');

      // Set languages from order
      if (selectedOrder.translate_from) setSourceLanguage(selectedOrder.translate_from);
      if (selectedOrder.translate_to) setTargetLanguage(selectedOrder.translate_to);

      // Auto-fill currencies based on languages
      const srcCurrency = getCurrencyFromLanguage(selectedOrder.translate_from);
      const tgtCurrency = getCurrencyFromLanguage(selectedOrder.translate_to);
      setTranslatorNoteSettings(prev => ({
        ...prev,
        sourceCurrency: srcCurrency,
        targetCurrency: tgtCurrency,
        exchangeRate: ''
      }));

      // Set translator if assigned
      if (selectedOrder.assigned_translator) {
        setSelectedTranslator(selectedOrder.assigned_translator);
      }

      // Set translation type
      if (selectedOrder.translation_type) {
        setTranslationType(selectedOrder.translation_type === 'certified' ? 'certified' : 'professional');
      }

      // Pre-select this order for sending
      setSelectedOrderId(selectedOrder.id);

      // Check if order has separate cover page
      if (selectedOrder.use_separate_cover) {
        setHasSeparateCover(true);
        setCoverPageFile({ name: selectedOrder.cover_page_filename || 'cover.pdf', uploaded: true });
      } else {
        setHasSeparateCover(false);
        setCoverPageFile(null);
      }
      setReplacementFile(null);

      // Show status
      setProcessingStatus(`üìã Working on order ${selectedOrder.order_number} - ${selectedOrder.client_name}`);

      // Skip to start tab
      setActiveSubTab('start');
    }
  }, [selectedOrder]);

  // Auto-update currencies when source/target language changes
  useEffect(() => {
    if (sourceLanguage) {
      const srcCurrency = getCurrencyFromLanguage(sourceLanguage);
      setTranslatorNoteSettings(prev => ({ ...prev, sourceCurrency: srcCurrency, exchangeRate: '' }));
    }
  }, [sourceLanguage]);

  useEffect(() => {
    if (targetLanguage) {
      const tgtCurrency = getCurrencyFromLanguage(targetLanguage);
      setTranslatorNoteSettings(prev => ({ ...prev, targetCurrency: tgtCurrency, exchangeRate: '' }));
    }
  }, [targetLanguage]);

  // Close project menu when clicking outside
  useEffect(() => {
    const handleClickOutside = (e) => {
      if (showProjectMenu && !e.target.closest('.project-menu-container')) {
        setShowProjectMenu(false);
      }
    };
    document.addEventListener('click', handleClickOutside);
    return () => document.removeEventListener('click', handleClickOutside);
  }, [showProjectMenu]);

  // Fetch assigned orders for translator/PM
  const fetchAssignedOrders = async () => {
    if (!user?.id) return;
    setLoadingAssigned(true);
    try {
      const response = await axios.get(`${API}/admin/orders?admin_key=${adminKey}`);
      // Filter orders assigned to this user (as translator or PM) or with pending review
      const myOrders = (response.data.orders || []).filter(order => {
        // For translators: check if assigned to them
        if (user.role === 'translator') {
          return (
            order.assigned_translator_id === user.id ||
            order.assigned_translator === user.name ||
            order.assigned_translator_name === user.name
          );
        }
        // For PM: check if assigned to them or ready for review
        if (user.role === 'pm') {
          return (
            order.assigned_pm_id === user.id ||
            order.assigned_pm_name === user.name ||
            order.translation_ready ||
            order.translation_html
          );
        }
        // For admin: only show orders where Admin is the assigned translator
        // Admin only sees projects in workspace when acting as translator (not as approver - that's PM's role)
        if (user.role === 'admin') {
          return (
            order.assigned_translator === 'Admin (Self)' ||
            order.assigned_translator === 'Admin' ||
            order.assigned_translator_name === 'Admin (Self)' ||
            order.assigned_translator_name === 'Admin'
          );
        }
        // Fallback: show all orders with translation
        return order.translation_ready || order.translation_html;
      }).filter(order =>
        // Include most statuses for translators to see their work
        ['pending', 'quote', 'received', 'in_translation', 'review', 'pending_review', 'pending_pm_review', 'client_review', 'ready'].includes(order.translation_status) ||
        order.translation_ready
      );
      setAssignedOrders(myOrders);

      // Fetch files for all projects to create individual file view
      const allFiles = [];
      for (const order of myOrders) {
        try {
          const docsResponse = await axios.get(`${API}/admin/orders/${order.id}/documents?admin_key=${adminKey}`);
          const docs = docsResponse.data.documents || [];
          for (const doc of docs) {
            allFiles.push({
              ...doc,
              order_id: order.id,
              order_number: order.order_number,
              translate_from: order.translate_from,
              translate_to: order.translate_to,
              document_type: order.document_type,
              deadline: order.deadline,
              translator_deadline: order.translator_deadline,
              internal_notes: order.internal_notes,
              project_translation_status: order.translation_status,
              // Use document-level status if available, otherwise inherit from project
              file_status: doc.status || doc.translation_status || order.translation_status || 'pending'
            });
          }
        } catch (e) {
          console.error(`Failed to fetch documents for order ${order.order_number}:`, e);
        }
      }
      setAllProjectFiles(allFiles);
    } catch (err) {
      console.error('Failed to fetch assigned orders:', err);
    } finally {
      setLoadingAssigned(false);
    }
  };

  // Fetch messages for translator
  const fetchTranslatorMessages = async () => {
    if (!user?.id) return;
    try {
      const response = await axios.get(`${API}/translator/messages?admin_key=${adminKey}&translator_id=${user.id}`);
      setTranslatorMessages(response.data.messages || []);
    } catch (err) {
      console.error('Failed to fetch translator messages:', err);
    }
  };

  // Mark translator message as read
  const markTranslatorMessageRead = async (messageId) => {
    try {
      await axios.put(`${API}/translator/messages/${messageId}/read?admin_key=${adminKey}`);
      fetchTranslatorMessages();
    } catch (err) {
      console.error('Failed to mark message as read:', err);
    }
  };

  // Fetch Admin/PM list for translator chat
  const fetchAdminPmList = async () => {
    try {
      const [adminsRes, pmsRes] = await Promise.all([
        axios.get(`${API}/admin/users/by-role/admin?admin_key=${adminKey}`),
        axios.get(`${API}/admin/users/by-role/pm?admin_key=${adminKey}`)
      ]);
      const admins = (adminsRes.data || []).map(u => ({ ...u, roleLabel: 'Admin' }));
      const pms = (pmsRes.data || []).map(u => ({ ...u, roleLabel: 'PM' }));
      setAdminPmList([...admins, ...pms]);
    } catch (err) {
      console.error('Failed to fetch admin/pm list:', err);
    }
  };

  // Send message from translator to Admin/PM
  const sendTranslatorMessageToAdmin = async () => {
    if (!translatorChatMessage.trim() || !selectedAdminPm) {
      showToast('Please select a recipient and enter a message');
      return;
    }
    setSendingTranslatorMessage(true);
    try {
      const recipient = adminPmList.find(u => u.id === selectedAdminPm);
      await axios.post(`${API}/translator/send-message?admin_key=${adminKey}`, {
        translator_id: user?.id,
        translator_name: user?.name || 'Translator',
        recipient_id: selectedAdminPm,
        recipient_name: recipient?.name || 'Admin/PM',
        recipient_role: recipient?.role || 'admin',
        content: translatorChatMessage
      });
      showToast('‚úÖ Message sent successfully!');
      setTranslatorChatMessage('');
      setShowTranslatorChat(false);
    } catch (err) {
      console.error('Failed to send message:', err);
      showToast('Error sending message. Please try again.');
    } finally {
      setSendingTranslatorMessage(false);
    }
  };

  useEffect(() => {
    // Fetch assigned orders for all roles (admin, pm, translator)
    if (user?.role) {
      fetchAssignedOrders();
      if (user.role === 'translator') {
        fetchTranslatorMessages();
        // Poll for messages every 30 seconds
        const interval = setInterval(fetchTranslatorMessages, 30000);
        return () => clearInterval(interval);
      }
    }
  }, [user]);

  // Auto-load project when selectedOrder prop is provided (e.g., coming from Projects page or PM Dashboard)
  useEffect(() => {
    const loadOrderData = async () => {
      if (selectedOrder && selectedOrder.id) {
        // Reset state for new order
        setSelectedOrderId(null);
        setTranslationResults([]);

        // Auto-select the project to load its documents
        await selectProject(selectedOrder);

        // Always try to load translation for PM review orders
        const hasTranslation = selectedOrder.translation_ready ||
                               selectedOrder.translation_html ||
                               ['review', 'pending_pm_review', 'pending_review'].includes(selectedOrder.translation_status);

        if (hasTranslation) {
          const loaded = await loadSavedTranslation(selectedOrder);
          if (loaded) {
            setActiveSubTab('review');
            setProcessingStatus(`‚úÖ Translation for project ${selectedOrder.order_number} loaded for review!`);
          } else {
            // If loadSavedTranslation failed, try to fetch directly
            try {
              const response = await axios.get(`${API}/admin/orders/${selectedOrder.id}?admin_key=${adminKey}`);
              const orderData = response.data.order || response.data;
              if (orderData.translation_html) {
                // Check for corrupted binary content
                if (isBinaryContent(orderData.translation_html)) {
                  setProcessingStatus('‚ö†Ô∏è Translation data is corrupted. Please re-upload the translation.');
                } else {
                  setTranslationResults([{
                    translatedText: orderData.translation_html,
                    filename: 'Translation',
                    originalText: ''
                  }]);
                  setActiveSubTab('review');
                  setProcessingStatus(`‚úÖ Translation loaded!`);
                }
              }
            } catch (err) {
              console.error('Failed to load translation:', err);
              setProcessingStatus(`‚ö†Ô∏è Could not load the translation`);
            }
          }
        }
      }
    };
    loadOrderData();
  }, [selectedOrder]);

  // Select project and fetch its files
  const selectProject = async (order) => {
    setSelectedOrderId(order.id);
    setOrderNumber(order.order_number);
    if (order.translate_from) setSourceLanguage(order.translate_from);
    if (order.translate_to) setTargetLanguage(order.translate_to);
    setLoadingProjectFiles(true);
    setSelectedProjectFiles([]);
    setSelectedFileId(null);

    try {
      // Fetch documents for this order
      const response = await axios.get(`${API}/admin/orders/${order.id}/documents?admin_key=${adminKey}`);
      const docs = response.data.documents || [];
      setSelectedProjectFiles(docs);

      if (docs.length === 0) {
        setProcessingStatus(`‚ö†Ô∏è No document found to ${order.order_number}`);
      } else {
        setProcessingStatus(`üìã ${docs.length} file(s) found(s). Click em um file to load.`);
      }

      // Update order status to "in_translation" if it was "received"
      if (order.translation_status === 'received') {
        try {
          await axios.put(`${API}/admin/orders/${order.id}?admin_key=${adminKey}`, {
            translation_status: 'in_translation'
          });
          setAssignedOrders(prev => prev.map(o =>
            o.id === order.id ? { ...o, translation_status: 'in_translation' } : o
          ));
        } catch (e) {
          console.error('Failed to update status:', e);
        }
      }
    } catch (err) {
      console.error('Failed to fetch documents:', err);
      setProcessingStatus(`‚ùå Error fetching documents: ${err.message}`);
    } finally {
      setLoadingProjectFiles(false);
    }
  };

  // Load a specific file from the project
  const loadProjectFile = async (doc) => {
    setProcessingStatus(`üìÇ Loading "${doc.filename}"...`);
    try {
      const downloadResponse = await axios.get(`${API}/admin/order-documents/${doc.id}/download?admin_key=${adminKey}`);

      if (downloadResponse.data.file_data) {
        const contentType = downloadResponse.data.content_type || 'application/pdf';
        const base64Data = downloadResponse.data.file_data;

        // Convert base64 to File object for the workspace
        const byteString = atob(base64Data);
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i);
        }
        const blob = new Blob([ab], { type: contentType });
        const file = new File([blob], doc.filename || 'document.pdf', { type: blob.type });

        // Set the file in the workspace
        setFiles([file]);
        setSelectedFileId(doc.id);

        // For PDFs, convert to images (one per page)
        if (contentType === 'application/pdf' || doc.filename?.toLowerCase().endsWith('.pdf')) {
          setProcessingStatus(`üìÑ Extracting PDF pages...`);
          try {
            const images = await convertPdfToImages(file, (currentPage, totalPages) => {
              setProcessingStatus(`üìÑ Extracting page ${currentPage} of ${totalPages}...`);
            });
            setOriginalImages(images);
            setProcessingStatus(`‚úÖ "${doc.filename}" loaded! (${images.length} page${images.length > 1 ? 's' : ''})`);
          } catch (pdfErr) {
            console.error('Failed to convert PDF to images:', pdfErr);
            // Fallback to single image
            const dataUrl = `data:${contentType};base64,${base64Data}`;
            setOriginalImages([{ filename: doc.filename, data: dataUrl }]);
            setProcessingStatus(`‚úÖ "${doc.filename}" loaded! (PDF could not be split into pages)`);
          }
        } else {
          // For images, just store directly
          const dataUrl = `data:${contentType};base64,${base64Data}`;
          setOriginalImages([{ filename: doc.filename, data: base64Data, type: contentType }]);
          setProcessingStatus(`‚úÖ "${doc.filename}" loaded!`);
        }

        // Only redirect to translate tab if coming from start tab
        // Stay on current tab if already on translate or ai-pipeline
        if (activeSubTab === 'start') {
          setActiveSubTab('translate');
        }
      }
    } catch (err) {
      console.error('Failed to load file:', err);
      setProcessingStatus(`‚ùå Error loading file: ${err.message}`);
    }
  };

  // Download project document directly
  const downloadProjectDocument = async (docId, filename) => {
    try {
      const response = await axios.get(`${API}/admin/order-documents/${docId}/download?admin_key=${adminKey}`);
      if (response.data.file_data) {
        const link = document.createElement('a');
        link.href = `data:${response.data.content_type || 'application/pdf'};base64,${response.data.file_data}`;
        link.download = filename || 'document.pdf';
        link.click();
      }
    } catch (err) {
      console.error('Failed to download:', err);
      showToast('Error downloading document');
    }
  };

  // Delete project document (Admin only - for project modal)
  const deleteProjectDocument = async (docId, filename) => {
    if (!confirm(`Tem certeza que deseja excluir "${filename}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
      return;
    }
    try {
      await axios.delete(`${API}/admin/order-documents/${docId}?admin_key=${adminKey}`);
      showToast(`Documento "${filename}" exclu√≠do com sucesso`);
      // Update local state to remove the deleted document
      setProjectDocuments(prev => prev.filter(doc => doc.id !== docId));
    } catch (err) {
      console.error('Failed to delete document:', err);
      showToast('Erro ao excluir documento');
    }
  };

  // Load file to workspace (download and convert PDF to images automatically)
  const loadFileToWorkspace = async (docId, filename) => {
    try {
      setProcessingStatus('Downloading file...');
      const response = await axios.get(`${API}/admin/order-documents/${docId}/download?admin_key=${adminKey}`);

      if (response.data.file_data) {
        const contentType = response.data.content_type || 'application/pdf';
        const base64Data = response.data.file_data;
        const fileNameLower = (filename || '').toLowerCase();

        // Check if it's a PDF - needs conversion to images
        if (fileNameLower.endsWith('.pdf') || contentType === 'application/pdf') {
          setProcessingStatus('Converting PDF to images...');

          try {
            // Convert base64 to Uint8Array directly for PDF.js
            const binaryString = atob(base64Data);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
              bytes[i] = binaryString.charCodeAt(i);
            }

            // Use PDF.js directly - v5.x requires object with data property
            const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
            const images = [];

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
              setProcessingStatus(`Converting PDF: page ${pageNum} of ${pdf.numPages}...`);

              const page = await pdf.getPage(pageNum);
              const scale = 3; // Higher scale = better quality (3x for sharp PDF rendering)
              const viewport = page.getViewport({ scale });
              const canvas = document.createElement('canvas');
              const context = canvas.getContext('2d');
              canvas.height = viewport.height;
              canvas.width = viewport.width;
              await page.render({ canvasContext: context, viewport }).promise;

              // Convert canvas to base64 PNG
              const base64Image = canvas.toDataURL('image/png').split(',')[1];
              images.push({
                filename: `${filename || 'document'}_page_${pageNum}.png`,
                data: base64Image,
                type: 'image/png'
              });
            }

            // Load images into workspace
            setOriginalImages(images);
            setProcessingStatus('');
            showToast(`‚úÖ PDF converted! ${images.length} page(s) loaded to workspace.`);

          } catch (pdfErr) {
            console.error('PDF conversion error:', pdfErr);
            setProcessingStatus('');
            showToast('Error converting PDF. The file may be corrupted or password-protected.');
          }

        } else if (contentType.startsWith('image/')) {
          // Image file - load directly
          setOriginalImages([{
            filename: filename || 'image',
            data: base64Data,
            type: contentType
          }]);
          setProcessingStatus('');
          showToast('‚úÖ Image loaded to workspace!');

        } else {
          // Other file types - just download
          setProcessingStatus('');
          const link = document.createElement('a');
          link.href = `data:${contentType};base64,${base64Data}`;
          link.download = filename || 'document';
          link.click();
          showToast('File downloaded. This file type cannot be loaded to workspace directly.');
        }
      }
    } catch (err) {
      console.error('Failed to load file to workspace:', err);
      setProcessingStatus('');
      showToast('Error loading file to workspace');
    }
  };

  // Load document from order (legacy - loads first file automatically)
  const loadOrderDocument = async (order) => {
    await selectProject(order);
  };

  // Load saved translation from order (for Review tab)
  const loadSavedTranslation = async (order) => {
    if (!order) return false;

    // Check if order has saved translation data
    if (order.translation_html || order.translation_ready) {
      try {
        // Fetch full order details to get translation data
        const response = await axios.get(`${API}/admin/orders/${order.id}?admin_key=${adminKey}`);
        const orderData = response.data.order || response.data;

        if (orderData.translation_html) {
          // Check for corrupted binary content (Word file that wasn't converted)
          if (isBinaryContent(orderData.translation_html)) {
            console.warn('Binary content detected in translation_html - this appears to be a corrupted Word file');
            setProcessingStatus('‚ö†Ô∏è Translation data is corrupted (binary Word file). Please re-upload the translation.');
            return false;
          }
          // Set translation results with original text for proofreading
          setTranslationResults([{
            translatedText: orderData.translation_html,
            filename: orderData.translation_document_type || 'Translation',
            originalText: orderData.translation_original_text || ''
          }]);

          // Also set OCR results if original text is available
          if (orderData.translation_original_text) {
            setOcrResults([{
              filename: orderData.translation_document_type || 'Original',
              text: orderData.translation_original_text
            }]);
          }

          // Set original images if available (for both normal flow and Quick Package)
          if (orderData.translation_original_images && orderData.translation_original_images.length > 0) {
            setOriginalImages(orderData.translation_original_images);
            // Also populate quickOriginalFiles for Quick Package mode
            const convertedForQuickPackage = orderData.translation_original_images.map(img => {
              let data = img.data;
              let type = img.type || 'image/png';
              if (data && data.startsWith('data:')) {
                const matches = data.match(/^data:([^;]+);base64,(.+)$/);
                if (matches) {
                  type = matches[1];
                  data = matches[2];
                }
              }
              return { filename: img.filename, data: data, type: type };
            });
            setQuickOriginalFiles(convertedForQuickPackage);
          }

          // Set other translation settings
          if (orderData.translation_source_language) setSourceLanguage(orderData.translation_source_language);
          if (orderData.translation_target_language) setTargetLanguage(orderData.translation_target_language);
          if (orderData.translation_document_type) setDocumentType(orderData.translation_document_type);
          if (orderData.translation_translator_name) {
            setSelectedTranslator(orderData.translation_translator_name);
            setSavedTranslatorName(orderData.translation_translator_name); // Save original name from DB - used for certificate signature
          }
          if (orderData.translation_type_setting) setTranslationType(orderData.translation_type_setting);
          if (orderData.translation_page_format) setPageFormat(orderData.translation_page_format);
          if (orderData.translation_include_cover !== undefined) setIncludeCover(orderData.translation_include_cover);

          // Preserve logos and signature from when the translation was saved
          // This ensures PM/Admin sees the same certificate as the translator created
          if (orderData.translation_logo_left) setLogoLeft(orderData.translation_logo_left);
          if (orderData.translation_logo_right) setLogoRight(orderData.translation_logo_right);
          if (orderData.translation_logo_stamp) setLogoStamp(orderData.translation_logo_stamp);
          if (orderData.translation_signature_image) setSignatureImage(orderData.translation_signature_image);

          setProcessingStatus(`‚úÖ Translation loaded: ${orderData.translation_document_type || 'Document'}`);
          return true;
        }
      } catch (err) {
        console.error('Failed to load saved translation:', err);
      }
    }
    return false;
  };

  // Fetch resources from backend
  const fetchResources = async () => {
    try {
      const requests = [
        axios.get(`${API}/admin/translation-instructions?admin_key=${adminKey}`),
        axios.get(`${API}/admin/glossaries?admin_key=${adminKey}`)
      ];

      // Only fetch TM for admin users
      if (isAdmin) {
        requests.push(axios.get(`${API}/admin/translation-memory?admin_key=${adminKey}`));
      }

      const results = await Promise.all(requests);
      setInstructions(results[0].data.instructions || []);
      setGlossaries(results[1].data.glossaries || []);

      if (isAdmin && results[2]) {
        setTranslationMemories(results[2].data.memories || []);
      }
    } catch (err) {
      console.error('Failed to fetch resources:', err);
    }
  };

  // Fetch available orders for sending translation
  const fetchAvailableOrders = async () => {
    try {
      const response = await axios.get(`${API}/admin/orders?admin_key=${adminKey}`);
      // Filter orders that are in translation or review status (including pending review)
      const orders = response.data.orders || [];
      const available = orders.filter(o =>
        ['received', 'in_translation', 'review', 'pending_review', 'pending_pm_review'].includes(o.translation_status) ||
        o.translation_ready
      );
      setAvailableOrders(available);
    } catch (err) {
      console.error('Failed to fetch orders:', err);
    }
  };

  // Check if all approval checks are complete
  const isApprovalComplete = approvalChecks.projectNumber && approvalChecks.languageCorrect && approvalChecks.proofread;

  // Send translation to Projects
  const sendToProjects = async (destination = 'admin') => {
    // For 'save' destination, only require basic info
    if (destination !== 'save') {
      // Validate document type
      if (!documentType.trim()) {
        showToast('Please fill in the Document Type field');
        return;
      }

      // Validate approval checklist only for delivery
      if (destination === 'deliver' && !isApprovalComplete) {
        showToast('Please complete all items in the Approval Checklist before sending');
        return;
      }
    }

    if (!selectedOrderId) {
      showToast('Please select an order to link this translation.\n\nGo to the START tab and select a project first.');
      return;
    }

    // Check for translation content - in Quick Package mode check those variables
    const hasTranslation = quickPackageMode
      ? (quickTranslationFiles.length > 0 || quickTranslationHtml)
      : translationResults.length > 0;

    if (!hasTranslation) {
      showToast('No translation to save. Please translate the document first.');
      return;
    }

    setSendingToProjects(true);
    setProcessingStatus(destination === 'save' ? 'üíæ Saving translation...' : 'üì§ Sending translation...');
    try {
      // Generate the HTML content
      const translator = TRANSLATORS.find(t => t.name === selectedTranslator);

      // Build translation HTML - use Quick Package data if in that mode
      let translationHTML = '';
      if (quickPackageMode && (quickTranslationHtml || quickTranslationFiles.length > 0)) {
        if (quickTranslationHtml) {
          translationHTML = quickTranslationHtml;
        } else {
          // Convert image files to HTML
          translationHTML = quickTranslationFiles.map((file, idx) =>
            `<div style="text-align:center; page-break-after: always;"><img src="data:${file.type || 'image/png'};base64,${file.data}" style="max-width:100%; height:auto;" alt="Translation page ${idx + 1}" /></div>`
          ).join('\n');
        }
      } else {
        translationHTML = translationResults.map(r => r.translatedText).join('\n\n---\n\n');
      }

      // Build original text for proofreading
      const originalText = translationResults.map(r => r.originalText).join('\n\n---\n\n') ||
                          ocrResults.map(r => r.text).join('\n\n---\n\n') || '';

      // Get original images - use Quick Package data if in that mode
      let origImages = [];
      if (quickPackageMode && quickOriginalFiles.length > 0) {
        origImages = quickOriginalFiles.map(img => ({ filename: img.filename, data: img.data, type: img.type || 'image/png' }));
      } else if (originalImages.length > 0) {
        origImages = originalImages.map(img => ({ filename: img.filename, data: img.data, type: img.type || 'image/png' }));
      }

      // Send to backend with destination info
      const response = await axios.post(`${API}/admin/orders/${selectedOrderId}/translation?admin_key=${adminKey}`, {
        translation_html: translationHTML,
        translation_original_text: originalText,
        source_language: sourceLanguage,
        target_language: targetLanguage,
        document_type: documentType || 'Document',
        translator_name: translator?.name || selectedTranslator,
        translation_date: translationDate,
        include_cover: includeCover,
        page_format: pageFormat,
        translation_type: translationType,
        original_images: origImages,
        logo_left: logoLeft,
        logo_right: logoRight,
        logo_stamp: logoStamp,
        signature_image: signatureImage,  // Preserve signature with order
        send_to: destination, // 'save', 'pm', 'ready', 'deliver'
        submitted_by: user?.name || 'Unknown',
        submitted_by_role: user?.role || 'unknown'
      });

      const destinationLabels = {
        'save': 'Saved',
        'pm': 'PM Review',
        'ready': 'Ready for Delivery',
        'deliver': 'Client',
        'client': 'Client (Review)',
        'admin': 'Admin',
        'pending_admin_approval': 'Admin (for client delivery)',
        'finalize_admin': 'Admin (Finalized - Ready for Client)'
      };
      const destinationLabel = destinationLabels[destination] || destination;

      if (response.data.status === 'success' || response.data.success) {
        const isTranslator = user?.role === 'translator';

        if (destination === 'save') {
          setProcessingStatus(`‚úÖ Translation saved successfully!`);
          // Clear status after 3 seconds for save action
          setTimeout(() => setProcessingStatus(''), 3000);
        } else if (destination === 'pm') {
          setProcessingStatus(`‚úÖ Translation sent to PM for review!`);
          if (isTranslator) {
            // Translator stays on translation page and goes to START tab to see other projects
            setTimeout(() => {
              // Reset the form and go back to START tab
              setSelectedOrderId('');
              setOrderNumber('');
              setTranslationResults([]);
              setOriginalImages([]);
              setActiveSubTab('start');
              setProcessingStatus('');
              // Refresh assigned orders list
              fetchAssignedOrders();
            }, 2000);
          } else {
            // For PM/Admin, just clear status after showing success
            setTimeout(() => setProcessingStatus(''), 3000);
          }
        } else if (destination === 'pending_admin_approval' || destination === 'finalize_admin') {
          setProcessingStatus(`‚úÖ Translation finalized and sent to Admin for client delivery!`);
          if (isTranslator) {
            // Reset and go back to START
            setTimeout(() => {
              setSelectedOrderId('');
              setOrderNumber('');
              setTranslationResults([]);
              setOriginalImages([]);
              setActiveSubTab('start');
              setProcessingStatus('');
              fetchAssignedOrders();
            }, 2000);
          } else {
            setTimeout(() => setProcessingStatus(''), 3000);
          }
        } else {
          setProcessingStatus(`‚úÖ Translation sent to ${destinationLabel}!`);
          setTimeout(() => setProcessingStatus(''), 3000);
        }

        // Refresh orders list
        fetchAvailableOrders();
        fetchAssignedOrders();

        // Clear autosave on successful send (except for 'save' which is just saving progress)
        if (destination !== 'save') {
          clearAutosave();
        }

        return true; // Success
      } else {
        throw new Error(response.data.error || response.data.detail || 'Failed to send');
      }
    } catch (error) {
      console.error('Error sending to projects:', error);
      setProcessingStatus(`‚ùå Failed to send: ${error.response?.data?.detail || error.message}`);
      return false; // Failed
    } finally {
      setSendingToProjects(false);
    }
  };

  // Save translated document to project files
  const saveTranslatedDocumentToFiles = async (orderId, docFilename) => {
    try {
      // Get the translation HTML content
      const translationContent = translationResults.map(r => r.translatedText).join('\n\n---\n\n');
      if (!translationContent) return;

      // Create HTML document with translation
      const translator = TRANSLATORS.find(t => t.name === selectedTranslator);
      const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Translated Document - ${docFilename}</title>
    <style>
        body { font-family: 'Times New Roman', serif; line-height: 1.6; padding: 40px; max-width: 800px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px; }
        .title { font-size: 18px; font-weight: bold; color: #1e40af; }
        .info { font-size: 12px; color: #666; margin-top: 10px; }
        .content { margin-top: 20px; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 11px; color: #666; }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">Certified Translation</div>
        <div class="info">
            Document: ${documentType || 'Document'}<br>
            From: ${sourceLanguage} ‚Üí To: ${targetLanguage}<br>
            Translator: ${translator?.name || selectedTranslator || 'Beatriz Paiva'}<br>
            Date: ${translationDate}
        </div>
    </div>
    <div class="content">
        ${translationContent}
    </div>
    <div class="footer">
        This is a certified translation by Legacy Translations Inc.<br>
        Approved on: ${new Date().toLocaleDateString('en-US', { timeZone: 'America/New_York' })}
    </div>
</body>
</html>`;

      // Convert to base64
      const base64Content = btoa(unescape(encodeURIComponent(htmlContent)));
      const filename = `${orderNumber || 'Translation'}_${documentType?.replace(/\s+/g, '_') || 'Document'}_Translated.html`;

      // Upload to order documents
      await axios.post(`${API}/admin/orders/${orderId}/documents?admin_key=${adminKey}`, {
        filename: filename,
        file_data: base64Content,
        content_type: 'text/html',
        source: 'translated_document'
      });

      console.log('Translated document saved to Files tab');
    } catch (err) {
      console.error('Failed to save translated document:', err);
    }
  };

  // Approve translation (PM/Admin) - sends to admin for final approval or marks as ready
  const approveTranslation = async (sendDirectToReady = false) => {
    if (!selectedOrderId) {
      showToast('No order selected');
      return;
    }

    // PM sends to Admin for approval, Admin marks as ready
    const isPMApproval = isPM && !isAdmin && !sendDirectToReady;
    const newStatus = isPMApproval ? 'pending_admin_approval' : 'ready';
    const message = isPMApproval
      ? '‚úÖ Approve and send to Admin?\n\nThe translation will be sent to Admin for final approval before delivery.'
      : '‚úÖ Approve this translation?\n\nThe translation will be marked as "Ready for Delivery".';

    const confirmed = window.confirm(message);
    if (!confirmed) return;

    setSendingToProjects(true);
    try {
      await axios.put(`${API}/admin/orders/${selectedOrderId}?admin_key=${adminKey}`, {
        translation_status: newStatus,
        proofreading_status: 'approved',
        proofreading_score: proofreadingResult?.pontuacao_final || null,
        proofreading_by: user?.name || 'PM',
        proofreading_date: new Date().toISOString()
      });

      // Save translated document to Files tab when approved
      await saveTranslatedDocumentToFiles(selectedOrderId, documentType || orderNumber);

      if (isPMApproval) {
        setProcessingStatus('‚úÖ Translation APPROVED and sent to Admin for final review!');
      } else {
        setProcessingStatus('‚úÖ Translation APPROVED! Ready for delivery.');
      }

      // Refresh lists
      fetchAvailableOrders();
      fetchAssignedOrders();

      // Navigate back for PM
      if (isPM && !isAdmin && onBack) {
        setTimeout(() => onBack(), 1500);
      } else if (isAdmin) {
        // Admin can go directly to deliver
        setActiveSubTab('deliver');
      }
    } catch (error) {
      console.error('Error approving translation:', error);
      setProcessingStatus(`‚ùå Failed to approve: ${error.response?.data?.detail || error.message}`);
    } finally {
      setSendingToProjects(false);
    }
  };

  // Open rejection modal (PM/Admin) - fetches translators and shows selection
  const openRejectModal = async () => {
    if (!selectedOrderId) {
      showToast('No order selected');
      return;
    }

    // Reset modal state
    setRejectReason('');
    setSelectedTranslatorForReject('');
    setShowRejectModal(true);
    setLoadingTranslators(true);

    try {
      // Fetch all translators
      const response = await axios.get(`${API}/admin/translators?admin_key=${adminKey}`);
      const translators = response.data || [];

      // Get current order details to pre-select the original translator
      const orderResponse = await axios.get(`${API}/admin/orders/${selectedOrderId}?admin_key=${adminKey}`);
      const order = orderResponse.data;

      setAvailableTranslators(translators.filter(t => t.is_active !== false));

      // Pre-select the originally assigned translator if available
      if (order?.assigned_translator_id) {
        setSelectedTranslatorForReject(order.assigned_translator_id.toString());
      } else if (order?.assigned_translator) {
        const translator = translators.find(t => t.name === order.assigned_translator);
        if (translator) {
          setSelectedTranslatorForReject(translator.id.toString());
        }
      }
    } catch (error) {
      console.error('Error fetching translators:', error);
      setAvailableTranslators([]);
    } finally {
      setLoadingTranslators(false);
    }
  };

  // Confirm rejection with selected translator
  const confirmRejectTranslation = async () => {
    if (!rejectReason.trim()) {
      showToast('Please provide a reason for rejection');
      return;
    }

    if (!selectedTranslatorForReject) {
      showToast('Please select a translator to send the work back to');
      return;
    }

    setSendingToProjects(true);
    setShowRejectModal(false);

    try {
      // Find selected translator details
      const selectedTranslator = availableTranslators.find(t => t.id.toString() === selectedTranslatorForReject);

      // Update order status back to in_translation and reassign to selected translator
      await axios.put(`${API}/admin/orders/${selectedOrderId}?admin_key=${adminKey}`, {
        translation_status: 'in_translation',
        proofreading_status: 'rejected',
        proofreading_notes: rejectReason,
        proofreading_by: user?.name || 'PM',
        proofreading_date: new Date().toISOString(),
        assigned_translator_id: parseInt(selectedTranslatorForReject),
        assigned_translator: selectedTranslator?.name || 'Translator',
        assigned_translator_name: selectedTranslator?.name || 'Translator'
      });

      setProcessingStatus(`‚ùå Translation REJECTED. Returned to ${selectedTranslator?.name || 'translator'} with feedback.`);

      // Refresh lists
      fetchAvailableOrders();
      fetchAssignedOrders();

      // Navigate back
      if (onBack) {
        setTimeout(() => onBack(), 1500);
      }
    } catch (error) {
      console.error('Error rejecting translation:', error);
      setProcessingStatus(`‚ùå Failed to reject: ${error.response?.data?.detail || error.message}`);
    } finally {
      setSendingToProjects(false);
    }
  };

  // Save API key (to backend for sharing with all users)
  const saveApiKey = async () => {
    if (!claudeApiKey) {
      setProcessingStatus('‚ùå Please enter an API key');
      return;
    }

    try {
      // Save to backend (shared with all users)
      await axios.post(`${API}/admin/settings/api-key?admin_key=${adminKey}`, {
        api_key: claudeApiKey
      });

      // Also save locally as backup
      localStorage.setItem('claude_api_key', claudeApiKey);
      setProcessingStatus('‚úÖ API Key saved! All translators can now use it.');
    } catch (err) {
      console.error('Failed to save API key to backend:', err);
      // Fallback to localStorage only
      localStorage.setItem('claude_api_key', claudeApiKey);
      setProcessingStatus('‚ö†Ô∏è API Key saved locally only. Backend save failed.');
    }
  };

  // Load shared API key from backend
  const loadSharedApiKey = async () => {
    try {
      // First try to get from backend
      const response = await axios.get(`${API}/settings/api-key/use?token=${adminKey}`);
      if (response.data?.api_key) {
        setClaudeApiKey(response.data.api_key);
        localStorage.setItem('claude_api_key', response.data.api_key);
        return true;
      }
    } catch (err) {
      // If backend fails, try localStorage
      const savedKey = localStorage.getItem('claude_api_key');
      if (savedKey) {
        setClaudeApiKey(savedKey);
        return true;
      }
    }
    return false;
  };

  // Save general instructions
  const saveGeneralInstructions = () => {
    localStorage.setItem('general_instructions', generalInstructions);
    setProcessingStatus('‚úÖ General instructions saved!');
  };

  // Save page format
  const savePageFormat = (format) => {
    setPageFormat(format);
    localStorage.setItem('page_format', format);
  };

  // Save translation type
  const saveTranslationType = (type) => {
    setTranslationType(type);
    localStorage.setItem('translation_type', type);
  };

  // Handle logo upload
  const handleLogoUpload = (e, type) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      const base64 = event.target.result;
      if (type === 'left') {
        setLogoLeft(base64);
        localStorage.setItem('logo_left', base64);
      } else if (type === 'right') {
        setLogoRight(base64);
        localStorage.setItem('logo_right', base64);
      } else if (type === 'stamp') {
        setLogoStamp(base64);
        localStorage.setItem('logo_stamp', base64);
      } else if (type === 'signature') {
        setSignatureImage(base64);
        localStorage.setItem('signature_image', base64);
      }
      const typeLabels = { left: 'Left logo', right: 'ATA logo', stamp: 'Stamp logo', signature: 'Signature' };
      setProcessingStatus(`‚úÖ ${typeLabels[type] || type} uploaded!`);
    };
    reader.readAsDataURL(file);
  };

  // Remove logo
  const removeLogo = (type) => {
    if (type === 'left') {
      setLogoLeft('');
      localStorage.removeItem('logo_left');
    } else if (type === 'right') {
      setLogoRight('');
      localStorage.removeItem('logo_right');
    } else if (type === 'stamp') {
      setLogoStamp('');
      localStorage.removeItem('logo_stamp');
    } else if (type === 'signature') {
      setSignatureImage('');
      localStorage.removeItem('signature_image');
    }
    setProcessingStatus(`${type === 'signature' ? 'Signature' : 'Logo'} removed`);
  };

  // Translation Instructions CRUD
  const handleSaveInstruction = async () => {
    // Validate required fields
    if (!instructionForm.title || !instructionForm.title.trim()) {
      showToast('Please enter a title for the instruction');
      return;
    }
    if (!instructionForm.content || !instructionForm.content.trim()) {
      showToast('Please enter instruction content');
      return;
    }

    setProcessingStatus('Saving instruction...');

    try {
      const dataToSend = {
        sourceLang: instructionForm.sourceLang,
        targetLang: instructionForm.targetLang,
        title: instructionForm.title.trim(),
        content: instructionForm.content.trim()
      };

      const config = { timeout: 30000 }; // 30 second timeout

      if (editingInstruction) {
        await axios.put(`${API}/admin/translation-instructions/${editingInstruction.id}?admin_key=${adminKey}`, dataToSend, config);
      } else {
        await axios.post(`${API}/admin/translation-instructions?admin_key=${adminKey}`, dataToSend, config);
      }
      setShowInstructionModal(false);
      setEditingInstruction(null);
      setInstructionForm({ sourceLang: 'Portuguese (Brazil)', targetLang: 'English', title: '', content: '' });
      fetchResources();
      setProcessingStatus('‚úÖ Instruction saved!');
    } catch (err) {
      console.error('Failed to save instruction:', err);

      // Save locally as backup
      const localInstructions = JSON.parse(localStorage.getItem('backup_instructions') || '[]');
      localInstructions.push({
        ...instructionForm,
        id: `local_${Date.now()}`,
        savedAt: new Date().toISOString()
      });
      localStorage.setItem('backup_instructions', JSON.stringify(localInstructions));

      const errorMsg = err.code === 'ECONNABORTED'
        ? 'Request timeout - server may be slow. Saved locally as backup.'
        : err.message === 'Network Error'
          ? 'Network Error - Server may be restarting. Saved locally as backup.'
          : (err.response?.data?.detail || err.message);

      showToast('Failed to save instruction: ' + errorMsg);
      setProcessingStatus('‚ùå Save failed - backed up locally');
    }
  };

  const handleDeleteInstruction = async (id) => {
    if (!window.confirm('Delete this instruction?')) return;
    try {
      await axios.delete(`${API}/admin/translation-instructions/${id}?admin_key=${adminKey}`);
      fetchResources();
    } catch (err) {
      console.error('Failed to delete instruction:', err);
    }
  };

  const handleEditInstruction = (instr) => {
    setEditingInstruction(instr);
    setInstructionForm({ sourceLang: instr.sourceLang, targetLang: instr.targetLang, title: instr.title, content: instr.content });
    setShowInstructionModal(true);
  };

  // Glossaries CRUD
  const handleSaveGlossary = async () => {
    if (!glossaryForm.name || !glossaryForm.name.trim()) {
      showToast('Please enter a name for the glossary');
      return;
    }

    setProcessingStatus('Saving glossary...');

    try {
      const config = { timeout: 30000 }; // 30 second timeout

      // Filter out invalid terms (must have both source and target non-empty)
      // This prevents 422 validation errors from the backend
      // Don't send 'id' field as it can cause issues with large timestamp values
      const cleanedData = {
        ...glossaryForm,
        terms: (glossaryForm.terms || []).filter(term =>
          term.source && term.source.trim() && term.target && term.target.trim()
        ).map((term, index) => ({
          source: term.source.trim(),
          target: term.target.trim(),
          notes: term.notes || '',
          id: index + 1  // Use simple sequential IDs instead of timestamps
        }))
      };

      if (editingGlossary) {
        await axios.put(`${API}/admin/glossaries/${editingGlossary.id}?admin_key=${adminKey}`, cleanedData, config);
      } else {
        await axios.post(`${API}/admin/glossaries?admin_key=${adminKey}`, cleanedData, config);
      }
      setShowGlossaryModal(false);
      setEditingGlossary(null);
      setGlossaryForm({
        name: '',
        sourceLang: 'Portuguese (Brazil)',
        targetLang: 'English',
        bidirectional: true,
        field: 'All Fields',
        terms: []
      });
      fetchResources();
      setProcessingStatus('‚úÖ Glossary saved!');
    } catch (err) {
      console.error('Failed to save glossary:', err);

      // Save locally as backup
      const localGlossaries = JSON.parse(localStorage.getItem('backup_glossaries') || '[]');
      localGlossaries.push({
        ...glossaryForm,
        id: `local_${Date.now()}`,
        savedAt: new Date().toISOString()
      });
      localStorage.setItem('backup_glossaries', JSON.stringify(localGlossaries));

      let errorMsg = 'Unknown error';
      if (err.code === 'ECONNABORTED') {
        errorMsg = 'Request timeout - server may be slow. Saved locally as backup.';
      } else if (err.message === 'Network Error') {
        errorMsg = 'Network Error - Server may be restarting. Saved locally as backup.';
      } else if (err.response?.data?.detail) {
        // Pydantic validation errors come as array of objects
        const detail = err.response.data.detail;
        if (Array.isArray(detail)) {
          errorMsg = detail.map(d => d.msg || d.message || JSON.stringify(d)).join('; ');
        } else if (typeof detail === 'string') {
          errorMsg = detail;
        } else {
          errorMsg = JSON.stringify(detail);
        }
      } else {
        errorMsg = err.message;
      }

      showToast('Failed to save glossary: ' + errorMsg);
      setProcessingStatus('‚ùå Save failed - backed up locally');
    }
  };

  const handleDeleteGlossary = async (id) => {
    if (!window.confirm('Delete this glossary?')) return;
    try {
      await axios.delete(`${API}/admin/glossaries/${id}?admin_key=${adminKey}`);
      fetchResources();
    } catch (err) {
      console.error('Failed to delete glossary:', err);
    }
  };

  const handleEditGlossary = (gloss) => {
    setEditingGlossary(gloss);
    setGlossaryForm({
      name: gloss.name,
      sourceLang: gloss.sourceLang || 'Portuguese (Brazil)',
      targetLang: gloss.targetLang || 'English',
      bidirectional: gloss.bidirectional !== undefined ? gloss.bidirectional : true,
      field: gloss.field || 'All Fields',
      terms: gloss.terms || []
    });
    setTermSearchQuery('');
    setShowGlossaryModal(true);
  };

  const addTermToGlossary = () => {
    if (newTerm.source && newTerm.target) {
      setGlossaryForm({ ...glossaryForm, terms: [...glossaryForm.terms, { ...newTerm, id: Date.now() }] });
      setNewTerm({ source: '', target: '', notes: '' });
    }
  };

  const removeTermFromGlossary = (termId) => {
    setGlossaryForm({ ...glossaryForm, terms: glossaryForm.terms.filter(t => t.id !== termId) });
  };

  const filteredGlossaries = glossaries.filter(g => {
    const matchLang = resourcesFilter.language === 'All Languages' || g.language === resourcesFilter.language;
    const matchField = resourcesFilter.field === 'All Fields' || g.field === resourcesFilter.field;
    return matchLang && matchField;
  });

  // Synchronized scrolling for Review tab
  const handleScroll = (source) => {
    if (source === 'original' && translatedTextRef.current && originalTextRef.current) {
      translatedTextRef.current.scrollTop = originalTextRef.current.scrollTop;
    } else if (source === 'translated' && originalTextRef.current && translatedTextRef.current) {
      originalTextRef.current.scrollTop = translatedTextRef.current.scrollTop;
    }
  };

  // Synchronized scrolling for Upload tab
  const handleUploadScroll = (source) => {
    if (source === 'original' && uploadOcrRef.current && uploadOriginalRef.current) {
      uploadOcrRef.current.scrollTop = uploadOriginalRef.current.scrollTop;
    } else if (source === 'ocr' && uploadOriginalRef.current && uploadOcrRef.current) {
      uploadOriginalRef.current.scrollTop = uploadOcrRef.current.scrollTop;
    }
  };

  // Apply formatting to OCR text
  const applyOcrFormatting = (format) => {
    const textarea = document.getElementById('ocr-editor');
    if (!textarea) return;

    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);

    if (!selectedText) return;

    let formattedText = selectedText;
    if (format === 'bold') {
      formattedText = `**${selectedText}**`;
    } else if (format === 'italic') {
      formattedText = `*${selectedText}*`;
    }

    const newText = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
    const updated = [...ocrResults];
    updated[0].text = newText;
    setOcrResults(updated);
  };

  // File handling
  const handleFileSelect = (event) => {
    const selectedFiles = Array.from(event.target.files);
    setFiles(selectedFiles);
    setOcrResults([]);
    setTranslationResults([]);
    setProcessingStatus('');

    // Save original images as base64 for later use in certificate
    const imagePromises = selectedFiles.map(file => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve({ filename: file.name, data: reader.result });
        reader.readAsDataURL(file);
      });
    });
    Promise.all(imagePromises).then(images => setOriginalImages(images));
  };

  // Handle external original document upload (with PDF to image conversion)
  const handleExternalOriginalUpload = async (event) => {
    const selectedFiles = Array.from(event.target.files);
    if (selectedFiles.length === 0) return;

    setProcessingStatus('üì§ Processing original documents...');
    const allImages = [];

    for (let i = 0; i < selectedFiles.length; i++) {
      const file = selectedFiles[i];
      const fileName = file.name.toLowerCase();

      // PDF - store directly as data URL
      if (fileName.endsWith('.pdf')) {
        setProcessingStatus(`Loading PDF: ${file.name}`);
        const dataUrl = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });
        allImages.push({ filename: file.name, data: dataUrl, type: 'application/pdf' });
      }
      // Images - read as data URL
      else if (file.type.startsWith('image/')) {
        const dataUrl = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });
        allImages.push({ filename: file.name, data: dataUrl });
      }
    }

    if (allImages.length > 0) {
      setExternalOriginalImages(allImages);
      // Also set as originalImages for certificate generation
      setOriginalImages(allImages);
      setProcessingStatus(`‚úÖ ${allImages.length} original page(s) uploaded`);
    }
  };

  // Handle external translation upload (text or images)
  const handleExternalTranslationUpload = async (event) => {
    const selectedFiles = Array.from(event.target.files);
    if (selectedFiles.length === 0) return;

    setProcessingStatus('Processing uploaded translation...');

    for (const file of selectedFiles) {
      const fileName = file.name.toLowerCase();

      try {
        // Word document (.docx) - convert to HTML
        if (fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
          setProcessingStatus(`Converting Word document: ${file.name}`);
          const html = await convertWordToHtml(file);
          setExternalTranslationText(html);
          setProcessingStatus(`‚úÖ Word document converted`);
        }
        // HTML file - read as HTML
        else if (fileName.endsWith('.html') || fileName.endsWith('.htm')) {
          setProcessingStatus(`Reading HTML: ${file.name}`);
          const html = await readHtmlFile(file);
          setExternalTranslationText(html);
          setProcessingStatus(`‚úÖ HTML file loaded`);
        }
        // Text file
        else if (fileName.endsWith('.txt') || file.type === 'text/plain') {
          setProcessingStatus(`Reading text file: ${file.name}`);
          const text = await readTxtFile(file);
          setExternalTranslationText(text);
          setProcessingStatus(`‚úÖ Text file loaded`);
        }
        // PDF - store directly
        else if (fileName.endsWith('.pdf')) {
          setProcessingStatus(`Loading PDF: ${file.name}`);
          const dataUrl = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
          });
          setExternalTranslationImages(prev => [...prev, { filename: file.name, data: dataUrl, type: 'application/pdf' }]);
          setProcessingStatus(`‚úÖ PDF loaded`);
        }
        // Images (JPG, PNG, etc.)
        else if (file.type.startsWith('image/')) {
          const base64 = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
          });
          setExternalTranslationImages(prev => [...prev, { filename: file.name, data: base64 }]);
          setProcessingStatus(`‚úÖ Image uploaded`);
        }
      } catch (err) {
        console.error(`Error processing ${file.name}:`, err);
        setProcessingStatus(`‚ö†Ô∏è Error processing ${file.name}`);
      }
    }

    setTimeout(() => setProcessingStatus(''), 3000);
    event.target.value = '';
  };

  // Send external translation to Review
  const handleExternalToReview = () => {
    if (externalOriginalImages.length === 0) {
      showToast('Please upload the original document first');
      return;
    }
    if (!externalTranslationText && externalTranslationImages.length === 0) {
      showToast('Please upload or paste the translation');
      return;
    }

    // Create translation results for review
    const results = [];

    if (externalTranslationText) {
      // If we have text, create one result per original page
      // Split text by page breaks if present
      const textPages = externalTranslationText.split(/---\s*Page\s*Break\s*---/i).map(t => t.trim()).filter(t => t);

      externalOriginalImages.forEach((img, idx) => {
        results.push({
          original: img.data,
          translatedText: textPages[idx] || textPages[0] || externalTranslationText,
          filename: img.filename || `page_${idx + 1}`
        });
      });
    } else if (externalTranslationImages.length > 0) {
      // If we have translation images, pair them with originals
      externalOriginalImages.forEach((origImg, idx) => {
        const transImg = externalTranslationImages[idx] || externalTranslationImages[0];
        results.push({
          original: origImg.data,
          translatedText: `<div style="text-align:center;"><img src="${transImg.data}" style="max-width:100%; height:auto;" alt="Translation page ${idx + 1}" /></div>`,
          filename: origImg.filename || `page_${idx + 1}`
        });
      });
    }

    if (results.length > 0) {
      setTranslationResults(results);
    }

    // Also populate Quick Package files for DELIVER tab
    // Convert full data URLs to base64-only format
    if (externalOriginalImages.length > 0) {
      const origFiles = externalOriginalImages.map(img => {
        const dataUrl = img.data;
        const matches = dataUrl.match(/^data:([^;]+);base64,(.+)$/);
        if (matches) {
          return {
            filename: img.filename,
            data: matches[2], // Just the base64 part
            type: matches[1]  // The mime type
          };
        }
        return { filename: img.filename, data: dataUrl, type: 'image/png' };
      });
      setQuickOriginalFiles(origFiles);
    }

    if (externalTranslationImages.length > 0) {
      const transFiles = externalTranslationImages.map(img => {
        const dataUrl = img.data;
        const matches = dataUrl.match(/^data:([^;]+);base64,(.+)$/);
        if (matches) {
          return {
            filename: img.filename,
            data: matches[2], // Just the base64 part
            type: matches[1]  // The mime type
          };
        }
        return { filename: img.filename, data: dataUrl, type: 'image/png' };
      });
      setQuickTranslationFiles(transFiles);
      setQuickTranslationType('images');
    } else if (externalTranslationText) {
      // If text was pasted, convert to HTML for Quick Package
      const html = `<div style="white-space: pre-wrap; font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.6;">${externalTranslationText}</div>`;
      setQuickTranslationHtml(html);
      setQuickTranslationType('html');
    }

    setActiveSubTab('review');
    setProcessingStatus('‚úÖ Ready for review');
  };

  // Run detailed proofreading (admin only)
  const runProofreading = async () => {
    if (!claudeApiKey) {
      showToast('Please configure Claude API key in Settings');
      return;
    }

    const currentResult = translationResults[selectedResultIndex];
    if (!currentResult?.translatedText) {
      showToast('No translation to proofread');
      return;
    }

    // Extract text from translation (remove HTML tags for proofreading)
    const translatedText = currentResult.translatedText
      .replace(/<[^>]*>/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();

    // Get original text (from OCR or extracted)
    let originalText = ocrResults[selectedResultIndex]?.text ||
                        currentResult.originalText ||
                        '';

    // Check if we have an original image that we can use
    const originalImage = originalImages[selectedResultIndex];
    let originalImageBase64 = null;

    if (originalImage?.data) {
      // Extract base64 from data URL if present
      if (originalImage.data.startsWith('data:')) {
        originalImageBase64 = originalImage.data.split(',')[1];
      } else {
        originalImageBase64 = originalImage.data;
      }
    }

    // If no text and no image, show error
    if (!originalText && !originalImageBase64) {
      showToast('No original document available for comparison. Please upload the original document in the Original Document section.');
      return;
    }

    setIsProofreading(true);
    setProofreadingError('');
    setProofreadingResult(null);

    try {
      const response = await fetch(`${API}/admin/proofread?admin_key=${encodeURIComponent(adminKey)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          original_text: originalText || 'See attached image',
          original_image: originalImageBase64,
          translated_text: translatedText,
          source_language: sourceLanguage,
          target_language: targetLanguage,
          document_type: documentType,
          claude_api_key: claudeApiKey
        })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.detail || 'Proofreading failed');
      }

      if (data.proofreading_result) {
        setProofreadingResult(data.proofreading_result);

        // Auto-save to Translation Memory if score is good
        const score = data.proofreading_result.pontuacao_final || data.proofreading_result.score || 0;
        const currentResult = translationResults[selectedResultIndex];
        if (currentResult?.originalText && currentResult?.translatedText) {
          saveToTranslationMemory(currentResult.originalText, currentResult.translatedText, score);
        }
      } else if (data.raw_response) {
        // Show raw response if JSON parsing failed
        setProofreadingError(`JSON parsing failed. Raw response:\n${data.raw_response}`);
      }
    } catch (error) {
      console.error('Proofreading error:', error);
      setProofreadingError(error.message);
    } finally {
      setIsProofreading(false);
    }
  };

  // Generate translation text with highlighted errors
  const getHighlightedTranslation = () => {
    const currentResult = translationResults[selectedResultIndex];
    if (!currentResult?.translatedText || !proofreadingResult?.erros || proofreadingResult.erros.length === 0) {
      return currentResult?.translatedText || '<p>No translation</p>';
    }

    let highlightedHtml = currentResult.translatedText;

    // Create a list of errors to highlight with their original index, sorted by length (longest first)
    // Use traducao_errada (English text found in translation) for highlighting, not the Portuguese original
    const errorsToHighlight = proofreadingResult.erros
      .map((erro, idx) => ({
        text: erro.traducao_errada || erro.found || '',
        severity: erro.severidade || erro.gravidade || 'M√âDIO',
        suggestion: erro.correcao || erro.sugestao || '',
        type: erro.tipo || 'Geral',
        index: idx,
        applied: erro.applied
      }))
      .filter(e => e.text && e.text.length > 0 && !e.applied)
      .sort((a, b) => b.text.length - a.text.length);

    // Apply highlighting for each error
    errorsToHighlight.forEach(error => {
      const severityColor = error.severity === 'CR√çTICO' ? '#fee2e2' : // red-100
                           error.severity === 'ALTO' ? '#dbeafe' : // blue-100
                           error.severity === 'M√âDIO' ? '#fef3c7' : // yellow-100
                           '#e0e7ff'; // indigo-100 for BAIXO

      const borderColor = error.severity === 'CR√çTICO' ? '#ef4444' : // red-500
                         error.severity === 'ALTO' ? '#3b82f6' : // blue-500
                         error.severity === 'M√âDIO' ? '#f59e0b' : // yellow-500
                         '#6366f1'; // indigo-500 for BAIXO

      const escapedText = error.text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

      // Create tooltip with error details
      const tooltipText = `Tipo: ${error.type} | Severidade: ${error.severity} | Sugest√£o: ${error.suggestion}`.replace(/"/g, '&quot;');

      // Use simple global replace (case insensitive) - only replace first occurrence to avoid duplicates
      const regex = new RegExp(escapedText, 'i');
      highlightedHtml = highlightedHtml.replace(
        regex,
        `<mark data-error-index="${error.index}" style="background-color: ${severityColor}; border-bottom: 2px solid ${borderColor}; padding: 2px 4px; border-radius: 3px; cursor: pointer; transition: all 0.2s;" title="${tooltipText}" class="proofreading-error-highlight">${error.text}</mark>`
      );
    });

    return highlightedHtml;
  };

  // Handle click on highlighted error in translation - scroll to and highlight the table row
  const handleHighlightedErrorClick = (e) => {
    const mark = e.target.closest('mark[data-error-index]');
    if (mark) {
      const errorIndex = parseInt(mark.getAttribute('data-error-index'), 10);
      setHighlightedErrorIndex(errorIndex);

      // Scroll the error table row into view
      setTimeout(() => {
        const errorRow = document.querySelector(`[data-error-row="${errorIndex}"]`);
        if (errorRow) {
          errorRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 100);

      // Clear the highlight after 3 seconds
      setTimeout(() => {
        setHighlightedErrorIndex(null);
      }, 3000);
    }
  };

  // Handle click on error row in table - scroll to and highlight in translation preview
  const handleErrorRowClick = (errorIndex, foundText) => {
    if (!foundText) return;

    setHighlightedErrorIndex(errorIndex);

    // Find and scroll to the highlighted mark in the translation preview iframe
    setTimeout(() => {
      const iframe = document.querySelector('.translation-preview-iframe');
      if (iframe && iframe.contentDocument) {
        const mark = iframe.contentDocument.querySelector(`mark[data-error-index="${errorIndex}"]`);
        if (mark) {
          mark.scrollIntoView({ behavior: 'smooth', block: 'center' });
          // Add a temporary pulse effect
          mark.style.animation = 'pulse 0.5s ease-in-out 3';
        }
      }
    }, 100);

    // Clear the highlight after 3 seconds
    setTimeout(() => {
      setHighlightedErrorIndex(null);
    }, 3000);
  };

  // Handle click on PM error row in table - scroll to and highlight in translation preview
  const handlePmErrorRowClick = (errorIndex, foundText) => {
    if (!foundText) return;

    setHighlightedPmErrorIndex(errorIndex);

    // Find and scroll to the text in the translation preview
    setTimeout(() => {
      const translationPreview = document.querySelector('.pm-translation-preview');
      if (translationPreview) {
        // Try to find and highlight the text
        const content = translationPreview.innerHTML;
        if (content.toLowerCase().includes(foundText.toLowerCase())) {
          const escapedText = foundText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const regex = new RegExp(`(${escapedText})`, 'gi');
          translationPreview.innerHTML = content.replace(
            regex,
            '<mark style="background-color: #fef3c7; border: 2px solid #f59e0b; padding: 2px 4px; border-radius: 3px; animation: pulse 0.5s ease-in-out 3;">$1</mark>'
          );
          const mark = translationPreview.querySelector('mark');
          if (mark) {
            mark.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      }
    }, 100);

    // Clear the highlight after 3 seconds
    setTimeout(() => {
      setHighlightedPmErrorIndex(null);
    }, 3000);
  };

  // Helper function to try replacing text with multiple strategies
  const tryReplaceText = (html, foundText, suggestionText) => {
    let updatedHtml = html;
    let replaced = false;

    // Strategy 1: Try exact match (case insensitive)
    const escapedText = foundText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const exactRegex = new RegExp(escapedText, 'gi');

    if (exactRegex.test(html)) {
      updatedHtml = html.replace(exactRegex, suggestionText);
      replaced = true;
    }

    // Strategy 2: Try matching with flexible whitespace
    if (!replaced) {
      const flexiblePattern = foundText
        .replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
        .replace(/\s+/g, '\\s*(?:<[^>]*>)?\\s*');
      const flexibleRegex = new RegExp(flexiblePattern, 'gi');

      if (flexibleRegex.test(html)) {
        updatedHtml = html.replace(flexibleRegex, suggestionText);
        replaced = true;
      }
    }

    // Strategy 3: Try finding words individually
    if (!replaced) {
      const words = foundText.split(/\s+/).filter(w => w.length > 2);
      if (words.length > 0) {
        const wordPattern = words
          .map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'))
          .join('(?:[^<]*(?:<[^>]*>[^<]*)*?)');
        const wordRegex = new RegExp(wordPattern, 'gi');

        if (wordRegex.test(html)) {
          updatedHtml = html.replace(wordRegex, suggestionText);
          replaced = true;
        }
      }
    }

    return { updatedHtml, replaced };
  };

  // Apply a single proofreading correction
  const applyProofreadingCorrection = (erro, index) => {
    // Handle both field name conventions - traducao_errada is the incorrect English text to find
    const foundText = (erro.traducao_errada || erro.found || '').trim();
    const suggestionText = (erro.correcao || erro.sugestao || '').trim();

    if (!foundText || !suggestionText) {
      showToast('Cannot apply correction: missing original text or suggestion');
      return;
    }

    const currentResult = translationResults[selectedResultIndex];
    if (!currentResult?.translatedText) return;

    const result = tryReplaceText(currentResult.translatedText, foundText, suggestionText);

    if (!result.replaced) {
      showToast(`Could not find text to replace: "${foundText.substring(0, 50)}${foundText.length > 50 ? '...' : ''}"\n\nThe text may have been modified or contains special formatting.`);
      return;
    }

    // Update translation results with corrected text AND track applied corrections
    const newResults = [...translationResults];
    const appliedCorrections = currentResult.appliedCorrections || [];
    newResults[selectedResultIndex] = {
      ...currentResult,
      translatedText: result.updatedHtml,
      appliedCorrections: [...appliedCorrections, {
        original: foundText,
        corrected: suggestionText,
        timestamp: Date.now()
      }]
    };
    setTranslationResults(newResults);

    // Mark this error as applied in proofreading result
    if (proofreadingResult?.erros) {
      const updatedErrors = [...proofreadingResult.erros];
      updatedErrors[index] = { ...updatedErrors[index], applied: true };
      setProofreadingResult({
        ...proofreadingResult,
        erros: updatedErrors
      });
    }

    // Mark as having unsaved changes
    setHasUnsavedChanges(true);
  };

  // Apply all proofreading corrections at once
  const applyAllProofreadingCorrections = () => {
    if (!proofreadingResult?.erros || proofreadingResult.erros.length === 0) return;

    const currentResult = translationResults[selectedResultIndex];
    if (!currentResult?.translatedText) return;

    let updatedHtml = currentResult.translatedText;
    let appliedCount = 0;
    const newAppliedCorrections = [];

    const updatedErrors = proofreadingResult.erros.map(erro => {
      // Handle both field name conventions - traducao_errada is the incorrect English text to find
      const foundText = (erro.traducao_errada || erro.found || '').trim();
      const suggestionText = (erro.correcao || erro.sugestao || '').trim();

      if (foundText && suggestionText && !erro.applied) {
        const result = tryReplaceText(updatedHtml, foundText, suggestionText);
        if (result.replaced) {
          updatedHtml = result.updatedHtml;
          appliedCount++;
          newAppliedCorrections.push({
            original: foundText,
            corrected: suggestionText,
            timestamp: Date.now()
          });
          return { ...erro, applied: true };
        }
      }
      return erro;
    });

    if (appliedCount === 0) {
      showToast('No corrections could be applied. The text may have been modified or contains special formatting.');
      return;
    }

    // Update translation results with corrected text AND track all applied corrections
    const newResults = [...translationResults];
    const existingCorrections = currentResult.appliedCorrections || [];
    newResults[selectedResultIndex] = {
      ...currentResult,
      translatedText: updatedHtml,
      appliedCorrections: [...existingCorrections, ...newAppliedCorrections]
    };
    setTranslationResults(newResults);

    // Update proofreading result
    setProofreadingResult({
      ...proofreadingResult,
      erros: updatedErrors
    });

    // Mark as having unsaved changes
    setHasUnsavedChanges(true);

    // Show success message
    setProcessingStatus(`‚úÖ ${appliedCount} correction(s) applied successfully!`);
    setTimeout(() => setProcessingStatus(''), 3000);
  };

  // Save translation pairs to Translation Memory after successful proofreading
  const saveToTranslationMemory = async (originalText, translatedText, score) => {
    // Only save if proofreading score is good (>= 85% - blue/green quality only)
    if (score < 85) {
      console.log('TM not saved: score below 85%');
      return;
    }

    try {
      // Extract sentence pairs by splitting on common sentence delimiters
      const extractSentences = (text) => {
        // Remove HTML tags for comparison
        const cleanText = text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
        // Split by sentence-ending punctuation
        const sentences = cleanText.split(/(?<=[.!?])\s+/).filter(s => s.trim().length > 10);
        return sentences;
      };

      const sourceSentences = extractSentences(originalText);
      const targetSentences = extractSentences(translatedText);

      // Create pairs (best effort alignment)
      const entries = [];
      const minLength = Math.min(sourceSentences.length, targetSentences.length);

      for (let i = 0; i < minLength; i++) {
        if (sourceSentences[i]?.trim() && targetSentences[i]?.trim()) {
          entries.push({
            source: sourceSentences[i].trim(),
            target: targetSentences[i].trim()
          });
        }
      }

      if (entries.length === 0) {
        console.log('No sentence pairs extracted for TM');
        return;
      }

      // Send to backend with score for quality tracking
      await axios.post(`${API}/admin/translation-memory?admin_key=${adminKey}`, {
        sourceLang: sourceLanguage,
        targetLang: targetLanguage,
        field: documentType || 'General',
        documentType: documentType,
        score: score,  // Include score so higher quality translations can replace lower ones
        entries: entries
      });

      console.log(`‚úÖ Saved ${entries.length} entries to Translation Memory (score: ${score}%)`);
      setProcessingStatus(`‚úÖ Proofreading complete! ${entries.length} pairs saved to TM (${score}%)`);
    } catch (error) {
      console.error('Failed to save to Translation Memory:', error);
      // Don't show error to user - TM save is optional
    }
  };

  // Convert file to base64
  const fileToBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const base64 = reader.result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  };

  // Helper function to detect if content is binary (corrupted Word file data)
  const isBinaryContent = (content) => {
    if (!content || typeof content !== 'string') return false;
    // Check for common binary signatures
    // PK = ZIP/DOCX header, starts with lots of null or control chars
    if (content.startsWith('PK')) return true;
    // Check for high ratio of non-printable characters
    const nonPrintable = content.slice(0, 500).split('').filter(c => {
      const code = c.charCodeAt(0);
      return code < 32 && code !== 9 && code !== 10 && code !== 13;
    }).length;
    return nonPrintable > 50; // More than 10% non-printable in first 500 chars
  };

  // Convert Word document (.docx) to HTML
  const convertWordToHtml = async (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const arrayBuffer = e.target.result;
          const result = await mammoth.convertToHtml({ arrayBuffer });
          resolve(result.value);
        } catch (err) {
          reject(err);
        }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  };

  // Convert PDF to images (one image per page)
  const convertPdfToImages = async (file, onProgress) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const typedArray = new Uint8Array(e.target.result);
          const pdf = await pdfjsLib.getDocument({ data: typedArray }).promise;
          const images = [];

          for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            if (onProgress) onProgress(pageNum, pdf.numPages);

            const page = await pdf.getPage(pageNum);
            const scale = 3; // Higher scale = better quality (3x for sharp PDF rendering)
            const viewport = page.getViewport({ scale });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: context, viewport }).promise;

            // Convert canvas to base64 PNG
            const dataUrl = canvas.toDataURL('image/png');
            const base64 = dataUrl.split(',')[1];

            // Validate that we got actual image data (not empty/blank)
            if (base64 && base64.length > 100) {
              images.push({
                filename: `${file.name}_page_${pageNum}.png`,
                data: base64,
                type: 'image/png'
              });
            } else {
              console.warn(`PDF page ${pageNum} rendered as empty, skipping`);
            }
          }

          if (images.length === 0) {
            reject(new Error('PDF conversion produced no valid images'));
          } else {
            resolve(images);
          }
        } catch (err) {
          reject(err);
        }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  };

  // Read HTML file content
  const readHtmlFile = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsText(file);
    });
  };

  // Read TXT file content
  const readTxtFile = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsText(file);
    });
  };

  // Helper function to ensure proper image src format (data URI)
  const getImageSrc = (img) => {
    if (!img || !img.data) return '';
    // If already a data URI, return as is
    if (img.data.startsWith('data:')) return img.data;
    // Otherwise, construct proper data URI (handle both type and contentType)
    const type = img.type || img.contentType || 'image/png';
    return `data:${type};base64,${img.data}`;
  };

  // OCR with backend (supports regular OCR or Claude OCR)
  const handleOCR = async () => {
    if (files.length === 0) {
      showToast('Please select files first');
      return;
    }

    if (useClaudeOcr && !claudeApiKey) {
      showToast('API Key is required for AI OCR. Please add it in Setup tab.');
      return;
    }

    setIsProcessing(true);
    setProcessingStatus(useClaudeOcr ? 'Performing OCR with Claude AI...' : 'Performing OCR...');
    setOcrResults([]);

    try {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        setProcessingStatus(`Processing ${file.name} (${i + 1}/${files.length})${useClaudeOcr ? ' with Claude AI' : ''}...`);

        const fileBase64 = await fileToBase64(file);

        const response = await axios.post(`${API}/admin/ocr?admin_key=${adminKey}`, {
          file_base64: fileBase64,
          file_type: file.type,
          filename: file.name,
          use_claude: useClaudeOcr,
          claude_api_key: useClaudeOcr ? claudeApiKey : null,
          special_commands: ocrSpecialCommands || null,
          preserve_layout: true
        });

        if (response.data.status === 'success' || response.data.text) {
          setOcrResults(prev => [...prev, {
            filename: file.name,
            text: response.data.text,
            html: response.data.html || null  // HTML with visual layout preservation
          }]);
        } else {
          throw new Error(response.data.error || response.data.detail || 'OCR failed');
        }
      }
      setProcessingStatus('‚úÖ OCR completed!');
    } catch (error) {
      console.error('OCR error:', error);
      setProcessingStatus(`‚ùå OCR failed: ${error.response?.data?.detail || error.message}`);
    } finally {
      setIsProcessing(false);
    }
  };

  // Translation with Claude
  const handleTranslate = async () => {
    if (ocrResults.length === 0) {
      showToast('Please perform OCR first');
      return;
    }

    if (!claudeApiKey) {
      showToast('Please configure your API Key in the Setup tab');
      setActiveSubTab('start');
      return;
    }

    setIsProcessing(true);
    setProcessingStatus('Translating with Claude AI...');
    setTranslationResults([]);

    try {
      for (let i = 0; i < ocrResults.length; i++) {
        const ocrResult = ocrResults[i];
        setProcessingStatus(`Translating ${ocrResult.filename} (${i + 1}/${ocrResults.length})...`);

        // Find corresponding original image for this file
        const originalImage = originalImages.find(img => img.filename === ocrResult.filename);

        // Build translator note settings for value conversion
        const translatorNoteData = translatorNoteEnabled ? {
          enabled: true,
          source_currency: translatorNoteSettings.sourceCurrency,
          target_currency: translatorNoteSettings.targetCurrency,
          exchange_rate: parseFloat(translatorNoteSettings.exchangeRate) || 0,
          rate_date: translatorNoteSettings.rateDate,
          rate_source: RATE_SOURCES.find(s => s.id === translatorNoteSettings.rateSource)?.url || '',
          convert_values: translatorNoteSettings.convertValues,
          source_currency_symbol: CURRENCIES[translatorNoteSettings.sourceCurrency]?.symbol || '',
          target_currency_symbol: CURRENCIES[translatorNoteSettings.targetCurrency]?.symbol || ''
        } : null;

        const response = await axios.post(`${API}/admin/translate?admin_key=${adminKey}`, {
          text: ocrResult.text,
          source_language: sourceLanguage,
          target_language: targetLanguage,
          document_type: documentType,
          claude_api_key: claudeApiKey,
          action: 'translate',
          general_instructions: generalInstructions,
          preserve_layout: true,
          page_format: pageFormat,
          // Send original image so Claude can see the visual layout
          original_image: originalImage ? originalImage.data : null,
          // Translator's note for financial documents
          translator_note: translatorNoteData
        });

        if (response.data.status === 'success' || response.data.translation) {
          // Get the translation and optionally prepend translator's note
          let finalTranslation = response.data.translation;

          // Add translator's note at the beginning of each file (not page)
          if (translatorNoteEnabled && translatorNoteSettings.exchangeRate) {
            const noteHTML = `
<div style="background-color: #fffbeb; border: 2px solid #f59e0b; border-radius: 8px; padding: 12px 16px; margin-bottom: 20px; font-style: italic;">
  <strong style="color: #b45309;">[TRANSLATOR'S NOTE:</strong> ${generateTranslatorNote().replace('[TRANSLATOR\'S NOTE:', '').replace(/\]$/, '')}<strong style="color: #b45309;">]</strong>
</div>`;

            // Insert the note after the opening body tag or at the start
            if (finalTranslation.includes('<body>')) {
              finalTranslation = finalTranslation.replace('<body>', '<body>' + noteHTML);
            } else if (finalTranslation.includes('<body')) {
              // Handle <body class="..."> or similar
              finalTranslation = finalTranslation.replace(/(<body[^>]*>)/, '$1' + noteHTML);
            } else {
              // Just prepend if no body tag
              finalTranslation = noteHTML + finalTranslation;
            }
          }

          setTranslationResults(prev => [...prev, {
            filename: ocrResult.filename,
            originalText: ocrResult.text,
            translatedText: finalTranslation
          }]);
        } else {
          throw new Error(response.data.error || response.data.detail || 'Translation failed');
        }
      }
      setProcessingStatus('‚úÖ Translation completed!');
      setActiveSubTab('review');
    } catch (error) {
      console.error('Translation error:', error);
      setProcessingStatus(`‚ùå Translation failed: ${error.response?.data?.detail || error.message}`);
    } finally {
      setIsProcessing(false);
    }
  };

  // Direct translation - Claude sees image directly, no OCR needed
  const handleDirectTranslate = async () => {
    if (originalImages.length === 0) {
      showToast('Please upload a document first');
      return;
    }

    if (!claudeApiKey) {
      showToast('Please configure your API Key in the Setup tab');
      setActiveSubTab('start');
      return;
    }

    setIsProcessing(true);
    setProcessingStatus('üåê Translating with Claude AI (analyzing image directly)...');
    setTranslationResults([]);

    try {
      const totalPages = originalImages.length;

      for (let i = 0; i < originalImages.length; i++) {
        const img = originalImages[i];
        const pageNumber = i + 1;
        setProcessingStatus(`Translating page ${pageNumber} of ${totalPages}: ${img.filename}...`);

        // Add page context to help Claude understand this is part of a multi-page document
        const pageContext = totalPages > 1
          ? `IMPORTANT: This is PAGE ${pageNumber} of ${totalPages} of a multi-page document. Translate ONLY the content visible in THIS image completely. Do NOT ask for other pages - they will be translated setotely.`
          : '';

        const response = await axios.post(`${API}/admin/translate?admin_key=${adminKey}`, {
          text: `[Document image attached - translate directly from image] ${pageContext}`,
          source_language: sourceLanguage,
          target_language: targetLanguage,
          document_type: documentType,
          claude_api_key: claudeApiKey,
          action: 'translate',
          general_instructions: `${generalInstructions}\n\n${pageContext}`.trim(),
          preserve_layout: true,
          page_format: pageFormat,
          original_image: img.data
        });

        if (response.data.status === 'success' || response.data.translation) {
          setTranslationResults(prev => [...prev, {
            filename: img.filename,
            originalText: `[Page ${pageNumber} of ${totalPages}]`,
            translatedText: response.data.translation
          }]);
        } else {
          throw new Error(response.data.error || response.data.detail || 'Translation failed');
        }
      }
      setProcessingStatus(`‚úÖ Translation completed! ${totalPages} page(s) translated.`);
    } catch (error) {
      console.error('Translation error:', error);
      setProcessingStatus(`‚ùå Translation failed: ${error.response?.data?.detail || error.message}`);
    } finally {
      setIsProcessing(false);
    }
  };

  // Apply correction
  const handleApplyCorrection = async () => {
    if (!correctionCommand.trim() || translationResults.length === 0) return;

    setApplyingCorrection(true);

    try {
      const currentResult = translationResults[selectedResultIndex];

      const response = await axios.post(`${API}/admin/translate?admin_key=${adminKey}`, {
        text: currentResult.translatedText,
        source_language: sourceLanguage,
        target_language: targetLanguage,
        document_type: documentType,
        claude_api_key: claudeApiKey,
        action: correctionCommand,
        current_translation: currentResult.translatedText
      });

      if (response.data.status === 'success' || response.data.translation) {
        let translationText = response.data.translation;
        let notesText = '';

        // Extract notes/changes made by Claude (text after "**Changes made:**" or similar patterns)
        const notesPatterns = [
          /(\*\*Changes made:\*\*[\s\S]*?)$/i,
          /(\*\*Corrections:\*\*[\s\S]*?)$/i,
          /(\*\*Notes:\*\*[\s\S]*?)$/i,
          /(Note:[\s\S]*?changes[\s\S]*?)$/i,
          /(\*\*Altera[√ßc][√µo]es:\*\*[\s\S]*?)$/i,
          /(\*\*Corre[√ßc][√µo]es:\*\*[\s\S]*?)$/i,
          /(\*\*Observa[√ßc][√µo]es:\*\*[\s\S]*?)$/i,
          /(---\s*\n[\s\S]*?(?:changes|altera√ß√µes|corre√ß√µes|notes|notas)[\s\S]*?)$/i,
          /(<hr[\s\S]*?>[\s\S]*?(?:changes|altera√ß√µes|corre√ß√µes|notes|notas)[\s\S]*?)$/i,
          /(I (?:made|applied|corrected|changed|fixed)[\s\S]*?)$/i,
          /(Eu (?:fiz|apliquei|corrigi|mudei|alterei)[\s\S]*?)$/i,
          /(Here are the changes[\s\S]*?)$/i,
          /(The following changes[\s\S]*?)$/i,
          /(Summary of changes[\s\S]*?)$/i,
          /(As altera√ß√µes foram[\s\S]*?)$/i
        ];

        for (const pattern of notesPatterns) {
          const match = translationText.match(pattern);
          if (match) {
            notesText = match[1].trim();
            translationText = translationText.replace(pattern, '').trim();
            break;
          }
        }

        // Also check for notes at the beginning (outside of HTML)
        if (!notesText && !translationText.startsWith('<!DOCTYPE') && !translationText.startsWith('<html')) {
          const htmlStart = translationText.search(/<(!DOCTYPE|html)/i);
          if (htmlStart > 0) {
            notesText = translationText.substring(0, htmlStart).trim();
            translationText = translationText.substring(htmlStart).trim();
          }
        }

        const updatedResults = [...translationResults];
        updatedResults[selectedResultIndex] = {
          ...currentResult,
          translatedText: translationText
        };
        setTranslationResults(updatedResults);

        // Save notes setotely
        if (notesText) {
          setClaudeNotes(prev => prev ? prev + '\n\n---\n\n' + notesText : notesText);
        }

        setCorrectionCommand('');
        setProcessingStatus('‚úÖ Correction applied!');
      } else {
        throw new Error(response.data.error || response.data.detail || 'Correction failed');
      }
    } catch (error) {
      console.error('Correction error:', error);
      showToast('Error applying correction: ' + error.message);
    } finally {
      setApplyingCorrection(false);
    }
  };

  // Extract body content and styles from full HTML document for contentEditable rendering
  // This fixes the "shrink" issue when editing full HTML documents in a div
  const extractBodyForEdit = (html) => {
    if (!html) return '<p>No translation</p>';

    // If it's not a full HTML document, return as-is
    if (!html.includes('<body') && !html.includes('<html')) {
      return html;
    }

    // Extract style content from head
    let styles = '';
    const styleMatch = html.match(/<style[^>]*>([\s\S]*?)<\/style>/gi);
    if (styleMatch) {
      styles = styleMatch.map(s => s.replace(/<\/?style[^>]*>/gi, '')).join('\n');
    }

    // Extract body content
    let bodyContent = html;
    const bodyMatch = html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
    if (bodyMatch) {
      bodyContent = bodyMatch[1];
    } else {
      // Try to extract content after </head> or after <html>
      const headEndMatch = html.match(/<\/head>\s*([\s\S]*?)<\/html>/i);
      if (headEndMatch) {
        bodyContent = headEndMatch[1];
      }
    }

    // Wrap with styles if present
    if (styles) {
      return `<style>${styles}</style>${bodyContent}`;
    }

    return bodyContent;
  };

  // Update translation text manually
  const handleTranslationEdit = (newText) => {
    const updatedResults = [...translationResults];
    updatedResults[selectedResultIndex] = {
      ...updatedResults[selectedResultIndex],
      translatedText: newText
    };
    setTranslationResults(updatedResults);
    setHasUnsavedChanges(true); // Mark as having unsaved changes
  };

  // Save and restore selection for formatting commands
  const savedSelection = useRef(null);

  const saveSelection = () => {
    const sel = window.getSelection();
    if (sel.rangeCount > 0) {
      savedSelection.current = sel.getRangeAt(0);
    }
  };

  const restoreSelection = () => {
    if (savedSelection.current) {
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(savedSelection.current);
    }
  };

  // Execute formatting command and maintain focus on contentEditable
  const execFormatCommand = (command, value = null) => {
    restoreSelection();

    // Handle font size increase/decrease
    if (command === 'increaseFontSize' || command === 'decreaseFontSize') {
      const selection = window.getSelection();
      if (selection.rangeCount > 0 && !selection.isCollapsed) {
        const range = selection.getRangeAt(0);
        const span = document.createElement('span');

        // Get current font size from selection or default to 12pt
        // Note: computedStyle.fontSize returns pixels, so we convert to points (px * 0.75 = pt)
        let currentSizePt = 12;
        const parentElement = range.commonAncestorContainer.parentElement;
        if (parentElement) {
          const computedStyle = window.getComputedStyle(parentElement);
          const fontSizePx = parseFloat(computedStyle.fontSize) || 16;
          currentSizePt = Math.round(fontSizePx * 0.75); // Convert px to pt
        }

        // Increase or decrease by 2pt (min 4pt to allow very small sizes)
        const newSize = command === 'increaseFontSize'
          ? Math.min(currentSizePt + 2, 48)
          : Math.max(currentSizePt - 2, 4);
        span.style.fontSize = `${newSize}pt`;

        try {
          span.appendChild(range.extractContents());
          range.insertNode(span);
          selection.removeAllRanges();
          const newRange = document.createRange();
          newRange.selectNodeContents(span);
          selection.addRange(newRange);
        } catch (e) {
          console.error('Error applying font size:', e);
        }
      }
    }
    // Handle fontSize and fontName specially since execCommand doesn't work well for these
    else if (command === 'fontSize' || command === 'fontName') {
      const selection = window.getSelection();
      if (selection.rangeCount > 0 && !selection.isCollapsed) {
        const range = selection.getRangeAt(0);
        const span = document.createElement('span');

        if (command === 'fontSize') {
          // Map values 1-7 to actual pt sizes
          const sizeMap = { '1': '8pt', '2': '10pt', '3': '12pt', '4': '14pt', '5': '18pt', '6': '24pt', '7': '36pt' };
          span.style.fontSize = sizeMap[value] || value;
        } else if (command === 'fontName') {
          span.style.fontFamily = value;
        }

        try {
          span.appendChild(range.extractContents());
          range.insertNode(span);
          // Select the new span content
          selection.removeAllRanges();
          const newRange = document.createRange();
          newRange.selectNodeContents(span);
          selection.addRange(newRange);
        } catch (e) {
          console.error('Error applying format:', e);
        }
      }
    }
    // Handle line spacing
    else if (command === 'increaseLineHeight' || command === 'decreaseLineHeight') {
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        // Get the editable container
        const container = editableRef.current;
        if (container) {
          // Get current line height
          const computedStyle = window.getComputedStyle(container);
          let currentLineHeight = parseFloat(computedStyle.lineHeight);
          if (isNaN(currentLineHeight)) currentLineHeight = 1.5;
          else currentLineHeight = currentLineHeight / parseFloat(computedStyle.fontSize);

          // Increase or decrease by 0.2
          const newLineHeight = command === 'increaseLineHeight'
            ? Math.min(currentLineHeight + 0.2, 3.0)
            : Math.max(currentLineHeight - 0.2, 1.0);

          container.style.lineHeight = newLineHeight.toFixed(1);
        }
      }
    } else {
      document.execCommand(command, false, value);
    }

    if (editableRef.current) {
      editableRef.current.focus();
    }
    // Save selection after command for next operation
    setTimeout(saveSelection, 0);
  };

  // Quick Package file handlers - with progress feedback and multi-format support
  const handleQuickTranslationUpload = async (e) => {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;

    setQuickPackageLoading(true);
    setQuickPackageProgress(`Processing ${files.length} translation file(s)...`);

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const fileName = file.name.toLowerCase();
      setQuickPackageProgress(`Processing translation ${i + 1}/${files.length}: ${file.name}`);

      try {
        // Word document (.docx or .doc)
        if (fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
          setQuickPackageProgress(`Converting Word document: ${file.name}`);
          const html = await convertWordToHtml(file);
          setQuickTranslationHtml(prev => prev + (prev ? '<div style="page-break-before: always;"></div>' : '') + html);
          setQuickTranslationType('html');
        }
        // HTML file
        else if (fileName.endsWith('.html') || fileName.endsWith('.htm')) {
          setQuickPackageProgress(`Reading HTML: ${file.name}`);
          const html = await readHtmlFile(file);
          setQuickTranslationHtml(prev => prev + (prev ? '<div style="page-break-before: always;"></div>' : '') + html);
          setQuickTranslationType('html');
        }
        // Text file
        else if (fileName.endsWith('.txt')) {
          setQuickPackageProgress(`Reading text file: ${file.name}`);
          const text = await readTxtFile(file);
          const html = `<div style="white-space: pre-wrap; font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.6;">${text}</div>`;
          setQuickTranslationHtml(prev => prev + (prev ? '<div style="page-break-before: always;"></div>' : '') + html);
          setQuickTranslationType('html');
        }
        // PDF - convert to images first
        else if (fileName.endsWith('.pdf')) {
          setQuickPackageProgress(`Converting PDF to images: ${file.name}`);
          try {
            const images = await convertPdfToImages(file, (page, total) => {
              setQuickPackageProgress(`Converting PDF page ${page}/${total}: ${file.name}`);
            });
            // Add each page as a setote image
            images.forEach((img, pageIdx) => {
              setQuickTranslationFiles(prev => [...prev, {
                filename: `${file.name.replace('.pdf', '')}_page_${pageIdx + 1}.png`,
                data: img.data.includes(',') ? img.data.split(',')[1] : img.data,
                type: 'image/png'
              }]);
            });
            if (!quickTranslationHtml) setQuickTranslationType('images');
          } catch (pdfErr) {
            console.error('PDF conversion failed:', pdfErr);
            setQuickPackageProgress(`‚ö†Ô∏è PDF conversion failed for ${file.name}`);
          }
        }
        // Images (JPG, PNG, etc.)
        else if (file.type.startsWith('image/')) {
          const base64 = await fileToBase64(file);
          // Validate that we got actual data
          if (base64 && base64.length > 100) {
            setQuickTranslationFiles(prev => [...prev, {
              filename: file.name,
              data: base64,
              type: file.type
            }]);
            if (!quickTranslationHtml) setQuickTranslationType('images');
          } else {
            console.warn(`Image file ${file.name} produced empty data, skipping`);
            setQuickPackageProgress(`‚ö†Ô∏è Failed to process ${file.name}`);
          }
        }
        else {
          console.warn(`Unsupported file type: ${file.name}`);
        }
      } catch (err) {
        console.error(`Error processing ${file.name}:`, err);
        setQuickPackageProgress(`‚ö†Ô∏è Error processing ${file.name}`);
      }
    }

    setQuickPackageLoading(false);
    setQuickPackageProgress(`‚úÖ Translation file(s) ready`);
    setTimeout(() => setQuickPackageProgress(''), 3000);
  };

  const handleQuickOriginalUpload = async (e) => {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;

    setQuickPackageLoading(true);
    setQuickPackageProgress(`Processing ${files.length} original file(s)...`);
    const processedFiles = [];

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const fileName = file.name.toLowerCase();
      setQuickPackageProgress(`Processing original ${i + 1}/${files.length}: ${file.name}`);

      try {
        // PDF - convert to images first
        if (fileName.endsWith('.pdf')) {
          setQuickPackageProgress(`Converting PDF to images: ${file.name}`);
          try {
            const images = await convertPdfToImages(file, (page, total) => {
              setQuickPackageProgress(`Converting PDF page ${page}/${total}: ${file.name}`);
            });
            // Add each page as a setote image
            images.forEach((img, pageIdx) => {
              processedFiles.push({
                filename: `${file.name.replace('.pdf', '')}_page_${pageIdx + 1}.png`,
                data: img.data.includes(',') ? img.data.split(',')[1] : img.data,
                type: 'image/png'
              });
            });
          } catch (pdfErr) {
            console.error('PDF conversion failed:', pdfErr);
            setQuickPackageProgress(`‚ö†Ô∏è PDF conversion failed for ${file.name}`);
          }
        }
        // Images
        else if (file.type.startsWith('image/')) {
          const base64 = await fileToBase64(file);
          // Validate that we got actual data
          if (base64 && base64.length > 100) {
            processedFiles.push({
              filename: file.name,
              data: base64,
              type: file.type
            });
          } else {
            console.warn(`Image file ${file.name} produced empty data, skipping`);
          }
        }
        else {
          console.warn(`Unsupported file type for original: ${file.name}`);
        }
      } catch (err) {
        console.error(`Error processing ${file.name}:`, err);
      }
    }

    setQuickOriginalFiles(prev => [...prev, ...processedFiles]);
    setQuickPackageLoading(false);
    setQuickPackageProgress(`‚úÖ ${processedFiles.length} original page(s) ready`);
    setTimeout(() => setQuickPackageProgress(''), 3000);
  };

  // Quick Package Download - generates complete certified translation package (same layout as normal flow)
  const handleQuickPackageDownload = async () => {
    setQuickPackageLoading(true);
    setQuickPackageProgress('Generating package...');

    // Small delay to let UI update
    await new Promise(resolve => setTimeout(resolve, 100));

    // Create certification with QR code if enabled
    let certData = certificationData;
    if (includeCertification && !certData) {
      setQuickPackageProgress('Creating certification...');
      // For Quick Package, we need to create certification with available content
      try {
        const translationContent = quickTranslationHtml || 'Quick Package Translation';
        const translator = TRANSLATORS.find(t => t.name === selectedTranslator);

        const response = await axios.post(`${API}/certifications/create?admin_key=${adminKey}`, {
          order_id: selectedOrderId,
          order_number: orderNumber,
          document_type: documentType,
          source_language: sourceLanguage,
          target_language: targetLanguage,
          page_count: quickTranslationFiles.length || 1,
          document_content: translationContent,
          certifier_name: translator?.name || 'Beatriz Paiva',
          certifier_title: 'Legal Representative',
          certifier_credentials: 'ATA Member # 275993',
          company_name: certCompanyName || 'Legacy Translations Inc.',
          company_address: certCompanyAddress || '867 Boylston Street, 5th Floor, #2073, Boston, MA 02116',
          company_phone: certCompanyPhone || '(857) 316-7770',
          company_email: certCompanyEmail || 'contact@legacytranslations.com',
          client_name: selectedOrder?.client_name || ''
        });

        certData = response.data;
        setCertificationData(certData);
      } catch (err) {
        console.error('Failed to create certification for Quick Package:', err);
        // Show warning but continue without verification page
        setQuickPackageProgress('‚ö†Ô∏è Verification page not available - continuing without QR code...');
        await new Promise(resolve => setTimeout(resolve, 2000));
        // Alert user so they're aware
        console.warn('Certificate creation failed. Check if order is selected and API is accessible.');
      }
      setQuickPackageProgress('Generating package...');
    }

    // Log certification status for debugging
    console.log('Certification status:', { includeCertification, hasCertData: !!certData, certId: certData?.certification_id });

    // Use saved translator name from database if available, otherwise fall back to UI selection
    const translatorNameForCert = savedTranslatorName || selectedTranslator;
    const translator = TRANSLATORS.find(t => t.name === translatorNameForCert);
    const pageSizeCSS = pageFormat === 'a4' ? 'A4' : 'Letter';
    const certTitle = translationType === 'sworn' ? 'Sworn Translation Certificate' : 'Certification of Translation Accuracy';

    // Cover Letter HTML - MATCHING START PREVIEW EXACTLY
    const coverLetterHTML = `
    <div style="font-family: Georgia, 'Times New Roman', serif; font-size: 12px; line-height: 1.6; max-width: 100%; padding: 0; page-break-after: always;">

        <!-- HEADER - Using fixed widths like START preview -->
        <div style="width: 100%; margin-bottom: 8px; overflow: hidden;">
            <div style="float: left; width: 128px;">
                ${logoLeft
                  ? `<img src="${logoLeft}" alt="Logo" style="max-height: 48px; max-width: 120px;" />`
                  : `<div style="font-size: 10px; color: #2563eb; font-weight: bold;">LEGACY<br/><span style="font-weight: normal; font-size: 8px;">TRANSLATIONS</span></div>`}
            </div>
            <div style="float: right; width: 80px; text-align: right;">
                ${logoRight
                  ? `<img src="${logoRight}" alt="ATA" style="max-height: 40px; max-width: 75px;" />`
                  : `<div style="font-size: 9px; color: #666; font-style: italic;">ata<br/><span style="font-size: 8px;">MEMBER</span><br/><span style="font-size: 7px;">American Translators Association</span></div>`}
            </div>
            <div style="margin-left: 138px; margin-right: 90px; text-align: center;">
                <div style="font-weight: bold; color: #2563eb; font-size: 14px; font-style: italic;">Legacy Translations</div>
                <div style="font-size: 9px; color: #666;">867 Boylston Street ¬∑ 5th Floor ¬∑ #2073 ¬∑ Boston, MA ¬∑ 02116</div>
                <div style="font-size: 9px; color: #666;">(857) 316-7770 ¬∑ contact@legacytranslations.com</div>
            </div>
        </div>

        <!-- Blue line -->
        <div style="clear: both; width: 100%; height: 2px; background: #93c5fd; margin-bottom: 16px;"></div>

        <!-- Order Number -->
        ${orderNumber && !orderNumber.toLowerCase().includes('order0') && orderNumber !== 'P0000'
          ? `<div style="text-align: right; margin-bottom: 24px; font-size: 14px;">Order # <strong>${orderNumber}</strong></div>`
          : '<div style="margin-bottom: 24px;"></div>'}

        <!-- Main Title -->
        <h1 style="text-align: center; font-size: 24px; font-weight: normal; margin-bottom: 30px; color: #1a365d; letter-spacing: 0.5px;">${certTitle}</h1>

        <!-- Translation of... -->
        <p style="text-align: center; margin-bottom: 30px; font-size: 14px; line-height: 1.8;">
            Translation of a <strong>${documentType}</strong> from <strong>${sourceLanguage}</strong> to<br/>
            <strong>${targetLanguage}</strong>
        </p>

        <!-- Body Paragraphs -->
        ${(() => {
          let templateParagraphs;
          if (selectedCertificateTemplate.startsWith('custom-')) {
            const customTemplate = customCertificateTemplates.find(t => `custom-${t.id}` === selectedCertificateTemplate);
            templateParagraphs = customTemplate?.bodyParagraphs || CERTIFICATE_TEMPLATES['default'].bodyParagraphs;
          } else {
            templateParagraphs = CERTIFICATE_TEMPLATES[selectedCertificateTemplate]?.bodyParagraphs || CERTIFICATE_TEMPLATES['default'].bodyParagraphs;
          }
          return templateParagraphs.map(p => {
            const processed = p.replace(/\{\{sourceLanguage\}\}/g, sourceLanguage).replace(/\{\{targetLanguage\}\}/g, targetLanguage);
            return `<p style="text-align: justify; margin-bottom: 16px; line-height: 1.8; font-size: 12px;">${processed}</p>`;
          }).join('\n        ');
        })()}

        <!-- Signature Section - Fixed at bottom -->
        <div style="margin-top: 60px; overflow: hidden;">
            <div style="float: left; width: 60%;">
                ${signatureImage
                  ? `<img src="${signatureImage}" alt="Signature" style="max-height: 40px; max-width: 180px; margin-bottom: 4px;" />`
                  : `<div style="font-family: 'Brush Script MT', cursive; font-size: 24px; color: #1a365d; margin-bottom: 4px;">Beatriz Paiva</div>`}
                <div style="font-weight: bold; font-size: 12px;">Authorized Representative</div>
                <div style="font-size: 12px;">Legacy Translations Inc.</div>
                <div style="font-size: 12px; margin-top: 8px;">Dated: ${translationDate}</div>
            </div>
            <div style="float: right; width: 35%; text-align: right;">
                ${logoStamp
                  ? `<img src="${logoStamp}" alt="Stamp" style="width: 120px; height: 120px; object-fit: contain;" />`
                  : `<div style="width: 120px; height: 120px; border: 4px double #2563eb; border-radius: 50%; margin-left: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px;">
                      <div style="font-size: 7px; font-weight: bold; color: #2563eb;">CERTIFIED TRANSLATOR</div>
                      <div style="font-size: 9px; font-weight: bold; color: #2563eb; margin-top: 4px;">LEGACY TRANSLATIONS</div>
                      <div style="font-size: 7px; color: #2563eb;">ATA # 275993</div>
                    </div>`}
            </div>
        </div>
    </div>`;

    // Letterhead for all pages - Same style as cover
    const letterheadHTML = `
        <div style="width: 100%; margin-bottom: 8px; padding-bottom: 4px; overflow: hidden;">
            <div style="float: left; width: 128px;">
                ${logoLeft
                  ? `<img src="${logoLeft}" alt="Logo" style="max-height: 48px; max-width: 120px;" />`
                  : `<div style="font-size: 10px; color: #2563eb; font-weight: bold;">LEGACY<br/><span style="font-weight: normal; font-size: 8px;">TRANSLATIONS</span></div>`}
            </div>
            <div style="float: right; width: 80px; text-align: right;">
                ${logoRight
                  ? `<img src="${logoRight}" alt="ATA" style="max-height: 40px; max-width: 75px;" />`
                  : `<div style="font-size: 9px; color: #666; font-style: italic;">ata<br/><span style="font-size: 8px;">MEMBER</span></div>`}
            </div>
            <div style="margin-left: 138px; margin-right: 90px; text-align: center;">
                <div style="font-weight: bold; color: #2563eb; font-size: 14px; font-style: italic;">Legacy Translations</div>
                <div style="font-size: 9px; color: #666;">867 Boylston Street ¬∑ 5th Floor ¬∑ #2073 ¬∑ Boston, MA ¬∑ 02116</div>
                <div style="font-size: 9px; color: #666;">(857) 316-7770 ¬∑ contact@legacytranslations.com</div>
            </div>
        </div>
        <div style="clear: both; width: 100%; height: 2px; background: #93c5fd; margin-bottom: 16px;"></div>`;

    // Translation pages - supports HTML content OR images (not both to avoid duplication)
    let translationPagesHTML = '';

    // Filter out files with invalid/missing data to prevent blank pages
    const validTranslationFiles = quickTranslationFiles.filter(file => file.data && file.data.length > 100);

    // Prefer image files if available (from images or PDF conversion) - each page gets its own header
    // First page doesn't need page-break since cover ends with one
    if (validTranslationFiles.length > 0) {
      translationPagesHTML = validTranslationFiles.map((file, idx) => `
    <div style="${idx > 0 ? 'page-break-before: always;' : ''} padding-top: 5px;">
        ${includeLetterhead ? letterheadHTML : ''}
        <div>
            <img src="data:${file.type || 'image/png'};base64,${file.data}" alt="Translation page ${idx + 1}" style="width: 100%; max-height: 8.5in; object-fit: contain; display: block; margin: 0 auto;" />
        </div>
    </div>`).join('');
    }
    // Otherwise use HTML content (from Word/HTML/TXT)
    // Uses table+thead so letterhead repeats on every printed page when content overflows
    else if (quickTranslationHtml) {
      translationPagesHTML = `
    <div style="padding-top: 5px;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr><td style="border: none; padding: 0; font-size: inherit;">
                    ${includeLetterhead ? letterheadHTML : ''}
                </td></tr>
            </thead>
            <tbody>
                <tr><td style="border: none; padding: 0; line-height: 1.5; font-size: 11pt;">
                    ${quickTranslationHtml}
                </td></tr>
            </tbody>
        </table>
    </div>`;
    }

    // Original document pages
    const validOriginalFiles = quickOriginalFiles.filter(file => file.data && file.data.length > 100);
    const originalPagesHTML = (includeOriginal && validOriginalFiles.length > 0) ? validOriginalFiles.map((file, idx) => `
    <div style="page-break-before: always; padding-top: 5px;">
        ${includeLetterhead ? letterheadHTML : ''}
        ${idx === 0 ? '<div style="font-size: 13px; font-weight: bold; text-align: center; margin: 8px 0; color: #1a365d; text-transform: uppercase; letter-spacing: 2px;">Original Document</div>' : ''}
        <div style="text-align: center;">
            <img src="data:${file.type || 'image/png'};base64,${file.data}" alt="Original page ${idx + 1}" style="width: 100%; max-height: 8.5in; object-fit: contain; display: block; margin: 0 auto;" />
        </div>
    </div>`).join('') : '';

    // Certification verification page HTML - ALL INLINE STYLES
    const certificationPageHTML = (includeCertification && certData) ? `
    <div style="page-break-before: always; padding-top: 10px;">
        ${includeLetterhead ? letterheadHTML : ''}

        <div style="max-width: 520px; margin: 25px auto; padding: 28px; border: 2px solid #2563eb; border-radius: 12px; background: #f8fafc; font-family: Georgia, 'Times New Roman', serif;">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 25px;">
                <div style="font-size: 40px; margin-bottom: 10px;">üîê</div>
                <h2 style="font-size: 20px; font-weight: bold; color: #1e40af; margin-bottom: 5px;">Document Verification</h2>
                <p style="font-size: 12px; color: #64748b;">This certified translation can be verified online</p>
            </div>

            <!-- Content: Info + QR side by side -->
            <div style="overflow: hidden; margin-bottom: 20px;">
                <div style="float: left; width: 55%;">
                    <div style="padding: 8px 0; border-bottom: 1px solid #e2e8f0; overflow: hidden;">
                        <span style="float: left; font-size: 11px; color: #64748b;">Certification ID:</span>
                        <span style="float: right; font-size: 11px; font-weight: 600; color: #2563eb; font-family: monospace;">${certData.certification_id}</span>
                    </div>
                    <div style="padding: 8px 0; border-bottom: 1px solid #e2e8f0; overflow: hidden;">
                        <span style="float: left; font-size: 11px; color: #64748b;">Document Type:</span>
                        <span style="float: right; font-size: 11px; font-weight: 600; color: #1e293b;">${documentType}</span>
                    </div>
                    <div style="padding: 8px 0; border-bottom: 1px solid #e2e8f0; overflow: hidden;">
                        <span style="float: left; font-size: 11px; color: #64748b;">Translation:</span>
                        <span style="float: right; font-size: 11px; font-weight: 600; color: #1e293b;">${sourceLanguage} ‚Üí ${targetLanguage}</span>
                    </div>
                    <div style="padding: 8px 0; border-bottom: 1px solid #e2e8f0; overflow: hidden;">
                        <span style="float: left; font-size: 11px; color: #64748b;">Certified Date:</span>
                        <span style="float: right; font-size: 11px; font-weight: 600; color: #1e293b;">${new Date(certData.certified_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                    </div>
                    <div style="padding: 8px 0; border-bottom: 1px solid #e2e8f0; overflow: hidden;">
                        <span style="float: left; font-size: 11px; color: #64748b;">Document Hash:</span>
                        <span style="float: right; font-size: 10px; font-weight: 600; color: #1e293b; font-family: monospace;">${certData.document_hash?.substring(0, 16)}...</span>
                    </div>
                </div>
                <div style="float: right; width: 40%; text-align: center; padding-left: 15px;">
                    ${certData.qr_code_data
                      ? `<img src="data:image/png;base64,${certData.qr_code_data}" alt="QR Code" style="width: 120px; height: 120px; border: 1px solid #e2e8f0; border-radius: 8px;" />`
                      : '<div style="width: 120px; height: 120px; border: 1px solid #e2e8f0; border-radius: 8px; margin: 0 auto; color: #999; text-align: center; line-height: 120px;">QR Code</div>'}
                    <p style="font-size: 10px; color: #64748b; margin-top: 5px;">Scan to verify</p>
                </div>
            </div>

            <!-- Footer -->
            <div style="clear: both; text-align: center; padding-top: 20px; border-top: 1px solid #e2e8f0; margin-top: 10px;">
                <p style="font-size: 11px; color: #1e40af; margin-bottom: 10px;">Verify at: <strong>${certData.verification_url}</strong></p>
                <p style="font-size: 9px; color: #64748b; line-height: 1.4;">This document has been digitally certified by Legacy Translations Inc. Any alterations to this document will invalidate this certification.</p>
            </div>
        </div>
    </div>
    ` : '';

    // Complete HTML using UNIFIED styles (same as Normal Flow)
    const fullHTML = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>${certTitle} - ${orderNumber || 'Document'}</title>
    <style>
        ${getUnifiedPdfStyles(pageSizeCSS)}
    </style>
</head>
<body>
    ${includeCover ? coverLetterHTML : ''}
    ${translationPagesHTML}
    ${originalPagesHTML}
    ${certificationPageHTML}
</body>
</html>`;

    // Generate PDF - use print window approach which is more reliable
    setQuickPackageProgress(`Opening preview window...`);

    try {
      const filename = `${orderNumber || 'LT'}_Certified_Translation.pdf`;

      // Open print window - larger and more visible
      const screenWidth = window.screen.width;
      const screenHeight = window.screen.height;
      const windowWidth = Math.min(1200, screenWidth - 100);
      const windowHeight = Math.min(900, screenHeight - 100);
      const left = (screenWidth - windowWidth) / 2;
      const top = (screenHeight - windowHeight) / 2;

      const printWindow = window.open('', 'PDFPreview', `width=${windowWidth},height=${windowHeight},left=${left},top=${top},scrollbars=yes,resizable=yes`);

      if (!printWindow || printWindow.closed || typeof printWindow.closed === 'undefined') {
        alert('‚ö†Ô∏è Pop-up bloqueado!\n\nPor favor, permita pop-ups para este site:\n1. Clique no √≠cone de pop-up bloqueado na barra de endere√ßo\n2. Selecione "Sempre permitir pop-ups"\n3. Tente novamente');
        setQuickPackageLoading(false);
        setQuickPackageProgress('');
        return;
      }

      // Write HTML to the window
      printWindow.document.open();
      printWindow.document.write(fullHTML);
      printWindow.document.close();

      // Wait for content to load
      await new Promise(resolve => {
        if (printWindow.document.readyState === 'complete') {
          resolve();
        } else {
          printWindow.onload = resolve;
          setTimeout(resolve, 2000);
        }
      });

      // Wait for images to load
      const images = printWindow.document.querySelectorAll('img');
      if (images.length > 0) {
        setQuickPackageProgress(`Loading ${images.length} images...`);
        await Promise.all(Array.from(images).map(img => {
          return new Promise((resolve) => {
            if (img.complete && img.naturalHeight !== 0) {
              resolve();
            } else {
              img.onload = resolve;
              img.onerror = resolve;
              setTimeout(resolve, 5000);
            }
          });
        }));
      }

      // Small delay for final rendering
      await new Promise(resolve => setTimeout(resolve, 500));

      // Update certification hash using document content hash
      if (certData?.certification_id) {
        setQuickPackageProgress('Registering digital signature...');
        // Calculate hash from HTML content for verification
        const encoder = new TextEncoder();
        const data = encoder.encode(fullHTML);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const contentHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

        const hashResult = await updatePdfHashInBackend(certData.certification_id, contentHash, adminKey);
        if (hashResult.success) {
          setQuickPackageProgress('‚úÖ Digital signature registered!');
        }
      }

      setQuickPackageProgress('');
      setQuickPackageLoading(false);

      // Focus and print
      printWindow.focus();

      // Add print instructions
      const instructionDiv = printWindow.document.createElement('div');
      instructionDiv.id = 'print-instructions';
      instructionDiv.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; background: #1e40af; color: white; padding: 12px 20px; z-index: 99999; font-family: sans-serif; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>üìÑ Document Preview</strong> - Use "Save as PDF" or print to get your certified translation
          </div>
          <div>
            <button onclick="window.print()" style="background: white; color: #1e40af; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-right: 10px;">
              üñ®Ô∏è Print / Save as PDF
            </button>
            <button onclick="document.getElementById('print-instructions').remove()" style="background: transparent; color: white; border: 1px solid white; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
              ‚úï Close Bar
            </button>
          </div>
        </div>
        <style>@media print { #print-instructions { display: none !important; } }</style>
      `;
      printWindow.document.body.insertBefore(instructionDiv, printWindow.document.body.firstChild);

    } catch (err) {
      console.error('Error generating package:', err);
      showToast('Error generating PDF package. Please try again.');
      setQuickPackageLoading(false);
      setQuickPackageProgress('');
    }
  };

  // Save Translation Memory
  const saveTranslationMemory = async () => {
    if (!saveToTM || translationResults.length === 0) return;

    const typeLabels = {
      'financial': 'Financial',
      'education': 'Education',
      'general': 'General',
      'personal': 'Personal Documents'
    };

    // Extract text from translations (strip HTML)
    const extractText = (html) => {
      const temp = document.createElement('div');
      temp.innerHTML = html;
      return temp.textContent || temp.innerText || '';
    };

    // Create TM entry
    const tmEntry = {
      id: Date.now(),
      name: `TM - ${documentType || 'Document'} - ${new Date().toLocaleDateString('en-US', { timeZone: 'America/New_York' })}`,
      sourceLang: sourceLanguage,
      targetLang: targetLanguage,
      field: typeLabels[documentCategory] || 'General',
      bidirectional: false,
      terms: translationResults.map((result, idx) => ({
        source: result.originalText || extractText(result.original || ''),
        target: extractText(result.translatedText || ''),
        context: `Page ${idx + 1} - ${orderNumber || 'No order'}`
      })).filter(t => t.source && t.target)
    };

    if (tmEntry.terms.length > 0) {
      // Save to glossaries
      const newGlossaries = [...glossaries, tmEntry];
      setGlossaries(newGlossaries);

      // Persist to backend
      try {
        await axios.post(`${API}/glossaries`, tmEntry, { withCredentials: true });
      } catch (err) {
        // Save to localStorage as fallback
        localStorage.setItem('glossaries', JSON.stringify(newGlossaries));
      }
    }
  };

  // Create document certification with QR code
  const createCertification = async () => {
    try {
      const translator = TRANSLATORS.find(t => t.name === selectedTranslator);
      const translationContent = translationResults.map(r => r.translatedText).join('\n');

      const response = await axios.post(`${API}/certifications/create?admin_key=${adminKey}`, {
        order_id: selectedOrderId,
        order_number: orderNumber,
        document_type: documentType,
        source_language: sourceLanguage,
        target_language: targetLanguage,
        page_count: translationResults.length,
        document_content: translationContent,
        certifier_name: translator?.name || 'Beatriz Paiva',
        certifier_title: 'Legal Representative',
        certifier_credentials: 'ATA Member # 275993',
        company_name: certCompanyName || 'Legacy Translations Inc.',
        company_address: certCompanyAddress || '867 Boylston Street, 5th Floor, #2073, Boston, MA 02116',
        company_phone: certCompanyPhone || '(857) 316-7770',
        company_email: certCompanyEmail || 'contact@legacytranslations.com',
        client_name: selectedOrder?.client_name || ''
      });

      setCertificationData(response.data);
      return response.data;
    } catch (err) {
      console.error('Failed to create certification:', err);
      return null;
    }
  };

  // Download certificate preview only (for Admin and PM)
  const handleDownloadCertificatePreview = () => {
    const translator = TRANSLATORS.find(t => t.name === selectedTranslator);
    const certTitle = translationType === 'sworn' ? 'Sworn Translation Certificate' : 'Certification of Translation Accuracy';
    const isFormTemplate = CERTIFICATE_TEMPLATES[selectedCertificateTemplate]?.isForm;

    // Get template paragraphs
    let templateParagraphs;
    if (selectedCertificateTemplate.startsWith('custom-')) {
      const customTemplate = customCertificateTemplates.find(t => `custom-${t.id}` === selectedCertificateTemplate);
      templateParagraphs = customTemplate?.bodyParagraphs || CERTIFICATE_TEMPLATES['default'].bodyParagraphs;
    } else {
      templateParagraphs = CERTIFICATE_TEMPLATES[selectedCertificateTemplate]?.bodyParagraphs || CERTIFICATE_TEMPLATES['default'].bodyParagraphs;
    }

    // Generate certificate HTML
    const certificateHTML = isFormTemplate ? `
      <div style="padding: 20px;">
        ${CERTIFICATE_TEMPLATES[selectedCertificateTemplate].formHTML
          .replace(/\{\{LOGO_LEFT\}\}/g, logoLeft ? `<img src="${logoLeft}" alt="Logo" style="max-height: 48px;" />` : '<div style="font-size: 10px; color: #2563eb; font-weight: bold;">LEGACY<br/><span style="font-weight: normal; font-size: 8px;">TRANSLATIONS</span></div>')
          .replace(/\{\{LOGO_RIGHT\}\}/g, logoRight ? `<img src="${logoRight}" alt="ATA" style="max-height: 40px;" />` : '<div style="font-size: 9px; color: #666; font-style: italic;">ata<br/><span style="font-size: 8px;">MEMBER</span><br/><span style="font-size: 7px;">American Translators Association</span></div>')
          .replace(/\{\{LOGO_STAMP\}\}/g, logoStamp ? `<img src="${logoStamp}" alt="Stamp" style="width: 100px; height: 100px; object-fit: contain;" />` : '')
          .replace(/\{\{SIGNATURE\}\}/g, signatureImage ? `<img src="${signatureImage}" alt="Signature" style="max-height: 32px; max-width: 150px;" />` : '')
          .replace(/\{\{TODAY_DATE\}\}/g, new Date().toLocaleDateString('en-US', { timeZone: 'America/New_York' }))}
      </div>
    ` : `
      <div style="font-family: Georgia, 'Times New Roman', serif; font-size: 12px; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 32px; background: white;">
        <!-- Header with logos -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px;">
          <div style="width: 128px;">
            ${logoLeft ? `<img src="${logoLeft}" alt="Logo" style="max-height: 48px;" />` : '<div style="font-size: 10px; color: #2563eb; font-weight: bold;">LEGACY<br/><span style="font-weight: normal; font-size: 8px;">TRANSLATIONS</span></div>'}
          </div>
          <div style="text-align: center; flex: 1; padding: 0 16px;">
            <div style="font-weight: bold; color: #2563eb; font-size: 14px;">Legacy Translations</div>
            <div style="font-size: 9px; color: #666;">867 Boylston Street ¬∑ 5th Floor ¬∑ #2073 ¬∑ Boston, MA ¬∑ 02116</div>
            <div style="font-size: 9px; color: #666;">(857) 316-7770 ¬∑ contact@legacytranslations.com</div>
          </div>
          <div style="width: 80px; text-align: left;">
            ${logoRight ? `<img src="${logoRight}" alt="ATA" style="max-height: 40px;" />` : '<div style="font-size: 9px; color: #666; font-style: italic;">ata<br/><span style="font-size: 8px;">MEMBER</span><br/><span style="font-size: 7px;">American Translators Association</span></div>'}
          </div>
        </div>
        <div style="width: 100%; height: 2px; background: #93c5fd; margin-bottom: 16px;"></div>

        <!-- Order Number - Only show if real order number exists -->
        ${orderNumber && !orderNumber.toLowerCase().includes('order0') && orderNumber !== 'P0000' ? `
        <div style="text-align: right; margin-bottom: 24px; font-size: 14px;">
          <span>Order # </span><strong>${orderNumber}</strong>
        </div>
        ` : ''}

        <!-- Main Title -->
        <h1 style="text-align: center; font-size: 24px; font-weight: normal; margin-bottom: 24px; color: #1a365d;">${certTitle}</h1>

        <!-- Translation of ... -->
        <p style="text-align: center; margin-bottom: 24px; font-size: 14px;">
          Translation of <strong>${documentType}</strong> from<br/>
          <strong>${sourceLanguage}</strong> to <strong>${targetLanguage}</strong>
        </p>

        <!-- Body paragraphs -->
        ${templateParagraphs.map(para => {
          const processed = para
            .replace(/\{\{sourceLanguage\}\}/g, sourceLanguage)
            .replace(/\{\{targetLanguage\}\}/g, targetLanguage);
          return `<p style="text-align: justify; margin-bottom: 16px; font-size: 12px; line-height: 1.6;">${processed}</p>`;
        }).join('')}

        <!-- Signature and Stamp Section -->
        <div style="margin-top: 32px; display: flex; justify-content: space-between; align-items: flex-end;">
          <div>
            ${signatureImage
              ? `<img src="${signatureImage}" alt="Signature" style="height: 60px; max-width: 200px; margin-bottom: 8px;" />`
              : `<div style="font-family: cursive; font-size: 28px; color: #1a365d; margin-bottom: 8px;">Beatriz Paiva</div>`}
            <div style="font-size: 14px; font-style: italic; font-weight: bold; color: #1a365d;">Beatriz Paiva</div>
            <div style="font-size: 14px; color: #333;">Authorized Representative</div>
            <div style="font-size: 14px; color: #333;">Legacy Translations Inc.</div>
            <div style="font-size: 14px; color: #666; margin-top: 4px;">Dated: ${new Date().toLocaleDateString('en-US', { timeZone: 'America/New_York' })}</div>
          </div>
          <div style="text-align: center;">
            ${logoStamp
              ? `<img src="${logoStamp}" alt="Stamp" style="width: 112px; height: 112px; object-fit: contain;" />`
              : `<div style="width: 112px; height: 112px; border-radius: 50%; border: 4px double #2563eb; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px;">
                  <div style="font-size: 8px; color: #2563eb; font-weight: bold;">CERTIFIED TRANSLATOR</div>
                  <div style="font-size: 10px; color: #2563eb; font-weight: bold; margin-top: 4px;">LEGACY TRANSLATIONS</div>
                  <div style="font-size: 8px; color: #2563eb;">ATA # 275993</div>
                </div>`}
          </div>
        </div>
      </div>
    `;

    const fullHTML = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Certificate_${orderNumber || 'P0000'}_${documentType.replace(/\s+/g, '_')}</title>
    <style>
        @page { size: Letter; margin: 0.5in; }
        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
        body { margin: 0; padding: 0; }
    </style>
</head>
<body>
    ${certificateHTML}
</body>
</html>`;

    // Open in new window for printing/saving as PDF
    const printWindow = window.open('', '_blank');
    printWindow.document.write(fullHTML);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
  };

  // Download certificate
  const handleDownload = async (format = 'html') => {
    // Save TM if enabled
    if (saveToTM) {
      saveTranslationMemory();
    }

    // Create certification if enabled
    let certData = certificationData;
    if (includeCertification && !certData) {
      certData = await createCertification();
    }

    // Use saved translator name from database if available, otherwise fall back to UI selection
    const translatorNameForCert = savedTranslatorName || selectedTranslator;
    const translator = TRANSLATORS.find(t => t.name === translatorNameForCert);
    const pageSizeCSS = pageFormat === 'a4' ? 'A4' : 'Letter';
    const certTitle = translationType === 'sworn' ? 'Sworn Translation Certificate' : 'Certification of Translation Accuracy';

    // Check if selected template is a form (like RMV Foreign DL)
    const isFormTemplate = CERTIFICATE_TEMPLATES[selectedCertificateTemplate]?.isForm;

    // Cover Letter HTML - MATCHING START PREVIEW EXACTLY
    const coverLetterHTML = isFormTemplate ? `
    <div style="font-family: Georgia, 'Times New Roman', serif; padding: 20px; page-break-after: always;">
        ${CERTIFICATE_TEMPLATES[selectedCertificateTemplate].formHTML}
    </div>` : `
    <div style="font-family: Georgia, 'Times New Roman', serif; font-size: 12px; line-height: 1.6; max-width: 100%; padding: 0; page-break-after: always;">

        <!-- HEADER - Using fixed widths like START preview -->
        <div style="width: 100%; margin-bottom: 8px; overflow: hidden;">
            <div style="float: left; width: 128px;">
                ${logoLeft
                  ? `<img src="${logoLeft}" alt="Logo" style="max-height: 48px; max-width: 120px;" />`
                  : `<div style="font-size: 10px; color: #2563eb; font-weight: bold;">LEGACY<br/><span style="font-weight: normal; font-size: 8px;">TRANSLATIONS</span></div>`}
            </div>
            <div style="float: right; width: 80px; text-align: right;">
                ${logoRight
                  ? `<img src="${logoRight}" alt="ATA" style="max-height: 40px; max-width: 75px;" />`
                  : `<div style="font-size: 9px; color: #666; font-style: italic;">ata<br/><span style="font-size: 8px;">MEMBER</span><br/><span style="font-size: 7px;">American Translators Association</span></div>`}
            </div>
            <div style="margin-left: 138px; margin-right: 90px; text-align: center;">
                <div style="font-weight: bold; color: #2563eb; font-size: 14px; font-style: italic;">Legacy Translations</div>
                <div style="font-size: 9px; color: #666;">867 Boylston Street ¬∑ 5th Floor ¬∑ #2073 ¬∑ Boston, MA ¬∑ 02116</div>
                <div style="font-size: 9px; color: #666;">(857) 316-7770 ¬∑ contact@legacytranslations.com</div>
            </div>
        </div>

        <!-- Blue line -->
        <div style="clear: both; width: 100%; height: 2px; background: #93c5fd; margin-bottom: 16px;"></div>

        <!-- Order Number -->
        ${orderNumber && !orderNumber.toLowerCase().includes('order0') && orderNumber !== 'P0000'
          ? `<div style="text-align: right; margin-bottom: 24px; font-size: 14px;">Order # <strong>${orderNumber}</strong></div>`
          : '<div style="margin-bottom: 24px;"></div>'}

        <!-- Main Title -->
        <h1 style="text-align: center; font-size: 24px; font-weight: normal; margin-bottom: 30px; color: #1a365d; letter-spacing: 0.5px;">${certTitle}</h1>

        <!-- Translation of... -->
        <p style="text-align: center; margin-bottom: 30px; font-size: 14px; line-height: 1.8;">
            Translation of a <strong>${documentType}</strong> from <strong>${sourceLanguage}</strong> to<br/>
            <strong>${targetLanguage}</strong>
        </p>

        <!-- Body Paragraphs -->
        ${(() => {
          let templateParagraphs;
          if (selectedCertificateTemplate.startsWith('custom-')) {
            const customTemplate = customCertificateTemplates.find(t => `custom-${t.id}` === selectedCertificateTemplate);
            templateParagraphs = customTemplate?.bodyParagraphs || CERTIFICATE_TEMPLATES['default'].bodyParagraphs;
          } else {
            templateParagraphs = CERTIFICATE_TEMPLATES[selectedCertificateTemplate]?.bodyParagraphs || CERTIFICATE_TEMPLATES['default'].bodyParagraphs;
          }
          return templateParagraphs.map(p => {
            const processed = p.replace(/\{\{sourceLanguage\}\}/g, sourceLanguage).replace(/\{\{targetLanguage\}\}/g, targetLanguage);
            return `<p style="text-align: justify; margin-bottom: 16px; line-height: 1.8; font-size: 12px;">${processed}</p>`;
          }).join('\n        ');
        })()}

        <!-- Signature Section -->
        <div style="margin-top: 60px; overflow: hidden;">
            <div style="float: left; width: 60%;">
                ${signatureImage
                  ? `<img src="${signatureImage}" alt="Signature" style="max-height: 40px; max-width: 180px; margin-bottom: 4px;" />`
                  : `<div style="font-family: 'Brush Script MT', cursive; font-size: 24px; color: #1a365d; margin-bottom: 4px;">Beatriz Paiva</div>`}
                <div style="font-weight: bold; font-size: 12px;">Authorized Representative</div>
                <div style="font-size: 12px;">Legacy Translations Inc.</div>
                <div style="font-size: 12px; margin-top: 8px;">Dated: ${translationDate}</div>
            </div>
            <div style="float: right; width: 35%; text-align: right;">
                ${logoStamp
                  ? `<img src="${logoStamp}" alt="Stamp" style="width: 120px; height: 120px; object-fit: contain;" />`
                  : `<div style="width: 120px; height: 120px; border: 4px double #2563eb; border-radius: 50%; margin-left: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px;">
                      <div style="font-size: 7px; font-weight: bold; color: #2563eb;">CERTIFIED TRANSLATOR</div>
                      <div style="font-size: 9px; font-weight: bold; color: #2563eb; margin-top: 4px;">LEGACY TRANSLATIONS</div>
                      <div style="font-size: 7px; color: #2563eb;">ATA # 275993</div>
                    </div>`}
            </div>
        </div>
    </div>`;

    // Letterhead for all pages - Same style as cover
    const letterheadHTML = `
        <div style="width: 100%; margin-bottom: 8px; padding-bottom: 4px; overflow: hidden;">
            <div style="float: left; width: 128px;">
                ${logoLeft
                  ? `<img src="${logoLeft}" alt="Logo" style="max-height: 48px; max-width: 120px;" />`
                  : `<div style="font-size: 10px; color: #2563eb; font-weight: bold;">LEGACY<br/><span style="font-weight: normal; font-size: 8px;">TRANSLATIONS</span></div>`}
            </div>
            <div style="float: right; width: 80px; text-align: right;">
                ${logoRight
                  ? `<img src="${logoRight}" alt="ATA" style="max-height: 40px; max-width: 75px;" />`
                  : `<div style="font-size: 9px; color: #666; font-style: italic;">ata<br/><span style="font-size: 8px;">MEMBER</span></div>`}
            </div>
            <div style="margin-left: 138px; margin-right: 90px; text-align: center;">
                <div style="font-weight: bold; color: #2563eb; font-size: 14px; font-style: italic;">Legacy Translations</div>
                <div style="font-size: 9px; color: #666;">867 Boylston Street ¬∑ 5th Floor ¬∑ #2073 ¬∑ Boston, MA ¬∑ 02116</div>
                <div style="font-size: 9px; color: #666;">(857) 316-7770 ¬∑ contact@legacytranslations.com</div>
            </div>
        </div>
        <div style="clear: both; width: 100%; height: 2px; background: #93c5fd; margin-bottom: 16px;"></div>`;

    // Translation pages HTML (with or without letterhead)
    // Uses table+thead so letterhead repeats on every printed page when content overflows
    // First page doesn't need page-break since cover ends with one
    const translationPagesHTML = translationResults.map((result, index) => `
    <div style="${index > 0 ? 'page-break-before: always;' : ''} padding-top: 5px;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr><td style="border: none; padding: 0; font-size: inherit;">
                    ${includeLetterhead ? letterheadHTML : ''}
                </td></tr>
            </thead>
            <tbody>
                <tr><td style="border: none; padding: 0; line-height: 1.5; font-size: 11pt;">
                    ${result.translatedText}
                </td></tr>
            </tbody>
        </table>
    </div>
    `).join('');

    // Certification verification page HTML - ALL INLINE STYLES
    const certificationPageHTML = (includeCertification && certData) ? `
    <div style="page-break-before: always; padding-top: 10px;">
        ${includeLetterhead ? letterheadHTML : ''}

        <div style="max-width: 520px; margin: 25px auto; padding: 28px; border: 2px solid #2563eb; border-radius: 12px; background: #f8fafc; font-family: Georgia, 'Times New Roman', serif;">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 25px;">
                <div style="font-size: 40px; margin-bottom: 10px;">üîê</div>
                <h2 style="font-size: 20px; font-weight: bold; color: #1e40af; margin-bottom: 5px;">Document Verification</h2>
                <p style="font-size: 12px; color: #64748b;">This certified translation can be verified online</p>
            </div>

            <!-- Content: Info + QR side by side -->
            <div style="overflow: hidden; margin-bottom: 20px;">
                <div style="float: left; width: 55%;">
                    <div style="padding: 8px 0; border-bottom: 1px solid #e2e8f0; overflow: hidden;">
                        <span style="float: left; font-size: 11px; color: #64748b;">Certification ID:</span>
                        <span style="float: right; font-size: 11px; font-weight: 600; color: #2563eb; font-family: monospace;">${certData.certification_id}</span>
                    </div>
                    <div style="padding: 8px 0; border-bottom: 1px solid #e2e8f0; overflow: hidden;">
                        <span style="float: left; font-size: 11px; color: #64748b;">Document Type:</span>
                        <span style="float: right; font-size: 11px; font-weight: 600; color: #1e293b;">${documentType}</span>
                    </div>
                    <div style="padding: 8px 0; border-bottom: 1px solid #e2e8f0; overflow: hidden;">
                        <span style="float: left; font-size: 11px; color: #64748b;">Translation:</span>
                        <span style="float: right; font-size: 11px; font-weight: 600; color: #1e293b;">${sourceLanguage} ‚Üí ${targetLanguage}</span>
                    </div>
                    <div style="padding: 8px 0; border-bottom: 1px solid #e2e8f0; overflow: hidden;">
                        <span style="float: left; font-size: 11px; color: #64748b;">Certified Date:</span>
                        <span style="float: right; font-size: 11px; font-weight: 600; color: #1e293b;">${new Date(certData.certified_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                    </div>
                    <div style="padding: 8px 0; border-bottom: 1px solid #e2e8f0; overflow: hidden;">
                        <span style="float: left; font-size: 11px; color: #64748b;">Document Hash:</span>
                        <span style="float: right; font-size: 10px; font-weight: 600; color: #1e293b; font-family: monospace;">${certData.document_hash?.substring(0, 16)}...</span>
                    </div>
                </div>
                <div style="float: right; width: 40%; text-align: center; padding-left: 15px;">
                    ${certData.qr_code_data
                      ? `<img src="data:image/png;base64,${certData.qr_code_data}" alt="QR Code" style="width: 120px; height: 120px; border: 1px solid #e2e8f0; border-radius: 8px;" />`
                      : '<div style="width: 120px; height: 120px; border: 1px solid #e2e8f0; border-radius: 8px; margin: 0 auto; color: #999; text-align: center; line-height: 120px;">QR Code</div>'}
                    <p style="font-size: 10px; color: #64748b; margin-top: 5px;">Scan to verify</p>
                </div>
            </div>

            <!-- Footer -->
            <div style="clear: both; text-align: center; padding-top: 20px; border-top: 1px solid #e2e8f0; margin-top: 10px;">
                <p style="font-size: 11px; color: #1e40af; margin-bottom: 10px;">Verify at: <strong>${certData.verification_url}</strong></p>
                <p style="font-size: 9px; color: #64748b; line-height: 1.4;">This document has been digitally certified by Legacy Translations Inc. Any alterations to this document will invalidate this certification.</p>
            </div>
        </div>
    </div>
    ` : '';

    // Original documents pages HTML (each image on separate page, title only on first)
    const originalPagesHTML = (includeOriginal && originalImages.length > 0) ? originalImages.map((img, index) => `
    <div style="page-break-before: always; padding-top: 5px;">
        ${includeLetterhead ? letterheadHTML : ''}
        ${index === 0 ? '<div style="font-size: 13px; font-weight: bold; text-align: center; margin: 8px 0; color: #1a365d; text-transform: uppercase; letter-spacing: 2px;">Original Document</div>' : ''}
        <div style="text-align: center;">
            <img src="${img.data}" alt="${img.filename}" style="width: 100%; max-height: 8.5in; object-fit: contain; display: block; margin: 0 auto;" />
        </div>
    </div>
    `).join('') : '';

    // Use UNIFIED styles (same as Quick Package)
    const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>${orderNumber || 'P0000'}_${documentType.replace(/\s+/g, '_')}_${translationType === 'sworn' ? 'Sworn' : 'Certified'}_Translation</title>
    <style>
        ${getUnifiedPdfStyles(pageSizeCSS)}
    </style>
</head>
<body>
    ${includeCover ? coverLetterHTML : ''}
    ${translationPagesHTML}
    ${originalPagesHTML}
    ${certificationPageHTML}
</body>
</html>`;

    if (format === 'pdf') {
      // Generate PDF with hash tracking for verification
      try {
        const filename = `${orderNumber || 'P0000'}_${documentType.replace(/\s+/g, '_')}_${translationType === 'sworn' ? 'Sworn' : 'Certified'}_Translation.pdf`;

        const { blob: pdfBlob, hash: pdfHash } = await generatePdfWithHash(htmlContent, filename, {
          margin: [5, 5, 5, 5],
          image: { type: 'jpeg', quality: 0.95 },
          html2canvas: { scale: 2, useCORS: true, allowTaint: true },
          jsPDF: { unit: 'mm', format: pageFormat === 'a4' ? 'a4' : 'letter', orientation: 'portrait' }
        });

        // Update PDF hash in backend if we have a certification
        // CRITICAL: This enables digital signature verification
        if (certData?.certification_id) {
          const hashResult = await updatePdfHashInBackend(certData.certification_id, pdfHash, adminKey);
          if (!hashResult.success) {
            console.error('Warning: PDF hash not saved. Verification may not work:', hashResult.error);
          }
        }

        // Download the PDF
        const downloadUrl = URL.createObjectURL(pdfBlob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(downloadUrl);
      } catch (err) {
        console.error('Error generating PDF:', err);
        showToast('Error generating PDF. Please try again.');
      }
    } else {
      // Download as HTML
      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${orderNumber || 'P0000'}_${documentType.replace(/\s+/g, '_')}_${translationType === 'sworn' ? 'Sworn' : 'Certified'}_Translation.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  };

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col">
      {/* Top header bar */}
      <div className="bg-slate-800 text-white flex items-center justify-between px-4 py-2 text-xs">
        <div className="flex items-center space-x-3">
          <div className="flex items-center space-x-2">
            <div className="w-8 h-8 bg-blue-500 rounded flex items-center justify-center text-sm">üåê</div>
            <div>
              <div className="font-bold text-sm">Legacy Admin</div>
            </div>
          </div>
        </div>
        <div className="flex items-center px-3 py-1.5 rounded bg-blue-600 text-white">
          <span className="mr-1.5">‚úçÔ∏è</span>
          <span>Translation</span>
        </div>
        <div className="flex items-center space-x-3">
          {user && (
            <div className="flex items-center space-x-2">
              <div className={`px-3 py-1 ${user?.role === 'admin' ? 'bg-red-500' : user?.role === 'pm' ? 'bg-blue-500' : 'bg-green-500'} rounded text-[10px] font-medium text-center`}>
                {user?.role === 'admin' ? 'Administrator' : user?.role === 'pm' ? 'Project Manager' : 'Translator'}
              </div>
              {user.name && (
                <span className="text-white text-[11px]">
                  Welcome, {user.name.split(' ')[0]}
                </span>
              )}
            </div>
          )}
          {onBack && (
            <button
              onClick={onBack}
              className="px-3 py-1.5 text-slate-300 hover:bg-slate-700 rounded text-xs"
            >
              ‚Üê Back to Projects
            </button>
          )}
        </div>
      </div>

      {/* Main content area */}
      <div className="flex-1 overflow-auto p-4">
      {/* Header with order info and back button */}
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center space-x-4">
          <h1 className="text-lg font-bold text-blue-600">TRANSLATION WORKSPACE</h1>
          {/* Auto-save indicator */}
          {(originalImages.length > 0 || translationResults.length > 0) && (
            <div className={`flex items-center gap-1 px-2 py-1 rounded-full text-[10px] ${
              hasUnsavedChanges
                ? 'bg-yellow-100 text-yellow-700 border border-yellow-300'
                : 'bg-green-100 text-green-700 border border-green-300'
            }`}>
              {hasUnsavedChanges ? (
                <>
                  <span className="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></span>
                  <span>Unsaved changes</span>
                </>
              ) : (
                <>
                  <span>‚úì</span>
                  <span>Auto-saved {lastSavedTime ? lastSavedTime.toLocaleTimeString() : ''}</span>
                </>
              )}
            </div>
          )}
          {selectedOrder && (
            <div className="relative group project-menu-container">
              <button
                className="flex items-center space-x-2 px-3 py-1.5 bg-gradient-to-r from-blue-50 to-purple-50 rounded-full border border-blue-200 hover:border-blue-400 hover:shadow-md transition-all cursor-pointer"
                onClick={() => setShowProjectMenu(!showProjectMenu)}
              >
                <span className="text-blue-600 text-xs font-bold">üìã {selectedOrder.order_number}</span>
                <span className="text-gray-400">|</span>
                <span className="text-gray-600 text-xs">{selectedOrder.client_name}</span>
                <span className="text-gray-400">|</span>
                <span className="text-xs text-gray-500">{selectedOrder.translate_from} ‚Üí {selectedOrder.translate_to}</span>
                <span className="text-gray-400 ml-1">‚ñº</span>
              </button>

              {/* Dropdown Menu */}
              {showProjectMenu && (
                <div className="absolute top-full left-0 mt-1 w-64 bg-white rounded-lg shadow-xl border border-gray-200 z-50 overflow-hidden">
                  <div className="p-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                    <div className="font-bold text-sm">{selectedOrder.order_number}</div>
                    <div className="text-xs opacity-80">{selectedOrder.client_name}</div>
                  </div>

                  <div className="p-1">
                    {/* Load Document */}
                    <button
                      onClick={() => {
                        setShowProjectMenu(false);
                        setActiveSubTab('start');
                      }}
                      className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded transition-colors"
                    >
                      <span className="text-lg">üìÇ</span>
                      <div className="text-left">
                        <div className="font-medium">Open Documents</div>
                        <div className="text-[10px] text-gray-500">View project files</div>
                      </div>
                    </button>

                    {/* Translate */}
                    <button
                      onClick={() => {
                        setShowProjectMenu(false);
                        setActiveSubTab('translate');
                      }}
                      className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-yellow-50 rounded transition-colors"
                    >
                      <span className="text-lg">üìÑ</span>
                      <div className="text-left">
                        <div className="font-medium">Translate Document</div>
                        <div className="text-[10px] text-gray-500">OCR and manual translation</div>
                      </div>
                    </button>

                    {/* Review - highlighted if translation ready */}
                    <button
                      onClick={async () => {
                        setShowProjectMenu(false);
                        if (selectedOrder.translation_ready || selectedOrder.translation_html) {
                          await loadSavedTranslation(selectedOrder);
                        }
                        setActiveSubTab('review');
                      }}
                      className={`w-full flex items-center gap-2 px-3 py-2 text-sm rounded transition-colors ${
                        selectedOrder.translation_ready || selectedOrder.translation_html
                          ? 'bg-green-100 text-green-700 hover:bg-green-200 border border-green-300'
                          : 'text-gray-700 hover:bg-green-50'
                      }`}
                    >
                      <span className="text-lg">üîç</span>
                      <div className="text-left">
                        <div className="font-medium">
                          {selectedOrder.translation_ready ? '‚úÖ Review Translation' : 'Review'}
                        </div>
                        <div className="text-[10px] text-gray-500">
                          {selectedOrder.translation_ready ? 'Translation ready for review' : 'Review and approve'}
                        </div>
                      </div>
                    </button>

                    {/* Deliver */}
                    <button
                      onClick={() => {
                        setShowProjectMenu(false);
                        setActiveSubTab('deliver');
                      }}
                      className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded transition-colors"
                    >
                      <span className="text-lg">‚úÖ</span>
                      <div className="text-left">
                        <div className="font-medium">Entregar ao Cliente</div>
                        <div className="text-[10px] text-gray-500">Finalize and send</div>
                      </div>
                    </button>
                  </div>

                  <div className="border-t border-gray-100 p-1">
                    <div className="px-3 py-2 text-[10px] text-gray-400">
                      Status: <span className="font-medium">{selectedOrder.translation_status || 'received'}</span>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
        {onBack && (
          <button
            onClick={onBack}
            className="px-3 py-1.5 bg-gray-100 text-gray-700 text-xs rounded hover:bg-gray-200 flex items-center"
          >
            <span className="mr-1">‚Üê</span> Back to Projects
          </button>
        )}
      </div>

      {/* Sub-tabs */}
      {/* Translator access: IN_HOUSE = ALL TABS (except REVIEW - merged into TRANSLATION) | CONTRACTOR = START, TRANSLATE, REVIEW, DELIVER */}
      <div className="flex space-x-1 mb-4 border-b overflow-x-auto">
        {[
          { id: 'start', label: 'START', icon: 'üìù', roles: ['admin', 'pm', 'translator'] },
          { id: 'translate', label: 'TRANSLATION', icon: 'üìÑ', roles: ['admin', 'pm', 'translator'] },
          { id: 'review', label: 'REVIEW', icon: 'üìã', roles: ['admin', 'pm', 'translator_contractor'] }, // Hidden for in-house - merged into TRANSLATION
          { id: 'proofreading', label: 'PROOFREADING', icon: 'üîç', roles: ['admin', 'pm', 'translator_inhouse'] },
          { id: 'deliver', label: 'DELIVER', icon: '‚úÖ', roles: ['admin', 'pm', 'translator_inhouse', 'translator_contractor'] }, // Admin, PM, In-house and Contractor
          { id: 'glossaries', label: 'GLOSSARIES', icon: 'üåê', roles: ['admin', 'pm', 'translator_inhouse'] },
          { id: 'tm', label: 'TM', icon: 'üß†', roles: ['admin', 'pm', 'translator_inhouse'] },
          { id: 'instructions', label: 'INSTRUCTIONS', icon: 'üìã', roles: ['admin', 'pm', 'translator_inhouse'] }
        ].filter(tab => {
          const userRole = user?.role || 'translator';
          // For translators, check translator_type for extended access
          if (userRole === 'translator' && user?.translator_type === 'in_house') {
            // In-house translators get access to tabs marked with 'translator_inhouse'
            // But NOT 'translator_contractor' (like REVIEW which is merged into TRANSLATION)
            return tab.roles.includes('translator_inhouse') || (tab.roles.includes('translator') && !tab.roles.includes('translator_contractor'));
          }
          // Contractors get basic translator tabs
          if (userRole === 'translator') {
            return tab.roles.includes('translator') || tab.roles.includes('translator_contractor');
          }
          return tab.roles.includes(userRole);
        }).map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveSubTab(tab.id)}
            className={`px-4 py-2 text-xs font-medium rounded-t relative ${
              activeSubTab === tab.id
                ? 'bg-blue-600 text-white'
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            }`}
          >
            {tab.icon} {tab.label}
          </button>
        ))}
      </div>

      {/* START TAB - Combined Setup & Cover Letter */}
      {activeSubTab === 'start' && (
        <div className="space-y-3">
          {/* Processing Status Indicator */}
          {processingStatus && (
            <div className={`p-3 rounded-lg text-sm font-medium animate-pulse ${
              processingStatus.includes('‚ùå') ? 'bg-red-100 text-red-700 border border-red-300' :
              processingStatus.includes('‚úÖ') ? 'bg-green-100 text-green-700 border border-green-300' :
              'bg-blue-100 text-blue-700 border border-blue-300'
            }`}>
              {processingStatus}
            </div>
          )}

          {/* Upload Document Section - Compact */}
          <div className="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-3">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-sm font-bold text-green-800">üì§ Upload Document to Translate</h3>
              <span className="text-[10px] text-green-600">PDF, Images, Word (.docx)</span>
            </div>

            <div className="border-2 border-dashed border-green-300 rounded-lg p-3 text-center hover:border-green-500 transition-colors">
              <input
                type="file"
                accept=".pdf,image/*,.docx,.doc"
                multiple
                onChange={async (e) => {
                  const files = Array.from(e.target.files);
                  if (files.length === 0) return;

                  setProcessingStatus('Processing uploaded files...');
                  const newImages = [];

                  for (const file of files) {
                    const fileName = file.name.toLowerCase();
                    try {
                      if (fileName.endsWith('.pdf')) {
                        // Convert PDF to images
                        setProcessingStatus(`Converting PDF: ${file.name}...`);
                        const images = await convertPdfToImages(file, (page, total) => {
                          setProcessingStatus(`Converting PDF page ${page}/${total}...`);
                        });
                        images.forEach((img, idx) => {
                          newImages.push({
                            data: `data:${img.type};base64,${img.data}`,
                            filename: `${file.name} - Page ${idx + 1}`,
                            type: img.type
                          });
                        });
                      } else if (file.type.startsWith('image/')) {
                        // Load image directly
                        const dataUrl = await new Promise((resolve) => {
                          const reader = new FileReader();
                          reader.onload = () => resolve(reader.result);
                          reader.readAsDataURL(file);
                        });
                        newImages.push({
                          data: dataUrl,
                          filename: file.name,
                          type: file.type
                        });
                      } else if (fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
                        // Convert Word to HTML and add to translation results
                        setProcessingStatus(`Converting Word: ${file.name}...`);
                        const html = await convertWordToHtml(file);
                        setTranslationResults(prev => [...prev, {
                          translatedText: '',
                          originalText: html,
                          filename: file.name
                        }]);
                      }
                    } catch (err) {
                      console.error('Upload error:', err);
                      setProcessingStatus(`Error processing: ${file.name}`);
                    }
                  }

                  if (newImages.length > 0) {
                    setOriginalImages(prev => [...prev, ...newImages]);
                    setProcessingStatus(`‚úÖ ${newImages.length} page(s) loaded! Go to TRANSLATION tab to translate.`);
                  } else if (translationResults.length > 0) {
                    setProcessingStatus(`‚úÖ Document loaded! Go to TRANSLATION tab to translate.`);
                  }

                  e.target.value = '';
                }}
                className="hidden"
                id="start-upload-docs"
              />
              <label htmlFor="start-upload-docs" className="cursor-pointer flex items-center justify-center gap-3">
                <span className="text-2xl">üìÑ</span>
                <span className="px-4 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 inline-block">
                  Choose Files
                </span>
              </label>
            </div>

            {/* Show loaded files list with delete option - Compact */}
            {(originalImages.length > 0 || translationResults.length > 0) && (
              <div className="mt-2 p-2 bg-green-100 rounded-lg">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-xs text-green-700 font-medium">
                    ‚úÖ {originalImages.length + translationResults.length} document(s) loaded
                  </span>
                  <div className="flex gap-2">
                    <button
                      onClick={() => {
                        if (window.confirm('Remove all files?')) {
                          setOriginalImages([]);
                          setTranslationResults([]);
                        }
                      }}
                      className="px-2 py-1 bg-red-500 text-white text-[10px] rounded hover:bg-red-600"
                    >
                      üóëÔ∏è Clear All
                    </button>
                    <button
                      onClick={() => setActiveSubTab('translate')}
                      className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                    >
                      Go to Translation ‚Üí
                    </button>
                  </div>
                </div>
                {/* File list */}
                <div className="max-h-32 overflow-y-auto space-y-1">
                  {originalImages.map((img, idx) => (
                    <div key={idx} className="flex items-center justify-between bg-white px-2 py-1 rounded text-xs">
                      <span className="truncate flex-1" title={img.filename}>
                        üìÑ {img.filename || `Page ${idx + 1}`}
                      </span>
                      <button
                        onClick={() => setOriginalImages(prev => prev.filter((_, i) => i !== idx))}
                        className="ml-2 px-1.5 py-0.5 bg-red-100 text-red-600 rounded hover:bg-red-200 text-[10px]"
                        title="Remove file"
                      >
                        ‚úï
                      </button>
                    </div>
                  ))}
                  {translationResults.map((result, idx) => (
                    <div key={`tr-${idx}`} className="flex items-center justify-between bg-white px-2 py-1 rounded text-xs">
                      <span className="truncate flex-1" title={result.filename}>
                        üìù {result.filename || `Document ${idx + 1}`}
                      </span>
                      <button
                        onClick={() => setTranslationResults(prev => prev.filter((_, i) => i !== idx))}
                        className="ml-2 px-1.5 py-0.5 bg-red-100 text-red-600 rounded hover:bg-red-200 text-[10px]"
                        title="Remove file"
                      >
                        ‚úï
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* Translator Messages Panel */}
          {user?.role === 'translator' && (
            <div className={`border rounded-lg p-4 ${translatorMessages.filter(m => !m.read).length > 0 ? 'bg-blue-50 border-blue-300' : 'bg-gray-50 border-gray-200'}`}>
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center">
                  <span className={`mr-2 text-xl ${translatorMessages.filter(m => !m.read).length > 0 ? 'text-blue-600' : 'text-gray-400'}`}>üí¨</span>
                  <span className={`text-sm font-bold ${translatorMessages.filter(m => !m.read).length > 0 ? 'text-blue-800' : 'text-gray-600'}`}>
                    {translatorMessages.filter(m => !m.read).length > 0
                      ? `${translatorMessages.filter(m => !m.read).length} New Message(s) from Admin/PM`
                      : 'Messages from Admin/PM'}
                  </span>
                </div>
                {translatorMessages.length > 0 && (
                  <button
                    onClick={() => setShowTranslatorMessages(!showTranslatorMessages)}
                    className="text-xs text-blue-600 hover:text-blue-800 px-2 py-1 bg-white rounded border border-blue-200"
                  >
                    {showTranslatorMessages ? 'Hide' : `View All (${translatorMessages.length})`}
                  </button>
                )}
              </div>
              {translatorMessages.filter(m => !m.read).length === 0 && !showTranslatorMessages && (
                <div className="text-xs text-gray-500 text-center py-2">
                  No new messages. Check back later for updates from Admin/PM.
                </div>
              )}
              {showTranslatorMessages && translatorMessages.length > 0 && (
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {translatorMessages.map((msg) => (
                    <div
                      key={msg.id}
                      className={`p-3 rounded border ${msg.read ? 'bg-gray-50 border-gray-200' : 'bg-white border-blue-200'}`}
                    >
                      <div className="flex justify-between items-start">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <span className={`font-medium text-sm ${msg.read ? 'text-gray-600' : 'text-blue-800'}`}>
                              From: {msg.from_admin_name}
                            </span>
                            {msg.order_number && (
                              <span className="text-[10px] px-1.5 py-0.5 bg-blue-100 text-blue-600 rounded">
                                {msg.order_number}
                              </span>
                            )}
                            {msg.read && (
                              <span className="text-[10px] px-1.5 py-0.5 bg-gray-100 text-gray-500 rounded">
                                Read
                              </span>
                            )}
                          </div>
                          <div className="text-sm text-gray-700 bg-gray-50 p-2 rounded mt-2">
                            {msg.content}
                          </div>
                          <div className="text-[10px] text-gray-400 mt-2">
                            {formatDateTimeLocal(msg.created_at)}
                          </div>
                        </div>
                      </div>
                      {!msg.read && (
                        <div className="flex justify-end mt-2 pt-2 border-t">
                          <button
                            onClick={() => markTranslatorMessageRead(msg.id)}
                            className="px-3 py-1 text-blue-600 border border-blue-200 rounded text-xs hover:bg-blue-50"
                          >
                            ‚úì Mark as read
                          </button>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* Assigned Projects/Files Section - For Translators and Admin */}
          {(user?.role === 'translator' || user?.role === 'admin') && (
            <div className={`bg-gradient-to-r ${user?.role === 'admin' ? 'from-blue-50 to-blue-100 border-blue-200' : 'from-blue-50 to-blue-100 border-blue-200'} border rounded-lg p-4`}>
              <div className="flex items-center justify-between mb-3">
                <h3 className={`text-sm font-bold ${user?.role === 'admin' ? 'text-blue-800' : 'text-blue-800'}`}>
                  {user?.role === 'admin' ? 'üëë Admin Translation' : 'üìã My Assigned Work'}
                </h3>
                <div className="flex items-center gap-2">
                  {/* Admin/PM: Add Document Button */}
                  {(isAdmin || isPM) && selectedOrderId && (
                    <label className="px-2 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded cursor-pointer transition-colors flex items-center gap-1" title="Add document to selected project">
                      ‚ûï Add
                      <input
                        type="file"
                        className="hidden"
                        accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                        multiple
                        onChange={(e) => {
                          if (e.target.files && e.target.files.length > 0) {
                            uploadDocumentsToOrder(selectedOrderId, Array.from(e.target.files));
                            e.target.value = '';
                          }
                        }}
                      />
                    </label>
                  )}
                  {/* View Mode Toggle */}
                  <div className="flex items-center gap-1 bg-white rounded-lg p-0.5 border">
                    <button
                      onClick={() => setViewMode('files')}
                      className={`px-3 py-1 text-xs rounded-md transition-all ${
                        viewMode === 'files'
                          ? 'bg-blue-600 text-white shadow'
                          : 'text-gray-600 hover:bg-gray-100'
                      }`}
                    >
                      üìÑ Files
                    </button>
                    <button
                      onClick={() => setViewMode('projects')}
                      className={`px-3 py-1 text-xs rounded-md transition-all ${
                        viewMode === 'projects'
                          ? 'bg-blue-600 text-white shadow'
                          : 'text-gray-600 hover:bg-gray-100'
                      }`}
                    >
                      üìÅ Projects
                    </button>
                  </div>
                </div>
              </div>

              {loadingAssigned ? (
                <div className="text-center py-4 text-gray-500 text-sm">Loading...</div>
              ) : viewMode === 'files' ? (
                /* FILES VIEW - Show individual files */
                allProjectFiles.length > 0 ? (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {allProjectFiles.map((file, idx) => (
                      <div
                        key={file.id || idx}
                        onClick={async () => {
                          // Set order context
                          const order = assignedOrders.find(o => o.id === file.order_id);
                          if (order) {
                            setSelectedOrderId(order.id);
                            setOrderNumber(order.order_number);
                            if (order.translate_from) setSourceLanguage(order.translate_from);
                            if (order.translate_to) setTargetLanguage(order.translate_to);
                          }
                          // Load this specific file
                          await loadProjectFile(file);
                        }}
                        className={`p-3 rounded-lg cursor-pointer transition-all border ${
                          selectedFileId === file.id
                            ? 'bg-blue-100 border-blue-500 shadow-md'
                            : 'bg-white border-gray-200 hover:border-blue-400 hover:shadow'
                        }`}
                      >
                        <div className="flex items-center justify-between mb-2">
                          <span className="font-bold text-blue-700 text-xs truncate max-w-[120px]" title={file.filename}>
                            {file.filename || 'Document'}
                          </span>
                          <span className={`text-[10px] px-2 py-0.5 rounded ${
                            file.file_status === 'pending' || file.file_status === 'received' ? 'bg-yellow-100 text-yellow-700' :
                            file.file_status === 'in_translation' ? 'bg-blue-100 text-blue-700' :
                            file.file_status === 'review' || file.file_status === 'pending_review' ? 'bg-purple-100 text-purple-700' :
                            file.file_status === 'completed' || file.file_status === 'ready' ? 'bg-green-100 text-green-700' :
                            'bg-gray-100 text-gray-700'
                          }`}>
                            {file.file_status === 'pending' || file.file_status === 'received' ? 'Pending' :
                             file.file_status === 'in_translation' ? 'Translating' :
                             file.file_status === 'review' || file.file_status === 'pending_review' ? 'Review' :
                             file.file_status === 'completed' || file.file_status === 'ready' ? 'Done' :
                             file.file_status}
                          </span>
                        </div>
                        <div className="text-[10px] text-gray-500 mb-1">
                          Project: <span className="font-medium text-blue-600">{file.order_number}</span>
                        </div>
                        <div className="text-xs text-gray-600">
                          {file.translate_from} ‚Üí {file.translate_to}
                        </div>
                        {(file.translator_deadline || file.deadline) && (
                          <div className="text-[10px] text-blue-600 mt-1">
                            ‚è∞ Due: {new Date(file.translator_deadline || file.deadline).toLocaleDateString('en-US', { timeZone: 'America/New_York' })}
                          </div>
                        )}
                        {file.internal_notes && (
                          <div className="text-[10px] text-sky-600 mt-1">
                            üìù Has instructions
                          </div>
                        )}
                        {selectedFileId === file.id && (
                          <div className="mt-2 text-[10px] text-blue-600 font-medium">‚úì File loaded</div>
                        )}
                        {/* Action buttons */}
                        <div className="mt-2 flex flex-wrap gap-1">
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              loadFileToWorkspace(file.id, file.filename);
                            }}
                            className="flex-1 px-2 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded flex items-center justify-center gap-1 transition-colors"
                            title="Load PDF/Image to workspace (PDF auto-converts to images)"
                          >
                            üì• Load
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              downloadProjectDocument(file.id, file.filename);
                            }}
                            className="px-2 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs rounded transition-colors flex items-center gap-1"
                            title={`Download original file: ${file.filename}`}
                          >
                            ‚¨áÔ∏è
                          </button>
                          {/* Admin/PM: Replace and Delete buttons */}
                          {(isAdmin || isPM) && (
                            <>
                              <label className="px-2 py-1.5 bg-yellow-500 hover:bg-yellow-600 text-white text-xs rounded cursor-pointer transition-colors flex items-center gap-1" title="Replace document">
                                üîÑ
                                <input
                                  type="file"
                                  className="hidden"
                                  accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                                  onChange={(e) => {
                                    e.stopPropagation();
                                    if (e.target.files[0]) {
                                      replaceOrderDocument(file.id, e.target.files[0], file.filename);
                                      e.target.value = '';
                                    }
                                  }}
                                  onClick={(e) => e.stopPropagation()}
                                />
                              </label>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  deleteOrderDocument(file.id, file.filename);
                                }}
                                className="px-2 py-1.5 bg-red-500 hover:bg-red-600 text-white text-xs rounded transition-colors flex items-center gap-1"
                                title="Delete document"
                              >
                                üóëÔ∏è
                              </button>
                            </>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-6 text-gray-500">
                    <div className="text-3xl mb-2">üì≠</div>
                    <p className="text-sm">No files found</p>
                    <p className="text-xs mt-1">Files from assigned projects will appear here</p>
                  </div>
                )
                /* Admin/PM: Add new document button */
              ) : (
                /* PROJECTS VIEW - Original behavior */
                assignedOrders.length > 0 ? (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {assignedOrders.map(order => {
                      // Check if translator (in-house or contractor) needs to accept this assignment first
                      const isPendingAcceptance = isTranslator && order.translator_assignment_status === 'pending';

                      return (
                        <div
                          key={order.id}
                          onClick={() => {
                            if (isPendingAcceptance) {
                              showToast('‚ö†Ô∏è Please accept this assignment first!\n\nCheck your email for the assignment notification and click "Accept" to start working on this project.');
                              return;
                            }
                            selectProject(order);
                          }}
                          className={`p-3 rounded-lg transition-all border ${
                            isPendingAcceptance
                              ? 'bg-yellow-50 border-yellow-400 cursor-not-allowed opacity-80'
                              : selectedOrderId === order.id
                                ? 'bg-blue-100 border-blue-500 shadow-md cursor-pointer'
                                : 'bg-white border-gray-200 hover:border-blue-400 hover:shadow cursor-pointer'
                          }`}
                        >
                          {/* Pending acceptance banner for contractors */}
                          {isPendingAcceptance && (
                            <div className="bg-yellow-100 border border-yellow-300 rounded px-2 py-1 mb-2 text-center">
                              <span className="text-[10px] text-yellow-800 font-medium">
                                ‚ö†Ô∏è Accept via email to start
                              </span>
                            </div>
                          )}
                          <div className="flex items-center justify-between mb-2">
                            <span className="font-bold text-blue-700 text-sm">{order.order_number}</span>
                            <span className={`text-[10px] px-2 py-0.5 rounded ${
                              order.translation_status === 'received' ? 'bg-yellow-100 text-yellow-700' :
                              order.translation_status === 'in_translation' ? 'bg-blue-100 text-blue-700' :
                              order.translation_status === 'review' ? 'bg-blue-100 text-blue-700' :
                              'bg-gray-100 text-gray-700'
                            }`}>
                              {order.translation_status}
                            </span>
                          </div>
                          <div className="text-xs text-gray-600 mb-1">
                            {order.translate_from} ‚Üí {order.translate_to}
                          </div>
                          <div className="text-xs text-gray-500">
                            {order.document_type || 'Document'} ‚Ä¢ {order.page_count || 1} page(s)
                          </div>
                          {(order.translator_deadline || order.deadline) && (
                            <div className="text-[10px] text-blue-600 mt-1">
                              ‚è∞ Due: {new Date(order.translator_deadline || order.deadline).toLocaleDateString('en-US', { timeZone: 'America/New_York' })}
                            </div>
                          )}
                          {order.internal_notes && (
                            <div className="text-[10px] text-sky-600 mt-1">
                              üìù Has instructions from PM
                            </div>
                          )}
                          {!isPendingAcceptance && selectedOrderId === order.id && (
                            <div className="mt-2 text-[10px] text-blue-600 font-medium">‚úì Project selected</div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                ) : (
                  <div className="text-center py-6 text-gray-500">
                    <div className="text-3xl mb-2">üì≠</div>
                    <p className="text-sm">No projects assigned yet</p>
                    <p className="text-xs mt-1">{user?.role === 'admin' ? 'Use "Assign to Me" button in Projects to assign projects to yourself' : 'Wait for project assignment by PM'}</p>
                  </div>
                )
              )}
            </div>
          )}

          {/* PM Instructions - Show when project is selected and has internal notes */}
          {selectedOrderId && assignedOrders.find(o => o.id === selectedOrderId)?.internal_notes && (
            <div className="bg-sky-50 border border-sky-300 rounded-lg p-4">
              <div className="flex items-start gap-3">
                <div className="text-2xl">üìù</div>
                <div className="flex-1">
                  <h3 className="text-sm font-bold text-sky-800 mb-2">Instructions from PM</h3>
                  <p className="text-sm text-gray-700 whitespace-pre-wrap">
                    {assignedOrders.find(o => o.id === selectedOrderId)?.internal_notes}
                  </p>
                </div>
              </div>
            </div>
          )}

          {/* Project Files Download Section - Show when project is selected */}
          {selectedOrderId && viewMode === 'projects' && (
            <div className="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-sm font-bold text-gray-800 flex items-center gap-2">
                  üìÇ Project Files
                </h3>
                {/* Admin/PM: Add new document button */}
                {(isAdmin || isPM) && (
                  <label className="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded cursor-pointer transition-colors flex items-center gap-1" title="Add new document">
                    ‚ûï Add Document
                    <input
                      type="file"
                      className="hidden"
                      accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                      multiple
                      onChange={(e) => {
                        if (e.target.files && e.target.files.length > 0) {
                          uploadDocumentsToOrder(selectedOrderId, Array.from(e.target.files));
                          e.target.value = '';
                        }
                      }}
                    />
                  </label>
                )}
              </div>
              {allProjectFiles.filter(f => f.order_id === selectedOrderId).length > 0 ? (
                <div className="space-y-2">
                  {allProjectFiles.filter(f => f.order_id === selectedOrderId).map((file, idx) => (
                    <div key={file.id || idx} className="flex items-center justify-between p-2 bg-gray-50 rounded border">
                      <div className="flex-1 min-w-0">
                        <span className="text-sm font-medium text-gray-700 truncate block" title={file.filename}>
                          {file.filename || 'Document'}
                        </span>
                        <span className={`text-[10px] px-1.5 py-0.5 rounded ${
                          file.file_status === 'pending' || file.file_status === 'received' ? 'bg-yellow-100 text-yellow-700' :
                          file.file_status === 'in_translation' ? 'bg-blue-100 text-blue-700' :
                          file.file_status === 'completed' || file.file_status === 'ready' ? 'bg-green-100 text-green-700' :
                          'bg-gray-100 text-gray-700'
                        }`}>
                          {file.file_status}
                        </span>
                      </div>
                      <div className="flex gap-1 ml-3">
                        <button
                          onClick={() => loadFileToWorkspace(file.id, file.filename)}
                          className="px-2 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded flex items-center gap-1 transition-colors"
                          title="Load PDF/Image to workspace (PDF auto-converts to images)"
                        >
                          üì• Load
                        </button>
                        <button
                          onClick={() => downloadProjectDocument(file.id, file.filename)}
                          className="px-2 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs rounded transition-colors flex items-center gap-1"
                          title={`Download original file: ${file.filename}`}
                        >
                          ‚¨áÔ∏è
                        </button>
                        {/* Admin/PM: Replace and Delete buttons */}
                        {(isAdmin || isPM) && (
                          <>
                            <label className="px-2 py-1.5 bg-yellow-500 hover:bg-yellow-600 text-white text-xs rounded cursor-pointer transition-colors flex items-center gap-1" title="Replace document">
                              üîÑ
                              <input
                                type="file"
                                className="hidden"
                                accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                                onChange={(e) => {
                                  if (e.target.files[0]) {
                                    replaceOrderDocument(file.id, e.target.files[0], file.filename);
                                    e.target.value = '';
                                  }
                                }}
                              />
                            </label>
                            <button
                              onClick={() => deleteOrderDocument(file.id, file.filename)}
                              className="px-2 py-1.5 bg-red-500 hover:bg-red-600 text-white text-xs rounded transition-colors flex items-center gap-1"
                              title="Delete document"
                            >
                              üóëÔ∏è
                            </button>
                          </>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-sm text-gray-500">No files found for this project.</p>
              )}
            </div>
          )}

          {/* Quick Start Guide - Compact */}
          <div className="bg-blue-50 border border-blue-200 rounded px-3 py-1.5">
            <p className="text-[10px] text-blue-700">
              <strong>Workflow:</strong> {isInHouseTranslator
                ? 'START ‚Üí TRANSLATE (edit) ‚Üí PROOFREADING ‚Üí DELIVER'
                : isAdmin || isPM
                  ? 'START ‚Üí TRANSLATE ‚Üí REVIEW ‚Üí PROOFREADING ‚Üí DELIVER'
                  : 'START ‚Üí TRANSLATE ‚Üí REVIEW ‚Üí DELIVER'}
            </p>
          </div>

          {/* Translation Direction - Compact inline */}
          <div className="bg-white rounded shadow p-2 flex items-center gap-2">
            <span className="text-xs font-bold text-blue-700">üåê</span>
            <select
              value={sourceLanguage}
              onChange={(e) => setSourceLanguage(e.target.value)}
              className="px-2 py-1 text-xs border rounded font-medium flex-1"
            >
              {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
            </select>
            <span className="text-lg text-blue-500">‚Üí</span>
            <select
              value={targetLanguage}
              onChange={(e) => setTargetLanguage(e.target.value)}
              className="px-2 py-1 text-xs border rounded font-medium flex-1"
            >
              {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
            </select>
          </div>

          {/* Document Type - Expandable */}
          <div className="bg-white rounded shadow">
            <details className="group" open>
              <summary className="p-3 cursor-pointer flex items-center justify-between hover:bg-gray-50">
                <div className="flex items-center gap-2">
                  <span className="text-lg">üìÅ</span>
                  <span className="text-sm font-bold">Document Type</span>
                  {documentType && <span className="text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded">{documentType}</span>}
                </div>
                <span className="text-gray-400 group-open:rotate-180 transition-transform">‚ñº</span>
              </summary>
              <div className="p-4 pt-0 border-t">
                {/* Document Category Buttons */}
                <div className="grid grid-cols-4 gap-2 mb-3">
                  <button
                    onClick={() => setDocumentCategory('financial')}
                    className={`px-3 py-2 text-xs rounded-lg transition-all ${documentCategory === 'financial' ? 'bg-blue-600 text-white shadow' : 'bg-gray-100 text-gray-600 hover:bg-blue-100 border'}`}
                  >
                    üìä Financial
                  </button>
                  <button
                    onClick={() => setDocumentCategory('education')}
                    className={`px-3 py-2 text-xs rounded-lg transition-all ${documentCategory === 'education' ? 'bg-blue-600 text-white shadow' : 'bg-gray-100 text-gray-600 hover:bg-blue-100 border'}`}
                  >
                    üéì Education
                  </button>
                  <button
                    onClick={() => setDocumentCategory('general')}
                    className={`px-3 py-2 text-xs rounded-lg transition-all ${documentCategory === 'general' ? 'bg-blue-600 text-white shadow' : 'bg-gray-100 text-gray-600 hover:bg-blue-100 border'}`}
                  >
                    üìÑ General
                  </button>
                  <button
                    onClick={() => setDocumentCategory('personal')}
                    className={`px-3 py-2 text-xs rounded-lg transition-all ${documentCategory === 'personal' ? 'bg-blue-600 text-white shadow' : 'bg-gray-100 text-gray-600 hover:bg-blue-100 border'}`}
                  >
                    üë§ Personal
                  </button>
                </div>
                {/* Document Type Input */}
                <div>
                  <label className="block text-xs text-gray-600 mb-1">Document Type:</label>
                  <input
                    type="text"
                    value={documentType}
                    onChange={(e) => setDocumentType(e.target.value)}
                    placeholder="e.g., Bank Statement, Birth Certificate, Diploma..."
                    className="w-full px-3 py-2 text-sm border rounded"
                  />
                </div>
              </div>
            </details>
          </div>

          {/* Page Format Section - Moved up before Logos */}
          <div className="bg-white rounded shadow p-4">
            <h3 className="text-xs font-bold text-gray-700 mb-3">üìÑ Page Format</h3>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Page Size</label>
                <select value={pageFormat} onChange={(e) => savePageFormat(e.target.value)} className="w-full px-2 py-1.5 text-xs border rounded">
                  <option value="letter">Letter (8.5" x 11") - US Standard</option>
                  <option value="a4">A4 (210mm x 297mm) - International</option>
                </select>
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Translation Type</label>
                <select value={translationType} onChange={(e) => saveTranslationType(e.target.value)} className="w-full px-2 py-1.5 text-xs border rounded">
                  <option value="certified">Certified Translation</option>
                  <option value="sworn">Sworn Translation</option>
                </select>
              </div>
            </div>
          </div>

          {/* Translator's Note for Financial Documents */}
          <div className="bg-white rounded shadow">
            <button
              onClick={() => setTranslatorNoteEnabled(!translatorNoteEnabled)}
              className="w-full p-3 flex items-center justify-between text-left hover:bg-gray-50"
            >
              <div className="flex items-center space-x-2">
                <span className="text-lg">üí±</span>
                <div>
                  <span className="text-sm font-medium">Translator's Note (Financial Documents)</span>
                  <p className="text-[10px] text-gray-500">Currency conversion for bank statements, tax returns</p>
                </div>
                {translatorNoteEnabled && <span className="text-xs text-green-600 bg-green-50 px-2 py-0.5 rounded">‚úì Active</span>}
              </div>
              <span className="text-gray-400">{translatorNoteEnabled ? '‚ñº' : '‚ñ∂'}</span>
            </button>

            {translatorNoteEnabled && (
              <div className="p-4 border-t space-y-4">
                {/* Currency Selection */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">Source Currency (Document)</label>
                    <select
                      value={translatorNoteSettings.sourceCurrency}
                      onChange={(e) => setTranslatorNoteSettings({...translatorNoteSettings, sourceCurrency: e.target.value, exchangeRate: ''})}
                      className="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      {Object.entries(CURRENCIES).map(([code, curr]) => (
                        <option key={code} value={code}>{curr.flag} {code} - {curr.name}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">Target Currency (Translation)</label>
                    <select
                      value={translatorNoteSettings.targetCurrency}
                      onChange={(e) => setTranslatorNoteSettings({...translatorNoteSettings, targetCurrency: e.target.value, exchangeRate: ''})}
                      className="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      {Object.entries(CURRENCIES).map(([code, curr]) => (
                        <option key={code} value={code}>{curr.flag} {code} - {curr.name}</option>
                      ))}
                    </select>
                  </div>
                </div>

                {/* Exchange Rate */}
                <div className="grid grid-cols-3 gap-3">
                  <div className="col-span-2">
                    <label className="block text-xs font-medium text-gray-700 mb-1">
                      1 {translatorNoteSettings.targetCurrency} ({CURRENCIES[translatorNoteSettings.targetCurrency]?.symbol}) = _____ {translatorNoteSettings.sourceCurrency} ({CURRENCIES[translatorNoteSettings.sourceCurrency]?.symbol})
                    </label>
                    <div className="flex gap-2">
                      <input
                        type="number"
                        step="0.0001"
                        value={translatorNoteSettings.exchangeRate}
                        onChange={(e) => setTranslatorNoteSettings({...translatorNoteSettings, exchangeRate: e.target.value})}
                        placeholder="Ex: 5.1234"
                        className="flex-1 px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500"
                      />
                      <button
                        onClick={fetchExchangeRate}
                        disabled={fetchingRate}
                        className="px-3 py-2 bg-blue-600 text-white text-xs rounded-lg hover:bg-blue-700 disabled:bg-gray-400 whitespace-nowrap"
                      >
                        {fetchingRate ? '‚è≥' : 'üîÑ'} Fetch Rate
                      </button>
                    </div>
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">Rate Date</label>
                    <input
                      type="date"
                      value={translatorNoteSettings.rateDate}
                      onChange={(e) => setTranslatorNoteSettings({...translatorNoteSettings, rateDate: e.target.value})}
                      className="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                </div>

                {/* Rate Source */}
                <div>
                  <label className="block text-xs font-medium text-gray-700 mb-1">Rate Source (for citation)</label>
                  <select
                    value={translatorNoteSettings.rateSource}
                    onChange={(e) => setTranslatorNoteSettings({...translatorNoteSettings, rateSource: e.target.value})}
                    className="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500"
                  >
                    {RATE_SOURCES.map(source => (
                      <option key={source.id} value={source.id}>{source.name} - {source.url}</option>
                    ))}
                  </select>
                </div>

                {/* Convert Values Toggle */}
                <div className="flex items-center gap-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                  <input
                    type="checkbox"
                    id="convertValues"
                    checked={translatorNoteSettings.convertValues}
                    onChange={(e) => setTranslatorNoteSettings({...translatorNoteSettings, convertValues: e.target.checked})}
                    className="w-4 h-4 text-blue-600 rounded"
                  />
                  <label htmlFor="convertValues" className="text-xs text-yellow-800">
                    <strong>Convert main values in document</strong> (totals, subtotals, balances, loans, credits)
                    <br />
                    <span className="text-yellow-600">Format: 3,113,492.10 [<strong>CA$807,126.92</strong>]</span>
                  </label>
                </div>

                {/* Preview Note */}
                {translatorNoteSettings.exchangeRate && (
                  <div className="p-3 bg-gray-50 border rounded-lg">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-xs font-medium text-gray-700">üìù Preview Translator's Note:</span>
                      <button
                        onClick={() => {
                          const note = generateTranslatorNote();
                          navigator.clipboard.writeText(note);
                          showToast('Note copied to clipboard!');
                        }}
                        className="text-xs text-blue-600 hover:underline"
                      >
                        üìã Copy
                      </button>
                    </div>
                    <p className="text-[11px] text-gray-600 italic leading-relaxed">
                      {generateTranslatorNote()}
                    </p>

                    {/* Example Conversion */}
                    <div className="mt-3 pt-3 border-t border-gray-200">
                      <span className="text-[10px] font-medium text-gray-500">Example Conversion:</span>
                      <div className="mt-1 text-sm">
                        <span className="text-gray-700">{CURRENCIES[translatorNoteSettings.sourceCurrency].symbol}1,000.00 </span>
                        <span dangerouslySetInnerHTML={{ __html: convertCurrencyValue(1000 * parseFloat(translatorNoteSettings.exchangeRate || 1)) }} className="text-green-700" />
                      </div>
                    </div>
                  </div>
                )}

                {/* Quick Info */}
                <div className="text-[10px] text-gray-500 bg-blue-50 p-2 rounded">
                  <strong>üí° How it works:</strong> When enabled, the translator's note will be added at the beginning of the FIRST PAGE of EACH FILE (if multiple files).
                  If "Convert values" is checked, main financial values will show converted amounts in brackets.
                  <br/><strong>Note:</strong> The preview above auto-updates when you change currency, date, or source.
                </div>
              </div>
            )}
          </div>

          {/* Certificate Preview - LIVE with Editable Fields */}
          <div className="bg-white rounded shadow p-4">
            <div className="flex justify-between items-center mb-3">
              <h3 className="text-xs font-bold text-blue-700">üìÑ Certificate Preview (Live)</h3>
              <div className="flex items-center gap-2">
                <span className="text-[10px] text-green-600 bg-green-50 px-2 py-1 rounded">
                  Template: {selectedCertificateTemplate.startsWith('custom-')
                    ? customCertificateTemplates.find(t => `custom-${t.id}` === selectedCertificateTemplate)?.name || 'Custom'
                    : CERTIFICATE_TEMPLATES[selectedCertificateTemplate]?.name || 'Default'}
                </span>
                <span className="text-[10px] text-blue-500 bg-blue-50 px-2 py-1 rounded">üîÑ Edit highlighted fields directly</span>
                {(isAdmin || isPM) && (
                  <button
                    onClick={handleDownloadCertificatePreview}
                    className="text-[10px] text-white bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded flex items-center gap-1"
                    title="Download certificate preview as PDF"
                  >
                    ‚¨á Download
                  </button>
                )}
              </div>
            </div>

            {/* Check if selected template is a form type */}
            {CERTIFICATE_TEMPLATES[selectedCertificateTemplate]?.isForm ? (
              /* Render Form Template (like RMV Foreign DL) */
              <div
                className="border rounded bg-white overflow-auto"
                style={{maxHeight: '800px'}}
                dangerouslySetInnerHTML={{ __html: CERTIFICATE_TEMPLATES[selectedCertificateTemplate].formHTML
                  .replace(/\{\{LOGO_LEFT\}\}/g, logoLeft ? `<img src="${logoLeft}" alt="Logo" style="max-height: 48px;" />` : '<div style="font-size: 10px; color: #2563eb; font-weight: bold;">LEGACY<br/><span style="font-weight: normal; font-size: 8px;">TRANSLATIONS</span></div>')
                  .replace(/\{\{LOGO_RIGHT\}\}/g, logoRight ? `<img src="${logoRight}" alt="ATA" style="max-height: 40px;" />` : '<div style="font-size: 9px; color: #666; font-style: italic;">ata<br/><span style="font-size: 8px;">MEMBER</span><br/><span style="font-size: 7px;">American Translators Association</span></div>')
                  .replace(/\{\{LOGO_STAMP\}\}/g, logoStamp ? `<img src="${logoStamp}" alt="Stamp" style="width: 100px; height: 100px; object-fit: contain;" />` : '')
                  .replace(/\{\{SIGNATURE\}\}/g, signatureImage ? `<img src="${signatureImage}" alt="Signature" style="max-height: 32px; max-width: 150px;" />` : '')
                  .replace(/\{\{TODAY_DATE\}\}/g, new Date().toLocaleDateString('en-US', { timeZone: 'America/New_York' }))
                }}
              />
            ) : (
              /* Render Standard Certificate Template */
              <div className="border rounded p-8 bg-white" style={{fontFamily: 'Georgia, Times New Roman, serif', fontSize: '12px', lineHeight: '1.6', maxWidth: '800px', margin: '0 auto'}}>

                {/* Header with logos */}
                <div className="flex justify-between items-center mb-2 pb-2">
                  <div className="w-32">
                    {logoLeft ? <img src={logoLeft} alt="Logo" className="max-h-12" /> : <div className="text-[10px] text-blue-600 font-bold">LEGACY<br/><span className="font-normal text-[8px]">TRANSLATIONS</span></div>}
                  </div>
                  <div className="text-center flex-1 px-4">
                    <div className="font-bold text-blue-600 text-sm">Legacy Translations</div>
                    <div className="text-[9px] text-gray-600">867 Boylston Street ¬∑ 5th Floor ¬∑ #2073 ¬∑ Boston, MA ¬∑ 02116</div>
                    <div className="text-[9px] text-gray-600">(857) 316-7770 ¬∑ contact@legacytranslations.com</div>
                  </div>
                  <div className="w-20 text-right">
                    {logoRight ? <img src={logoRight} alt="ATA" className="max-h-10 ml-auto" /> : <div className="text-[9px] text-gray-600 italic">ata<br/><span className="text-[8px]">Member # 275993</span></div>}
                  </div>
                </div>
                {/* Light blue line below header */}
                <div className="w-full h-0.5 bg-blue-200 mb-4"></div>

                {/* Order Number */}
                <div className="text-right mb-6 text-sm">
                  <span>Order # </span>
                  <input type="text" value={orderNumber} onChange={(e) => setOrderNumber(e.target.value)} className="font-bold border-b-2 border-blue-400 bg-blue-50 px-2 py-0.5 w-48 text-center focus:outline-none focus:border-blue-600" placeholder="P6287 or ORD-..." />
                </div>

                {/* Main Title */}
                <h1 className="text-2xl text-center mb-6 font-normal" style={{color: '#1a365d'}}>Certification of Translation Accuracy</h1>

                {/* Translation of ... */}
                <p className="text-center mb-6 text-sm">
                  Translation of{' '}
                  <input type="text" value={documentType} onChange={(e) => setDocumentType(e.target.value)} className="font-bold border-b-2 border-blue-400 bg-blue-50 px-2 py-0.5 w-32 text-center focus:outline-none focus:border-blue-600" placeholder="School Transcript" />
                  {' '}from<br/>
                  <select value={sourceLanguage} onChange={(e) => setSourceLanguage(e.target.value)} className="font-bold border-b-2 border-blue-400 bg-blue-50 px-2 py-0.5 focus:outline-none focus:border-blue-600 mt-1">
                    {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                  </select>
                  {' '}to{' '}
                  <select value={targetLanguage} onChange={(e) => setTargetLanguage(e.target.value)} className="font-bold border-b-2 border-blue-400 bg-blue-50 px-2 py-0.5 focus:outline-none focus:border-blue-600">
                    {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                  </select>
                </p>

                {/* Body tographs - Dynamic based on selected template */}
                {(() => {
                  // Get the template tographs
                  let templateParagraphs;
                  if (selectedCertificateTemplate.startsWith('custom-')) {
                    const customTemplate = customCertificateTemplates.find(t => `custom-${t.id}` === selectedCertificateTemplate);
                    templateParagraphs = customTemplate?.bodyParagraphs || CERTIFICATE_TEMPLATES['default'].bodyParagraphs;
                  } else {
                    templateParagraphs = CERTIFICATE_TEMPLATES[selectedCertificateTemplate]?.bodyParagraphs || CERTIFICATE_TEMPLATES['default'].bodyParagraphs;
                  }

                  // Replace placeholders with actual values
                  return templateParagraphs.map((tograph, index) => {
                    const processedParagraph = tograph
                      .replace(/\{\{sourceLanguage\}\}/g, sourceLanguage)
                      .replace(/\{\{targetLanguage\}\}/g, targetLanguage);

                    return (
                      <p
                        key={index}
                        className={`${index === templateParagraphs.length - 1 ? 'mb-6' : 'mb-4'} text-justify text-xs leading-relaxed`}
                        dangerouslySetInnerHTML={{ __html: processedParagraph }}
                      />
                    );
                  });
                })()}

                {/* Signature and Stamp Section */}
                <div className="mt-8 flex justify-between items-end">
                  <div>
                    {signatureImage ? (
                      <img src={signatureImage} alt="Signature" className="h-8 mb-1" style={{maxWidth: '150px'}} />
                    ) : (
                      <div className="mb-1" style={{fontFamily: 'Rage Italic, cursive', fontSize: '20px', color: '#1a365d'}}>Beatriz Paiva</div>
                  )}
                  <div className="text-xs">Authorized Representative</div>
                  <div className="text-xs">Legacy Translations Inc.</div>
                  <div className="text-xs mt-2">
                    Dated:{' '}
                    <input type="text" value={translationDate} onChange={(e) => setTranslationDate(e.target.value)} className="font-bold border-b-2 border-blue-400 bg-blue-50 px-2 py-0.5 w-28 focus:outline-none focus:border-blue-600" />
                  </div>
                </div>
                <div className="text-center">
                  {logoStamp ? (
                    <img src={logoStamp} alt="Stamp" className="w-28 h-28 object-contain" />
                  ) : (
                    <div className="w-28 h-28 rounded-full border-4 border-blue-600 flex flex-col items-center justify-center p-2" style={{borderStyle: 'double'}}>
                      <div className="text-[8px] text-blue-600 font-bold">CERTIFIED TRANSLATOR</div>
                      <div className="text-[10px] text-blue-600 font-bold mt-1">LEGACY TRANSLATIONS</div>
                      <div className="text-[8px] text-blue-600">ATA # 275993</div>
                    </div>
                  )}
                </div>
              </div>
            </div>
            )}
          </div>

          {/* Certificate Logos Section - Admin Only */}
          {isAdmin && (
          <div className="bg-white rounded shadow p-4">
            <h3 className="text-xs font-bold text-gray-700 mb-3">üñºÔ∏è Certificate Logos & Signature</h3>

            {/* Header Info Section */}
            <div className="mb-4 p-3 bg-gray-50 rounded border">
              <h4 className="text-[10px] font-bold text-gray-600 mb-2">üìù Certificate Header Info</h4>
              <div className="grid grid-cols-2 gap-2">
                <div>
                  <label className="block text-[10px] text-gray-500 mb-0.5">Company Name</label>
                  <input
                    type="text"
                    value={certCompanyName}
                    onChange={(e) => {
                      setCertCompanyName(e.target.value);
                      localStorage.setItem('cert_company_name', e.target.value);
                    }}
                    className="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500"
                    placeholder="Legacy Translations Inc."
                  />
                </div>
                <div>
                  <label className="block text-[10px] text-gray-500 mb-0.5">Address</label>
                  <input
                    type="text"
                    value={certCompanyAddress}
                    onChange={(e) => {
                      setCertCompanyAddress(e.target.value);
                      localStorage.setItem('cert_company_address', e.target.value);
                    }}
                    className="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500"
                    placeholder="123 Business St, Suite 100"
                  />
                </div>
                <div>
                  <label className="block text-[10px] text-gray-500 mb-0.5">Phone</label>
                  <input
                    type="text"
                    value={certCompanyPhone}
                    onChange={(e) => {
                      setCertCompanyPhone(e.target.value);
                      localStorage.setItem('cert_company_phone', e.target.value);
                    }}
                    className="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500"
                    placeholder="+1 (555) 123-4567"
                  />
                </div>
                <div>
                  <label className="block text-[10px] text-gray-500 mb-0.5">Email</label>
                  <input
                    type="text"
                    value={certCompanyEmail}
                    onChange={(e) => {
                      setCertCompanyEmail(e.target.value);
                      localStorage.setItem('cert_company_email', e.target.value);
                    }}
                    className="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500"
                    placeholder="contact@legacytranslations.com"
                  />
                </div>
              </div>
            </div>

            {/* Logos Grid - Made smaller */}
            <div className="grid grid-cols-4 gap-2">
              {/* Left Logo (Legacy/Partner) */}
              <div className="text-center">
                <label className="block text-[10px] font-medium text-gray-700 mb-1">Left Logo</label>
                <div className="border-2 border-dashed border-gray-300 rounded p-1 bg-white h-14 flex items-center justify-center">
                  {logoLeft ? (
                    <img src={logoLeft} alt="Left Logo" className="max-h-10 max-w-full object-contain" />
                  ) : (
                    <span className="text-[9px] text-gray-400">No logo</span>
                  )}
                </div>
                <input ref={logoLeftInputRef} type="file" accept="image/*" onChange={(e) => handleLogoUpload(e, 'left')} className="hidden" />
                <div className="flex justify-center gap-1 mt-1">
                  {user?.role === 'admin' && <button onClick={() => logoLeftInputRef.current?.click()} className="px-1.5 py-0.5 bg-blue-500 text-white text-[9px] rounded hover:bg-blue-600">Upload</button>}
                  {user?.role === 'admin' && logoLeft && <button onClick={() => saveAssetToBackend('logo_left', logoLeft)} className="px-1.5 py-0.5 bg-green-500 text-white text-[9px] rounded hover:bg-green-600">Salvar</button>}
                  {user?.role === 'admin' && logoLeft && <button onClick={() => removeLogo('left')} className="px-1.5 py-0.5 bg-red-500 text-white text-[9px] rounded hover:bg-red-600">üóëÔ∏è</button>}
                </div>
              </div>

              {/* Center Logo (ATA) */}
              <div className="text-center">
                <label className="block text-[10px] font-medium text-gray-700 mb-1">Center Logo</label>
                <div className="border-2 border-dashed border-gray-300 rounded p-1 bg-white h-14 flex items-center justify-center">
                  {logoRight ? (
                    <img src={logoRight} alt="ATA Logo" className="max-h-10 max-w-full object-contain" />
                  ) : (
                    <span className="text-[9px] text-gray-400">No logo</span>
                  )}
                </div>
                <input ref={logoRightInputRef} type="file" accept="image/*" onChange={(e) => handleLogoUpload(e, 'right')} className="hidden" />
                <div className="flex justify-center gap-1 mt-1">
                  {user?.role === 'admin' && <button onClick={() => logoRightInputRef.current?.click()} className="px-1.5 py-0.5 bg-blue-500 text-white text-[9px] rounded hover:bg-blue-600">Upload</button>}
                  {user?.role === 'admin' && logoRight && <button onClick={() => saveAssetToBackend('logo_right', logoRight)} className="px-1.5 py-0.5 bg-green-500 text-white text-[9px] rounded hover:bg-green-600">Salvar</button>}
                  {user?.role === 'admin' && logoRight && <button onClick={() => removeLogo('right')} className="px-1.5 py-0.5 bg-red-500 text-white text-[9px] rounded hover:bg-red-600">üóëÔ∏è</button>}
                </div>
              </div>

              {/* Stamp Logo */}
              <div className="text-center">
                <label className="block text-[10px] font-medium text-gray-700 mb-1">Stamp</label>
                <div className="border-2 border-dashed border-gray-300 rounded p-1 bg-white h-14 flex items-center justify-center">
                  {logoStamp ? (
                    <img src={logoStamp} alt="Stamp Logo" className="max-h-10 max-w-full object-contain" />
                  ) : (
                    <span className="text-[9px] text-gray-400">No stamp</span>
                  )}
                </div>
                <input ref={logoStampInputRef} type="file" accept="image/*" onChange={(e) => handleLogoUpload(e, 'stamp')} className="hidden" />
                <div className="flex justify-center gap-1 mt-1">
                  {user?.role === 'admin' && <button onClick={() => logoStampInputRef.current?.click()} className="px-1.5 py-0.5 bg-blue-500 text-white text-[9px] rounded hover:bg-blue-600">Upload</button>}
                  {user?.role === 'admin' && logoStamp && <button onClick={() => saveAssetToBackend('logo_stamp', logoStamp)} className="px-1.5 py-0.5 bg-green-500 text-white text-[9px] rounded hover:bg-green-600">Salvar</button>}
                  {user?.role === 'admin' && logoStamp && <button onClick={() => removeLogo('stamp')} className="px-1.5 py-0.5 bg-red-500 text-white text-[9px] rounded hover:bg-red-600">üóëÔ∏è</button>}
                </div>
              </div>

              {/* Signature Image */}
              <div className="text-center">
                <label className="block text-[10px] font-medium text-gray-700 mb-1">Signature</label>
                <div className="border-2 border-dashed border-gray-300 rounded p-1 bg-white h-14 flex items-center justify-center">
                  {signatureImage ? (
                    <img src={signatureImage} alt="Signature" className="max-h-10 max-w-full object-contain" />
                  ) : (
                    <span className="text-[9px] text-gray-400">No signature</span>
                  )}
                </div>
                <input ref={signatureInputRef} type="file" accept="image/*" onChange={(e) => handleLogoUpload(e, 'signature')} className="hidden" />
                <div className="flex justify-center gap-1 mt-1">
                  {user?.role === 'admin' && <button onClick={() => signatureInputRef.current?.click()} className="px-1.5 py-0.5 bg-blue-500 text-white text-[9px] rounded hover:bg-blue-600">Upload</button>}
                  {user?.role === 'admin' && signatureImage && <button onClick={() => saveAssetToBackend('signature_image', signatureImage)} className="px-1.5 py-0.5 bg-green-500 text-white text-[9px] rounded hover:bg-green-600">Salvar</button>}
                  {user?.role === 'admin' && signatureImage && <button onClick={() => removeLogo('signature')} className="px-1.5 py-0.5 bg-red-500 text-white text-[9px] rounded hover:bg-red-600">üóëÔ∏è</button>}
                </div>
              </div>
            </div>
          </div>
          )}

          {/* Certificate Template Selector - Organized by Category */}
          <div className="bg-white rounded shadow p-3">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-xs font-bold">üìú Certificate Template</h3>
              <button
                onClick={() => {
                  const name = prompt('Template name:');
                  if (name) {
                    const templateText = prompt('Certificate tographs (use {{sourceLanguage}}, {{targetLanguage}}). Setote with ||:');
                    if (templateText) {
                      const tographs = templateText.split('||').map(p => p.trim()).filter(p => p);
                      if (tographs.length > 0) {
                        const newTemplate = { id: Date.now(), name, description: 'Custom', bodyParagraphs: tographs };
                        const updated = [...customCertificateTemplates, newTemplate];
                        setCustomCertificateTemplates(updated);
                        localStorage.setItem('custom_certificate_templates', JSON.stringify(updated));
                        setSelectedCertificateTemplate(`custom-${newTemplate.id}`);
                        localStorage.setItem('selected_certificate_template', `custom-${newTemplate.id}`);
                      }
                    }
                  }
                }}
                className="text-[10px] px-2 py-1 rounded border border-dashed border-blue-400 text-blue-600 hover:bg-blue-50"
              >
                + Custom
              </button>
            </div>

            {/* Templates by Category - Only show Certificates in START tab */}
            <div className="space-y-2">
              {Object.entries(TEMPLATE_CATEGORIES)
                .filter(([catKey]) => catKey === 'certificates')
                .map(([catKey, category]) => {
                const templatesInCategory = Object.entries(CERTIFICATE_TEMPLATES).filter(([_, t]) => t.category === catKey);
                if (templatesInCategory.length === 0) return null;
                return (
                  <div key={catKey} className="border rounded p-2">
                    <div className="text-[10px] font-semibold text-gray-600 mb-1.5 flex items-center gap-1">
                      <span>{category.icon}</span>
                      <span>{category.name}</span>
                      <span className="text-[9px] text-gray-400 font-normal">({templatesInCategory.length})</span>
                    </div>
                    <div className="flex flex-wrap gap-1">
                      {templatesInCategory.map(([key, template]) => (
                        <button
                          key={key}
                          onClick={() => {
                            setSelectedCertificateTemplate(key);
                            localStorage.setItem('selected_certificate_template', key);
                          }}
                          className={`px-2 py-1 text-[9px] rounded transition-all ${selectedCertificateTemplate === key
                            ? 'bg-blue-500 text-white font-medium'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                          title={template.description}
                        >
                          {template.name}
                        </button>
                      ))}
                    </div>
                  </div>
                );
              })}

              {/* Custom Templates */}
              {customCertificateTemplates.length > 0 && (
                <div className="border rounded p-2 border-dashed">
                  <div className="text-[10px] font-semibold text-gray-600 mb-1.5 flex items-center gap-1">
                    <span>‚≠ê</span>
                    <span>Custom Templates</span>
                    <span className="text-[9px] text-gray-400 font-normal">({customCertificateTemplates.length})</span>
                  </div>
                  <div className="flex flex-wrap gap-1">
                    {customCertificateTemplates.map(tpl => (
                      <div key={tpl.id} className="flex items-center">
                        <button
                          onClick={() => {
                            setSelectedCertificateTemplate(`custom-${tpl.id}`);
                            localStorage.setItem('selected_certificate_template', `custom-${tpl.id}`);
                          }}
                          className={`px-2 py-1 text-[9px] rounded-l transition-all ${selectedCertificateTemplate === `custom-${tpl.id}`
                            ? 'bg-blue-500 text-white font-medium'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                        >
                          {tpl.name}
                        </button>
                        <button
                          onClick={() => {
                            if (window.confirm(`Delete "${tpl.name}"?`)) {
                              const updated = customCertificateTemplates.filter(t => t.id !== tpl.id);
                              setCustomCertificateTemplates(updated);
                              localStorage.setItem('custom_certificate_templates', JSON.stringify(updated));
                              if (selectedCertificateTemplate === `custom-${tpl.id}`) {
                                setSelectedCertificateTemplate('default');
                                localStorage.setItem('selected_certificate_template', 'default');
                              }
                            }
                          }}
                          className="px-1 py-1 text-[9px] bg-red-100 text-red-600 rounded-r hover:bg-red-200"
                        >
                          ‚úï
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Session Restore Preferences */}
          {restorePromptsDisabled && (
            <div className="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg">
              <div className="flex items-center justify-between">
                <div className="text-xs text-gray-600">
                  Session restore prompts are disabled
                </div>
                <button
                  onClick={() => {
                    localStorage.removeItem('translation_restore_disabled');
                    setRestorePromptsDisabled(false);
                  }}
                  className="text-xs text-blue-600 hover:text-blue-800 underline"
                >
                  Enable restore prompts
                </button>
              </div>
            </div>
          )}

          {/* Navigation */}
          <div className="mt-4 flex justify-end">
            <button
              onClick={() => setActiveSubTab('translate')}
              className="px-6 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 flex items-center"
            >
              Next: Translate <span className="ml-2">‚Üí</span>
            </button>
          </div>
        </div>
      )}

      {/* DOCUMENT TAB - Direct Translation */}
      {activeSubTab === 'translate' && (
        <div className="bg-white rounded shadow p-4">
          <h2 className="text-sm font-bold mb-2">üìÑ Document Translation</h2>

          {/* Translation Type Selector */}
          <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <label className="block text-xs font-medium text-blue-700 mb-2">üìÅ Document Type</label>
            <div className="grid grid-cols-4 gap-2">
              <button
                onClick={() => setDocumentCategory('financial')}
                className={`px-3 py-2 text-xs rounded-lg transition-all ${documentCategory === 'financial' ? 'bg-blue-600 text-white shadow' : 'bg-white text-gray-600 hover:bg-blue-100 border'}`}
              >
                üìä Financial
              </button>
              <button
                onClick={() => setDocumentCategory('education')}
                className={`px-3 py-2 text-xs rounded-lg transition-all ${documentCategory === 'education' ? 'bg-blue-600 text-white shadow' : 'bg-white text-gray-600 hover:bg-blue-100 border'}`}
              >
                üéì Education
              </button>
              <button
                onClick={() => setDocumentCategory('general')}
                className={`px-3 py-2 text-xs rounded-lg transition-all ${documentCategory === 'general' ? 'bg-blue-600 text-white shadow' : 'bg-white text-gray-600 hover:bg-blue-100 border'}`}
              >
                üìÑ General
              </button>
              <button
                onClick={() => setDocumentCategory('personal')}
                className={`px-3 py-2 text-xs rounded-lg transition-all ${documentCategory === 'personal' ? 'bg-blue-600 text-white shadow' : 'bg-white text-gray-600 hover:bg-blue-100 border'}`}
              >
                üë§ Personal
              </button>
            </div>
          </div>

          {/* Workflow Mode Switch */}
          <div className="mb-4 p-3 bg-gray-100 rounded-lg">
            <div className="flex items-center justify-center gap-3">
              <label className={`flex items-center px-3 py-2 rounded-lg cursor-pointer transition-all ${workflowMode === 'ai' ? 'bg-blue-600 text-white shadow' : 'bg-white text-gray-600 hover:bg-gray-50'}`}>
                <input
                  type="radio"
                  name="workflowMode"
                  value="ai"
                  checked={workflowMode === 'ai'}
                  onChange={() => handleWorkflowModeChange('ai')}
                  className="sr-only"
                />
                <span className="mr-2">ü§ñ</span>
                <span className="text-sm font-medium">Translate with AI</span>
              </label>
              <label className={`flex items-center px-3 py-2 rounded-lg cursor-pointer transition-all ${workflowMode === 'external' ? 'bg-green-600 text-white shadow' : 'bg-white text-gray-600 hover:bg-gray-50'}`}>
                <input
                  type="radio"
                  name="workflowMode"
                  value="external"
                  checked={workflowMode === 'external'}
                  onChange={() => handleWorkflowModeChange('external')}
                  className="sr-only"
                />
                <span className="mr-2">üì•</span>
                <span className="text-sm font-medium">External Translation</span>
              </label>
              <label className={`flex items-center px-3 py-2 rounded-lg cursor-pointer transition-all ${workflowMode === 'ocr' ? 'bg-gray-700 text-white shadow' : 'bg-white text-gray-600 hover:bg-gray-50'}`}>
                <input
                  type="radio"
                  name="workflowMode"
                  value="ocr"
                  checked={workflowMode === 'ocr'}
                  onChange={() => handleWorkflowModeChange('ocr')}
                  className="sr-only"
                />
                <span className="mr-2">üìù</span>
                <span className="text-sm font-medium">OCR (CAT Tool)</span>
              </label>
              <label className={`flex items-center px-3 py-2 rounded-lg cursor-pointer transition-all ${workflowMode === 'template' ? 'bg-purple-600 text-white shadow' : 'bg-white text-gray-600 hover:bg-gray-50'}`}>
                <input
                  type="radio"
                  name="workflowMode"
                  value="template"
                  checked={workflowMode === 'template'}
                  onChange={() => handleWorkflowModeChange('template')}
                  className="sr-only"
                />
                <span className="mr-2">üìã</span>
                <span className="text-sm font-medium">Fill Template</span>
              </label>
            </div>
            <p className="text-[10px] text-gray-500 text-center mt-2">
              {workflowMode === 'ai' ? 'Upload document and translate with AI' : workflowMode === 'external' ? 'Upload original + existing translation for review' : workflowMode === 'ocr' ? 'Extract text for external CAT tools (SDL Trados, MemoQ, etc.)' : 'Fill document template with original for reference'}
            </p>
          </div>

          {/* Project Documents Section - Select to Load */}
          {selectedOrderId && (
            <div className="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-4 mb-4">
              <div className="flex justify-between items-start gap-4">
                {/* Left side - Files */}
                <div className="flex-1">
                  <h3 className="text-xs font-bold text-blue-800 mb-3">üìÅ Project Documents - Click to Load</h3>

                  {loadingProjectFiles ? (
                    <div className="text-sm text-gray-500 text-center py-4">Loading files...</div>
                  ) : selectedProjectFiles.length > 0 ? (
                    <>
                      <div className="space-y-2">
                        {selectedProjectFiles.map((doc, idx) => (
                          <div
                            key={doc.id}
                            className={`p-3 rounded-lg transition-all ${
                              selectedFileId === doc.id
                                ? 'bg-green-100 border-2 border-green-500 shadow-md'
                                : 'bg-white border border-gray-200 hover:bg-blue-50'
                            }`}
                          >
                            <div className="flex items-center gap-3">
                              {/* File Icon and Info - Clickable to load */}
                              <div
                                onClick={() => loadProjectFile(doc)}
                                className="flex items-center gap-3 flex-1 cursor-pointer"
                              >
                                <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-lg ${
                                  selectedFileId === doc.id ? 'bg-green-500 text-white' : 'bg-gray-100'
                                }`}>
                                  {doc.filename?.toLowerCase().endsWith('.pdf') ? 'üìÑ' : 'üñºÔ∏è'}
                                </div>
                                <div className="flex-1 min-w-0">
                                  <div className={`text-sm font-medium truncate ${
                                    selectedFileId === doc.id ? 'text-green-700' : 'text-gray-700'
                                  }`}>
                                    {doc.filename || `File ${idx + 1}`}
                                  </div>
                                  <div className="text-xs text-gray-400">
                                    {selectedFileId === doc.id ? '‚úì Loaded - Ready to translate' : 'Click to load'}
                                  </div>
                                </div>
                                {selectedFileId === doc.id && (
                                  <div className="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-sm">
                                    ‚úì
                                  </div>
                                )}
                              </div>

                              {/* Action Buttons */}
                              <div className="flex items-center gap-1">
                                {/* Download Button */}
                                <button
                                  onClick={async (e) => {
                                    e.stopPropagation();
                                    try {
                                      const response = await axios.get(`${API}/admin/order-documents/${doc.id}/download?admin_key=${adminKey}`);
                                      if (response.data.file_data) {
                                        const link = document.createElement('a');
                                        link.href = `data:${response.data.content_type || 'application/pdf'};base64,${response.data.file_data}`;
                                        link.download = doc.filename || 'document.pdf';
                                        link.click();
                                      }
                                    } catch (err) {
                                      showToast('Error downloading file');
                                    }
                                  }}
                                  className="px-2 py-1.5 bg-blue-100 text-blue-600 rounded text-xs hover:bg-blue-200 transition-colors"
                                  title="Download"
                                >
                                  ‚¨áÔ∏è
                                </button>

                                {/* Replace Button - File input */}
                                <label
                                  className="px-2 py-1.5 bg-blue-100 text-blue-600 rounded text-xs hover:bg-blue-200 transition-colors cursor-pointer"
                                  title="Substituir file"
                                >
                                  üîÑ
                                  <input
                                    type="file"
                                    className="hidden"
                                    accept="image/*,.pdf"
                                    onChange={async (e) => {
                                      const file = e.target.files[0];
                                      if (!file) return;
                                      try {
                                        const reader = new FileReader();
                                        reader.onload = async () => {
                                          const base64 = reader.result.split(',')[1];
                                          await axios.put(`${API}/admin/order-documents/${doc.id}?admin_key=${adminKey}`, {
                                            filename: file.name,
                                            file_data: base64,
                                            content_type: file.type
                                          });
                                          // Refresh files
                                          const response = await axios.get(`${API}/admin/orders/${selectedOrderId}/documents?admin_key=${adminKey}`);
                                          setSelectedProjectFiles(response.data.documents || []);
                                          setProcessingStatus(`‚úÖ File replaced: ${file.name}`);
                                        };
                                        reader.readAsDataURL(file);
                                      } catch (err) {
                                        showToast('Error replacing file');
                                      }
                                    }}
                                  />
                                </label>

                                {/* Use filename for Cover Letter */}
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    // Extract filename without extension and clean it up
                                    const filename = doc.filename || 'Document';
                                    const nameWithoutExt = filename.replace(/\.[^/.]+$/, '').replace(/_/g, ' ').replace(/-/g, ' ');
                                    setDocumentType(nameWithoutExt);
                                    setProcessingStatus(`‚úÖ Document type set to: "${nameWithoutExt}"`);
                                  }}
                                  className="px-2 py-1.5 bg-blue-100 text-blue-600 rounded text-xs hover:bg-blue-200 transition-colors"
                                  title="Usar nome do file na Capa"
                                >
                                  üìã
                                </button>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>

                      {originalImages.length > 0 && (
                        <div className="mt-3 p-2 bg-green-100 border border-green-300 rounded text-sm text-green-700">
                          ‚úÖ Document loaded: {originalImages[0]?.filename || 'Ready'} ({originalImages.length} page{originalImages.length > 1 ? 's' : ''})
                        </div>
                      )}
                    </>
                  ) : (
                    <div className="text-center py-4">
                      <p className="text-sm text-gray-500 mb-3">No document found in this project</p>
                      <button
                        onClick={() => setActiveSubTab('start')}
                        className="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700"
                      >
                        Fazer Upload na tab START
                      </button>
                    </div>
                  )}
                </div>

                {/* Right side - Field Selector */}
                <div className="w-48 flex-shrink-0">
                  <label className="block text-xs font-bold text-blue-800 mb-2">üìÇ Field</label>
                  <select
                    value={documentCategory}
                    onChange={(e) => setDocumentCategory(e.target.value)}
                    className="w-full px-3 py-2 text-sm border border-blue-300 rounded-lg bg-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                  >
                    <option value="financial">üìä Financial</option>
                    <option value="education">üéì Education</option>
                    <option value="general">üìÑ General</option>
                    <option value="personal">üë§ Personal</option>
                  </select>
                  <p className="text-[10px] text-gray-500 mt-1">Auto-selected from document type</p>
                </div>
              </div>
            </div>
          )}

          {/* Hint when no project selected */}
          {!selectedOrderId && (
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4 text-center">
              <div className="text-3xl mb-2">üìã</div>
              <p className="text-sm text-yellow-800 font-medium">Select a project first</p>
              <p className="text-xs text-yellow-600 mt-1">Go to the START tab and select a project to load the documents</p>
              <button
                onClick={() => setActiveSubTab('start')}
                className="mt-3 px-4 py-2 bg-yellow-600 text-white text-sm rounded hover:bg-yellow-700"
              >
                Go to START
              </button>
            </div>
          )}

          {/* ============ AI TRANSLATION MODE ============ */}
          {workflowMode === 'ai' && (
            <>
          {/* Language Selection */}
          <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded">
            <h3 className="text-xs font-bold text-blue-700 mb-3">üåê Translation Direction</h3>
            <div className="flex items-center justify-center gap-4">
              <div className="flex-1">
                <label className="block text-xs text-gray-600 mb-1">From:</label>
                <select
                  value={sourceLanguage}
                  onChange={(e) => setSourceLanguage(e.target.value)}
                  className="w-full px-3 py-2 text-sm border rounded font-medium"
                >
                  {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                </select>
              </div>
              <div className="pt-5 text-2xl text-blue-500">‚Üí</div>
              <div className="flex-1">
                <label className="block text-xs text-gray-600 mb-1">To:</label>
                <select
                  value={targetLanguage}
                  onChange={(e) => setTargetLanguage(e.target.value)}
                  className="w-full px-3 py-2 text-sm border rounded font-medium"
                >
                  {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                </select>
              </div>
            </div>
          </div>

          {/* File Upload Section */}
          {!originalImages.length && (
            <div
              className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-400 transition-colors mb-4"
              onClick={() => fileInputRef.current?.click()}
            >
              <input
                ref={fileInputRef}
                type="file"
                multiple
                accept="image/*,.pdf"
                onChange={handleFileSelect}
                className="hidden"
              />
              <div className="text-4xl mb-2">üì§</div>
              <button className="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                Upload Document
              </button>
              <p className="text-xs text-gray-500 mt-2">
                Upload image or PDF of the document to translate
              </p>
            </div>
          )}

          {/* Processing Status */}
          {processingStatus && (
            <div className={`mb-4 p-3 rounded text-xs ${
              processingStatus.includes('‚ùå') ? 'bg-red-100 text-red-700' :
              processingStatus.includes('‚úÖ') ? 'bg-green-100 text-green-700' :
              'bg-blue-100 text-blue-700'
            }`}>
              {processingStatus}
            </div>
          )}

          {/* Side-by-Side View: Original + Translation */}
          {originalImages.length > 0 && (
            <div className="mt-2">
              {/* Header */}
              <div className="flex justify-between items-center mb-2">
                <span className="text-xs font-medium text-gray-600">
                  {sourceLanguage} ‚Üí {targetLanguage}
                </span>
                <button
                  onClick={() => {
                    setOriginalImages([]);
                    setTranslationResults([]);
                    setFiles([]);
                  }}
                  className="px-2 py-1 text-xs text-red-600 hover:bg-red-50 rounded"
                >
                  üóëÔ∏è Clear & Start Over
                </button>
              </div>

              {/* Side-by-Side Panels */}
              <div className="border rounded">
                <div className="grid grid-cols-2 gap-0 bg-gray-100 border-b">
                  <div className="px-3 py-2 border-r">
                    <span className="text-xs font-bold text-gray-700">üìÑ Original Document</span>
                  </div>
                  <div className="px-3 py-2">
                    <span className="text-xs font-bold text-gray-700">üåê Translation ({targetLanguage})</span>
                  </div>
                </div>
                {/* Edit Mode Toggle and Toolbar - Outside the grid for consistent height */}
                {isInHouseTranslator && translationResults.length > 0 && (
                  <div className="flex items-center justify-between px-2 py-1 bg-gray-100 border-b">
                    <span className="text-[10px] text-gray-600">Mode:</span>
                    <div className="flex gap-1">
                      <button
                        onClick={() => setTranslationEditMode && setTranslationEditMode(false)}
                        className={`px-2 py-0.5 text-[10px] rounded ${!translationEditMode ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 border'}`}
                      >
                        Preview
                      </button>
                      <button
                        onClick={() => setTranslationEditMode && setTranslationEditMode(true)}
                        className={`px-2 py-0.5 text-[10px] rounded ${translationEditMode ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 border'}`}
                      >
                        ‚úèÔ∏è Edit
                      </button>
                    </div>
                  </div>
                )}
                {isInHouseTranslator && translationEditMode && translationResults.length > 0 && (
                  <div className="flex gap-1 px-2 py-1 bg-gray-50 border-b flex-wrap">
                    <button onClick={() => document.execCommand('bold')} className="px-2 py-0.5 text-xs border rounded hover:bg-gray-100 font-bold" title="Bold">B</button>
                    <button onClick={() => document.execCommand('italic')} className="px-2 py-0.5 text-xs border rounded hover:bg-gray-100 italic" title="Italic">I</button>
                    <button onClick={() => document.execCommand('underline')} className="px-2 py-0.5 text-xs border rounded hover:bg-gray-100 underline" title="Underline">U</button>
                    <span className="border-l mx-1"></span>
                    <button onClick={() => document.execCommand('fontSize', false, '2')} className="px-2 py-0.5 text-[10px] border rounded hover:bg-gray-100" title="Small">A-</button>
                    <button onClick={() => document.execCommand('fontSize', false, '4')} className="px-2 py-0.5 text-xs border rounded hover:bg-gray-100" title="Normal">A</button>
                    <button onClick={() => document.execCommand('fontSize', false, '6')} className="px-2 py-0.5 text-sm border rounded hover:bg-gray-100" title="Large">A+</button>
                  </div>
                )}
                <div className="grid grid-cols-2 gap-0 h-[500px] overflow-hidden">
                  {/* Left: Original Document */}
                  <div className="border-r overflow-auto bg-gray-50 p-2">
                    {originalImages.map((img, idx) => (
                      <div key={idx} className="mb-2">
                        {img.filename?.toLowerCase().endsWith('.pdf') ? (
                          <embed
                            src={getImageSrc(img)}
                            type="application/pdf"
                            className="w-full border shadow-sm"
                            style={{height: '480px'}}
                          />
                        ) : (
                          <img
                            src={getImageSrc(img)}
                            alt={img.filename || 'Original'}
                            className="max-w-full border shadow-sm"
                          />
                        )}
                      </div>
                    ))}
                  </div>

                  {/* Right: Translation Result - With Edit Mode for In-House Translators */}
                  <div className="overflow-auto bg-white flex flex-col h-full">
                    {translationResults.length > 0 ? (
                      isInHouseTranslator && translationEditMode ? (
                        <div
                          contentEditable
                          suppressContentEditableWarning
                          className="p-3 overflow-auto focus:outline-none h-full"
                          style={{width: '100%', boxSizing: 'border-box', border: '3px solid #10B981', borderRadius: '4px'}}
                          dangerouslySetInnerHTML={{ __html: extractBodyForEdit(translationResults[0]?.translatedText) }}
                          onBlur={(e) => {
                            // Save edits back to translationResults
                            const newResults = [...translationResults];
                            newResults[0] = { ...newResults[0], translatedText: e.target.innerHTML };
                            setTranslationResults(newResults);
                          }}
                        />
                      ) : (
                        <iframe
                          srcDoc={translationResults[0]?.translatedText || '<p>No translation</p>'}
                          title="Translation"
                          className="w-full h-full border-0"
                        />
                      )
                    ) : (
                      <div className="h-full flex items-center justify-center text-gray-400 text-sm p-4">
                        <div className="text-center">
                          <div className="text-3xl mb-2">üåê</div>
                          <p>Click "Translate" to start</p>
                          <p className="text-xs mt-1">Claude will see the image and translate directly</p>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* Special Instructions for Claude */}
              <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded">
                <label className="block text-xs font-medium text-blue-700 mb-1">
                  üìù Special Instructions for Claude (Optional)
                </label>
                <textarea
                  value={generalInstructions}
                  onChange={(e) => setGeneralInstructions(e.target.value)}
                  placeholder='e.g., "Describe what is written in Arabic between brackets" or "Keep original formatting with tables"'
                  className="w-full px-2 py-1.5 text-xs border rounded h-16 resize-none"
                />
                <p className="text-[10px] text-blue-600 mt-1">
                  These instructions will be sent to Claude along with each page. Max recommended: 5-10 pages at once.
                </p>
              </div>

              {/* Translate Button */}
              <div className="mt-4">
                <button
                  onClick={handleDirectTranslate}
                  disabled={isProcessing || !claudeApiKey}
                  className="w-full py-3 bg-green-600 text-white text-sm font-bold rounded hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                >
                  {isProcessing ? '‚è≥ Translating...' : `üåê Translate ${originalImages.length > 0 ? `(${originalImages.length} page${originalImages.length > 1 ? 's' : ''})` : ''} with Claude AI`}
                </button>
                {!claudeApiKey && (
                  <p className="text-[10px] text-red-500 mt-1 text-center">
                    ‚ö†Ô∏è Please add your API Key in the Setup tab
                  </p>
                )}
              </div>

              {translationResults.length > 0 && (
                <div className="mt-3 p-3 bg-green-50 border border-green-200 rounded">
                  <div className="flex justify-between items-center mb-3">
                    <p className="text-xs text-green-700 font-medium">‚úÖ Translation complete!</p>
                    {/* In-house translators go directly to Proofreading (REVIEW merged into TRANSLATION) */}
                    {isInHouseTranslator ? (
                      <button
                        onClick={() => setActiveSubTab('proofreading')}
                        className="px-3 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700"
                      >
                        Next: Proofreading ‚Üí
                      </button>
                    ) : (
                      <button
                        onClick={() => setActiveSubTab('review')}
                        className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                      >
                        Go to Review ‚Üí
                      </button>
                    )}
                  </div>

                  {/* Correction Command - Also available in Translation tab */}
                  <div className="mb-3 p-3 bg-yellow-50 border border-yellow-200 rounded">
                    <label className="block text-xs font-medium text-gray-700 mb-1">
                      üìù Send Command to Claude (correct/modify translation)
                    </label>
                    <div className="flex space-x-2">
                      <input
                        type="text"
                        value={correctionCommand}
                        onChange={(e) => setCorrectionCommand(e.target.value)}
                        placeholder='e.g., "Fix formatting" or "Change word X to Y"'
                        className="flex-1 px-2 py-1.5 text-xs border rounded"
                      />
                      <button
                        onClick={handleApplyCorrection}
                        disabled={!correctionCommand.trim() || applyingCorrection}
                        className="px-3 py-1.5 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 disabled:bg-gray-300"
                      >
                        {applyingCorrection ? '‚è≥' : '‚ú® Apply'}
                      </button>
                    </div>
                  </div>

                  {/* Download Options */}
                  <div className="flex gap-2 pt-2 border-t border-green-200">
                    <div className="flex-1 relative group">
                      <button
                        onClick={() => {
                          // Download Original as-is
                          originalImages.forEach((img, idx) => {
                            const link = document.createElement('a');
                            link.href = img.data;
                            link.download = `original_${idx + 1}_${img.filename || 'document'}`;
                            link.click();
                          });
                        }}
                        className="w-full px-3 py-2 bg-blue-100 text-blue-700 text-xs rounded hover:bg-blue-200 flex items-center justify-center gap-1"
                      >
                        üìÑ Download Original ({originalImages.length})
                      </button>
                      {/* Dropdown for PDF to Image conversion */}
                      {originalImages.some(img => img.type === 'application/pdf' || img.filename?.toLowerCase().endsWith('.pdf')) && (
                        <button
                          onClick={async () => {
                            setProcessingStatus('Converting PDF to images...');
                            try {
                              for (let idx = 0; idx < originalImages.length; idx++) {
                                const img = originalImages[idx];
                                // If it's already an image, download directly
                                if (img.data.startsWith('data:image')) {
                                  const link = document.createElement('a');
                                  link.href = img.data;
                                  link.download = `original_page_${idx + 1}.png`;
                                  link.click();
                                } else if (img.data.startsWith('data:application/pdf') || img.type === 'application/pdf') {
                                  // Convert PDF to images using backend
                                  const base64Data = img.data.includes(',') ? img.data.split(',')[1] : img.data;
                                  const response = await axios.post(`${API}/admin/pdf-to-images?admin_key=${adminKey}`, {
                                    file_base64: base64Data,
                                    filename: img.filename || 'document.pdf'
                                  });
                                  if (response.data.images) {
                                    response.data.images.forEach((pageImg, pageIdx) => {
                                      const link = document.createElement('a');
                                      link.href = pageImg.data;
                                      link.download = `original_page_${pageIdx + 1}.png`;
                                      link.click();
                                    });
                                  }
                                }
                              }
                              setProcessingStatus('‚úÖ Images downloaded!');
                            } catch (err) {
                              setProcessingStatus('‚ùå Failed to convert: ' + err.message);
                            }
                          }}
                          className="mt-1 w-full px-3 py-1.5 bg-blue-50 text-blue-600 text-[10px] rounded border border-blue-200 hover:bg-blue-100"
                        >
                          üñºÔ∏è Download as Images (PNG)
                        </button>
                      )}
                    </div>
                    <button
                      onClick={() => {
                        // Download Translation as HTML
                        const htmlContent = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>${orderNumber || 'P0000'}_${documentType.replace(/\s+/g, '_')}_Translation</title>
<style>body{font-family:Georgia,serif;max-width:800px;margin:0 auto;padding:40px;line-height:1.8;}</style></head>
<body>${translationResults.map((r, i) => `<div style="margin-bottom:30px;"><h3>Page ${i + 1}</h3>${r.translatedText}</div>`).join('')}</body></html>`;
                        const blob = new Blob([htmlContent], { type: 'text/html' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `${orderNumber || 'P0000'}_${documentType.replace(/\s+/g, '_')}_Translation.html`;
                        link.click();
                      }}
                      className="flex-1 px-3 py-2 bg-blue-100 text-blue-700 text-xs rounded hover:bg-blue-200 flex items-center justify-center gap-1"
                    >
                      üåê Download Translation (HTML)
                    </button>
                    <button
                      onClick={() => {
                        // Download Translation as TXT
                        const extractText = (html) => {
                          const temp = document.createElement('div');
                          temp.innerHTML = html;
                          return temp.textContent || temp.innerText || '';
                        };
                        const txtContent = translationResults.map((r, i) =>
                          `=== PAGE ${i + 1} ===\n\n${extractText(r.translatedText)}\n\n`
                        ).join('');
                        const blob = new Blob([txtContent], { type: 'text/plain' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `${orderNumber || 'P0000'}_${documentType.replace(/\s+/g, '_')}_Translation.txt`;
                        link.click();
                      }}
                      className="flex-1 px-3 py-2 bg-gray-100 text-gray-700 text-xs rounded hover:bg-gray-200 flex items-center justify-center gap-1"
                    >
                      üìù Download Translation (TXT)
                    </button>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Navigation */}
          <div className="mt-4 flex justify-between items-center">
            <button
              onClick={() => setActiveSubTab('start')}
              className="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded hover:bg-gray-300 flex items-center"
            >
              <span className="mr-2">‚Üê</span> Back: Details
            </button>
            {/* In-house translators go directly to Proofreading (REVIEW merged into TRANSLATION) */}
            {isInHouseTranslator ? (
              <button
                onClick={() => setActiveSubTab('proofreading')}
                disabled={translationResults.length === 0}
                className="px-6 py-2 bg-purple-600 text-white text-sm font-medium rounded hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center"
              >
                Next: Proofreading <span className="ml-2">‚Üí</span>
              </button>
            ) : (
              <button
                onClick={() => setActiveSubTab('review')}
                disabled={translationResults.length === 0}
                className="px-6 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center"
              >
                Next: Review <span className="ml-2">‚Üí</span>
              </button>
            )}
          </div>
            </>
          )}

          {/* ============ EXTERNAL TRANSLATION MODE ============ */}
          {workflowMode === 'external' && (
            <>
              {/* Language Selection for External */}
              <div className="mb-4 p-4 bg-green-50 border border-green-200 rounded">
                <h3 className="text-xs font-bold text-green-700 mb-3">üåê Translation Direction</h3>
                <div className="flex items-center justify-center gap-4">
                  <div className="flex-1">
                    <label className="block text-xs text-gray-600 mb-1">From:</label>
                    <select
                      value={sourceLanguage}
                      onChange={(e) => setSourceLanguage(e.target.value)}
                      className="w-full px-3 py-2 text-sm border rounded font-medium"
                    >
                      {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                    </select>
                  </div>
                  <div className="pt-5 text-2xl text-green-500">‚Üí</div>
                  <div className="flex-1">
                    <label className="block text-xs text-gray-600 mb-1">To:</label>
                    <select
                      value={targetLanguage}
                      onChange={(e) => setTargetLanguage(e.target.value)}
                      className="w-full px-3 py-2 text-sm border rounded font-medium"
                    >
                      {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                    </select>
                  </div>
                </div>
              </div>

              {/* Side by Side Upload */}
              <div className="grid grid-cols-2 gap-4 mb-4">
                {/* Original Document Upload */}
                <div className="border-2 border-dashed border-blue-300 rounded-lg p-4 bg-blue-50">
                  <h3 className="text-sm font-bold text-blue-700 mb-2 text-center">üìÑ Original Document</h3>
                  <div
                    className="text-center cursor-pointer hover:bg-blue-100 rounded p-4 transition-colors"
                    onClick={() => externalOriginalInputRef.current?.click()}
                  >
                    <input
                      ref={externalOriginalInputRef}
                      type="file"
                      multiple
                      accept="image/*,.pdf"
                      onChange={handleExternalOriginalUpload}
                      className="hidden"
                    />
                    {externalOriginalImages.length > 0 ? (
                      <div>
                        <div className="text-3xl mb-2">‚úÖ</div>
                        <p className="text-xs text-blue-700 font-medium">{externalOriginalImages.length} file(s) uploaded</p>
                        <div className="mt-2 max-h-32 overflow-auto">
                          {externalOriginalImages.map((img, idx) => (
                            <img key={idx} src={getImageSrc(img)} alt={img.filename || 'Original'} className="max-h-24 mx-auto mb-1 border rounded" />
                          ))}
                        </div>
                        <button className="mt-2 px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                          Change Files
                        </button>
                      </div>
                    ) : (
                      <div>
                        <div className="text-3xl mb-2">üì§</div>
                        <button className="px-3 py-1.5 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                          Upload Original
                        </button>
                        <p className="text-[10px] text-gray-500 mt-1">Image or PDF (auto-converted)</p>
                      </div>
                    )}
                  </div>
                </div>

                {/* Translation Upload */}
                <div className="border-2 border-dashed border-green-300 rounded-lg p-4 bg-green-50">
                  <h3 className="text-sm font-bold text-green-700 mb-2 text-center">üìù Translation (External)</h3>
                  <div
                    className="text-center cursor-pointer hover:bg-green-100 rounded p-4 transition-colors"
                    onClick={() => externalTranslationInputRef.current?.click()}
                  >
                    <input
                      ref={externalTranslationInputRef}
                      type="file"
                      accept=".docx,.doc,.html,.htm,.txt,.pdf,image/*"
                      onChange={handleExternalTranslationUpload}
                      className="hidden"
                    />
                    {externalTranslationText || externalTranslationImages.length > 0 ? (
                      <div>
                        <div className="text-3xl mb-2">‚úÖ</div>
                        <p className="text-xs text-green-700 font-medium">
                          {externalTranslationText ? 'Text uploaded' : `${externalTranslationImages.length} file(s) uploaded`}
                        </p>
                        {/* Show translation image previews */}
                        {externalTranslationImages.length > 0 && (
                          <div className="mt-2 max-h-32 overflow-auto">
                            {externalTranslationImages.map((img, idx) => (
                              <img key={idx} src={getImageSrc(img)} alt={img.filename || 'Translation'} className="max-h-24 mx-auto mb-1 border rounded" />
                            ))}
                          </div>
                        )}
                        <button className="mt-2 px-3 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600">
                          Change File
                        </button>
                      </div>
                    ) : (
                      <div>
                        <div className="text-3xl mb-2">üì§</div>
                        <button className="px-3 py-1.5 bg-green-500 text-white text-xs rounded hover:bg-green-600">
                          Upload Translation
                        </button>
                        <p className="text-[10px] text-gray-500 mt-1">Word, PDF, HTML, TXT, or Image</p>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* Or paste translation text */}
              <div className="mb-4">
                <label className="block text-xs font-medium text-gray-700 mb-2">Or paste translation text directly:</label>
                <textarea
                  value={externalTranslationText}
                  onChange={(e) => setExternalTranslationText(e.target.value)}
                  placeholder="Paste the translated text here..."
                  className="w-full h-40 px-3 py-2 text-sm border rounded font-mono"
                />
              </div>

              {/* Processing Status */}
              {processingStatus && (
                <div className={`mb-4 p-3 rounded text-xs ${
                  processingStatus.includes('‚ùå') ? 'bg-red-100 text-red-700' :
                  processingStatus.includes('‚úÖ') ? 'bg-green-100 text-green-700' :
                  'bg-blue-100 text-blue-700'
                }`}>
                  {processingStatus}
                </div>
              )}

              {/* Navigation for External Mode */}
              <div className="mt-4 flex justify-between items-center">
                <button
                  onClick={() => setActiveSubTab('start')}
                  className="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded hover:bg-gray-300 flex items-center"
                >
                  <span className="mr-2">‚Üê</span> Back: Details
                </button>
                <button
                  onClick={handleExternalToReview}
                  disabled={externalOriginalImages.length === 0 || (!externalTranslationText && externalTranslationImages.length === 0)}
                  className="px-6 py-2 bg-green-600 text-white text-sm font-medium rounded hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center"
                >
                  Go to Review <span className="ml-2">‚Üí</span>
                </button>
              </div>
            </>
          )}

          {/* ============ OCR MODE ============ */}
          {workflowMode === 'ocr' && (
            <>
              {/* File Upload for OCR */}
              <div
                className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-gray-500 transition-colors mb-4"
                onClick={() => fileInputRef.current?.click()}
              >
                <input
                  ref={fileInputRef}
                  type="file"
                  multiple
                  accept="image/*,.pdf"
                  onChange={handleFileSelect}
                  className="hidden"
                />
                <div className="text-3xl mb-2">üìù</div>
                <button className="px-4 py-2 bg-gray-700 text-white text-sm rounded hover:bg-gray-800">
                  Upload Document for OCR
                </button>
                <p className="text-xs text-gray-500 mt-2">
                  {files.length > 0 ? `${files.length} file(s) selected` : 'Images or PDF - Extract text for CAT tools'}
                </p>
              </div>

              {/* OCR Options */}
              {files.length > 0 && (
                <div className="space-y-4 p-4 bg-gray-50 rounded-lg">
                  <div className="flex items-center space-x-4 text-xs">
                    <label className="flex items-center">
                      <input
                        type="radio"
                        checked={!useClaudeOcr}
                        onChange={() => setUseClaudeOcr(false)}
                        className="mr-2"
                      />
                      AWS Textract OCR
                    </label>
                    <label className="flex items-center">
                      <input
                        type="radio"
                        checked={useClaudeOcr}
                        onChange={() => setUseClaudeOcr(true)}
                        className="mr-2"
                      />
                      AI OCR (better formatting)
                    </label>
                  </div>

                  <button
                    onClick={handleOCR}
                    disabled={isProcessing || (useClaudeOcr && !claudeApiKey)}
                    className="w-full py-2 bg-gray-700 text-white text-sm rounded hover:bg-gray-800 disabled:bg-gray-300"
                  >
                    {isProcessing ? processingStatus : 'üîç Extract Text (OCR)'}
                  </button>

                  {/* OCR Results */}
                  {ocrResults.length > 0 && (
                    <div className="border rounded p-3 bg-white">
                      <div className="flex justify-between items-center mb-2">
                        <span className="text-xs font-medium">Extracted Text:</span>
                        <div className="flex items-center space-x-2">
                          <button
                            onClick={() => {
                              const text = ocrResults.map(r => r.text).join('\n\n---\n\n');
                              const blob = new Blob([text], { type: 'text/plain' });
                              const url = URL.createObjectURL(blob);
                              const a = document.createElement('a');
                              a.href = url;
                              a.download = 'ocr_text_for_cat.txt';
                              a.click();
                              URL.revokeObjectURL(url);
                            }}
                            className="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                            title="Download as TXT"
                          >
                            TXT
                          </button>
                          <button
                            onClick={() => {
                              // Use HTML layout if available, otherwise plain text
                              const content = ocrResults.map(r => r.html || `<pre style="white-space: pre-wrap;">${r.text}</pre>`).join('\n<hr style="border: 2px dashed #ccc; margin: 20px 0; page-break-after: always;">\n');
                              const htmlContent = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>OCR Extracted Text - Visual Layout</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
    table { border-collapse: collapse; width: 100%; margin: 10px 0; }
    td, th { border: 1px solid #333; padding: 8px; text-align: left; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    pre { white-space: pre-wrap; word-wrap: break-word; font-family: inherit; }
    @media print { .page-break { page-break-after: always; } }
  </style>
</head>
<body>
  ${content}
</body>
</html>`;
                              const blob = new Blob([htmlContent], { type: 'text/html' });
                              const url = URL.createObjectURL(blob);
                              const a = document.createElement('a');
                              a.href = url;
                              a.download = 'ocr_visual_layout.html';
                              a.click();
                              URL.revokeObjectURL(url);
                            }}
                            className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700"
                            title="Download as HTML (Visual Layout)"
                          >
                            HTML
                          </button>
                          <button
                            onClick={() => {
                              // Use HTML layout if available for Word export
                              const content = ocrResults.map(r => r.html || `<pre style="white-space: pre-wrap;">${r.text}</pre>`).join('\n<br style="page-break-before: always;">\n');
                              const docContent = `<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head>
  <meta charset="UTF-8">
  <title>OCR Extracted Text - Visual Layout</title>
  <!--[if gte mso 9]>
  <xml>
    <w:WordDocument>
      <w:View>Print</w:View>
      <w:Zoom>100</w:Zoom>
    </w:WordDocument>
  </xml>
  <![endif]-->
  <style>
    body { font-family: Arial, sans-serif; margin: 1in; line-height: 1.6; }
    table { border-collapse: collapse; width: 100%; margin: 10px 0; }
    td, th { border: 1px solid #333; padding: 8px; text-align: left; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    pre { white-space: pre-wrap; word-wrap: break-word; font-family: Courier New, monospace; }
  </style>
</head>
<body>
  ${content}
</body>
</html>`;
                              const blob = new Blob([docContent], { type: 'application/msword' });
                              const url = URL.createObjectURL(blob);
                              const a = document.createElement('a');
                              a.href = url;
                              a.download = 'ocr_text_for_cat.doc';
                              a.click();
                              URL.revokeObjectURL(url);
                            }}
                            className="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700"
                            title="Download as Word"
                          >
                            Word
                          </button>
                        </div>
                      </div>
                      {/* View Mode Toggle */}
                      {ocrResults.some(r => r.html) && (
                        <div className="flex items-center gap-2 mb-2 text-xs">
                          <span className="text-gray-600">View:</span>
                          <button
                            onClick={() => setOcrViewMode('text')}
                            className={`px-2 py-1 rounded ${ocrViewMode === 'text' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                          >
                            Plain Text
                          </button>
                          <button
                            onClick={() => setOcrViewMode('html')}
                            className={`px-2 py-1 rounded ${ocrViewMode === 'html' ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                          >
                            Visual Layout
                          </button>
                        </div>
                      )}

                      {/* Text View */}
                      {ocrViewMode === 'text' && (
                        <textarea
                          value={ocrResults.map(r => r.text).join('\n\n---\n\n')}
                          readOnly
                          className="w-full h-40 text-xs font-mono border rounded p-2 bg-gray-50"
                        />
                      )}

                      {/* HTML Visual Layout View */}
                      {ocrViewMode === 'html' && ocrResults.some(r => r.html) && (
                        <div
                          className="w-full h-80 overflow-auto border rounded p-2 bg-white text-xs"
                          dangerouslySetInnerHTML={{
                            __html: ocrResults.map(r => r.html || `<pre>${r.text}</pre>`).join('<hr style="border: 2px dashed #ccc; margin: 20px 0;">')
                          }}
                        />
                      )}
                    </div>
                  )}
                </div>
              )}

              {/* Navigation */}
              <div className="mt-4 flex justify-between">
                <button
                  onClick={() => setActiveSubTab('start')}
                  className="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded hover:bg-gray-300 flex items-center"
                >
                  <span className="mr-2">‚Üê</span> Back: Details
                </button>
                {ocrResults.length > 0 && (
                  <button
                    onClick={() => {
                      // Load OCR text into translation - use HTML if available for better formatting
                      const textToTranslate = ocrResults.map(r => r.html || r.text).join('\n\n--- Page Break ---\n\n');
                      setOriginalText(textToTranslate);
                      setActiveSubTab('translate');
                    }}
                    className="px-6 py-2 bg-green-600 text-white text-sm font-medium rounded hover:bg-green-700 flex items-center"
                  >
                    Go to Translation <span className="ml-2">‚Üí</span>
                  </button>
                )}
              </div>
            </>
          )}

          {/* ============ TEMPLATE MODE ============ */}
          {workflowMode === 'template' && (
            <>
              {/* Template Selection - Non-Certificate Templates */}
              <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                <h3 className="text-xs font-bold text-purple-800 mb-3">üìã Select a Document Template to Fill</h3>
                <p className="text-[10px] text-purple-600 mb-3">Choose a template below, fill in the fields, and save as translation</p>

                <div className="space-y-3">
                  {Object.entries(TEMPLATE_CATEGORIES)
                    .filter(([catKey]) => catKey !== 'certificates')
                    .map(([catKey, category]) => {
                      const templatesInCategory = Object.entries(CERTIFICATE_TEMPLATES).filter(([_, t]) => t.category === catKey);
                      if (templatesInCategory.length === 0) return null;
                      return (
                        <div key={catKey} className="bg-white border rounded p-3">
                          <div className="text-[11px] font-semibold text-gray-700 mb-2 flex items-center gap-1">
                            <span>{category.icon}</span>
                            <span>{category.name}</span>
                            <span className="text-[9px] text-gray-400 font-normal">({templatesInCategory.length})</span>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            {templatesInCategory.map(([key, template]) => (
                              <button
                                key={key}
                                onClick={() => {
                                  setSelectedFillableTemplate(key);
                                  setFillableTemplateData({});
                                  setShowTemplatePreview(true);
                                }}
                                className={`px-3 py-1.5 text-[10px] rounded-lg transition-all ${selectedFillableTemplate === key
                                  ? 'bg-purple-600 text-white font-medium shadow'
                                  : 'bg-gray-100 text-gray-700 hover:bg-purple-100 hover:text-purple-700'}`}
                                title={template.description}
                              >
                                {template.name}
                              </button>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                </div>

                {/* Custom Uploaded Templates */}
                {customCertificateTemplates.filter(t => t.category && t.category !== 'certificates').length > 0 && (
                  <div className="bg-white border border-dashed border-purple-300 rounded p-3 mt-3">
                    <div className="text-[11px] font-semibold text-purple-700 mb-2 flex items-center gap-1">
                      <span>‚≠ê</span>
                      <span>Custom Uploaded Templates</span>
                    </div>
                    <div className="flex flex-wrap gap-2">
                      {customCertificateTemplates
                        .filter(t => t.category && t.category !== 'certificates')
                        .map(tpl => (
                          <div key={tpl.id} className="flex items-center">
                            <button
                              onClick={() => {
                                setSelectedFillableTemplate(`custom-${tpl.id}`);
                                setFillableTemplateData({});
                                setShowTemplatePreview(true);
                              }}
                              className={`px-3 py-1.5 text-[10px] rounded-l-lg transition-all ${selectedFillableTemplate === `custom-${tpl.id}`
                                ? 'bg-purple-600 text-white font-medium shadow'
                                : 'bg-gray-100 text-gray-700 hover:bg-purple-100 hover:text-purple-700'}`}
                            >
                              {tpl.name}
                            </button>
                            {(user?.role === 'admin' || user?.role === 'pm') && (
                              <button
                                onClick={() => {
                                  if (window.confirm(`Delete "${tpl.name}"?`)) {
                                    const updated = customCertificateTemplates.filter(t => t.id !== tpl.id);
                                    setCustomCertificateTemplates(updated);
                                    localStorage.setItem('custom_certificate_templates', JSON.stringify(updated));
                                    if (selectedFillableTemplate === `custom-${tpl.id}`) {
                                      setSelectedFillableTemplate(null);
                                      setShowTemplatePreview(false);
                                    }
                                  }
                                }}
                                className="px-1.5 py-1.5 text-[10px] bg-red-100 text-red-600 rounded-r-lg hover:bg-red-200"
                              >
                                ‚úï
                              </button>
                            )}
                          </div>
                        ))}
                    </div>
                  </div>
                )}

                {/* Upload Template Section for Admin/PM */}
                {(user?.role === 'admin' || user?.role === 'pm') && (
                  <div className="mt-4 pt-4 border-t border-purple-200">
                    <div className="flex items-center justify-between">
                      <span className="text-[10px] text-purple-700 font-medium">Upload Custom Template (Admin/PM only)</span>
                      <input
                        type="file"
                        accept=".html,.htm"
                        onChange={(e) => {
                          const file = e.target.files?.[0];
                          if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                              const htmlContent = event.target?.result;
                              const name = prompt('Template name:');
                              if (name && htmlContent) {
                                const category = prompt('Category (rmv-forms, brazil-docs, education):') || 'brazil-docs';
                                const newTemplate = {
                                  id: Date.now(),
                                  name,
                                  description: 'Uploaded template',
                                  category,
                                  isForm: true,
                                  formHTML: htmlContent
                                };
                                const updated = [...customCertificateTemplates, newTemplate];
                                setCustomCertificateTemplates(updated);
                                localStorage.setItem('custom_certificate_templates', JSON.stringify(updated));
                                showToast(`Template "${name}" uploaded successfully!`);
                              }
                            };
                            reader.readAsText(file);
                          }
                        }}
                        className="hidden"
                        id="template-upload-input"
                      />
                      <label
                        htmlFor="template-upload-input"
                        className="px-3 py-1.5 bg-purple-100 text-purple-700 text-[10px] rounded-lg cursor-pointer hover:bg-purple-200 transition-colors"
                      >
                        üì§ Upload HTML Template
                      </label>
                    </div>
                  </div>
                )}
              </div>

              {/* Template Preview and Fill Interface */}
              {showTemplatePreview && selectedFillableTemplate && (
                <div className="border-2 border-purple-300 rounded-lg overflow-hidden">
                  <div className="bg-purple-100 px-4 py-2 flex items-center justify-between">
                    <h4 className="text-sm font-bold text-purple-800">
                      üìã {CERTIFICATE_TEMPLATES[selectedFillableTemplate]?.name ||
                          (selectedFillableTemplate?.startsWith('custom-') ?
                            customCertificateTemplates.find(t => t.id === parseInt(selectedFillableTemplate.replace('custom-', '')))?.name
                            : 'Template')}
                    </h4>
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => {
                          setShowTemplatePreview(false);
                          setSelectedFillableTemplate(null);
                        }}
                        className="px-2 py-1 bg-gray-200 text-gray-600 text-xs rounded hover:bg-gray-300"
                      >
                        ‚úï Close
                      </button>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-0 h-[600px]">
                    {/* Left Side - Original Document Preview */}
                    <div className="border-r border-purple-200 bg-gray-50 p-4 overflow-auto">
                      <div className="text-xs font-bold text-gray-600 mb-2 flex items-center gap-2">
                        üìÑ Original Document (Reference)
                        {selectedProjectFiles.length > 0 && (
                          <select
                            className="ml-2 text-xs border rounded px-2 py-1"
                            onChange={(e) => {
                              const fileId = parseInt(e.target.value);
                              const doc = selectedProjectFiles.find(f => f.id === fileId);
                              if (doc) loadProjectFile(doc);
                            }}
                            value={selectedFileId || ''}
                          >
                            <option value="">Select file...</option>
                            {selectedProjectFiles.map(doc => (
                              <option key={doc.id} value={doc.id}>{doc.filename}</option>
                            ))}
                          </select>
                        )}
                      </div>
                      {uploadedImagePreview ? (
                        <img src={uploadedImagePreview} alt="Original Document" className="max-w-full border rounded shadow" />
                      ) : (
                        <div className="h-full flex items-center justify-center text-gray-400 text-sm">
                          <div className="text-center">
                            <div className="text-4xl mb-2">üìÑ</div>
                            <p>Load a document from project files</p>
                            <p className="text-xs mt-1">or upload an image to reference</p>
                            <input
                              type="file"
                              accept="image/*,.pdf"
                              onChange={handleFileSelect}
                              className="hidden"
                              id="template-reference-upload"
                            />
                            <label
                              htmlFor="template-reference-upload"
                              className="mt-3 inline-block px-3 py-1.5 bg-blue-100 text-blue-700 text-xs rounded cursor-pointer hover:bg-blue-200"
                            >
                              üì§ Upload Reference
                            </label>
                          </div>
                        </div>
                      )}
                    </div>

                    {/* Right Side - Fillable Template */}
                    <div className="bg-white p-4 overflow-auto">
                      <div className="text-xs font-bold text-gray-600 mb-2">‚úèÔ∏è Fill Template Below</div>
                      <div
                        id="fillable-template-container"
                        className="template-form"
                        dangerouslySetInnerHTML={{
                          __html: (() => {
                            // Get template from either CERTIFICATE_TEMPLATES or custom templates
                            let template = CERTIFICATE_TEMPLATES[selectedFillableTemplate];
                            if (!template && selectedFillableTemplate?.startsWith('custom-')) {
                              const customId = parseInt(selectedFillableTemplate.replace('custom-', ''));
                              template = customCertificateTemplates.find(t => t.id === customId);
                            }
                            if (!template) return '<div class="text-gray-400 text-center p-8">Select a template</div>';

                            if (template.isForm && template.formHTML) {
                              return template.formHTML
                                .replace(/\{\{LOGO_LEFT\}\}/g, logoLeft ? `<img src="${logoLeft}" style="max-height: 60px; max-width: 120px;" />` : '')
                                .replace(/\{\{LOGO_RIGHT\}\}/g, logoRight ? `<img src="${logoRight}" style="max-height: 60px; max-width: 80px;" />` : '')
                                .replace(/\{\{LOGO_STAMP\}\}/g, logoStamp ? `<img src="${logoStamp}" style="max-height: 60px; max-width: 60px;" />` : '');
                            }
                            return `<div class="p-4">${template.bodyParagraphs?.map(p => `<p class="mb-3">${p}</p>`).join('') || ''}</div>`;
                          })()
                        }}
                      />
                    </div>
                  </div>

                  {/* Action Buttons */}
                  <div className="bg-purple-50 px-4 py-3 flex items-center justify-between border-t border-purple-200">
                    <div className="text-[10px] text-purple-600">
                      Fill in the template fields, then save as translation
                    </div>
                    <div className="flex items-center gap-2">
                      <button
                        onClick={async () => {
                          // Get the filled template content
                          const container = document.getElementById('fillable-template-container');
                          if (container && selectedOrderId) {
                            const filledContent = container.innerHTML;

                            try {
                              setProcessingStatus('Saving translation...');

                              // Save directly to backend
                              const response = await axios.post(`${API}/admin/orders/${selectedOrderId}/translation?admin_key=${adminKey}`, {
                                translation_html: filledContent,
                                translation_original_text: '',
                                source_language: sourceLanguage || 'Portuguese',
                                target_language: targetLanguage || 'English',
                                document_type: documentType || 'Document',
                                translator_name: user?.name || 'Translator',
                                translation_date: new Date().toISOString().split('T')[0],
                                include_cover: false,
                                page_format: 'letter',
                                translation_type: translationType || 'certified',
                                original_images: uploadedImagePreview ? [{ filename: 'original.jpg', data: uploadedImagePreview }] : [],
                                logo_left: logoLeft,
                                logo_right: logoRight,
                                logo_stamp: logoStamp,
                                signature_image: signatureImage,
                                send_to: 'save',
                                submitted_by: user?.name || 'Unknown',
                                submitted_by_role: user?.role || 'unknown'
                              });

                              if (response.data.status === 'success' || response.data.success) {
                                setTranslatedText(filledContent);
                                setProcessingStatus('‚úÖ Translation saved successfully to the system!');
                                setTimeout(() => {
                                  setProcessingStatus('');
                                  setActiveSubTab('review');
                                }, 2000);
                              } else {
                                setProcessingStatus('‚ùå Error saving translation. Please try again.');
                              }
                            } catch (error) {
                              console.error('Error saving translation:', error);
                              setProcessingStatus('‚ùå Error saving translation: ' + (error.response?.data?.error || error.message));
                            }
                          } else if (!selectedOrderId) {
                            setProcessingStatus('‚ö†Ô∏è Please select an order first from the START tab.');
                          }
                        }}
                        disabled={!selectedOrderId}
                        className={`px-4 py-2 text-white text-sm font-medium rounded flex items-center gap-2 ${selectedOrderId ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-400 cursor-not-allowed'}`}
                      >
                        üíæ Save as Translation
                      </button>
                      <button
                        onClick={() => setActiveSubTab('review')}
                        className="px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded hover:bg-purple-700 flex items-center gap-2"
                      >
                        Go to Review ‚Üí
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Navigation */}
              <div className="mt-4 flex justify-between items-center">
                <button
                  onClick={() => setActiveSubTab('start')}
                  className="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded hover:bg-gray-300 flex items-center"
                >
                  <span className="mr-2">‚Üê</span> Back: Details
                </button>
                {selectedFillableTemplate && (
                  <button
                    onClick={() => setActiveSubTab('review')}
                    className="px-6 py-2 bg-purple-600 text-white text-sm font-medium rounded hover:bg-purple-700 flex items-center"
                  >
                    Go to Review <span className="ml-2">‚Üí</span>
                  </button>
                )}
              </div>
            </>
          )}

        </div>
      )}

      {/* AI PIPELINE TAB */}
      {activeSubTab === 'ai-pipeline' && (
        <div className="bg-white rounded shadow p-4">
          <h2 className="text-sm font-bold mb-4">ü§ñ AI Translation Pipeline</h2>

          {!selectedOrderId ? (
            <div className="text-center py-8 text-gray-500">
              <div className="text-4xl mb-3">üìã</div>
              <p>Please select an order from the START tab first</p>
              <button
                onClick={() => setActiveSubTab('start')}
                className="mt-3 px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700"
              >
                Go to START
              </button>
            </div>
          ) : (
            <>
              {/* Project Files Section - Load documents here */}
              <div className="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-4 mb-4">
                <h3 className="text-xs font-bold text-blue-800 mb-3">üìÅ Project Documents - Select to Load</h3>

                {loadingProjectFiles ? (
                  <div className="text-sm text-gray-500 text-center py-4">Loading files...</div>
                ) : selectedProjectFiles.length > 0 ? (
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                    {selectedProjectFiles.map((doc, idx) => (
                      <div
                        key={doc.id}
                        className={`p-3 rounded-lg transition-all ${
                          selectedFileId === doc.id
                            ? 'bg-green-100 border-2 border-green-500 shadow-md'
                            : 'bg-white border border-gray-200 hover:bg-blue-100 hover:border-blue-400 hover:shadow'
                        }`}
                      >
                        <div
                          onClick={() => loadProjectFile(doc)}
                          className="flex items-center gap-3 cursor-pointer"
                        >
                          <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-lg ${
                            selectedFileId === doc.id ? 'bg-green-500 text-white' : 'bg-gray-100'
                          }`}>
                            {doc.filename?.toLowerCase().endsWith('.pdf') ? 'üìÑ' : 'üñºÔ∏è'}
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className={`text-sm font-medium truncate ${
                              selectedFileId === doc.id ? 'text-green-700' : 'text-gray-700'
                            }`}>
                              {doc.filename || `File ${idx + 1}`}
                            </div>
                            <div className="text-xs text-gray-400">
                              {selectedFileId === doc.id ? '‚úì Loaded - Ready' : 'Click to load'}
                            </div>
                          </div>
                          {selectedFileId === doc.id && (
                            <div className="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-sm">
                              ‚úì
                            </div>
                          )}
                        </div>
                        {/* Use filename for Cover */}
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const filename = doc.filename || 'Document';
                            const nameWithoutExt = filename.replace(/\.[^/.]+$/, '').replace(/_/g, ' ').replace(/-/g, ' ');
                            setDocumentType(nameWithoutExt);
                            setProcessingStatus(`‚úÖ Document type: "${nameWithoutExt}"`);
                          }}
                          className="mt-2 w-full px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200 transition-colors"
                          title="Use this filename for Cover Letter"
                        >
                          üìã Use for Cover
                        </button>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-4">
                    <p className="text-sm text-gray-500 mb-3">No documents found in this project</p>
                    <button
                      onClick={() => setActiveSubTab('start')}
                      className="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700"
                    >
                      Upload Document in START tab
                    </button>
                  </div>
                )}

                {originalImages.length > 0 && (
                  <div className="mt-3 p-2 bg-green-100 border border-green-300 rounded text-sm text-green-700">
                    ‚úÖ Document loaded: {originalImages[0]?.filename || 'Ready'} ({originalImages.length} page{originalImages.length > 1 ? 's' : ''})
                  </div>
                )}
              </div>

              {/* Processing Status */}
              {processingStatus && (
                <div className={`mt-3 p-2 rounded text-xs ${
                  processingStatus.includes('‚ùå') ? 'bg-red-100 text-red-700' :
                  processingStatus.includes('‚úÖ') ? 'bg-green-100 text-green-700' :
                  'bg-blue-100 text-blue-700'
                }`}>
                  {processingStatus}
                </div>
              )}
            </>
          )}
        </div>
      )}

      {/* REVIEW TAB - Side-by-side Original + Translation Review */}
      {activeSubTab === 'review' && (
        <div className="bg-white rounded shadow p-4">
          <h2 className="text-sm font-bold mb-2">üìã Review Translation</h2>

          {/* Upload Translation */}
          <div className="mb-4 p-3 bg-gray-50 rounded-lg border">
            <label className="flex items-center justify-center px-4 py-2 bg-green-500 text-white text-sm rounded cursor-pointer hover:bg-green-600 transition">
              üìÑ Upload Translation (Word/HTML/TXT)
              <input
                type="file"
                accept=".docx,.doc,.html,.htm,.txt,.pdf,image/*"
                multiple
                onChange={async (e) => {
                  const files = Array.from(e.target.files);
                  if (files.length === 0) return;
                  setProcessingStatus('Processing uploaded translation...');
                  for (const file of files) {
                    const fileName = file.name.toLowerCase();
                    try {
                      if (fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
                        const html = await convertWordToHtml(file);
                        setTranslationResults(prev => [...prev, { translatedText: html, originalText: '', filename: file.name }]);
                      } else if (fileName.endsWith('.html') || fileName.endsWith('.htm')) {
                        const html = await readHtmlFile(file);
                        setTranslationResults(prev => [...prev, { translatedText: html, originalText: '', filename: file.name }]);
                      } else if (fileName.endsWith('.txt')) {
                        const text = await readTxtFile(file);
                        const html = `<div style="white-space: pre-wrap; font-family: 'Times New Roman', serif; font-size: 12pt;">${text}</div>`;
                        setTranslationResults(prev => [...prev, { translatedText: html, originalText: '', filename: file.name }]);
                      } else if (fileName.endsWith('.pdf')) {
                        setProcessingStatus(`Converting PDF: ${file.name}...`);
                        const images = await convertPdfToImages(file, (page, total) => {
                          setProcessingStatus(`Converting PDF page ${page}/${total}`);
                        });
                        images.forEach((img, idx) => {
                          const imgHtml = `<div style="text-align:center;"><img src="data:${img.type};base64,${img.data}" style="max-width:100%; height:auto;" alt="${file.name} page ${idx + 1}" /></div>`;
                          setTranslationResults(prev => [...prev, { translatedText: imgHtml, originalText: '', filename: `${file.name} - Page ${idx + 1}` }]);
                        });
                      } else if (file.type.startsWith('image/')) {
                        const dataUrl = await new Promise((resolve) => {
                          const reader = new FileReader();
                          reader.onload = () => resolve(reader.result);
                          reader.readAsDataURL(file);
                        });
                        const html = `<div style="text-align:center;"><img src="${dataUrl}" style="max-width:100%; height:auto;" alt="${file.name}" /></div>`;
                        setTranslationResults(prev => [...prev, { translatedText: html, originalText: '', filename: file.name }]);
                      }
                    } catch (err) {
                      console.error('Upload error:', err);
                      setProcessingStatus(`Error: ${file.name}`);
                    }
                  }
                  setProcessingStatus('Translation uploaded!');
                  setTimeout(() => setProcessingStatus(''), 3000);
                  e.target.value = '';
                }}
                className="hidden"
              />
            </label>
            {translationResults.length > 0 && (
              <p className="text-xs text-green-600 mt-1 text-center">Translation loaded</p>
            )}
          </div>

          {/* Processing Status */}
          {processingStatus && (
            <div className={`mb-3 p-3 rounded text-sm font-medium ${
              processingStatus.includes('Error') ? 'bg-red-100 text-red-700 border border-red-300' :
              processingStatus.includes('uploaded') || processingStatus.includes('loaded') ? 'bg-green-100 text-green-700 border border-green-300' :
              'bg-blue-100 text-blue-700 border border-blue-300 animate-pulse'
            }`}>
              {processingStatus}
            </div>
          )}

          {translationResults.length > 0 ? (
            <>
              {/* Document selector */}
              {translationResults.length > 1 && (
                <div className="mb-3">
                  <label className="text-xs text-gray-600 mr-2">Document:</label>
                  <select
                    value={selectedResultIndex}
                    onChange={(e) => setSelectedResultIndex(Number(e.target.value))}
                    className="px-2 py-1 text-xs border rounded"
                  >
                    {translationResults.map((r, idx) => (
                      <option key={idx} value={idx}>{r.filename || `Page ${idx + 1}`}</option>
                    ))}
                  </select>
                </div>
              )}

              {/* View Mode Toggle + Download */}
              <div className="flex items-center gap-2 mb-2">
                <div className="inline-flex rounded-md shadow-sm" role="group">
                  <button
                    onClick={() => setReviewViewMode('preview')}
                    className={`px-3 py-1 text-xs font-medium rounded-l-md border ${
                      reviewViewMode === 'preview'
                        ? 'bg-blue-600 text-white border-blue-600'
                        : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
                    }`}
                  >
                    Preview
                  </button>
                  <button
                    onClick={() => setReviewViewMode('edit')}
                    className={`px-3 py-1 text-xs font-medium rounded-r-md border-t border-b border-r ${
                      reviewViewMode === 'edit'
                        ? 'bg-blue-600 text-white border-blue-600'
                        : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
                    }`}
                  >
                    Edit
                  </button>
                </div>
                <button
                  onClick={() => {
                    const content = translationResults[selectedResultIndex]?.translatedText || '';
                    const blob = new Blob([`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Translation</title></head><body>${content}</body></html>`], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `translation_${orderNumber || 'document'}.html`;
                    a.click();
                    URL.revokeObjectURL(url);
                  }}
                  className="px-3 py-1 text-xs font-medium bg-green-600 text-white rounded hover:bg-green-700"
                >
                  Download
                </button>
              </div>

              {/* Side by side view: Original | Translation */}
              <div className="border rounded mb-4">
                <div className="grid grid-cols-2 gap-0 bg-gray-100 border-b">
                  <div className="px-3 py-2 border-r flex items-center justify-between">
                    <span className="text-xs font-bold text-gray-700">Original Document</span>
                    <label className="px-2 py-1 bg-blue-500 text-white text-[10px] rounded cursor-pointer hover:bg-blue-600">
                      Upload
                      <input
                        type="file"
                        accept="image/*,.pdf"
                        className="hidden"
                        onChange={(e) => {
                          if (e.target.files && e.target.files[0]) {
                            const file = e.target.files[0];
                            const reader = new FileReader();
                            reader.onload = (event) => {
                              const newOriginalImages = [...originalImages];
                              newOriginalImages[selectedResultIndex] = {
                                data: event.target.result,
                                filename: file.name
                              };
                              setOriginalImages(newOriginalImages);
                            };
                            reader.readAsDataURL(file);
                          }
                        }}
                      />
                    </label>
                  </div>
                  <div className="px-3 py-2 flex items-center justify-between">
                    <span className="text-xs font-bold text-gray-700">
                      Translation ({targetLanguage}) - {reviewViewMode === 'preview' ? 'Preview' : 'Editing'}
                    </span>
                  </div>
                </div>
                {/* Toolbar outside the height-constrained grid */}
                {reviewViewMode === 'edit' && (
                  <div className="flex items-center space-x-1 bg-gray-100 px-2 py-1 border-b">
                    <button onMouseDown={(e) => { e.preventDefault(); execFormatCommand('bold'); }} className="px-2 py-1 text-xs font-bold bg-white border rounded hover:bg-gray-200" title="Bold">B</button>
                    <button onMouseDown={(e) => { e.preventDefault(); execFormatCommand('italic'); }} className="px-2 py-1 text-xs italic bg-white border rounded hover:bg-gray-200" title="Italic">I</button>
                    <button onMouseDown={(e) => { e.preventDefault(); execFormatCommand('underline'); }} className="px-2 py-1 text-xs underline bg-white border rounded hover:bg-gray-200" title="Underline">U</button>
                    <div className="w-px h-5 bg-gray-300 mx-1"></div>
                    <button onMouseDown={(e) => { e.preventDefault(); execFormatCommand('decreaseFontSize'); }} className="px-2 py-1 text-xs bg-white border rounded hover:bg-gray-200">A-</button>
                    <button onMouseDown={(e) => { e.preventDefault(); execFormatCommand('increaseFontSize'); }} className="px-2 py-1 text-xs bg-white border rounded hover:bg-gray-200">A+</button>
                    <div className="w-px h-5 bg-gray-300 mx-1"></div>
                    <button onMouseDown={(e) => { e.preventDefault(); execFormatCommand('justifyLeft'); }} className="px-2 py-1 text-xs bg-white border rounded hover:bg-gray-200" title="Align Left">‚¨Ö</button>
                    <button onMouseDown={(e) => { e.preventDefault(); execFormatCommand('justifyCenter'); }} className="px-2 py-1 text-xs bg-white border rounded hover:bg-gray-200" title="Center">‚¨å</button>
                    <button onMouseDown={(e) => { e.preventDefault(); execFormatCommand('justifyRight'); }} className="px-2 py-1 text-xs bg-white border rounded hover:bg-gray-200" title="Align Right">‚û°</button>
                  </div>
                )}
                <div className="grid grid-cols-2 gap-0 h-[384px] overflow-hidden">
                  {/* Left: Original Document */}
                  <div className="border-r overflow-auto bg-gray-50 p-2" ref={originalTextRef} onScroll={() => handleScroll('original')}>
                    {originalImages[selectedResultIndex] ? (
                      originalImages[selectedResultIndex].filename?.toLowerCase().endsWith('.pdf') ? (
                        <embed src={getImageSrc(originalImages[selectedResultIndex])} type="application/pdf" className="w-full border shadow-sm" style={{height: '380px'}} />
                      ) : (
                        <img src={getImageSrc(originalImages[selectedResultIndex])} alt={originalImages[selectedResultIndex].filename || 'Original'} className="max-w-full border shadow-sm" />
                      )
                    ) : translationResults[selectedResultIndex]?.original ? (
                      <img src={translationResults[selectedResultIndex].original} alt="Original" className="max-w-full border shadow-sm" />
                    ) : (
                      <div className="flex items-center justify-center h-full text-gray-400 text-xs">
                        <div className="text-center">
                          <p>No original document</p>
                          <p className="mt-1">Click "Upload" above to add</p>
                        </div>
                      </div>
                    )}
                  </div>
                  {/* Right: Translation */}
                  <div className="overflow-hidden bg-white flex flex-col h-full" ref={translatedTextRef} onScroll={() => handleScroll('translated')}>
                    {reviewViewMode === 'preview' ? (
                      <iframe
                        srcDoc={translationResults[selectedResultIndex]?.translatedText || '<p>No translation</p>'}
                        title="Translation Preview"
                        className="w-full h-full border-0"
                      />
                    ) : (
                      <div
                        ref={editableRef}
                        contentEditable
                        suppressContentEditableWarning
                        dangerouslySetInnerHTML={{ __html: extractBodyForEdit(translationResults[selectedResultIndex]?.translatedText) }}
                        onBlur={(e) => handleTranslationEdit(e.target.innerHTML)}
                        onMouseUp={saveSelection}
                        onKeyUp={saveSelection}
                        className="p-3 text-xs focus:outline-none overflow-auto h-full"
                        style={{width: '100%', boxSizing: 'border-box', border: '3px solid #10B981', borderRadius: '4px'}}
                      />
                    )}
                  </div>
                </div>
              </div>

              {/* Navigation and Send Buttons */}
              <div className="mt-4 flex justify-between items-center">
                <div className="flex gap-2">
                  <button
                    onClick={() => setActiveSubTab('translate')}
                    className="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded hover:bg-gray-300"
                  >
                    Back: Translation
                  </button>
                  <button
                    onClick={() => sendToProjects('save')}
                    disabled={sendingToProjects || translationResults.length === 0}
                    className="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 disabled:bg-gray-300"
                  >
                    Save
                  </button>
                </div>
                <div className="flex gap-2">
                  {/* Contractor: Only Send to PM */}
                  {isContractor && (
                    <button
                      onClick={async () => {
                        const success = await sendToProjects('pm');
                        if (success) {
                          showToast('Translation sent to PM!');
                          // Data clearing is now handled inside sendToProjects on success
                        }
                        // If failed, data is preserved and user can retry
                      }}
                      disabled={sendingToProjects}
                      className="px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded hover:bg-purple-700 disabled:bg-gray-300"
                    >
                      Send to PM
                    </button>
                  )}

                  {/* PM/Admin/In-House Translator: Next to Proofreading - In-House must complete all steps */}
                  {(isAdmin || isPM || isInHouseTranslator) && (
                    <button
                      onClick={() => setActiveSubTab('proofreading')}
                      className="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded hover:bg-indigo-700"
                    >
                      Next: Proofreading
                    </button>
                  )}
                </div>
              </div>
            </>
          ) : (
            <div className="py-4">
              {/* Show orders with saved translations */}
              <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h3 className="text-sm font-bold text-blue-800 mb-3">Projects with Translation to Review</h3>
                <p className="text-xs text-gray-600 mb-3">Select a project to load a saved translation:</p>

                {assignedOrders.filter(o => o.translation_ready || o.translation_html).length > 0 ? (
                  <div className="space-y-2 max-h-64 overflow-y-auto">
                    {assignedOrders.filter(o => o.translation_ready || o.translation_html).map(order => (
                      <div
                        key={order.id}
                        onClick={async () => {
                          setSelectedOrderId(order.id);
                          setOrderNumber(order.order_number);
                          const loaded = await loadSavedTranslation(order);
                          if (loaded) {
                            setProcessingStatus(`Translation for ${order.order_number} loaded!`);
                          }
                        }}
                        className="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg cursor-pointer hover:bg-green-50 hover:border-green-400 transition-all"
                      >
                        <div className="flex items-center gap-3">
                          <span className="text-lg">üìù</span>
                          <div>
                            <div className="font-medium text-sm text-gray-800">{order.order_number}</div>
                            <div className="text-xs text-gray-500">{order.client_name || order.partner_name}</div>
                          </div>
                        </div>
                        <span className="text-green-600">‚Üí</span>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="text-xs text-gray-500 text-center py-4">No projects with saved translation found.</p>
                )}
              </div>

              <div className="text-center py-4 border-t border-gray-200">
                <p className="text-xs text-gray-500 mb-3">Or start a new translation:</p>
                <button
                  onClick={() => setActiveSubTab('translate')}
                  className="px-4 py-2 bg-blue-600 text-white text-xs rounded hover:bg-blue-700"
                >
                  Go to Translation
                </button>
              </div>
            </div>
          )}
        </div>
      )}

      {/* PROOFREADING TAB - Admin, PM, and In-House Translators */}
      {activeSubTab === 'proofreading' && (isAdmin || isPM || isInHouseTranslator) && (
        <div className="bg-white rounded shadow p-4">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-sm font-bold">üîç Proofreading & Quality Assurance</h2>
            {translationResults.length > 0 && (
              <button
                onClick={() => {
                  const content = translationResults[selectedResultIndex]?.translatedText || '';
                  const blob = new Blob([`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Translation</title></head><body>${content}</body></html>`], { type: 'text/html' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `translation_${orderNumber || 'document'}.html`;
                  a.click();
                  URL.revokeObjectURL(url);
                }}
                className="px-3 py-1 text-xs font-medium bg-green-600 text-white rounded hover:bg-green-700"
                title="Download Translation"
              >
                ‚¨áÔ∏è Download
              </button>
            )}
          </div>

          {translationResults.length > 0 ? (
            <>
              {/* Document selector */}
              {translationResults.length > 1 && (
                <div className="mb-3">
                  <label className="text-xs text-gray-600 mr-2">Document:</label>
                  <select
                    value={selectedResultIndex}
                    onChange={(e) => setSelectedResultIndex(Number(e.target.value))}
                    className="px-2 py-1 text-xs border rounded"
                  >
                    {translationResults.map((r, idx) => (
                      <option key={idx} value={idx}>{r.filename}</option>
                    ))}
                  </select>
                </div>
              )}

              {/* Original and Translation Side by Side - Same layout as REVIEW tab */}
              <div className="border rounded mb-4">
                <div className="grid grid-cols-2 gap-0 bg-gray-100 border-b">
                  <div className="px-3 py-2 border-r flex items-center justify-between">
                    <span className="text-xs font-bold text-gray-700">Original Document ({sourceLanguage})</span>
                    <label className="px-2 py-1 bg-blue-500 text-white text-[10px] rounded cursor-pointer hover:bg-blue-600">
                      Upload
                      <input
                        type="file"
                        accept="image/*,.pdf"
                        className="hidden"
                        onChange={(e) => {
                          if (e.target.files && e.target.files[0]) {
                            const file = e.target.files[0];
                            const reader = new FileReader();
                            reader.onload = (event) => {
                              const newOriginalImages = [...originalImages];
                              newOriginalImages[selectedResultIndex] = {
                                data: event.target.result,
                                filename: file.name
                              };
                              setOriginalImages(newOriginalImages);
                            };
                            reader.readAsDataURL(file);
                          }
                        }}
                      />
                    </label>
                  </div>
                  <div className="px-3 py-2 flex items-center justify-between">
                    <span className="text-xs font-bold text-gray-700">
                      Translation ({targetLanguage}) - {proofreadingViewMode === 'preview' ? 'Preview' : 'Editing'}
                    </span>
                    <div className="flex items-center gap-1">
                      <button
                        onClick={() => setProofreadingViewMode('preview')}
                        className={`px-2 py-0.5 text-[10px] rounded ${proofreadingViewMode === 'preview' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 border'}`}
                      >
                        Preview
                      </button>
                      <button
                        onClick={() => setProofreadingViewMode('edit')}
                        className={`px-2 py-0.5 text-[10px] rounded ${proofreadingViewMode === 'edit' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 border'}`}
                      >
                        Edit
                      </button>
                    </div>
                  </div>
                </div>
                {/* Toolbar outside the height-constrained grid */}
                {proofreadingViewMode === 'edit' && (
                  <div className="flex items-center space-x-1 bg-gray-100 px-2 py-1 border-b">
                    <button onMouseDown={(e) => { e.preventDefault(); execFormatCommand('bold'); }} className="px-2 py-1 text-xs font-bold bg-white border rounded hover:bg-gray-200">B</button>
                    <button onMouseDown={(e) => { e.preventDefault(); execFormatCommand('italic'); }} className="px-2 py-1 text-xs italic bg-white border rounded hover:bg-gray-200">I</button>
                    <button onMouseDown={(e) => { e.preventDefault(); execFormatCommand('underline'); }} className="px-2 py-1 text-xs underline bg-white border rounded hover:bg-gray-200">U</button>
                    <div className="w-px h-5 bg-gray-300 mx-1"></div>
                    <button onMouseDown={(e) => { e.preventDefault(); execFormatCommand('decreaseFontSize'); }} className="px-2 py-1 text-xs bg-white border rounded hover:bg-gray-200">A-</button>
                    <button onMouseDown={(e) => { e.preventDefault(); execFormatCommand('increaseFontSize'); }} className="px-2 py-1 text-xs bg-white border rounded hover:bg-gray-200">A+</button>
                    <div className="w-px h-5 bg-gray-300 mx-1"></div>
                    <button onMouseDown={(e) => { e.preventDefault(); execFormatCommand('justifyLeft'); }} className="px-2 py-1 text-xs bg-white border rounded hover:bg-gray-200" title="Align Left">‚¨Ö</button>
                    <button onMouseDown={(e) => { e.preventDefault(); execFormatCommand('justifyCenter'); }} className="px-2 py-1 text-xs bg-white border rounded hover:bg-gray-200" title="Center">‚¨å</button>
                    <button onMouseDown={(e) => { e.preventDefault(); execFormatCommand('justifyRight'); }} className="px-2 py-1 text-xs bg-white border rounded hover:bg-gray-200" title="Align Right">‚û°</button>
                  </div>
                )}
                <div className="grid grid-cols-2 gap-0 h-[600px] overflow-hidden">
                  {/* Left: Original Document */}
                  <div className="border-r overflow-auto bg-gray-50 p-2">
                    {originalImages[selectedResultIndex] ? (
                      originalImages[selectedResultIndex].filename?.toLowerCase().endsWith('.pdf') ? (
                        <embed src={getImageSrc(originalImages[selectedResultIndex])} type="application/pdf" className="w-full border shadow-sm" style={{height: '580px'}} />
                      ) : (
                        <img src={getImageSrc(originalImages[selectedResultIndex])} alt={originalImages[selectedResultIndex].filename || 'Original'} className="max-w-full border shadow-sm" />
                      )
                    ) : translationResults[selectedResultIndex]?.original ? (
                      // Show original image from external upload
                      <img src={translationResults[selectedResultIndex].original} alt="Original" className="max-w-full border shadow-sm" />
                    ) : (ocrResults[selectedResultIndex]?.text || translationResults[selectedResultIndex]?.originalText) ? (
                      <div className="text-xs whitespace-pre-wrap p-2">
                        {ocrResults[selectedResultIndex]?.text || translationResults[selectedResultIndex]?.originalText}
                      </div>
                    ) : (
                      <div className="flex items-center justify-center h-full text-gray-400 text-xs">
                        <div className="text-center">
                          <p>No original document</p>
                          <p className="mt-1">Click "Upload" above to add</p>
                        </div>
                      </div>
                    )}
                  </div>
                  {/* Right: Translation */}
                  <div className="overflow-hidden bg-white flex flex-col h-full">
                    {proofreadingViewMode === 'preview' ? (
                      <iframe
                        srcDoc={getHighlightedTranslation()}
                        title="Translation Preview"
                        className="w-full h-full border-0 translation-preview-iframe"
                      />
                    ) : (
                      <div
                        contentEditable
                        suppressContentEditableWarning
                        dangerouslySetInnerHTML={{ __html: extractBodyForEdit(translationResults[selectedResultIndex]?.translatedText) }}
                        onBlur={(e) => handleTranslationEdit(e.target.innerHTML)}
                        onMouseUp={saveSelection}
                        onKeyUp={saveSelection}
                        className="p-3 text-xs focus:outline-none overflow-auto h-full"
                        style={{width: '100%', boxSizing: 'border-box', border: '3px solid #10B981', borderRadius: '4px'}}
                      />
                    )}
                  </div>
                </div>
              </div>

              {/* Proofreading Controls */}
              <div className="mb-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-sm font-bold text-indigo-800 flex items-center gap-2">
                    üîé AI Proofreading Analysis
                  </h3>
                  <button
                    onClick={runProofreading}
                    disabled={isProofreading || !translationResults[selectedResultIndex]?.translatedText}
                    className="px-4 py-2 bg-indigo-600 text-white text-xs font-medium rounded hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2"
                  >
                    {isProofreading ? (
                      <>
                        <span className="animate-spin">‚è≥</span>
                        Analyzing...
                      </>
                    ) : (
                      <>
                        üîé Run Proofreading
                      </>
                    )}
                  </button>
                </div>

                {/* Error Display */}
                {proofreadingError && (
                  <div className="mb-3 p-3 bg-red-100 border border-red-300 rounded text-xs text-red-700">
                    ‚ùå {proofreadingError}
                  </div>
                )}

                {/* Proofreading Results */}
                {proofreadingResult && (
                  <div className="space-y-3">
                    {/* Classification Badge */}
                    <div className="flex items-center gap-3">
                      <span className={`px-4 py-2 rounded-full text-sm font-bold ${
                        proofreadingResult.classificacao === 'APROVADO'
                          ? 'bg-green-500 text-white'
                          : proofreadingResult.classificacao === 'APROVADO_COM_OBSERVACOES'
                          ? 'bg-yellow-500 text-white'
                          : 'bg-red-500 text-white'
                      }`}>
                        {proofreadingResult.classificacao === 'APROVADO' ? '‚úÖ APROVADO' :
                         proofreadingResult.classificacao === 'APROVADO_COM_OBSERVACOES' ? '‚ö†Ô∏è APROVADO COM OBSERVA√á√ïES' :
                         '‚ùå REPROVADO'}
                      </span>
                      <span className="text-xs text-gray-600">
                        Score: {proofreadingResult.pontuacao_final || proofreadingResult.score || 'N/A'}%
                      </span>
                    </div>

                    {/* Summary Counts */}
                    <div className="flex gap-4 text-xs">
                      <span className="px-2 py-1 bg-gray-100 rounded">
                        Total: <strong>{proofreadingResult.total_erros || 0}</strong>
                      </span>
                      <span className="px-2 py-1 bg-red-100 text-red-700 rounded">
                        Cr√≠ticos: <strong>{proofreadingResult.criticos || 0}</strong>
                      </span>
                      <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded">
                        Altos: <strong>{proofreadingResult.altos || 0}</strong>
                      </span>
                      <span className="px-2 py-1 bg-yellow-100 text-yellow-700 rounded">
                        M√©dios: <strong>{proofreadingResult.medios || 0}</strong>
                      </span>
                      <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded">
                        Baixos: <strong>{proofreadingResult.baixos || 0}</strong>
                      </span>
                    </div>

                    {/* Errors Table */}
                    {proofreadingResult.erros && proofreadingResult.erros.length > 0 && (
                      <div>
                        {/* Apply All Button */}
                        <div className="flex justify-end mb-2">
                          <button
                            onClick={applyAllProofreadingCorrections}
                            disabled={proofreadingResult.erros.every(e => e.applied)}
                            className="px-3 py-1.5 bg-green-600 text-white text-xs font-medium rounded hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-1"
                          >
                            ‚úÖ Apply All Corrections
                          </button>
                        </div>
                        <div className="bg-white border border-gray-200 rounded-lg overflow-hidden">
                          <table className="w-full text-xs">
                            <thead className="bg-gray-100">
                              <tr>
                                <th className="px-2 py-2 text-left font-medium text-gray-600">Severidade</th>
                                <th className="px-2 py-2 text-left font-medium text-gray-600">Tipo</th>
                                <th className="px-2 py-2 text-left font-medium text-gray-600">Original</th>
                                <th className="px-2 py-2 text-left font-medium text-gray-600">Encontrado</th>
                                <th className="px-2 py-2 text-left font-medium text-gray-600">Sugest√£o</th>
                                <th className="px-2 py-2 text-center font-medium text-gray-600">A√ß√£o</th>
                              </tr>
                            </thead>
                            <tbody>
                              {proofreadingResult.erros.map((erro, idx) => {
                                // Handle both field name conventions
                                const severity = erro.severidade || erro.gravidade || 'M√âDIO';
                                const errorType = erro.tipo || 'Geral';
                                const originalText = erro.original || '';  // Portuguese original
                                const foundText = erro.traducao_errada || erro.found || '';  // Incorrect English found in translation
                                const suggestionText = erro.correcao || erro.sugestao || '';  // Corrected English suggestion
                                const explanation = erro.explicacao || erro.descricao || '';

                                return (
                                  <tr
                                    key={idx}
                                    data-error-row={idx}
                                    onClick={() => handleErrorRowClick(idx, foundText)}
                                    className={`border-t transition-all duration-300 cursor-pointer hover:ring-2 hover:ring-indigo-300 ${
                                      highlightedErrorIndex === idx ? 'ring-2 ring-indigo-500 ring-inset shadow-lg scale-[1.01]' :
                                      erro.applied ? 'bg-green-50 opacity-60' :
                                      severity === 'CR√çTICO' ? 'bg-red-50' :
                                      severity === 'ALTO' ? 'bg-blue-50' :
                                      severity === 'M√âDIO' ? 'bg-yellow-50' :
                                      'bg-blue-50'
                                    }`}
                                    title="Click to highlight in translation">
                                    <td className="px-2 py-2">
                                      <span className={`px-2 py-0.5 rounded text-[10px] font-bold ${
                                        severity === 'CR√çTICO' ? 'bg-red-500 text-white' :
                                        severity === 'ALTO' ? 'bg-blue-500 text-white' :
                                        severity === 'M√âDIO' ? 'bg-yellow-500 text-white' :
                                        'bg-blue-500 text-white'
                                      }`}>
                                        {severity}
                                      </span>
                                    </td>
                                    <td className="px-2 py-2 text-gray-700">{errorType}</td>
                                    <td className="px-2 py-2 text-gray-600 max-w-[120px] truncate" title={originalText || explanation}>
                                      {originalText || explanation || '-'}
                                    </td>
                                    <td className="px-2 py-2 text-red-600 max-w-[120px] truncate" title={foundText}>
                                      {erro.applied ? <s>{foundText}</s> : foundText || '-'}
                                    </td>
                                    <td className="px-2 py-2 text-green-600 max-w-[120px] truncate" title={suggestionText}>
                                      {suggestionText || '-'}
                                    </td>
                                    <td className="px-2 py-2 text-center">
                                      {erro.applied ? (
                                        <span className="text-green-600 text-[10px] font-medium">‚úì Aplicado</span>
                                      ) : foundText && suggestionText ? (
                                        <button
                                          onClick={() => applyProofreadingCorrection(erro, idx)}
                                          className="px-2 py-1 bg-blue-500 text-white text-[10px] rounded hover:bg-blue-600"
                                        >
                                          Aplicar
                                        </button>
                                      ) : (
                                        <span className="text-gray-400 text-[10px]">-</span>
                                      )}
                                    </td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}

                    {/* No Errors Message */}
                    {(!proofreadingResult.erros || proofreadingResult.erros.length === 0) && (
                      <div className="p-4 bg-green-100 border border-green-300 rounded text-center">
                        <span className="text-green-700 text-sm font-medium">
                          ‚úÖ No erro found na translation!
                        </span>
                      </div>
                    )}

                    {/* Observations */}
                    {proofreadingResult.observacoes && (
                      <div className="p-3 bg-gray-100 border border-gray-200 rounded">
                        <h4 className="text-xs font-medium text-gray-700 mb-1">üìù Observations:</h4>
                        <p className="text-xs text-gray-600">{proofreadingResult.observacoes}</p>
                      </div>
                    )}
                  </div>
                )}

                {/* Instructions when no result */}
                {!proofreadingResult && !isProofreading && !proofreadingError && (
                  <p className="text-xs text-gray-500">
                    Click em "Run Proofreading" to analyze a translation e identificar erros.
                  </p>
                )}
              </div>

              {/* Approval Actions */}
              <div className="mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                <h4 className="text-sm font-bold text-gray-700 mb-3">üìã Approval Decision</h4>
                <div className="flex justify-between items-center">
                  <button
                    onClick={() => setActiveSubTab('review')}
                    className="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded hover:bg-gray-300 flex items-center"
                  >
                    <span className="mr-2">‚Üê</span> Back: Review
                  </button>
                  <div className="flex gap-3">
                    {/* Reject Button - Only for Admin and PM */}
                    {(isAdmin || isPM) && (
                      <button
                        onClick={openRejectModal}
                        disabled={sendingToProjects}
                        className="px-6 py-2 bg-red-600 text-white text-sm font-medium rounded hover:bg-red-700 disabled:bg-gray-300 flex items-center gap-2"
                      >
                        ‚ùå Reject
                      </button>
                    )}

                    {/* Translators: Send to PM */}
                    {(isInHouseTranslator || isContractor) && (
                      <button
                        onClick={() => sendToProjects('pm')}
                        disabled={sendingToProjects}
                        className="px-6 py-2 text-white text-sm font-medium rounded disabled:bg-gray-300 flex items-center gap-2 bg-purple-600 hover:bg-purple-700"
                      >
                        üì§ Send to PM
                      </button>
                    )}

                    {/* PM: Approve and Send to Admin for delivery */}
                    {(isPM && !isAdmin) && (
                      <button
                        onClick={() => approveTranslation(false)}
                        disabled={sendingToProjects}
                        className="px-6 py-2 text-white text-sm font-medium rounded disabled:bg-gray-300 flex items-center gap-2 bg-green-600 hover:bg-green-700"
                      >
                        ‚úÖ Approve
                      </button>
                    )}

                    {/* Admin: Send to Client (Deliver) */}
                    {isAdmin && (
                      <button
                        onClick={() => sendToProjects('deliver')}
                        disabled={sendingToProjects}
                        className="px-6 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 disabled:bg-gray-300 flex items-center gap-2"
                      >
                        üì§ Send to Client
                      </button>
                    )}

                    {/* Next: Go to Deliver tab */}
                    <button
                      onClick={() => setActiveSubTab('deliver')}
                      className="px-6 py-2 bg-teal-600 text-white text-sm font-medium rounded hover:bg-teal-700 flex items-center gap-2"
                    >
                      Next: Deliver <span className="ml-1">‚Üí</span>
                    </button>
                  </div>
                </div>
                <p className="text-[10px] text-gray-500 mt-2">
                  {(isInHouseTranslator || isContractor) ? (
                    <>
                      üì§ <strong>Send to PM:</strong> Sends translation to Project Manager for review and approval
                      <br/>
                      ‚û°Ô∏è <strong>Next:</strong> Go to Deliver tab to generate final documents
                    </>
                  ) : isPM && !isAdmin ? (
                    <>
                      ‚úÖ <strong>Approve:</strong> Approves translation and sends to Admin for client delivery
                      <br/>
                      ‚ùå <strong>Reject:</strong> Returns translation to translator with feedback
                      <br/>
                      ‚û°Ô∏è <strong>Next:</strong> Go to Deliver tab to generate final documents
                    </>
                  ) : (
                    <>
                      üì§ <strong>Send to Client:</strong> Delivers the approved translation to the client
                      <br/>
                      ‚ùå <strong>Reject:</strong> Returns translation to translator with feedback
                      <br/>
                      ‚û°Ô∏è <strong>Next:</strong> Go to Deliver tab to generate final documents
                    </>
                  )}
                </p>
              </div>
            </>
          ) : (
            <div className="space-y-4">
              <div className="text-center py-4 text-gray-500">
                <div className="text-4xl mb-2">üîç</div>
                <p className="text-sm mb-4">Upload documents to start proofreading</p>
              </div>

              {/* Direct Upload for Proofreading */}
              <div className="grid grid-cols-2 gap-4">
                {/* Upload Original Document */}
                <div className="border-2 border-dashed border-blue-300 rounded-lg p-4 bg-blue-50">
                  <h3 className="text-xs font-bold text-blue-700 mb-2">üìÑ Original Document ({sourceLanguage})</h3>
                  <input
                    type="file"
                    accept=".pdf,image/*"
                    className="hidden"
                    id="proofreading-original-upload"
                    onChange={async (e) => {
                      const file = e.target.files?.[0];
                      if (!file) return;
                      setProcessingStatus('üîÑ Extracting text from original...');
                      try {
                        const fileBase64 = await fileToBase64(file);
                        const response = await axios.post(
                          `${API}/admin/ocr?admin_key=${adminKey}`,
                          {
                            file_base64: fileBase64,
                            file_type: file.type,
                            filename: file.name,
                            use_claude: claudeApiKey ? true : false,
                            claude_api_key: claudeApiKey || null,
                            preserve_layout: true
                          }
                        );
                        if (response.data.text) {
                          setOcrResults([{ filename: file.name, text: response.data.text }]);
                          // Create translation result entry if doesn't exist
                          if (translationResults.length === 0) {
                            setTranslationResults([{ translatedText: '', originalText: response.data.text, filename: file.name }]);
                          } else {
                            setTranslationResults(prev => prev.map((r, idx) =>
                              idx === 0 ? { ...r, originalText: response.data.text } : r
                            ));
                          }
                          setProcessingStatus('‚úÖ Original text extracted!');
                        }
                      } catch (err) {
                        setProcessingStatus('‚ùå Failed to extract text: ' + (err.response?.data?.detail || err.message));
                      }
                      e.target.value = '';
                    }}
                  />
                  <label
                    htmlFor="proofreading-original-upload"
                    className="cursor-pointer flex flex-col items-center justify-center py-4 hover:bg-blue-100 rounded transition-colors"
                  >
                    <span className="text-3xl mb-2">üì§</span>
                    <span className="text-xs text-blue-600">Click to upload PDF or image</span>
                  </label>
                  {ocrResults[0]?.text && (
                    <div className="mt-2 p-2 bg-white rounded border text-xs max-h-32 overflow-auto">
                      {ocrResults[0].text.substring(0, 200)}...
                    </div>
                  )}
                </div>

                {/* Upload Translation */}
                <div className="border-2 border-dashed border-green-300 rounded-lg p-4 bg-green-50">
                  <h3 className="text-xs font-bold text-green-700 mb-2">üìÑ Translation ({targetLanguage})</h3>
                  <input
                    type="file"
                    accept=".pdf,image/*,.html,.htm,.txt,.doc,.docx"
                    className="hidden"
                    id="proofreading-translation-upload"
                    onChange={async (e) => {
                      const file = e.target.files?.[0];
                      if (!file) return;
                      setProcessingStatus('üîÑ Processing translation file...');
                      try {
                        if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                          const text = await file.text();
                          // Check for binary content
                          if (isBinaryContent(text)) {
                            setProcessingStatus('‚ö†Ô∏è File appears to be corrupted. Please try a different file.');
                            return;
                          }
                          const html = `<div style="white-space: pre-wrap;">${text}</div>`;
                          if (translationResults.length === 0) {
                            setTranslationResults([{ translatedText: html, originalText: ocrResults[0]?.text || '', filename: file.name }]);
                          } else {
                            setTranslationResults(prev => prev.map((r, idx) =>
                              idx === 0 ? { ...r, translatedText: html } : r
                            ));
                          }
                          setProcessingStatus('‚úÖ Translation loaded!');
                        } else if (file.type === 'text/html' || file.name.endsWith('.html') || file.name.endsWith('.htm')) {
                          const html = await file.text();
                          // Check for binary content
                          if (isBinaryContent(html)) {
                            setProcessingStatus('‚ö†Ô∏è File appears to be corrupted. Please try a different file.');
                            return;
                          }
                          if (translationResults.length === 0) {
                            setTranslationResults([{ translatedText: html, originalText: ocrResults[0]?.text || '', filename: file.name }]);
                          } else {
                            setTranslationResults(prev => prev.map((r, idx) =>
                              idx === 0 ? { ...r, translatedText: html } : r
                            ));
                          }
                          setProcessingStatus('‚úÖ Translation loaded!');
                        } else if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                          // Word document - convert to HTML using mammoth
                          setProcessingStatus('üîÑ Converting Word document...');
                          const html = await convertWordToHtml(file);
                          // Check for binary content (corrupted conversion)
                          if (isBinaryContent(html)) {
                            setProcessingStatus('‚ö†Ô∏è Word document appears to be corrupted. Please try a different file.');
                            return;
                          }
                          if (translationResults.length === 0) {
                            setTranslationResults([{ translatedText: html, originalText: ocrResults[0]?.text || '', filename: file.name }]);
                          } else {
                            setTranslationResults(prev => prev.map((r, idx) =>
                              idx === 0 ? { ...r, translatedText: html } : r
                            ));
                          }
                          setProcessingStatus('‚úÖ Translation loaded!');
                        } else {
                          // For PDF/images, extract text via OCR
                          const fileBase64 = await fileToBase64(file);
                          const response = await axios.post(
                            `${API}/admin/ocr?admin_key=${adminKey}`,
                            {
                              file_base64: fileBase64,
                              file_type: file.type,
                              filename: file.name,
                              use_claude: claudeApiKey ? true : false,
                              claude_api_key: claudeApiKey || null,
                              preserve_layout: true
                            }
                          );
                          if (response.data.text) {
                            const html = `<div style="white-space: pre-wrap;">${response.data.text}</div>`;
                            if (translationResults.length === 0) {
                              setTranslationResults([{ translatedText: html, originalText: ocrResults[0]?.text || '', filename: file.name }]);
                            } else {
                              setTranslationResults(prev => prev.map((r, idx) =>
                                idx === 0 ? { ...r, translatedText: html } : r
                              ));
                            }
                            setProcessingStatus('‚úÖ Translation text extracted!');
                          }
                        }
                      } catch (err) {
                        setProcessingStatus('‚ùå Failed to process: ' + (err.response?.data?.detail || err.message));
                      }
                      e.target.value = '';
                    }}
                  />
                  <label
                    htmlFor="proofreading-translation-upload"
                    className="cursor-pointer flex flex-col items-center justify-center py-4 hover:bg-green-100 rounded transition-colors"
                  >
                    <span className="text-3xl mb-2">üì§</span>
                    <span className="text-xs text-green-600">Click to upload translation file</span>
                  </label>
                  {translationResults[0]?.translatedText && (
                    <div className="mt-2 p-2 bg-white rounded border text-xs max-h-32 overflow-auto">
                      <div dangerouslySetInnerHTML={{ __html: translationResults[0].translatedText.substring(0, 200) + '...' }} />
                    </div>
                  )}
                </div>
              </div>

              {/* Or paste text manually */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-xs font-medium text-gray-600 mb-1 block">Or paste original text:</label>
                  <textarea
                    className="w-full h-32 text-xs p-2 border rounded resize-none"
                    placeholder="Paste original text here..."
                    onChange={(e) => {
                      const text = e.target.value;
                      if (text.trim()) {
                        setOcrResults([{ filename: 'Original', text: text }]);
                        if (translationResults.length === 0) {
                          setTranslationResults([{ translatedText: '', originalText: text, filename: 'Manual' }]);
                        } else {
                          setTranslationResults(prev => prev.map((r, idx) =>
                            idx === 0 ? { ...r, originalText: text } : r
                          ));
                        }
                      }
                    }}
                  />
                </div>
                <div>
                  <label className="text-xs font-medium text-gray-600 mb-1 block">Or paste translation text:</label>
                  <textarea
                    className="w-full h-32 text-xs p-2 border rounded resize-none"
                    placeholder="Paste translation text here..."
                    onChange={(e) => {
                      const text = e.target.value;
                      if (text.trim()) {
                        const html = `<div style="white-space: pre-wrap;">${text}</div>`;
                        if (translationResults.length === 0) {
                          setTranslationResults([{ translatedText: html, originalText: ocrResults[0]?.text || '', filename: 'Manual' }]);
                        } else {
                          setTranslationResults(prev => prev.map((r, idx) =>
                            idx === 0 ? { ...r, translatedText: html } : r
                          ));
                        }
                      }
                    }}
                  />
                </div>
              </div>

              {/* Run Proofreading Button */}
              {translationResults[0]?.translatedText && (
                <div className="text-center">
                  <button
                    onClick={runProofreading}
                    disabled={isProofreading || !translationResults[0]?.translatedText}
                    className="px-6 py-3 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                  >
                    {isProofreading ? '‚è≥ Analyzing...' : 'üîé Run Proofreading'}
                  </button>
                </div>
              )}

              {/* Proofreading Results */}
              {proofreadingResult && (
                <div className="p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                  <div className="flex items-center gap-3 mb-3">
                    <span className={`px-4 py-2 rounded-full text-sm font-bold ${
                      proofreadingResult.classificacao === 'APROVADO'
                        ? 'bg-green-500 text-white'
                        : proofreadingResult.classificacao === 'APROVADO_COM_OBSERVACOES'
                        ? 'bg-yellow-500 text-white'
                        : 'bg-red-500 text-white'
                    }`}>
                      {proofreadingResult.classificacao === 'APROVADO' ? '‚úÖ APPROVED' :
                       proofreadingResult.classificacao === 'APROVADO_COM_OBSERVACOES' ? '‚ö†Ô∏è APPROVED WITH OBSERVATIONS' :
                       '‚ùå REJECTED'}
                    </span>
                    <span className="text-xs text-gray-600">
                      Score: {proofreadingResult.pontuacao_final || proofreadingResult.score || 'N/A'}%
                    </span>
                  </div>
                  {proofreadingResult.erros && proofreadingResult.erros.length > 0 && (
                    <div className="text-xs text-gray-600">
                      Found {proofreadingResult.erros.length} issue(s)
                    </div>
                  )}
                </div>
              )}

              {proofreadingError && (
                <div className="p-3 bg-red-100 border border-red-300 rounded text-xs text-red-700">
                  ‚ùå {proofreadingError}
                </div>
              )}

              <div className="text-center">
                <button
                  onClick={() => setActiveSubTab('review')}
                  className="px-4 py-2 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300"
                >
                  ‚Üê Back to Review
                </button>
              </div>
            </div>
          )}
        </div>
      )}

      {/* APPROVAL TAB - Admin, PM and Translator */}
      {activeSubTab === 'deliver' && (isAdmin || isPM || isTranslator) && (
        <div className="bg-white rounded shadow p-4">
          <h2 className="text-sm font-bold mb-2">‚úÖ Approval & Delivery</h2>

          {/* Mode Switch: Normal vs Quick Package - Hidden for contractors only */}
          {(isAdmin || isPM || isInHouseTranslator) && (
            <div className="mb-4 p-3 bg-gray-100 rounded-lg">
              <div className="flex items-center justify-center gap-3">
                <label className={`flex items-center px-4 py-2 rounded-lg cursor-pointer transition-all ${!quickPackageMode ? 'bg-blue-600 text-white shadow' : 'bg-white text-gray-600 hover:bg-gray-50'}`}>
                  <input
                    type="radio"
                    checked={!quickPackageMode}
                    onChange={() => setQuickPackageMode(false)}
                    className="sr-only"
                  />
                  <span className="mr-2">üìù</span>
                  <span className="text-sm font-medium">Normal Flow</span>
                </label>
                <label className={`flex items-center px-4 py-2 rounded-lg cursor-pointer transition-all ${quickPackageMode ? 'bg-green-600 text-white shadow' : 'bg-white text-gray-600 hover:bg-gray-50'}`}>
                  <input
                    type="radio"
                    checked={quickPackageMode}
                    onChange={() => {
                      setQuickPackageMode(true);
                      // Auto-populate quickOriginalFiles from originalImages if available
                      if (originalImages.length > 0 && quickOriginalFiles.length === 0) {
                        const convertedFiles = originalImages.map(img => {
                          // Extract base64 data - handle both formats (with and without data: prefix)
                          let data = img.data;
                          let type = img.type || 'image/png';
                          if (data && data.startsWith('data:')) {
                            const matches = data.match(/^data:([^;]+);base64,(.+)$/);
                            if (matches) {
                              type = matches[1];
                              data = matches[2];
                            }
                          }
                          return { filename: img.filename, data: data, type: type };
                        });
                        setQuickOriginalFiles(convertedFiles);
                      }
                    }}
                    className="sr-only"
                  />
                  <span className="mr-2">üì¶</span>
                  <span className="text-sm font-medium">Quick Package</span>
                </label>
              </div>
              <p className="text-[10px] text-gray-500 text-center mt-2">
                {!quickPackageMode ? 'Use translation from previous flow' : 'Build package with ready translation (upload) - includes verification QR code'}
              </p>
            </div>
          )}

          {/* ============ QUICK PACKAGE MODE ============ */}
          {/* Contractors always use Quick Package mode, In-house translators can choose */}
          {(quickPackageMode || isContractor) && (
            <>
              {/* Certificate Fields */}
              <div className="p-4 bg-blue-50 border border-blue-200 rounded mb-4">
                <h3 className="text-sm font-bold text-blue-700 mb-3">üìú Certificate Information</h3>

                {/* Order Number */}
                <div className="mb-3">
                  <label className="block text-xs font-medium text-gray-700 mb-1">Order #</label>
                  <input
                    type="text"
                    value={orderNumber}
                    onChange={(e) => setOrderNumber(e.target.value)}
                    placeholder="P0000 or ORD-20260111-241CFA"
                    className="w-full px-3 py-2 text-sm border rounded"
                  />
                </div>

                {/* Document Type - REQUIRED */}
                <div className="mb-3">
                  <label className="block text-xs font-medium text-gray-700 mb-1">
                    Translation of <span className="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    value={documentType}
                    onChange={(e) => setDocumentType(e.target.value)}
                    placeholder="Birth Certificate, Marriage Certificate, Diploma..."
                    className={`w-full px-3 py-2 text-sm border rounded ${
                      !documentType.trim() ? 'border-red-300 bg-red-50' : 'border-gray-300'
                    }`}
                  />
                  {!documentType.trim() && (
                    <p className="text-[10px] text-red-500 mt-1">‚ö†Ô∏è Document type is required</p>
                  )}
                </div>

                {/* Language Pair */}
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">From</label>
                    <select
                      value={sourceLanguage}
                      onChange={(e) => setSourceLanguage(e.target.value)}
                      className="w-full px-3 py-2 text-sm border rounded"
                    >
                      {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">To</label>
                    <select
                      value={targetLanguage}
                      onChange={(e) => setTargetLanguage(e.target.value)}
                      className="w-full px-3 py-2 text-sm border rounded"
                    >
                      {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                    </select>
                  </div>
                </div>
              </div>

              {/* Upload Translation (Ready) */}
              <div className="p-4 bg-green-50 border border-green-200 rounded mb-4">
                <h3 className="text-sm font-bold text-green-700 mb-2">üìÑ Upload Ready Translation</h3>
                <p className="text-[10px] text-green-600 mb-3">Upload your translation document (recommended: Word .docx)</p>

                <div className={`border-2 border-dashed border-green-300 rounded-lg p-4 text-center transition-colors mb-2 ${quickPackageLoading ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:border-green-500'}`}>
                  <input
                    type="file"
                    multiple
                    accept=".docx,.doc,.html,.htm,.txt,.pdf,image/*"
                    onChange={handleQuickTranslationUpload}
                    className="hidden"
                    id="quick-translation-upload"
                    disabled={quickPackageLoading}
                  />
                  <label htmlFor="quick-translation-upload" className={quickPackageLoading ? 'cursor-not-allowed' : 'cursor-pointer'}>
                    <UploadIcon className="w-6 h-6 mx-auto mb-1 text-green-600" />
                    <span className="px-3 py-1.5 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                      Upload Translation
                    </span>
                    <p className="text-[10px] text-gray-500 mt-1">Word (.docx), HTML, TXT, PDF, Images</p>
                  </label>
                </div>

                {/* Paste HTML/Text directly */}
                <div className="mt-3">
                  <label className="block text-[10px] font-medium text-gray-600 mb-1">Or paste text/HTML directly:</label>
                  <textarea
                    placeholder="Paste your translation text or HTML here..."
                    className="w-full h-24 px-3 py-2 text-xs border border-green-200 rounded resize-none focus:border-green-500 focus:ring-1 focus:ring-green-500"
                    onChange={(e) => {
                      const text = e.target.value;
                      if (text.trim()) {
                        // Check if it looks like HTML
                        const isHtml = text.includes('<') && text.includes('>');
                        const html = isHtml ? text : `<div style="white-space: pre-wrap; font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.6;">${text}</div>`;
                        setQuickTranslationHtml(html);
                        setQuickTranslationType('html');
                      }
                    }}
                    disabled={quickPackageLoading}
                  />
                </div>

                {/* Show HTML content indicator */}
                {quickTranslationHtml && (
                  <div className="mb-2 p-2 bg-white rounded border border-green-200">
                    <div className="flex items-center justify-between">
                      <span className="text-xs font-medium text-green-700">
                        ‚úì Document content loaded (Word/HTML/TXT)
                      </span>
                      <button
                        onClick={() => { setQuickTranslationHtml(''); setQuickTranslationType('images'); }}
                        className="text-gray-400 hover:text-red-500 p-1"
                        disabled={quickPackageLoading}
                        title="Clear document"
                      >
                        <TrashIcon className="w-3 h-3" />
                      </button>
                    </div>
                  </div>
                )}

                {/* Show image files */}
                {quickTranslationFiles.length > 0 && (
                  <div className="space-y-1">
                    <div className="flex items-center justify-between">
                      <p className="text-xs font-medium text-green-700">{quickTranslationFiles.length} image page(s):</p>
                      <button
                        onClick={() => setQuickTranslationFiles([])}
                        className="text-[10px] text-gray-400 hover:text-red-500"
                        disabled={quickPackageLoading}
                      >
                        Clear all
                      </button>
                    </div>
                    <div className="max-h-32 overflow-y-auto">
                      {quickTranslationFiles.map((file, idx) => (
                        <div key={idx} className="flex items-center justify-between bg-white px-2 py-1 rounded text-xs mb-1">
                          <span className="truncate flex-1">{idx + 1}. {file.filename}</span>
                          <button
                            onClick={() => setQuickTranslationFiles(prev => prev.filter((_, i) => i !== idx))}
                            className="text-gray-400 hover:text-red-500 ml-2 p-1"
                            disabled={quickPackageLoading}
                          >
                            <TrashIcon className="w-3 h-3" />
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>

              {/* Upload Originals */}
              <div className="p-4 bg-blue-50 border border-blue-200 rounded mb-4">
                <h3 className="text-sm font-bold text-blue-700 mb-2">üìë Upload Original Documents</h3>
                <p className="text-[10px] text-blue-600 mb-3">Upload original document (PDF auto-converted to images)</p>

                <div className={`border-2 border-dashed border-blue-300 rounded-lg p-4 text-center transition-colors mb-2 ${quickPackageLoading ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:border-blue-500'}`}>
                  <input
                    type="file"
                    multiple
                    accept=".pdf,image/*"
                    onChange={handleQuickOriginalUpload}
                    className="hidden"
                    id="quick-original-upload"
                    disabled={quickPackageLoading}
                  />
                  <label htmlFor="quick-original-upload" className={quickPackageLoading ? 'cursor-not-allowed' : 'cursor-pointer'}>
                    <UploadIcon className="w-6 h-6 mx-auto mb-1 text-blue-600" />
                    <span className="px-3 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                      Upload Originals
                    </span>
                    <p className="text-[10px] text-gray-500 mt-1">PDF or images (PDF auto-converted)</p>
                  </label>
                </div>

                {quickOriginalFiles.length > 0 && (
                  <div className="space-y-1">
                    <p className="text-xs font-medium text-blue-700">{quickOriginalFiles.length} page(s) uploaded:</p>
                    <div className="max-h-32 overflow-y-auto">
                      {quickOriginalFiles.map((file, idx) => (
                        <div key={idx} className="flex items-center justify-between bg-white px-2 py-1 rounded text-xs mb-1">
                          <span className="truncate flex-1">{idx + 1}. {file.filename}</span>
                          <button
                            onClick={() => setQuickOriginalFiles(prev => prev.filter((_, i) => i !== idx))}
                            className="text-gray-400 hover:text-red-500 ml-2 p-1"
                            disabled={quickPackageLoading}
                          >
                            <TrashIcon className="w-3 h-3" />
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>

              {/* Options - Hidden for contractors only */}
              {(isAdmin || isPM || isInHouseTranslator) && (
                <div className="p-4 bg-gray-50 border border-gray-200 rounded mb-4">
                  <h3 className="text-sm font-bold text-gray-700 mb-2">‚öôÔ∏è Options</h3>
                  <div className="space-y-2">
                    <label className="flex items-center text-xs cursor-pointer">
                      <input
                        type="checkbox"
                        checked={includeCover}
                        onChange={(e) => setIncludeCover(e.target.checked)}
                        className="mr-3 w-4 h-4"
                      />
                      <span>Include Certificate of Accuracy</span>
                    </label>
                    <label className="flex items-center text-xs cursor-pointer">
                      <input
                        type="checkbox"
                        checked={includeLetterhead}
                        onChange={(e) => setIncludeLetterhead(e.target.checked)}
                        className="mr-3 w-4 h-4"
                      />
                      <span>Include Letterhead on pages</span>
                    </label>
                    <label className="flex items-center text-xs cursor-pointer">
                      <input
                        type="checkbox"
                        checked={includeOriginal}
                        onChange={(e) => setIncludeOriginal(e.target.checked)}
                        className="mr-3 w-4 h-4"
                      />
                      <span>Include Original Documents</span>
                    </label>
                    <label className="flex items-center text-xs cursor-pointer">
                      <input
                        type="checkbox"
                        checked={includeCertification}
                        onChange={(e) => setIncludeCertification(e.target.checked)}
                        className="mr-3 w-4 h-4"
                      />
                      <span>üîê Include Verification Page (QR Code)</span>
                    </label>
                  </div>
                </div>
              )}

              {/* Document Order Preview - Hidden for contractors only */}
              {(isAdmin || isPM || isInHouseTranslator) && (
                <div className="p-4 bg-blue-50 border border-blue-200 rounded mb-4">
                  <h3 className="text-sm font-bold text-blue-700 mb-2">üìã Final Document Order</h3>
                  <div className="flex items-center gap-2 text-xs flex-wrap">
                    {includeCover && (
                      <>
                        <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded">üìú Certificate</span>
                        <span className="text-gray-400">‚Üí</span>
                      </>
                    )}
                    <span className="px-2 py-1 bg-green-100 text-green-700 rounded">
                      üìÑ Translation {quickTranslationHtml ? '(Document)' : `(${quickTranslationFiles.length} pages)`}
                    </span>
                    {includeOriginal && quickOriginalFiles.length > 0 && (
                      <>
                        <span className="text-gray-400">‚Üí</span>
                        <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded">üìë Original ({quickOriginalFiles.length} pages)</span>
                      </>
                    )}
                    {includeCertification && (
                      <>
                        <span className="text-gray-400">‚Üí</span>
                        <span className="px-2 py-1 bg-purple-100 text-purple-700 rounded">üîê Verification</span>
                      </>
                    )}
                  </div>
                </div>
              )}

              {/* Loading/Progress Indicator */}
              {quickPackageProgress && (
                <div className="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <div className="flex items-center gap-2">
                    {quickPackageLoading && (
                      <div className="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                    )}
                    <span className="text-sm text-blue-700 font-medium">{quickPackageProgress}</span>
                  </div>
                </div>
              )}

              {/* Approval Checklist for Quick Package - Required before submitting */}
              <div className={`p-4 rounded mb-4 ${
                isApprovalComplete
                  ? 'bg-green-50 border border-green-200'
                  : 'bg-blue-50 border-2 border-purple-300'
              }`}>
                <h3 className="text-sm font-bold text-blue-700 mb-1">
                  üìã Translation Checklist <span className="text-red-500">*</span>
                </h3>
                <p className="text-[10px] text-blue-600 mb-3">‚ö†Ô∏è Complete all items before submitting</p>
                <div className="space-y-2">
                  <label className={`flex items-center text-xs cursor-pointer p-2 rounded ${
                    approvalChecks.projectNumber ? 'bg-green-100' : 'bg-white'
                  }`}>
                    <input
                      type="checkbox"
                      checked={approvalChecks.projectNumber}
                      onChange={(e) => setApprovalChecks({...approvalChecks, projectNumber: e.target.checked})}
                      className="mr-3 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-purple-500"
                    />
                    <span className="font-medium">Did you include the correct project number?</span>
                    {approvalChecks.projectNumber && <span className="ml-auto text-green-600">‚úì</span>}
                  </label>
                  <label className={`flex items-center text-xs cursor-pointer p-2 rounded ${
                    approvalChecks.languageCorrect ? 'bg-green-100' : 'bg-white'
                  }`}>
                    <input
                      type="checkbox"
                      checked={approvalChecks.languageCorrect}
                      onChange={(e) => setApprovalChecks({...approvalChecks, languageCorrect: e.target.checked})}
                      className="mr-3 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-purple-500"
                    />
                    <span className="font-medium">Is the source and target language correct?</span>
                    {approvalChecks.languageCorrect && <span className="ml-auto text-green-600">‚úì</span>}
                  </label>
                  <label className={`flex items-center text-xs cursor-pointer p-2 rounded ${
                    approvalChecks.proofread ? 'bg-green-100' : 'bg-white'
                  }`}>
                    <input
                      type="checkbox"
                      checked={approvalChecks.proofread}
                      onChange={(e) => setApprovalChecks({...approvalChecks, proofread: e.target.checked})}
                      className="mr-3 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-purple-500"
                    />
                    <span className="font-medium">Did you proofread the entire document carefully?</span>
                    {approvalChecks.proofread && <span className="ml-auto text-green-600">‚úì</span>}
                  </label>
                </div>
                {!isApprovalComplete && (
                  <p className="text-[10px] text-red-500 mt-3 font-medium">
                    ‚ö†Ô∏è Complete all checklist items to enable submission
                  </p>
                )}
                {isApprovalComplete && (
                  <p className="text-[10px] text-green-600 mt-3 font-medium">
                    ‚úÖ All checks completed - Ready to submit!
                  </p>
                )}
              </div>

              {/* ============ CONTRACTOR SECTION: Send to PM ============ */}
              {/* Only contractors see this - In-house translators use the full Admin/PM section below */}
              {isContractor && (
                <div className="p-4 bg-purple-50 border border-purple-200 rounded mb-4">
                  <h3 className="text-sm font-bold text-purple-700 mb-2">
                    üì§ Send to Project Manager
                  </h3>
                  <p className="text-[10px] text-purple-600 mb-3">
                    Send your completed translation to the PM for review and approval
                  </p>

                  <div className="mb-3">
                    <label className="block text-xs font-medium text-gray-700 mb-1">Select Order *</label>
                    <select
                      value={selectedOrderId}
                      onChange={(e) => setSelectedOrderId(e.target.value)}
                      className="w-full px-2 py-1.5 text-xs border rounded"
                    >
                      <option value="">-- Select Order --</option>
                      {availableOrders.map(order => (
                        <option key={order.id} value={order.id}>
                          {order.order_number} - {order.client_name}
                        </option>
                      ))}
                    </select>
                  </div>

                  <button
                    onClick={() => sendToProjects('pm')}
                    disabled={!selectedOrderId || sendingToProjects || !isApprovalComplete || !documentType.trim() || (quickTranslationFiles.length === 0 && !quickTranslationHtml)}
                    className="w-full py-3 bg-purple-600 text-white text-sm font-bold rounded-lg hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    {sendingToProjects ? (
                      <>
                        <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        Sending...
                      </>
                    ) : (
                      'üì§ Send to PM for Review'
                    )}
                  </button>

                  {/* Download Button for Contractors */}
                  <button
                    onClick={handleQuickPackageDownload}
                    disabled={(quickTranslationFiles.length === 0 && !quickTranslationHtml) || quickPackageLoading}
                    className="w-full mt-3 py-2 bg-gradient-to-r from-green-600 to-blue-600 text-white text-sm font-medium rounded-lg hover:from-green-700 hover:to-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    {quickPackageLoading ? (
                      <>
                        <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        Generating...
                      </>
                    ) : (
                      'üì• Download Package (Print/PDF)'
                    )}
                  </button>
                  <p className="text-[10px] text-gray-500 mt-1 text-center">
                    Opens print window - save as PDF
                  </p>

                  {(!documentType.trim() || (quickTranslationFiles.length === 0 && !quickTranslationHtml)) && (
                    <p className="text-[10px] text-purple-600 mt-2">
                      ‚ö†Ô∏è Fill document type and upload translation first
                    </p>
                  )}

                  {processingStatus && (
                    <div className={`mt-3 p-2 rounded text-xs ${
                      processingStatus.includes('‚ùå') ? 'bg-red-100 text-red-700' :
                      processingStatus.includes('‚úÖ') ? 'bg-green-100 text-green-700' :
                      'bg-blue-100 text-blue-700'
                    }`}>
                      {processingStatus}
                    </div>
                  )}
                </div>
              )}

              {/* ============ ADMIN/PM/IN-HOUSE SECTION: Send to Projects ============ */}
              {(isAdmin || isPM || isInHouseTranslator) && (
                <>
                  <div className={`p-4 rounded mb-4 ${
                    isApprovalComplete && documentType.trim()
                      ? 'bg-green-50 border border-green-200'
                      : 'bg-gray-50 border border-gray-200'
                  }`}>
                    <h3 className="text-sm font-bold text-green-700 mb-3">üì§ Send to Projects</h3>
                    <p className="text-[10px] text-gray-600 mb-3">Send this translation to a project for review and delivery.</p>

                    {/* Validation warnings */}
                    {(!isApprovalComplete || !documentType.trim()) && (
                      <div className="mb-3 p-2 bg-yellow-50 border border-yellow-200 rounded">
                        <p className="text-[10px] text-yellow-700 font-medium">‚ö†Ô∏è Before sending, please complete:</p>
                        <ul className="text-[10px] text-yellow-600 mt-1 ml-4 list-disc">
                          {!documentType.trim() && <li>Fill in Document Type</li>}
                          {!isApprovalComplete && <li>Complete all Approval Checklist items</li>}
                        </ul>
                      </div>
                    )}

                    <div className="flex flex-col space-y-2">
                      <select
                        value={selectedOrderId}
                        onChange={(e) => setSelectedOrderId(e.target.value)}
                        className="w-full px-2 py-1.5 text-xs border rounded"
                      >
                        <option value="">-- Select Order --</option>
                        {availableOrders.map(order => (
                          <option key={order.id} value={order.id}>
                            {order.order_number} - {order.client_name}
                          </option>
                        ))}
                      </select>
                      <div className="flex space-x-2">
                        {/* Role-based delivery options - same as Normal Flow */}
                        <select
                          value={sendDestination}
                          onChange={(e) => setSendDestination(e.target.value)}
                          className="px-2 py-2 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                          disabled={sendingToProjects}
                        >
                          {/* Admin sends to PM Admin for final processing */}
                          {isAdmin && <option value="pending_admin_approval">üì§ Send to PM Admin</option>}
                          {/* PM sends to Admin for final approval */}
                          {isPM && !isAdmin && <option value="pending_admin_approval">üì§ Send to Admin (Ready for Client)</option>}
                          {/* In-House Translator: Send to PM or Finalize to Admin (never to client) */}
                          {isInHouseTranslator && (
                            <>
                              <option value="pm">üì§ Send to PM (for review)</option>
                              <option value="finalize_admin">‚úÖ Finalize & Send to Admin</option>
                            </>
                          )}
                        </select>
                        <button
                          onClick={() => sendToProjects(sendDestination)}
                          disabled={!selectedOrderId || sendingToProjects || !isApprovalComplete || !documentType.trim() || (quickTranslationFiles.length === 0 && !quickTranslationHtml)}
                          className={`flex-1 px-4 py-2 text-white text-xs rounded disabled:bg-gray-300 disabled:cursor-not-allowed ${
                            sendDestination === 'finalize_admin' ? 'bg-green-600 hover:bg-green-700' :
                            'bg-blue-600 hover:bg-blue-700'
                          }`}
                        >
                          {sendingToProjects ? '‚è≥ Sending...' : sendDestination === 'finalize_admin' ? '‚úÖ Finalize' : 'üì§ Deliver'}
                        </button>
                      </div>
                    </div>
                    {availableOrders.length === 0 && (
                      <p className="text-[10px] text-yellow-600 mt-2">No orders available. Create an order first in the Projects tab.</p>
                    )}
                  </div>

                  {/* Download Button - Admin/PM only */}
                  <button
                    onClick={handleQuickPackageDownload}
                    disabled={(quickTranslationFiles.length === 0 && !quickTranslationHtml) || quickPackageLoading}
                    className="w-full py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white text-sm font-bold rounded-lg hover:from-green-700 hover:to-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    {quickPackageLoading ? (
                      <>
                        <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        Generating...
                      </>
                    ) : (
                      'üì¶ Generate Complete Package (Print/PDF)'
                    )}
                  </button>
                  <p className="text-[10px] text-gray-500 mt-2 text-center">
                    Opens print window - save as PDF
                  </p>

                  {/* PM External Translation Upload Section */}
                  {isPM && (
                    <div className="mt-4 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                      <h4 className="text-sm font-bold text-orange-700 mb-2">üìÅ External Translation Upload</h4>
                      <p className="text-[10px] text-orange-600 mb-3">
                        Upload translations from external translators (outside the system)
                      </p>
                      <div className="bg-white rounded p-3 border border-orange-100">
                        <p className="text-[10px] text-gray-500 mb-2">
                          Use the "Upload Ready Translation" section above to upload external translations.
                          After uploading, complete the checklist and send to Admin for client delivery.
                        </p>
                      </div>
                    </div>
                  )}

                  {/* PM Approval & Send to Admin Section */}
                  {isPM && (
                    <div className="mt-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                      <h4 className="text-sm font-bold text-indigo-700 mb-2">‚úÖ Approve & Send to Admin</h4>
                      <p className="text-[10px] text-indigo-600 mb-3">
                        After reviewing the translation, approve it and send to Admin for final client delivery
                      </p>

                      <div className="mb-3">
                        <label className="block text-xs font-medium text-gray-700 mb-1">Select Order *</label>
                        <select
                          value={selectedOrderId}
                          onChange={(e) => setSelectedOrderId(e.target.value)}
                          className="w-full px-2 py-1.5 text-xs border rounded"
                        >
                          <option value="">-- Select Order --</option>
                          {availableOrders.map(order => (
                            <option key={order.id} value={order.id}>
                              {order.order_number} - {order.client_name} ({order.translation_status || 'N/A'})
                            </option>
                          ))}
                        </select>
                      </div>

                      <button
                        onClick={() => sendToProjects('pending_admin_approval')}
                        disabled={!selectedOrderId || sendingToProjects || !isApprovalComplete || (quickTranslationFiles.length === 0 && !quickTranslationHtml)}
                        className="w-full py-3 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                      >
                        {sendingToProjects ? (
                          <>
                            <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                            Sending...
                          </>
                        ) : (
                          '‚úÖ Approve & Send to Admin'
                        )}
                      </button>
                      <p className="text-[10px] text-indigo-500 mt-2 text-center">
                        Admin will send the final translation to the client
                      </p>
                    </div>
                  )}

                </>
              )}
            </>
          )}

          {/* ============ NORMAL FLOW ============ */}
          {/* Normal Flow - Available for ALL users including Contractors */}
          {!quickPackageMode && translationResults.length > 0 && (
            <>
              {/* Approval Checklist - ALL REQUIRED */}
              <div className={`p-4 rounded mb-4 ${
                isApprovalComplete
                  ? 'bg-green-50 border border-green-200'
                  : 'bg-blue-50 border-2 border-purple-300'
              }`}>
                <h3 className="text-sm font-bold text-blue-700 mb-1">
                  üìã Translation Approval Checklist <span className="text-red-500">*</span>
                </h3>
                <p className="text-[10px] text-blue-600 mb-3">‚ö†Ô∏è All items must be checked before sending</p>
                <div className="space-y-2">
                  <label className={`flex items-center text-xs cursor-pointer p-2 rounded ${
                    approvalChecks.projectNumber ? 'bg-green-100' : 'bg-white'
                  }`}>
                    <input
                      type="checkbox"
                      checked={approvalChecks.projectNumber}
                      onChange={(e) => setApprovalChecks({...approvalChecks, projectNumber: e.target.checked})}
                      className="mr-3 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-purple-500"
                    />
                    <span className="font-medium">Did you include the correct project number?</span>
                    {approvalChecks.projectNumber && <span className="ml-auto text-green-600">‚úì</span>}
                  </label>
                  <label className={`flex items-center text-xs cursor-pointer p-2 rounded ${
                    approvalChecks.languageCorrect ? 'bg-green-100' : 'bg-white'
                  }`}>
                    <input
                      type="checkbox"
                      checked={approvalChecks.languageCorrect}
                      onChange={(e) => setApprovalChecks({...approvalChecks, languageCorrect: e.target.checked})}
                      className="mr-3 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-purple-500"
                    />
                    <span className="font-medium">Is the source and target language correct?</span>
                    {approvalChecks.languageCorrect && <span className="ml-auto text-green-600">‚úì</span>}
                  </label>
                  <label className={`flex items-center text-xs cursor-pointer p-2 rounded ${
                    approvalChecks.proofread ? 'bg-green-100' : 'bg-white'
                  }`}>
                    <input
                      type="checkbox"
                      checked={approvalChecks.proofread}
                      onChange={(e) => setApprovalChecks({...approvalChecks, proofread: e.target.checked})}
                      className="mr-3 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-purple-500"
                    />
                    <span className="font-medium">Did you proofread the entire document carefully?</span>
                    {approvalChecks.proofread && <span className="ml-auto text-green-600">‚úì</span>}
                  </label>
                </div>
                {!isApprovalComplete && (
                  <p className="text-[10px] text-red-500 mt-3 font-medium">
                    ‚ö†Ô∏è Complete all checklist items to enable sending
                  </p>
                )}
                {isApprovalComplete && (
                  <p className="text-[10px] text-green-600 mt-3 font-medium">
                    ‚úÖ All checks completed - Ready to send!
                  </p>
                )}
              </div>

              {/* Document Options */}
              <div className="p-4 bg-green-50 border border-green-200 rounded mb-4">
                <h3 className="text-sm font-bold text-green-700 mb-2">üì¶ Document Options</h3>
                <p className="text-[10px] text-green-600 mb-3">Select what to include in the final document:</p>
                <div className="space-y-2">
                  <label className="flex items-center text-xs cursor-pointer">
                    <input
                      type="checkbox"
                      checked={includeCover}
                      onChange={(e) => setIncludeCover(e.target.checked)}
                      className="mr-3 w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500"
                    />
                    <span className="font-medium">üìú Include Certificate of Accuracy</span>
                  </label>
                  <label className="flex items-center text-xs cursor-pointer">
                    <input
                      type="checkbox"
                      checked={includeLetterhead}
                      onChange={(e) => setIncludeLetterhead(e.target.checked)}
                      className="mr-3 w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500"
                    />
                    <span className="font-medium">üìã Include Letterhead on pages</span>
                  </label>
                  <label className="flex items-center text-xs cursor-pointer">
                    <input
                      type="checkbox"
                      checked={includeOriginal}
                      onChange={(e) => setIncludeOriginal(e.target.checked)}
                      className="mr-3 w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500"
                    />
                    <span className="font-medium">üìë Include Original Documents</span>
                  </label>
                  <label className="flex items-center text-xs cursor-pointer p-2 bg-purple-50 border border-purple-200 rounded">
                    <input
                      type="checkbox"
                      checked={includeCertification}
                      onChange={(e) => setIncludeCertification(e.target.checked)}
                      className="mr-3 w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"
                    />
                    <span className="font-medium text-purple-700">üîê Include Verification Page (QR Code)</span>
                  </label>
                </div>
              </div>

              {/* Translation Memory Option */}
              <div className="p-4 bg-blue-50 border border-blue-200 rounded mb-4">
                <div className="flex items-center justify-between mb-3">
                  <label className="flex items-center text-xs cursor-pointer">
                    <input
                      type="checkbox"
                      checked={saveToTM}
                      onChange={(e) => setSaveToTM(e.target.checked)}
                      className="mr-3 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    />
                    <div>
                      <span className="font-medium">üíæ Save to Translation Memory</span>
                      <p className="text-[10px] text-blue-600 mt-0.5">
                        Category: {documentCategory === 'financial' ? 'üìä Financial' : documentCategory === 'education' ? 'üéì Education' : documentCategory === 'personal' ? 'üë§ Personal' : 'üìÑ General'}
                      </p>
                    </div>
                  </label>
                  <span className="text-[10px] bg-blue-200 text-blue-800 px-2 py-0.5 rounded">
                    {glossaries.filter(g => g.name?.startsWith('TM -')).length} TMs saved
                  </span>
                </div>

                {/* View Saved TMs */}
                {glossaries.filter(g => g.name?.startsWith('TM -')).length > 0 && (
                  <div className="mt-3 pt-3 border-t border-blue-200">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-[10px] font-medium text-blue-700">üìö Saved Translation Memories:</span>
                      <div className="flex gap-1">
                        <button
                          onClick={() => {
                            // Download all TMs as JSON
                            const tms = glossaries.filter(g => g.name?.startsWith('TM -'));
                            const blob = new Blob([JSON.stringify(tms, null, 2)], { type: 'application/json' });
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(blob);
                            link.download = `translation_memories_${new Date().toISOString().split('T')[0]}.json`;
                            link.click();
                          }}
                          className="px-2 py-1 text-[9px] bg-blue-600 text-white rounded hover:bg-blue-700"
                        >
                          üì• Export All (JSON)
                        </button>
                        <button
                          onClick={() => {
                            // Download all TMs as TMX
                            const tms = glossaries.filter(g => g.name?.startsWith('TM -'));
                            let tmxContent = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE tmx SYSTEM "tmx14.dtd">
<tmx version="1.4">
  <header creationtool="Legacy Translations TM" creationtoolversion="1.0" datatype="plaintext" segtype="sentence" adminlang="en-US" srclang="*all*"/>
  <body>
`;
                            tms.forEach(tm => {
                              (tm.terms || []).forEach(term => {
                                tmxContent += `    <tu>
      <tuv xml:lang="${tm.sourceLang || 'pt-BR'}">
        <seg>${term.source?.replace(/</g, '&lt;').replace(/>/g, '&gt;') || ''}</seg>
      </tuv>
      <tuv xml:lang="${tm.targetLang || 'en-US'}">
        <seg>${term.target?.replace(/</g, '&lt;').replace(/>/g, '&gt;') || ''}</seg>
      </tuv>
    </tu>
`;
                              });
                            });
                            tmxContent += `  </body>
</tmx>`;
                            const blob = new Blob([tmxContent], { type: 'application/xml' });
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(blob);
                            link.download = `translation_memories_${new Date().toISOString().split('T')[0]}.tmx`;
                            link.click();
                          }}
                          className="px-2 py-1 text-[9px] bg-blue-600 text-white rounded hover:bg-blue-700"
                        >
                          üì• Export All (TMX)
                        </button>
                      </div>
                    </div>
                    <div className="max-h-32 overflow-auto space-y-1">
                      {glossaries.filter(g => g.name?.startsWith('TM -')).map((tm, idx) => (
                        <div key={tm.id || idx} className="flex items-center justify-between p-2 bg-white rounded border text-[10px]">
                          <div className="flex-1">
                            <span className="font-medium text-gray-700">{tm.name}</span>
                            <span className="text-gray-400 ml-2">({tm.terms?.length || 0} segments)</span>
                            <span className="text-gray-400 ml-1">{tm.sourceLang} ‚Üí {tm.targetLang}</span>
                          </div>
                          <div className="flex gap-1">
                            <button
                              onClick={() => {
                                // Download single TM as JSON
                                const blob = new Blob([JSON.stringify(tm, null, 2)], { type: 'application/json' });
                                const link = document.createElement('a');
                                link.href = URL.createObjectURL(blob);
                                link.download = `${tm.name?.replace(/[^a-z0-9]/gi, '_') || 'tm'}.json`;
                                link.click();
                              }}
                              className="px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded hover:bg-gray-200"
                              title="Download JSON"
                            >
                              üì•
                            </button>
                            <button
                              onClick={() => {
                                if (window.confirm(`Delete "${tm.name}"?`)) {
                                  const updated = glossaries.filter(g => g.id !== tm.id);
                                  setGlossaries(updated);
                                  localStorage.setItem('glossaries', JSON.stringify(updated));
                                }
                              }}
                              className="px-1.5 py-0.5 bg-red-100 text-red-600 rounded hover:bg-red-200"
                              title="Delete"
                            >
                              üóëÔ∏è
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>

              {/* Download Options */}
              <div className="p-4 bg-blue-50 border border-blue-200 rounded mb-4">
                <h3 className="text-sm font-bold text-blue-700 mb-3">üì• Download Complete Package</h3>

                {/* Document Order Preview */}
                <div className="bg-white rounded border p-3 mb-3">
                  <p className="text-xs font-medium text-gray-700 mb-2">üìã Document Order:</p>
                  <div className="flex items-center gap-2 text-xs flex-wrap">
                    {includeCover && (
                      <>
                        <span className="px-2 py-1 bg-indigo-100 text-indigo-700 rounded">Certificate</span>
                        <span className="text-gray-400">‚Üí</span>
                      </>
                    )}
                    <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded">Translation</span>
                    {includeOriginal && (
                      <>
                        <span className="text-gray-400">‚Üí</span>
                        <span className="px-2 py-1 bg-green-100 text-green-700 rounded">Original</span>
                      </>
                    )}
                    {includeCertification && (
                      <>
                        <span className="text-gray-400">‚Üí</span>
                        <span className="px-2 py-1 bg-purple-100 text-purple-700 rounded">üîê Verification</span>
                      </>
                    )}
                  </div>
                  <p className="text-[10px] text-gray-500 mt-2">
                    {includeLetterhead ? '‚úì Letterhead on all pages' : '‚úó No letterhead'}
                    {includeCertification ? ' ‚Ä¢ ‚úì Verification page' : ''}
                  </p>
                </div>

                {/* Download Buttons */}
                <div className="grid grid-cols-2 gap-2">
                  <button
                    onClick={() => handleDownload('html')}
                    className="py-3 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 flex items-center justify-center gap-2"
                  >
                    üìÑ Download HTML
                  </button>
                  <button
                    onClick={() => handleDownload('pdf')}
                    className="py-3 bg-green-600 text-white text-sm font-medium rounded hover:bg-green-700 flex items-center justify-center gap-2"
                  >
                    üìë Print / Save PDF
                  </button>
                </div>
                <p className="text-[10px] text-gray-500 mt-2 text-center">
                  HTML: Edit in browser before printing | PDF: Opens print dialog
                </p>
              </div>

              {/* Send to Projects */}
              <div className={`p-4 rounded ${
                isApprovalComplete && documentType.trim()
                  ? 'bg-green-50 border border-green-200'
                  : 'bg-gray-50 border border-gray-200'
              }`}>
                <h3 className="text-sm font-bold text-green-700 mb-3">üì§ Send to Projects</h3>
                <p className="text-[10px] text-gray-600 mb-3">Send this translation to a project for final review and delivery to client.</p>

                {/* Validation warnings */}
                {(!isApprovalComplete || !documentType.trim()) && (
                  <div className="mb-3 p-2 bg-yellow-50 border border-yellow-200 rounded">
                    <p className="text-[10px] text-yellow-700 font-medium">‚ö†Ô∏è Before sending, please complete:</p>
                    <ul className="text-[10px] text-yellow-600 mt-1 ml-4 list-disc">
                      {!documentType.trim() && <li>Fill in Document Type (in Details tab)</li>}
                      {!isApprovalComplete && <li>Complete all Approval Checklist items</li>}
                    </ul>
                  </div>
                )}

                <div className="flex flex-col space-y-2">
                  <select
                    value={selectedOrderId}
                    onChange={(e) => setSelectedOrderId(e.target.value)}
                    className="w-full px-2 py-1.5 text-xs border rounded"
                  >
                    <option value="">-- Select Order --</option>
                    {availableOrders.map(order => (
                      <option key={order.id} value={order.id}>
                        {order.order_number} - {order.client_name} ({order.translation_status})
                      </option>
                    ))}
                  </select>
                  <div className="flex space-x-2">
                    {/* Role-based delivery options */}
                    <select
                      value={sendDestination}
                      onChange={(e) => setSendDestination(e.target.value)}
                      className="px-2 py-2 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                      disabled={sendingToProjects}
                    >
                      {/* Admin sends to PM Admin for final processing */}
                      {isAdmin && <option value="pending_admin_approval">üì§ Send to PM Admin</option>}
                      {/* PM sends to Admin for final approval */}
                      {isPM && !isAdmin && <option value="pending_admin_approval">üì§ Send to Admin (Ready for Client)</option>}
                      {/* In-House Translator: Send to PM or Finalize to Admin (never to client) */}
                      {isInHouseTranslator && (
                        <>
                          <option value="pm">üì§ Send to PM (for review)</option>
                          <option value="finalize_admin">‚úÖ Finalize & Send to Admin</option>
                        </>
                      )}
                      {/* Contractor: Only send to PM */}
                      {isContractor && (
                        <option value="pm">üì§ Send to PM</option>
                      )}
                    </select>
                    <button
                      onClick={() => sendToProjects(sendDestination)}
                      disabled={!selectedOrderId || sendingToProjects || !isApprovalComplete || !documentType.trim()}
                      className={`flex-1 px-4 py-2 text-white text-xs rounded disabled:bg-gray-300 disabled:cursor-not-allowed ${
                        sendDestination === 'finalize_admin' ? 'bg-green-600 hover:bg-green-700' :
                        'bg-blue-600 hover:bg-blue-700'
                      }`}
                    >
                      {sendingToProjects ? '‚è≥ Sending...' : sendDestination === 'finalize_admin' ? '‚úÖ Finalize' : 'üì§ Deliver'}
                    </button>
                  </div>
                </div>
                {availableOrders.length === 0 && (
                  <p className="text-[10px] text-yellow-600 mt-2">No orders available. Create an order first in the Projects tab.</p>
                )}
              </div>

              {processingStatus && (
                <div className={`mt-4 p-3 rounded text-xs ${
                  processingStatus.includes('‚ùå') ? 'bg-red-100 text-red-700' :
                  processingStatus.includes('‚úÖ') ? 'bg-green-100 text-green-700' :
                  'bg-blue-100 text-blue-700'
                }`}>
                  {processingStatus}
                </div>
              )}

              {/* Navigation */}
              <div className="mt-6 flex justify-start">
                <button
                  onClick={() => setActiveSubTab('review')}
                  className="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded hover:bg-gray-300 flex items-center"
                >
                  <span className="mr-2">‚Üê</span> Back: Review
                </button>
              </div>
            </>
          )}

          {/* No translations message - only in normal flow */}
          {!quickPackageMode && translationResults.length === 0 && (
            <div className="text-center py-8 text-gray-500">
              <div className="text-4xl mb-2">üìÑ</div>
              <p className="text-xs">No translations yet. Complete the translation workflow first,</p>
              <p className="text-xs mb-4">or use <strong>Quick Package</strong> mode to upload ready translations.</p>
              <button
                onClick={() => setActiveSubTab('translate')}
                className="px-4 py-2 bg-blue-600 text-white text-xs rounded hover:bg-blue-700"
              >
                Go to Document
              </button>
            </div>
          )}
        </div>
      )}

      {/* GLOSSARIES TAB */}
      {activeSubTab === 'glossaries' && (
        <div className="bg-white rounded shadow">
          <div className="p-4 border-b flex items-center justify-between">
            <div className="flex items-center space-x-2">
              <span className="text-lg">üåê</span>
              <div>
                <h2 className="text-sm font-bold">Glossaries & Translation Memories</h2>
                <p className="text-xs text-gray-500">Upload and manage terminology resources</p>
              </div>
            </div>
            <div className="flex space-x-2">
              {/* Upload Glossary Button */}
              <label className="px-3 py-1.5 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 flex items-center cursor-pointer">
                <input
                  type="file"
                  accept=".csv,.tmx,.xml,.xlsx,.xls,.sdltm"
                  className="hidden"
                  onChange={(e) => {
                    const file = e.target.files?.[0];
                    if (!file) return;
                    // Store file and show upload config modal
                    setGlossaryUploadFile(file);
                    setGlossaryUploadConfig({
                      name: file.name.replace(/\.(csv|tmx|xml|xlsx|xls|sdltm)$/i, ''),
                      sourceLang: resourcesFilter.language !== 'All Languages' ? resourcesFilter.language : 'Portuguese (Brazil)',
                      targetLang: 'English',
                      field: resourcesFilter.field !== 'All Fields' ? resourcesFilter.field : 'All Fields',
                      bidirectional: true
                    });
                    setShowGlossaryUploadModal(true);
                    e.target.value = ''; // Reset file input
                  }}
                />
                üì§ Upload Glossary
              </label>
              <button
                onClick={() => { setEditingGlossary(null); setGlossaryForm({ name: '', sourceLang: 'Portuguese (Brazil)', targetLang: 'English', bidirectional: true, field: 'All Fields', terms: [] }); setTermSearchQuery(''); setShowGlossaryModal(true); }}
                className="px-3 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 flex items-center"
              >
                <span className="mr-1">+</span> Add
              </button>
            </div>
          </div>
          <div className="p-4">
            {/* Filters */}
            <div className="flex space-x-3 mb-4">
              <select
                value={resourcesFilter.language}
                onChange={(e) => setResourcesFilter({ ...resourcesFilter, language: e.target.value })}
                className="px-3 py-1.5 text-xs border rounded"
              >
                <option>All Languages</option>
                {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
              </select>
              <select
                value={resourcesFilter.field}
                onChange={(e) => setResourcesFilter({ ...resourcesFilter, field: e.target.value })}
                className="px-3 py-1.5 text-xs border rounded"
              >
                <option>All Fields</option>
                <option>Financial</option>
                <option>Education</option>
                <option>General</option>
                <option>Personal Documents</option>
              </select>
            </div>

            {filteredGlossaries.length > 0 ? (
              <div className="space-y-2">
                {filteredGlossaries.map((gloss) => (
                  <div key={gloss.id} className="p-3 border rounded hover:bg-gray-50">
                    <div className="flex items-center justify-between">
                      <div>
                        <span className="text-xs font-medium">{gloss.name}</span>
                        <div className="flex flex-wrap gap-2 mt-1">
                          <span className="px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-[10px]">
                            {gloss.sourceLang || 'PT'} {gloss.bidirectional ? '‚Üî' : '‚Üí'} {gloss.targetLang || 'EN'}
                          </span>
                          <span className="px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-[10px]">{gloss.field}</span>
                          <span className="text-[10px] text-gray-500">{gloss.terms?.length || 0} terms</span>
                          {gloss.bidirectional && (
                            <span className="px-2 py-0.5 bg-green-50 text-green-600 rounded text-[10px]">‚Üî Bidirectional</span>
                          )}
                        </div>
                      </div>
                      <div className="flex space-x-1">
                        <button onClick={() => handleEditGlossary(gloss)} className="px-2 py-1 text-xs text-blue-600 hover:bg-blue-50 rounded">‚úèÔ∏è</button>
                        <button onClick={() => handleDeleteGlossary(gloss.id)} className="px-2 py-1 text-xs text-red-600 hover:bg-red-50 rounded">üóëÔ∏è</button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center py-8 text-gray-500">
                <p className="text-xs">No glossaries/TM yet. Click "Add" to upload one.</p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* INSTRUCTIONS TAB */}
      {activeSubTab === 'instructions' && (
        <div className="bg-white rounded shadow">
          <div className="p-4 border-b flex items-center justify-between">
            <div className="flex items-center space-x-2">
              <span className="text-lg">üìã</span>
              <div>
                <h2 className="text-sm font-bold">Translation Instructions</h2>
                <p className="text-xs text-gray-500">
                  {(isAdmin || isPM) ? 'Manage custom instructions for specific document types and language pairs' : 'View translation guidelines for document types and language pairs'}
                </p>
              </div>
            </div>
            {(isAdmin || isPM) && (
              <button
                onClick={() => {
                  setEditingInstruction(null);
                  setInstructionForm({
                    title: '',
                    sourceLang: 'All Languages',
                    targetLang: 'All Languages',
                    field: 'All Fields',
                    documentType: 'All Documents',
                    content: ''
                  });
                  setShowInstructionModal(true);
                }}
                className="px-3 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 flex items-center"
              >
                <span className="mr-1">+</span> Add Instruction
              </button>
            )}
          </div>
          <div className="p-4">
            {/* Filters */}
            <div className="flex space-x-3 mb-4">
              <select
                value={resourcesFilter.language}
                onChange={(e) => setResourcesFilter({ ...resourcesFilter, language: e.target.value })}
                className="px-3 py-1.5 text-xs border rounded"
              >
                <option>All Languages</option>
                {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
              </select>
              <select
                value={resourcesFilter.field}
                onChange={(e) => setResourcesFilter({ ...resourcesFilter, field: e.target.value })}
                className="px-3 py-1.5 text-xs border rounded"
              >
                <option>All Fields</option>
                <option>Financial</option>
                <option>Education</option>
                <option>Legal</option>
                <option>Medical</option>
                <option>Technical</option>
                <option>General</option>
                <option>Personal Documents</option>
              </select>
            </div>

            {/* Instructions List */}
            {instructions.filter(instr =>
              (resourcesFilter.language === 'All Languages' || instr.sourceLang === resourcesFilter.language || instr.targetLang === resourcesFilter.language) &&
              (resourcesFilter.field === 'All Fields' || instr.field === resourcesFilter.field)
            ).length > 0 ? (
              <div className="space-y-2">
                {instructions
                  .filter(instr =>
                    (resourcesFilter.language === 'All Languages' || instr.sourceLang === resourcesFilter.language || instr.targetLang === resourcesFilter.language) &&
                    (resourcesFilter.field === 'All Fields' || instr.field === resourcesFilter.field)
                  )
                  .map((instr) => (
                  <div key={instr.id} className="p-3 border rounded hover:bg-gray-50">
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <span className="text-sm font-medium text-gray-800">{instr.title}</span>
                          {instr.isDefault && (
                            <span className="px-2 py-0.5 bg-green-100 text-green-700 rounded text-[10px]">Default</span>
                          )}
                        </div>
                        <div className="flex flex-wrap gap-2 mb-2">
                          <span className="px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-[10px]">
                            {instr.sourceLang || 'PT'} ‚Üí {instr.targetLang || 'EN'}
                          </span>
                          <span className="px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-[10px]">{instr.field || 'General'}</span>
                          {instr.documentType && instr.documentType !== 'All Documents' && (
                            <span className="px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-[10px]">{instr.documentType}</span>
                          )}
                        </div>
                        <p className="text-xs text-gray-600 line-clamp-2">{instr.content}</p>
                      </div>
                      {(isAdmin || isPM) && (
                        <div className="flex space-x-1 ml-2">
                          <button
                            onClick={() => {
                              setEditingInstruction(instr);
                              setInstructionForm({
                                title: instr.title,
                                sourceLang: instr.sourceLang || 'Portuguese (Brazil)',
                                targetLang: instr.targetLang || 'English',
                                field: instr.field || 'All Fields',
                                documentType: instr.documentType || 'All Documents',
                                content: instr.content
                              });
                              setShowInstructionModal(true);
                            }}
                            className="px-2 py-1 text-xs text-blue-600 hover:bg-blue-50 rounded"
                          >
                            ‚úèÔ∏è
                          </button>
                          <button
                            onClick={async () => {
                              if (window.confirm(`Delete instruction "${instr.title}"?`)) {
                                try {
                                  await axios.delete(`${API}/admin/translation-instructions/${instr.id}?admin_key=${adminKey}`);
                                  setInstructions(instructions.filter(i => i.id !== instr.id));
                                } catch (err) {
                                  showToast('Failed to delete instruction: ' + (err.response?.data?.detail || err.message));
                                }
                              }
                            }}
                            className="px-2 py-1 text-xs text-red-600 hover:bg-red-50 rounded"
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center py-8 text-gray-500">
                <div className="text-4xl mb-2">üìã</div>
                <p className="text-sm font-medium mb-1">No instructions yet</p>
                <p className="text-xs">
                  {(isAdmin || isPM) ? 'Click "Add Instruction" to create custom translation guidelines.' : 'No translation guidelines have been created yet.'}
                </p>
                <p className="text-xs text-gray-400 mt-2">Instructions help the AI follow specific rules for document types, terminology, and formatting.</p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* TRANSLATION MEMORY TAB - Admin, PM, and In-House Translators */}
      {activeSubTab === 'tm' && (isAdmin || isPM || isInHouseTranslator) && (
        <div className="bg-white rounded shadow">
          <div className="p-4 border-b flex items-center justify-between">
            <div className="flex items-center space-x-2">
              <span className="text-lg">üß†</span>
              <div>
                <h2 className="text-sm font-bold">Translation Memory</h2>
                <p className="text-xs text-gray-500">Automatically collected from high-quality translations (score ‚â• 85%)</p>
              </div>
            </div>
            <div className="flex space-x-2">
              {/* Upload TM Button - only for admin, PM, and in-house translators */}
              <label className="px-3 py-1.5 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 flex items-center cursor-pointer">
                <input
                  type="file"
                  accept=".csv,.tmx,.xml,.xlsx,.xls,.sdltm"
                  className="hidden"
                  onChange={(e) => {
                    const file = e.target.files?.[0];
                    if (!file) return;
                    setTmUploadFile(file);
                    setShowTmUploadModal(true);
                    e.target.value = ''; // Reset file input
                  }}
                />
                üì§ Upload TM
              </label>
              <button
                onClick={async () => {
                  try {
                    const response = await axios.get(`${API}/admin/translation-memory/download?admin_key=${adminKey}&format=csv`);
                    const blob = new Blob([response.data.content], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = response.data.filename;
                    a.click();
                    window.URL.revokeObjectURL(url);
                  } catch (err) {
                    showToast('Failed to download: ' + err.message);
                  }
                }}
                className="px-3 py-1.5 bg-green-600 text-white text-xs rounded hover:bg-green-700 flex items-center"
              >
                üì• Download CSV
              </button>
              <button
                onClick={async () => {
                  try {
                    const response = await axios.get(`${API}/admin/translation-memory/download?admin_key=${adminKey}&format=tmx`);
                    const blob = new Blob([response.data.content], { type: 'application/xml' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = response.data.filename;
                    a.click();
                    window.URL.revokeObjectURL(url);
                  } catch (err) {
                    showToast('Failed to download: ' + err.message);
                  }
                }}
                className="px-3 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 flex items-center"
              >
                üì• Download TMX
              </button>
              <button
                onClick={async () => {
                  if (!window.confirm('Clear ALL Translation Memory entries? This cannot be undone.')) return;
                  try {
                    await axios.delete(`${API}/admin/translation-memory?admin_key=${adminKey}`);
                    setProcessingStatus('‚úÖ Translation Memory cleared');
                    // Refresh TM list
                    const res = await axios.get(`${API}/admin/translation-memory?admin_key=${adminKey}`);
                    setTranslationMemories(res.data.memories || []);
                  } catch (err) {
                    showToast('Failed to clear: ' + err.message);
                  }
                }}
                className="px-3 py-1.5 bg-red-100 text-red-600 text-xs rounded hover:bg-red-200 flex items-center"
              >
                üóëÔ∏è Clear All
              </button>
            </div>
          </div>
          <div className="p-4">
            {/* Filters */}
            <div className="flex space-x-3 mb-4">
              <select
                value={tmFilter.sourceLang}
                onChange={(e) => setTmFilter({ ...tmFilter, sourceLang: e.target.value })}
                className="px-3 py-1.5 text-xs border rounded"
              >
                <option value="">All Source Languages</option>
                {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
              </select>
              <select
                value={tmFilter.targetLang}
                onChange={(e) => setTmFilter({ ...tmFilter, targetLang: e.target.value })}
                className="px-3 py-1.5 text-xs border rounded"
              >
                <option value="">All Target Languages</option>
                {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
              </select>
              <select
                value={tmFilter.field}
                onChange={(e) => setTmFilter({ ...tmFilter, field: e.target.value })}
                className="px-3 py-1.5 text-xs border rounded"
              >
                <option value="">All Fields</option>
                <option value="General">General</option>
                <option value="Financial">Financial</option>
                <option value="Education">Education</option>
                <option value="Legal">Legal</option>
                <option value="Medical">Medical</option>
                <option value="Technical">Technical</option>
                <option value="Personal Documents">Personal Documents</option>
              </select>
              <button
                onClick={async () => {
                  try {
                    let url = `${API}/admin/translation-memory?admin_key=${adminKey}`;
                    if (tmFilter.sourceLang) url += `&sourceLang=${encodeURIComponent(tmFilter.sourceLang)}`;
                    if (tmFilter.targetLang) url += `&targetLang=${encodeURIComponent(tmFilter.targetLang)}`;
                    if (tmFilter.field) url += `&field=${encodeURIComponent(tmFilter.field)}`;
                    const res = await axios.get(url);
                    setTranslationMemories(res.data.memories || []);
                  } catch (err) {
                    showToast('Failed to load TM: ' + err.message);
                  }
                }}
                className="px-3 py-1.5 bg-gray-100 text-gray-700 text-xs rounded hover:bg-gray-200"
              >
                üîÑ Refresh
              </button>
            </div>

            {/* TM Stats */}
            <div className="mb-3 flex items-center gap-4 text-xs">
              <span className="bg-gray-100 px-3 py-1 rounded">
                Total: <strong>{translationMemories.length}</strong> entries
              </span>
              <span className="bg-purple-50 text-purple-700 px-3 py-1 rounded">
                üì§ Uploaded: <strong>{translationMemories.filter(tm => tm.is_uploaded).length}</strong>
              </span>
              <span className="bg-green-50 text-green-700 px-3 py-1 rounded">
                ü§ñ Auto-generated: <strong>{translationMemories.filter(tm => !tm.is_uploaded).length}</strong>
              </span>
            </div>

            {/* TM Entries Table */}
            {translationMemories.length > 0 ? (
              <div className="border rounded overflow-hidden">
                <div className="px-3 py-2 bg-gray-50 border-b text-xs text-gray-600 flex justify-between items-center">
                  <span>Showing {Math.min(translationMemories.length, 500)} of {translationMemories.length} entries</span>
                  {translationMemories.length > 500 && (
                    <span className="text-orange-600">Use filters to narrow results or download full TM</span>
                  )}
                </div>
                <table className="w-full text-xs">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="px-3 py-2 text-left font-medium">Source</th>
                      <th className="px-3 py-2 text-left font-medium">Languages</th>
                      <th className="px-3 py-2 text-left font-medium">Source Text</th>
                      <th className="px-3 py-2 text-left font-medium">Target Text</th>
                      <th className="px-3 py-2 text-left font-medium">Field</th>
                      <th className="px-3 py-2 text-center font-medium">Score</th>
                      <th className="px-3 py-2 text-center font-medium">Actions</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {translationMemories.slice(0, 500).map((tm) => (
                      <tr key={tm.id} className="hover:bg-gray-50">
                        <td className="px-3 py-2">
                          <span className="px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-[10px]">
                            {tm.sourceLang?.substring(0, 10)} ‚Üí {tm.targetLang?.substring(0, 10)}
                          </span>
                        </td>
                        <td className="px-3 py-2 max-w-xs truncate" title={tm.source}>{tm.source}</td>
                        <td className="px-3 py-2 max-w-xs truncate" title={tm.target}>{tm.target}</td>
                        <td className="px-3 py-2">
                          <span className="px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-[10px]">{tm.field || 'General'}</span>
                        </td>
                        <td className="px-3 py-2 text-center">
                          <span className={`px-2 py-0.5 rounded text-[10px] font-medium ${
                            (tm.score || 0) >= 95 ? 'bg-green-100 text-green-700' :
                            (tm.score || 0) >= 85 ? 'bg-blue-100 text-blue-700' :
                            'bg-yellow-100 text-yellow-700'
                          }`}>
                            {tm.score ? `${tm.score}%` : '-'}
                          </span>
                        </td>
                        <td className="px-3 py-2 text-center">
                          <div className="flex items-center justify-center space-x-1">
                            <button
                              onClick={() => {
                                setEditingTmEntry(tm);
                                setTmEditForm({
                                  source: tm.source,
                                  target: tm.target,
                                  sourceLang: tm.sourceLang,
                                  targetLang: tm.targetLang,
                                  field: tm.field || 'General'
                                });
                                setShowTmEditModal(true);
                              }}
                              className="text-blue-500 hover:text-blue-700"
                              title="Edit entry"
                            >
                              ‚úèÔ∏è
                            </button>
                            <button
                              onClick={async () => {
                                if (!window.confirm('Delete this TM entry?')) return;
                                try {
                                  await axios.delete(`${API}/admin/translation-memory/${tm.id}?admin_key=${adminKey}`);
                                  setTranslationMemories(translationMemories.filter(t => t.id !== tm.id));
                                } catch (err) {
                                  showToast('Failed to delete: ' + err.message);
                                }
                              }}
                              className="text-red-500 hover:text-red-700"
                              title="Delete entry"
                            >
                              üóëÔ∏è
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                {translationMemories.length > 100 && (
                  <div className="p-2 bg-gray-50 text-center text-xs text-gray-500">
                    Showing 100 of {translationMemories.length} entries (newest first). Download to see all.
                  </div>
                )}
              </div>
            ) : (
              <div className="text-center py-8 text-gray-500">
                <div className="text-4xl mb-2">üß†</div>
                <p className="text-sm font-medium mb-1">No Translation Memory entries yet</p>
                <p className="text-xs">TM entries are automatically added after proofreading translations with a score ‚â• 85%</p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Instruction Modal - Only for admin and PM */}
      {showInstructionModal && (isAdmin || isPM) && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div className="p-4 border-b">
              <h3 className="font-bold">{editingInstruction ? 'Edit' : 'Add'} Translation Instruction</h3>
            </div>
            <div className="p-4 space-y-4">
              {/* Title */}
              <div>
                <label className="block text-xs font-medium mb-1">Title *</label>
                <input
                  type="text"
                  value={instructionForm.title}
                  onChange={(e) => setInstructionForm({ ...instructionForm, title: e.target.value })}
                  className="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-blue-400"
                  placeholder="e.g., Birth Certificate Guidelines"
                />
              </div>

              {/* Language Pair */}
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-medium mb-1">Source Language</label>
                  <select
                    value={instructionForm.sourceLang}
                    onChange={(e) => setInstructionForm({ ...instructionForm, sourceLang: e.target.value })}
                    className="w-full px-3 py-2 text-sm border rounded-lg"
                  >
                    <option value="All Languages">All Languages</option>
                    {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-medium mb-1">Target Language</label>
                  <select
                    value={instructionForm.targetLang}
                    onChange={(e) => setInstructionForm({ ...instructionForm, targetLang: e.target.value })}
                    className="w-full px-3 py-2 text-sm border rounded-lg"
                  >
                    <option value="All Languages">All Languages</option>
                    {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                  </select>
                </div>
              </div>

              {/* Field and Document Type */}
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-medium mb-1">Field</label>
                  <select
                    value={instructionForm.field}
                    onChange={(e) => setInstructionForm({ ...instructionForm, field: e.target.value })}
                    className="w-full px-3 py-2 text-sm border rounded-lg"
                  >
                    <option>All Fields</option>
                    <option>Financial</option>
                    <option>Education</option>
                    <option>Legal</option>
                    <option>Medical</option>
                    <option>Technical</option>
                    <option>General</option>
                    <option>Personal Documents</option>
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-medium mb-1">Document Type</label>
                  <select
                    value={instructionForm.documentType}
                    onChange={(e) => setInstructionForm({ ...instructionForm, documentType: e.target.value })}
                    className="w-full px-3 py-2 text-sm border rounded-lg"
                  >
                    <option>All Documents</option>
                    <option>Birth Certificate</option>
                    <option>Marriage Certificate</option>
                    <option>Death Certificate</option>
                    <option>Diploma</option>
                    <option>Academic Transcript</option>
                    <option>Driver's License</option>
                    <option>ID Card</option>
                    <option>Passport</option>
                    <option>Bank Statement</option>
                    <option>Tax Return</option>
                    <option>Contract</option>
                    <option>Power of Attorney</option>
                    <option>Court Document</option>
                    <option>Medical Record</option>
                    <option>Other</option>
                  </select>
                </div>
              </div>

              {/* Instructions Content */}
              <div>
                <label className="block text-xs font-medium mb-1">Instructions *</label>
                <textarea
                  value={instructionForm.content}
                  onChange={(e) => setInstructionForm({ ...instructionForm, content: e.target.value })}
                  className="w-full px-3 py-2 text-sm border rounded-lg h-48 font-mono"
                  placeholder="Enter translation guidelines and instructions...

Examples:
- Always translate 'Certid√£o de Nascimento' as 'Birth Certificate'
- Keep original names in their original form
- Format dates as MM/DD/YYYY
- Use American English spelling
- Preserve all official stamps and seals descriptions"
                />
                <p className="text-[10px] text-gray-500 mt-1">
                  These instructions will be included in the AI prompt when translating matching documents.
                </p>
              </div>

              {/* Example Instructions */}
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <p className="text-xs font-medium text-blue-700 mb-2">üí° Suggested Instructions:</p>
                <div className="flex flex-wrap gap-2">
                  {[
                    'Keep names in original form',
                    'Use formal register',
                    'Format dates as MM/DD/YYYY',
                    'American English spelling',
                    'Preserve formatting',
                    'Include [sic] for errors'
                  ].map((suggestion, idx) => (
                    <button
                      key={idx}
                      onClick={() => setInstructionForm({
                        ...instructionForm,
                        content: instructionForm.content + (instructionForm.content ? '\n- ' : '- ') + suggestion
                      })}
                      className="px-2 py-1 text-[10px] bg-white border border-blue-300 text-blue-700 rounded hover:bg-blue-100"
                    >
                      + {suggestion}
                    </button>
                  ))}
                </div>
              </div>
            </div>
            <div className="p-4 border-t flex justify-end space-x-2">
              <button
                onClick={() => setShowInstructionModal(false)}
                className="px-4 py-2 text-sm border rounded-lg hover:bg-gray-50"
              >
                Cancel
              </button>
              <button
                onClick={async () => {
                  if (!instructionForm.title || !instructionForm.content) {
                    showToast('Please fill in the title and instructions');
                    return;
                  }
                  try {
                    const payload = {
                      title: instructionForm.title,
                      sourceLang: instructionForm.sourceLang,
                      targetLang: instructionForm.targetLang,
                      field: instructionForm.field,
                      documentType: instructionForm.documentType,
                      content: instructionForm.content
                    };

                    if (editingInstruction) {
                      await axios.put(`${API}/admin/translation-instructions/${editingInstruction.id}?admin_key=${adminKey}`, payload);
                      setInstructions(instructions.map(i => i.id === editingInstruction.id ? { ...i, ...payload } : i));
                    } else {
                      const response = await axios.post(`${API}/admin/translation-instructions?admin_key=${adminKey}`, payload);
                      setInstructions([...instructions, { id: response.data.id || Date.now(), ...payload }]);
                    }
                    setShowInstructionModal(false);
                    setProcessingStatus('‚úÖ Instruction saved!');
                    setTimeout(() => setProcessingStatus(''), 3000);
                  } catch (err) {
                    showToast('Failed to save instruction: ' + (err.response?.data?.detail || err.message));
                  }
                }}
                className="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700"
              >
                Save Instruction
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Glossary Modal - Outside all tabs so it's always available */}
      {showGlossaryModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div className="p-4 border-b">
              <h3 className="font-bold">{editingGlossary ? 'Edit' : 'Add'} Glossary / TM</h3>
            </div>
            <div className="p-4 space-y-3">
              {/* Name and Field */}
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-medium mb-1">Name</label>
                  <input
                    type="text"
                    value={glossaryForm.name}
                    onChange={(e) => setGlossaryForm({ ...glossaryForm, name: e.target.value })}
                    className="w-full px-2 py-1.5 text-xs border rounded"
                    placeholder="e.g., Legal Terms PT-EN"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium mb-1">Field</label>
                  <select
                    value={glossaryForm.field}
                    onChange={(e) => setGlossaryForm({ ...glossaryForm, field: e.target.value })}
                    className="w-full px-2 py-1.5 text-xs border rounded"
                  >
                    <option>All Fields</option>
                    <option>Financial</option>
                    <option>Education</option>
                    <option>General</option>
                    <option>Personal Documents</option>
                  </select>
                </div>
              </div>

              {/* Language Pair */}
              <div className="bg-blue-50 border border-blue-200 rounded p-3">
                <label className="block text-xs font-bold mb-2">üåê Language Pair</label>
                <div className="flex items-center gap-2">
                  <select
                    value={glossaryForm.sourceLang}
                    onChange={(e) => setGlossaryForm({ ...glossaryForm, sourceLang: e.target.value })}
                    className="flex-1 px-2 py-1.5 text-xs border rounded"
                  >
                    {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                  </select>
                  <span className="text-lg font-bold text-blue-600">
                    {glossaryForm.bidirectional ? '‚Üî' : '‚Üí'}
                  </span>
                  <select
                    value={glossaryForm.targetLang}
                    onChange={(e) => setGlossaryForm({ ...glossaryForm, targetLang: e.target.value })}
                    className="flex-1 px-2 py-1.5 text-xs border rounded"
                  >
                    {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                  </select>
                </div>
                <label className="flex items-center gap-2 mt-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={glossaryForm.bidirectional}
                    onChange={(e) => setGlossaryForm({ ...glossaryForm, bidirectional: e.target.checked })}
                    className="rounded text-blue-600"
                  />
                  <span className="text-xs text-blue-700">
                    <strong>Bidirectional:</strong> Terms work both ways (PT ‚Üí EN and EN ‚Üí PT)
                  </span>
                </label>
              </div>

              {/* Add Single Term */}
              <div className="border-t pt-3">
                <label className="block text-xs font-medium mb-2">Add Single Term</label>
                <div className="flex space-x-2">
                  <input
                    type="text"
                    value={newTerm.source}
                    onChange={(e) => setNewTerm({ ...newTerm, source: e.target.value })}
                    className="flex-1 px-2 py-1.5 text-xs border rounded"
                    placeholder="Source term"
                  />
                  <input
                    type="text"
                    value={newTerm.target}
                    onChange={(e) => setNewTerm({ ...newTerm, target: e.target.value })}
                    className="flex-1 px-2 py-1.5 text-xs border rounded"
                    placeholder="Target term"
                  />
                  <input
                    type="text"
                    value={newTerm.notes}
                    onChange={(e) => setNewTerm({ ...newTerm, notes: e.target.value })}
                    className="flex-1 px-2 py-1.5 text-xs border rounded"
                    placeholder="Notes (optional)"
                  />
                  <button onClick={addTermToGlossary} className="px-3 py-1.5 bg-green-600 text-white text-xs rounded hover:bg-green-700">+</button>
                </div>
              </div>

              {/* Bulk Upload Terms */}
              <div className="border-t pt-3">
                <label className="block text-xs font-medium mb-2">üì§ Bulk Upload Terms (Paste Entire Glossary)</label>
                <div className="bg-green-50 border border-green-200 rounded p-2 mb-2">
                  <p className="text-[10px] text-green-700">
                    <strong>Format:</strong> One term per line: <code className="bg-green-100 px-1">{glossaryForm.sourceLang} | {glossaryForm.targetLang} | notes (optional)</code>
                  </p>
                  {glossaryForm.bidirectional && (
                    <p className="text-[10px] text-green-600 mt-1">
                      ‚Üî <strong>Bidirectional enabled:</strong> Terms will work in both translation directions automatically!
                    </p>
                  )}
                </div>
                <textarea
                  value={bulkTermsText}
                  onChange={(e) => setBulkTermsText(e.target.value)}
                  placeholder={`certid√£o de nascimento | birth certificate | legal document
carteira de identidade | identity card | ID document
CPF | individual taxpayer number | Brazilian tax ID
registro civil | civil registry
cart√≥rio | notary office | public registry
certid√£o de casamento | marriage certificate
certid√£o de √≥bito | death certificate
reconhecimento de firma | notarized signature
autentica√ß√£o | authentication
translation juramentada | certified translation`}
                  className="w-full px-2 py-1.5 text-xs border rounded h-40 font-mono resize-y"
                />
                <div className="flex items-center justify-between mt-2">
                  <span className="text-xs text-gray-500">
                    {bulkTermsText.trim() ? `${bulkTermsText.trim().split('\n').filter(l => l.trim() && l.includes('|')).length} valid terms detected` : 'Paste your glossary above'}
                  </span>
                  <div className="flex space-x-2">
                    <button
                      onClick={() => setBulkTermsText('')}
                      className="px-3 py-1.5 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300"
                    >
                      Clear
                    </button>
                    <button
                      onClick={() => {
                        const lines = bulkTermsText.trim().split('\n').filter(l => l.trim() && l.includes('|'));
                        const newTerms = lines.map(line => {
                          const parts = line.split('|').map(p => p.trim());
                          return {
                            id: Date.now() + Math.random(),
                            source: parts[0] || '',
                            target: parts[1] || '',
                            notes: parts[2] || ''
                          };
                        }).filter(t => t.source && t.target);

                        if (newTerms.length > 0) {
                          setGlossaryForm({
                            ...glossaryForm,
                            terms: [...glossaryForm.terms, ...newTerms]
                          });
                          setBulkTermsText('');
                          showToast(`‚úÖ Added ${newTerms.length} terms to glossary!`);
                        } else {
                          showToast('No valid terms found. Use format: source | target | notes');
                        }
                      }}
                      disabled={!bulkTermsText.trim()}
                      className="px-4 py-1.5 bg-green-600 text-white text-xs rounded hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                      üì• Import {bulkTermsText.trim().split('\n').filter(l => l.trim() && l.includes('|')).length} Terms
                    </button>
                  </div>
                </div>
              </div>

              {/* Terms List with Search */}
              {glossaryForm.terms.length > 0 && (
                <div className="border rounded">
                  {/* Header with count, search and actions */}
                  <div className="px-3 py-2 bg-gray-100 border-b">
                    <div className="flex justify-between items-center mb-2">
                      <span className="text-xs font-bold text-gray-700">üìö {glossaryForm.terms.length} terms loaded</span>
                      <button
                        onClick={() => {
                          if (window.confirm('Clear all terms? This cannot be undone.')) {
                            setGlossaryForm({...glossaryForm, terms: []});
                            setTermSearchQuery('');
                          }
                        }}
                        className="px-2 py-1 text-[10px] text-red-600 bg-red-50 rounded hover:bg-red-100"
                      >
                        üóëÔ∏è Clear All
                      </button>
                    </div>
                    {/* Search Input */}
                    <div className="relative">
                      <input
                        type="text"
                        value={termSearchQuery}
                        onChange={(e) => setTermSearchQuery(e.target.value)}
                        placeholder="üîç Search terms..."
                        className="w-full px-3 py-1.5 text-xs border rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                      />
                      {termSearchQuery && (
                        <button
                          onClick={() => setTermSearchQuery('')}
                          className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                        >
                          ‚úï
                        </button>
                      )}
                    </div>
                    {termSearchQuery && (
                      <p className="text-[10px] text-blue-600 mt-1">
                        Showing {glossaryForm.terms.filter(t =>
                          t.source.toLowerCase().includes(termSearchQuery.toLowerCase()) ||
                          t.target.toLowerCase().includes(termSearchQuery.toLowerCase()) ||
                          (t.notes && t.notes.toLowerCase().includes(termSearchQuery.toLowerCase()))
                        ).length} of {glossaryForm.terms.length} terms
                      </p>
                    )}
                  </div>

                  {/* Terms Table */}
                  <div className="max-h-64 overflow-y-auto">
                    <table className="w-full text-xs">
                      <thead className="bg-gray-50 sticky top-0">
                        <tr>
                          <th className="px-3 py-2 text-left font-medium text-gray-600">{glossaryForm.sourceLang}</th>
                          <th className="px-3 py-2 text-left font-medium text-gray-600">{glossaryForm.targetLang}</th>
                          <th className="px-3 py-2 text-left font-medium text-gray-600">Notes</th>
                          <th className="px-2 py-2 w-20 text-center font-medium text-gray-600">Actions</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y">
                        {glossaryForm.terms
                          .map((term, originalIdx) => ({ term, originalIdx }))
                          .filter(({ term }) =>
                            !termSearchQuery ||
                            term.source.toLowerCase().includes(termSearchQuery.toLowerCase()) ||
                            term.target.toLowerCase().includes(termSearchQuery.toLowerCase()) ||
                            (term.notes && term.notes.toLowerCase().includes(termSearchQuery.toLowerCase()))
                          )
                          .map(({ term, originalIdx }) => (
                            <tr key={term.id} className="hover:bg-blue-50 group">
                              <td className="px-2 py-1.5">
                                <input
                                  type="text"
                                  value={term.source}
                                  onChange={(e) => {
                                    const updated = [...glossaryForm.terms];
                                    updated[originalIdx].source = e.target.value;
                                    setGlossaryForm({...glossaryForm, terms: updated});
                                  }}
                                  className="w-full px-2 py-1 text-xs border border-transparent bg-transparent hover:border-gray-300 hover:bg-white focus:bg-white focus:border-blue-400 focus:ring-1 focus:ring-blue-400 rounded transition-all"
                                />
                              </td>
                              <td className="px-2 py-1.5">
                                <input
                                  type="text"
                                  value={term.target}
                                  onChange={(e) => {
                                    const updated = [...glossaryForm.terms];
                                    updated[originalIdx].target = e.target.value;
                                    setGlossaryForm({...glossaryForm, terms: updated});
                                  }}
                                  className="w-full px-2 py-1 text-xs border border-transparent bg-transparent hover:border-gray-300 hover:bg-white focus:bg-white focus:border-blue-400 focus:ring-1 focus:ring-blue-400 rounded transition-all"
                                />
                              </td>
                              <td className="px-2 py-1.5">
                                <input
                                  type="text"
                                  value={term.notes || ''}
                                  onChange={(e) => {
                                    const updated = [...glossaryForm.terms];
                                    updated[originalIdx].notes = e.target.value;
                                    setGlossaryForm({...glossaryForm, terms: updated});
                                  }}
                                  className="w-full px-2 py-1 text-xs text-gray-500 border border-transparent bg-transparent hover:border-gray-300 hover:bg-white focus:bg-white focus:border-blue-400 focus:ring-1 focus:ring-blue-400 rounded transition-all"
                                  placeholder="Add notes..."
                                />
                              </td>
                              <td className="px-2 py-1.5 text-center">
                                <button
                                  onClick={() => {
                                    if (window.confirm(`Delete "${term.source} ‚Üí ${term.target}"?`)) {
                                      removeTermFromGlossary(term.id);
                                    }
                                  }}
                                  className="px-2 py-1 text-red-500 hover:text-white hover:bg-red-500 rounded transition-all opacity-50 group-hover:opacity-100"
                                  title="Delete this term"
                                >
                                  üóëÔ∏è
                                </button>
                              </td>
                            </tr>
                          ))}
                      </tbody>
                    </table>
                  </div>

                  {/* No results message */}
                  {termSearchQuery && glossaryForm.terms.filter(t =>
                    t.source.toLowerCase().includes(termSearchQuery.toLowerCase()) ||
                    t.target.toLowerCase().includes(termSearchQuery.toLowerCase()) ||
                    (t.notes && t.notes.toLowerCase().includes(termSearchQuery.toLowerCase()))
                  ).length === 0 && (
                    <div className="p-4 text-center text-gray-500 text-xs">
                      No terms found matching "{termSearchQuery}"
                    </div>
                  )}
                </div>
              )}
            </div>
            <div className="p-4 border-t flex justify-end space-x-2">
              <button onClick={() => setShowGlossaryModal(false)} className="px-4 py-2 text-xs border rounded hover:bg-gray-50">Cancel</button>
              <button onClick={handleSaveGlossary} className="px-4 py-2 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
            </div>
          </div>
        </div>
      )}

      {/* Glossary Upload Configuration Modal */}
      {showGlossaryUploadModal && glossaryUploadFile && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div className="p-4 border-b bg-purple-50">
              <h3 className="font-bold text-purple-700">Upload Glossary</h3>
              <p className="text-xs text-purple-600 mt-1">Configure language pair for your glossary file</p>
            </div>
            <div className="p-4 space-y-4">
              {/* File Info */}
              <div className="flex items-center gap-2 p-2 bg-gray-50 rounded border">
                <span className="text-lg">üìÑ</span>
                <div className="flex-1 min-w-0">
                  <p className="text-xs font-medium text-gray-700 truncate">{glossaryUploadFile.name}</p>
                  <p className="text-[10px] text-gray-500">{(glossaryUploadFile.size / 1024).toFixed(1)} KB</p>
                </div>
              </div>

              {/* Glossary Name */}
              <div>
                <label className="block text-xs font-medium mb-1">Glossary Name</label>
                <input
                  type="text"
                  value={glossaryUploadConfig.name}
                  onChange={(e) => setGlossaryUploadConfig({ ...glossaryUploadConfig, name: e.target.value })}
                  className="w-full px-3 py-2 text-xs border rounded focus:ring-2 focus:ring-purple-400 focus:border-purple-400"
                  placeholder="e.g., Legal Terms ES-EN"
                />
              </div>

              {/* Language Pair */}
              <div className="bg-blue-50 border border-blue-200 rounded p-3">
                <label className="block text-xs font-bold mb-2">Language Pair</label>
                <div className="flex items-center gap-2">
                  <div className="flex-1">
                    <label className="block text-[10px] text-gray-500 mb-1">Source Language</label>
                    <select
                      value={glossaryUploadConfig.sourceLang}
                      onChange={(e) => setGlossaryUploadConfig({ ...glossaryUploadConfig, sourceLang: e.target.value })}
                      className="w-full px-2 py-1.5 text-xs border rounded"
                    >
                      {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                    </select>
                  </div>
                  <span className="text-lg font-bold text-blue-600 mt-4">
                    {glossaryUploadConfig.bidirectional ? '‚Üî' : '‚Üí'}
                  </span>
                  <div className="flex-1">
                    <label className="block text-[10px] text-gray-500 mb-1">Target Language</label>
                    <select
                      value={glossaryUploadConfig.targetLang}
                      onChange={(e) => setGlossaryUploadConfig({ ...glossaryUploadConfig, targetLang: e.target.value })}
                      className="w-full px-2 py-1.5 text-xs border rounded"
                    >
                      {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                    </select>
                  </div>
                </div>
                <label className="flex items-center gap-2 mt-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={glossaryUploadConfig.bidirectional}
                    onChange={(e) => setGlossaryUploadConfig({ ...glossaryUploadConfig, bidirectional: e.target.checked })}
                    className="rounded text-blue-600"
                  />
                  <span className="text-xs text-blue-700">
                    <strong>Bidirectional:</strong> Terms work both ways
                  </span>
                </label>
              </div>

              {/* Field */}
              <div>
                <label className="block text-xs font-medium mb-1">Field</label>
                <select
                  value={glossaryUploadConfig.field}
                  onChange={(e) => setGlossaryUploadConfig({ ...glossaryUploadConfig, field: e.target.value })}
                  className="w-full px-3 py-2 text-xs border rounded"
                >
                  <option>All Fields</option>
                  <option>Financial</option>
                  <option>Education</option>
                  <option>General</option>
                  <option>Personal Documents</option>
                </select>
              </div>
            </div>

            {/* Actions */}
            <div className="p-4 border-t flex justify-end space-x-2">
              <button
                onClick={() => {
                  setShowGlossaryUploadModal(false);
                  setGlossaryUploadFile(null);
                }}
                className="px-4 py-2 text-xs border rounded hover:bg-gray-50"
              >
                Cancel
              </button>
              <button
                onClick={async () => {
                  if (!glossaryUploadConfig.name.trim()) {
                    showToast('Please enter a name for the glossary');
                    return;
                  }

                  const formData = new FormData();
                  formData.append('file', glossaryUploadFile);
                  formData.append('name', glossaryUploadConfig.name);
                  formData.append('sourceLang', glossaryUploadConfig.sourceLang);
                  formData.append('targetLang', glossaryUploadConfig.targetLang);
                  formData.append('field', glossaryUploadConfig.field);
                  formData.append('bidirectional', glossaryUploadConfig.bidirectional.toString());

                  try {
                    setShowGlossaryUploadModal(false);
                    setProcessingStatus('Uploading glossary...');
                    const response = await axios.post(
                      `${API}/admin/glossaries/upload?admin_key=${adminKey}`,
                      formData,
                      { headers: { 'Content-Type': 'multipart/form-data' } }
                    );
                    setProcessingStatus(`${response.data.message}`);
                    // Refresh glossaries list
                    const res = await axios.get(`${API}/admin/glossaries?admin_key=${adminKey}`);
                    setGlossaries(res.data.glossaries || []);
                  } catch (err) {
                    showToast('Upload failed: ' + (err.response?.data?.detail || err.message));
                    setProcessingStatus('');
                  }
                  setGlossaryUploadFile(null);
                }}
                className="px-4 py-2 text-xs bg-purple-600 text-white rounded hover:bg-purple-700"
              >
                Upload
              </button>
            </div>
          </div>
        </div>
      )}

      {/* TM Upload Modal */}
      {showTmUploadModal && tmUploadFile && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div className="p-4 border-b bg-purple-50">
              <h3 className="font-bold text-purple-700">Upload Translation Memory</h3>
              <p className="text-xs text-purple-600 mt-1">Configure language pair and field for your TM file</p>
            </div>
            <div className="p-4 space-y-4">
              {/* File Info */}
              <div className="flex items-center gap-2 p-2 bg-gray-50 rounded border">
                <span className="text-lg">üìÑ</span>
                <div className="flex-1 min-w-0">
                  <p className="text-xs font-medium text-gray-700 truncate">{tmUploadFile.name}</p>
                  <p className="text-[10px] text-gray-500">{(tmUploadFile.size / 1024).toFixed(1)} KB</p>
                </div>
              </div>

              {/* Language Pair */}
              <div className="bg-blue-50 border border-blue-200 rounded p-3">
                <label className="block text-xs font-bold mb-2">Language Pair</label>
                <div className="flex items-center gap-2">
                  <div className="flex-1">
                    <label className="block text-[10px] text-gray-500 mb-1">Source Language</label>
                    <select
                      value={tmUploadConfig.sourceLang}
                      onChange={(e) => setTmUploadConfig({ ...tmUploadConfig, sourceLang: e.target.value })}
                      className="w-full px-2 py-1.5 text-xs border rounded"
                    >
                      {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                    </select>
                  </div>
                  <span className="text-lg font-bold text-blue-600 mt-4">‚Üí</span>
                  <div className="flex-1">
                    <label className="block text-[10px] text-gray-500 mb-1">Target Language</label>
                    <select
                      value={tmUploadConfig.targetLang}
                      onChange={(e) => setTmUploadConfig({ ...tmUploadConfig, targetLang: e.target.value })}
                      className="w-full px-2 py-1.5 text-xs border rounded"
                    >
                      {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                    </select>
                  </div>
                </div>
              </div>

              {/* Field */}
              <div>
                <label className="block text-xs font-medium mb-1">Field</label>
                <select
                  value={tmUploadConfig.field}
                  onChange={(e) => setTmUploadConfig({ ...tmUploadConfig, field: e.target.value })}
                  className="w-full px-3 py-2 text-xs border rounded"
                >
                  <option>General</option>
                  <option>Financial</option>
                  <option>Education</option>
                  <option>Legal</option>
                  <option>Medical</option>
                  <option>Technical</option>
                  <option>Personal Documents</option>
                </select>
              </div>
            </div>

            {/* Actions */}
            <div className="p-4 border-t flex justify-end space-x-2">
              <button
                onClick={() => {
                  setShowTmUploadModal(false);
                  setTmUploadFile(null);
                }}
                className="px-4 py-2 text-xs border rounded hover:bg-gray-50"
              >
                Cancel
              </button>
              <button
                onClick={async () => {
                  const formData = new FormData();
                  formData.append('file', tmUploadFile);
                  formData.append('sourceLang', tmUploadConfig.sourceLang);
                  formData.append('targetLang', tmUploadConfig.targetLang);
                  formData.append('field', tmUploadConfig.field);

                  try {
                    setShowTmUploadModal(false);
                    setProcessingStatus('Uploading TM...');
                    const response = await axios.post(
                      `${API}/admin/translation-memory/upload?admin_key=${adminKey}`,
                      formData,
                      { headers: { 'Content-Type': 'multipart/form-data' } }
                    );
                    setProcessingStatus(`‚úÖ ${response.data.message}`);
                    // Refresh TM list
                    const res = await axios.get(`${API}/admin/translation-memory?admin_key=${adminKey}`);
                    setTranslationMemories(res.data.memories || []);
                  } catch (err) {
                    showToast('Upload failed: ' + (err.response?.data?.detail || err.message));
                    setProcessingStatus('');
                  }
                  setTmUploadFile(null);
                }}
                className="px-4 py-2 text-xs bg-purple-600 text-white rounded hover:bg-purple-700"
              >
                Upload
              </button>
            </div>
          </div>
        </div>
      )}

      {/* TM Edit Modal */}
      {showTmEditModal && editingTmEntry && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
            <div className="p-4 border-b bg-purple-50">
              <h3 className="font-bold text-purple-700">Edit Translation Memory Entry</h3>
              <p className="text-xs text-purple-600 mt-1">Modify the source text, target text, or metadata</p>
            </div>
            <div className="p-4 space-y-4">
              {/* Language Pair */}
              <div className="bg-blue-50 border border-blue-200 rounded p-3">
                <label className="block text-xs font-bold mb-2">Language Pair</label>
                <div className="flex items-center gap-2">
                  <div className="flex-1">
                    <label className="block text-[10px] text-gray-500 mb-1">Source Language</label>
                    <select
                      value={tmEditForm.sourceLang}
                      onChange={(e) => setTmEditForm({ ...tmEditForm, sourceLang: e.target.value })}
                      className="w-full px-2 py-1.5 text-xs border rounded"
                    >
                      {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                    </select>
                  </div>
                  <span className="text-lg font-bold text-blue-600 mt-4">‚Üí</span>
                  <div className="flex-1">
                    <label className="block text-[10px] text-gray-500 mb-1">Target Language</label>
                    <select
                      value={tmEditForm.targetLang}
                      onChange={(e) => setTmEditForm({ ...tmEditForm, targetLang: e.target.value })}
                      className="w-full px-2 py-1.5 text-xs border rounded"
                    >
                      {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                    </select>
                  </div>
                </div>
              </div>

              {/* Source Text */}
              <div>
                <label className="block text-xs font-medium mb-1">Source Text</label>
                <textarea
                  value={tmEditForm.source}
                  onChange={(e) => setTmEditForm({ ...tmEditForm, source: e.target.value })}
                  className="w-full px-3 py-2 text-xs border rounded resize-none"
                  rows={3}
                  placeholder="Original text..."
                />
              </div>

              {/* Target Text */}
              <div>
                <label className="block text-xs font-medium mb-1">Target Text</label>
                <textarea
                  value={tmEditForm.target}
                  onChange={(e) => setTmEditForm({ ...tmEditForm, target: e.target.value })}
                  className="w-full px-3 py-2 text-xs border rounded resize-none"
                  rows={3}
                  placeholder="Translated text..."
                />
              </div>

              {/* Field */}
              <div>
                <label className="block text-xs font-medium mb-1">Field</label>
                <select
                  value={tmEditForm.field}
                  onChange={(e) => setTmEditForm({ ...tmEditForm, field: e.target.value })}
                  className="w-full px-3 py-2 text-xs border rounded"
                >
                  <option>General</option>
                  <option>Financial</option>
                  <option>Education</option>
                  <option>Legal</option>
                  <option>Medical</option>
                  <option>Technical</option>
                  <option>Personal Documents</option>
                </select>
              </div>
            </div>

            {/* Actions */}
            <div className="p-4 border-t flex justify-end space-x-2">
              <button
                onClick={() => {
                  setShowTmEditModal(false);
                  setEditingTmEntry(null);
                }}
                className="px-4 py-2 text-xs border rounded hover:bg-gray-50"
              >
                Cancel
              </button>
              <button
                onClick={async () => {
                  if (!tmEditForm.source.trim() || !tmEditForm.target.trim()) {
                    showToast('Source and target text are required');
                    return;
                  }

                  try {
                    await axios.put(
                      `${API}/admin/translation-memory/${editingTmEntry.id}?admin_key=${adminKey}`,
                      {
                        source: tmEditForm.source,
                        target: tmEditForm.target,
                        sourceLang: tmEditForm.sourceLang,
                        targetLang: tmEditForm.targetLang,
                        field: tmEditForm.field
                      }
                    );

                    // Update local state
                    setTranslationMemories(translationMemories.map(tm =>
                      tm.id === editingTmEntry.id
                        ? { ...tm, ...tmEditForm }
                        : tm
                    ));

                    setShowTmEditModal(false);
                    setEditingTmEntry(null);
                    setProcessingStatus('‚úÖ TM entry updated successfully');
                  } catch (err) {
                    showToast('Failed to update: ' + (err.response?.data?.detail || err.message));
                  }
                }}
                className="px-4 py-2 text-xs bg-purple-600 text-white rounded hover:bg-purple-700"
              >
                Save Changes
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Restore Session Modal */}
      {showRestoreModal && restoreSessionData && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div className="p-4 border-b bg-blue-50">
              <h3 className="font-bold text-blue-700">Found unsaved work</h3>
              <p className="text-xs text-blue-600 mt-1">
                From {new Date(restoreSessionData.timestamp).toLocaleString()}
              </p>
            </div>

            <div className="p-4 space-y-3">
              <div className="text-sm space-y-2">
                <p><strong>Order:</strong> {restoreSessionData.orderNumber || 'Not set'}</p>
                <p><strong>Document Type:</strong> {restoreSessionData.documentType || 'Not set'}</p>
                <p><strong>Translation texts:</strong> {restoreSessionData.translationResults?.length || 0}</p>
              </div>

              {restoreSessionData.originalImagesCount > 0 && (
                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                  <p className="text-sm text-yellow-700">
                    <span className="font-medium">Note:</span> {restoreSessionData.originalImagesCount} original document(s) need to be re-uploaded.
                  </p>
                </div>
              )}

              <p className="text-sm text-gray-600 pt-2">Do you want to restore this session?</p>
            </div>

            {/* Modal Actions */}
            <div className="p-4 border-t bg-gray-50 flex flex-col gap-2">
              <div className="flex justify-end gap-3">
                <button
                  onClick={() => handleRestoreSession('discard')}
                  className="px-4 py-2 text-sm border rounded-lg hover:bg-gray-100"
                >
                  Cancel
                </button>
                <button
                  onClick={() => handleRestoreSession('restore')}
                  className="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                >
                  Restore
                </button>
              </div>
              <div className="flex justify-center pt-2 border-t mt-2">
                <button
                  onClick={() => handleRestoreSession('never')}
                  className="text-xs text-gray-500 hover:text-gray-700 underline"
                >
                  Don't ask again (disable restore prompts)
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Rejection Modal - PM/Admin can choose which translator to send back to */}
      {showRejectModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div className="p-4 border-b bg-red-50">
              <h3 className="font-bold text-red-700">‚ùå Reject Translation</h3>
              <p className="text-xs text-red-600 mt-1">Send this translation back for revision</p>
            </div>

            <div className="p-4 space-y-4">
              {/* Translator Selection */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Send back to translator: *
                </label>
                {loadingTranslators ? (
                  <div className="text-center py-4 text-gray-500 text-sm">Loading translators...</div>
                ) : (
                  <select
                    value={selectedTranslatorForReject}
                    onChange={(e) => setSelectedTranslatorForReject(e.target.value)}
                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-400 focus:border-red-400"
                  >
                    <option value="">-- Select Translator --</option>
                    {availableTranslators.map((t) => (
                      <option key={t.id} value={t.id.toString()}>
                        {t.name} {t.translator_type === 'in_house' ? '(In-House)' : '(Contractor)'}
                      </option>
                    ))}
                  </select>
                )}
                {availableTranslators.length === 0 && !loadingTranslators && (
                  <p className="text-xs text-red-500 mt-1">No translators available</p>
                )}
              </div>

              {/* Rejection Reason */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Reason for rejection: *
                </label>
                <textarea
                  value={rejectReason}
                  onChange={(e) => setRejectReason(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-400 focus:border-red-400 h-32 resize-none"
                  placeholder="Explain what needs to be corrected..."
                />
              </div>
            </div>

            {/* Modal Actions */}
            <div className="p-4 border-t bg-gray-50 flex justify-end gap-3">
              <button
                onClick={() => setShowRejectModal(false)}
                className="px-4 py-2 text-sm border rounded-lg hover:bg-gray-100"
              >
                Cancel
              </button>
              <button
                onClick={confirmRejectTranslation}
                disabled={!selectedTranslatorForReject || !rejectReason.trim() || sendingToProjects}
                className="px-4 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2"
              >
                {sendingToProjects ? 'Rejecting...' : '‚ùå Confirm Reject'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Floating Chat Widget for Translator - Send messages to Admin/PM */}
      {isTranslator && (
        <>
          {/* Floating Button */}
          <button
            onClick={() => {
              setShowTranslatorChat(!showTranslatorChat);
              if (!showTranslatorChat && adminPmList.length === 0) {
                fetchAdminPmList();
              }
            }}
            className="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-full shadow-lg hover:from-purple-700 hover:to-purple-800 flex items-center justify-center z-50 transition-all hover:scale-105"
            title="Send message to Admin/PM"
          >
            {showTranslatorChat ? (
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            ) : (
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
            )}
          </button>

          {/* Chat Panel */}
          {showTranslatorChat && (
            <div className="fixed bottom-24 right-6 w-80 bg-white rounded-lg shadow-2xl border z-50 overflow-hidden">
              <div className="p-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white">
                <h3 className="font-bold text-sm">üí¨ Send Message to Admin/PM</h3>
                <p className="text-xs opacity-80">Contact administration</p>
              </div>
              <div className="p-3 space-y-3">
                <div>
                  <label className="block text-xs font-medium text-gray-700 mb-1">Send to:</label>
                  <select
                    value={selectedAdminPm}
                    onChange={(e) => setSelectedAdminPm(e.target.value)}
                    className="w-full px-2 py-1.5 border rounded text-sm"
                  >
                    <option value="">-- Select recipient --</option>
                    {adminPmList.map(u => (
                      <option key={u.id} value={u.id}>
                        {u.name} ({u.roleLabel})
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-700 mb-1">Message:</label>
                  <textarea
                    value={translatorChatMessage}
                    onChange={(e) => setTranslatorChatMessage(e.target.value)}
                    placeholder="Type your message..."
                    rows="3"
                    className="w-full px-2 py-1.5 border rounded text-sm resize-none"
                  />
                </div>
                <button
                  onClick={sendTranslatorMessageToAdmin}
                  disabled={sendingTranslatorMessage || !selectedAdminPm || !translatorChatMessage.trim()}
                  className="w-full px-3 py-2 bg-purple-600 text-white rounded text-sm hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                >
                  {sendingTranslatorMessage ? 'Sending...' : 'üì§ Send Message'}
                </button>
              </div>
            </div>
          )}
        </>
      )}

      </div>
    </div>
  );
};

// ==================== PROJECTS PAGE ====================
const ProjectsPage = ({ adminKey, onTranslate, user }) => {
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');

  // Pagination state
  const [currentPage, setCurrentPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [totalCount, setTotalCount] = useState(0);
  const [pageSize] = useState(50);
  const [assigningTranslator, setAssigningTranslator] = useState(null); // Order ID being assigned
  const [assigningPM, setAssigningPM] = useState(null); // Order ID being assigned PM
  const [openActionsDropdown, setOpenActionsDropdown] = useState(null); // Order ID with open actions dropdown

  // Delivery Modal state
  const [showDeliveryModal, setShowDeliveryModal] = useState(false);
  const [deliveryModalOrder, setDeliveryModalOrder] = useState(null);
  const [deliveryTranslationHtml, setDeliveryTranslationHtml] = useState('');
  const [deliverySending, setDeliverySending] = useState(false);
  const [deliveryStatus, setDeliveryStatus] = useState('');
  const [deliveryIncludeVerification, setDeliveryIncludeVerification] = useState(true);

  // Translator stats for PM view
  const [translatorStats, setTranslatorStats] = useState({ available: 0, busy: 0, total: 0 });
  const [translatorsWithStatus, setTranslatorsWithStatus] = useState([]); // List of translators with details
  const [showTranslatorsList, setShowTranslatorsList] = useState(false); // Toggle translator list view

  // Check if user is PM
  const isPM = user?.role === 'pm';
  const isAdmin = user?.role === 'admin';

  // New Project Form
  const [showNewProjectForm, setShowNewProjectForm] = useState(false);
  const [pmList, setPmList] = useState([]);
  const [translatorList, setTranslatorList] = useState([]);
  const [creatingProject, setCreatingProject] = useState(false);
  const [documentFiles, setDocumentFiles] = useState([]);

  // Document viewer state
  const [viewingOrder, setViewingOrder] = useState(null);
  const [orderDocuments, setOrderDocuments] = useState([]);
  const [selectedDocsForDelivery, setSelectedDocsForDelivery] = useState([]); // IDs of translated docs selected for client delivery
  const [loadingDocuments, setLoadingDocuments] = useState(false);
  const [projectModalTab, setProjectModalTab] = useState('details');
  const [uploadingProjectDoc, setUploadingProjectDoc] = useState(false);
  const [fileTranslatorAssignments, setFileTranslatorAssignments] = useState({}); // { docId: translatorId }
  const [editingNotes, setEditingNotes] = useState(false);
  const [tempNotes, setTempNotes] = useState({ client: '', internal: '' });
  const [editingModalDeadline, setEditingModalDeadline] = useState(false);
  const [tempModalDeadline, setTempModalDeadline] = useState({ date: '', time: '' });
  const [editingProject, setEditingProject] = useState(false);
  const [editFormData, setEditFormData] = useState({});
  const [savingProject, setSavingProject] = useState(false);

  // Editing states for inline edits
  const [editingTags, setEditingTags] = useState(null); // Order ID being edited
  const [editingDeadline, setEditingDeadline] = useState(null); // Order ID being edited for client deadline
  const [editingTranslatorDeadline, setEditingTranslatorDeadline] = useState(null); // Order ID being edited for translator deadline
  const [tempTagValue, setTempTagValue] = useState({ type: 'professional', notes: '' });
  const [tempDeadlineValue, setTempDeadlineValue] = useState({ date: '', time: '' });
  const [tempTranslatorDeadlineValue, setTempTranslatorDeadlineValue] = useState({ date: '', time: '' });

  // Send to Client modal state
  const [sendingOrder, setSendingOrder] = useState(null); // Order being sent
  const [translatedDocInfo, setTranslatedDocInfo] = useState(null);
  const [uploadingFile, setUploadingFile] = useState(false);
  const [sendingToClient, setSendingToClient] = useState(false);
  const [sendBccEmail, setSendBccEmail] = useState(''); // BCC email address
  const [notifyPM, setNotifyPM] = useState(true); // Notify assigned PM
  const [additionalAttachments, setAdditionalAttachments] = useState([]); // Multiple uploaded files
  const [selectedAttachments, setSelectedAttachments] = useState({ workspace: true, uploaded: [] }); // Which attachments to send
  const [externalAttachment, setExternalAttachment] = useState(null); // External attachment for resend (not saved to system)

  // Send message to translator state
  const [messagingTranslator, setMessagingTranslator] = useState(null); // { id, name, email, order_number }
  const [translatorMessageContent, setTranslatorMessageContent] = useState('');
  const [sendingTranslatorMessage, setSendingTranslatorMessage] = useState(false);

  // Translator Assignment Modal state
  const [assigningTranslatorModal, setAssigningTranslatorModal] = useState(null); // Order to assign
  const [assignmentDetails, setAssignmentDetails] = useState({
    translator_id: '',
    due_date: '',
    due_time: '17:00',
    project_notes: '',
    language_pair: ''
  });
  const [sendingAssignment, setSendingAssignment] = useState(false);

  // Quick Add Translator state (for PM)
  const [showQuickAddTranslator, setShowQuickAddTranslator] = useState(false);
  const [newTranslatorData, setNewTranslatorData] = useState({
    name: '',
    email: '',
    password: '',
    rate_per_page: '',
    rate_per_word: '',
    language_pairs: ''
  });
  const [addingTranslator, setAddingTranslator] = useState(false);

  // Notifications state
  const [notifications, setNotifications] = useState([]);
  const [showNotifications, setShowNotifications] = useState(false);

  // Partner Messages state
  const [partnerMessages, setPartnerMessages] = useState([]);
  const [showPartnerMessages, setShowPartnerMessages] = useState(false);
  const [replyingToMessage, setReplyingToMessage] = useState(null);
  const [replyContent, setReplyContent] = useState('');
  const [sendingReply, setSendingReply] = useState(false);

  // QuickBooks state
  const [qbConnected, setQbConnected] = useState(false);
  const [qbSyncing, setQbSyncing] = useState({});

  // Review Modal state (PM Side-by-Side Review)
  const [reviewingOrder, setReviewingOrder] = useState(null);
  const [reviewOriginalDocs, setReviewOriginalDocs] = useState([]);
  const [reviewTranslatedDoc, setReviewTranslatedDoc] = useState(null);
  const [loadingReview, setLoadingReview] = useState(false);
  const [reviewComment, setReviewComment] = useState('');
  const [submittingReview, setSubmittingReview] = useState(false);
  const [reviewCurrentPage, setReviewCurrentPage] = useState(0);

  // Download package state
  const [downloadingPackage, setDownloadingPackage] = useState(null); // Order ID being downloaded

  const [newProject, setNewProject] = useState({
    client_name: '',
    client_email: '',
    client_phone: '',
    translate_from: 'Portuguese',
    translate_to: 'English',
    service_type: 'certified',
    document_type: '',
    page_count: 1,
    word_count: 0,
    urgency: 'no',
    notes: '',
    internal_notes: '',
    assigned_pm_id: '',
    assigned_translator_id: '',
    deadline: '',
    deadline_time: '17:00',
    base_price: '',
    total_price: '',
    revenue_source: 'website',
    payment_method: '',
    payment_received: false,
    payment_tag: '',
    create_invoice: false,
    invoice_terms: '30_days',
    invoice_custom_date: '',
    document_category: ''
  });

  // Document type filter state
  const [documentTypeFilter, setDocumentTypeFilter] = useState('');

  const REVENUE_SOURCES = [
    { value: 'website', label: 'Website' },
    { value: 'google', label: 'Google' },
    { value: 'instagram', label: 'Instagram' },
    { value: 'facebook', label: 'Facebook' },
    { value: 'whatsapp', label: 'WhatsApp' },
    { value: 'social_media', label: 'Social Media' },
    { value: 'referral', label: 'Referral' },
    { value: 'partner', label: 'Partner' },
    { value: 'other', label: 'Other' }
  ];

  const PAYMENT_METHODS = [
    { value: '', label: '-- Select --' },
    { value: 'credit_card', label: 'Credit Card' },
    { value: 'debit', label: 'Debit Card' },
    { value: 'paypal', label: 'PayPal' },
    { value: 'zelle', label: 'Zelle' },
    { value: 'venmo', label: 'Venmo' },
    { value: 'pix', label: 'PIX' },
    { value: 'apple_pay', label: 'Apple Pay' },
    { value: 'bank_transfer', label: 'Bank Transfer' }
  ];

  // Primary Languages first, then alphabetical
  const PM_LANGUAGES = [
    'English', 'Spanish', 'Portuguese',
    'Afrikaans', 'Albanian', 'Amharic', 'Arabic', 'Armenian', 'Azerbaijani',
    'Basque', 'Belarusian', 'Bengali', 'Bosnian', 'Bulgarian', 'Burmese',
    'Catalan', 'Chinese', 'Croatian', 'Czech', 'Danish', 'Dutch',
    'Estonian', 'Filipino', 'Finnish', 'French', 'Galician', 'Georgian',
    'German', 'Greek', 'Gujarati', 'Haitian Creole', 'Hebrew', 'Hindi',
    'Hungarian', 'Icelandic', 'Igbo', 'Indonesian', 'Irish', 'Italian',
    'Japanese', 'Kazakh', 'Khmer', 'Korean', 'Lao', 'Latin', 'Latvian',
    'Lithuanian', 'Luxembourgish', 'Macedonian', 'Malay', 'Maltese',
    'Mongolian', 'Nepali', 'Norwegian', 'Papiamento', 'Persian', 'Polish',
    'Punjabi', 'Romanian', 'Russian', 'Serbian', 'Slovak', 'Slovenian',
    'Somali', 'Swahili', 'Swedish', 'Tamil', 'Telugu', 'Thai', 'Turkish',
    'Ukrainian', 'Urdu', 'Uzbek', 'Vietnamese', 'Welsh', 'Yoruba', 'Zulu'
  ];

  // Track if initial load is done
  const [initialLoadDone, setInitialLoadDone] = useState(false);

  // Initial load - fetch users and orders
  useEffect(() => {
    const loadInitialData = async () => {
      setLoading(true);
      try {
        await Promise.all([
          fetchOrders(1),
          fetchUsers(),
          isPM ? fetchTranslatorStats() : Promise.resolve()
        ]);
      } finally {
        setInitialLoadDone(true);
      }
    };
    loadInitialData();
  }, [adminKey]);

  // Re-fetch orders when status filter changes (but not on initial load)
  useEffect(() => {
    if (initialLoadDone) {
      fetchOrders(1); // Reset to first page when filter changes
    }
  }, [statusFilter]);

  const fetchUsers = async () => {
    try {
      const [pmRes, transRes] = await Promise.all([
        axios.get(`${API}/admin/users/by-role/pm?admin_key=${adminKey}`),
        axios.get(`${API}/admin/users/by-role/translator?admin_key=${adminKey}`)
      ]);
      setPmList(pmRes.data || []);
      setTranslatorList(transRes.data || []);
    } catch (err) {
      console.error('Failed to fetch users:', err);
    }
  };

  // Fetch translator availability stats (for PM view)
  const fetchTranslatorStats = async () => {
    try {
      const response = await axios.get(`${API}/admin/translators/status?admin_key=${adminKey}`);
      const data = response.data;
      setTranslatorStats({
        total: data.summary.total,
        busy: data.summary.busy,
        available: data.summary.available
      });
      setTranslatorsWithStatus(data.translators || []);
    } catch (err) {
      console.error('Failed to fetch translator stats:', err);
      // Fallback to old method if new endpoint fails
      try {
        const [transRes, ordersRes] = await Promise.all([
          axios.get(`${API}/admin/users/by-role/translator?admin_key=${adminKey}`),
          axios.get(`${API}/admin/orders?admin_key=${adminKey}`)
        ]);
        const translators = transRes.data || [];
        const activeOrders = (ordersRes.data.orders || []).filter(o =>
          ['received', 'in_translation', 'review'].includes(o.translation_status)
        );
        const busyTranslatorIds = new Set(activeOrders.map(o => o.assigned_translator_id).filter(Boolean));
        const busyTranslatorNames = new Set(activeOrders.map(o => o.assigned_translator).filter(Boolean));
        const busy = translators.filter(t => busyTranslatorIds.has(t.id) || busyTranslatorNames.has(t.name)).length;
        setTranslatorStats({
          total: translators.length,
          busy: busy,
          available: translators.length - busy
        });
      } catch (e) {
        console.error('Fallback also failed:', e);
      }
    }
  };

  const fetchOrders = async (page = currentPage) => {
    setLoading(true);
    try {
      // Build query toms for pagination
      const toms = new URLSearchParams({
        admin_key: adminKey,
        page: page.toString(),
        limit: pageSize.toString()
      });

      // Add filters if active
      if (statusFilter && statusFilter !== 'all') {
        toms.append('status', statusFilter);
      }

      const response = await axios.get(`${API}/admin/orders?${toms.toString()}`);
      let allOrders = response.data.orders || [];

      // Update pagination state
      if (response.data.pagination) {
        setTotalPages(response.data.pagination.total_pages || 1);
        setTotalCount(response.data.pagination.total_count || 0);
        setCurrentPage(response.data.pagination.page || 1);
      }

      // PM filtering is now handled server-side based on the user token
      setOrders(allOrders);
    } catch (err) {
      console.error('Failed to fetch orders:', err);
    } finally {
      setLoading(false);
    }
  };

  // Handle page change
  const handlePageChange = (newPage) => {
    if (newPage >= 1 && newPage <= totalPages) {
      setCurrentPage(newPage);
      fetchOrders(newPage);
    }
  };

  const updateStatus = async (orderId, newStatus) => {
    try {
      await axios.put(`${API}/admin/orders/${orderId}?admin_key=${adminKey}`, { translation_status: newStatus });
      fetchOrders();
    } catch (err) {
      console.error('Failed to update:', err);
    }
  };

  const markPaid = async (orderId) => {
    try {
      await axios.post(`${API}/admin/orders/${orderId}/mark-paid?admin_key=${adminKey}`);
      fetchOrders();
    } catch (err) {
      console.error('Failed to mark paid:', err);
    }
  };

  // Confirm payment for WhatsApp/MIA quotes - marks as paid and changes status to "received"
  const confirmQuotePayment = async (orderId) => {
    if (!window.confirm('Confirm payment received? This will convert the Quote to an active Order.')) return;
    try {
      await axios.put(`${API}/admin/orders/${orderId}?admin_key=${adminKey}`, {
        payment_status: 'paid',
        translation_status: 'received'
      });
      showToast('‚úÖ Payment confirmed! Order is now active.');
      fetchOrders();
    } catch (err) {
      console.error('Failed to confirm payment:', err);
      showToast('Error confirming payment');
    }
  };

  const deliverOrder = async (orderId) => {
    try {
      await axios.post(`${API}/admin/orders/${orderId}/deliver?admin_key=${adminKey}`);
      fetchOrders();
    } catch (err) {
      console.error('Failed to deliver:', err);
    }
  };

  // Reopen delivered order for corrections/new uploads
  const reopenOrder = async (orderId) => {
    if (!window.confirm('Reopen this order for corrections? This will change the status back to "Ready" so you can make changes and re-deliver.')) return;
    try {
      await axios.put(`${API}/admin/orders/${orderId}?admin_key=${adminKey}`, {
        translation_status: 'ready',
        reopened_at: new Date().toISOString(),
        reopened_for_corrections: true
      });
      showToast('‚úÖ Order reopened! You can now upload new documents and re-deliver to the client.');
      fetchOrders();
    } catch (err) {
      console.error('Failed to reopen order:', err);
      showToast('Error reopening order');
    }
  };

  // Download complete translation package (PDF/Print)
  const downloadOrderPackage = async (order) => {
    setDownloadingPackage(order.id);
    try {
      // Fetch complete order data with translation
      const orderResponse = await axios.get(`${API}/admin/orders/${order.id}?admin_key=${adminKey}`);
      const orderData = orderResponse.data.order || orderResponse.data;

      // Check for any form of completed translation
      const hasTranslation = orderData.translation_html ||
                            orderData.translation_ready ||
                            orderData.translated_file ||
                            orderData.translated_gridfs_id ||
                            orderData.translated_filename ||
                            orderData.has_translated_documents;

      if (!hasTranslation) {
        showToast('This order does not have a completed translation yet.');
        setDownloadingPackage(null);
        return;
      }

      // Fetch order documents for originals
      let originalDocuments = [];
      try {
        const docsResponse = await axios.get(`${API}/admin/order-documents?order_id=${order.id}&admin_key=${adminKey}`);
        const docs = docsResponse.data.documents || docsResponse.data || [];

        // Load original documents (not translations)
        for (const doc of docs.filter(d => d.document_type !== 'translation')) {
          try {
            const docData = await axios.get(`${API}/admin/order-documents/${doc.id}/download?admin_key=${adminKey}`);
            if (docData.data.file_data) {
              originalDocuments.push({
                filename: doc.filename,
                data: docData.data.file_data,
                type: docData.data.content_type || 'image/png'
              });
            }
          } catch (docErr) {
            console.warn('Failed to load document:', doc.id);
          }
        }
      } catch (docsErr) {
        console.warn('Failed to fetch documents:', docsErr);
      }

      // Build package HTML
      const translatorName = orderData.translation_translator_name || orderData.assigned_translator_name || orderData.assigned_translator || 'Beatriz Paiva';
      const documentType = DOCUMENT_TYPES.find(d => d.value === orderData.document_type)?.label || orderData.document_type || 'Document';
      const sourceLanguage = orderData.translate_from || orderData.source_language || 'Portuguese';
      const targetLanguage = orderData.translate_to || orderData.target_language || 'English';
      const translationDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

      // Letterhead HTML
      const letterheadHTML = `
        <div class="header">
          <div class="logo-left">
            <div class="logo-placeholder"><span style="text-align:center;">LEGACY<br/>TRANSLATIONS</span></div>
          </div>
          <div class="header-center">
            <div class="company-name">Legacy Translations</div>
            <div class="company-address">
              867 Boylston Street ¬∑ 5th Floor ¬∑ #2073 ¬∑ Boston, MA ¬∑ 02116<br>
              (857) 316-7770 ¬∑ contact@legacytranslations.com
            </div>
          </div>
          <div class="logo-right">
            <div class="logo-placeholder-right"><span>ata<br/>Member #275993</span></div>
          </div>
        </div>
        <div class="header-line"></div>`;

      // Cover Letter
      const coverLetterHTML = `
      <div class="cover-page">
        ${letterheadHTML}
        ${orderData.order_number ? `<div class="order-number">Order # <strong>${orderData.order_number}</strong></div>` : ''}
        <h1 class="main-title">Certification of Translation Accuracy</h1>
        <div class="subtitle">
          Translation of a <strong>${documentType}</strong> from <strong>${sourceLanguage}</strong> to<br>
          <strong>${targetLanguage}</strong>
        </div>
        <p class="body-text">I, the undersigned, hereby certify that the attached document is, to the best of my knowledge and belief, a true and accurate translation of the original document from ${sourceLanguage} to ${targetLanguage}.</p>
        <p class="body-text">I am competent to translate from ${sourceLanguage} to ${targetLanguage}, and this translation is complete and accurate.</p>
        <p class="body-text">This certification is valid for official use, including immigration, legal, and academic purposes.</p>
        <div class="footer-section">
          <div class="signature-block">
            <div style="font-family: 'Times New Roman', serif; font-size: 18px; font-style: italic; color: #1a365d; margin-bottom: 2px;">${translatorName}</div>
            <div class="signature-name">Authorized Representative</div>
            <div class="signature-title">Legacy Translations Inc.</div>
            <div class="signature-date">Dated: ${translationDate}</div>
          </div>
          <div class="stamp-container">
            <div class="stamp">
              <div class="stamp-text-top">CERTIFIED TRANSLATOR</div>
              <div class="stamp-center">
                <div class="stamp-company">LEGACY TRANSLATIONS</div>
                <div class="stamp-ata">ATA # 275993</div>
              </div>
            </div>
          </div>
        </div>
      </div>`;

      // Translation pages HTML
      let translationPagesHTML = '';
      if (orderData.translation_html) {
        translationPagesHTML = `
        <div class="translation-text-page">
          <div class="running-header">${letterheadHTML}</div>
          <div class="running-header-spacer"></div>
          <div class="translation-content translation-text">${orderData.translation_html}</div>
        </div>`;
      }

      // Original documents pages
      const originalPagesHTML = originalDocuments.length > 0 ? originalDocuments.map((file, idx) => `
      <div class="original-documents-page">
        ${letterheadHTML}
        ${idx === 0 ? '<div class="page-title">Original Document</div>' : ''}
        <div class="original-image-container">
          <img src="data:${file.type};base64,${file.data}" alt="Original page ${idx + 1}" class="original-image" />
        </div>
      </div>`).join('') : '';

      // Complete HTML document
      const fullHTML = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Certified Translation - ${orderData.order_number || 'Document'}</title>
  <style>
    @page { size: Letter; margin: 0.5in 0.6in 0.6in 0.6in; }
    @page cover { size: Letter; margin: 0.75in; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Times New Roman', Georgia, serif; font-size: 13px; line-height: 1.5; color: #333; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; }
    .header-line { height: 3px; background: linear-gradient(to right, #3B82F6, #60A5FA); margin-bottom: 12px; }
    .logo-left { width: 130px; height: 55px; display: flex; align-items: center; }
    .logo-placeholder { width: 130px; height: 55px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #999; background: #fafafa; }
    .header-center { text-align: center; flex: 1; padding: 0 15px; }
    .company-name { font-size: 15px; font-weight: bold; color: #2563eb; margin-bottom: 2px; }
    .company-address { font-size: 9px; line-height: 1.3; color: #333; }
    .logo-right { width: 85px; height: 55px; display: flex; align-items: center; justify-content: flex-end; }
    .logo-placeholder-right { width: 85px; height: 55px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; font-size: 9px; color: #1a365d; background: #fafafa; text-align: center; font-style: italic; }
    .order-number { text-align: right; margin-bottom: 20px; font-size: 12px; margin-top: 5px; }
    .main-title { text-align: center; font-size: 26px; font-weight: normal; margin-bottom: 20px; color: #1a365d; line-height: 1.2; }
    .subtitle { text-align: center; font-size: 13px; margin-bottom: 25px; line-height: 1.5; }
    .body-text { text-align: justify; margin-bottom: 14px; line-height: 1.6; font-size: 12px; }
    .footer-section { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; padding-top: 20px; }
    .signature-block { line-height: 1.3; }
    .signature-name { font-weight: bold; font-size: 13px; }
    .signature-title { font-weight: bold; font-size: 12px; }
    .signature-date { font-size: 12px; }
    .stamp-container { width: 130px; height: 130px; }
    .stamp { width: 130px; height: 130px; border: 3px solid #2563eb; border-radius: 50%; position: relative; display: flex; align-items: center; justify-content: center; background: white; }
    .stamp::before { content: ''; position: absolute; top: 7px; left: 7px; right: 7px; bottom: 7px; border: 1px solid #2563eb; border-radius: 50%; }
    .stamp-text-top { position: absolute; top: 14px; left: 50%; transform: translateX(-50%); font-size: 8px; font-weight: bold; color: #2563eb; letter-spacing: 1.5px; }
    .stamp-center { text-align: center; padding: 0 12px; }
    .stamp-company { font-size: 10px; font-weight: bold; color: #2563eb; margin-bottom: 2px; }
    .stamp-ata { font-size: 8px; color: #2563eb; }
    .cover-page { page: cover; page-break-after: always; min-height: 100%; display: flex; flex-direction: column; }
    .translation-text-page { page-break-before: always; }
    .translation-content.translation-text { text-align: left; font-family: 'Times New Roman', Georgia, serif; font-size: 11pt; line-height: 1.5; color: #333; }
    .translation-content.translation-text p { margin-bottom: 10px; text-align: justify; }
    .translation-content.translation-text table { width: 100%; border-collapse: collapse; margin: 10px 0; }
    .translation-content.translation-text td, .translation-content.translation-text th { border: 1px solid #333; padding: 6px; font-size: 10pt; }
    .page-title { font-size: 13px; font-weight: bold; text-align: center; margin: 10px 0 8px 0; color: #1a365d; text-transform: uppercase; letter-spacing: 2px; }
    .original-documents-page { page-break-after: always; page-break-inside: avoid; padding-top: 15px; }
    .original-documents-page:last-of-type { page-break-after: auto; }
    .original-image-container { text-align: center; margin-bottom: 5px; }
    .original-image { max-width: 100%; max-height: 630px; border: 1px solid #ddd; object-fit: contain; display: block; margin: 0 auto; }
    @media print {
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .running-header { position: fixed; top: 0; left: 0; right: 0; background: white; padding: 20px 50px 10px; }
      .running-header-spacer { height: 100px; }
    }
  </style>
</head>
<body>
  ${coverLetterHTML}
  ${translationPagesHTML}
  ${originalPagesHTML}
</body>
</html>`;

      // Generate PDF with hash tracking
      const filename = `${order.order_number || 'Order'}_Certified_Translation.pdf`;

      try {
        const { blob: pdfBlob, hash: pdfHash } = await generatePdfWithHash(fullHTML, filename, {
          margin: [5, 5, 5, 5],
          image: { type: 'jpeg', quality: 0.95 },
          html2canvas: { scale: 2, useCORS: true, allowTaint: true },
          jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' }
        });

        // Download the PDF
        const downloadUrl = URL.createObjectURL(pdfBlob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(downloadUrl);
      } catch (pdfErr) {
        console.error('PDF generation failed, falling back to print:', pdfErr);
        // Fallback to print window if PDF generation fails
        const printWindow = window.open('', '_blank');
        if (printWindow) {
          printWindow.document.write(fullHTML);
          printWindow.document.close();
          printWindow.focus();
          setTimeout(() => { printWindow.print(); }, 500);
        } else {
          showToast('Please allow popups to download the translation package.');
        }
      }
    } catch (err) {
      console.error('Failed to download package:', err);
      showToast('Error generating translation package: ' + (err.message || 'Unknown error'));
    } finally {
      setDownloadingPackage(null);
    }
  };

  // Open delivery modal with translation preview
  const openDeliveryModal = async (order) => {
    setDeliveryModalOrder(order);
    setDeliveryStatus('');
    setShowDeliveryModal(true);

    // Fetch the translation HTML
    try {
      const response = await axios.get(`${API}/admin/orders/${order.id}?admin_key=${adminKey}`);
      const orderData = response.data.order || response.data;
      setDeliveryTranslationHtml(orderData.translation_html || '');
    } catch (err) {
      console.error('Failed to fetch translation:', err);
      setDeliveryTranslationHtml('<p style="color: red;">Error ao load translation</p>');
    }
  };

  // Send translation by email
  const sendDeliveryEmail = async () => {
    if (!deliveryModalOrder) return;

    setDeliverySending(true);
    setDeliveryStatus('üìÑ Generating certified PDF package...');

    // Get translator name from order data
    const translatorName = deliveryModalOrder.translation_translator_name ||
                          deliveryModalOrder.assigned_translator_name ||
                          deliveryModalOrder.assigned_translator ||
                          'Beatriz Paiva';

    try {
      const response = await axios.post(`${API}/admin/orders/${deliveryModalOrder.id}/deliver?admin_key=${adminKey}`, {
        include_verification_page: deliveryIncludeVerification,
        certifier_name: translatorName,
        // Combined PDF options
        generate_combined_pdf: true,
        include_certificate: true,
        include_translation: true,
        include_original: true,
        translator_name: translatorName,
        document_type: deliveryModalOrder.document_type,
        source_language: deliveryModalOrder.source_language,
        target_language: deliveryModalOrder.target_language
      });

      let statusMessage = '‚úÖ Certified translation delivered!';
      if (response.data.certification?.included) {
        statusMessage += `\nüîê Verification ID: ${response.data.certification.certification_id}`;
      }
      if (response.data.attachment_filenames?.length > 0) {
        statusMessage += `\nüìé ${response.data.attachment_filenames.join(', ')}`;
      } else if (response.data.attachments_sent === 0) {
        statusMessage += `\n‚ö†Ô∏è Warning: No attachments were sent! Check if the order has a translation.`;
      }
      setDeliveryStatus(statusMessage);
      fetchOrders();

      // Close modal after success
      setTimeout(() => {
        setShowDeliveryModal(false);
        setDeliveryModalOrder(null);
        setDeliveryTranslationHtml('');
        setDeliveryStatus('');
        setDeliveryIncludeVerification(true); // Reset to default
      }, 3000);
    } catch (err) {
      console.error('Failed to send email:', err);
      setDeliveryStatus('‚ùå Error sending email: ' + (err.response?.data?.detail || err.message));
    } finally {
      setDeliverySending(false);
    }
  };

  const deleteOrder = async (orderId, orderNumber) => {
    if (!window.confirm(`Are you sure you want to delete order ${orderNumber}?\n\nThis action cannot be undone.`)) return;
    try {
      await axios.delete(`${API}/admin/orders/${orderId}?admin_key=${adminKey}`);
      fetchOrders();
    } catch (err) {
      console.error('Failed to delete:', err);
      showToast('Error deleting order');
    }
  };

  // QuickBooks sync function
  const syncOrderToQuickBooks = async (order) => {
    setQbSyncing(prev => ({ ...prev, [order.id]: true }));
    try {
      const isPartnerOrder = order.partner_id && order.partner_id !== 'manual' && order.partner_id !== 'direct_client' && order.partner_id !== 'admin_quote';
      const response = await axios.post(`${API}/quickbooks/sync/receipt?admin_key=${adminKey}`, {
        order_id: order.id,
        customer_name: isPartnerOrder ? (order.partner_company || order.partner_name) : order.client_name,
        customer_email: isPartnerOrder ? order.partner_email : order.client_email,
        send_email: true,
        is_partner_order: isPartnerOrder
      });
      if (response.data.success) {
        const recipient = isPartnerOrder ? (order.partner_company || 'partner') : (order.client_email || 'client');
        showToast(`Receipt #${response.data.receipt_number} created and sent to ${recipient}!`);
        fetchOrders();
      }
    } catch (err) {
      console.error('Failed to sync to QuickBooks:', err);
      showToast('Failed to sync: ' + (err.response?.data?.detail || err.message));
    } finally {
      setQbSyncing(prev => ({ ...prev, [order.id]: false }));
    }
  };

  // Edit tags
  const startEditingTags = (order) => {
    setEditingTags(order.id);
    setTempTagValue({
      type: order.translation_type || 'professional',
      notes: order.internal_notes || ''
    });
  };

  const saveTagsEdit = async (orderId) => {
    try {
      await axios.put(`${API}/admin/orders/${orderId}?admin_key=${adminKey}`, {
        translation_type: tempTagValue.type,
        internal_notes: tempTagValue.notes
      });
      setEditingTags(null);
      fetchOrders();
    } catch (err) {
      console.error('Failed to update tags:', err);
    }
  };

  // Edit deadline
  const startEditingDeadline = (order) => {
    setEditingDeadline(order.id);
    // Extract date/time in NY timezone (backend stores UTC, display in NY)
    const { date, time } = getDateTimePartsInNY(order.deadline);
    setTempDeadlineValue({ date, time });
  };

  const saveDeadlineEdit = async (orderId) => {
    try {
      // Convert NY timezone input to UTC for backend storage
      const deadlineDateTime = convertNYToUTC(tempDeadlineValue.date, tempDeadlineValue.time);
      await axios.put(`${API}/admin/orders/${orderId}?admin_key=${adminKey}`, {
        deadline: deadlineDateTime
      });
      setEditingDeadline(null);
      fetchOrders();
    } catch (err) {
      console.error('Failed to update deadline:', err);
    }
  };

  // Edit translator deadline
  const startEditingTranslatorDeadline = (order) => {
    setEditingTranslatorDeadline(order.id);
    // Extract date/time in NY timezone (backend stores UTC, display in NY)
    const { date, time } = getDateTimePartsInNY(order.translator_deadline);
    setTempTranslatorDeadlineValue({ date, time });
  };

  const saveTranslatorDeadlineEdit = async (orderId) => {
    try {
      // Convert NY timezone input to UTC for backend storage
      const deadlineDateTime = convertNYToUTC(tempTranslatorDeadlineValue.date, tempTranslatorDeadlineValue.time);
      await axios.put(`${API}/admin/orders/${orderId}?admin_key=${adminKey}`, {
        translator_deadline: deadlineDateTime
      });
      setEditingTranslatorDeadline(null);
      fetchOrders();
    } catch (err) {
      console.error('Failed to update translator deadline:', err);
    }
  };

  // Open "Send to Client" modal
  const openSendToClientModal = async (order) => {
    setSendingOrder(order);
    setTranslatedDocInfo(null);
    setAdditionalAttachments([]);
    setSelectedAttachments({ workspace: true, uploaded: [] });
    setExternalAttachment(null);
    try {
      const response = await axios.get(`${API}/admin/orders/${order.id}/translated-document?admin_key=${adminKey}`);
      setTranslatedDocInfo(response.data);

      // Load additional documents from the translated-document endpoint
      const additionalDocsFromResponse = response.data.additional_documents || [];
      let allAdditionalDocs = additionalDocsFromResponse.map(d => ({
        id: d.id,
        filename: d.filename,
        isExisting: true
      }));

      // Also load existing order documents as potential attachments
      const docsResponse = await axios.get(`${API}/admin/orders/${order.id}/documents?admin_key=${adminKey}`);
      if (docsResponse.data.documents) {
        // Filter to show signed/translated documents (that are not already in allAdditionalDocs)
        const existingIds = new Set(allAdditionalDocs.map(d => d.id));
        const existingDocs = docsResponse.data.documents.filter(d =>
          !existingIds.has(d.id) && (
            d.filename?.toLowerCase().includes('signed') ||
            d.filename?.toLowerCase().includes('translation') ||
            d.document_type === 'translation' ||
            d.source === 'translated_document'
          )
        );
        allAdditionalDocs = [...allAdditionalDocs, ...existingDocs.map(d => ({
          id: d.id,
          filename: d.filename,
          isExisting: true
        }))];
      }

      // Set attachments and select them by default
      if (allAdditionalDocs.length > 0) {
        setAdditionalAttachments(allAdditionalDocs);
        setSelectedAttachments(prev => ({
          ...prev,
          uploaded: allAdditionalDocs.map(d => d.id)
        }));
      }
    } catch (err) {
      console.error('Failed to get translated document info:', err);
      setTranslatedDocInfo({ has_translated_document: false });
    }
  };

  // Download translated document
  const downloadTranslatedDocument = async (orderId, filename) => {
    try {
      const response = await axios.get(`${API}/admin/orders/${orderId}/download-translation?admin_key=${adminKey}`);
      if (response.data.type === 'file' && response.data.file_data) {
        const link = document.createElement('a');
        link.href = `data:${response.data.content_type};base64,${response.data.file_data}`;
        link.download = response.data.filename || filename || 'translation.pdf';
        link.click();
      } else if (response.data.type === 'html') {
        // Open HTML in new tab for printing
        const newWindow = window.open('', '_blank');
        newWindow.document.write(response.data.html_content);
        newWindow.document.close();
      }
    } catch (err) {
      console.error('Failed to download translation:', err);
      showToast('Error downloading translation');
    }
  };

  // Upload new translated document(s) - supports multiple files
  const uploadTranslatedDocument = async (orderId, files) => {
    const fileList = Array.isArray(files) ? files : [files];
    setUploadingFile(true);
    try {
      for (const file of fileList) {
        const formData = new FormData();
        formData.append('file', file);
        const uploadResponse = await axios.post(`${API}/admin/orders/${orderId}/upload-translation?admin_key=${adminKey}`, formData, {
          headers: { 'Content-Type': 'multipart/form-data' }
        });
        // Add to additional attachments list
        const newAttachment = {
          id: uploadResponse.data.document_id || `temp-${Date.now()}-${file.name}`,
          filename: file.name,
          isExisting: true
        };
        setAdditionalAttachments(prev => [...prev, newAttachment]);
        setSelectedAttachments(prev => ({
          ...prev,
          uploaded: [...prev.uploaded, newAttachment.id]
        }));
      }
      // Refresh doc info
      const response = await axios.get(`${API}/admin/orders/${orderId}/translated-document?admin_key=${adminKey}`);
      setTranslatedDocInfo(response.data);
      showToast(`${fileList.length} file(s) sent(s) successfully!`);
    } catch (err) {
      console.error('Failed to upload translation:', err);
      showToast('Error sending file');
    } finally {
      setUploadingFile(false);
    }
  };

  // Send translation to client (deliver)
  const sendTranslationToClient = async (orderId) => {
    setSendingToClient(true);
    try {
      // Prepare selected attachments info
      const attachmentsToSend = {
        include_workspace: selectedAttachments.workspace && translatedDocInfo?.has_html_translation,
        additional_document_ids: selectedAttachments.uploaded
      };

      // Build request payload with all PDF generation options
      const payload = {
        bcc_email: sendBccEmail || null,
        notify_pm: notifyPM && sendingOrder?.assigned_pm_id ? true : false,
        attachments: attachmentsToSend,
        // Ensure combined PDF with verification page is generated
        include_verification_page: true,
        generate_combined_pdf: true,
        include_certificate: true,
        include_translation: true,
        include_original: true,
        certifier_name: sendingOrder?.assigned_translator_name || sendingOrder?.assigned_translator || 'Beatriz Paiva',
        translator_name: sendingOrder?.assigned_translator_name || sendingOrder?.assigned_translator || 'Beatriz Paiva',
        document_type: sendingOrder?.document_type,
        source_language: sendingOrder?.source_language,
        target_language: sendingOrder?.target_language
      };

      // Add external attachment if present (for resend)
      if (externalAttachment) {
        payload.external_attachment = externalAttachment;
      }

      const response = await axios.post(`${API}/admin/orders/${orderId}/deliver?admin_key=${adminKey}`, payload);

      let message = '‚úÖ Email sent to o cliente!\n\n';

      if (response.data.attachments_sent > 0) {
        message += `üìé ${response.data.attachments_sent} attachment(s) sent(s)\n`;
        if (response.data.attachment_filenames) {
          message += `   Files: ${response.data.attachment_filenames.join(', ')}\n`;
        }
      } else if (response.data.attachment_sent) {
        message += `üìé Attachment: ${response.data.attachment_filename || 'Yes'}\n`;
      } else {
        message += '‚ö†Ô∏è Without attachment (no translation file found)\n';
        if (response.data.debug) {
          message += `\nDebug: had_file=${response.data.debug.had_file}, had_html=${response.data.debug.had_html}, html_length=${response.data.debug.html_length}`;
        }
      }

      if (response.data.external_attachment_sent) {
        message += `\nüìé Anexo externo: ${response.data.external_attachment_filename}`;
      }

      if (response.data.pm_notified) {
        message += '\nüìß PM notified.';
      }
      if (response.data.bcc_sent) {
        message += '\nüìß BCC copy sent.';
      }

      showToast(message);
      setSendingOrder(null);
      setSendBccEmail('');
      setAdditionalAttachments([]);
      setSelectedAttachments({ workspace: true, uploaded: [] });
      setExternalAttachment(null);
      fetchOrders();
    } catch (err) {
      console.error('Failed to deliver:', err);
      showToast('Error sending: ' + (err.response?.data?.detail || err.message));
    } finally {
      setSendingToClient(false);
    }
  };

  // View order documents
  const viewOrderDocuments = async (order) => {
    console.log('Opening project details for:', order);
    if (!order) {
      console.error('viewOrderDocuments called with null order');
      return;
    }
    setProjectModalTab('details'); // Reset to details tab
    setEditingProject(false); // Reset edit mode
    setViewingOrder(order);
    setLoadingDocuments(true);
    setOrderDocuments([]);
    setSelectedDocsForDelivery([]); // Reset selection
    try {
      const response = await axios.get(`${API}/admin/orders/${order.id}/documents?admin_key=${adminKey}`);
      console.log('Documents loaded:', response.data);
      const docs = response.data.documents || [];
      setOrderDocuments(docs);
      // Auto-select all translated documents for delivery
      const translatedDocIds = docs.filter(d => d.source === 'translated_document').map(d => d.id);
      setSelectedDocsForDelivery(translatedDocIds);
    } catch (err) {
      console.error('Failed to fetch documents:', err);
      setOrderDocuments([]);
    } finally {
      setLoadingDocuments(false);
    }
  };

  // Download document
  const downloadDocument = async (docId, filename) => {
    try {
      const response = await axios.get(`${API}/admin/order-documents/${docId}/download?admin_key=${adminKey}`);
      if (response.data.file_data) {
        const link = document.createElement('a');
        link.href = `data:${response.data.content_type};base64,${response.data.file_data}`;
        link.download = filename || 'document.pdf';
        link.click();
      } else {
        showToast('Document not found');
      }
    } catch (err) {
      console.error('Failed to download:', err);
      showToast('Error downloading document');
    }
  };

  // Upload single document to order (Admin/PM only)
  const uploadDocumentToOrder = async (orderId, file) => {
    if (!file) return;
    setUploadingProjectDoc(true);
    try {
      const reader = new FileReader();
      const base64Promise = new Promise((resolve, reject) => {
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
      });
      reader.readAsDataURL(file);
      const base64Data = await base64Promise;

      await axios.post(`${API}/admin/orders/${orderId}/documents?admin_key=${adminKey}`, {
        filename: file.name,
        file_data: base64Data,
        content_type: file.type || 'application/octet-stream',
        source: 'manual_upload'
      });

      // Refresh documents
      viewOrderDocuments(viewingOrder);
    } catch (err) {
      console.error('Failed to upload document:', err);
      showToast('Error uploading document');
    } finally {
      setUploadingProjectDoc(false);
    }
  };

  // Assign translator to specific document
  const assignTranslatorToDocument = async (docId, translatorId, translatorName) => {
    try {
      // Update local state immediately for UI feedback
      setFileTranslatorAssignments(prev => ({
        ...prev,
        [docId]: { id: translatorId, name: translatorName }
      }));

      // Save to backend - update document metadata
      await axios.patch(`${API}/admin/order-documents/${docId}?admin_key=${adminKey}`, {
        assigned_translator_id: translatorId,
        assigned_translator_name: translatorName
      });
    } catch (err) {
      console.error('Failed to assign translator to document:', err);
      // Revert on error
      setFileTranslatorAssignments(prev => {
        const newState = { ...prev };
        delete newState[docId];
        return newState;
      });
    }
  };

  // Upload multiple documents to order (Admin/PM only)
  const uploadDocumentsToOrder = async (orderId, files) => {
    if (!files || files.length === 0) return;
    setUploadingProjectDoc(true);

    const maxFileSize = 100 * 1024 * 1024; // 100MB max per file
    let successCount = 0;
    let errorCount = 0;

    try {
      for (const file of files) {
        // Check file size
        if (file.size > maxFileSize) {
          showToast(`File "${file.name}" exceeds 100MB limit and was skipped.`);
          errorCount++;
          continue;
        }

        try {
          const reader = new FileReader();
          const base64Promise = new Promise((resolve, reject) => {
            reader.onload = () => {
              const base64 = reader.result.split(',')[1];
              resolve(base64);
            };
            reader.onerror = reject;
          });
          reader.readAsDataURL(file);
          const base64Data = await base64Promise;

          await axios.post(`${API}/admin/orders/${orderId}/documents?admin_key=${adminKey}`, {
            filename: file.name,
            file_data: base64Data,
            content_type: file.type || 'application/octet-stream',
            source: 'manual_upload'
          });
          successCount++;
        } catch (err) {
          console.error(`Failed to upload ${file.name}:`, err);
          errorCount++;
        }
      }

      // Show summary
      if (successCount > 0 && errorCount === 0) {
        showToast(`Successfully uploaded ${successCount} file(s)!`);
      } else if (successCount > 0 && errorCount > 0) {
        showToast(`Uploaded ${successCount} file(s), ${errorCount} failed.`);
      } else {
        showToast('Failed to upload files.');
      }

      // Refresh documents
      viewOrderDocuments(viewingOrder);
    } catch (err) {
      console.error('Failed to upload documents:', err);
      showToast('Error uploading documents');
    } finally {
      setUploadingProjectDoc(false);
    }
  };

  // Delete order document (Admin/PM only)
  const deleteOrderDocument = async (docId, filename) => {
    if (!confirm(`Are you sure you want to delete "${filename}"? This action cannot be undone.`)) {
      return;
    }
    try {
      await axios.delete(`${API}/admin/order-documents/${docId}?admin_key=${adminKey}`);
      showToast(`Document "${filename}" deleted successfully`);
      // Refresh files list
      if (viewingOrder) {
        viewOrderDocuments(viewingOrder);
      }
      // Refresh all project files for Files view
      if (assignedOrders && assignedOrders.length > 0) {
        const allFiles = [];
        for (const order of assignedOrders) {
          try {
            const res = await axios.get(`${API}/admin/orders/${order.id}/documents?admin_key=${adminKey}`);
            if (res.data?.documents) {
              res.data.documents.forEach(doc => {
                allFiles.push({
                  ...doc,
                  order_id: order.id,
                  order_number: order.order_number,
                  translate_from: order.translate_from,
                  translate_to: order.translate_to,
                  deadline: order.deadline,
                  internal_notes: order.internal_notes
                });
              });
            }
          } catch (e) { /* ignore */ }
        }
        setAllProjectFiles(allFiles);
      }
    } catch (err) {
      console.error('Failed to delete document:', err);
      showToast('Error deleting document');
    }
  };

  // Replace order document (Admin/PM only)
  const replaceOrderDocument = async (docId, file, oldFilename) => {
    if (!file) return;
    if (!confirm(`Replace "${oldFilename}" with "${file.name}"?`)) {
      return;
    }
    try {
      const reader = new FileReader();
      const base64Promise = new Promise((resolve, reject) => {
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
      });
      reader.readAsDataURL(file);
      const base64Data = await base64Promise;

      await axios.put(`${API}/admin/order-documents/${docId}?admin_key=${adminKey}`, {
        filename: file.name,
        file_data: base64Data,
        content_type: file.type || 'application/octet-stream'
      });

      showToast(`Document replaced successfully with "${file.name}"`);
      // Refresh files list
      if (viewingOrder) {
        viewOrderDocuments(viewingOrder);
      }
      // Refresh all project files for Files view
      if (assignedOrders && assignedOrders.length > 0) {
        const allFiles = [];
        for (const order of assignedOrders) {
          try {
            const res = await axios.get(`${API}/admin/orders/${order.id}/documents?admin_key=${adminKey}`);
            if (res.data?.documents) {
              res.data.documents.forEach(doc => {
                allFiles.push({
                  ...doc,
                  order_id: order.id,
                  order_number: order.order_number,
                  translate_from: order.translate_from,
                  translate_to: order.translate_to,
                  deadline: order.deadline,
                  internal_notes: order.internal_notes
                });
              });
            }
          } catch (e) { /* ignore */ }
        }
        setAllProjectFiles(allFiles);
      }
    } catch (err) {
      console.error('Failed to replace document:', err);
      showToast('Error replacing document');
    }
  };

  // Update order notes
  const updateOrderNotes = async (orderId, clientNotes, internalNotes) => {
    try {
      await axios.put(`${API}/admin/orders/${orderId}?admin_key=${adminKey}`, {
        notes: clientNotes,
        internal_notes: internalNotes
      });
      // Refresh order in modal
      setViewingOrder(prev => ({ ...prev, notes: clientNotes, internal_notes: internalNotes }));
      setEditingNotes(false);
      fetchOrders();
    } catch (err) {
      console.error('Failed to update notes:', err);
      showToast('Error updating notes');
    }
  };

  // Save deadline from modal
  const saveModalDeadline = async () => {
    if (!viewingOrder) return;
    try {
      let newDeadline = null;
      if (tempModalDeadline.date) {
        newDeadline = `${tempModalDeadline.date}T${tempModalDeadline.time || '17:00'}:00`;
      }
      await axios.put(`${API}/admin/orders/${viewingOrder.id}?admin_key=${adminKey}`, {
        deadline: newDeadline
      });
      setViewingOrder(prev => ({ ...prev, deadline: newDeadline }));
      setEditingModalDeadline(false);
      fetchOrders();
    } catch (err) {
      console.error('Failed to update deadline:', err);
      showToast('Error updating deadline');
    }
  };

  // Save edited project
  const saveEditedProject = async () => {
    if (!viewingOrder || !editFormData) return;
    setSavingProject(true);
    try {
      await axios.put(`${API}/admin/orders/${viewingOrder.id}?admin_key=${adminKey}`, editFormData);

      // Update viewing order locally
      const updatedOrder = { ...viewingOrder, ...editFormData };
      setViewingOrder(updatedOrder);

      // Update orders list locally for immediate display
      setOrders(prev => prev.map(o =>
        o.id === viewingOrder.id ? { ...o, ...editFormData } : o
      ));

      setEditingProject(false);

      // Also refresh from server to ensure consistency
      fetchOrders();

      showToast('‚úÖ Projeto salvo successfully!');
    } catch (err) {
      console.error('Failed to save project:', err);
      showToast('Error saving project: ' + (err.response?.data?.detail || err.message));
    } finally {
      setSavingProject(false);
    }
  };

  // Start editing project
  const startEditingProject = () => {
    if (!viewingOrder) return;
    setEditFormData({
      client_name: viewingOrder.client_name || '',
      client_email: viewingOrder.client_email || '',
      translate_from: viewingOrder.translate_from || 'Portuguese',
      translate_to: viewingOrder.translate_to || 'English',
      service_type: viewingOrder.service_type || 'certified',
      page_count: viewingOrder.page_count || 1,
      urgency: viewingOrder.urgency || 'no',
      deadline: viewingOrder.deadline ? new Date(viewingOrder.deadline).toISOString().slice(0, 16) : '',
      document_type: viewingOrder.document_type || '',
      notes: viewingOrder.notes || '',
      internal_notes: viewingOrder.internal_notes || '',
      total_price: viewingOrder.total_price || 0,
      payment_status: viewingOrder.payment_status || 'pending',
      translation_status: viewingOrder.translation_status || 'received'
    });
    setEditingProject(true);
  };

  // Fetch notifications
  const fetchNotifications = async () => {
    try {
      const response = await axios.get(`${API}/admin/notifications?admin_key=${adminKey}&token=${user?.token || ''}`);
      setNotifications(response.data.notifications || []);
    } catch (err) {
      console.error('Failed to fetch notifications:', err);
    }
  };

  // Mark notification as read
  const markNotificationRead = async (notifId) => {
    try {
      await axios.put(`${API}/admin/notifications/${notifId}/read?admin_key=${adminKey}&token=${user?.token || ''}`);
      fetchNotifications();
    } catch (err) {
      console.error('Failed to mark notification as read:', err);
    }
  };

  // Fetch partner messages
  const fetchPartnerMessages = async () => {
    try {
      const response = await axios.get(`${API}/admin/partner-messages?admin_key=${adminKey}`);
      setPartnerMessages(response.data.messages || []);
    } catch (err) {
      console.error('Failed to fetch partner messages:', err);
    }
  };

  // Mark partner message as read
  const markPartnerMessageRead = async (messageId) => {
    try {
      await axios.put(`${API}/admin/partner-messages/${messageId}/read?admin_key=${adminKey}`);
      fetchPartnerMessages();
    } catch (err) {
      console.error('Failed to mark message as read:', err);
    }
  };

  // Reply to partner message
  const replyToPartnerMessage = async () => {
    if (!replyingToMessage || !replyContent.trim()) return;
    setSendingReply(true);
    try {
      // Send reply via email to partner
      await axios.post(`${API}/admin/partner-messages/${replyingToMessage.id}/reply?admin_key=${adminKey}`, {
        content: replyContent,
        partner_email: replyingToMessage.from_partner_email,
        partner_name: replyingToMessage.from_partner_name,
        admin_name: user?.name || 'Admin'
      });
      showToast('Reply sent to ' + replyingToMessage.from_partner_name + '!');
      setReplyingToMessage(null);
      setReplyContent('');
      fetchPartnerMessages();
    } catch (err) {
      console.error('Failed to send reply:', err);
      showToast('Failed to send reply. Please try again.');
    } finally {
      setSendingReply(false);
    }
  };

  // Send message to translator
  const sendMessageToTranslator = async () => {
    if (!messagingTranslator || !translatorMessageContent.trim()) return;
    setSendingTranslatorMessage(true);
    try {
      await axios.post(`${API}/admin/translator-messages?admin_key=${adminKey}`, {
        translator_id: messagingTranslator.id,
        translator_name: messagingTranslator.name,
        translator_email: messagingTranslator.email,
        content: translatorMessageContent,
        order_number: messagingTranslator.order_number,
        admin_name: user?.name || 'Admin'
      });
      showToast('Message sent to ' + messagingTranslator.name + '!');
      setMessagingTranslator(null);
      setTranslatorMessageContent('');
    } catch (err) {
      console.error('Failed to send message:', err);
      showToast('Failed to send message. Please try again.');
    } finally {
      setSendingTranslatorMessage(false);
    }
  };

  // Poll for notifications and partner messages
  useEffect(() => {
    if (adminKey && (isAdmin || isPM)) {
      fetchNotifications();
      fetchPartnerMessages();
      const interval = setInterval(() => {
        fetchNotifications();
        fetchPartnerMessages();
      }, 30000); // Every 30 seconds
      return () => clearInterval(interval);
    }
  }, [adminKey, user]);

  // Open translator assignment modal
  const openAssignTranslatorModal = async (order) => {
    setAssigningTranslatorModal(order);
    setAssignmentDetails({
      translator_id: '',
      due_date: order.deadline ? order.deadline.split('T')[0] : '',
      due_time: '17:00',
      project_notes: order.internal_notes || '',
      language_pair: `${order.translate_from} ‚Üí ${order.translate_to}`
    });
    // Refresh translator list when opening modal to ensure we have latest data
    try {
      const response = await axios.get(`${API}/admin/users/by-role/translator?admin_key=${adminKey}`);
      console.log('Translators loaded:', response.data);
      setTranslatorList(response.data || []);
    } catch (err) {
      console.error('Failed to load translators:', err);
    }
  };

  // Quick Add Translator (PM can add new translators from assignment modal)
  const quickAddTranslator = async () => {
    if (!newTranslatorData.name || !newTranslatorData.email || !newTranslatorData.password) {
      showToast('Please fill in name, email and password');
      return;
    }
    setAddingTranslator(true);
    try {
      const response = await axios.post(`${API}/admin/auth/register?admin_key=${adminKey}`, {
        name: newTranslatorData.name,
        email: newTranslatorData.email,
        password: newTranslatorData.password,
        role: 'translator',
        rate_per_page: newTranslatorData.rate_per_page ? parseFloat(newTranslatorData.rate_per_page) : null,
        rate_per_word: newTranslatorData.rate_per_word ? parseFloat(newTranslatorData.rate_per_word) : null,
        language_pairs: newTranslatorData.language_pairs || null
      });

      showToast(`Translator "${newTranslatorData.name}" created successfully!`);

      // Reset form and refresh translator list
      setNewTranslatorData({ name: '', email: '', password: '', rate_per_page: '', rate_per_word: '', language_pairs: '' });
      setShowQuickAddTranslator(false);

      // Refresh translator list
      const usersRes = await axios.get(`${API}/admin/users/by-role/translator?admin_key=${adminKey}`);
      setTranslatorList(usersRes.data || []);

      // Auto-select the new translator
      if (response.data.user_id) {
        setAssignmentDetails({...assignmentDetails, translator_id: response.data.user_id});
      }
    } catch (err) {
      console.error('Failed to add translator:', err);
      showToast(err.response?.data?.detail || 'Error creating translator');
    } finally {
      setAddingTranslator(false);
    }
  };

  // Open Review Modal (PM Side-by-Side Review)
  const openReviewModal = async (order) => {
    setReviewingOrder(order);
    setLoadingReview(true);
    setReviewComment('');
    setReviewCurrentPage(0);
    setReviewOriginalDocs([]);
    setReviewTranslatedDoc(null);

    try {
      // Fetch original documents
      const docsResponse = await axios.get(`${API}/admin/orders/${order.id}/documents?admin_key=${adminKey}`);
      const docs = docsResponse.data.documents || [];

      // Download each original document as base64
      const originalDocsWithData = [];
      for (const doc of docs) {
        try {
          const downloadRes = await axios.get(`${API}/admin/order-documents/${doc.id}/download?admin_key=${adminKey}`);
          if (downloadRes.data.file_data) {
            const contentType = downloadRes.data.content_type || 'application/pdf';
            originalDocsWithData.push({
              ...doc,
              data: `data:${contentType};base64,${downloadRes.data.file_data}`,
              contentType
            });
          }
        } catch (e) {
          console.error('Failed to download doc:', e);
        }
      }
      setReviewOriginalDocs(originalDocsWithData);

      // Fetch translated document (if exists)
      try {
        const translatedRes = await axios.get(`${API}/admin/orders/${order.id}/translated-document?admin_key=${adminKey}`);
        if (translatedRes.data.translation_html) {
          setReviewTranslatedDoc({
            type: 'html',
            content: translatedRes.data.translation_html,
            settings: translatedRes.data
          });
        } else if (translatedRes.data.file_data) {
          const contentType = translatedRes.data.content_type || 'application/pdf';
          setReviewTranslatedDoc({
            type: 'file',
            data: `data:${contentType};base64,${translatedRes.data.file_data}`,
            filename: translatedRes.data.filename,
            contentType
          });
        }
      } catch (e) {
        console.error('No translated document found:', e);
      }
    } catch (err) {
      console.error('Failed to load review documents:', err);
      showToast('Error loading documents for review');
    } finally {
      setLoadingReview(false);
    }
  };

  // Approve translation (PM approves, moves to ready)
  const approveTranslation = async () => {
    if (!reviewingOrder) return;
    setSubmittingReview(true);
    try {
      await axios.put(`${API}/admin/orders/${reviewingOrder.id}?admin_key=${adminKey}`, {
        translation_status: 'ready',
        pm_review_status: 'approved',
        pm_review_comment: reviewComment,
        pm_reviewed_at: new Date().toISOString()
      });
      showToast('Translation approved! Ready for delivery.');
      setReviewingOrder(null);
      fetchOrders();
    } catch (err) {
      console.error('Failed to approve:', err);
      showToast('Error approving translation');
    } finally {
      setSubmittingReview(false);
    }
  };

  // Request correction (PM sends back to translator)
  const requestCorrection = async () => {
    if (!reviewingOrder) return;
    if (!reviewComment.trim()) {
      showToast('Please add a comment explaining what needs to be corrected');
      return;
    }
    setSubmittingReview(true);
    try {
      await axios.put(`${API}/admin/orders/${reviewingOrder.id}?admin_key=${adminKey}`, {
        translation_status: 'in_translation',
        pm_review_status: 'correction_requested',
        pm_review_comment: reviewComment,
        pm_reviewed_at: new Date().toISOString()
      });
      showToast('Correction requested. Translator will be notified.');
      setReviewingOrder(null);
      fetchOrders();
    } catch (err) {
      console.error('Failed to request correction:', err);
      showToast('Error requesting correction');
    } finally {
      setSubmittingReview(false);
    }
  };

  // Send translator assignment with email invitation
  const sendTranslatorAssignment = async () => {
    if (!assignmentDetails.translator_id) {
      showToast('Please select a translator');
      return;
    }
    setSendingAssignment(true);
    try {
      // Check if assigning to self (admin/PM)
      const isSelfAssignment = assignmentDetails.translator_id === 'self';

      // Find translator info (or use current user for self assignment)
      const selectedTranslator = isSelfAssignment
        ? { name: user?.name || 'Admin', id: 'self' }
        : translatorList.find(t => t.id === assignmentDetails.translator_id);

      // Build translator deadline if provided
      let translatorDeadline = null;
      if (assignmentDetails.due_date) {
        translatorDeadline = `${assignmentDetails.due_date}T${assignmentDetails.due_time}:00`;
      }

      // Update order with translator assignment
      await axios.put(`${API}/admin/orders/${assigningTranslatorModal.id}?admin_key=${adminKey}`, {
        assigned_translator_id: isSelfAssignment ? null : assignmentDetails.translator_id,
        assigned_translator: isSelfAssignment ? (user?.name || 'Admin') : selectedTranslator?.name,
        translator_deadline: translatorDeadline,
        internal_notes: assignmentDetails.project_notes,
        self_assigned: isSelfAssignment,
        skip_email: isSelfAssignment
      });

      if (isSelfAssignment) {
        showToast(`Project assigned to yourself (${user?.name || 'Admin'})! You can start translating now.`);
      } else {
        showToast(`Invitation sent to ${selectedTranslator?.name || 'translator'}! They will receive an email to accept or decline.`);
      }
      setAssigningTranslatorModal(null);
      setAssigningTranslator(null);
      fetchOrders();
      fetchNotifications();
    } catch (err) {
      console.error('Failed to assign translator:', err);
      showToast('Error sending assignment');
    } finally {
      setSendingAssignment(false);
    }
  };

  // Simple assign translator (from dropdown)
  const assignTranslator = async (orderId, translatorName) => {
    try {
      await axios.put(`${API}/admin/orders/${orderId}?admin_key=${adminKey}`, {
        assigned_translator: translatorName
      });
      setAssigningTranslator(null);
      fetchOrders();
    } catch (err) {
      console.error('Failed to assign translator:', err);
    }
  };

  // Assign PM to order
  const assignPM = async (orderId, pmName) => {
    try {
      await axios.put(`${API}/admin/orders/${orderId}?admin_key=${adminKey}`, {
        assigned_pm: pmName
      });
      setAssigningPM(null);
      fetchOrders();
    } catch (err) {
      console.error('Failed to assign PM:', err);
    }
  };

  // Update translator assignment status (Admin/PM can manually change Pending to Accepted)
  const updateTranslatorAssignmentStatus = async (orderId, newStatus) => {
    try {
      await axios.put(`${API}/admin/orders/${orderId}?admin_key=${adminKey}`, {
        translator_assignment_status: newStatus
      });
      showToast(`Translator status updated to: ${newStatus}`);
      fetchOrders();
    } catch (err) {
      console.error('Failed to update translator assignment status:', err);
      showToast('Failed to update status');
    }
  };

  // Start translation - navigate to Translation Tool with order
  const startTranslation = (order) => {
    if (onTranslate) {
      onTranslate(order);
    }
  };

  // Create new project manually
  const createProject = async (e) => {
    e.preventDefault();

    // Validate required fields
    if (!newProject.client_name || !newProject.client_name.trim()) {
      showToast('Client name is required');
      return;
    }
    if (!newProject.client_email || !newProject.client_email.trim()) {
      showToast('Client email is required');
      return;
    }
    // Basic email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(newProject.client_email)) {
      showToast('Please enter a valid email address');
      return;
    }

    setCreatingProject(true);
    try {
      // Prepare project data with document if uploaded
      let projectData = { ...newProject };

      // Combine deadline date and time FIRST (before removing deadline_time)
      if (projectData.deadline && projectData.deadline_time) {
        projectData.deadline = `${projectData.deadline}T${projectData.deadline_time}`;
      } else if (!projectData.deadline) {
        projectData.deadline = null;
      }

      // Remove fields that shouldn't be sent to backend
      delete projectData.deadline_time; // This is combined into deadline

      // Clean up empty string fields - convert to null or proper types
      if (projectData.assigned_pm_id === '') projectData.assigned_pm_id = null;
      if (projectData.assigned_translator_id === '') projectData.assigned_translator_id = null;
      if (projectData.payment_method === '') projectData.payment_method = null;
      if (projectData.reference === '') projectData.reference = null;
      if (projectData.notes === '') projectData.notes = null;
      if (projectData.internal_notes === '') projectData.internal_notes = null;
      if (projectData.payment_tag === '') projectData.payment_tag = null;
      if (projectData.base_price === '' || projectData.base_price === null) projectData.base_price = 0;
      if (projectData.total_price === '' || projectData.total_price === null) projectData.total_price = 0;
      if (projectData.page_count === '' || projectData.page_count === null) projectData.page_count = 1;
      if (projectData.word_count === '' || projectData.word_count === null) projectData.word_count = 0;

      // Convert numeric fields to numbers
      projectData.base_price = parseFloat(projectData.base_price) || 0;
      projectData.total_price = parseFloat(projectData.total_price) || 0;
      projectData.page_count = parseInt(projectData.page_count) || 1;
      projectData.word_count = parseInt(projectData.word_count) || 0;

      // Convert documents to base64 if provided (multiple files support)
      if (documentFiles.length > 0) {
        const documentsArray = [];
        for (const file of documentFiles) {
          const reader = new FileReader();
          const base64Promise = new Promise((resolve, reject) => {
            reader.onload = () => {
              const base64 = reader.result.split(',')[1]; // Remove data:...;base64, prefix
              resolve(base64);
            };
            reader.onerror = reject;
          });
          reader.readAsDataURL(file);
          const base64Data = await base64Promise;
          documentsArray.push({
            filename: file.name,
            data: base64Data,
            content_type: file.type || 'application/octet-stream'
          });
        }
        projectData.documents = documentsArray;
        // Keep backwards compatibility - first file as main document
        projectData.document_data = documentsArray[0].data;
        projectData.document_filename = documentsArray[0].filename;
      }

      // Set payment status based on received flag
      if (newProject.payment_received) {
        projectData.payment_status = 'paid';
      } else {
        projectData.payment_status = 'pending';
      }

      await axios.post(`${API}/admin/orders/manual?admin_key=${adminKey}`, projectData);
      setShowNewProjectForm(false);
      setNewProject({
        client_name: '',
        client_email: '',
        translate_from: 'Portuguese',
        translate_to: 'English',
        service_type: 'certified',
        document_type: '',
        page_count: 1,
        word_count: 0,
        urgency: 'no',
        notes: '',
        internal_notes: '',
        assigned_pm_id: '',
        assigned_translator_id: '',
        deadline: '',
        deadline_time: '17:00',
        base_price: '',
        total_price: '',
        revenue_source: 'website',
        payment_method: '',
        payment_received: false,
        payment_tag: '',
        create_invoice: false,
        invoice_terms: '30_days',
        invoice_custom_date: '',
        document_category: ''
      });
      setDocumentFiles([]);
      fetchOrders();
    } catch (err) {
      console.error('Error creating project:', err.response?.data || err);
      const rawError = err.response?.data?.detail || 'Error creating project';
      const errorMsg = sanitizeErrorMessage(rawError);
      showToast(errorMsg.includes('email') ? 'Invalid email format. Please enter a valid email (e.g., name@email.com)' : errorMsg);
    } finally {
      setCreatingProject(false);
    }
  };

  // Client-side filtering for search and document type only (status is filtered server-side)
  const filtered = orders.filter(o => {
    const matchSearch = !search ||
      o.client_name?.toLowerCase().includes(search.toLowerCase()) ||
      o.client_email?.toLowerCase().includes(search.toLowerCase()) ||
      o.order_number?.toLowerCase().includes(search.toLowerCase()) ||
      o.document_type?.toLowerCase().includes(search.toLowerCase());
    const matchDocType = !documentTypeFilter || o.document_type === documentTypeFilter;
    return matchSearch && matchDocType;
  });

  const totalReceive = filtered.reduce((sum, o) => sum + (o.total_price || 0), 0);
  const totalPaid = filtered.filter(o => o.payment_status === 'paid').reduce((sum, o) => sum + (o.total_price || 0), 0);
  const totalPending = filtered.filter(o => o.payment_status === 'pending').reduce((sum, o) => sum + (o.total_price || 0), 0);

  const getStatusLabel = (status) => {
    const labels = {
      'received': 'In Progress',
      'Quote': 'In Progress',
      'quote': 'In Progress',
      'pending': 'In Progress',
      'in_translation': 'In Progress',
      'review': 'PM Review',
      'pending_pm_review': 'PM Review',
      'pending_admin_approval': 'Pending Admin',
      'pending_admin_review': 'Admin Review',
      'finalized_pending_admin': 'Ready (Admin)',
      'client_review': 'Client Review',
      'ready': 'Ready',
      'delivered': 'Delivered',
      'final': 'Final'
    };
    return labels[status] || status;
  };

  if (loading) {
    return <div className="p-4 flex items-center justify-center"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600"></div></div>;
  }

  return (
    <div className="p-4">
      {/* Notification Bell - Discreet red bell indicator */}
      {(isAdmin || isPM) && notifications.filter(n => !n.is_read).length > 0 && (
        <div className="fixed bottom-20 right-4 z-40">
          <button
            onClick={() => setShowNotifications(!showNotifications)}
            className="relative bg-white shadow-lg rounded-full p-3 hover:bg-gray-50 border border-gray-200 transition-all hover:scale-105"
            title="View notifications"
          >
            <span className="text-xl">üîî</span>
            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold min-w-[18px] h-[18px] rounded-full flex items-center justify-center px-1">
              {notifications.filter(n => !n.is_read).length}
            </span>
          </button>
          {showNotifications && (
            <div className="absolute bottom-14 right-0 w-80 bg-white rounded-lg shadow-xl border border-gray-200 max-h-80 overflow-hidden">
              <div className="p-2 border-b bg-gray-50 flex justify-between items-center">
                <span className="text-xs font-bold text-gray-700">üîî Notifications</span>
                <button onClick={() => setShowNotifications(false)} className="text-gray-400 hover:text-gray-600">√ó</button>
              </div>
              <div className="overflow-y-auto max-h-64">
                {notifications.filter(n => !n.is_read).map((notif) => (
                  <div
                    key={notif.id}
                    className={`p-2 border-b text-xs hover:bg-gray-50 ${
                      notif.type === 'assignment_declined' ? 'border-l-2 border-l-red-500' :
                      notif.type === 'assignment_accepted' ? 'border-l-2 border-l-green-500' :
                      notif.type === 'payment_proof_received' ? 'border-l-2 border-l-yellow-500' :
                      'border-l-2 border-l-blue-500'
                    }`}
                  >
                    <div className="flex justify-between items-start gap-2">
                      <div className="flex-1">
                        <div className="font-medium text-gray-800">
                          {notif.type === 'assignment_declined' ? '‚ùå' :
                           notif.type === 'assignment_accepted' ? '‚úÖ' :
                           notif.type === 'payment_proof_received' ? 'üí∞' : 'üìã'} {notif.title}
                        </div>
                        <div className="text-gray-600 mt-0.5">{notif.message}</div>
                        {notif.order_number && (
                          <span className="text-[10px] text-purple-600 font-medium">Order: {notif.order_number}</span>
                        )}
                      </div>
                      <button
                        onClick={() => markNotificationRead(notif.id)}
                        className="text-gray-400 hover:text-red-500 text-[10px]"
                        title="Mark as read"
                      >
                        ‚úì
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}

      {/* Partner Messages Bell - Discreet message indicator */}
      {partnerMessages.filter(m => !m.read).length > 0 && (
        <div className="fixed bottom-4 right-4 z-40">
          <button
            onClick={() => setShowPartnerMessages(!showPartnerMessages)}
            className="relative bg-white shadow-lg rounded-full p-3 hover:bg-gray-50 border border-gray-200 transition-all hover:scale-105"
            title="View partner messages"
          >
            <span className="text-xl">üí¨</span>
            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold min-w-[18px] h-[18px] rounded-full flex items-center justify-center px-1">
              {partnerMessages.filter(m => !m.read).length}
            </span>
          </button>
          {showPartnerMessages && (
            <div className="absolute bottom-14 right-0 w-96 bg-white rounded-lg shadow-xl border border-gray-200 max-h-96 overflow-hidden">
              <div className="p-2 border-b bg-gray-50 flex justify-between items-center">
                <span className="text-xs font-bold text-gray-700">üí¨ Partner Messages</span>
                <button onClick={() => setShowPartnerMessages(false)} className="text-gray-400 hover:text-gray-600">√ó</button>
              </div>
              <div className="overflow-y-auto max-h-80">
                {partnerMessages.filter(m => !m.read).map((msg) => (
                  <div
                    key={msg.id}
                    className="p-3 border-b border-l-2 border-l-blue-500 hover:bg-gray-50"
                  >
                    <div className="flex items-center gap-2 mb-1">
                      <span className="font-medium text-xs text-gray-800">
                        {msg.from_partner_name}
                      </span>
                      <span className="text-[10px] px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded">
                        {msg.recipient_type === 'pm' ? `‚Üí ${msg.recipient_name}` : '‚Üí Admin'}
                      </span>
                      {msg.order_number && (
                        <span className="text-[10px] px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded">
                          {msg.order_number}
                        </span>
                      )}
                    </div>
                    <div className="text-[10px] text-gray-500 mb-1">{msg.from_partner_email}</div>
                    <div className="text-xs text-gray-700 bg-gray-50 p-2 rounded mb-2">
                      {msg.content.length > 100 ? msg.content.substring(0, 100) + '...' : msg.content}
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-[10px] text-gray-400">{formatDateTimeLocal(msg.created_at)}</span>
                      <div className="flex gap-1">
                        <button
                          onClick={() => {
                            setReplyingToMessage(msg);
                            setReplyContent('');
                          }}
                          className="px-2 py-0.5 bg-green-500 text-white rounded text-[10px] hover:bg-green-600"
                        >
                          Reply
                        </button>
                        <button
                          onClick={() => markPartnerMessageRead(msg.id)}
                          className="px-2 py-0.5 text-gray-500 border border-gray-300 rounded text-[10px] hover:bg-gray-100"
                        >
                          ‚úì
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}

      {/* Reply to Partner Message Modal */}
      {replyingToMessage && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <div className="p-4 border-b flex justify-between items-center bg-blue-600 text-white rounded-t-lg">
              <div>
                <h3 className="font-bold">üìß Reply to Partner</h3>
                <p className="text-xs opacity-80">{replyingToMessage.from_partner_name}</p>
              </div>
              <button onClick={() => setReplyingToMessage(null)} className="text-white hover:text-gray-200 text-xl">√ó</button>
            </div>

            <div className="p-4">
              {/* Original Message */}
              <div className="mb-4 p-3 bg-gray-50 rounded border">
                <div className="text-xs text-gray-500 mb-1">Original message:</div>
                <div className="text-sm text-gray-700">{replyingToMessage.content}</div>
              </div>

              {/* Reply */}
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Your Reply *</label>
                <textarea
                  value={replyContent}
                  onChange={(e) => setReplyContent(e.target.value)}
                  rows="4"
                  className="w-full px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                  placeholder="Type your reply..."
                />
              </div>

              <div className="mt-3 p-2 bg-blue-50 rounded text-xs text-blue-700">
                <span className="font-medium">üìß</span> Reply will be sent to: {replyingToMessage.from_partner_email}
              </div>
            </div>

            <div className="p-3 border-t bg-gray-50 flex justify-end gap-2 rounded-b-lg">
              <button
                onClick={() => setReplyingToMessage(null)}
                className="px-4 py-1.5 text-gray-600 text-sm hover:text-gray-800"
              >
                Cancel
              </button>
              <button
                onClick={replyToPartnerMessage}
                disabled={sendingReply || !replyContent.trim()}
                className="px-4 py-1.5 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:bg-gray-400"
              >
                {sendingReply ? 'Sending...' : 'üì§ Send Reply'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Translator Assignment Modal */}
      {assigningTranslatorModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div className="p-4 border-b flex justify-between items-center bg-blue-600 text-white rounded-t-lg">
              <div>
                <h3 className="font-bold">üë§ Assign Translator</h3>
                <p className="text-xs opacity-80">{assigningTranslatorModal.order_number} - {assigningTranslatorModal.client_name}</p>
              </div>
              <button onClick={() => setAssigningTranslatorModal(null)} className="text-white hover:text-gray-200 text-xl">√ó</button>
            </div>

            <div className="p-4 space-y-4">
              {/* Project Info */}
              <div className="p-3 bg-gray-50 rounded border text-xs">
                <div className="grid grid-cols-2 gap-2">
                  <div>
                    <span className="text-gray-500">Language:</span>
                    <span className="ml-1 font-medium">{assignmentDetails.language_pair}</span>
                  </div>
                  <div>
                    <span className="text-gray-500">Pages:</span>
                    <span className="ml-1 font-medium">{assigningTranslatorModal.page_count || 1}</span>
                  </div>
                </div>
              </div>

              {/* Select Translator */}
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Select Translator *</label>
                <select
                  value={assignmentDetails.translator_id}
                  onChange={(e) => setAssignmentDetails({...assignmentDetails, translator_id: e.target.value})}
                  className="w-full px-3 py-2 border rounded text-sm"
                >
                  <option value="">-- Choose Translator --</option>
                  {/* Option for admin to assign to themselves */}
                  {user?.role === 'admin' && (
                    <option value="self" className="font-medium bg-blue-50">
                      üë§ Myself ({user?.name || 'Admin'}) - No email notification
                    </option>
                  )}
                  {translatorList.filter(t => t.is_active !== false).map(t => (
                    <option key={t.id} value={t.id}>
                      {t.name} {t.language_pairs ? `(${t.language_pairs})` : ''} {t.rate_per_page ? `- $${t.rate_per_page}/pg` : ''} {t.invitation_pending ? '(pending)' : ''}
                    </option>
                  ))}
                </select>
                {translatorList.length === 0 && (
                  <p className="text-[10px] text-blue-600 mt-1">No translators found. Register translators in the Users tab first.</p>
                )}
                {translatorList.length > 0 && translatorList.filter(t => t.is_active !== false).length === 0 && (
                  <p className="text-[10px] text-blue-600 mt-1">All translators are inactive. They need to accept their invitation first.</p>
                )}
              </div>

              {/* Translator Deadline - When translator must return */}
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-medium text-gray-700 mb-1">Translator Deadline</label>
                  <input
                    type="date"
                    value={assignmentDetails.due_date}
                    onChange={(e) => setAssignmentDetails({...assignmentDetails, due_date: e.target.value})}
                    className="w-full px-3 py-2 border rounded text-sm"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-700 mb-1">Time</label>
                  <input
                    type="time"
                    value={assignmentDetails.due_time}
                    onChange={(e) => setAssignmentDetails({...assignmentDetails, due_time: e.target.value})}
                    className="w-full px-3 py-2 border rounded text-sm"
                  />
                </div>
              </div>

              {/* Notes */}
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Notes for Translator</label>
                <textarea
                  value={assignmentDetails.project_notes}
                  onChange={(e) => setAssignmentDetails({...assignmentDetails, project_notes: e.target.value})}
                  className="w-full px-3 py-2 border rounded text-sm"
                  rows="2"
                  placeholder="Special instructions for the translator..."
                />
              </div>

              {/* Info */}
              {assignmentDetails.translator_id === 'self' ? (
                <div className="p-2 bg-green-50 rounded text-xs text-green-700">
                  <span className="font-medium">üë§ Self Assignment:</span> The project will be assigned directly to you. No email will be sent.
                </div>
              ) : (
                <div className="p-2 bg-blue-50 rounded text-xs text-blue-700">
                  <span className="font-medium">üìß Email Invitation:</span> The translator will receive an email with accept/decline links. You will be notified of their response.
                </div>
              )}
            </div>

            <div className="p-3 border-t bg-gray-50 flex justify-end gap-2 rounded-b-lg">
              <button
                onClick={() => setAssigningTranslatorModal(null)}
                className="px-4 py-1.5 text-gray-600 text-sm hover:text-gray-800"
              >
                Cancel
              </button>
              <button
                onClick={sendTranslatorAssignment}
                disabled={sendingAssignment || !assignmentDetails.translator_id}
                className="px-4 py-1.5 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:bg-gray-400"
              >
                {sendingAssignment ? 'Sending...' : (assignmentDetails.translator_id === 'self' ? '‚úÖ Assign to Myself' : 'üì§ Send Invitation')}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* PM Review Modal - Side by Side */}
      {reviewingOrder && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-6xl h-[90vh] flex flex-col">
            {/* Header */}
            <div className="p-4 border-b flex justify-between items-center bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-t-lg">
              <div>
                <h3 className="font-bold text-lg">üìã Review Translation</h3>
                <p className="text-xs opacity-80">
                  {reviewingOrder.order_number} - {reviewingOrder.client_name} | {reviewingOrder.translate_from} ‚Üí {reviewingOrder.translate_to}
                </p>
              </div>
              <button onClick={() => setReviewingOrder(null)} className="text-white hover:text-gray-200 text-2xl">√ó</button>
            </div>

            {loadingReview ? (
              <div className="flex-1 flex items-center justify-center">
                <div className="text-center">
                  <div className="text-4xl mb-3">‚è≥</div>
                  <p className="text-gray-600">Loading documents...</p>
                </div>
              </div>
            ) : (
              <>
                {/* Document Navigation */}
                {reviewOriginalDocs.length > 1 && (
                  <div className="px-4 py-2 bg-gray-100 border-b flex items-center justify-center gap-2">
                    <button
                      onClick={() => setReviewCurrentPage(Math.max(0, reviewCurrentPage - 1))}
                      disabled={reviewCurrentPage === 0}
                      className="px-3 py-1 bg-white border rounded text-sm disabled:opacity-50"
                    >
                      ‚Üê Previous
                    </button>
                    <span className="text-sm font-medium">
                      Document {reviewCurrentPage + 1} of {reviewOriginalDocs.length}
                    </span>
                    <button
                      onClick={() => setReviewCurrentPage(Math.min(reviewOriginalDocs.length - 1, reviewCurrentPage + 1))}
                      disabled={reviewCurrentPage >= reviewOriginalDocs.length - 1}
                      className="px-3 py-1 bg-white border rounded text-sm disabled:opacity-50"
                    >
                      Next ‚Üí
                    </button>
                  </div>
                )}

                {/* Side by Side Content */}
                <div className="flex-1 grid grid-cols-2 gap-0 overflow-hidden">
                  {/* Left: Original Document */}
                  <div className="border-r flex flex-col">
                    <div className="px-4 py-2 bg-blue-50 border-b">
                      <span className="text-sm font-bold text-blue-700">üìÑ Original Document</span>
                      {reviewOriginalDocs[reviewCurrentPage] && (
                        <span className="text-xs text-gray-500 ml-2">{reviewOriginalDocs[reviewCurrentPage].filename}</span>
                      )}
                    </div>
                    <div className="flex-1 overflow-auto p-4 bg-gray-50">
                      {reviewOriginalDocs[reviewCurrentPage] ? (
                        reviewOriginalDocs[reviewCurrentPage].contentType?.includes('pdf') ? (
                          <embed
                            src={getImageSrc(reviewOriginalDocs[reviewCurrentPage])}
                            type="application/pdf"
                            className="w-full h-full min-h-[500px]"
                          />
                        ) : (
                          <img
                            src={getImageSrc(reviewOriginalDocs[reviewCurrentPage])}
                            alt="Original"
                            className="max-w-full border shadow-sm"
                          />
                        )
                      ) : (
                        <div className="text-center text-gray-400 py-8">
                          <div className="text-4xl mb-2">üì≠</div>
                          <p>No original document found</p>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Right: Translated Document */}
                  <div className="flex flex-col">
                    <div className="px-4 py-2 bg-blue-50 border-b">
                      <span className="text-sm font-bold text-blue-700">üåê Translation ({reviewingOrder.translate_to})</span>
                    </div>
                    <div className="flex-1 overflow-auto p-4 bg-gray-50">
                      {reviewTranslatedDoc ? (
                        reviewTranslatedDoc.type === 'html' ? (
                          <div
                            className="bg-white p-4 border shadow-sm prose prose-sm max-w-none"
                            dangerouslySetInnerHTML={{ __html: reviewTranslatedDoc.content }}
                          />
                        ) : reviewTranslatedDoc.contentType?.includes('pdf') ? (
                          <embed
                            src={getImageSrc(reviewTranslatedDoc)}
                            type="application/pdf"
                            className="w-full h-full min-h-[500px]"
                          />
                        ) : (
                          <img
                            src={getImageSrc(reviewTranslatedDoc)}
                            alt="Translation"
                            className="max-w-full border shadow-sm"
                          />
                        )
                      ) : (
                        <div className="text-center text-gray-400 py-8">
                          <div className="text-4xl mb-2">üìù</div>
                          <p>No translation found</p>
                          <p className="text-xs mt-1">Translation not yet submitted</p>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Review Actions Footer */}
                <div className="p-4 border-t bg-gray-50">
                  {/* Comment */}
                  <div className="mb-4">
                    <label className="block text-xs font-medium text-gray-700 mb-1">
                      üí¨ Review Comment {!reviewTranslatedDoc && '(required for correction request)'}
                    </label>
                    <textarea
                      value={reviewComment}
                      onChange={(e) => setReviewComment(e.target.value)}
                      className="w-full px-3 py-2 border rounded text-sm"
                      rows="2"
                      placeholder="Add your feedback, corrections needed, or approval notes..."
                    />
                  </div>

                  {/* Action Buttons */}
                  <div className="flex justify-between items-center">
                    <button
                      onClick={() => setReviewingOrder(null)}
                      className="px-4 py-2 text-gray-600 hover:text-gray-800"
                    >
                      Close
                    </button>
                    <div className="flex gap-3">
                      <button
                        onClick={requestCorrection}
                        disabled={submittingReview || !reviewTranslatedDoc}
                        className="px-6 py-2 bg-red-500 text-white rounded hover:bg-red-600 disabled:bg-gray-400 flex items-center gap-2"
                      >
                        {submittingReview ? '...' : '‚ùå Request Correction'}
                      </button>
                      <button
                        onClick={approveTranslation}
                        disabled={submittingReview || !reviewTranslatedDoc}
                        className="px-6 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:bg-gray-400 flex items-center gap-2"
                      >
                        {submittingReview ? '...' : '‚úÖ Approve Translation'}
                      </button>
                    </div>
                  </div>
                </div>
              </>
            )}
          </div>
        </div>
      )}

      {/* Stats Cards - Different for Admin vs PM */}
      {isPM ? (
        /* PM sees: My Orders, Translators Available, Translators Busy */
        <>
          <div className="grid grid-cols-3 gap-3 mb-4">
            <div className="bg-white rounded shadow p-3">
              <div className="text-[10px] text-gray-500 uppercase">Meus Pedidos</div>
              <div className="text-xl font-bold text-gray-800">{orders.length}</div>
            </div>
            <div
              onClick={() => setShowTranslatorsList(!showTranslatorsList)}
              className="bg-gradient-to-r from-green-500 to-green-600 rounded shadow p-3 text-white cursor-pointer hover:from-green-600 hover:to-green-700 transition-all"
            >
              <div className="text-[10px] uppercase opacity-80">Available Translators</div>
              <div className="text-xl font-bold">{translatorStats.available}</div>
              <div className="text-[9px] opacity-70 mt-1">Click to view list</div>
            </div>
            <div
              onClick={() => setShowTranslatorsList(!showTranslatorsList)}
              className="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded shadow p-3 text-white cursor-pointer hover:from-yellow-600 hover:to-yellow-700 transition-all"
            >
              <div className="text-[10px] uppercase opacity-80">Busy Translators</div>
              <div className="text-xl font-bold">{translatorStats.busy}</div>
              <div className="text-[9px] opacity-70 mt-1">Click to view list</div>
            </div>
          </div>

          {/* Translators List Panel */}
          {showTranslatorsList && (
            <div className="bg-white rounded-lg shadow mb-4 p-4">
              <div className="flex justify-between items-center mb-3">
                <h3 className="text-sm font-bold text-gray-800">üë• Translators List</h3>
                <button onClick={() => setShowTranslatorsList(false)} className="text-gray-500 hover:text-gray-700 text-xl">√ó</button>
              </div>
              {translatorsWithStatus.length === 0 ? (
                <div className="text-center py-4 text-gray-500 text-xs">No translators registered</div>
              ) : (
                <div className="grid grid-cols-2 gap-3">
                  {translatorsWithStatus.map((translator) => (
                    <div
                      key={translator.id}
                      className={`p-3 rounded-lg border-2 ${
                        translator.status === 'available'
                          ? 'border-green-200 bg-green-50'
                          : 'border-yellow-200 bg-yellow-50'
                      }`}
                    >
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center">
                          <div className={`w-2 h-2 rounded-full mr-2 ${translator.status === 'available' ? 'bg-green-500' : 'bg-yellow-500'}`}></div>
                          <span className="font-medium text-sm text-gray-800">{translator.name}</span>
                        </div>
                        <span className={`text-[10px] px-2 py-0.5 rounded-full ${
                          translator.status === 'available'
                            ? 'bg-green-500 text-white'
                            : 'bg-yellow-500 text-white'
                        }`}>
                          {translator.status === 'available' ? 'Available' : 'Busy'}
                        </span>
                      </div>
                      <div className="text-[10px] text-gray-500 mb-1">{translator.email}</div>
                      {translator.status === 'busy' && translator.projects && translator.projects.length > 0 && (
                        <div className="mt-2 pt-2 border-t border-gray-200">
                          <div className="text-[10px] font-medium text-gray-600 mb-1">Projetos Ativos:</div>
                          {translator.projects.map((proj, idx) => (
                            <div key={idx} className="flex justify-between items-center text-[10px] py-0.5">
                              <span className="text-blue-600 font-mono">{proj.code}</span>
                              <span className="text-gray-500">
                                {proj.deadline ? new Date(proj.deadline).toLocaleDateString('en-US', { timeZone: 'America/New_York' }) : 'No deadline'}
                              </span>
                            </div>
                          ))}
                        </div>
                      )}
                      {translator.status === 'available' && (
                        <div className="mt-2 text-[10px] text-green-600">‚úì Ready to novos projects</div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </>
      ) : null}

      <div className="flex justify-between items-center mb-3">
        <div className="flex items-center space-x-3">
          <h1 className="text-lg font-bold text-blue-600">{isPM ? 'MEUS PROJETOS' : 'PROJECTS'}</h1>
          {/* New Project button - Admin only */}
          {isAdmin && (
            <button
              onClick={() => setShowNewProjectForm(!showNewProjectForm)}
              className="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700"
            >
              + New Project
            </button>
          )}
          <div className="flex space-x-1">
            {['all', 'received', 'review', 'client_review', 'ready', 'delivered', 'final'].map((s) => (
              <button key={s} onClick={() => setStatusFilter(s)}
                className={`px-2 py-1 text-[10px] rounded ${statusFilter === s ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600'}`}>
                {s === 'all' ? 'All' : getStatusLabel(s)}
              </button>
            ))}
          </div>
          {/* Document Type Filter */}
          <select
            value={documentTypeFilter}
            onChange={(e) => setDocumentTypeFilter(e.target.value)}
            className="px-2 py-1 text-[10px] border rounded bg-white"
          >
            <option value="">All Documents</option>
            {DOCUMENT_TYPES.filter(d => d.value).map(doc => (
              <option key={doc.value} value={doc.value}>{doc.label}</option>
            ))}
          </select>
        </div>
        <SearchBar value={search} onChange={setSearch} />
      </div>

      {/* New Project Form */}
      {showNewProjectForm && (
        <div className="bg-white rounded-lg shadow mb-4 p-4">
          <h3 className="text-sm font-bold text-gray-800 mb-3">üìù Create New Project</h3>
          <form onSubmit={createProject}>
            <div className="grid grid-cols-5 gap-3 mb-3">
              {/* Client Info */}
              <div>
                <label className="block text-[10px] font-medium text-gray-600 mb-1">Client Name *</label>
                <input
                  type="text"
                  value={newProject.client_name}
                  onChange={(e) => setNewProject({...newProject, client_name: e.target.value})}
                  required
                  className="w-full px-2 py-1.5 text-xs border rounded"
                  placeholder="John Doe"
                />
              </div>
              <div>
                <label className="block text-[10px] font-medium text-gray-600 mb-1">Client Email *</label>
                <input
                  type="email"
                  value={newProject.client_email}
                  onChange={(e) => setNewProject({...newProject, client_email: e.target.value})}
                  required
                  className="w-full px-2 py-1.5 text-xs border rounded"
                  placeholder="client@email.com"
                />
              </div>
              <div>
                <label className="block text-[10px] font-medium text-gray-600 mb-1">Client Phone (WhatsApp)</label>
                <input
                  type="tel"
                  value={newProject.client_phone}
                  onChange={(e) => setNewProject({...newProject, client_phone: e.target.value})}
                  className="w-full px-2 py-1.5 text-xs border rounded"
                  placeholder="+1 (555) 123-4567"
                />
              </div>
              <div>
                <label className="block text-[10px] font-medium text-gray-600 mb-1">From Language *</label>
                <select
                  value={newProject.translate_from}
                  onChange={(e) => setNewProject({...newProject, translate_from: e.target.value})}
                  className="w-full px-2 py-1.5 text-xs border rounded"
                >
                  {PM_LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-[10px] font-medium text-gray-600 mb-1">To Language *</label>
                <select
                  value={newProject.translate_to}
                  onChange={(e) => setNewProject({...newProject, translate_to: e.target.value})}
                  className="w-full px-2 py-1.5 text-xs border rounded"
                >
                  {PM_LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                </select>
              </div>
            </div>

            {/* Document Type Row */}
            <div className="grid grid-cols-2 gap-3 mb-3">
              <div>
                <label className="block text-[10px] font-medium text-gray-600 mb-1">Document Type</label>
                <select
                  value={newProject.document_type}
                  onChange={(e) => setNewProject({...newProject, document_type: e.target.value})}
                  className="w-full px-2 py-1.5 text-xs border rounded"
                >
                  {DOCUMENT_TYPES.map(doc => <option key={doc.value} value={doc.value}>{doc.label}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-[10px] font-medium text-gray-600 mb-1">Service Type</label>
                <select
                  value={newProject.service_type}
                  onChange={(e) => setNewProject({...newProject, service_type: e.target.value})}
                  className="w-full px-2 py-1.5 text-xs border rounded"
                >
                  <option value="certified">Certified</option>
                  <option value="standard">Standard</option>
                  <option value="rmv">RMV</option>
                  <option value="sworn">Sworn Translation</option>
                </select>
              </div>
            </div>

            <div className="grid grid-cols-5 gap-3 mb-3">
              <div>
                <label className="block text-[10px] font-medium text-gray-600 mb-1">Pages</label>
                <input
                  type="number"
                  value={newProject.page_count}
                  onChange={(e) => setNewProject({...newProject, page_count: parseInt(e.target.value) || 1})}
                  min="1"
                  className="w-full px-2 py-1.5 text-xs border rounded"
                />
              </div>
              <div>
                <label className="block text-[10px] font-medium text-gray-600 mb-1">Urgency</label>
                <select
                  value={newProject.urgency}
                  onChange={(e) => setNewProject({...newProject, urgency: e.target.value})}
                  className="w-full px-2 py-1.5 text-xs border rounded"
                >
                  <option value="no">Normal</option>
                  <option value="priority">Priority</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>
              <div>
                <label className="block text-[10px] font-medium text-gray-600 mb-1">Deadline</label>
                <div className="flex gap-1">
                  <input
                    type="date"
                    value={newProject.deadline}
                    onChange={(e) => setNewProject({...newProject, deadline: e.target.value})}
                    className="flex-1 px-2 py-1.5 text-xs border rounded"
                  />
                  <input
                    type="time"
                    value={newProject.deadline_time}
                    onChange={(e) => setNewProject({...newProject, deadline_time: e.target.value})}
                    className="w-20 px-1 py-1.5 text-xs border rounded"
                  />
                </div>
              </div>
              <div>
                <label className="block text-[10px] font-medium text-gray-600 mb-1">Price ($)</label>
                <input
                  type="number"
                  value={newProject.total_price}
                  onChange={(e) => setNewProject({...newProject, total_price: e.target.value, base_price: e.target.value})}
                  min="0"
                  step="0.01"
                  placeholder="0.00"
                  className="w-full px-2 py-1.5 text-xs border rounded"
                />
              </div>
              <div>
                <label className="block text-[10px] font-medium text-gray-600 mb-1">Payment Method</label>
                <select
                  value={newProject.payment_method}
                  onChange={(e) => setNewProject({...newProject, payment_method: e.target.value})}
                  className="w-full px-2 py-1.5 text-xs border rounded"
                >
                  {PAYMENT_METHODS.map(pm => <option key={pm.value} value={pm.value}>{pm.label}</option>)}
                </select>
              </div>
            </div>

            {/* Payment Status Section */}
            <div className="mb-3 p-3 bg-gray-50 rounded border">
              <div className="flex items-center justify-between mb-2">
                <label className="text-[10px] font-medium text-gray-700">Payment Status</label>
                <label className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={newProject.payment_received}
                    onChange={(e) => setNewProject({...newProject, payment_received: e.target.checked, payment_tag: e.target.checked ? '' : newProject.payment_tag})}
                    className="w-4 h-4 rounded border-gray-300"
                  />
                  <span className={`text-xs font-medium ${newProject.payment_received ? 'text-green-600' : 'text-gray-600'}`}>
                    {newProject.payment_received ? '‚úì Payment Received' : 'Payment Received'}
                  </span>
                </label>
              </div>

              {!newProject.payment_received && (
                <div className="space-y-2">
                  <div className="text-[10px] text-gray-500 mb-1">Payment Tag:</div>
                  <div className="flex flex-wrap gap-2">
                    {[
                      { value: '', label: 'Awaiting Payment' },
                      { value: 'bonus', label: 'üéÅ Bonus' },
                      { value: 'no_charge', label: 'üö´ No Charge' },
                      { value: 'partner', label: 'ü§ù Partner' }
                    ].map(tag => (
                      <label key={tag.value} className="flex items-center gap-1 cursor-pointer">
                        <input
                          type="radio"
                          name="payment_tag"
                          value={tag.value}
                          checked={newProject.payment_tag === tag.value}
                          onChange={(e) => setNewProject({...newProject, payment_tag: e.target.value})}
                          className="w-3 h-3"
                        />
                        <span className="text-[10px] text-gray-600">{tag.label}</span>
                      </label>
                    ))}
                  </div>

                  {/* Invoice Options */}
                  <div className="mt-3 pt-2 border-t">
                    <label className="flex items-center gap-2 cursor-pointer mb-2">
                      <input
                        type="checkbox"
                        checked={newProject.create_invoice}
                        onChange={(e) => setNewProject({...newProject, create_invoice: e.target.checked})}
                        className="w-4 h-4 rounded border-gray-300"
                      />
                      <span className="text-[10px] font-medium text-gray-700">üìÑ Create Invoice</span>
                    </label>

                    {newProject.create_invoice && (
                      <div className="ml-6 flex flex-wrap gap-2">
                        {[
                          { value: '15_days', label: '15 Days' },
                          { value: '30_days', label: '30 Days' },
                          { value: 'custom', label: 'Custom Date' }
                        ].map(term => (
                          <label key={term.value} className="flex items-center gap-1 cursor-pointer">
                            <input
                              type="radio"
                              name="invoice_terms"
                              value={term.value}
                              checked={newProject.invoice_terms === term.value}
                              onChange={(e) => setNewProject({...newProject, invoice_terms: e.target.value})}
                              className="w-3 h-3"
                            />
                            <span className="text-[10px] text-gray-600">{term.label}</span>
                          </label>
                        ))}
                        {newProject.invoice_terms === 'custom' && (
                          <input
                            type="date"
                            value={newProject.invoice_custom_date}
                            onChange={(e) => setNewProject({...newProject, invoice_custom_date: e.target.value})}
                            className="px-2 py-1 text-xs border rounded"
                          />
                        )}
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>

            {/* Document Upload - Multiple Files */}
            <div className="mb-3">
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-[10px] font-medium text-gray-600 mb-1">Documents to Translate (Multiple allowed)</label>
                  <div className="flex items-center space-x-2">
                    <input
                      type="file"
                      multiple
                      onChange={(e) => setDocumentFiles(Array.from(e.target.files))}
                      accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.tiff,.bmp,.gif"
                      className="text-xs"
                    />
                    {documentFiles.length > 0 && (
                      <span className="text-xs text-green-600">‚úì {documentFiles.length} file(s) selected</span>
                    )}
                  </div>
                  <p className="text-[9px] text-gray-400 mt-1">Accepted: PDF, DOC, DOCX, TXT, JPG, PNG, TIFF, BMP, GIF - Max 100MB per file</p>
                </div>
                <div>
                  <label className="block text-[10px] font-medium text-gray-600 mb-1">Document Category</label>
                  <select
                    value={newProject.document_category}
                    onChange={(e) => setNewProject({...newProject, document_category: e.target.value})}
                    className="w-full px-2 py-1.5 text-xs border rounded"
                  >
                    {DOCUMENT_CATEGORIES.map(cat => <option key={cat.value} value={cat.value}>{cat.label}</option>)}
                  </select>
                  <p className="text-[9px] text-gray-400 mt-1">Select the category that best describes your documents</p>
                </div>
              </div>
              {documentFiles.length > 0 && (
                <div className="mt-2 space-y-1">
                  {documentFiles.map((file, idx) => (
                    <div key={idx} className="flex items-center justify-between bg-gray-50 px-2 py-1 rounded text-xs">
                      <span className="truncate max-w-xs">{file.name}</span>
                      <span className="text-gray-400 ml-2">({(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                      <button
                        type="button"
                        onClick={() => setDocumentFiles(documentFiles.filter((_, i) => i !== idx))}
                        className="ml-2 text-red-500 hover:text-red-700"
                      >
                        √ó
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div className="grid grid-cols-4 gap-3 mb-3">
              <div>
                <label className="block text-[10px] font-medium text-gray-600 mb-1">Project Manager</label>
                <select
                  value={newProject.assigned_pm_id}
                  onChange={(e) => setNewProject({...newProject, assigned_pm_id: e.target.value})}
                  className="w-full px-2 py-1.5 text-xs border rounded"
                >
                  <option value="">-- Select PM --</option>
                  {pmList.map(pm => <option key={pm.id} value={pm.id}>{pm.name}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-[10px] font-medium text-gray-600 mb-1">Translator</label>
                <select
                  value={newProject.assigned_translator_id}
                  onChange={(e) => setNewProject({...newProject, assigned_translator_id: e.target.value})}
                  className="w-full px-2 py-1.5 text-xs border rounded"
                >
                  <option value="">-- Select Translator --</option>
                  {translatorList.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                </select>
              </div>
              <div className="col-span-2">
                <label className="block text-[10px] font-medium text-gray-600 mb-1">Client Notes</label>
                <input
                  type="text"
                  value={newProject.notes}
                  onChange={(e) => setNewProject({...newProject, notes: e.target.value})}
                  className="w-full px-2 py-1.5 text-xs border rounded"
                  placeholder="Notes visible to client"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-3 mb-3">
              <div>
                <label className="block text-[10px] font-medium text-gray-600 mb-1">Revenue Source</label>
                <select
                  value={newProject.revenue_source}
                  onChange={(e) => setNewProject({...newProject, revenue_source: e.target.value})}
                  className="w-full px-2 py-1.5 text-xs border rounded"
                >
                  {REVENUE_SOURCES.map(src => <option key={src.value} value={src.value}>{src.label}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-[10px] font-medium text-gray-600 mb-1">Internal Notes (Admin/PM only)</label>
                <textarea
                  value={newProject.internal_notes}
                  onChange={(e) => setNewProject({...newProject, internal_notes: e.target.value})}
                  className="w-full px-2 py-1.5 text-xs border rounded"
                  rows="1"
                  placeholder="Internal notes"
                />
              </div>
            </div>

            <div className="flex justify-end gap-2">
              <button type="button" onClick={() => setShowNewProjectForm(false)} className="px-4 py-1.5 text-gray-600 text-xs">
                Cancel
              </button>
              <button type="submit" disabled={creatingProject} className="px-4 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:bg-gray-400">
                {creatingProject ? 'Creating...' : 'Create Project'}
              </button>
            </div>
          </form>
        </div>
      )}

      <div className="bg-white rounded-lg shadow-sm overflow-x-auto border border-gray-100">
        <table className="w-full text-sm">
          <thead className="bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-200">
            <tr>
              <th className="px-3 py-3 text-left font-semibold text-blue-700">Code</th>
              <th className="px-3 py-3 text-left font-semibold text-gray-700">Order Date</th>
              <th className="px-3 py-3 text-left font-semibold text-gray-700">Client</th>
              <th className="px-3 py-3 text-left font-semibold text-gray-700">Doc Type</th>
              {/* PM column - Admin only */}
              {isAdmin && <th className="px-3 py-3 text-left font-semibold text-gray-700">PM</th>}
              <th className="px-3 py-3 text-left font-semibold text-gray-700">Translator</th>
              <th className="px-3 py-3 text-left font-semibold text-gray-700" title="Prazo do Tradutor - Data de retorno da tradu√ß√£o">TR Deadline</th>
              <th className="px-3 py-3 text-left font-semibold text-gray-700" title="Prazo do Cliente - Data de entrega ao cliente">Client Deadline</th>
              <th className="px-3 py-3 text-left font-semibold text-gray-700">Status</th>
              {/* Translation Ready column - shows when translation is complete */}
              <th className="px-3 py-3 text-center font-semibold text-gray-700">Translation</th>
              {/* Total and Payment columns - Admin only */}
              {isAdmin && <th className="px-3 py-3 text-right font-semibold text-gray-700">Total</th>}
              {isAdmin && <th className="px-3 py-3 text-center font-semibold text-gray-700">Payment</th>}
              <th className="px-3 py-3 text-center font-semibold text-gray-700">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100">
            {filtered.map((order) => {
              const created = parseUTCDate(order.created_at);
              // Translator deadline - when translator must return
              const hasTranslatorDeadline = order.translator_deadline ? true : false;
              const translatorDeadline = hasTranslatorDeadline ? parseUTCDate(order.translator_deadline) : null;
              const translatorDaysUntil = hasTranslatorDeadline ? Math.ceil((translatorDeadline - new Date()) / (1000 * 60 * 60 * 24)) : null;
              // Client deadline - when to deliver to client
              const hasClientDeadline = order.deadline ? true : false;
              const clientDeadline = hasClientDeadline ? parseUTCDate(order.deadline) : null;
              const clientDaysUntil = hasClientDeadline ? Math.ceil((clientDeadline - new Date()) / (1000 * 60 * 60 * 24)) : null;
              return (
                <tr key={order.id} className="hover:bg-blue-50/50 transition-colors">
                  {/* Code */}
                  <td className="px-3 py-3 font-medium">
                    <button
                      onClick={() => viewOrderDocuments(order)}
                      className="text-blue-600 hover:text-blue-800 hover:underline cursor-pointer font-semibold"
                      title="Ver document original"
                    >
                      {order.order_number}
                    </button>
                  </td>
                  {/* Order Date */}
                  <td className="px-3 py-3 text-gray-600">
                    {created.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric', timeZone: NY_TIMEZONE })}
                    <span className="text-xs text-gray-400 block">{created.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', timeZone: NY_TIMEZONE })}</span>
                  </td>
                  {/* Client with email and send buttons */}
                  <td className="px-3 py-3">
                    <div className="flex items-center gap-2">
                      <div>
                        <span className="font-medium text-gray-800">{order.client_name}</span>
                        <span className="text-gray-400 text-xs block">{order.client_email}</span>
                      </div>
                      {/* Send translation button - Admin only - shows when ready, review, or delivered (for resend) */}
                      {['ready', 'review', 'delivered', 'pending_admin_approval', 'pending_admin_review', 'finalized_pending_admin'].includes(order.translation_status) && isAdmin && (
                        <button
                          onClick={() => openSendToClientModal(order)}
                          className={`px-1 py-0.5 rounded text-[9px] ${
                            order.translation_status === 'delivered'
                              ? 'bg-blue-500 text-white hover:bg-blue-600'
                              : 'bg-blue-500 text-white hover:bg-blue-600'
                          }`}
                          title={order.translation_status === 'delivered' ? 'Resend translation' : 'Send translation to client'}
                        >
                          {order.translation_status === 'delivered' ? 'üîÑ' : 'üì§'}
                        </button>
                      )}
                    </div>
                  </td>
                  {/* Document Type */}
                  <td className="px-3 py-3">
                    <span className="text-xs px-2 py-1 bg-slate-100 text-slate-700 rounded">
                      {DOCUMENT_TYPES.find(d => d.value === order.document_type)?.label?.split('/')[0]?.trim() || order.document_type || '-'}
                    </span>
                  </td>
                  {/* PM - Admin only */}
                  {isAdmin && (
                    <td className={`px-3 py-3 ${(order.assigned_pm_name || order.assigned_pm) ? 'bg-green-50' : ''}`}>
                      {assigningPM === order.id ? (
                        <select
                          autoFocus
                          className="px-2 py-1 text-xs border rounded w-28"
                          onChange={(e) => {
                            if (e.target.value) assignPM(order.id, e.target.value);
                          }}
                          onBlur={() => setAssigningPM(null)}
                        >
                          <option value="">Select...</option>
                          {/* Use registered PMs from dattabse, fallback to static list */}
                          {(pmList.length > 0 ? pmList : PROJECT_MANAGERS).map(pm => (
                            <option key={pm.id || pm.name} value={pm.name}>{pm.name}</option>
                          ))}
                        </select>
                      ) : (order.assigned_pm_name || order.assigned_pm) ? (
                        <span
                          onClick={() => setAssigningPM(order.id)}
                          className="text-xs text-green-700 font-medium cursor-pointer hover:text-green-900 hover:underline"
                          title="Click to change PM"
                        >
                          {order.assigned_pm_name || order.assigned_pm}
                        </span>
                      ) : (
                        <button
                          onClick={() => setAssigningPM(order.id)}
                          className="px-2 py-1 bg-gray-100 text-gray-500 rounded text-xs hover:bg-gray-200"
                        >
                          Assign
                        </button>
                      )}
                    </td>
                  )}
                  {/* Translator */}
                  <td className={`px-3 py-3 ${(order.assigned_translator_name || order.assigned_translator) ? 'bg-green-50' : ''}`}>
                    {assigningTranslator === order.id ? (
                      <select
                        autoFocus
                        className="px-2 py-1 text-xs border rounded w-28"
                        onChange={(e) => {
                          if (e.target.value) assignTranslator(order.id, e.target.value);
                        }}
                        onBlur={() => setAssigningTranslator(null)}
                      >
                        <option value="">Select...</option>
                        {/* Use registered translators from dattabse, fallback to static list */}
                        {(translatorList.length > 0 ? translatorList : TRANSLATORS).map(t => (
                          <option key={t.id || t.name} value={t.name}>{t.name}</option>
                        ))}
                      </select>
                    ) : (order.assigned_translator_name || order.assigned_translator) ? (
                      <div className="flex flex-col">
                        <span
                          onClick={() => (isAdmin || isPM) && openAssignTranslatorModal(order)}
                          className={`text-xs text-green-700 font-medium ${(isAdmin || isPM) ? 'cursor-pointer hover:text-green-900 hover:underline' : ''}`}
                          title={(isAdmin || isPM) ? "Click to change translator" : ""}
                        >
                          {order.assigned_translator_name || order.assigned_translator}
                        </span>
                        {order.translator_assignment_status === 'pending' && (
                          <span
                            onClick={(e) => {
                              e.stopPropagation();
                              if (isAdmin || isPM) {
                                if (confirm('Mark translator as Accepted? (Use this if translator is already working but status is stuck on Pending)')) {
                                  updateTranslatorAssignmentStatus(order.id, 'accepted');
                                }
                              }
                            }}
                            className={`text-xs px-1.5 py-0.5 bg-yellow-50 text-yellow-600 rounded mt-1 inline-block w-fit border border-yellow-200 ${(isAdmin || isPM) ? 'cursor-pointer hover:bg-yellow-100' : ''}`}
                            title={(isAdmin || isPM) ? "Click to mark as Accepted" : ""}
                          >
                            Pending
                          </span>
                        )}
                        {order.translator_assignment_status === 'accepted' && (
                          <span
                            onClick={(e) => {
                              e.stopPropagation();
                              if (isAdmin || isPM) {
                                if (confirm('Change status back to Pending?')) {
                                  updateTranslatorAssignmentStatus(order.id, 'pending');
                                }
                              }
                            }}
                            className={`text-xs px-1.5 py-0.5 bg-green-100 text-green-700 rounded mt-1 inline-block w-fit ${(isAdmin || isPM) ? 'cursor-pointer hover:bg-green-200' : ''}`}
                            title={(isAdmin || isPM) ? "Click to change status" : ""}
                          >
                            ‚úì Accepted
                          </span>
                        )}
                        {order.translator_assignment_status === 'declined' && (
                          <div className="flex flex-col gap-1">
                            <span className="text-xs px-1.5 py-0.5 bg-red-100 text-red-700 rounded inline-block w-fit">‚úï Declined</span>
                            {(isAdmin || isPM) && (
                              <button
                                onClick={() => openAssignTranslatorModal(order)}
                                className="text-xs px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 flex items-center gap-1"
                              >
                                <RefreshIcon className="w-3 h-3" /> Reassign
                              </button>
                            )}
                          </div>
                        )}
                      </div>
                    ) : (isAdmin || isPM) ? (
                      <div className="flex flex-col gap-1">
                        <button
                          onClick={() => openAssignTranslatorModal(order)}
                          className="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs hover:bg-gray-200 flex items-center gap-1"
                        >
                          <AssignIcon className="w-3 h-3" /> Translator
                        </button>
                      </div>
                    ) : (
                      <span className="text-xs text-gray-400">-</span>
                    )}
                  </td>
                  {/* Translator Deadline - When translator must return translation */}
                  <td className="px-3 py-3">
                    {editingTranslatorDeadline === order.id && (isAdmin || isPM) ? (
                      <div className="flex flex-col gap-1">
                        <input
                          type="date"
                          value={tempTranslatorDeadlineValue.date}
                          onChange={(e) => setTempTranslatorDeadlineValue({...tempTranslatorDeadlineValue, date: e.target.value})}
                          className="px-2 py-1 text-xs border rounded w-28"
                        />
                        <input
                          type="time"
                          value={tempTranslatorDeadlineValue.time}
                          onChange={(e) => setTempTranslatorDeadlineValue({...tempTranslatorDeadlineValue, time: e.target.value})}
                          className="px-2 py-1 text-xs border rounded w-28"
                        />
                        <div className="flex gap-1">
                          <button onClick={() => saveTranslatorDeadlineEdit(order.id)} className="px-2 py-1 bg-green-500 text-white rounded text-xs">‚úì</button>
                          <button onClick={() => setEditingTranslatorDeadline(null)} className="px-2 py-1 bg-gray-300 text-gray-700 rounded text-xs">‚úï</button>
                        </div>
                      </div>
                    ) : hasTranslatorDeadline ? (
                      <div
                        onClick={() => (isAdmin || isPM) && startEditingTranslatorDeadline(order)}
                        className={`${(isAdmin || isPM) ? 'cursor-pointer hover:text-blue-600' : ''}`}
                        title={(isAdmin || isPM) ? "Click to edit translator deadline" : ""}
                      >
                        {translatorDeadline.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', timeZone: NY_TIMEZONE })}
                        <span className="text-xs text-gray-500 block">{translatorDeadline.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', timeZone: NY_TIMEZONE })}</span>
                        {translatorDaysUntil > 0 && order.translation_status !== 'delivered' && (
                          <span className={`text-xs font-medium ${translatorDaysUntil <= 2 ? 'text-red-600' : 'text-yellow-600'}`}>({translatorDaysUntil}d)</span>
                        )}
                      </div>
                    ) : (
                      <span
                        onClick={() => (isAdmin || isPM) && startEditingTranslatorDeadline(order)}
                        className={`text-xs text-gray-400 ${(isAdmin || isPM) ? 'cursor-pointer hover:text-blue-600' : ''}`}
                        title={(isAdmin || isPM) ? "Click to set translator deadline" : ""}
                      >
                        -
                      </span>
                    )}
                  </td>
                  {/* Client Deadline - When to deliver to client */}
                  <td className="px-3 py-3">
                    {editingDeadline === order.id && isAdmin ? (
                      <div className="flex flex-col gap-1">
                        <input
                          type="date"
                          value={tempDeadlineValue.date}
                          onChange={(e) => setTempDeadlineValue({...tempDeadlineValue, date: e.target.value})}
                          className="px-2 py-1 text-xs border rounded w-28"
                        />
                        <input
                          type="time"
                          value={tempDeadlineValue.time}
                          onChange={(e) => setTempDeadlineValue({...tempDeadlineValue, time: e.target.value})}
                          className="px-2 py-1 text-xs border rounded w-28"
                        />
                        <div className="flex gap-1">
                          <button onClick={() => saveDeadlineEdit(order.id)} className="px-2 py-1 bg-green-500 text-white rounded text-xs">‚úì</button>
                          <button onClick={() => setEditingDeadline(null)} className="px-2 py-1 bg-gray-300 text-gray-700 rounded text-xs">‚úï</button>
                        </div>
                      </div>
                    ) : hasClientDeadline ? (
                      <div
                        onClick={() => isAdmin && startEditingDeadline(order)}
                        className={`${isAdmin ? 'cursor-pointer hover:text-blue-600' : ''}`}
                        title={isAdmin ? "Click to edit client deadline" : ""}
                      >
                        {clientDeadline.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', timeZone: NY_TIMEZONE })}
                        <span className="text-xs text-gray-500 block">{clientDeadline.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', timeZone: NY_TIMEZONE })}</span>
                        {clientDaysUntil > 0 && order.translation_status !== 'delivered' && (
                          <span className={`text-xs font-medium ${clientDaysUntil <= 2 ? 'text-red-600' : 'text-yellow-600'}`}>({clientDaysUntil}d)</span>
                        )}
                      </div>
                    ) : (
                      <span
                        onClick={() => isAdmin && startEditingDeadline(order)}
                        className={`text-xs text-gray-400 ${isAdmin ? 'cursor-pointer hover:text-blue-600' : ''}`}
                        title={isAdmin ? "Click to set client deadline" : ""}
                      >
                        -
                      </span>
                    )}
                  </td>
                  {/* Status */}
                  <td className="px-3 py-3"><span className={`px-2 py-1 rounded text-xs font-medium ${STATUS_COLORS[order.translation_status] || 'bg-gray-100'}`}>{getStatusLabel(order.translation_status)}</span></td>
                  {/* Translation Ready column - shows when translation is complete */}
                  <td className="px-3 py-3 text-center">
                    {order.translation_ready ? (
                      <div className="flex flex-col items-center gap-0.5">
                        <span className="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">
                          ‚úÖ Ready
                        </span>
                        {order.translation_ready_at && (
                          <span className="text-xs text-gray-500">
                            {parseUTCDate(order.translation_ready_at).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', timeZone: NY_TIMEZONE })}
                          </span>
                        )}
                      </div>
                    ) : ['review', 'ready', 'delivered'].includes(order.translation_status) ? (
                      <span className="px-2 py-1 bg-blue-50 text-blue-600 rounded text-xs font-medium border border-blue-200 flex items-center gap-1">
                        <RefreshIcon className="w-3 h-3" /> Review
                      </span>
                    ) : order.translation_status === 'in_translation' ? (
                      <span className="px-2 py-1 bg-yellow-50 text-yellow-600 rounded text-xs font-medium border border-yellow-200 flex items-center gap-1">
                        <ClockIcon className="w-3 h-3" /> Working
                      </span>
                    ) : (
                      <span className="text-gray-300 text-xs">-</span>
                    )}
                  </td>
                  {/* Total and Payment columns - Admin only */}
                  {isAdmin && <td className="px-3 py-3 text-right font-semibold text-gray-800">${order.total_price?.toFixed(2)}</td>}
                  {isAdmin && <td className="px-3 py-3 text-center"><span className={`px-2 py-1 rounded text-xs font-medium ${PAYMENT_COLORS[order.payment_status]}`}>{order.payment_status}</span></td>}
                  <td className="px-3 py-3 text-center">
                    <div className="relative">
                      <button
                        onClick={() => setOpenActionsDropdown(openActionsDropdown === order.id ? null : order.id)}
                        className="w-8 h-8 flex items-center justify-center border border-slate-200 text-slate-500 rounded-lg hover:border-slate-400 hover:bg-slate-50 transition-colors"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                        </svg>
                      </button>
                      {openActionsDropdown === order.id && (
                        <div className="absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-slate-200 py-1 z-50">
                          {/* View Documents */}
                          <button
                            onClick={() => { viewOrderDocuments(order); setOpenActionsDropdown(null); }}
                            className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2"
                          >
                            <DocumentIcon className="w-4 h-4 text-slate-400" />
                            View Documents
                          </button>

                          {/* Translation Tool */}
                          {(isAdmin || isPM) && ['received', 'in_translation', 'review'].includes(order.translation_status) && (
                            <button
                              onClick={() => { startTranslation(order); setOpenActionsDropdown(null); }}
                              className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-blue-50 flex items-center gap-2"
                            >
                              <WriteIcon className="w-4 h-4 text-blue-500" />
                              Open Translation
                            </button>
                          )}

                          {/* Review Side-by-Side */}
                          {(isAdmin || isPM) && ['review', 'ready', 'client_review'].includes(order.translation_status) && (
                            <button
                              onClick={() => { openReviewModal(order); setOpenActionsDropdown(null); }}
                              className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-emerald-50 flex items-center gap-2"
                            >
                              <SearchIcon className="w-4 h-4 text-emerald-500" />
                              Review Side-by-Side
                            </button>
                          )}

                          {/* Download Translation Package */}
                          {(isAdmin || isPM) && (order.translation_ready || ['ready', 'delivered', 'final', 'pending_admin_approval', 'pending_admin_review', 'finalized_pending_admin', 'review', 'pending_pm_review'].includes(order.translation_status)) && (
                            <button
                              onClick={() => { downloadOrderPackage(order); setOpenActionsDropdown(null); }}
                              disabled={downloadingPackage === order.id}
                              className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-purple-50 flex items-center gap-2 disabled:opacity-50"
                            >
                              <DownloadIcon className="w-4 h-4 text-purple-500" />
                              {downloadingPackage === order.id ? 'Generating...' : 'Download Package (PDF)'}
                            </button>
                          )}

                          {/* Confirm Payment - for WhatsApp/MIA quotes */}
                          {isAdmin && (order.translation_status === 'Quote' || (order.translation_status === 'received' && order.payment_status === 'pending')) && (
                            <button
                              onClick={() => { confirmQuotePayment(order.id); setOpenActionsDropdown(null); }}
                              className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-green-50 flex items-center gap-2"
                            >
                              <CheckIcon className="w-4 h-4 text-green-500" />
                              üí∞ Confirm Payment
                            </button>
                          )}

                          <div className="border-t border-slate-100 my-1"></div>

                          {/* Status Actions */}
                          {(isAdmin || isPM) && order.translation_status === 'received' && (isAdmin || order.translator_assignment_status === 'accepted') && (
                            <button
                              onClick={() => { updateStatus(order.id, 'in_translation'); setOpenActionsDropdown(null); }}
                              className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-sky-50 flex items-center gap-2"
                            >
                              <PlayIcon className="w-4 h-4 text-sky-500" />
                              Start Translation
                            </button>
                          )}

                          {(isAdmin || isPM) && order.translation_status === 'in_translation' && (
                            <button
                              onClick={() => { updateStatus(order.id, 'review'); setOpenActionsDropdown(null); }}
                              className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-indigo-50 flex items-center gap-2"
                            >
                              <EyeIcon className="w-4 h-4 text-indigo-500" />
                              Send to PM Review
                            </button>
                          )}

                          {/* Admin only: Approve from PM/Translator */}
                          {isAdmin && ['pending_admin_approval', 'pending_admin_review', 'finalized_pending_admin'].includes(order.translation_status) && (
                            <>
                              <button
                                onClick={() => { updateStatus(order.id, 'ready'); setOpenActionsDropdown(null); }}
                                className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-green-50 flex items-center gap-2"
                              >
                                <CheckIcon className="w-4 h-4 text-green-500" />
                                ‚úÖ Approve (Ready for Delivery)
                              </button>
                              <button
                                onClick={() => { updateStatus(order.id, 'review'); setOpenActionsDropdown(null); }}
                                className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-yellow-50 flex items-center gap-2"
                              >
                                <RefreshIcon className="w-4 h-4 text-yellow-500" />
                                Return to PM Review
                              </button>
                            </>
                          )}

                          {/* Admin only: Send to Client Review and Mark as Final */}
                          {isAdmin && (order.translation_status === 'review' || order.translation_status === 'pending_pm_review') && (
                            <>
                              <button
                                onClick={() => { updateStatus(order.id, 'client_review'); setOpenActionsDropdown(null); }}
                                className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-blue-50 flex items-center gap-2"
                              >
                                <MailIcon className="w-4 h-4 text-blue-500" />
                                Send to Client Review
                              </button>
                              <button
                                onClick={() => { updateStatus(order.id, 'ready'); setOpenActionsDropdown(null); }}
                                className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-emerald-50 flex items-center gap-2"
                              >
                                <CheckIcon className="w-4 h-4 text-emerald-500" />
                                Mark as Ready
                              </button>
                            </>
                          )}

                          {/* Admin only: Client review actions */}
                          {isAdmin && order.translation_status === 'client_review' && (
                            <>
                              <button
                                onClick={() => { updateStatus(order.id, 'review'); setOpenActionsDropdown(null); }}
                                className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-yellow-50 flex items-center gap-2"
                              >
                                <RefreshIcon className="w-4 h-4 text-yellow-500" />
                                Back to Revision
                              </button>
                              <button
                                onClick={() => { updateStatus(order.id, 'ready'); setOpenActionsDropdown(null); }}
                                className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-emerald-50 flex items-center gap-2"
                              >
                                <CheckIcon className="w-4 h-4 text-emerald-500" />
                                Mark as Final
                              </button>
                            </>
                          )}

                          {/* Admin only: Preview & Send Translation */}
                          {isAdmin && ['ready', 'pending_admin_approval', 'pending_admin_review', 'finalized_pending_admin', 'review', 'pending_pm_review'].includes(order.translation_status) && (
                            <button
                              onClick={() => { openDeliveryModal(order); setOpenActionsDropdown(null); }}
                              className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-blue-50 flex items-center gap-2"
                            >
                              <MailIcon className="w-4 h-4 text-blue-500" />
                              üìß Preview & Send Email
                            </button>
                          )}

                          {/* Admin only: Deliver to Client (quick) */}
                          {isAdmin && (order.translation_status === 'ready' || order.translation_status === 'final') && (
                            <button
                              onClick={() => { deliverOrder(order.id); setOpenActionsDropdown(null); }}
                              className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-blue-50 flex items-center gap-2"
                            >
                              <SendIcon className="w-4 h-4 text-teal-500" />
                              Deliver to Client (Quick)
                            </button>
                          )}

                          {/* Admin only: Mark as Final (project completed) */}
                          {isAdmin && (order.translation_status === 'delivered' || order.translation_status === 'ready') && (
                            <button
                              onClick={() => { updateStatus(order.id, 'final'); setOpenActionsDropdown(null); }}
                              className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-blue-50 flex items-center gap-2"
                            >
                              <CheckIcon className="w-4 h-4 text-purple-500" />
                              Mark as Final
                            </button>
                          )}

                          {/* Admin only: Reopen delivered/final order for corrections */}
                          {isAdmin && (order.translation_status === 'delivered' || order.translation_status === 'final') && (
                            <button
                              onClick={() => { reopenOrder(order.id); setOpenActionsDropdown(null); }}
                              className="w-full px-3 py-2 text-left text-sm text-yellow-700 hover:bg-yellow-50 flex items-center gap-2"
                            >
                              <RefreshIcon className="w-4 h-4 text-yellow-500" />
                              Reopen for Corrections
                            </button>
                          )}

                          {/* Admin-only Actions */}
                          {isAdmin && (
                            <>
                              <div className="border-t border-slate-100 my-1"></div>
                              {order.payment_status === 'pending' && (
                                <button
                                  onClick={() => { markPaid(order.id); setOpenActionsDropdown(null); }}
                                  className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-emerald-50 flex items-center gap-2"
                                >
                                  <span className="w-4 h-4 flex items-center justify-center text-emerald-500 font-semibold">$</span>
                                  Mark as Paid
                                </button>
                              )}
                              <button
                                onClick={() => { deleteOrder(order.id, order.order_number); setOpenActionsDropdown(null); }}
                                className="w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"
                              >
                                <TrashIcon className="w-4 h-4" />
                                Delete Order
                              </button>
                            </>
                          )}
                        </div>
                      )}
                    </div>
                  </td>
                </tr>
              );
            })}
          </tbody>
          {/* Summary Footer */}
          {filtered.length > 0 && (
            <tfoot>
              <tr className="bg-slate-100 border-t-2 border-slate-300">
                <td colSpan={isAdmin ? 11 : 10} className="px-4 py-3">
                  <div className="flex justify-between items-center text-sm font-medium">
                    <span className="text-slate-700">
                      üìä Total Orders: <span className="text-blue-600 font-bold">{filtered.length}</span>
                    </span>
                    {isAdmin && (
                      <span className="text-slate-700">
                        üí∞ Total Revenue: <span className="text-green-600 font-bold">${filtered.reduce((sum, order) => sum + (order.total_price || 0), 0).toFixed(2)}</span>
                      </span>
                    )}
                  </div>
                </td>
              </tr>
            </tfoot>
          )}
        </table>
        {filtered.length === 0 && <div className="p-8 text-center text-gray-500 text-sm">No projects found</div>}

        {/* Pagination Controls */}
        {totalPages > 1 && (
          <div className="flex items-center justify-between px-4 py-3 bg-gray-50 border-t">
            <div className="text-xs text-gray-600">
              Showing {((currentPage - 1) * pageSize) + 1} - {Math.min(currentPage * pageSize, totalCount)} of {totalCount} projects
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={() => handlePageChange(1)}
                disabled={currentPage === 1}
                className="px-2 py-1 text-xs border rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100"
              >
                ¬´¬´
              </button>
              <button
                onClick={() => handlePageChange(currentPage - 1)}
                disabled={currentPage === 1}
                className="px-3 py-1 text-xs border rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100"
              >
                ‚Äπ Prev
              </button>
              <span className="px-3 py-1 text-xs font-medium">
                Page {currentPage} of {totalPages}
              </span>
              <button
                onClick={() => handlePageChange(currentPage + 1)}
                disabled={currentPage === totalPages}
                className="px-3 py-1 text-xs border rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100"
              >
                Next ‚Ä∫
              </button>
              <button
                onClick={() => handlePageChange(totalPages)}
                disabled={currentPage === totalPages}
                className="px-2 py-1 text-xs border rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100"
              >
                ¬ª¬ª
              </button>
            </div>
          </div>
        )}
      </div>

      {/* Enhanced Project Details Modal */}
      {viewingOrder && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col">
            {/* Header */}
            <div className="p-4 border-b flex justify-between items-center bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-t-lg">
              <div>
                <h3 className="font-bold text-lg">PROJECT {viewingOrder.order_number}</h3>
                <p className="text-xs opacity-80">{viewingOrder.client_name}</p>
              </div>
              <div className="flex items-center gap-2">
                {(isAdmin || isPM) && !editingProject && (
                  <button
                    onClick={startEditingProject}
                    className="px-3 py-1 bg-white bg-opacity-20 rounded text-xs hover:bg-opacity-30 font-medium"
                  >
                    ‚úèÔ∏è Edit
                  </button>
                )}
                {editingProject && (
                  <>
                    <button
                      onClick={saveEditedProject}
                      disabled={savingProject}
                      className="px-3 py-1 bg-green-500 rounded text-xs hover:bg-green-600 font-medium disabled:opacity-50"
                    >
                      {savingProject ? '...' : 'üíæ Save'}
                    </button>
                    <button
                      onClick={() => setEditingProject(false)}
                      className="px-3 py-1 bg-white bg-opacity-20 rounded text-xs hover:bg-opacity-30"
                    >
                      Cancel
                    </button>
                  </>
                )}
                <button onClick={() => { setViewingOrder(null); setProjectModalTab('details'); setEditingNotes(false); setEditingProject(false); setEditingModalDeadline(false); }} className="text-white hover:text-gray-200 text-xl">√ó</button>
              </div>
            </div>

            {/* Tabs */}
            <div className="flex border-b bg-gray-50">
              {['details', 'files', 'workflow'].map(tab => (
                <button
                  key={tab}
                  onClick={() => setProjectModalTab(tab)}
                  className={`px-4 py-2 text-sm font-medium transition-colors ${
                    projectModalTab === tab
                      ? 'text-blue-600 border-b-2 border-blue-600 bg-white'
                      : 'text-gray-500 hover:text-gray-700'
                  }`}
                >
                  {tab === 'details' ? 'Details' : tab === 'files' ? 'Files' : 'Workflow'}
                </button>
              ))}
            </div>

            {/* Tab Content */}
            <div className="p-4 overflow-y-auto flex-1">
              {/* Details Tab */}
              {projectModalTab === 'details' && (
                <div className="space-y-4">
                  {editingProject ? (
                    /* EDIT MODE - Editable form */
                    <>
                      {/* Client Section - Editable */}
                      <div>
                        <h4 className="text-sm font-bold text-blue-600 mb-2">üë§ Client</h4>
                        <div className="grid grid-cols-2 gap-3">
                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">Name</label>
                            <input
                              type="text"
                              value={editFormData.client_name || ''}
                              onChange={(e) => setEditFormData(prev => ({ ...prev, client_name: e.target.value }))}
                              className="w-full px-2 py-1.5 border rounded text-sm"
                            />
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">Email</label>
                            <input
                              type="email"
                              value={editFormData.client_email || ''}
                              onChange={(e) => setEditFormData(prev => ({ ...prev, client_email: e.target.value }))}
                              className="w-full px-2 py-1.5 border rounded text-sm"
                            />
                          </div>
                        </div>
                      </div>

                      {/* Requirements Section - Editable */}
                      <div>
                        <h4 className="text-sm font-bold text-blue-600 mb-2">üìã Requirements</h4>
                        <div className="grid grid-cols-2 gap-3">
                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">From Language</label>
                            <select
                              value={editFormData.translate_from || 'Portuguese'}
                              onChange={(e) => setEditFormData(prev => ({ ...prev, translate_from: e.target.value }))}
                              className="w-full px-2 py-1.5 border rounded text-sm"
                            >
                              {['Portuguese', 'English', 'Spanish', 'French', 'German', 'Italian', 'Chinese', 'Japanese', 'Korean', 'Russian', 'Arabic', 'Dutch', 'Norwegian', 'Swedish', 'Danish'].map(lang => (
                                <option key={lang} value={lang}>{lang}</option>
                              ))}
                            </select>
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">To Language</label>
                            <select
                              value={editFormData.translate_to || 'English'}
                              onChange={(e) => setEditFormData(prev => ({ ...prev, translate_to: e.target.value }))}
                              className="w-full px-2 py-1.5 border rounded text-sm"
                            >
                              {['English', 'Portuguese', 'Spanish', 'French', 'German', 'Italian', 'Chinese', 'Japanese', 'Korean', 'Russian', 'Arabic', 'Dutch', 'Norwegian', 'Swedish', 'Danish'].map(lang => (
                                <option key={lang} value={lang}>{lang}</option>
                              ))}
                            </select>
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">Service Type</label>
                            <select
                              value={editFormData.service_type || 'certified'}
                              onChange={(e) => setEditFormData(prev => ({ ...prev, service_type: e.target.value }))}
                              className="w-full px-2 py-1.5 border rounded text-sm"
                            >
                              <option value="certified">Certified</option>
                              <option value="standard">Standard</option>
                              <option value="rmv">RMV</option>
                              <option value="sworn">Sworn Translation</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">Pages</label>
                            <input
                              type="number"
                              min="1"
                              value={editFormData.page_count || 1}
                              onChange={(e) => setEditFormData(prev => ({ ...prev, page_count: parseInt(e.target.value) || 1 }))}
                              className="w-full px-2 py-1.5 border rounded text-sm"
                            />
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">Urgency</label>
                            <select
                              value={editFormData.urgency || 'no'}
                              onChange={(e) => setEditFormData(prev => ({ ...prev, urgency: e.target.value }))}
                              className="w-full px-2 py-1.5 border rounded text-sm"
                            >
                              <option value="no">Normal</option>
                              <option value="priority">Priority</option>
                              <option value="urgent">Urgent</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">Document Type</label>
                            <input
                              type="text"
                              value={editFormData.document_type || ''}
                              onChange={(e) => setEditFormData(prev => ({ ...prev, document_type: e.target.value }))}
                              placeholder="Birth Certificate, Diploma..."
                              className="w-full px-2 py-1.5 border rounded text-sm"
                            />
                          </div>
                          <div className="col-span-2">
                            <label className="block text-xs font-medium text-gray-600 mb-1">Deadline</label>
                            <input
                              type="datetime-local"
                              value={editFormData.deadline || ''}
                              onChange={(e) => setEditFormData(prev => ({ ...prev, deadline: e.target.value }))}
                              className="w-full px-2 py-1.5 border rounded text-sm"
                            />
                          </div>
                        </div>
                      </div>

                      {/* Financial Section - Editable */}
                      <div>
                        <h4 className="text-sm font-bold text-blue-600 mb-2">üí∞ Financial</h4>
                        <div className="grid grid-cols-2 gap-3">
                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">Total Price ($)</label>
                            <input
                              type="number"
                              min="0"
                              step="0.01"
                              value={editFormData.total_price || 0}
                              onChange={(e) => setEditFormData(prev => ({ ...prev, total_price: parseFloat(e.target.value) || 0 }))}
                              className="w-full px-2 py-1.5 border rounded text-sm"
                            />
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">Payment Status</label>
                            <select
                              value={editFormData.payment_status || 'pending'}
                              onChange={(e) => setEditFormData(prev => ({ ...prev, payment_status: e.target.value }))}
                              className="w-full px-2 py-1.5 border rounded text-sm"
                            >
                              <option value="pending">Pending</option>
                              <option value="paid">Paid</option>
                              <option value="partial">Partial</option>
                              <option value="refunded">Refunded</option>
                            </select>
                          </div>
                        </div>
                      </div>

                      {/* Status Section - Editable */}
                      <div>
                        <h4 className="text-sm font-bold text-blue-600 mb-2">üìä Status</h4>
                        <div>
                          <label className="block text-xs font-medium text-gray-600 mb-1">Translation Status</label>
                          <select
                            value={editFormData.translation_status || 'received'}
                            onChange={(e) => setEditFormData(prev => ({ ...prev, translation_status: e.target.value }))}
                            className="w-full px-2 py-1.5 border rounded text-sm"
                          >
                            <option value="received">Received</option>
                            <option value="quote">Quote</option>
                            <option value="in_translation">In Translation</option>
                            <option value="review">Review</option>
                            <option value="pending_review">Pending Review</option>
                            <option value="client_review">Client Review</option>
                            <option value="ready">Ready</option>
                            <option value="delivered">Delivered</option>
                          </select>
                        </div>
                      </div>

                      {/* Notes Section - Editable */}
                      <div>
                        <h4 className="text-sm font-bold text-blue-600 mb-2">üìù Notes</h4>
                        <div className="space-y-3">
                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">Client Notes</label>
                            <textarea
                              value={editFormData.notes || ''}
                              onChange={(e) => setEditFormData(prev => ({ ...prev, notes: e.target.value }))}
                              className="w-full px-2 py-1.5 border rounded text-sm"
                              rows="2"
                              placeholder="Notes visible to client..."
                            />
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">Internal Notes (Admin only)</label>
                            <textarea
                              value={editFormData.internal_notes || ''}
                              onChange={(e) => setEditFormData(prev => ({ ...prev, internal_notes: e.target.value }))}
                              className="w-full px-2 py-1.5 border rounded text-sm"
                              rows="2"
                              placeholder="Internal notes..."
                            />
                          </div>
                        </div>
                      </div>
                    </>
                  ) : (
                    /* VIEW MODE - Read only */
                    <>
                      {/* Client Section */}
                      <div>
                        <h4 className="text-sm font-bold text-blue-600 mb-2">Client</h4>
                        <table className="w-full text-xs">
                          <tbody>
                            <tr className="border-b">
                              <td className="py-2 font-medium text-gray-600 w-1/3">Client</td>
                              <td className="py-2 text-blue-600">{viewingOrder.client_name}</td>
                            </tr>
                            <tr className="border-b">
                              <td className="py-2 font-medium text-gray-600">Email</td>
                              <td className="py-2">{viewingOrder.client_email}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>

                      {/* Requirements Section */}
                      <div>
                        <h4 className="text-sm font-bold text-blue-600 mb-2">Requirements</h4>
                        <table className="w-full text-xs">
                          <tbody>
                            <tr className="border-b">
                              <td className="py-2 font-medium text-gray-600 w-1/3">Language Pair</td>
                              <td className="py-2">{viewingOrder.translate_from} ‚Üí {viewingOrder.translate_to}</td>
                            </tr>
                            <tr className="border-b">
                              <td className="py-2 font-medium text-gray-600">Service Type</td>
                              <td className="py-2 capitalize">{viewingOrder.service_type || 'Standard'}</td>
                            </tr>
                            <tr className="border-b">
                              <td className="py-2 font-medium text-gray-600">Pages</td>
                              <td className="py-2">{viewingOrder.page_count || 1}</td>
                            </tr>
                            <tr className="border-b">
                              <td className="py-2 font-medium text-gray-600">Urgency</td>
                              <td className="py-2">
                                <span className={`px-2 py-0.5 rounded text-[10px] ${viewingOrder.urgency === 'urgent' ? 'bg-red-100 text-red-700' : viewingOrder.urgency === 'priority' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'}`}>
                                  {viewingOrder.urgency === 'no' ? 'Normal' : viewingOrder.urgency || 'Normal'}
                                </span>
                              </td>
                            </tr>
                            <tr className="border-b">
                              <td className="py-2 font-medium text-gray-600">Created</td>
                              <td className="py-2">{formatDateTimeLocal(viewingOrder.created_at)}</td>
                            </tr>
                            <tr className="border-b">
                              <td className="py-2 font-medium text-gray-600">Deadline</td>
                              <td className="py-2">
                                {editingModalDeadline ? (
                                  <div className="flex flex-col gap-2">
                                    <div className="flex gap-2">
                                      <input
                                        type="date"
                                        value={tempModalDeadline.date}
                                        onChange={(e) => setTempModalDeadline(prev => ({ ...prev, date: e.target.value }))}
                                        className="px-2 py-1 border rounded text-xs"
                                      />
                                      <input
                                        type="time"
                                        value={tempModalDeadline.time}
                                        onChange={(e) => setTempModalDeadline(prev => ({ ...prev, time: e.target.value }))}
                                        className="px-2 py-1 border rounded text-xs"
                                      />
                                    </div>
                                    <div className="flex gap-1">
                                      <button
                                        onClick={saveModalDeadline}
                                        className="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600"
                                      >
                                        ‚úì Save
                                      </button>
                                      <button
                                        onClick={() => setEditingModalDeadline(false)}
                                        className="px-2 py-1 bg-gray-300 text-gray-700 rounded text-xs hover:bg-gray-400"
                                      >
                                        ‚úï Cancel
                                      </button>
                                    </div>
                                  </div>
                                ) : (
                                  <div className="flex items-center gap-2">
                                    {viewingOrder.deadline ? (
                                      <span className="text-blue-600 font-medium">
                                        {formatDateTimeLocal(viewingOrder.deadline)}
                                      </span>
                                    ) : (
                                      <span className="text-gray-400">Not set</span>
                                    )}
                                    {(isAdmin || isPM) && (
                                      <button
                                        onClick={() => {
                                          const deadline = viewingOrder.deadline ? new Date(viewingOrder.deadline) : null;
                                          setTempModalDeadline({
                                            date: deadline ? deadline.toISOString().split('T')[0] : '',
                                            time: deadline ? deadline.toTimeString().slice(0, 5) : '17:00'
                                          });
                                          setEditingModalDeadline(true);
                                        }}
                                        className="px-2 py-0.5 bg-blue-100 text-blue-600 rounded text-[10px] hover:bg-blue-200"
                                      >
                                        ‚úèÔ∏è {viewingOrder.deadline ? 'Edit' : 'Set Deadline'}
                                      </button>
                                    )}
                                  </div>
                                )}
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>

                      {/* Financial Section - Admin only (PMs cannot see prices) */}
                      {isAdmin && (
                        <div>
                          <h4 className="text-sm font-bold text-blue-600 mb-2">üí∞ Financial</h4>
                          <table className="w-full text-xs">
                            <tbody>
                              <tr className="border-b">
                                <td className="py-2 font-medium text-gray-600 w-1/3">Total Price</td>
                                <td className="py-2">
                                  <span className="text-green-600 font-bold">
                                    ${(viewingOrder.total_price || 0).toFixed(2)}
                                  </span>
                                </td>
                              </tr>
                              <tr className="border-b">
                                <td className="py-2 font-medium text-gray-600">Payment Status</td>
                                <td className="py-2">
                                  <span className={`px-2 py-0.5 rounded text-[10px] ${
                                    viewingOrder.payment_status === 'paid' ? 'bg-green-100 text-green-700' :
                                    viewingOrder.payment_status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                                    'bg-gray-100 text-gray-700'
                                  }`}>
                                    {viewingOrder.payment_status || 'Pending'}
                                  </span>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      )}

                      {/* Notes Section */}
                      <div>
                        <h4 className="text-sm font-bold text-blue-600 mb-2">Notes</h4>
                        {editingNotes ? (
                      <div className="space-y-3">
                        <div>
                          <label className="block text-xs font-medium text-gray-600 mb-1">üí¨ Client Note</label>
                          <textarea
                            value={tempNotes.client}
                            onChange={(e) => setTempNotes(prev => ({ ...prev, client: e.target.value }))}
                            className="w-full px-2 py-1.5 border rounded text-xs"
                            rows="2"
                            placeholder="Notes visible to client..."
                          />
                        </div>
                        <div>
                          <label className="block text-xs font-medium text-gray-600 mb-1">üìù Internal Note (Admin/PM only)</label>
                          <textarea
                            value={tempNotes.internal}
                            onChange={(e) => setTempNotes(prev => ({ ...prev, internal: e.target.value }))}
                            className="w-full px-2 py-1.5 border rounded text-xs"
                            rows="2"
                            placeholder="Internal notes..."
                          />
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={() => updateOrderNotes(viewingOrder.id, tempNotes.client, tempNotes.internal)}
                            className="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700"
                          >
                            Save Notes
                          </button>
                          <button
                            onClick={() => setEditingNotes(false)}
                            className="px-3 py-1 bg-gray-200 text-gray-700 rounded text-xs hover:bg-gray-300"
                          >
                            Cancel
                          </button>
                        </div>
                      </div>
                    ) : (
                      <div className="space-y-2">
                        {viewingOrder.notes ? (
                          <div className="p-2 bg-blue-50 rounded border border-blue-200">
                            <div className="text-[10px] font-medium text-blue-600 mb-1">üí¨ Client Note:</div>
                            <p className="text-xs text-gray-700">{viewingOrder.notes}</p>
                          </div>
                        ) : (
                          <div className="p-2 bg-gray-50 rounded border text-xs text-gray-400">No client notes</div>
                        )}
                        {(isAdmin || isPM) && (
                          viewingOrder.internal_notes ? (
                            <div className="p-2 bg-yellow-50 rounded border border-yellow-200">
                              <div className="text-[10px] font-medium text-yellow-600 mb-1">üìù Internal Note:</div>
                              <p className="text-xs text-gray-700">{viewingOrder.internal_notes}</p>
                            </div>
                          ) : (
                            <div className="p-2 bg-gray-50 rounded border text-xs text-gray-400">No internal notes</div>
                          )
                        )}
                      </div>
                    )}
                  </div>

                  {/* Assignment Section */}
                  <div>
                    <h4 className="text-sm font-bold text-blue-600 mb-2">Assignment</h4>
                    <table className="w-full text-xs">
                      <tbody>
                        <tr className="border-b">
                          <td className="py-2 font-medium text-gray-600 w-1/3">Project Manager</td>
                          <td className="py-2">{viewingOrder.assigned_pm_name || viewingOrder.assigned_pm || '-'}</td>
                        </tr>
                        <tr className="border-b">
                          <td className="py-2 font-medium text-gray-600">Translator</td>
                          <td className="py-2">
                            {viewingOrder.assigned_translator_name || viewingOrder.assigned_translator || '-'}
                            {viewingOrder.translator_assignment_status && (
                              <span
                                onClick={() => {
                                  if (isAdmin || isPM) {
                                    const newStatus = viewingOrder.translator_assignment_status === 'accepted' ? 'pending' : 'accepted';
                                    if (confirm(`Change translator status to "${newStatus}"?`)) {
                                      updateTranslatorAssignmentStatus(viewingOrder.id, newStatus);
                                      setViewingOrder(prev => ({ ...prev, translator_assignment_status: newStatus }));
                                    }
                                  }
                                }}
                                className={`ml-2 px-1.5 py-0.5 rounded text-[10px] ${
                                  viewingOrder.translator_assignment_status === 'accepted' ? 'bg-green-100 text-green-700' :
                                  viewingOrder.translator_assignment_status === 'declined' ? 'bg-red-100 text-red-700' :
                                  'bg-yellow-100 text-yellow-700'
                                } ${(isAdmin || isPM) ? 'cursor-pointer hover:opacity-80' : ''}`}
                                title={(isAdmin || isPM) ? "Click to change status" : ""}
                              >
                                {viewingOrder.translator_assignment_status}
                              </span>
                            )}
                          </td>
                        </tr>
                        <tr className="border-b">
                          <td className="py-2 font-medium text-gray-600">Status</td>
                          <td className="py-2">
                            <span className={`px-2 py-0.5 rounded text-[10px] ${STATUS_COLORS[viewingOrder.translation_status] || 'bg-gray-100'}`}>
                              {viewingOrder.translation_status}
                            </span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  {/* Financial Section - Admin only */}
                  {isAdmin && (
                    <div>
                      <h4 className="text-sm font-bold text-blue-600 mb-2">Financial</h4>
                      <table className="w-full text-xs">
                        <tbody>
                          <tr className="border-b">
                            <td className="py-2 font-medium text-gray-600 w-1/3">Total Price</td>
                            <td className="py-2 font-bold text-green-600">${viewingOrder.total_price?.toFixed(2) || '0.00'}</td>
                          </tr>
                          <tr className="border-b">
                            <td className="py-2 font-medium text-gray-600">Payment Status</td>
                            <td className="py-2">
                              <span className={`px-2 py-0.5 rounded text-[10px] ${PAYMENT_COLORS[viewingOrder.payment_status] || 'bg-gray-100'}`}>
                                {viewingOrder.payment_status || 'pending'}
                              </span>
                            </td>
                          </tr>
                          <tr className="border-b">
                            <td className="py-2 font-medium text-gray-600">Payment Method</td>
                            <td className="py-2 capitalize">{viewingOrder.payment_method || '-'}</td>
                          </tr>
                        </tbody>
                      </table>

                      {/* QuickBooks Invoice/Receipt Buttons */}
                      {qbConnected && (
                        <div className="mt-3 p-3 bg-gray-50 rounded-lg border">
                          <div className="flex items-center justify-between">
                            <div className="text-xs">
                              <span className="font-medium text-gray-700">QuickBooks:</span>
                              {viewingOrder.quickbooks_invoice_id ? (
                                <span className="ml-2 text-green-600">
                                  ‚úì {viewingOrder.quickbooks_receipt_type === 'sales_receipt' ? 'Receipt' : 'Invoice'} #{viewingOrder.quickbooks_invoice_number}
                                </span>
                              ) : (
                                <span className="ml-2 text-gray-500">Not synced</span>
                              )}
                            </div>
                            {!viewingOrder.quickbooks_invoice_id && (
                              <div className="flex gap-2">
                                {viewingOrder.payment_status === 'paid' ? (
                                  <button
                                    onClick={() => syncOrderToQuickBooks(viewingOrder)}
                                    disabled={qbSyncing[viewingOrder.id]}
                                    className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 disabled:bg-gray-300"
                                  >
                                    {qbSyncing[viewingOrder.id] ? 'Sending...' : 'üßæ Send Receipt'}
                                  </button>
                                ) : (
                                  <button
                                    onClick={() => {
                                      // For unpaid orders, send Invoice (not Receipt)
                                      setQbSyncing(prev => ({ ...prev, [viewingOrder.id]: true }));
                                      axios.post(`${API}/quickbooks/sync/invoice?admin_key=${adminKey}`, {
                                        order_id: viewingOrder.id,
                                        customer_name: viewingOrder.partner_company || viewingOrder.client_name,
                                        customer_email: viewingOrder.partner_email || viewingOrder.client_email,
                                        send_email: true
                                      }).then(response => {
                                        if (response.data.success) {
                                          showToast(`Invoice #${response.data.invoice_number} sent!`);
                                          fetchOrders();
                                          setViewingOrder(prev => ({
                                            ...prev,
                                            quickbooks_invoice_id: response.data.invoice_id,
                                            quickbooks_invoice_number: response.data.invoice_number
                                          }));
                                        }
                                      }).catch(err => {
                                        showToast('Failed: ' + (err.response?.data?.detail || err.message));
                                      }).finally(() => {
                                        setQbSyncing(prev => ({ ...prev, [viewingOrder.id]: false }));
                                      });
                                    }}
                                    disabled={qbSyncing[viewingOrder.id]}
                                    className="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:bg-gray-300"
                                  >
                                    {qbSyncing[viewingOrder.id] ? 'Sending...' : 'üìÑ Send Invoice'}
                                  </button>
                                )}
                              </div>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                    </>
                  )}
                </div>
              )}

              {/* Files Tab */}
              {projectModalTab === 'files' && (
                <div className="space-y-4">
                  {/* Upload Section - Admin/PM only */}
                  {(isAdmin || isPM) && (
                    <div className="p-3 bg-blue-50 rounded-lg border border-blue-200">
                      <div className="text-xs font-medium text-blue-700 mb-2">üì§ Upload Documents (Multiple Files Allowed)</div>
                      <div className="flex items-center gap-2">
                        <input
                          type="file"
                          id="project-doc-upload"
                          multiple
                          accept="*/*"
                          onChange={(e) => uploadDocumentsToOrder(viewingOrder.id, Array.from(e.target.files))}
                          className="hidden"
                        />
                        <label
                          htmlFor="project-doc-upload"
                          className={`px-3 py-1.5 rounded text-xs cursor-pointer ${uploadingProjectDoc ? 'bg-gray-300 text-gray-500' : 'bg-blue-600 text-white hover:bg-blue-700'}`}
                        >
                          {uploadingProjectDoc ? 'Uploading...' : 'Choose Files'}
                        </label>
                        <span className="text-[10px] text-gray-500">All formats accepted ‚Ä¢ Max 100MB per file ‚Ä¢ Multiple files allowed</span>
                      </div>
                    </div>
                  )}

                  {/* Original Documents Section */}
                  <div>
                    <div className="text-xs font-medium text-gray-600 mb-2">üìÅ Original Documents</div>
                    {loadingDocuments ? (
                      <div className="text-center py-4 text-gray-500 text-xs">Loading documents...</div>
                    ) : orderDocuments.filter(doc => doc.source !== 'translated_document').length > 0 ? (
                      <div className="space-y-2">
                        {orderDocuments.filter(doc => doc.source !== 'translated_document').map((doc, idx) => (
                          <div key={doc.id || idx} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border hover:bg-gray-100">
                            <div className="flex items-center">
                              <span className="text-2xl mr-3">
                                {doc.filename?.endsWith('.pdf') ? 'üìï' : doc.filename?.match(/\.(jpg|jpeg|png)$/i) ? 'üñºÔ∏è' : 'üìÑ'}
                              </span>
                              <div>
                                <div className="text-sm font-medium">{doc.filename || 'Document'}</div>
                                <div className="text-[10px] text-gray-500">
                                  {doc.source === 'manual_upload' ? 'Manual upload' : 'Partner portal'}
                                  {doc.uploaded_at && ` ‚Ä¢ ${new Date(doc.uploaded_at).toLocaleDateString('en-US', { timeZone: 'America/New_York' })}`}
                                </div>
                              </div>
                            </div>
                            <div className="flex items-center gap-2">
                              <button
                                onClick={() => downloadDocument(doc.id, doc.filename)}
                                className="px-3 py-1.5 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 flex items-center gap-1"
                              >
                                <span>‚¨áÔ∏è</span> Download
                              </button>
                              {(isAdmin || isPM) && (
                                <button
                                  onClick={() => deleteOrderDocument(doc.id, doc.filename)}
                                  className="px-2 py-1.5 bg-red-500 text-white rounded text-xs hover:bg-red-600"
                                  title="Excluir documento"
                                >
                                  üóëÔ∏è
                                </button>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className="text-center py-4 text-gray-400">
                        <div className="text-2xl mb-1">üì≠</div>
                        <div className="text-xs">No original documents</div>
                        {viewingOrder.document_filename && (
                          <div className="mt-1 text-[10px] text-gray-500">
                            Registered file: {viewingOrder.document_filename}
                          </div>
                        )}
                      </div>
                    )}
                  </div>

                  {/* Translated Documents Section */}
                  <div className="mt-4 pt-4 border-t">
                    <div className="flex items-center justify-between mb-2">
                      <div className="text-xs font-medium text-green-700">üìó Translated Documents</div>
                      {/* Upload Translated Document Button */}
                      {(isAdmin || isPM) && (
                        <label className="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs rounded cursor-pointer transition-colors flex items-center gap-1">
                          ‚¨ÜÔ∏è Upload Translation
                          <input
                            type="file"
                            className="hidden"
                            accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                            multiple
                            onChange={async (e) => {
                              if (e.target.files && e.target.files.length > 0) {
                                for (const file of e.target.files) {
                                  try {
                                    const reader = new FileReader();
                                    const base64Promise = new Promise((resolve, reject) => {
                                      reader.onload = () => resolve(reader.result.split(',')[1]);
                                      reader.onerror = reject;
                                    });
                                    reader.readAsDataURL(file);
                                    const base64Data = await base64Promise;

                                    await axios.post(`${API}/admin/orders/${viewingOrder.id}/documents?admin_key=${adminKey}`, {
                                      filename: file.name,
                                      file_data: base64Data,
                                      content_type: file.type || 'application/octet-stream',
                                      source: 'translated_document'
                                    });
                                  } catch (err) {
                                    console.error('Failed to upload translation:', err);
                                    showToast(`Error uploading ${file.name}`);
                                  }
                                }
                                showToast('Translation(s) uploaded successfully!');
                                viewOrderDocuments(viewingOrder);
                              }
                              e.target.value = '';
                            }}
                          />
                        </label>
                      )}
                    </div>
                    {orderDocuments.filter(doc => doc.source === 'translated_document').length > 0 ? (
                      <div className="space-y-2">
                        {orderDocuments.filter(doc => doc.source === 'translated_document').map((doc, idx) => (
                          <div key={doc.id || idx} className="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200 hover:bg-green-100">
                            <div className="flex items-center">
                              {/* Checkbox for selecting files to send to client */}
                              {(viewingOrder.translation_status === 'ready' || viewingOrder.translation_status === 'final') && (
                                <input
                                  type="checkbox"
                                  checked={selectedDocsForDelivery.includes(doc.id)}
                                  onChange={(e) => {
                                    if (e.target.checked) {
                                      setSelectedDocsForDelivery(prev => [...prev, doc.id]);
                                    } else {
                                      setSelectedDocsForDelivery(prev => prev.filter(id => id !== doc.id));
                                    }
                                  }}
                                  className="w-4 h-4 mr-3 text-purple-600 bg-white border-gray-300 rounded focus:ring-purple-500 cursor-pointer"
                                  title="Selecionar para enviar ao cliente"
                                />
                              )}
                              <span className="text-2xl mr-3">üìó</span>
                              <div>
                                <div className="text-sm font-medium text-green-800">{doc.filename || 'Translated Document'}</div>
                                <div className="text-[10px] text-green-600">
                                  Approved translation
                                  {doc.uploaded_at && ` ‚Ä¢ ${new Date(doc.uploaded_at).toLocaleDateString('en-US', { timeZone: 'America/New_York' })}`}
                                </div>
                              </div>
                            </div>
                            <div className="flex gap-1">
                              <button
                                onClick={() => downloadDocument(doc.id, doc.filename)}
                                className="px-2 py-1.5 bg-green-600 text-white rounded text-xs hover:bg-green-700 flex items-center gap-1"
                              >
                                ‚¨áÔ∏è
                              </button>
                              {(isAdmin || isPM) && (
                                <button
                                  onClick={() => deleteOrderDocument(doc.id, doc.filename)}
                                  className="px-2 py-1.5 bg-red-500 text-white rounded text-xs hover:bg-red-600"
                                  title="Delete translation"
                                >
                                  üóëÔ∏è
                                </button>
                              )}
                            </div>
                          </div>
                        ))}

                        {/* Action Buttons when translations exist */}
                        {(isAdmin || isPM) && (
                          <div className="mt-3 pt-3 border-t border-green-200">
                            {/* Accept Translation Button - shows when not yet ready */}
                            {viewingOrder.translation_status !== 'ready' && viewingOrder.translation_status !== 'delivered' && viewingOrder.translation_status !== 'final' && (
                              <div className="flex flex-col gap-2">
                                <button
                                  onClick={async () => {
                                    if (confirm('Aceitar esta tradu√ß√£o e marcar como pronta para envio?')) {
                                      try {
                                        await axios.put(`${API}/admin/orders/${viewingOrder.id}?admin_key=${adminKey}`, {
                                          translation_status: 'ready',
                                          translation_ready_at: new Date().toISOString()
                                        });
                                        showToast('Tradu√ß√£o aceita! Agora voc√™ pode enviar para o cliente.');
                                        setViewingOrder(prev => ({ ...prev, translation_status: 'ready' }));
                                        fetchOrders();
                                      } catch (err) {
                                        console.error('Failed to update status:', err);
                                        showToast('Erro ao atualizar status');
                                      }
                                    }
                                  }}
                                  className="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg flex items-center justify-center gap-2 transition-colors"
                                >
                                  ‚úÖ Aceitar Tradu√ß√£o
                                </button>
                                <p className="text-[10px] text-gray-500 text-center">
                                  Ap√≥s aceitar, voc√™ poder√° enviar o email ao cliente com a tradu√ß√£o
                                </p>
                              </div>
                            )}

                            {/* Send Email Section - shows after translation is accepted */}
                            {(viewingOrder.translation_status === 'ready' || viewingOrder.translation_status === 'final') && (
                              <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                <div className="flex items-center gap-2 mb-2">
                                  <span className="text-2xl">üìß</span>
                                  <div>
                                    <div className="text-sm font-medium text-purple-800">Tradu√ß√£o Aceita!</div>
                                    <div className="text-[10px] text-purple-600">Pronto para enviar ao cliente</div>
                                  </div>
                                </div>
                                <div className="flex flex-col gap-2">
                                  {/* Show selected files count with select all/none buttons */}
                                  <div className="flex items-center justify-between text-xs text-purple-700 bg-purple-100 px-2 py-1 rounded">
                                    <span>
                                      {selectedDocsForDelivery.length > 0 ? (
                                        <span>{selectedDocsForDelivery.length} arquivo(s) selecionado(s) para envio</span>
                                      ) : (
                                        <span className="text-orange-600">Selecione os arquivos acima para enviar</span>
                                      )}
                                    </span>
                                    <div className="flex gap-1">
                                      <button
                                        onClick={() => {
                                          const translatedDocIds = orderDocuments.filter(d => d.source === 'translated_document').map(d => d.id);
                                          setSelectedDocsForDelivery(translatedDocIds);
                                        }}
                                        className="px-2 py-0.5 text-[10px] bg-purple-200 hover:bg-purple-300 rounded"
                                      >
                                        Todos
                                      </button>
                                      <button
                                        onClick={() => setSelectedDocsForDelivery([])}
                                        className="px-2 py-0.5 text-[10px] bg-purple-200 hover:bg-purple-300 rounded"
                                      >
                                        Nenhum
                                      </button>
                                    </div>
                                  </div>
                                  <div className="flex items-center gap-2">
                                    <input
                                      type="email"
                                      placeholder="BCC email (opcional)"
                                      id="bcc-email-input"
                                      className="flex-1 px-2 py-1.5 border border-purple-200 rounded text-xs focus:ring-2 focus:ring-purple-400 focus:outline-none"
                                    />
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (selectedDocsForDelivery.length === 0) {
                                        showToast('Por favor, selecione pelo menos um arquivo para enviar ao cliente.');
                                        return;
                                      }
                                      const bccInput = document.getElementById('bcc-email-input');
                                      const bccEmail = bccInput?.value?.trim() || null;
                                      const selectedFilenames = orderDocuments
                                        .filter(d => selectedDocsForDelivery.includes(d.id))
                                        .map(d => d.filename)
                                        .join('\n  - ');

                                      if (confirm(`Enviar tradu√ß√£o para ${viewingOrder.client_email}?\n\nArquivos selecionados:\n  - ${selectedFilenames}${bccEmail ? `\n\nC√≥pia (BCC): ${bccEmail}` : ''}`)) {
                                        try {
                                          await axios.post(`${API}/admin/orders/${viewingOrder.id}/deliver?admin_key=${adminKey}`, {
                                            bcc_email: bccEmail,
                                            include_verification_page: true,
                                            certifier_name: 'Beatriz Paiva',
                                            generate_combined_pdf: true,
                                            include_certificate: true,
                                            include_translation: true,
                                            include_original: true,
                                            attachments: {
                                              include_workspace: false,
                                              additional_document_ids: selectedDocsForDelivery
                                            }
                                          });
                                          showToast(`Tradu√ß√£o enviada para o cliente!\n\n${selectedDocsForDelivery.length} arquivo(s) enviado(s).` + (bccEmail ? `\n\nC√≥pia (BCC): ${bccEmail}` : ''));
                                          setViewingOrder(prev => ({ ...prev, translation_status: 'delivered' }));
                                          fetchOrders();
                                        } catch (err) {
                                          console.error('Failed to deliver:', err);
                                          showToast('Erro ao enviar para o cliente');
                                        }
                                      }
                                    }}
                                    disabled={selectedDocsForDelivery.length === 0}
                                    className={`w-full px-4 py-3 text-white text-sm font-medium rounded-lg flex items-center justify-center gap-2 transition-colors ${
                                      selectedDocsForDelivery.length === 0
                                        ? 'bg-gray-400 cursor-not-allowed'
                                        : 'bg-purple-600 hover:bg-purple-700'
                                    }`}
                                  >
                                    <span className="text-lg">‚úâÔ∏è</span>
                                    Enviar Email ao Cliente
                                  </button>
                                  <div className="text-[10px] text-purple-600 text-center">
                                    Ser√° enviado para: <strong>{viewingOrder.client_email}</strong>
                                  </div>
                                </div>
                              </div>
                            )}

                            {/* Delivered Status */}
                            {viewingOrder.translation_status === 'delivered' && (
                              <div className="bg-gray-50 border border-gray-200 rounded-lg p-3 flex items-center gap-2">
                                <span className="text-2xl">‚úÖ</span>
                                <div>
                                  <div className="text-sm font-medium text-gray-700">Entregue ao Cliente</div>
                                  <div className="text-[10px] text-gray-500">Tradu√ß√£o enviada com sucesso</div>
                                </div>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    ) : (
                      <div className="text-center py-4 text-gray-400">
                        <div className="text-2xl mb-1">üìù</div>
                        <div className="text-xs">No translations uploaded yet</div>
                        <div className="text-[10px] mt-1 text-gray-400">Use "Upload Translation" button above to add completed translations</div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Workflow Tab */}
              {projectModalTab === 'workflow' && (
                <div className="space-y-4">
                  <div className="text-xs font-medium text-gray-600 mb-3">Project Workflow Status</div>

                  {/* Workflow Steps */}
                  <div className="space-y-3">
                    {[
                      { status: 'received', label: 'Received', icon: 'üì•', desc: 'Project received and awaiting assignment' },
                      { status: 'in_translation', label: 'In Translation', icon: '‚úçÔ∏è', desc: 'Translator is working on the document' },
                      { status: 'review', label: 'PM Review', icon: 'üîç', desc: 'Project Manager reviewing translation' },
                      { status: 'client_review', label: 'Client Review', icon: 'üë§', desc: 'Client reviewing the translation' },
                      { status: 'ready', label: 'Ready', icon: '‚úÖ', desc: 'Translation approved and ready for delivery' },
                      { status: 'delivered', label: 'Delivered', icon: 'üì§', desc: 'Sent to client' }
                    ].map((step, idx) => {
                      const currentIdx = ['received', 'in_translation', 'review', 'client_review', 'ready', 'delivered'].indexOf(viewingOrder.translation_status);
                      const stepIdx = idx;
                      const isCompleted = stepIdx < currentIdx;
                      const isCurrent = viewingOrder.translation_status === step.status;

                      return (
                        <div key={step.status} className={`flex items-start p-3 rounded-lg border ${isCurrent ? 'bg-blue-50 border-blue-300' : isCompleted ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
                          <div className={`w-8 h-8 rounded-full flex items-center justify-center mr-3 ${isCurrent ? 'bg-blue-600 text-white' : isCompleted ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'}`}>
                            {isCompleted ? '‚úì' : step.icon}
                          </div>
                          <div className="flex-1">
                            <div className={`text-sm font-medium ${isCurrent ? 'text-blue-700' : isCompleted ? 'text-green-700' : 'text-gray-500'}`}>
                              {step.label}
                              {isCurrent && <span className="ml-2 px-1.5 py-0.5 bg-blue-600 text-white rounded text-[10px]">Current</span>}
                            </div>
                            <div className="text-[10px] text-gray-500 mt-0.5">{step.desc}</div>
                          </div>
                        </div>
                      );
                    })}
                  </div>

                  {/* Translator Assignment Status */}
                  {(viewingOrder.assigned_translator_name || viewingOrder.assigned_translator) && (
                    <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                      <div className="text-xs font-medium text-blue-700 mb-2">Translator Assignment</div>
                      <div className="flex items-center justify-between">
                        <div>
                          <div className="text-sm">{viewingOrder.assigned_translator_name || viewingOrder.assigned_translator}</div>
                          <div className={`text-xs mt-1 ${
                            viewingOrder.translator_assignment_status === 'accepted' ? 'text-green-600' :
                            viewingOrder.translator_assignment_status === 'declined' ? 'text-red-600' :
                            'text-yellow-600'
                          }`}>
                            Status: {viewingOrder.translator_assignment_status || 'pending'}
                          </div>
                        </div>
                        {isAdmin && (viewingOrder.assigned_translator_id || viewingOrder.assigned_translator) && (
                          <button
                            onClick={() => {
                              // Find translator details - use ID if available, otherwise search by name
                              const translatorId = viewingOrder.assigned_translator_id;
                              const translator = translatorId
                                ? translators.find(t => t.id === translatorId)
                                : translators.find(t => t.name === viewingOrder.assigned_translator);
                              setMessagingTranslator({
                                id: translatorId || translator?.id || viewingOrder.assigned_translator,
                                name: viewingOrder.assigned_translator_name || translator?.name || viewingOrder.assigned_translator || 'Translator',
                                email: translator?.email || '',
                                order_number: viewingOrder.order_number
                              });
                            }}
                            className="px-3 py-1.5 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 flex items-center gap-1"
                          >
                            üí¨ Send Message
                          </button>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Delivery Info & Resend Option - Admin only */}
                  {viewingOrder.translation_status === 'delivered' && (
                    <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                      <div className="text-xs font-medium text-blue-700 mb-2">üì§ Delivery Information</div>
                      {viewingOrder.delivered_at && (
                        <div className="text-xs text-gray-600 mb-2">
                          Delivered: {formatDateTimeLocal(viewingOrder.delivered_at)}
                        </div>
                      )}
                      <div className="text-xs text-gray-600 mb-3">
                        Sent to: {viewingOrder.client_email}
                      </div>
                      {isAdmin && (
                        <button
                          onClick={() => {
                            setViewingOrder(null);
                            openSendToClientModal(viewingOrder);
                          }}
                          className="px-3 py-1.5 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 flex items-center gap-1"
                        >
                          üîÑ Resend Translation
                        </button>
                      )}
                    </div>
                  )}

                  {/* Translation Ready - option to send - Admin only */}
                  {viewingOrder.translation_ready && viewingOrder.translation_status !== 'delivered' && isAdmin && (
                    <div className="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                      <div className="text-xs font-medium text-green-700 mb-2">‚úÖ Translation Ready</div>
                      <div className="text-xs text-gray-600 mb-3">
                        {viewingOrder.translation_ready_at && (
                          <span>Completed: {formatDateTimeLocal(viewingOrder.translation_ready_at)}</span>
                        )}
                      </div>
                      <button
                        onClick={() => {
                          setViewingOrder(null);
                          openSendToClientModal(viewingOrder);
                        }}
                        className="px-3 py-1.5 bg-green-600 text-white rounded text-xs hover:bg-green-700 flex items-center gap-1"
                      >
                        üì§ Send to Client
                      </button>
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="p-3 border-t bg-gray-50 flex justify-end gap-2 rounded-b-lg">
              <button
                onClick={() => { setViewingOrder(null); setProjectModalTab('details'); setEditingNotes(false); setEditingModalDeadline(false); }}
                className="px-4 py-1.5 bg-gray-600 text-white rounded text-xs hover:bg-gray-700"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Send to Client Modal */}
      {sendingOrder && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[85vh] flex flex-col">
            <div className={`p-3 border-b flex justify-between items-center rounded-t-lg flex-shrink-0 ${
              sendingOrder.translation_status === 'delivered' ? 'bg-blue-600' : 'bg-blue-600'
            } text-white`}>
              <div>
                <h3 className="font-bold text-sm">
                  {sendingOrder.translation_status === 'delivered' ? 'üîÑ Resend Translation' : 'üì§ Send to Client'}
                </h3>
                <p className="text-[10px] opacity-80">{sendingOrder.order_number} - {sendingOrder.client_name}</p>
              </div>
              <button onClick={() => setSendingOrder(null)} className="text-white hover:text-gray-200 text-xl">√ó</button>
            </div>

            <div className="p-3 overflow-y-auto flex-1">
              {/* Resend notice for delivered orders */}
              {sendingOrder.translation_status === 'delivered' && (
                <div className="mb-3 p-2 bg-blue-50 border border-blue-200 rounded">
                  <div className="text-[10px] text-blue-700">
                    <strong>‚ÑπÔ∏è Resending:</strong> Delivered
                    {sendingOrder.delivered_at && ` on ${new Date(sendingOrder.delivered_at).toLocaleDateString('en-US', { timeZone: 'America/New_York' })}`}.
                    Upload new file below if needed.
                  </div>
                </div>
              )}

              {/* Client Info */}
              <div className="mb-3 p-2 bg-gray-50 rounded border">
                <div className="text-[10px] font-medium text-gray-600">Client:</div>
                <div className="text-xs font-medium">{sendingOrder.client_name}</div>
                <div className="text-[10px] text-gray-500">{sendingOrder.client_email}</div>
              </div>

              {/* Translated Document Status */}
              <div className="mb-3">
                <div className="text-[10px] font-medium text-gray-600 mb-1">üìÑ Translation to Attach:</div>
                {!translatedDocInfo ? (
                  <div className="text-center py-2 text-gray-500 text-[10px]">Loading...</div>
                ) : (
                  <div className="space-y-2">
                    {/* Workspace translation with checkbox */}
                    {translatedDocInfo.has_html_translation && (
                      <div className={`p-2 rounded border ${selectedAttachments.workspace ? 'bg-green-50 border-green-300' : 'bg-gray-50 border-gray-200'}`}>
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input
                            type="checkbox"
                            checked={selectedAttachments.workspace}
                            onChange={(e) => setSelectedAttachments(prev => ({ ...prev, workspace: e.target.checked }))}
                            className="w-4 h-4 text-green-600 rounded"
                          />
                          <div className="flex-1">
                            <div className="flex items-center justify-between">
                              <span className="text-[10px] text-green-800 font-medium">‚úÖ Workspace Translation</span>
                              <button
                                onClick={(e) => { e.preventDefault(); downloadTranslatedDocument(sendingOrder.id, 'translation.html'); }}
                                className="px-2 py-0.5 bg-green-600 text-white rounded text-[10px] hover:bg-green-700"
                              >
                                üëÅÔ∏è Preview
                              </button>
                            </div>
                            {translatedDocInfo.translation_settings && (
                              <div className="text-[9px] text-gray-600 mt-1">
                                üìù {translatedDocInfo.translation_settings.document_type || 'N/A'} ‚Ä¢
                                {translatedDocInfo.translation_settings.source_language} ‚Üí {translatedDocInfo.translation_settings.target_language}
                              </div>
                            )}
                          </div>
                        </label>
                      </div>
                    )}

                    {/* Additional attachments with checkboxes */}
                    {additionalAttachments.length > 0 && (
                      <div className="space-y-1">
                        {additionalAttachments.map((attachment) => (
                          <div
                            key={attachment.id}
                            className={`p-2 rounded border ${selectedAttachments.uploaded.includes(attachment.id) ? 'bg-blue-50 border-blue-300' : 'bg-gray-50 border-gray-200'}`}
                          >
                            <label className="flex items-center gap-2 cursor-pointer">
                              <input
                                type="checkbox"
                                checked={selectedAttachments.uploaded.includes(attachment.id)}
                                onChange={(e) => {
                                  if (e.target.checked) {
                                    setSelectedAttachments(prev => ({ ...prev, uploaded: [...prev.uploaded, attachment.id] }));
                                  } else {
                                    setSelectedAttachments(prev => ({ ...prev, uploaded: prev.uploaded.filter(id => id !== attachment.id) }));
                                  }
                                }}
                                className="w-4 h-4 text-blue-600 rounded"
                              />
                              <div className="flex-1 flex items-center justify-between">
                                <span className="text-[10px] text-blue-800 font-medium truncate">
                                  üìé File: {attachment.filename}
                                </span>
                                <button
                                  onClick={(e) => {
                                    e.preventDefault();
                                    setAdditionalAttachments(prev => prev.filter(a => a.id !== attachment.id));
                                    setSelectedAttachments(prev => ({ ...prev, uploaded: prev.uploaded.filter(id => id !== attachment.id) }));
                                  }}
                                  className="px-1.5 py-0.5 bg-red-100 text-red-600 rounded text-[9px] hover:bg-red-200"
                                  title="Remover"
                                >
                                  ‚úï
                                </button>
                              </div>
                            </label>
                          </div>
                        ))}
                      </div>
                    )}

                    {/* No attachments warning */}
                    {!translatedDocInfo.has_html_translation && additionalAttachments.length === 0 && (
                      <div className="p-2 bg-yellow-50 border border-yellow-200 rounded">
                        <div className="text-[10px] text-yellow-800">‚ö†Ô∏è No translation anexada</div>
                        <div className="text-[9px] text-yellow-600 mt-1">
                          Fa√ßa upload de files tabixo ou complete a translation no Workspace
                        </div>
                      </div>
                    )}

                    {/* Selection summary */}
                    {(translatedDocInfo.has_html_translation || additionalAttachments.length > 0) && (
                      <div className="p-1.5 bg-gray-100 rounded text-[9px] text-gray-600">
                        üìã {(selectedAttachments.workspace && translatedDocInfo.has_html_translation ? 1 : 0) + selectedAttachments.uploaded.length} file(s) selecionado(s) to envio
                      </div>
                    )}
                  </div>
                )}
              </div>

              {/* Upload new document - External translation (supports multiple) */}
              <div className="mb-3">
                <div className="text-[10px] font-medium text-gray-600 mb-1">üìé Upload External Translation:</div>
                <input
                  type="file"
                  id="translationFile"
                  accept=".pdf,.doc,.docx,.html"
                  multiple
                  className="hidden"
                  onChange={(e) => {
                    if (e.target.files && e.target.files.length > 0) {
                      uploadTranslatedDocument(sendingOrder.id, Array.from(e.target.files));
                    }
                  }}
                />
                <label
                  htmlFor="translationFile"
                  className={`block px-2 py-1.5 border-2 border-dashed rounded text-center cursor-pointer hover:bg-gray-50 text-[10px] ${uploadingFile ? 'opacity-50' : ''}`}
                >
                  {uploadingFile ? 'Sending...' : 'üìÅ Select file(s) (PDF, DOC, HTML)'}
                </label>
                <div className="text-[9px] text-gray-400 mt-1 text-center">
                  For translations done outside the system
                </div>
              </div>

              {/* Notify PM Option */}
              {sendingOrder?.assigned_pm_id && (
                <div className="mb-3 p-2 bg-blue-50 border border-blue-200 rounded">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input
                      type="checkbox"
                      checked={notifyPM}
                      onChange={(e) => setNotifyPM(e.target.checked)}
                      className="w-3 h-3 text-blue-600 rounded"
                    />
                    <span className="text-[10px] text-blue-700">
                      Notify PM ({sendingOrder.assigned_pm_name || 'Assigned'})
                    </span>
                  </label>
                </div>
              )}

              {/* BCC Field */}
              <div className="mb-2">
                <label className="text-[10px] font-medium text-gray-600 mb-1 block">üìß BCC:</label>
                <input
                  type="email"
                  value={sendBccEmail}
                  onChange={(e) => setSendBccEmail(e.target.value)}
                  placeholder="email@example.com (optional)"
                  className="w-full px-2 py-1 border rounded text-xs"
                />
              </div>

              {/* External Attachment for Resend - only for delivered orders */}
              {sendingOrder.translation_status === 'delivered' && (
                <div className="mb-2">
                  <div className="text-[10px] font-medium text-gray-600 mb-1">üìé Anexo Externo (Reenvio):</div>
                  <div className="text-[9px] text-gray-500 mb-1">
                    Anexar arquivo externo sem salvar no sistema
                  </div>
                  {!externalAttachment ? (
                    <>
                      <input
                        type="file"
                        id="externalAttachmentFile"
                        accept=".pdf,.doc,.docx,.html,.jpg,.jpeg,.png,.xlsx,.xls"
                        className="hidden"
                        onChange={(e) => {
                          const file = e.target.files?.[0];
                          if (file) {
                            const reader = new FileReader();
                            reader.onload = () => {
                              const base64 = reader.result.split(',')[1];
                              setExternalAttachment({
                                filename: file.name,
                                content_type: file.type || 'application/octet-stream',
                                data: base64
                              });
                            };
                            reader.readAsDataURL(file);
                          }
                        }}
                      />
                      <label
                        htmlFor="externalAttachmentFile"
                        className="block px-2 py-1.5 border-2 border-dashed border-purple-300 bg-purple-50 rounded text-center cursor-pointer hover:bg-purple-100 text-[10px] text-purple-700"
                      >
                        üìé Selecionar anexo externo
                      </label>
                    </>
                  ) : (
                    <div className="p-2 bg-purple-50 border border-purple-300 rounded flex items-center justify-between">
                      <div className="flex items-center gap-1">
                        <span className="text-[10px] text-purple-700">üìé</span>
                        <span className="text-[10px] text-purple-800 font-medium truncate max-w-[180px]">
                          {externalAttachment.filename}
                        </span>
                      </div>
                      <button
                        onClick={() => setExternalAttachment(null)}
                        className="px-1.5 py-0.5 bg-red-100 text-red-600 rounded text-[9px] hover:bg-red-200"
                        title="Remover"
                      >
                        ‚úï
                      </button>
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Footer - always visible */}
            <div className="p-2 border-t bg-gray-50 flex justify-between rounded-b-lg flex-shrink-0">
              <button
                onClick={() => setSendingOrder(null)}
                className="px-3 py-1.5 bg-gray-400 text-white rounded text-xs hover:bg-gray-500"
              >
                Cancel
              </button>
              <button
                onClick={() => sendTranslationToClient(sendingOrder.id)}
                disabled={sendingToClient}
                className={`px-3 py-1.5 text-white rounded text-xs disabled:bg-gray-400 ${
                  sendingOrder.translation_status === 'delivered'
                    ? 'bg-blue-600 hover:bg-blue-700'
                    : 'bg-blue-600 hover:bg-blue-700'
                }`}
              >
                {sendingToClient ? 'Sending...' : (sendingOrder.translation_status === 'delivered' ? 'üîÑ Resend' : 'üì§ Send')}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Delivery Preview Modal */}
      {showDeliveryModal && deliveryModalOrder && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            {/* Header */}
            <div className="p-4 border-b flex justify-between items-center bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-t-lg">
              <div>
                <h3 className="font-bold text-lg">üìß Preview & Send Translation</h3>
                <p className="text-xs opacity-80">
                  {deliveryModalOrder.order_number} - {deliveryModalOrder.client_name} ({deliveryModalOrder.client_email})
                </p>
              </div>
              <button
                onClick={() => { setShowDeliveryModal(false); setDeliveryModalOrder(null); setDeliveryTranslationHtml(''); setDeliveryIncludeVerification(true); }}
                className="text-white hover:text-gray-200 text-2xl font-bold"
              >
                √ó
              </button>
            </div>

            {/* Translation Preview */}
            <div className="flex-1 overflow-auto p-4 bg-gray-50">
              <div className="mb-3 flex items-center justify-between">
                <h4 className="text-sm font-bold text-gray-700">üìÑ Translation Preview</h4>
                <span className={`px-2 py-1 text-xs rounded ${STATUS_COLORS[deliveryModalOrder.translation_status] || 'bg-gray-100'}`}>
                  {getStatusLabel(deliveryModalOrder.translation_status)}
                </span>
              </div>

              {deliveryTranslationHtml ? (
                <div
                  className="bg-white border rounded-lg p-4 shadow-inner prose max-w-none"
                  style={{ minHeight: '300px' }}
                  dangerouslySetInnerHTML={{ __html: deliveryTranslationHtml }}
                />
              ) : (
                <div className="bg-white border rounded-lg p-8 text-center text-gray-400">
                  <div className="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-3"></div>
                  <p>Loading translation...</p>
                </div>
              )}

              {/* Delivery Options */}
              <div className="mt-4 p-4 bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-xl shadow-sm">
                <h4 className="text-sm font-bold text-purple-800 mb-3 flex items-center gap-2">
                  <span className="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-white text-xs">‚öô</span>
                  Delivery Options
                </h4>
                <label className={`flex items-start text-sm cursor-pointer p-3 rounded-lg transition-all duration-200 ${
                  deliveryIncludeVerification
                    ? 'bg-purple-100 border-2 border-purple-400 shadow-md'
                    : 'bg-white border-2 border-gray-200 hover:border-purple-300 hover:shadow-sm'
                }`}>
                  <input
                    type="checkbox"
                    checked={deliveryIncludeVerification}
                    onChange={(e) => setDeliveryIncludeVerification(e.target.checked)}
                    className="mt-1 mr-3 w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500"
                  />
                  <span className="flex items-start gap-3 flex-1">
                    <span className="text-2xl">üîê</span>
                    <span className="flex-1">
                      <span className="font-semibold text-gray-800 block">Include Verification Page (QR Code)</span>
                      <span className="text-xs text-gray-600 mt-1 block leading-relaxed">
                        Adds a professionally designed verification page with scannable QR code.
                        Recipients can verify document authenticity online.
                      </span>
                      {deliveryIncludeVerification && (
                        <span className="inline-flex items-center gap-1 mt-2 px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">
                          <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
                          Will be included in delivery
                        </span>
                      )}
                    </span>
                  </span>
                </label>
              </div>
            </div>

            {/* Status Message */}
            {deliveryStatus && (
              <div className={`px-4 py-3 text-sm ${
                deliveryStatus.includes('‚úÖ') ? 'bg-green-100 text-green-700 border-t border-green-200' :
                deliveryStatus.includes('‚ùå') ? 'bg-red-100 text-red-700 border-t border-red-200' :
                'bg-blue-100 text-blue-700 border-t border-blue-200'
              }`}>
                <div className="whitespace-pre-line text-center">{deliveryStatus}</div>
              </div>
            )}

            {/* Footer Actions */}
            <div className="p-4 border-t bg-gray-100 rounded-b-lg flex justify-between items-center">
              <div className="text-xs text-gray-500">
                <strong>Client:</strong> {deliveryModalOrder.client_email}
              </div>
              <div className="flex gap-3">
                <button
                  onClick={() => { setShowDeliveryModal(false); setDeliveryModalOrder(null); setDeliveryIncludeVerification(true); }}
                  className="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500 text-sm"
                >
                  Cancel
                </button>
                <button
                  onClick={sendDeliveryEmail}
                  disabled={deliverySending || !deliveryTranslationHtml}
                  className="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-300 text-sm font-medium flex items-center gap-2"
                >
                  {deliverySending ? (
                    <>
                      <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                      Sending...
                    </>
                  ) : (
                    <>üìß Send to Client</>
                  )}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Send Message to Translator Modal */}
      {messagingTranslator && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
            {/* Header */}
            <div className="p-4 border-b bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-t-lg">
              <div className="flex justify-between items-center">
                <div>
                  <h3 className="font-bold">üí¨ Send Message to Translator</h3>
                  <p className="text-xs opacity-80 mt-1">
                    To: {messagingTranslator.name}
                    {messagingTranslator.order_number && ` ‚Ä¢ Project: ${messagingTranslator.order_number}`}
                  </p>
                </div>
                <button
                  onClick={() => { setMessagingTranslator(null); setTranslatorMessageContent(''); }}
                  className="text-white hover:text-gray-200 text-2xl font-bold"
                >
                  √ó
                </button>
              </div>
            </div>

            {/* Content */}
            <div className="p-4">
              <div className="mb-4">
                <label className="text-xs font-medium text-gray-600 mb-2 block">Message:</label>
                <textarea
                  value={translatorMessageContent}
                  onChange={(e) => setTranslatorMessageContent(e.target.value)}
                  placeholder="Type your message to the translator..."
                  className="w-full border rounded-lg p-3 text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  rows={5}
                />
              </div>

              {messagingTranslator.email && (
                <div className="text-xs text-gray-500 mb-4">
                  üìß A notification will be sent to: {messagingTranslator.email}
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end gap-2">
              <button
                onClick={() => { setMessagingTranslator(null); setTranslatorMessageContent(''); }}
                className="px-4 py-2 bg-gray-400 text-white rounded text-sm hover:bg-gray-500"
              >
                Cancel
              </button>
              <button
                onClick={sendMessageToTranslator}
                disabled={sendingTranslatorMessage || !translatorMessageContent.trim()}
                className="px-4 py-2 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 disabled:bg-gray-300 flex items-center gap-2"
              >
                {sendingTranslatorMessage ? (
                  <>
                    <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    Sending...
                  </>
                ) : (
                  <>üì§ Send Message</>
                )}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ==================== NEW QUOTE PAGE ====================
const NewQuotePage = ({ adminKey, user }) => {
  const [formData, setFormData] = useState({
    client_name: '',
    client_email: '',
    client_phone: '',
    translate_from: 'Portuguese',
    translate_to: 'English',
    service_type: 'certified',
    turnaround: 'standard',
    delivery_method: 'digital',
    discount: 0,
    special_instructions: '',
    // Editable prices
    custom_price_per_page: 24.99,
    custom_urgency_multiplier: 1.0,
    custom_delivery_fee: 0
  });
  const [uploadedFiles, setUploadedFiles] = useState([]);
  const [uploading, setUploading] = useState(false);
  const [calculating, setCalculating] = useState(false);
  const [sending, setSending] = useState(false);
  const [quote, setQuote] = useState(null);
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState('');

  const LANGUAGES = ['Portuguese', 'Spanish', 'English', 'French', 'German', 'Italian', 'Chinese', 'Japanese', 'Korean', 'Arabic', 'Russian'];

  const SERVICE_TYPES = {
    certified: { name: 'Certified Translation', price: 24.99, description: 'Official documents, legal, immigration' },
    sworn: { name: 'Sworn Translation (Tradu√ß√£o Juramentada)', price: 34.99, description: 'Court-recognized, notarized by sworn translator' },
    apostille: { name: 'Apostille Service', price: 85.00, description: 'HCCH Apostille authentication', comingSoon: true },
    standard: { name: 'Standard Translation', price: 19.99, description: 'General use, no certification' }
  };

  const TURNAROUND = {
    standard: { name: '2-3 business days', multiplier: 1.0 },
    priority: { name: 'Priority (24 hours)', multiplier: 1.25 },
    urgent: { name: 'Urgent (12 hours)', multiplier: 2.0 }
  };

  const DELIVERY_OPTIONS = {
    digital: { name: 'Digital Delivery (Email/Download)', price: 0, description: 'PDF via email' },
    usps_standard: { name: 'USPS Standard Mail', price: 5.99, description: '5-7 business days' },
    usps_priority: { name: 'USPS Priority Mail', price: 12.99, description: '2-3 business days' },
    usps_express: { name: 'USPS Express Mail', price: 29.99, description: '1-2 business days' },
    fedex_overnight: { name: 'FedEx Overnight', price: 39.99, description: 'Next business day' }
  };

  // Handle file upload
  const handleFileUpload = async (e) => {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;

    setUploading(true);
    const newFiles = [];

    for (const file of files) {
      const reader = new FileReader();
      await new Promise((resolve) => {
        reader.onload = (e) => {
          newFiles.push({
            name: file.name,
            size: file.size,
            type: file.type,
            data: e.target.result.split(',')[1], // base64
            pages: 1 // Default, would need OCR/PDF parsing for actual count
          });
          resolve();
        };
        reader.readAsDataURL(file);
      });
    }

    setUploadedFiles([...uploadedFiles, ...newFiles]);
    setUploading(false);
    setQuote(null); // Reset quote when files change
  };

  // Remove file
  const removeFile = (index) => {
    const newFiles = [...uploadedFiles];
    newFiles.splice(index, 1);
    setUploadedFiles(newFiles);
    setQuote(null);
  };

  // Calculate quote
  const calculateQuote = () => {
    if (uploadedFiles.length === 0) {
      setError('Please upload at least one document');
      return;
    }

    setCalculating(true);
    setError('');

    // Calculate total pages (simplified - 1 page per file for now)
    const totalPages = uploadedFiles.length || 1;
    // Use custom editable prices
    const pricePerPage = parseFloat(formData.custom_price_per_page) || SERVICE_TYPES[formData.service_type].price;
    const urgencyMultiplier = parseFloat(formData.custom_urgency_multiplier) || TURNAROUND[formData.turnaround].multiplier;
    const deliveryFee = parseFloat(formData.custom_delivery_fee) || DELIVERY_OPTIONS[formData.delivery_method].price;
    const discountPercent = parseFloat(formData.discount) || 0;

    const subtotal = totalPages * pricePerPage;
    const turnaroundFee = subtotal * (urgencyMultiplier - 1);
    const discountAmount = (subtotal + turnaroundFee) * (discountPercent / 100);
    const total = subtotal + turnaroundFee + deliveryFee - discountAmount;

    setTimeout(() => {
      setQuote({
        pages: totalPages,
        base_price: pricePerPage,
        subtotal: subtotal,
        turnaround_fee: turnaroundFee,
        delivery_fee: deliveryFee,
        discount_percent: discountPercent,
        discount_amount: discountAmount,
        total: total,
        service: SERVICE_TYPES[formData.service_type].name,
        turnaround: TURNAROUND[formData.turnaround].name,
        delivery: DELIVERY_OPTIONS[formData.delivery_method].name
      });
      setCalculating(false);
    }, 500);
  };

  // Send quote to client
  const sendQuote = async () => {
    if (!quote) {
      setError('Please calculate the quote first');
      return;
    }

    if (!formData.client_email || !formData.client_name) {
      setError('Please fill in client name and email');
      return;
    }

    setSending(true);
    setError('');

    try {
      // Create order in backend
      const orderData = {
        client_name: formData.client_name,
        client_email: formData.client_email,
        client_phone: formData.client_phone,
        translate_from: formData.translate_from,
        translate_to: formData.translate_to,
        service_type: formData.service_type,
        turnaround: formData.turnaround,
        special_instructions: formData.special_instructions,
        pages: quote.pages,
        total_price: quote.total,
        status: 'Quote',
        created_by: user?.name || 'Admin',
        files: uploadedFiles.map(f => ({ filename: f.name, data: f.data, content_type: f.type }))
      };

      const response = await axios.post(`${API}/admin/create-quote?admin_key=${adminKey}`, orderData);

      if (response.data.success || response.data.id) {
        setSuccess(true);
        // Reset form
        setFormData({
          client_name: '',
          client_email: '',
          client_phone: '',
          translate_from: 'Portuguese',
          translate_to: 'English',
          service_type: 'certified',
          turnaround: 'standard',
          special_instructions: ''
        });
        setUploadedFiles([]);
        setQuote(null);
      } else {
        throw new Error(response.data.error || 'Failed to create quote');
      }
    } catch (err) {
      console.error('Failed to send quote:', err);
      setError(err.response?.data?.detail || err.message || 'Failed to send quote');
    } finally {
      setSending(false);
    }
  };

  if (success) {
    return (
      <div className="p-6 max-w-2xl mx-auto">
        <div className="bg-white rounded-xl shadow-lg p-8 text-center">
          <div className="text-6xl mb-4">‚úÖ</div>
          <h2 className="text-2xl font-bold text-green-700 mb-2">Quote Sent Successfully!</h2>
          <p className="text-gray-600 mb-6">
            The quote has been sent to {formData.client_email || 'the client'}
          </p>
          <button
            onClick={() => setSuccess(false)}
            className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            Create Another Quote
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="p-6 max-w-4xl mx-auto">
      <div className="mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Create New Quote</h1>
        <p className="text-gray-600">Create a quote for a client and send it via email</p>
      </div>

      {error && (
        <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg">{error}</div>
      )}

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Left Column - Form */}
        <div className="lg:col-span-2 space-y-6">
          {/* Client Information */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-lg font-bold text-gray-800 mb-4">Client Information</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Client Name *</label>
                <input
                  type="text"
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  value={formData.client_name}
                  onChange={(e) => setFormData({...formData, client_name: e.target.value})}
                  placeholder="John Smith"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                <input
                  type="email"
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  value={formData.client_email}
                  onChange={(e) => setFormData({...formData, client_email: e.target.value})}
                  placeholder="john@example.com"
                />
              </div>
              <div className="md:col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">Phone (optional)</label>
                <input
                  type="tel"
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  value={formData.client_phone}
                  onChange={(e) => setFormData({...formData, client_phone: e.target.value})}
                  placeholder="+1 (555) 123-4567"
                />
              </div>
            </div>
          </div>

          {/* Translation Details */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-lg font-bold text-gray-800 mb-4">Translation Details</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">From Language</label>
                <select
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  value={formData.translate_from}
                  onChange={(e) => setFormData({...formData, translate_from: e.target.value})}
                >
                  {LANGUAGES.map(lang => (
                    <option key={lang} value={lang}>{lang}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">To Language</label>
                <select
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  value={formData.translate_to}
                  onChange={(e) => setFormData({...formData, translate_to: e.target.value})}
                >
                  {LANGUAGES.map(lang => (
                    <option key={lang} value={lang}>{lang}</option>
                  ))}
                </select>
              </div>
            </div>

            {/* Service Type */}
            <div className="mt-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">Service Type</label>
              <div className="space-y-2">
                {Object.entries(SERVICE_TYPES).map(([key, service]) => (
                  <label
                    key={key}
                    className={`flex items-center p-3 border rounded-lg ${service.comingSoon ? 'opacity-50 cursor-not-allowed bg-gray-50' : 'cursor-pointer'} ${formData.service_type === key ? 'border-blue-500 bg-blue-50' : 'hover:bg-gray-50'}`}
                  >
                    <input
                      type="radio"
                      name="service_type"
                      value={key}
                      checked={formData.service_type === key}
                      disabled={service.comingSoon}
                      onChange={(e) => {
                        setFormData({
                          ...formData,
                          service_type: e.target.value,
                          custom_price_per_page: SERVICE_TYPES[e.target.value].price
                        });
                        setQuote(null);
                      }}
                      className="mr-3"
                    />
                    <div className="flex-1">
                      <div className="font-medium">
                        {service.name}
                        {service.comingSoon && <span className="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded">Coming Soon</span>}
                      </div>
                      <div className="text-sm text-gray-500">{service.description}</div>
                    </div>
                    <div className="font-bold text-blue-600">${service.price}/page</div>
                  </label>
                ))}
              </div>
            </div>

            {/* Editable Price per Page */}
            <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
              <label className="block text-sm font-medium text-yellow-800 mb-2">Custom Price per Page ($)</label>
              <input
                type="number"
                step="0.01"
                min="0"
                value={formData.custom_price_per_page}
                onChange={(e) => { setFormData({...formData, custom_price_per_page: parseFloat(e.target.value) || 0}); setQuote(null); }}
                className="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500"
              />
              <p className="text-xs text-yellow-600 mt-1">Override the default price per page for this quote</p>
            </div>

            {/* Turnaround */}
            <div className="mt-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">Turnaround Time</label>
              <div className="space-y-2">
                {Object.entries(TURNAROUND).map(([key, option]) => (
                  <label key={key} className={`flex items-center p-3 border rounded-lg cursor-pointer ${formData.turnaround === key ? 'border-blue-500 bg-blue-50' : 'hover:bg-gray-50'}`}>
                    <input
                      type="radio"
                      name="turnaround"
                      value={key}
                      checked={formData.turnaround === key}
                      onChange={(e) => {
                        setFormData({
                          ...formData,
                          turnaround: e.target.value,
                          custom_urgency_multiplier: TURNAROUND[e.target.value].multiplier
                        });
                        setQuote(null);
                      }}
                      className="mr-3"
                    />
                    <div className="flex-1">
                      <div className="font-medium">{option.name}</div>
                    </div>
                    {option.multiplier > 1 && (
                      <div className="text-sm text-blue-600">+{((option.multiplier - 1) * 100).toFixed(0)}%</div>
                    )}
                  </label>
                ))}
              </div>
              {/* Custom Urgency Multiplier */}
              <div className="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <label className="block text-xs font-medium text-blue-800 mb-1">Custom Urgency Multiplier</label>
                <input
                  type="number"
                  step="0.01"
                  min="1"
                  value={formData.custom_urgency_multiplier}
                  onChange={(e) => { setFormData({...formData, custom_urgency_multiplier: parseFloat(e.target.value) || 1}); setQuote(null); }}
                  className="w-full px-2 py-1 text-sm border border-blue-300 rounded focus:ring-2 focus:ring-blue-500"
                />
                <p className="text-xs text-blue-600 mt-1">1.0 = no fee, 1.25 = +25%, 2.0 = +100%</p>
              </div>
            </div>

            {/* Delivery Method */}
            <div className="mt-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">Delivery Method</label>
              <div className="space-y-2">
                {Object.entries(DELIVERY_OPTIONS).map(([key, option]) => (
                  <label key={key} className={`flex items-center p-3 border rounded-lg cursor-pointer ${formData.delivery_method === key ? 'border-blue-500 bg-blue-50' : 'hover:bg-gray-50'}`}>
                    <input
                      type="radio"
                      name="delivery_method"
                      value={key}
                      checked={formData.delivery_method === key}
                      onChange={(e) => {
                        setFormData({
                          ...formData,
                          delivery_method: e.target.value,
                          custom_delivery_fee: DELIVERY_OPTIONS[e.target.value].price
                        });
                        setQuote(null);
                      }}
                      className="mr-3"
                    />
                    <div className="flex-1">
                      <div className="font-medium">{option.name}</div>
                      <div className="text-sm text-gray-500">{option.description}</div>
                    </div>
                    {option.price > 0 && (
                      <div className="text-sm text-blue-600">+${option.price.toFixed(2)}</div>
                    )}
                  </label>
                ))}
              </div>
              {/* Custom Delivery Fee */}
              <div className="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <label className="block text-xs font-medium text-blue-800 mb-1">Custom Delivery Fee ($)</label>
                <input
                  type="number"
                  step="0.01"
                  min="0"
                  value={formData.custom_delivery_fee}
                  onChange={(e) => { setFormData({...formData, custom_delivery_fee: parseFloat(e.target.value) || 0}); setQuote(null); }}
                  className="w-full px-2 py-1 text-sm border border-blue-300 rounded focus:ring-2 focus:ring-blue-500"
                />
                <p className="text-xs text-blue-600 mt-1">Override the delivery fee for this quote</p>
              </div>
            </div>

            {/* Discount */}
            <div className="mt-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">Discount (%)</label>
              <input
                type="number"
                min="0"
                max="100"
                value={formData.discount}
                onChange={(e) => { setFormData({...formData, discount: parseFloat(e.target.value) || 0}); setQuote(null); }}
                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                placeholder="0"
              />
              <p className="text-xs text-gray-500 mt-1">Enter discount percentage (e.g., 10 for 10% off)</p>
            </div>
          </div>

          {/* Documents */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-lg font-bold text-gray-800 mb-4">Documents</h2>

            {/* Upload Area */}
            <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors">
              <input
                type="file"
                multiple
                onChange={handleFileUpload}
                className="hidden"
                id="file-upload"
                accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
              />
              <label htmlFor="file-upload" className="cursor-pointer">
                <div className="text-4xl mb-2">üìÑ</div>
                <div className="font-medium text-gray-700">Click to upload documents</div>
                <div className="text-sm text-gray-500">PDF, DOC, DOCX, JPG, PNG</div>
              </label>
            </div>

            {/* Uploaded Files */}
            {uploadedFiles.length > 0 && (
              <div className="mt-4 space-y-2">
                {uploadedFiles.map((file, index) => (
                  <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div className="flex items-center">
                      <span className="text-2xl mr-3">üìé</span>
                      <div>
                        <div className="font-medium text-sm">{file.name}</div>
                        <div className="text-xs text-gray-500">{(file.size / 1024).toFixed(1)} KB</div>
                      </div>
                    </div>
                    <button
                      onClick={() => removeFile(index)}
                      className="text-red-500 hover:text-red-700"
                    >
                      ‚úï
                    </button>
                  </div>
                ))}
              </div>
            )}

            {/* Special Instructions */}
            <div className="mt-4">
              <label className="block text-sm font-medium text-gray-700 mb-1">Special Instructions (optional)</label>
              <textarea
                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                rows={3}
                value={formData.special_instructions}
                onChange={(e) => setFormData({...formData, special_instructions: e.target.value})}
                placeholder="Any special requirements or notes..."
              />
            </div>
          </div>
        </div>

        {/* Right Column - Quote Summary */}
        <div className="lg:col-span-1">
          <div className="bg-white rounded-xl shadow p-6 sticky top-6">
            <h2 className="text-lg font-bold text-blue-700 mb-4">Quote Summary</h2>

            {quote ? (
              <>
                <div className="space-y-3 mb-6">
                  <div className="flex justify-between text-sm">
                    <span className="text-gray-600">Service</span>
                    <span className="font-medium">{quote.service}</span>
                  </div>
                  <div className="flex justify-between text-sm">
                    <span className="text-gray-600">Pages</span>
                    <span className="font-medium">{quote.pages}</span>
                  </div>
                  <div className="flex justify-between text-sm">
                    <span className="text-gray-600">Turnaround</span>
                    <span className="font-medium">{quote.turnaround}</span>
                  </div>
                  <div className="flex justify-between text-sm">
                    <span className="text-gray-600">Delivery</span>
                    <span className="font-medium">{quote.delivery}</span>
                  </div>
                  <div className="flex justify-between text-sm">
                    <span className="text-gray-600">Subtotal</span>
                    <span>${quote.subtotal.toFixed(2)}</span>
                  </div>
                  {quote.turnaround_fee > 0 && (
                    <div className="flex justify-between text-sm">
                      <span className="text-gray-600">Rush Fee</span>
                      <span className="text-blue-600">+${quote.turnaround_fee.toFixed(2)}</span>
                    </div>
                  )}
                  {quote.delivery_fee > 0 && (
                    <div className="flex justify-between text-sm">
                      <span className="text-gray-600">Delivery Fee</span>
                      <span className="text-blue-600">+${quote.delivery_fee.toFixed(2)}</span>
                    </div>
                  )}
                  {quote.discount_amount > 0 && (
                    <div className="flex justify-between text-sm">
                      <span className="text-gray-600">Discount ({quote.discount_percent}%)</span>
                      <span className="text-green-600">-${quote.discount_amount.toFixed(2)}</span>
                    </div>
                  )}
                  <div className="border-t pt-3 flex justify-between">
                    <span className="font-bold">Total</span>
                    <span className="font-bold text-2xl text-blue-600">${quote.total.toFixed(2)}</span>
                  </div>
                </div>

                <button
                  onClick={sendQuote}
                  disabled={sending}
                  className="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 font-medium"
                >
                  {sending ? 'Sending...' : 'üìß Send Quote to Client'}
                </button>
              </>
            ) : (
              <>
                <div className="text-center text-gray-500 py-8">
                  <div className="text-4xl mb-2">üìä</div>
                  <p>Upload documents and click Calculate to see the quote</p>
                </div>

                <button
                  onClick={calculateQuote}
                  disabled={calculating || uploadedFiles.length === 0}
                  className="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 font-medium"
                >
                  {calculating ? 'Calculating...' : 'üî¢ Calculate Quote'}
                </button>
              </>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

// ==================== FOLLOW-UPS PAGE ====================
const FollowupsPage = ({ adminKey }) => {
  const [loading, setLoading] = useState(true);
  const [processing, setProcessing] = useState(false);
  const [followupData, setFollowupData] = useState(null);
  const [error, setError] = useState('');
  const [selectedStage, setSelectedStage] = useState(null);
  const [showModal, setShowModal] = useState(false);

  const fetchFollowupStatus = async () => {
    setLoading(true);
    try {
      const response = await axios.get(`${API}/admin/quotes/followup-status?admin_key=${adminKey}`);
      setFollowupData(response.data);
    } catch (err) {
      setError('Failed to load follow-up data');
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const processFollowups = async () => {
    setProcessing(true);
    try {
      const response = await axios.post(`${API}/admin/quotes/process-followups?admin_key=${adminKey}`);
      const result = response.data;
      const errorDetails = result.errors?.length > 0
        ? `\n\nErrors (${result.errors.length}):\n${result.errors.slice(0, 5).join('\n')}${result.errors.length > 5 ? `\n... and ${result.errors.length - 5} more` : ''}`
        : '';
      if (result.errors?.length > 0) {
        console.log('Follow-up errors:', result.errors);
      }
      showToast(`Follow-ups processed!\n\nReminders sent: ${result.reminders_sent}\nMarked as lost: ${result.marked_lost}${errorDetails}`);
      fetchFollowupStatus();
    } catch (err) {
      showToast('Failed to process follow-ups. Check console for details.');
      console.error(err);
    } finally {
      setProcessing(false);
    }
  };

  const excludeFromFollowup = async (quoteId, quoteType) => {
    if (!window.confirm('Tem certeza que deseja remover este cliente do follow-up autom√°tico?')) {
      return;
    }
    try {
      await axios.post(`${API}/admin/quotes/exclude-from-followup?admin_key=${adminKey}&quote_id=${quoteId}&quote_type=${quoteType}`);
      fetchFollowupStatus();
    } catch (err) {
      showToast('Erro ao excluir cliente do follow-up');
      console.error(err);
    }
  };

  const openStageModal = (stage) => {
    setSelectedStage(stage);
    setShowModal(true);
  };

  const getClientsForStage = (stage) => {
    if (!followupData) return [];
    const allClients = [
      ...(followupData.abandoned_quotes || []),
      ...(followupData.quote_orders || [])
    ];
    return allClients.filter(client => client.followup_stage === stage);
  };

  const stageLabels = {
    pending: { title: 'Pending (0-3 days)', color: 'gray' },
    first: { title: '1st Reminder', color: 'yellow' },
    second: { title: '2nd Reminder (10%)', color: 'blue' },
    third: { title: '3rd Reminder (15%)', color: 'red' },
    lost: { title: 'Marked Lost', color: 'gray' }
  };

  useEffect(() => {
    fetchFollowupStatus();
  }, []);

  if (loading) {
    return (
      <div className="p-6 flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600"></div>
      </div>
    );
  }

  return (
    <div className="p-6 bg-gray-50 min-h-screen">
      <div className="max-w-7xl mx-auto">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h1 className="text-2xl font-bold text-gray-800">Quote Follow-up System</h1>
            <p className="text-gray-600 text-sm">Automated reminders for unconverted quotes</p>
          </div>
          <button
            onClick={processFollowups}
            disabled={processing}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 flex items-center gap-2"
          >
            {processing ? (
              <>
                <span className="animate-spin">‚è≥</span>
                Processing...
              </>
            ) : (
              <>
                <span>üöÄ</span>
                Process Follow-ups Now
              </>
            )}
          </button>
        </div>

        {/* Summary Cards - Clickable */}
        {followupData?.summary && (
          <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div
              onClick={() => openStageModal('pending')}
              className="bg-white rounded-lg shadow p-4 text-center cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent hover:border-gray-300"
            >
              <div className="text-3xl font-bold text-gray-600">{followupData.summary.total_pending}</div>
              <div className="text-xs text-gray-500">Pending (0-3 days)</div>
              <div className="text-xs text-gray-400 mt-1">Click to view</div>
            </div>
            <div
              onClick={() => openStageModal('first')}
              className="bg-yellow-50 rounded-lg shadow p-4 text-center border border-yellow-200 cursor-pointer hover:shadow-lg transition-shadow hover:border-yellow-400"
            >
              <div className="text-3xl font-bold text-yellow-600">{followupData.summary.needs_first_reminder}</div>
              <div className="text-xs text-yellow-700">Need 1st Reminder</div>
              <div className="text-xs text-yellow-500 mt-1">Click to view</div>
            </div>
            <div
              onClick={() => openStageModal('second')}
              className="bg-blue-50 rounded-lg shadow p-4 text-center border border-blue-200 cursor-pointer hover:shadow-lg transition-shadow hover:border-blue-400"
            >
              <div className="text-3xl font-bold text-blue-600">{followupData.summary.needs_second_reminder}</div>
              <div className="text-xs text-blue-700">Need 2nd Reminder (10%)</div>
              <div className="text-xs text-blue-500 mt-1">Click to view</div>
            </div>
            <div
              onClick={() => openStageModal('third')}
              className="bg-red-50 rounded-lg shadow p-4 text-center border border-red-200 cursor-pointer hover:shadow-lg transition-shadow hover:border-red-400"
            >
              <div className="text-3xl font-bold text-red-600">{followupData.summary.needs_third_reminder}</div>
              <div className="text-xs text-red-700">Need 3rd Reminder (15%)</div>
              <div className="text-xs text-red-500 mt-1">Click to view</div>
            </div>
            <div
              onClick={() => openStageModal('lost')}
              className="bg-gray-100 rounded-lg shadow p-4 text-center cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent hover:border-gray-400"
            >
              <div className="text-3xl font-bold text-gray-500">{followupData.summary.marked_lost}</div>
              <div className="text-xs text-gray-500">Marked Lost</div>
              <div className="text-xs text-gray-400 mt-1">Click to view</div>
            </div>
          </div>
        )}

        {/* Schedule Info */}
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
          <h3 className="font-semibold text-blue-800 mb-2">Follow-up Schedule</h3>
          <div className="grid grid-cols-4 gap-4 text-sm">
            <div className="text-center">
              <div className="text-blue-600 font-bold">Day 3</div>
              <div className="text-blue-700">1st Reminder</div>
              <div className="text-blue-500 text-xs">No discount</div>
            </div>
            <div className="text-center">
              <div className="text-blue-600 font-bold">Day 7</div>
              <div className="text-blue-700">2nd Reminder</div>
              <div className="text-blue-500 text-xs">10% discount</div>
            </div>
            <div className="text-center">
              <div className="text-blue-600 font-bold">Day 14</div>
              <div className="text-blue-700">3rd Reminder</div>
              <div className="text-blue-500 text-xs">15% discount</div>
            </div>
            <div className="text-center">
              <div className="text-gray-600 font-bold">Day 21</div>
              <div className="text-gray-700">Mark as Lost</div>
              <div className="text-gray-500 text-xs">Close quote</div>
            </div>
          </div>
        </div>

        {/* Quote Orders Table */}
        {followupData?.quote_orders?.length > 0 && (
          <div className="bg-white rounded-lg shadow mb-6">
            <div className="px-4 py-3 border-b bg-gray-50">
              <h3 className="font-semibold text-gray-800">Quote Orders ({followupData.quote_orders.length})</h3>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-2 text-left">Quote #</th>
                    <th className="px-4 py-2 text-left">Client</th>
                    <th className="px-4 py-2 text-left">Email</th>
                    <th className="px-4 py-2 text-right">Amount</th>
                    <th className="px-4 py-2 text-center">Days</th>
                    <th className="px-4 py-2 text-center">Reminders</th>
                    <th className="px-4 py-2 text-left">Status</th>
                    <th className="px-4 py-2 text-left">Next Action</th>
                  </tr>
                </thead>
                <tbody>
                  {followupData.quote_orders.map((order, idx) => (
                    <tr key={idx} className="border-t hover:bg-gray-50">
                      <td className="px-4 py-2 font-medium">{order.order_number}</td>
                      <td className="px-4 py-2">{order.client_name}</td>
                      <td className="px-4 py-2 text-gray-600">{order.client_email}</td>
                      <td className="px-4 py-2 text-right">${(order.total_price || 0).toFixed(2)}</td>
                      <td className="px-4 py-2 text-center">{order.days_since_creation}</td>
                      <td className="px-4 py-2 text-center">{order.followup_count || 0}</td>
                      <td className="px-4 py-2">
                        <span className={`px-2 py-1 rounded text-xs ${
                          order.status === 'Quote - Lost' ? 'bg-gray-200 text-gray-700' :
                          order.status === 'Quote' ? 'bg-yellow-100 text-yellow-700' :
                          'bg-blue-100 text-blue-700'
                        }`}>
                          {order.status}
                        </span>
                      </td>
                      <td className="px-4 py-2 text-sm text-gray-600">{order.next_action}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Abandoned Quotes Table */}
        {followupData?.tabndoned_quotes?.length > 0 && (
          <div className="bg-white rounded-lg shadow">
            <div className="px-4 py-3 border-b bg-gray-50">
              <h3 className="font-semibold text-gray-800">Abandoned Quotes ({followupData.tabndoned_quotes.length})</h3>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-2 text-left">Name</th>
                    <th className="px-4 py-2 text-left">Email</th>
                    <th className="px-4 py-2 text-right">Amount</th>
                    <th className="px-4 py-2 text-center">Days</th>
                    <th className="px-4 py-2 text-center">Reminders</th>
                    <th className="px-4 py-2 text-left">Status</th>
                    <th className="px-4 py-2 text-left">Next Action</th>
                  </tr>
                </thead>
                <tbody>
                  {followupData.tabndoned_quotes.map((quote, idx) => (
                    <tr key={idx} className="border-t hover:bg-gray-50">
                      <td className="px-4 py-2 font-medium">{quote.name}</td>
                      <td className="px-4 py-2 text-gray-600">{quote.email}</td>
                      <td className="px-4 py-2 text-right">${(quote.total_price || 0).toFixed(2)}</td>
                      <td className="px-4 py-2 text-center">{quote.days_since_creation}</td>
                      <td className="px-4 py-2 text-center">{quote.reminder_count || 0}</td>
                      <td className="px-4 py-2">
                        <span className={`px-2 py-1 rounded text-xs ${
                          quote.status === 'lost' ? 'bg-gray-200 text-gray-700' :
                          quote.status === 'recovered' ? 'bg-green-100 text-green-700' :
                          'bg-yellow-100 text-yellow-700'
                        }`}>
                          {quote.status || 'tabndoned'}
                        </span>
                      </td>
                      <td className="px-4 py-2 text-sm text-gray-600">{quote.next_action}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {(!followupData?.quote_orders?.length && !followupData?.tabndoned_quotes?.length) && (
          <div className="bg-white rounded-lg shadow p-8 text-center">
            <div className="text-6xl mb-4">‚úÖ</div>
            <h3 className="text-lg font-semibold text-gray-700">All caught up!</h3>
            <p className="text-gray-500">No quotes requiring follow-up at this time.</p>
          </div>
        )}

        {/* Modal for Stage Details */}
        {showModal && selectedStage && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden">
              <div className={`px-6 py-4 border-b flex items-center justify-between ${
                selectedStage === 'first' ? 'bg-yellow-50' :
                selectedStage === 'second' ? 'bg-blue-50' :
                selectedStage === 'third' ? 'bg-red-50' :
                'bg-gray-50'
              }`}>
                <h2 className="text-xl font-bold text-gray-800">
                  {stageLabels[selectedStage]?.title || selectedStage}
                </h2>
                <button
                  onClick={() => setShowModal(false)}
                  className="text-gray-500 hover:text-gray-700 text-2xl font-bold"
                >
                  √ó
                </button>
              </div>
              <div className="p-6 overflow-y-auto max-h-[60vh]">
                {getClientsForStage(selectedStage).length === 0 ? (
                  <p className="text-center text-gray-500 py-8">Nenhum cliente nesta categoria</p>
                ) : (
                  <table className="w-full text-sm">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-4 py-2 text-left">Cliente</th>
                        <th className="px-4 py-2 text-left">Email</th>
                        <th className="px-4 py-2 text-right">Valor</th>
                        <th className="px-4 py-2 text-center">Dias</th>
                        <th className="px-4 py-2 text-center">Reminders</th>
                        <th className="px-4 py-2 text-center">A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {getClientsForStage(selectedStage).map((client, idx) => (
                        <tr key={idx} className="border-t hover:bg-gray-50">
                          <td className="px-4 py-2 font-medium">
                            {client.client_name || client.name}
                            {client.order_number && (
                              <span className="text-xs text-gray-500 ml-2">#{client.order_number}</span>
                            )}
                          </td>
                          <td className="px-4 py-2 text-gray-600">{client.client_email || client.email}</td>
                          <td className="px-4 py-2 text-right">${(client.total_price || 0).toFixed(2)}</td>
                          <td className="px-4 py-2 text-center">{client.days_since_creation}</td>
                          <td className="px-4 py-2 text-center">{client.followup_count || client.reminder_count || 0}</td>
                          <td className="px-4 py-2 text-center">
                            <button
                              onClick={() => excludeFromFollowup(client.id, client.type)}
                              className="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 text-xs font-medium"
                              title="Remover do follow-up autom√°tico"
                            >
                              Excluir
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                )}
              </div>
              <div className="px-6 py-4 border-t bg-gray-50 flex justify-end">
                <button
                  onClick={() => setShowModal(false)}
                  className="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                >
                  Fechar
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

// ==================== SETTINGS PAGE ====================
const SettingsPage = ({ adminKey }) => {
  const [exportingProjects, setExportingProjects] = useState(false);
  const [exportingClients, setExportingClients] = useState(false);
  const [exportingTranslators, setExportingTranslators] = useState(false);
  const [exportingFinancial, setExportingFinancial] = useState(false);
  const [creatingBackup, setCreatingBackup] = useState(false);
  const [exportProgress, setExportProgress] = useState('');

  // Restore Points State
  const [restorePoints, setRestorePoints] = useState([]);
  const [loadingRestorePoints, setLoadingRestorePoints] = useState(false);
  const [creatingRestorePoint, setCreatingRestorePoint] = useState(false);
  const [restoringFrom, setRestoringFrom] = useState(null);
  const [downloadingSource, setDownloadingSource] = useState(false);
  const [restorePointName, setRestorePointName] = useState('');
  const [showRestoreConfirm, setShowRestoreConfirm] = useState(null);

  // QuickBooks Integration State
  const [qbStatus, setQbStatus] = useState({ connected: false, company_name: null, loading: true });
  const [qbConnecting, setQbConnecting] = useState(false);

  // Check QuickBooks status on mount
  useEffect(() => {
    const checkQBStatus = async () => {
      try {
        const response = await axios.get(`${API}/quickbooks/status?admin_key=${adminKey}`);
        setQbStatus({ ...response.data, loading: false });
      } catch (err) {
        console.error('Failed to check QuickBooks status:', err);
        setQbStatus({ connected: false, loading: false, error: err.message });
      }
    };
    checkQBStatus();

    // Listen for OAuth callback message
    const handleMessage = (event) => {
      if (event.data?.type === 'quickbooks_connected' && event.data?.success) {
        checkQBStatus();
      }
    };
    window.addEventListener('message', handleMessage);
    return () => window.removeEventListener('message', handleMessage);
  }, [adminKey]);

  const connectQuickBooks = async () => {
    setQbConnecting(true);
    try {
      const response = await axios.get(`${API}/quickbooks/connect?admin_key=${adminKey}`);
      if (response.data.authorization_url) {
        // Open QuickBooks authorization in a popup
        const width = 600;
        const height = 700;
        const left = (window.screen.width - width) / 2;
        const top = (window.screen.height - height) / 2;
        window.open(
          response.data.authorization_url,
          'QuickBooks Authorization',
          `width=${width},height=${height},left=${left},top=${top}`
        );
      }
    } catch (err) {
      console.error('Failed to connect to QuickBooks:', err);
      showToast('Failed to start QuickBooks connection: ' + (err.response?.data?.detail || err.message));
    } finally {
      setQbConnecting(false);
    }
  };

  const disconnectQuickBooks = async () => {
    if (!window.confirm('Are you sure you want to disconnect QuickBooks?')) return;
    try {
      await axios.post(`${API}/quickbooks/disconnect?admin_key=${adminKey}`);
      setQbStatus({ connected: false, company_name: null, loading: false });
    } catch (err) {
      console.error('Failed to disconnect QuickBooks:', err);
      showToast('Failed to disconnect: ' + (err.response?.data?.detail || err.message));
    }
  };

  // Export functions
  const exportToCSV = (data, filename) => {
    if (!data || data.length === 0) {
      showToast('No data to export');
      return;
    }
    const headers = Object.keys(data[0]);
    const csvContent = [
      headers.join(','),
      ...data.map(row => headers.map(h => {
        const val = row[h];
        if (val === null || val === undefined) return '';
        if (typeof val === 'string' && (val.includes(',') || val.includes('"') || val.includes('\n'))) {
          return `"${val.replace(/"/g, '""')}"`;
        }
        return val;
      }).join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  };

  const exportToJSON = (data, filename) => {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
  };

  const exportProjects = async (format = 'csv') => {
    setExportingProjects(true);
    setExportProgress('Fetching projects...');
    try {
      const response = await axios.get(`${API}/admin/orders?admin_key=${adminKey}`);
      const projects = response.data.orders || response.data || [];
      const exportData = projects.map(p => ({
        order_number: p.order_number,
        client_name: p.client_name,
        client_email: p.client_email,
        document_type: p.document_type || p.service_type,
        source_language: p.translate_from,
        target_language: p.translate_to,
        status: p.translation_status,
        payment_status: p.payment_status,
        total_price: p.total_price,
        deadline: p.deadline,
        created_at: p.created_at,
        assigned_pm: p.assigned_pm_name,
        assigned_translator: p.assigned_translator_name
      }));
      if (format === 'csv') exportToCSV(exportData, 'projects');
      else exportToJSON(exportData, 'projects');
      setExportProgress('‚úÖ Projects exported! Check your Downloads folder.');
    } catch (err) {
      setExportProgress('‚ùå Error exporting projects');
      console.error(err);
    } finally {
      setExportingProjects(false);
      setTimeout(() => setExportProgress(''), 3000);
    }
  };

  const exportClients = async (format = 'csv') => {
    setExportingClients(true);
    setExportProgress('Fetching client data...');
    try {
      const response = await axios.get(`${API}/admin/orders?admin_key=${adminKey}`);
      const projects = response.data.orders || response.data || [];
      // Get unique clients
      const clientsMap = new Map();
      projects.forEach(p => {
        if (p.client_email && !clientsMap.has(p.client_email)) {
          clientsMap.set(p.client_email, {
            name: p.client_name,
            email: p.client_email,
            phone: p.client_phone || '',
            total_orders: 0,
            total_spent: 0
          });
        }
        if (p.client_email) {
          const client = clientsMap.get(p.client_email);
          client.total_orders++;
          client.total_spent += p.total_price || 0;
        }
      });
      const clients = Array.from(clientsMap.values());
      if (format === 'csv') exportToCSV(clients, 'clients');
      else exportToJSON(clients, 'clients');
      setExportProgress('‚úÖ Clients exported! Check your Downloads folder.');
    } catch (err) {
      setExportProgress('‚ùå Error exporting clients');
      console.error(err);
    } finally {
      setExportingClients(false);
      setTimeout(() => setExportProgress(''), 3000);
    }
  };

  const exportTranslators = async (format = 'csv') => {
    setExportingTranslators(true);
    setExportProgress('Fetching translators...');
    try {
      const response = await axios.get(`${API}/admin/users/by-role/translator?admin_key=${adminKey}`);
      const translators = response.data || [];
      const exportData = translators.map(t => ({
        name: t.name,
        email: t.email,
        language_pairs: t.language_pairs,
        rate_per_page: t.rate_per_page,
        rate_per_word: t.rate_per_word,
        is_active: t.is_active
      }));
      if (format === 'csv') exportToCSV(exportData, 'translators');
      else exportToJSON(exportData, 'translators');
      setExportProgress('‚úÖ Translators exported! Check your Downloads folder.');
    } catch (err) {
      setExportProgress('‚ùå Error exporting translators');
      console.error(err);
    } finally {
      setExportingTranslators(false);
      setTimeout(() => setExportProgress(''), 3000);
    }
  };

  const exportFinancialReport = async (format = 'csv') => {
    setExportingFinancial(true);
    setExportProgress('Generating financial report...');
    try {
      const response = await axios.get(`${API}/admin/orders?admin_key=${adminKey}`);
      const projects = response.data.orders || response.data || [];
      const reportData = projects.map(p => ({
        order_number: p.order_number,
        client_name: p.client_name,
        document_type: p.document_type || p.service_type,
        base_price: p.base_price || 0,
        urgency_fee: p.urgency_fee || 0,
        total_price: p.total_price || 0,
        payment_status: p.payment_status,
        payment_method: p.payment_method,
        created_at: p.created_at,
        delivered_at: p.delivered_at
      }));
      if (format === 'csv') exportToCSV(reportData, 'financial_report');
      else exportToJSON(reportData, 'financial_report');
      setExportProgress('‚úÖ Financial report exported! Check your Downloads folder.');
    } catch (err) {
      setExportProgress('‚ùå Error exporting report');
      console.error(err);
    } finally {
      setExportingFinancial(false);
      setTimeout(() => setExportProgress(''), 3000);
    }
  };

  const createFullBackup = async () => {
    setCreatingBackup(true);
    setExportProgress('Creating full backup...');
    try {
      // Fetch all data
      setExportProgress('Fetching projects...');
      const ordersRes = await axios.get(`${API}/admin/orders?admin_key=${adminKey}`);

      setExportProgress('Fetching users...');
      const usersRes = await axios.get(`${API}/admin/users?admin_key=${adminKey}`);

      setExportProgress('Fetching translators...');
      const translatorsRes = await axios.get(`${API}/admin/users/by-role/translator?admin_key=${adminKey}`);

      const backupData = {
        backup_date: new Date().toISOString(),
        backup_version: '1.0',
        data: {
          projects: ordersRes.data.orders || ordersRes.data || [],
          users: usersRes.data || [],
          translators: translatorsRes.data || []
        },
        stats: {
          total_projects: (ordersRes.data.orders || ordersRes.data || []).length,
          total_users: (usersRes.data || []).length,
          total_translators: (translatorsRes.data || []).length
        }
      };

      exportToJSON(backupData, 'full_backup');
      setExportProgress('‚úÖ Full backup created! The file was saved to your Downloads folder.');
    } catch (err) {
      setExportProgress('‚ùå Error creating backup');
      console.error(err);
    } finally {
      setCreatingBackup(false);
      setTimeout(() => setExportProgress(''), 5000);
    }
  };

  // Download source code as ZIP
  const downloadSourceCode = async () => {
    setDownloadingSource(true);
    setExportProgress('Downloading source code...');
    try {
      const response = await axios.get(`${API}/admin/backup/source-code?admin_key=${adminKey}`, {
        responseType: 'blob'
      });
      const url = window.URL.createObjectURL(new Blob([response.data]));
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', `legacy_portal_source_${new Date().toISOString().split('T')[0]}.zip`);
      document.body.appendChild(link);
      link.click();
      link.remove();
      setExportProgress('‚úÖ Source code downloaded! Check your Downloads folder.');
    } catch (err) {
      setExportProgress('‚ùå Error downloading source code');
      console.error(err);
    } finally {
      setDownloadingSource(false);
      setTimeout(() => setExportProgress(''), 5000);
    }
  };

  // Fetch restore points
  const fetchRestorePoints = async () => {
    setLoadingRestorePoints(true);
    try {
      const response = await axios.get(`${API}/admin/backup/restore-points?admin_key=${adminKey}`);
      setRestorePoints(response.data.restore_points || []);
    } catch (err) {
      console.error('Error fetching restore points:', err);
    } finally {
      setLoadingRestorePoints(false);
    }
  };

  // Create restore point
  const createRestorePoint = async () => {
    setCreatingRestorePoint(true);
    setExportProgress('Creating restore point...');
    try {
      const response = await axios.post(`${API}/admin/backup/restore-point?admin_key=${adminKey}`, {
        name: restorePointName || '',
        description: ''
      });
      setExportProgress(`‚úÖ Restore point created: ${response.data.name}`);
      setRestorePointName('');
      fetchRestorePoints();
    } catch (err) {
      setExportProgress('‚ùå Error creating restore point');
      console.error(err);
    } finally {
      setCreatingRestorePoint(false);
      setTimeout(() => setExportProgress(''), 5000);
    }
  };

  // Restore from a restore point
  const restoreFromPoint = async (restorePointId) => {
    setRestoringFrom(restorePointId);
    setExportProgress('Restoring database...');
    try {
      const response = await axios.post(`${API}/admin/backup/restore/${restorePointId}?admin_key=${adminKey}`, {
        confirm: true
      });
      setExportProgress(`‚úÖ ${response.data.message}. Auto-backup created.`);
      setShowRestoreConfirm(null);
      fetchRestorePoints();
    } catch (err) {
      setExportProgress('‚ùå Error restoring: ' + (err.response?.data?.detail || err.message));
      console.error(err);
    } finally {
      setRestoringFrom(null);
      setTimeout(() => setExportProgress(''), 8000);
    }
  };

  // Delete restore point
  const deleteRestorePoint = async (restorePointId) => {
    if (!window.confirm('Delete this restore point?')) return;
    try {
      await axios.delete(`${API}/admin/backup/restore-point/${restorePointId}?admin_key=${adminKey}`);
      fetchRestorePoints();
    } catch (err) {
      showToast('Error deleting restore point');
      console.error(err);
    }
  };

  // Load restore points on mount
  useEffect(() => {
    fetchRestorePoints();
  }, [adminKey]);

  // Permissions matrix data
  const PERMISSIONS = {
    roles: ['Administrator', 'Project Manager', 'Sales', 'Translator'],
    permissions: [
      { name: 'Projects', desc: 'View and manage projects', admin: true, pm: true, sales: true, translator: false },
      { name: 'Create Projects', desc: 'Create new projects', admin: true, pm: true, sales: true, translator: false },
      { name: 'Assign Translator', desc: 'Assign translators to projects', admin: true, pm: true, sales: false, translator: false },
      { name: 'Translation Tool', desc: 'Access translation workspace', admin: true, pm: true, sales: false, translator: true },
      { name: 'Review Translation', desc: 'Review and approve translations', admin: true, pm: true, sales: false, translator: false },
      { name: 'Send to Client', desc: 'Send completed work to client', admin: true, pm: true, sales: false, translator: false },
      { name: 'Clients', desc: 'View client profiles', admin: true, pm: true, sales: true, translator: false },
      { name: 'Translators', desc: 'View translator profiles', admin: true, pm: true, sales: false, translator: false },
      { name: 'Register Translators', desc: 'Add new translators', admin: true, pm: true, sales: false, translator: false },
      { name: 'Delete Translators', desc: 'Remove translators', admin: true, pm: false, sales: false, translator: false },
      { name: 'Finances', desc: 'View financial reports', admin: true, pm: false, sales: false, translator: false },
      { name: 'Reports', desc: 'Access analytics and reports', admin: true, pm: false, sales: false, translator: false },
      { name: 'Settings', desc: 'Manage system settings', admin: true, pm: false, sales: false, translator: false },
      { name: 'User Management', desc: 'Create and manage users', admin: true, pm: false, sales: false, translator: false },
    ]
  };

  return (
    <div className="p-4 space-y-6">
      <h1 className="text-lg font-bold text-blue-600 mb-4">SETTINGS</h1>

      {/* Permissions Matrix */}
      <div className="bg-white rounded shadow overflow-hidden">
        <div className="p-4 border-b bg-gray-50">
          <h2 className="text-sm font-bold text-gray-800">Role Permissions Matrix</h2>
          <p className="text-xs text-gray-500 mt-1">Only Administrator can modify role permissions</p>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-xs">
            <thead>
              <tr className="bg-gray-100">
                <th className="text-left p-3 font-semibold text-gray-700 border-b">Permission</th>
                <th className="text-center p-3 font-semibold text-gray-700 border-b w-24">Admin</th>
                <th className="text-center p-3 font-semibold text-gray-700 border-b w-24">PM</th>
                <th className="text-center p-3 font-semibold text-gray-700 border-b w-24">Sales</th>
                <th className="text-center p-3 font-semibold text-gray-700 border-b w-24">Translator</th>
              </tr>
            </thead>
            <tbody>
              {PERMISSIONS.permissions.map((perm, idx) => (
                <tr key={perm.name} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                  <td className="p-3 border-b">
                    <div className="font-medium text-gray-800">{perm.name}</div>
                    <div className="text-[10px] text-gray-500">{perm.desc}</div>
                  </td>
                  <td className={`p-3 border-b text-center ${perm.admin ? 'bg-green-50' : 'bg-red-50'}`}>
                    <span className={`px-2 py-0.5 rounded text-[10px] font-medium ${perm.admin ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                      {perm.admin ? 'Yes' : 'No'}
                    </span>
                  </td>
                  <td className={`p-3 border-b text-center ${perm.pm ? 'bg-green-50' : 'bg-red-50'}`}>
                    <span className={`px-2 py-0.5 rounded text-[10px] font-medium ${perm.pm ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                      {perm.pm ? 'Yes' : 'No'}
                    </span>
                  </td>
                  <td className={`p-3 border-b text-center ${perm.sales ? 'bg-green-50' : 'bg-red-50'}`}>
                    <span className={`px-2 py-0.5 rounded text-[10px] font-medium ${perm.sales ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                      {perm.sales ? 'Yes' : 'No'}
                    </span>
                  </td>
                  <td className={`p-3 border-b text-center ${perm.translator ? 'bg-green-50' : 'bg-red-50'}`}>
                    <span className={`px-2 py-0.5 rounded text-[10px] font-medium ${perm.translator ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                      {perm.translator ? 'Yes' : 'No'}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      <div className="grid grid-cols-2 gap-4">
        {/* API Configuration */}
        <div className="bg-white rounded shadow p-4">
          <h2 className="text-sm font-bold text-gray-800 mb-3">API Configuration</h2>
          <div className="space-y-2 text-xs">
            <div>
              <label className="block text-gray-500 mb-1">API URL</label>
              <input type="text" className="w-full px-2 py-1.5 border rounded bg-gray-50" value={API} readOnly />
            </div>
            <div>
              <label className="block text-gray-500 mb-1">Admin Key</label>
              <input type="password" className="w-full px-2 py-1.5 border rounded bg-gray-50" value={adminKey} readOnly />
            </div>
          </div>
        </div>

        {/* Pricing */}
        <div className="bg-white rounded shadow p-4">
          <h2 className="text-sm font-bold text-gray-800 mb-3">Pricing</h2>
          <div className="space-y-1 text-xs">
            <div className="flex justify-between p-2 bg-gray-50 rounded">
              <span>Certified Translation</span>
              <span className="font-bold text-blue-600">$24.99/page</span>
            </div>
            <div className="flex justify-between p-2 bg-gray-50 rounded">
              <span>Professional Translation</span>
              <span className="font-bold text-blue-600">$19.50/page</span>
            </div>
            <div className="flex justify-between p-2 bg-gray-50 rounded">
              <span>Priority Fee</span>
              <span className="font-bold text-blue-600">+25%</span>
            </div>
            <div className="flex justify-between p-2 bg-gray-50 rounded">
              <span>Urgent Fee</span>
              <span className="font-bold text-red-500">+100%</span>
            </div>
          </div>
        </div>

        {/* Integrations */}
        <div className="bg-white rounded shadow p-4">
          <h2 className="text-sm font-bold text-gray-800 mb-3">Integrations</h2>
          <div className="space-y-2 text-xs">
            <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
              <div className="flex items-center">
                <span className="mr-2">üí≥</span>
                <span>Stripe</span>
              </div>
              <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px] font-medium">Connected</span>
            </div>
            <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
              <div className="flex items-center">
                <span className="mr-2">üìß</span>
                <span>Resend Email</span>
              </div>
              <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px] font-medium">Connected</span>
            </div>
            {/* QuickBooks Integration */}
            <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
              <div className="flex items-center">
                <span className="mr-2">üìä</span>
                <div>
                  <span>QuickBooks Online</span>
                  {qbStatus.connected && qbStatus.company_name && (
                    <span className="text-[10px] text-gray-500 ml-1">({qbStatus.company_name})</span>
                  )}
                </div>
              </div>
              {qbStatus.loading ? (
                <span className="px-2 py-0.5 bg-gray-100 text-gray-500 rounded text-[10px]">Checking...</span>
              ) : qbStatus.connected ? (
                <div className="flex items-center space-x-2">
                  <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px] font-medium">Connected</span>
                  <button
                    onClick={disconnectQuickBooks}
                    className="px-2 py-0.5 bg-red-100 text-red-600 rounded text-[10px] hover:bg-red-200"
                  >
                    Disconnect
                  </button>
                </div>
              ) : (
                <button
                  onClick={connectQuickBooks}
                  disabled={qbConnecting}
                  className="px-3 py-1 bg-green-600 text-white rounded text-[10px] font-medium hover:bg-green-700 disabled:bg-gray-300"
                >
                  {qbConnecting ? 'Connecting...' : 'Connect'}
                </button>
              )}
            </div>
          </div>
        </div>

        {/* Workflow Info */}
        <div className="bg-white rounded shadow p-4">
          <h2 className="text-sm font-bold text-gray-800 mb-3">Workflow Status Legend</h2>
          <div className="space-y-1 text-xs">
            <div className="flex items-center justify-between p-2 bg-gray-100 rounded">
              <span>Received</span>
              <span className="text-gray-600">Awaiting assignment</span>
            </div>
            <div className="flex items-center justify-between p-2 bg-yellow-50 rounded">
              <span>In Translation</span>
              <span className="text-yellow-700">Translator working</span>
            </div>
            <div className="flex items-center justify-between p-2 bg-blue-50 rounded">
              <span>PM Review</span>
              <span className="text-blue-700">PM reviewing</span>
            </div>
            <div className="flex items-center justify-between p-2 bg-blue-50 rounded">
              <span>Client Review</span>
              <span className="text-blue-700">Client reviewing</span>
            </div>
            <div className="flex items-center justify-between p-2 bg-green-50 rounded">
              <span>Ready</span>
              <span className="text-green-700">Ready to deliver</span>
            </div>
            <div className="flex items-center justify-between p-2 bg-blue-50 rounded">
              <span>Delivered</span>
              <span className="text-blue-700">Sent to client</span>
            </div>
          </div>
        </div>
      </div>

      {/* Export & Backup Section */}
      <div className="bg-white rounded shadow overflow-hidden">
        <div className="p-4 border-b bg-gray-50">
          <h2 className="text-sm font-bold text-gray-800">Export & Backup</h2>
          <p className="text-xs text-gray-500 mt-1">Export data or create a full system backup</p>
        </div>
        <div className="p-4">
          {exportProgress && (
            <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-xs text-blue-700">
              {exportProgress}
            </div>
          )}

          <div className="grid grid-cols-2 gap-4">
            {/* Export Projects */}
            <div className="border rounded p-3">
              <h3 className="text-xs font-semibold text-gray-700 mb-2">Export Projects</h3>
              <p className="text-[10px] text-gray-500 mb-3">Download all project data including status, client info, and pricing</p>
              <div className="flex space-x-2">
                <button
                  onClick={() => exportProjects('csv')}
                  disabled={exportingProjects}
                  className="flex-1 px-2 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:bg-gray-300"
                >
                  {exportingProjects ? 'Exporting...' : 'CSV'}
                </button>
                <button
                  onClick={() => exportProjects('json')}
                  disabled={exportingProjects}
                  className="flex-1 px-2 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:bg-gray-300"
                >
                  {exportingProjects ? 'Exporting...' : 'JSON'}
                </button>
              </div>
            </div>

            {/* Export Clients */}
            <div className="border rounded p-3">
              <h3 className="text-xs font-semibold text-gray-700 mb-2">Export Clients</h3>
              <p className="text-[10px] text-gray-500 mb-3">Download client contact info, phone numbers, and order history</p>
              <div className="flex space-x-2">
                <button
                  onClick={() => exportClients('csv')}
                  disabled={exportingClients}
                  className="flex-1 px-2 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:bg-gray-300"
                >
                  {exportingClients ? 'Exporting...' : 'CSV'}
                </button>
                <button
                  onClick={() => exportClients('json')}
                  disabled={exportingClients}
                  className="flex-1 px-2 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:bg-gray-300"
                >
                  {exportingClients ? 'Exporting...' : 'JSON'}
                </button>
              </div>
            </div>

            {/* Export Translators */}
            <div className="border rounded p-3">
              <h3 className="text-xs font-semibold text-gray-700 mb-2">Export Translators</h3>
              <p className="text-[10px] text-gray-500 mb-3">Download translator profiles, language pairs, and rates</p>
              <div className="flex space-x-2">
                <button
                  onClick={() => exportTranslators('csv')}
                  disabled={exportingTranslators}
                  className="flex-1 px-2 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:bg-gray-300"
                >
                  {exportingTranslators ? 'Exporting...' : 'CSV'}
                </button>
                <button
                  onClick={() => exportTranslators('json')}
                  disabled={exportingTranslators}
                  className="flex-1 px-2 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:bg-gray-300"
                >
                  {exportingTranslators ? 'Exporting...' : 'JSON'}
                </button>
              </div>
            </div>

            {/* Export Financial Report */}
            <div className="border rounded p-3">
              <h3 className="text-xs font-semibold text-gray-700 mb-2">Financial Report</h3>
              <p className="text-[10px] text-gray-500 mb-3">Download financial data including pricing and payment status</p>
              <div className="flex space-x-2">
                <button
                  onClick={() => exportFinancialReport('csv')}
                  disabled={exportingFinancial}
                  className="flex-1 px-2 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:bg-gray-300"
                >
                  {exportingFinancial ? 'Exporting...' : 'CSV'}
                </button>
                <button
                  onClick={() => exportFinancialReport('json')}
                  disabled={exportingFinancial}
                  className="flex-1 px-2 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:bg-gray-300"
                >
                  {exportingFinancial ? 'Exporting...' : 'JSON'}
                </button>
              </div>
            </div>
          </div>

          {/* Full Backup */}
          <div className="mt-4 border-t pt-4">
            <div className="border rounded p-4 bg-gray-50">
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="text-xs font-semibold text-gray-700">Full System Backup</h3>
                  <p className="text-[10px] text-gray-500 mt-1">Create a complete backup of all projects, users, and translators in JSON format</p>
                  <p className="text-[10px] text-blue-600 mt-1">Files are saved to your browser's Downloads folder</p>
                </div>
                <button
                  onClick={createFullBackup}
                  disabled={creatingBackup}
                  className="px-4 py-2 bg-slate-700 text-white text-xs rounded hover:bg-slate-800 disabled:bg-gray-300 flex items-center"
                >
                  {creatingBackup ? (
                    <>
                      <svg className="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      Creating...
                    </>
                  ) : (
                    <>
                      <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                      </svg>
                      Create Backup
                    </>
                  )}
                </button>
              </div>
            </div>

            {/* Download Source Code */}
            <div className="border rounded p-4 bg-blue-50 mt-4">
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="text-xs font-semibold text-gray-700">Download Source Code</h3>
                  <p className="text-[10px] text-gray-500 mt-1">Download Python backend and React frontend as ZIP file</p>
                </div>
                <button
                  onClick={downloadSourceCode}
                  disabled={downloadingSource}
                  className="px-4 py-2 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:bg-gray-300 flex items-center"
                >
                  {downloadingSource ? (
                    <>
                      <svg className="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      Downloading...
                    </>
                  ) : (
                    <>
                      <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                      </svg>
                      Download ZIP
                    </>
                  )}
                </button>
              </div>
            </div>
          </div>

          {/* Restore Points Section */}
          <div className="mt-6 border-t pt-4">
            <h3 className="text-sm font-bold text-gray-700 mb-3">Restore Points</h3>
            <p className="text-xs text-gray-500 mb-4">Create restore points to save the current state of your database. You can restore to any previous point if needed.</p>

            {/* Create Restore Point */}
            <div className="flex items-center space-x-2 mb-4">
              <input
                type="text"
                placeholder="Restore point name (optional)"
                value={restorePointName}
                onChange={(e) => setRestorePointName(e.target.value)}
                className="flex-1 px-3 py-2 border rounded text-xs"
              />
              <button
                onClick={createRestorePoint}
                disabled={creatingRestorePoint}
                className="px-4 py-2 bg-green-600 text-white text-xs rounded hover:bg-green-700 disabled:bg-gray-300 flex items-center whitespace-nowrap"
              >
                {creatingRestorePoint ? (
                  <>
                    <svg className="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Creating...
                  </>
                ) : (
                  <>+ Create Restore Point</>
                )}
              </button>
            </div>

            {/* Restore Points List */}
            <div className="space-y-2 max-h-64 overflow-y-auto">
              {loadingRestorePoints ? (
                <p className="text-xs text-gray-500 text-center py-4">Loading restore points...</p>
              ) : restorePoints.length === 0 ? (
                <p className="text-xs text-gray-500 text-center py-4">No restore points created yet.</p>
              ) : (
                restorePoints.map((rp) => (
                  <div key={rp.id} className={`border rounded p-3 ${rp.is_auto_backup ? 'bg-yellow-50 border-yellow-200' : 'bg-white'}`}>
                    <div className="flex items-center justify-between">
                      <div>
                        <div className="flex items-center">
                          <span className="text-xs font-medium text-gray-800">{rp.name}</span>
                          {rp.is_auto_backup && (
                            <span className="ml-2 px-1.5 py-0.5 bg-yellow-200 text-yellow-800 text-[10px] rounded">Auto</span>
                          )}
                        </div>
                        <div className="text-[10px] text-gray-500 mt-1">
                          {new Date(rp.created_at).toLocaleString('en-US', { timeZone: 'America/New_York' })} |
                          {rp.stats?.orders_count || 0} orders, {rp.stats?.users_count || 0} users
                        </div>
                      </div>
                      <div className="flex items-center space-x-2">
                        {showRestoreConfirm === rp.id ? (
                          <>
                            <span className="text-[10px] text-red-600 mr-2">Are you sure?</span>
                            <button
                              onClick={() => restoreFromPoint(rp.id)}
                              disabled={restoringFrom === rp.id}
                              className="px-2 py-1 bg-red-600 text-white text-[10px] rounded hover:bg-red-700 disabled:bg-gray-300"
                            >
                              {restoringFrom === rp.id ? 'Restoring...' : 'Yes, Restore'}
                            </button>
                            <button
                              onClick={() => setShowRestoreConfirm(null)}
                              className="px-2 py-1 bg-gray-300 text-gray-700 text-[10px] rounded hover:bg-gray-400"
                            >
                              Cancel
                            </button>
                          </>
                        ) : (
                          <>
                            <button
                              onClick={() => setShowRestoreConfirm(rp.id)}
                              className="px-2 py-1 bg-blue-600 text-white text-[10px] rounded hover:bg-blue-700"
                            >
                              Restore
                            </button>
                            <button
                              onClick={() => deleteRestorePoint(rp.id)}
                              className="px-2 py-1 bg-red-100 text-red-600 text-[10px] rounded hover:bg-red-200"
                            >
                              Delete
                            </button>
                          </>
                        )}
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>

            <div className="mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded">
              <p className="text-[10px] text-yellow-800">
                <strong>Warning:</strong> Restoring from a point will overwrite all current data. An automatic backup is created before each restore.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// ==================== TRANSLATOR LOGIN (Blue Design) ====================
const TranslatorLogin = ({ onLogin }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [showForgotPassword, setShowForgotPassword] = useState(false);
  const [resetEmail, setResetEmail] = useState('');
  const [resetSent, setResetSent] = useState(false);
  const [resetLoading, setResetLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      const response = await axios.post(`${API}/admin/auth/login`, { email, password });
      if (response.data && response.data.token) {
        // Only allow translators to login here
        if (response.data.role !== 'translator') {
          setError('This portal is for translators only. Please use the admin panel.');
          setLoading(false);
          return;
        }
        onLogin({
          adminKey: response.data.token,
          token: response.data.token,
          role: response.data.role,
          name: response.data.name,
          email: response.data.email,
          id: response.data.id,
          translator_type: response.data.translator_type
        });
      }
    } catch (err) {
      setError(err.response?.data?.detail || 'Invalid credentials');
    } finally {
      setLoading(false);
    }
  };

  const handleForgotPassword = async (e) => {
    e.preventDefault();
    setResetLoading(true);
    try {
      await axios.post(`${API}/admin/auth/forgot-password`, { email: resetEmail });
      setResetSent(true);
    } catch (err) {
      setError(err.response?.data?.detail || 'Failed to send reset email');
    } finally {
      setResetLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-500 via-blue-600 to-blue-700 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
        {/* Blue Header with Globe */}
        <div className="bg-gradient-to-b from-blue-500 to-blue-600 py-8 px-4 text-center">
          {/* Globe Icon */}
          <div className="mb-3">
            <div className="w-16 h-16 mx-auto">
              <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="#4FC3F7"/>
                <ellipse cx="50" cy="50" rx="18" ry="45" stroke="white" strokeWidth="1.5" fill="none"/>
                <line x1="5" y1="50" x2="95" y2="50" stroke="white" strokeWidth="1.5"/>
                <ellipse cx="50" cy="28" rx="38" ry="10" stroke="white" strokeWidth="1.5" fill="none"/>
                <ellipse cx="50" cy="72" rx="38" ry="10" stroke="white" strokeWidth="1.5" fill="none"/>
                {/* Land masses */}
                <path d="M28 32 Q34 26 46 30 Q52 34 48 44 Q42 48 34 44 Q28 38 28 32Z" fill="#4CAF50"/>
                <path d="M56 22 Q68 18 76 26 Q80 36 72 42 Q62 40 54 34 Q50 28 56 22Z" fill="#4CAF50"/>
                <path d="M22 54 Q30 50 42 54 Q48 60 44 70 Q34 74 26 68 Q18 62 22 54Z" fill="#4CAF50"/>
                <path d="M58 56 Q70 52 80 60 Q84 70 76 76 Q64 78 56 72 Q52 64 58 56Z" fill="#4CAF50"/>
              </svg>
            </div>
          </div>
          <h1 className="text-xl font-semibold text-white">Legacy Translations</h1>
        </div>

        {/* Form */}
        <div className="p-8">
          {showForgotPassword ? (
            // Forgot Password Form
            <div>
              <h2 className="text-lg font-medium text-gray-800 text-center mb-6">Reset Password</h2>

              {resetSent ? (
                <div className="text-center">
                  <div className="text-green-600 mb-4">
                    <svg className="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  </div>
                  <p className="text-gray-600 mb-4">If an account exists with this email, you will receive a password reset link.</p>
                  <button
                    onClick={() => { setShowForgotPassword(false); setResetSent(false); setResetEmail(''); }}
                    className="text-blue-600 hover:text-blue-700 font-medium"
                  >
                    Back to Login
                  </button>
                </div>
              ) : (
                <form onSubmit={handleForgotPassword} className="space-y-4">
                  <p className="text-sm text-gray-600 text-center mb-4">
                    Enter your email address and we'll send you a link to reset your password.
                  </p>

                  {error && (
                    <div className="p-3 bg-red-100 text-red-700 rounded-lg text-sm text-center">
                      {error}
                    </div>
                  )}

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input
                      type="email"
                      required
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      value={resetEmail}
                      onChange={(e) => setResetEmail(e.target.value)}
                    />
                  </div>

                  <button
                    type="submit"
                    disabled={resetLoading}
                    className="w-full py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 disabled:from-gray-400 disabled:to-gray-500 font-medium transition-all"
                  >
                    {resetLoading ? 'Sending...' : 'Send Reset Link'}
                  </button>

                  <button
                    type="button"
                    onClick={() => { setShowForgotPassword(false); setError(''); }}
                    className="w-full py-3 text-gray-600 hover:text-gray-800 font-medium"
                  >
                    Back to Login
                  </button>
                </form>
              )}
            </div>
          ) : (
            // Login Form
            <div>
              {error && (
                <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm text-center">
                  {error}
                </div>
              )}

              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
                  <input
                    type="email"
                    required
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                  <input
                    type="password"
                    required
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                  />
                </div>

                <button
                  type="submit"
                  disabled={loading}
                  className="w-full py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 disabled:from-gray-400 disabled:to-gray-500 font-medium transition-all"
                >
                  {loading ? 'Logging in...' : 'Login'}
                </button>
              </form>

              <div className="mt-6 text-center">
                <button
                  onClick={() => { setShowForgotPassword(true); setError(''); }}
                  className="text-blue-600 hover:text-blue-700 text-sm hover:underline"
                >
                  Forgot password?
                </button>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// ==================== TRANSLATION TOOL PAGE (Standalone) ====================
const TranslationToolPage = ({ adminKey, onLogout, user }) => {
  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header */}
      <div className="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 py-3 flex items-center justify-between shadow-md">
        <div className="flex items-center space-x-3">
          <div className="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
            <svg className="w-6 h-6" viewBox="0 0 100 100" fill="white">
              <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" strokeWidth="3"/>
              <ellipse cx="50" cy="50" rx="20" ry="45" stroke="currentColor" strokeWidth="2" fill="none"/>
              <line x1="5" y1="50" x2="95" y2="50" stroke="currentColor" strokeWidth="2"/>
            </svg>
          </div>
          <div>
            <div className="font-bold">Translation Tool</div>
            <div className="text-xs text-blue-200">Legacy Translations</div>
          </div>
        </div>
        <div className="flex items-center space-x-4">
          <span className="text-sm text-blue-200">
            Welcome, <span className="text-white font-medium">{user?.name || 'Translator'}</span>
          </span>
          <button
            onClick={onLogout}
            className="px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition-colors"
          >
            Logout
          </button>
        </div>
      </div>
      {/* Translation Workspace */}
      <TranslationWorkspace adminKey={adminKey} user={user} />
    </div>
  );
};

// ==================== REVIEW PAGE (Pending Translations & Security) ====================
const ReviewPage = ({ adminKey, user }) => {
  const [pendingSubmissions, setPendingSubmissions] = useState([]);
  const [suspiciousUsers, setSuspiciousUsers] = useState([]);
  const [loginAttempts, setLoginAttempts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedSubmission, setSelectedSubmission] = useState(null);
  const [selectedUserIpHistory, setSelectedUserIpHistory] = useState(null);
  const [ipHistoryData, setIpHistoryData] = useState([]);
  const [activeSection, setActiveSection] = useState('submissions'); // 'submissions' | 'security'
  const [revisionNote, setRevisionNote] = useState('');

  // New states for side-by-side view
  const [fullScreenReview, setFullScreenReview] = useState(false);
  const [editedTranslation, setEditedTranslation] = useState('');
  const [currentImageIndex, setCurrentImageIndex] = useState(0);
  const [saving, setSaving] = useState(false);
  const [filterPM, setFilterPM] = useState('all'); // 'all' or PM id
  const [pmList, setPmList] = useState([]);

  const isAdmin = user?.role === 'admin';
  const isPM = user?.role === 'pm';

  const fetchPendingSubmissions = async () => {
    try {
      // Admin sees all, PM sees only their assigned projects
      const endpoint = isAdmin
        ? `${API}/admin/translations/pending-review?admin_key=${adminKey}`
        : `${API}/admin/translations/pending-review?admin_key=${adminKey}&pm_id=${user?.id}`;
      const response = await axios.get(endpoint);
      setPendingSubmissions(response.data || []);

      // Extract unique PMs for filter dropdown (admin only)
      if (isAdmin && response.data) {
        const pms = [...new Set(response.data.map(s => s.assigned_pm_name).filter(Boolean))];
        setPmList(pms);
      }
    } catch (err) {
      console.error('Failed to fetch pending submissions:', err);
    }
  };

  const fetchSuspiciousUsers = async () => {
    try {
      const response = await axios.get(`${API}/admin/security/suspicious-users?admin_key=${adminKey}&token=${user?.token}`);
      setSuspiciousUsers(response.data || []);
    } catch (err) {
      console.error('Failed to fetch suspicious users:', err);
    }
  };

  const fetchLoginAttempts = async () => {
    try {
      const response = await axios.get(`${API}/admin/login-attempts?admin_key=${adminKey}&token=${user?.token}&limit=50`);
      setLoginAttempts(response.data || []);
    } catch (err) {
      console.error('Failed to fetch login attempts:', err);
    }
  };

  const fetchUserIpHistory = async (userId) => {
    try {
      const response = await axios.get(`${API}/admin/users/${userId}/ip-history?admin_key=${adminKey}&token=${user?.token}`);
      setIpHistoryData(response.data || []);
      setSelectedUserIpHistory(userId);
    } catch (err) {
      console.error('Failed to fetch IP history:', err);
    }
  };

  useEffect(() => {
    const loadData = async () => {
      setLoading(true);
      try {
        await fetchPendingSubmissions();
        if (isAdmin) {
          await Promise.all([
            fetchSuspiciousUsers(),
            fetchLoginAttempts()
          ]);
        }
      } catch (err) {
        console.error('Error loading review data:', err);
      } finally {
        setLoading(false);
      }
    };
    if (adminKey) {
      loadData();
    }
  }, [adminKey]);

  // Load translation content when submission is selected
  useEffect(() => {
    if (selectedSubmission) {
      setEditedTranslation(selectedSubmission.translation_html || selectedSubmission.translated_text || '');
      setCurrentImageIndex(0);
    }
  }, [selectedSubmission]);

  const handleApproveSubmission = async (submissionId) => {
    try {
      // If translation was edited, save it first
      if (editedTranslation !== (selectedSubmission.translation_html || selectedSubmission.translated_text)) {
        await axios.put(`${API}/admin/translations/submission/${submissionId}/update?admin_key=${adminKey}`, {
          translation_html: editedTranslation
        });
      }

      await axios.post(`${API}/admin/translations/submission/${submissionId}/approve?admin_key=${adminKey}&token=${user?.token}`);
      fetchPendingSubmissions();
      setSelectedSubmission(null);
      setFullScreenReview(false);
      showToast('Translation approved and sent to client!');
    } catch (err) {
      showToast('Error approving: ' + (err.response?.data?.detail || err.message));
    }
  };

  const handleRequestRevision = async (submissionId) => {
    if (!revisionNote.trim()) {
      showToast('Please add a note explaining the corrections needed.');
      return;
    }
    try {
      await axios.post(`${API}/admin/translations/submission/${submissionId}/request-revision?admin_key=${adminKey}&token=${user?.token}`, {
        note: revisionNote
      });
      fetchPendingSubmissions();
      setSelectedSubmission(null);
      setRevisionNote('');
      setFullScreenReview(false);
      showToast('Revision requested from translator!');
    } catch (err) {
      showToast('Error: ' + (err.response?.data?.detail || err.message));
    }
  };

  const handleSaveEdits = async () => {
    if (!selectedSubmission) return;
    setSaving(true);
    try {
      await axios.put(`${API}/admin/translations/submission/${selectedSubmission._id}/update?admin_key=${adminKey}`, {
        translation_html: editedTranslation
      });
      showToast('Changes saved!');
      fetchPendingSubmissions();
    } catch (err) {
      showToast('Error saving: ' + (err.response?.data?.detail || err.message));
    } finally {
      setSaving(false);
    }
  };

  // Filter submissions based on selected PM
  const filteredSubmissions = filterPM === 'all'
    ? pendingSubmissions
    : pendingSubmissions.filter(s => s.assigned_pm_name === filterPM);

  if (loading) {
    return (
      <div className="p-6 flex items-center justify-center">
        <div className="text-gray-500">Loading...</div>
      </div>
    );
  }

  // Full-screen side-by-side review mode
  if (fullScreenReview && selectedSubmission) {
    const originalImages = selectedSubmission.original_images || [];
    const hasMultiplePages = originalImages.length > 1;

    return (
      <div className="fixed inset-0 bg-gray-900 z-50 flex flex-col">
        {/* Header */}
        <div className="bg-gray-800 text-white px-4 py-3 flex items-center justify-between">
          <div className="flex items-center space-x-4">
            <button
              onClick={() => setFullScreenReview(false)}
              className="px-3 py-1 bg-gray-700 rounded hover:bg-gray-600 text-sm"
            >
              ‚Üê Back to List
            </button>
            <span className="font-bold">{selectedSubmission.order_number}</span>
            <span className="text-gray-400">|</span>
            <span className="text-sm text-gray-300">Translator: {selectedSubmission.translator_name}</span>
            {selectedSubmission.assigned_pm_name && (
              <>
                <span className="text-gray-400">|</span>
                <span className="text-sm text-gray-300">PM: {selectedSubmission.assigned_pm_name}</span>
              </>
            )}
          </div>
          <div className="flex items-center space-x-2">
            <button
              onClick={handleSaveEdits}
              disabled={saving}
              className="px-4 py-1.5 bg-blue-600 rounded hover:bg-blue-700 text-sm disabled:bg-gray-600"
            >
              {saving ? 'Saving...' : 'Save Edits'}
            </button>
            <button
              onClick={() => handleApproveSubmission(selectedSubmission._id)}
              className="px-4 py-1.5 bg-green-600 rounded hover:bg-green-700 text-sm"
            >
              ‚úì Approve
            </button>
            <button
              onClick={() => {
                const note = prompt('Enter revision note for translator:');
                if (note) {
                  setRevisionNote(note);
                  handleRequestRevision(selectedSubmission._id);
                }
              }}
              className="px-4 py-1.5 bg-blue-500 rounded hover:bg-blue-600 text-sm"
            >
              ‚Üª Request Revision
            </button>
          </div>
        </div>

        {/* Side-by-side content */}
        <div className="flex-1 flex overflow-hidden">
          {/* Left panel - Original document */}
          <div className="w-1/2 flex flex-col border-r border-gray-700">
            <div className="bg-gray-800 text-white px-4 py-2 text-sm font-medium flex items-center justify-between">
              <span>Original Document</span>
              {hasMultiplePages && (
                <div className="flex items-center space-x-2">
                  <button
                    onClick={() => setCurrentImageIndex(Math.max(0, currentImageIndex - 1))}
                    disabled={currentImageIndex === 0}
                    className="px-2 py-1 bg-gray-700 rounded disabled:opacity-50"
                  >
                    ‚Üê
                  </button>
                  <span className="text-xs">Page {currentImageIndex + 1} of {originalImages.length}</span>
                  <button
                    onClick={() => setCurrentImageIndex(Math.min(originalImages.length - 1, currentImageIndex + 1))}
                    disabled={currentImageIndex === originalImages.length - 1}
                    className="px-2 py-1 bg-gray-700 rounded disabled:opacity-50"
                  >
                    ‚Üí
                  </button>
                </div>
              )}
            </div>
            <div className="flex-1 overflow-auto bg-gray-100 p-4">
              {originalImages.length > 0 ? (
                <img
                  src={originalImages[currentImageIndex]?.data || originalImages[currentImageIndex]}
                  alt={`Original page ${currentImageIndex + 1}`}
                  className="max-w-full mx-auto shadow-lg"
                />
              ) : (
                <div className="flex items-center justify-center h-full text-gray-500">
                  No original images available
                </div>
              )}
            </div>
          </div>

          {/* Right panel - Translation (editable) */}
          <div className="w-1/2 flex flex-col">
            <div className="bg-gray-800 text-white px-4 py-2 text-sm font-medium flex items-center justify-between">
              <span>Translation (Editable)</span>
              <span className="text-xs text-gray-400">Click to edit</span>
            </div>
            <div className="flex-1 overflow-auto bg-white">
              <div
                contentEditable
                className="min-h-full p-6 outline-none prose max-w-none"
                dangerouslySetInnerHTML={{ __html: extractBodyForEdit(editedTranslation) }}
                onBlur={(e) => setEditedTranslation(e.target.innerHTML)}
                style={{ minHeight: '100%' }}
              />
            </div>
          </div>
        </div>

        {/* Footer with notes */}
        {selectedSubmission.translator_notes && (
          <div className="bg-gray-800 text-white px-4 py-2 text-xs">
            <span className="text-gray-400">Translator notes:</span> {selectedSubmission.translator_notes}
          </div>
        )}
      </div>
    );
  }

  return (
    <div className="p-4 bg-gray-50 min-h-screen">
      {/* Header */}
      <div className="bg-white rounded-lg shadow p-4 mb-4">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-lg font-bold text-gray-800">Review Panel</h1>
            <p className="text-xs text-gray-500">
              {isAdmin
                ? 'Review translations from all PMs and translators'
                : 'Review translations assigned to you'}
            </p>
          </div>
          {/* PM Filter (Admin only) */}
          {isAdmin && pmList.length > 0 && (
            <div className="flex items-center space-x-2">
              <label className="text-xs text-gray-500">Filter by PM:</label>
              <select
                value={filterPM}
                onChange={(e) => setFilterPM(e.target.value)}
                className="border rounded px-2 py-1 text-sm"
              >
                <option value="all">All PMs ({pendingSubmissions.length})</option>
                {pmList.map(pm => (
                  <option key={pm} value={pm}>
                    {pm} ({pendingSubmissions.filter(s => s.assigned_pm_name === pm).length})
                  </option>
                ))}
              </select>
            </div>
          )}
        </div>
      </div>

      {/* Tab navigation */}
      <div className="flex gap-2 mb-4">
        <button
          onClick={() => setActiveSection('submissions')}
          className={`px-4 py-2 text-sm font-medium rounded ${activeSection === 'submissions' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}`}
        >
          Pending Reviews ({filteredSubmissions.length})
        </button>
        {isAdmin && (
          <button
            onClick={() => setActiveSection('security')}
            className={`px-4 py-2 text-sm font-medium rounded ${activeSection === 'security' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}`}
          >
            Security {suspiciousUsers.length > 0 && <span className="ml-1 bg-red-500 text-white px-1.5 rounded-full text-xs">{suspiciousUsers.length}</span>}
          </button>
        )}
      </div>

      {/* Submissions Section */}
      {activeSection === 'submissions' && (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
          {/* Pending submissions list */}
          <div className="bg-white rounded-lg shadow p-4">
            <h2 className="text-sm font-bold text-gray-700 mb-3">Translations to Review</h2>
            {filteredSubmissions.length === 0 ? (
              <p className="text-gray-500 text-sm">No pending translations to review.</p>
            ) : (
              <div className="space-y-2 max-h-[600px] overflow-y-auto">
                {filteredSubmissions.map((sub) => (
                  <div
                    key={sub._id}
                    onClick={() => setSelectedSubmission(sub)}
                    className={`p-3 border rounded cursor-pointer hover:bg-gray-50 ${selectedSubmission?._id === sub._id ? 'border-blue-500 bg-blue-50' : ''}`}
                  >
                    <div className="flex justify-between items-start">
                      <div>
                        <div className="font-medium text-sm">{sub.order_number}</div>
                        <div className="text-xs text-gray-500">Translator: {sub.translator_name}</div>
                        {isAdmin && sub.assigned_pm_name && (
                          <div className="text-xs text-blue-600">PM: {sub.assigned_pm_name}</div>
                        )}
                      </div>
                      <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded">
                        Pending
                      </span>
                    </div>
                    <div className="text-xs text-gray-400 mt-1">
                      {new Date(sub.submitted_at).toLocaleDateString('en-US', { timeZone: 'America/New_York' })}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Selected submission details */}
          <div className="lg:col-span-2 bg-white rounded-lg shadow p-4">
            {selectedSubmission ? (
              <>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-sm font-bold text-gray-700">{selectedSubmission.order_number}</h2>
                  <button
                    onClick={() => setFullScreenReview(true)}
                    className="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 flex items-center"
                  >
                    <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                    </svg>
                    Open Side-by-Side Review
                  </button>
                </div>

                <div className="grid grid-cols-2 gap-4 mb-4">
                  <div className="space-y-2 text-xs">
                    <div><span className="text-gray-500">Translator:</span> {selectedSubmission.translator_name}</div>
                    <div><span className="text-gray-500">Client:</span> {selectedSubmission.client_name || 'N/A'}</div>
                    <div><span className="text-gray-500">Submitted:</span> {new Date(selectedSubmission.submitted_at).toLocaleString('en-US', { timeZone: 'America/New_York' })}</div>
                  </div>
                  <div className="space-y-2 text-xs">
                    <div><span className="text-gray-500">Pages:</span> {selectedSubmission.pages_count || 'N/A'}</div>
                    {isAdmin && <div><span className="text-gray-500">Assigned PM:</span> {selectedSubmission.assigned_pm_name || 'N/A'}</div>}
                    <div><span className="text-gray-500">Document:</span> {selectedSubmission.document_type || 'N/A'}</div>
                  </div>
                </div>

                {selectedSubmission.translator_notes && (
                  <div className="bg-blue-50 p-3 rounded mb-4">
                    <div className="text-xs font-medium text-blue-700 mb-1">Translator Notes:</div>
                    <div className="text-sm text-blue-800">{selectedSubmission.translator_notes}</div>
                  </div>
                )}

                {/* Preview */}
                <div className="grid grid-cols-2 gap-4 mb-4">
                  {/* Original preview */}
                  <div className="border rounded p-2">
                    <div className="text-xs font-medium text-gray-500 mb-2">Original (Preview)</div>
                    {selectedSubmission.original_images?.length > 0 ? (
                      <img
                        src={selectedSubmission.original_images[0]?.data || selectedSubmission.original_images[0]}
                        alt="Original"
                        className="w-full h-40 object-contain bg-gray-100"
                      />
                    ) : (
                      <div className="h-40 bg-gray-100 flex items-center justify-center text-gray-400 text-sm">
                        No preview
                      </div>
                    )}
                  </div>
                  {/* Translation preview */}
                  <div className="border rounded p-2">
                    <div className="text-xs font-medium text-gray-500 mb-2">Translation (Preview)</div>
                    <div
                      className="h-40 overflow-hidden bg-gray-50 p-2 text-xs"
                      dangerouslySetInnerHTML={{ __html: selectedSubmission.translation_html || selectedSubmission.translated_text || '<em>No translation content</em>' }}
                    />
                  </div>
                </div>

                {/* Revision note input */}
                <div className="mb-4">
                  <label className="block text-xs text-gray-500 mb-1">Revision note (if needed):</label>
                  <textarea
                    value={revisionNote}
                    onChange={(e) => setRevisionNote(e.target.value)}
                    className="w-full border rounded p-2 text-sm"
                    rows={2}
                    placeholder="Describe corrections needed..."
                  />
                </div>

                {/* Action buttons */}
                <div className="flex gap-2">
                  <button
                    onClick={() => handleApproveSubmission(selectedSubmission._id)}
                    className="flex-1 py-2 bg-green-600 text-white rounded text-sm font-medium hover:bg-green-700"
                  >
                    ‚úì Approve & Send to Client
                  </button>
                  <button
                    onClick={() => handleRequestRevision(selectedSubmission._id)}
                    className="flex-1 py-2 bg-blue-500 text-white rounded text-sm font-medium hover:bg-blue-600"
                  >
                    ‚Üª Request Revision
                  </button>
                </div>
              </>
            ) : (
              <div className="text-gray-500 text-sm text-center py-16">
                <svg className="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Select a translation to review
              </div>
            )}
          </div>
        </div>
      )}

      {/* Security Section (Admin only) */}
      {activeSection === 'security' && isAdmin && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
          {/* Suspicious Users */}
          <div className="bg-white rounded-lg shadow p-4">
            <h2 className="text-sm font-bold text-gray-700 mb-3">Suspicious Users (Multiple IPs)</h2>
            <p className="text-xs text-gray-500 mb-3">Users who accessed from more than 3 different IPs.</p>
            {suspiciousUsers.length === 0 ? (
              <p className="text-gray-500 text-sm">No suspicious users detected.</p>
            ) : (
              <div className="space-y-2 max-h-[400px] overflow-y-auto">
                {suspiciousUsers.map((usr) => (
                  <div
                    key={usr._id}
                    className="p-3 border rounded bg-red-50 border-red-200"
                  >
                    <div className="flex justify-between items-start">
                      <div>
                        <div className="font-medium text-sm">{usr.name}</div>
                        <div className="text-xs text-gray-500">{usr.email}</div>
                      </div>
                      <span className="text-xs bg-red-200 text-red-700 px-2 py-0.5 rounded">
                        {usr.unique_ips} IPs
                      </span>
                    </div>
                    <button
                      onClick={() => fetchUserIpHistory(usr._id)}
                      className="mt-2 text-xs text-blue-600 hover:underline"
                    >
                      View IP history ‚Üí
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* IP History / Login Attempts */}
          <div className="bg-white rounded-lg shadow p-4">
            {selectedUserIpHistory ? (
              <>
                <div className="flex justify-between items-center mb-3">
                  <h2 className="text-sm font-bold text-gray-700">IP History</h2>
                  <button
                    onClick={() => setSelectedUserIpHistory(null)}
                    className="text-xs text-gray-500 hover:text-gray-700"
                  >
                    ‚úï Close
                  </button>
                </div>
                <div className="space-y-2 max-h-[400px] overflow-y-auto">
                  {ipHistoryData.map((entry, idx) => (
                    <div key={idx} className="p-2 border rounded text-xs">
                      <div className="font-mono">{entry.ip}</div>
                      <div className="text-gray-500">{entry.user_agent}</div>
                      <div className="text-gray-400">{new Date(entry.timestamp).toLocaleString('en-US', { timeZone: 'America/New_York' })}</div>
                    </div>
                  ))}
                </div>
              </>
            ) : (
              <>
                <h2 className="text-sm font-bold text-gray-700 mb-3">Recent Logins</h2>
                <div className="space-y-2 max-h-[400px] overflow-y-auto">
                  {loginAttempts.map((attempt, idx) => (
                    <div key={idx} className="p-2 border rounded text-xs flex justify-between items-center">
                      <div>
                        <div className="font-medium">{attempt.user_name || attempt.email}</div>
                        <div className="font-mono text-gray-500">{attempt.ip}</div>
                      </div>
                      <div className="text-right">
                        <span className={`px-2 py-0.5 rounded ${attempt.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                          {attempt.success ? 'OK' : 'Failed'}
                        </span>
                        <div className="text-gray-400 mt-1">{new Date(attempt.timestamp).toLocaleString('en-US', { timeZone: 'America/New_York' })}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

// ==================== USERS MANAGEMENT PAGE ====================
const UsersPage = ({ adminKey, user }) => {
  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showCreateForm, setShowCreateForm] = useState(false);
  const [newUser, setNewUser] = useState({ name: '', email: '', role: 'translator', rate_per_page: '', rate_per_word: '', language_pairs: '', translator_type: 'contractor' });
  const [creating, setCreating] = useState(false);
  const [expandedUser, setExpandedUser] = useState(null);
  const [userDocuments, setUserDocuments] = useState({});
  const [uploadingDoc, setUploadingDoc] = useState(false);
  const [search, setSearch] = useState('');
  const [editingUser, setEditingUser] = useState(null);
  const [editForm, setEditForm] = useState({});
  const [savingUser, setSavingUser] = useState(false);

  const isAdmin = user?.role === 'admin';
  const isPM = user?.role === 'pm';

  // Document types for translators
  const TRANSLATOR_DOC_TYPES = [
    { value: 'id_document', label: 'Documento de Identidade (RG/ID)' },
    { value: 'cpf', label: 'CPF' },
    { value: 'address_proof', label: 'Proof de Resid√™ncia' },
    { value: 'contract', label: 'Contrato de Presta√ß√£o de Servi√ßo' },
    { value: 'bank_info', label: 'Dados Banc√°rios' },
    { value: 'certification', label: 'Certifica√ß√£o/Diploma' },
    { value: 'portfolio', label: 'Portf√≥lio/Amostras' },
    { value: 'other', label: 'Outro Documento' }
  ];

  const fetchUsers = async () => {
    try {
      const response = await axios.get(`${API}/admin/users?admin_key=${adminKey}&token=`);
      setUsers(response.data);
    } catch (err) {
      console.error('Error fetching users:', err);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { fetchUsers(); }, [adminKey]);

  // Fetch documents for a specific user
  const fetchUserDocuments = async (userId) => {
    try {
      const response = await axios.get(`${API}/admin/users/${userId}/documents?admin_key=${adminKey}`);
      setUserDocuments(prev => ({ ...prev, [userId]: response.data.documents || [] }));
    } catch (err) {
      console.error('Error fetching user documents:', err);
      setUserDocuments(prev => ({ ...prev, [userId]: [] }));
    }
  };

  // Start editing a user
  const startEditUser = (u) => {
    setEditingUser(u.id);
    setEditForm({
      name: u.name || '',
      email: u.email || '',
      role: u.role || '',
      rate_per_page: u.rate_per_page || '',
      rate_per_word: u.rate_per_word || '',
      language_pairs: u.language_pairs || '',
      translator_type: u.translator_type || 'contractor'
    });
  };

  // Cancel editing
  const cancelEditUser = () => {
    setEditingUser(null);
    setEditForm({});
  };

  // Save user edits
  const saveUserEdits = async (userId) => {
    setSavingUser(true);
    try {
      const updateData = {};
      if (editForm.name) updateData.name = editForm.name;
      if (editForm.email) updateData.email = editForm.email;
      if (editForm.role) updateData.role = editForm.role;
      if (editForm.rate_per_page !== '') updateData.rate_per_page = parseFloat(editForm.rate_per_page);
      if (editForm.rate_per_word !== '') updateData.rate_per_word = parseFloat(editForm.rate_per_word);
      if (editForm.language_pairs !== undefined) updateData.language_pairs = editForm.language_pairs;
      if (editForm.translator_type) updateData.translator_type = editForm.translator_type;

      await axios.put(`${API}/admin/users/${userId}?admin_key=${adminKey}`, updateData);
      await fetchUsers();
      setEditingUser(null);
      setEditForm({});
      showToast('Perfil atualizado successfully!');
    } catch (err) {
      console.error('Error updating user:', err);
      showToast(err.response?.data?.detail || 'Error updating profile');
    } finally {
      setSavingUser(false);
    }
  };

  // Upload document for a user
  const handleUploadDocument = async (userId, file, docType) => {
    if (!file) return;
    setUploadingDoc(true);
    try {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('document_type', docType);
      await axios.post(`${API}/admin/users/${userId}/documents?admin_key=${adminKey}`, formData, {
        headers: { 'Content-Type': 'multipart/form-data' }
      });
      await fetchUserDocuments(userId);
      showToast('Document sent successfully!');
    } catch (err) {
      console.error('Error uploading document:', err);
      showToast('Error uploading document');
    } finally {
      setUploadingDoc(false);
    }
  };

  // Download document
  const handleDownloadDocument = async (userId, docId, filename) => {
    try {
      const response = await axios.get(`${API}/admin/users/${userId}/documents/${docId}/download?admin_key=${adminKey}`);
      const link = document.createElement('a');
      link.href = `data:${response.data.content_type};base64,${response.data.file_data}`;
      link.download = filename;
      link.click();
    } catch (err) {
      console.error('Error downloading document:', err);
      showToast('Error downloading document');
    }
  };

  // Delete document
  const handleDeleteDocument = async (userId, docId) => {
    if (!window.confirm('Excluir este document?')) return;
    try {
      await axios.delete(`${API}/admin/users/${userId}/documents/${docId}?admin_key=${adminKey}`);
      await fetchUserDocuments(userId);
    } catch (err) {
      console.error('Error deleting document:', err);
      showToast('Error deleting document');
    }
  };

  // Toggle expanded user profile
  const toggleExpandUser = async (userId) => {
    if (expandedUser === userId) {
      setExpandedUser(null);
    } else {
      setExpandedUser(userId);
      if (!userDocuments[userId]) {
        await fetchUserDocuments(userId);
      }
    }
  };

  const handleCreateUser = async (e) => {
    e.preventDefault();
    setCreating(true);
    try {
      // Build user data - password will be set by user via invitation email
      const userData = {
        name: newUser.name,
        email: newUser.email,
        role: newUser.role,
        rate_per_page: newUser.rate_per_page ? parseFloat(newUser.rate_per_page) : null,
        rate_per_word: newUser.rate_per_word ? parseFloat(newUser.rate_per_word) : null,
        language_pairs: newUser.language_pairs || null,
        translator_type: newUser.translator_type || 'contractor'
      };
      const response = await axios.post(`${API}/admin/auth/register?admin_key=${adminKey}`, userData);

      // Show invitation link for manual sharing (email may go to spam)
      if (response.data?.invitation_link) {
        const copyLink = window.confirm(
          `‚úÖ ${response.data.message}\n\n` +
          `‚ö†Ô∏è The email may go to spam. Copy the invite link?\n\n` +
          `Link: ${response.data.invitation_link}`
        );
        if (copyLink) {
          navigator.clipboard.writeText(response.data.invitation_link);
          showToast('Link copied! Send it to the user via WhatsApp or another method.');
        }
      } else {
        showToast(response.data?.message || 'User created!');
      }

      setNewUser({ name: '', email: '', role: 'translator', rate_per_page: '', rate_per_word: '', language_pairs: '', translator_type: 'contractor' });
      setShowCreateForm(false);
      fetchUsers();
    } catch (err) {
      showToast(err.response?.data?.detail || 'Error creating user');
    } finally {
      setCreating(false);
    }
  };

  const handleToggleActive = async (userId) => {
    try {
      await axios.put(`${API}/admin/users/${userId}/toggle-active?admin_key=${adminKey}`);
      fetchUsers();
    } catch (err) {
      showToast('Error toggling user status');
    }
  };

  const handleDeleteUser = async (userId, userName) => {
    if (!window.confirm(`Delete user "${userName}"?`)) return;
    try {
      await axios.delete(`${API}/admin/users/${userId}?admin_key=${adminKey}`);
      fetchUsers();
    } catch (err) {
      showToast('Error deleting user');
    }
  };

  const handleResendInvitation = async (userId, userName, userEmail) => {
    if (!window.confirm(`Resend invite to "${userName}" (${userEmail})?`)) return;
    try {
      const response = await axios.post(`${API}/admin/auth/resend-invitation?admin_key=${adminKey}`, {
        user_id: userId
      });

      // Show link for manual sharing
      if (response.data?.invitation_link) {
        const copyLink = window.confirm(
          `‚úÖ ${response.data.message}\n\n` +
          `‚ö†Ô∏è The email may go to spam. Copy the invite link?\n\n` +
          `Link: ${response.data.invitation_link}`
        );
        if (copyLink) {
          navigator.clipboard.writeText(response.data.invitation_link);
          showToast('Link copied! Send it to the user via WhatsApp or another method.');
        }
      } else {
        showToast(response.data?.message || 'Invite resent!');
      }
    } catch (err) {
      showToast(err.response?.data?.detail || 'Error resending invite');
    }
  };

  const roleColors = {
    admin: 'bg-red-100 text-red-800',
    pm: 'bg-blue-100 text-blue-800',
    translator: 'bg-green-100 text-green-800',
    sales: 'bg-blue-100 text-blue-800'
  };

  // PM can only see translators
  const baseFilteredUsers = isPM ? users.filter(u => u.role === 'translator') : users;

  // Apply search filter
  const filteredUsers = baseFilteredUsers.filter(u =>
    u.name?.toLowerCase().includes(search.toLowerCase()) ||
    u.email?.toLowerCase().includes(search.toLowerCase()) ||
    u.language_pairs?.toLowerCase().includes(search.toLowerCase())
  );

  if (loading) return <div className="p-6 text-center">Loading users...</div>;

  return (
    <div className="p-6">
      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-xl font-bold text-gray-800">{isPM ? 'üë• Translators' : 'üë§ User Management'}</h1>
          {isPM && <p className="text-xs text-gray-500 mt-1">Register and manage translators</p>}
        </div>
        <div className="flex items-center gap-3">
          {/* Search Input */}
          <div className="relative">
            <input
              type="text"
              placeholder="Buscar por nome, email ou idiomas..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="px-3 py-2 text-sm border rounded-lg w-64 pl-8"
            />
            <SearchIcon className="w-4 h-4 absolute left-2 top-2.5 text-gray-400" />
          </div>
          <button
            onClick={() => setShowCreateForm(!showCreateForm)}
            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"
          >
            + {isPM ? 'Register Translator' : 'Create User'}
          </button>
        </div>
      </div>

      {/* Create User Form */}
      {showCreateForm && (
        <div className="bg-white p-4 rounded-lg shadow mb-6">
          <h3 className="font-bold text-sm mb-3">{isPM ? 'Register New Translator' : 'Create New User'}</h3>
          <form onSubmit={handleCreateUser} className="space-y-3">
            <div className="grid grid-cols-3 gap-3">
              <input
                type="text"
                placeholder="Name"
                value={newUser.name}
                onChange={(e) => setNewUser({...newUser, name: e.target.value})}
                required
                className="px-3 py-2 text-sm border rounded"
              />
              <input
                type="email"
                placeholder="Email"
                value={newUser.email}
                onChange={(e) => setNewUser({...newUser, email: e.target.value})}
                required
                className="px-3 py-2 text-sm border rounded"
              />
              {isPM ? (
                <input type="hidden" value="translator" />
              ) : (
                <select
                  value={newUser.role}
                  onChange={(e) => setNewUser({...newUser, role: e.target.value})}
                  className="px-3 py-2 text-sm border rounded"
                >
                  <option value="translator">Translator</option>
                  <option value="pm">Project Manager</option>
                  <option value="sales">Sales</option>
                  <option value="admin">Admin</option>
                </select>
              )}
            </div>
            <p className="text-xs text-gray-500 mt-1">An invitation email will be sent to set up the password</p>

            {/* Translator Pricing - always show for translators */}
            {(newUser.role === 'translator' || isPM) && (
              <>
                <div className="grid grid-cols-4 gap-3 pt-2 border-t">
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">Translator Type</label>
                    <select
                      value={newUser.translator_type || 'contractor'}
                      onChange={(e) => setNewUser({...newUser, translator_type: e.target.value})}
                      className="w-full px-3 py-2 text-sm border rounded"
                    >
                      <option value="contractor">Contractor (Limited)</option>
                      <option value="in_house">In-House (Full Access)</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">Rate per Page ($)</label>
                    <input
                      type="number"
                      step="0.01"
                      placeholder="e.g. 15.00"
                      value={newUser.rate_per_page}
                      onChange={(e) => setNewUser({...newUser, rate_per_page: e.target.value})}
                      className="w-full px-3 py-2 text-sm border rounded"
                    />
                  </div>
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">Rate per Word ($)</label>
                    <input
                      type="number"
                      step="0.001"
                      placeholder="e.g. 0.08"
                      value={newUser.rate_per_word}
                      onChange={(e) => setNewUser({...newUser, rate_per_word: e.target.value})}
                      className="w-full px-3 py-2 text-sm border rounded"
                    />
                  </div>
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">Language Pairs</label>
                    <input
                      type="text"
                      placeholder="e.g. EN-PT, ES-EN"
                      value={newUser.language_pairs}
                      onChange={(e) => setNewUser({...newUser, language_pairs: e.target.value})}
                      className="w-full px-3 py-2 text-sm border rounded"
                    />
                  </div>
                </div>
                <p className="text-[10px] text-gray-400 mt-1">
                  <strong>Contractor:</strong> Limited access (START + DELIVER tabs only) |
                  <strong> In-House:</strong> Full access (START, TRANSLATION, REVIEW, DELIVER tabs)
                </p>
              </>
            )}

            <div className="flex justify-end gap-2">
              <button type="button" onClick={() => setShowCreateForm(false)} className="px-4 py-2 text-gray-600 text-sm">Cancel</button>
              <button type="submit" disabled={creating} className="px-4 py-2 bg-blue-600 text-white rounded text-sm disabled:bg-gray-400">
                {creating ? 'Creating...' : 'Create'}
              </button>
            </div>
          </form>
        </div>
      )}

      {/* Users Table */}
      <div className="bg-white rounded-lg shadow overflow-hidden">
        <table className="w-full text-sm">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 text-left font-medium text-gray-700">Name</th>
              <th className="px-4 py-3 text-left font-medium text-gray-700">Email</th>
              <th className="px-4 py-3 text-left font-medium text-gray-700">Role</th>
              <th className="px-4 py-3 text-left font-medium text-gray-700">Type</th>
              <th className="px-4 py-3 text-left font-medium text-gray-700">Rate/Page</th>
              <th className="px-4 py-3 text-left font-medium text-gray-700">Languages</th>
              <th className="px-4 py-3 text-left font-medium text-gray-700">Status</th>
              <th className="px-4 py-3 text-left font-medium text-gray-700">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200">
            {filteredUsers.map((u) => (
              <React.Fragment key={u.id}>
                <tr className={`hover:bg-gray-50 ${expandedUser === u.id ? 'bg-blue-50' : ''}`}>
                  <td className="px-4 py-3 font-medium">
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => toggleExpandUser(u.id)}
                        className={`text-gray-400 hover:text-blue-600 transition-transform ${expandedUser === u.id ? 'rotate-90' : ''}`}
                      >
                        ‚ñ∂
                      </button>
                      {u.name}
                    </div>
                  </td>
                  <td className="px-4 py-3 text-gray-600">{u.email}</td>
                  <td className="px-4 py-3">
                    <span className={`px-2 py-1 rounded text-xs font-medium ${roleColors[u.role]}`}>
                      {u.role.toUpperCase()}
                    </span>
                  </td>
                  <td className="px-4 py-3">
                    {u.role === 'translator' ? (
                      <span className={`px-2 py-1 rounded text-xs font-medium ${
                        u.translator_type === 'in_house'
                          ? 'bg-blue-100 text-blue-800'
                          : 'bg-orange-100 text-orange-800'
                      }`}>
                        {u.translator_type === 'in_house' ? 'In-House' : 'Contractor'}
                      </span>
                    ) : (
                      <span className="text-gray-400">-</span>
                    )}
                  </td>
                  <td className="px-4 py-3 text-gray-600">
                    {u.rate_per_page ? `$${u.rate_per_page}` : '-'}
                  </td>
                  <td className="px-4 py-3 text-gray-600 text-xs">
                    {u.language_pairs || '-'}
                  </td>
                  <td className="px-4 py-3">
                    {u.invitation_pending ? (
                      <span className="px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-800">
                        Pending Invitation
                      </span>
                    ) : (
                      <span className={`px-2 py-1 rounded text-xs ${u.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                        {u.is_active ? 'Active' : 'Inactive'}
                      </span>
                    )}
                  </td>
                  <td className="px-4 py-3 space-x-2">
                    <button
                      onClick={() => toggleExpandUser(u.id)}
                      className="text-blue-600 hover:text-blue-800 text-xs"
                    >
                      {expandedUser === u.id ? 'Fechar' : 'Ver Perfil'}
                    </button>
                    {u.invitation_pending && (
                      <button
                        onClick={() => handleResendInvitation(u.id, u.name, u.email)}
                        className="text-blue-600 hover:text-blue-800 text-xs"
                      >
                        Resend Invitation
                      </button>
                    )}
                    {isAdmin && (
                      <button
                        onClick={() => handleToggleActive(u.id)}
                        className="text-blue-600 hover:text-blue-800 text-xs"
                      >
                        {u.is_active ? 'Deactivate' : 'Activate'}
                      </button>
                    )}
                    {isAdmin && (
                      <button
                        onClick={() => handleDeleteUser(u.id, u.name)}
                        className="text-red-600 hover:text-red-800 text-xs"
                      >
                        Delete
                      </button>
                    )}
                  </td>
                </tr>

                {/* Expanded Profile Section */}
                {expandedUser === u.id && (
                  <tr>
                    <td colSpan="7" className="px-4 py-4 bg-gray-50">
                      <div className="grid grid-cols-2 gap-6">
                        {/* Profile Information */}
                        <div className="bg-white rounded-lg p-4 border">
                          <div className="flex justify-between items-center mb-3">
                            <h4 className="font-bold text-sm text-gray-800 flex items-center gap-2">
                              üìã Informa√ß√µes do Perfil
                            </h4>
                            {isAdmin && editingUser !== u.id && (
                              <button
                                onClick={() => startEditUser(u)}
                                className="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center gap-1"
                              >
                                ‚úèÔ∏è Editar
                              </button>
                            )}
                            {editingUser === u.id && (
                              <div className="flex gap-2">
                                <button
                                  onClick={() => saveUserEdits(u.id)}
                                  disabled={savingUser}
                                  className="px-2 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600 disabled:bg-gray-400"
                                >
                                  {savingUser ? '‚è≥...' : '‚úì Salvar'}
                                </button>
                                <button
                                  onClick={cancelEditUser}
                                  className="px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600"
                                >
                                  ‚úï Cancelar
                                </button>
                              </div>
                            )}
                          </div>
                          <div className="grid grid-cols-2 gap-3 text-sm">
                            <div>
                              <span className="text-gray-500 text-xs">Nome Completo:</span>
                              {editingUser === u.id ? (
                                <input
                                  type="text"
                                  value={editForm.name}
                                  onChange={(e) => setEditForm({...editForm, name: e.target.value})}
                                  className="w-full px-2 py-1 text-sm border rounded"
                                />
                              ) : (
                                <div className="font-medium">{u.name}</div>
                              )}
                            </div>
                            <div>
                              <span className="text-gray-500 text-xs">Email:</span>
                              {editingUser === u.id ? (
                                <input
                                  type="email"
                                  value={editForm.email}
                                  onChange={(e) => setEditForm({...editForm, email: e.target.value})}
                                  className="w-full px-2 py-1 text-sm border rounded"
                                />
                              ) : (
                                <div className="font-medium">{u.email}</div>
                              )}
                            </div>
                            <div>
                              <span className="text-gray-500 text-xs">Fun√ß√£o:</span>
                              {editingUser === u.id ? (
                                <select
                                  value={editForm.role}
                                  onChange={(e) => setEditForm({...editForm, role: e.target.value})}
                                  className="w-full px-2 py-1 text-sm border rounded"
                                >
                                  <option value="translator">Translator</option>
                                  <option value="pm">PM</option>
                                  <option value="admin">Admin</option>
                                  <option value="sales">Sales</option>
                                </select>
                              ) : (
                                <div className="font-medium capitalize">{u.role}</div>
                              )}
                            </div>
                            <div>
                              <span className="text-gray-500 text-xs">Status:</span>
                              <div className={`font-medium ${u.is_active ? 'text-green-600' : 'text-red-600'}`}>
                                {u.is_active ? 'Ativo' : 'Inativo'}
                              </div>
                            </div>
                            {u.role === 'translator' && (
                              <div>
                                <span className="text-gray-500 text-xs">Tipo de Tradutor:</span>
                                {editingUser === u.id ? (
                                  <select
                                    value={editForm.translator_type || 'contractor'}
                                    onChange={(e) => setEditForm({...editForm, translator_type: e.target.value})}
                                    className="w-full px-2 py-1 text-sm border rounded"
                                  >
                                    <option value="contractor">Contractor (Limitado)</option>
                                    <option value="in_house">In-House (Acesso Completo)</option>
                                  </select>
                                ) : (
                                  <div className={`font-medium ${u.translator_type === 'in_house' ? 'text-blue-600' : 'text-orange-600'}`}>
                                    {u.translator_type === 'in_house' ? 'In-House' : 'Contractor'}
                                  </div>
                                )}
                              </div>
                            )}
                            <div>
                              <span className="text-gray-500 text-xs">Amount por P√°gina:</span>
                              {editingUser === u.id ? (
                                <input
                                  type="number"
                                  step="0.01"
                                  value={editForm.rate_per_page}
                                  onChange={(e) => setEditForm({...editForm, rate_per_page: e.target.value})}
                                  className="w-full px-2 py-1 text-sm border rounded"
                                  placeholder="Ex: 25.00"
                                />
                              ) : (
                                <div className="font-medium text-green-600">
                                  {u.rate_per_page ? `$${u.rate_per_page.toFixed(2)}` : 'N√£o definido'}
                                </div>
                              )}
                            </div>
                            <div>
                              <span className="text-gray-500 text-xs">Amount por Palavra:</span>
                              {editingUser === u.id ? (
                                <input
                                  type="number"
                                  step="0.001"
                                  value={editForm.rate_per_word}
                                  onChange={(e) => setEditForm({...editForm, rate_per_word: e.target.value})}
                                  className="w-full px-2 py-1 text-sm border rounded"
                                  placeholder="Ex: 0.08"
                                />
                              ) : (
                                <div className="font-medium text-green-600">
                                  {u.rate_per_word ? `$${u.rate_per_word.toFixed(3)}` : 'N√£o definido'}
                                </div>
                              )}
                            </div>
                            <div className="col-span-2">
                              <span className="text-gray-500 text-xs">Pares de Idiomas:</span>
                              {editingUser === u.id ? (
                                <input
                                  type="text"
                                  value={editForm.language_pairs}
                                  onChange={(e) => setEditForm({...editForm, language_pairs: e.target.value})}
                                  className="w-full px-2 py-1 text-sm border rounded"
                                  placeholder="Ex: Portuguese ‚Üí English, Spanish ‚Üí English"
                                />
                              ) : (
                                <div className="font-medium">
                                  {u.language_pairs ? (
                                    <div className="flex flex-wrap gap-1 mt-1">
                                      {u.language_pairs.split(',').map((pair, idx) => (
                                        <span key={idx} className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">
                                          {pair.trim()}
                                        </span>
                                      ))}
                                    </div>
                                  ) : 'N√£o definido'}
                                </div>
                              )}
                            </div>
                            <div>
                              <span className="text-gray-500 text-xs">P√°ginas Traduzidas:</span>
                              <div className="font-medium">{u.pages_translated || 0}</div>
                            </div>
                            <div>
                              <span className="text-gray-500 text-xs">Data de Cadastro:</span>
                              <div className="font-medium">
                                {u.created_at ? new Date(u.created_at).toLocaleDateString('en-US', { timeZone: 'America/New_York' }) : '-'}
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Documents Section */}
                        <div className="bg-white rounded-lg p-4 border">
                          <h4 className="font-bold text-sm text-gray-800 mb-3 flex items-center gap-2">
                            üìÅ Documentos Pessoais
                          </h4>

                          {/* Upload Section */}
                          {isAdmin && (
                            <div className="mb-4 p-3 bg-gray-50 rounded border-dashed border-2 border-gray-200">
                              <div className="flex items-center gap-2">
                                <select
                                  id={`doc-type-${u.id}`}
                                  className="px-2 py-1.5 text-xs border rounded flex-1"
                                  defaultValue=""
                                >
                                  <option value="" disabled>Tipo de document...</option>
                                  {TRANSLATOR_DOC_TYPES.map(dt => (
                                    <option key={dt.value} value={dt.value}>{dt.label}</option>
                                  ))}
                                </select>
                                <label className="px-3 py-1.5 bg-blue-500 text-white text-xs rounded cursor-pointer hover:bg-blue-600">
                                  {uploadingDoc ? '‚è≥...' : 'üì§ Upload'}
                                  <input
                                    type="file"
                                    className="hidden"
                                    accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                                    disabled={uploadingDoc}
                                    onChange={(e) => {
                                      const docType = document.getElementById(`doc-type-${u.id}`).value;
                                      if (!docType) {
                                        showToast('Select o tipo de document first');
                                        e.target.value = '';
                                        return;
                                      }
                                      handleUploadDocument(u.id, e.target.files[0], docType);
                                      e.target.value = '';
                                    }}
                                  />
                                </label>
                              </div>
                              <p className="text-[10px] text-gray-400 mt-1">PDF, DOC, JPG, PNG (max 10MB)</p>
                            </div>
                          )}

                          {/* Documents List */}
                          <div className="space-y-2 max-h-48 overflow-auto">
                            {userDocuments[u.id]?.length > 0 ? (
                              userDocuments[u.id].map((doc) => (
                                <div key={doc.id} className="flex items-center justify-between p-2 bg-gray-50 rounded border text-xs">
                                  <div className="flex items-center gap-2">
                                    <span className="text-lg">
                                      {doc.filename?.endsWith('.pdf') ? 'üìÑ' :
                                       doc.filename?.match(/\.(jpg|jpeg|png)$/i) ? 'üñºÔ∏è' : 'üìé'}
                                    </span>
                                    <div>
                                      <div className="font-medium">{doc.filename}</div>
                                      <div className="text-gray-400">
                                        {TRANSLATOR_DOC_TYPES.find(dt => dt.value === doc.document_type)?.label || doc.document_type}
                                        {doc.uploaded_at && ` ‚Ä¢ ${new Date(doc.uploaded_at).toLocaleDateString('en-US', { timeZone: 'America/New_York' })}`}
                                      </div>
                                    </div>
                                  </div>
                                  <div className="flex gap-1">
                                    <button
                                      onClick={() => handleDownloadDocument(u.id, doc.id, doc.filename)}
                                      className="px-2 py-1 bg-blue-100 text-blue-600 rounded hover:bg-blue-200"
                                    >
                                      ‚¨áÔ∏è
                                    </button>
                                    {isAdmin && (
                                      <button
                                        onClick={() => handleDeleteDocument(u.id, doc.id)}
                                        className="px-2 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200"
                                      >
                                        üóëÔ∏è
                                      </button>
                                    )}
                                  </div>
                                </div>
                              ))
                            ) : (
                              <div className="text-center py-4 text-gray-400 text-xs">
                                <div className="text-2xl mb-1">üì≠</div>
                                No document sent
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    </td>
                  </tr>
                )}
              </React.Fragment>
            ))}
          </tbody>
        </table>
        {filteredUsers.length === 0 && (
          <div className="p-6 text-center text-gray-500">No users found. Create your first user above.</div>
        )}
      </div>
    </div>
  );
};

// ==================== PRODUCTION & PAYMENTS PAGE ====================
const ProductionPage = ({ adminKey }) => {
  const [stats, setStats] = useState([]);
  const [payments, setPayments] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activeView, setActiveView] = useState('stats'); // stats, payments, response_times
  const [selectedTranslator, setSelectedTranslator] = useState(null);
  const [translatorOrders, setTranslatorOrders] = useState([]);
  const [showPaymentModal, setShowPaymentModal] = useState(false);
  const [partnerResponseTimes, setPartnerResponseTimes] = useState([]);
  const [selectedPartnerMessages, setSelectedPartnerMessages] = useState(null);
  const [paymentForm, setPaymentForm] = useState({
    translator_id: '',
    period_start: '',
    period_end: '',
    pages_count: 0,
    rate_per_page: 25.0,
    total_amount: 0,
    payment_method: '',
    payment_reference: '',
    notes: ''
  });

  const fetchStats = async () => {
    try {
      const response = await axios.get(`${API}/admin/production/stats?admin_key=${adminKey}`);
      setStats(response.data.stats || []);
    } catch (err) {
      console.error('Error fetching production stats:', err);
    }
  };

  const fetchPayments = async () => {
    try {
      const response = await axios.get(`${API}/admin/payments?admin_key=${adminKey}`);
      setPayments(response.data.payments || []);
    } catch (err) {
      console.error('Error fetching payments:', err);
    }
  };

  const fetchTranslatorOrders = async (translatorId) => {
    try {
      const response = await axios.get(`${API}/admin/production/translator/${translatorId}/orders?admin_key=${adminKey}&status=completed`);
      setTranslatorOrders(response.data.orders || []);
    } catch (err) {
      console.error('Error fetching translator orders:', err);
    }
  };

  const fetchPartnerResponseTimes = async () => {
    try {
      const response = await axios.get(`${API}/admin/partner-response-times?admin_key=${adminKey}`);
      setPartnerResponseTimes(response.data.partner_stats || []);
    } catch (err) {
      console.error('Error fetching partner response times:', err);
    }
  };

  useEffect(() => {
    const loadData = async () => {
      setLoading(true);
      await Promise.all([fetchStats(), fetchPayments(), fetchPartnerResponseTimes()]);
      setLoading(false);
    };
    loadData();
  }, [adminKey]);

  const handleSelectTranslator = async (translator) => {
    setSelectedTranslator(translator);
    await fetchTranslatorOrders(translator.translator_id);
  };

  const openPaymentModal = (translator) => {
    const today = new Date().toISOString().split('T')[0];
    const firstOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
    setPaymentForm({
      translator_id: translator.translator_id,
      period_start: firstOfMonth,
      period_end: today,
      pages_count: translator.pending_payment_pages || 0,
      rate_per_page: 25.0,
      total_amount: (translator.pending_payment_pages || 0) * 25.0,
      payment_method: 'bank_transfer',
      payment_reference: '',
      notes: ''
    });
    setShowPaymentModal(true);
  };

  const handleCreatePayment = async (e) => {
    e.preventDefault();
    try {
      await axios.post(`${API}/admin/payments?admin_key=${adminKey}`, paymentForm);
      setShowPaymentModal(false);
      fetchStats();
      fetchPayments();
      showToast('Payment registrado successfully!');
    } catch (err) {
      showToast(err.response?.data?.detail || 'Error registering payment');
    }
  };

  const handleMarkAsPaid = async (paymentId) => {
    if (!window.confirm('Confirm pagamento como completed?')) return;
    try {
      await axios.put(`${API}/admin/payments/${paymentId}?admin_key=${adminKey}`, { status: 'paid' });
      fetchPayments();
      fetchStats();
    } catch (err) {
      showToast('Error updating payment');
    }
  };

  const handleDeletePayment = async (paymentId) => {
    if (!window.confirm('Delete this payment record?')) return;
    try {
      await axios.delete(`${API}/admin/payments/${paymentId}?admin_key=${adminKey}`);
      fetchPayments();
      fetchStats();
    } catch (err) {
      showToast('Error deleting payment');
    }
  };

  const formatDate = (dateStr) => {
    return formatDateLocal(dateStr);
  };

  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
  };

  if (loading) return <div className="p-6 text-center">Loading statistics...</div>;

  return (
    <div className="p-6">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-xl font-bold text-gray-800">üìä Production & Payments</h1>
        <div className="flex space-x-2">
          <button
            onClick={() => setActiveView('stats')}
            className={`px-4 py-2 rounded text-sm ${activeView === 'stats' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
          >
            Statistics
          </button>
          <button
            onClick={() => setActiveView('payments')}
            className={`px-4 py-2 rounded text-sm ${activeView === 'payments' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
          >
            Payment History
          </button>
          <button
            onClick={() => setActiveView('response_times')}
            className={`px-4 py-2 rounded text-sm ${activeView === 'response_times' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
          >
            Partner Response Times
          </button>
        </div>
      </div>

      {activeView === 'stats' && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Translator Stats Cards */}
          <div className="bg-white rounded-lg shadow">
            <div className="p-4 border-b">
              <h2 className="text-sm font-bold text-gray-800">Translators</h2>
            </div>
            <div className="p-4 space-y-3">
              {stats.length === 0 ? (
                <div className="text-center text-gray-500 py-4">No translators found</div>
              ) : (
                stats.map((translator) => (
                  <div
                    key={translator.translator_id}
                    onClick={() => handleSelectTranslator(translator)}
                    className={`p-4 border rounded-lg cursor-pointer transition-colors ${
                      selectedTranslator?.translator_id === translator.translator_id
                        ? 'border-blue-500 bg-blue-50'
                        : 'border-gray-200 hover:border-teal-300'
                    }`}
                  >
                    <div className="flex justify-between items-start mb-3">
                      <div>
                        <div className="font-medium text-gray-800">{translator.translator_name}</div>
                        <div className="text-xs text-gray-500">{translator.translator_email}</div>
                      </div>
                      {translator.pending_payment_pages > 0 && (
                        <button
                          onClick={(e) => { e.stopPropagation(); openPaymentModal(translator); }}
                          className="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700"
                        >
                          Register Payment
                        </button>
                      )}
                    </div>
                    <div className="grid grid-cols-4 gap-2 text-center text-xs">
                      <div className="bg-gray-100 rounded p-2">
                        <div className="text-gray-500">Total</div>
                        <div className="font-bold text-gray-800">{translator.total_pages}</div>
                      </div>
                      <div className="bg-green-100 rounded p-2">
                        <div className="text-green-600">Completed</div>
                        <div className="font-bold text-green-700">{translator.completed_pages}</div>
                      </div>
                      <div className="bg-blue-100 rounded p-2">
                        <div className="text-blue-600">Paid</div>
                        <div className="font-bold text-blue-700">{translator.paid_pages}</div>
                      </div>
                      <div className="bg-yellow-100 rounded p-2">
                        <div className="text-yellow-600">To Pay</div>
                        <div className="font-bold text-yellow-700">{translator.pending_payment_pages}</div>
                      </div>
                    </div>
                    <div className="mt-2 text-xs text-gray-500">
                      {translator.completed_orders} of {translator.orders_count} projects completed
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>

          {/* Selected Translator Orders */}
          <div className="bg-white rounded-lg shadow">
            <div className="p-4 border-b">
              <h2 className="text-sm font-bold text-gray-800">
                {selectedTranslator ? `${selectedTranslator.translator_name}'s Projects` : 'Select a translator'}
              </h2>
            </div>
            <div className="p-4">
              {!selectedTranslator ? (
                <div className="text-center text-gray-500 py-8">
                  Click on a translator to view their projects
                </div>
              ) : translatorOrders.length === 0 ? (
                <div className="text-center text-gray-500 py-4">No completed projects</div>
              ) : (
                <div className="space-y-2 max-h-96 overflow-y-auto">
                  {translatorOrders.map((order) => (
                    <div key={order.id} className="p-3 border rounded-lg text-xs">
                      <div className="flex justify-between items-start">
                        <div>
                          <div className="font-medium text-gray-800">{order.order_number || order.reference}</div>
                          <div className="text-gray-500">{order.client_name}</div>
                        </div>
                        <div className="text-right">
                          <div className="font-bold text-blue-600">{order.page_count || 0} pages</div>
                          <div className="text-gray-500">{formatDate(order.created_at)}</div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {activeView === 'payments' && (
        <div className="bg-white rounded-lg shadow">
          <div className="p-4 border-b">
            <h2 className="text-sm font-bold text-gray-800">Payment History</h2>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-xs">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left font-medium text-gray-600">Translator</th>
                  <th className="px-4 py-3 text-left font-medium text-gray-600">Period</th>
                  <th className="px-4 py-3 text-center font-medium text-gray-600">Pages</th>
                  <th className="px-4 py-3 text-center font-medium text-gray-600">Amount</th>
                  <th className="px-4 py-3 text-center font-medium text-gray-600">Status</th>
                  <th className="px-4 py-3 text-center font-medium text-gray-600">Payment Date</th>
                  <th className="px-4 py-3 text-center font-medium text-gray-600">Actions</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {payments.length === 0 ? (
                  <tr>
                    <td colSpan="7" className="px-4 py-8 text-center text-gray-500">
                      No payments registered
                    </td>
                  </tr>
                ) : (
                  payments.map((payment) => (
                    <tr key={payment.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3">
                        <div className="font-medium text-gray-800">{payment.translator_name}</div>
                      </td>
                      <td className="px-4 py-3">
                        {formatDate(payment.period_start)} - {formatDate(payment.period_end)}
                      </td>
                      <td className="px-4 py-3 text-center">{payment.pages_count}</td>
                      <td className="px-4 py-3 text-center font-bold text-blue-600">
                        {formatCurrency(payment.total_amount)}
                      </td>
                      <td className="px-4 py-3 text-center">
                        <span className={`px-2 py-1 rounded text-xs ${
                          payment.status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                        }`}>
                          {payment.status === 'paid' ? 'Pago' : 'Pendente'}
                        </span>
                      </td>
                      <td className="px-4 py-3 text-center">
                        {payment.payment_date ? formatDate(payment.payment_date) : '-'}
                      </td>
                      <td className="px-4 py-3 text-center space-x-2">
                        {payment.status !== 'paid' && (
                          <button
                            onClick={() => handleMarkAsPaid(payment.id)}
                            className="text-green-600 hover:text-green-800"
                          >
                            Confirm
                          </button>
                        )}
                        <button
                          onClick={() => handleDeletePayment(payment.id)}
                          className="text-red-600 hover:text-red-800"
                        >
                          Delete
                        </button>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Partner Response Times View */}
      {activeView === 'response_times' && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Partner Stats Cards */}
          <div className="bg-white rounded-lg shadow">
            <div className="p-4 border-b">
              <h2 className="text-sm font-bold text-gray-800">Partner Message Response Times</h2>
              <p className="text-xs text-gray-500 mt-1">Track how quickly we respond to partner messages</p>
            </div>
            <div className="p-4 space-y-3 max-h-[600px] overflow-y-auto">
              {partnerResponseTimes.length === 0 ? (
                <div className="text-center text-gray-500 py-4">No partner messages found</div>
              ) : (
                partnerResponseTimes.map((partner) => (
                  <div
                    key={partner.partner_id}
                    onClick={() => setSelectedPartnerMessages(partner)}
                    className={`p-4 border rounded-lg cursor-pointer transition-colors ${
                      selectedPartnerMessages?.partner_id === partner.partner_id
                        ? 'border-purple-500 bg-blue-50'
                        : 'border-gray-200 hover:border-purple-300'
                    }`}
                  >
                    <div className="flex justify-between items-start mb-3">
                      <div>
                        <div className="font-medium text-gray-800">{partner.partner_name}</div>
                        <div className="text-xs text-gray-500">{partner.partner_email}</div>
                      </div>
                      {partner.pending_messages > 0 && (
                        <span className="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-bold">
                          {partner.pending_messages} Pending
                        </span>
                      )}
                    </div>
                    <div className="grid grid-cols-3 gap-2 text-center text-xs">
                      <div className="bg-blue-50 rounded p-2">
                        <div className="font-bold text-blue-700">{partner.total_messages}</div>
                        <div className="text-gray-500">Total</div>
                      </div>
                      <div className="bg-green-50 rounded p-2">
                        <div className="font-bold text-green-700">{partner.replied_messages}</div>
                        <div className="text-gray-500">Replied</div>
                      </div>
                      <div className={`rounded p-2 ${partner.avg_response_time_hours !== null ? (partner.avg_response_time_hours <= 24 ? 'bg-green-50' : partner.avg_response_time_hours <= 48 ? 'bg-yellow-50' : 'bg-red-50') : 'bg-gray-50'}`}>
                        <div className={`font-bold ${partner.avg_response_time_hours !== null ? (partner.avg_response_time_hours <= 24 ? 'text-green-700' : partner.avg_response_time_hours <= 48 ? 'text-yellow-700' : 'text-red-700') : 'text-gray-500'}`}>
                          {partner.avg_response_time_hours !== null ? `${partner.avg_response_time_hours}h` : '-'}
                        </div>
                        <div className="text-gray-500">Avg Time</div>
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>

          {/* Message Details Panel */}
          <div className="bg-white rounded-lg shadow">
            <div className="p-4 border-b">
              <h2 className="text-sm font-bold text-gray-800">
                {selectedPartnerMessages ? `Messages from ${selectedPartnerMessages.partner_name}` : 'Select a Partner'}
              </h2>
            </div>
            <div className="p-4">
              {selectedPartnerMessages ? (
                <div className="space-y-3 max-h-[550px] overflow-y-auto">
                  {selectedPartnerMessages.messages.map((msg) => (
                    <div key={msg.id} className={`p-3 border rounded-lg ${msg.replied ? 'border-green-200 bg-green-50' : 'border-yellow-200 bg-yellow-50'}`}>
                      <div className="flex justify-between items-start mb-2">
                        <div className="flex items-center gap-2">
                          {msg.order_number && (
                            <span className="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded">
                              {msg.order_number}
                            </span>
                          )}
                          <span className={`text-xs px-2 py-0.5 rounded ${msg.replied ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}`}>
                            {msg.replied ? 'Replied' : 'Pending'}
                          </span>
                        </div>
                        {msg.response_time_hours !== null && (
                          <span className={`text-xs font-bold ${msg.response_time_hours <= 24 ? 'text-green-600' : msg.response_time_hours <= 48 ? 'text-yellow-600' : 'text-red-600'}`}>
                            {msg.response_time_hours}h response
                          </span>
                        )}
                      </div>
                      <div className="text-sm text-gray-700">{msg.content}</div>
                      <div className="text-[10px] text-gray-400 mt-2">
                        Sent: {msg.created_at ? new Date(msg.created_at).toLocaleString('en-US', { timeZone: 'America/New_York' }) : '-'}
                        {msg.replied_at && ` ‚Ä¢ Replied: ${new Date(msg.replied_at).toLocaleString('en-US', { timeZone: 'America/New_York' })}`}
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center text-gray-500 py-8">
                  <div className="text-4xl mb-2">üìä</div>
                  <p>Click on a partner to view their message history</p>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Payment Modal */}
      {showPaymentModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div className="p-4 border-b flex justify-between items-center">
              <h3 className="font-bold text-gray-800">Register Payment</h3>
              <button onClick={() => setShowPaymentModal(false)} className="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <form onSubmit={handleCreatePayment} className="p-4 space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs text-gray-600 mb-1">Per√≠odo In√≠cio</label>
                  <input
                    type="date"
                    value={paymentForm.period_start}
                    onChange={(e) => setPaymentForm({...paymentForm, period_start: e.target.value})}
                    className="w-full px-3 py-2 border rounded text-sm"
                    required
                  />
                </div>
                <div>
                  <label className="block text-xs text-gray-600 mb-1">Per√≠odo Fim</label>
                  <input
                    type="date"
                    value={paymentForm.period_end}
                    onChange={(e) => setPaymentForm({...paymentForm, period_end: e.target.value})}
                    className="w-full px-3 py-2 border rounded text-sm"
                    required
                  />
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs text-gray-600 mb-1">P√°ginas</label>
                  <input
                    type="number"
                    value={paymentForm.pages_count}
                    onChange={(e) => {
                      const pages = parseInt(e.target.value) || 0;
                      setPaymentForm({
                        ...paymentForm,
                        pages_count: pages,
                        total_amount: pages * paymentForm.rate_per_page
                      });
                    }}
                    className="w-full px-3 py-2 border rounded text-sm"
                    required
                  />
                </div>
                <div>
                  <label className="block text-xs text-gray-600 mb-1">Amount por P√°gina ($)</label>
                  <input
                    type="number"
                    step="0.01"
                    value={paymentForm.rate_per_page}
                    onChange={(e) => {
                      const rate = parseFloat(e.target.value) || 0;
                      setPaymentForm({
                        ...paymentForm,
                        rate_per_page: rate,
                        total_amount: paymentForm.pages_count * rate
                      });
                    }}
                    className="w-full px-3 py-2 border rounded text-sm"
                    required
                  />
                </div>
              </div>
              <div>
                <label className="block text-xs text-gray-600 mb-1">Amount Total</label>
                <input
                  type="text"
                  value={formatCurrency(paymentForm.total_amount)}
                  readOnly
                  className="w-full px-3 py-2 border rounded text-sm bg-gray-100 font-bold text-blue-600"
                />
              </div>
              <div>
                <label className="block text-xs text-gray-600 mb-1">M√©todo de Payment</label>
                <select
                  value={paymentForm.payment_method}
                  onChange={(e) => setPaymentForm({...paymentForm, payment_method: e.target.value})}
                  className="w-full px-3 py-2 border rounded text-sm"
                >
                  <option value="">Select...</option>
                  <option value="bank_transfer">Transfer√™ncia Banc√°ria</option>
                  <option value="paypal">PayPal</option>
                  <option value="pix">PIX</option>
                  <option value="check">Cheque</option>
                  <option value="other">Outro</option>
                </select>
              </div>
              <div>
                <label className="block text-xs text-gray-600 mb-1">Refer√™ncia/ID da Transa√ß√£o</label>
                <input
                  type="text"
                  value={paymentForm.payment_reference}
                  onChange={(e) => setPaymentForm({...paymentForm, payment_reference: e.target.value})}
                  className="w-full px-3 py-2 border rounded text-sm"
                  placeholder="Opcional"
                />
              </div>
              <div>
                <label className="block text-xs text-gray-600 mb-1">Notas</label>
                <textarea
                  value={paymentForm.notes}
                  onChange={(e) => setPaymentForm({...paymentForm, notes: e.target.value})}
                  className="w-full px-3 py-2 border rounded text-sm"
                  rows="2"
                  placeholder="Observa√ß√µes opcionais..."
                />
              </div>
              <div className="flex justify-end space-x-2 pt-2">
                <button
                  type="button"
                  onClick={() => setShowPaymentModal(false)}
                  className="px-4 py-2 border rounded text-sm text-gray-600 hover:bg-gray-50"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
                >
                  Register Payment
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
};

// ==================== FINANCES PAGE ====================
const FinancesPage = ({ adminKey }) => {
  const [summary, setSummary] = useState(null);
  const [expenses, setExpenses] = useState([]);
  const [loading, setLoading] = useState(true);
  const [period, setPeriod] = useState('month');
  const [activeView, setActiveView] = useState('overview'); // overview, expenses, quickbooks, partners, pages
  // Translator payments state
  const [translators, setTranslators] = useState([]);
  const [translatorPayments, setTranslatorPayments] = useState([]);
  const [selectedTranslatorForPayment, setSelectedTranslatorForPayment] = useState(null);
  const [paymentAmount, setPaymentAmount] = useState('');
  const [paymentNote, setPaymentNote] = useState('');
  const [paymentMethod, setPaymentMethod] = useState('');
  const [paymentType, setPaymentType] = useState('translation');
  const [commissionRate, setCommissionRate] = useState('');
  const [paymentReport, setPaymentReport] = useState(null);
  const [showExpenseModal, setShowExpenseModal] = useState(false);
  // Receipt file upload state
  const [receiptFile, setReceiptFile] = useState(null);
  const [receiptPreview, setReceiptPreview] = useState(null);
  // QuickBooks state
  const [qbConnected, setQbConnected] = useState(false);
  const [qbSyncing, setQbSyncing] = useState({});
  const [paidOrders, setPaidOrders] = useState([]);
  // Partner statistics state
  const [partnerStats, setPartnerStats] = useState({ partners: [], summary: {} });
  // Partner invoices state
  const [partnerInvoices, setPartnerInvoices] = useState([]);
  const [selectedPartnerForInvoice, setSelectedPartnerForInvoice] = useState(null);
  const [partnerOrdersForInvoice, setPartnerOrdersForInvoice] = useState([]);
  const [selectedOrdersForInvoice, setSelectedOrdersForInvoice] = useState([]);
  const [showCreateInvoiceModal, setShowCreateInvoiceModal] = useState(false);
  const [invoiceDueDays, setInvoiceDueDays] = useState(30);
  const [invoiceNotes, setInvoiceNotes] = useState('');
  const [creatingInvoice, setCreatingInvoice] = useState(false);
  const [showInvoicesModal, setShowInvoicesModal] = useState(false);
  const [selectedPartnerInvoices, setSelectedPartnerInvoices] = useState([]);
  // Invoice payment management state
  const [pendingZelleInvoices, setPendingZelleInvoices] = useState([]);
  const [paymentHistory, setPaymentHistory] = useState([]);
  // Email search state
  const [emailSearchQuery, setEmailSearchQuery] = useState('');
  const [emailSearchResult, setEmailSearchResult] = useState(null);
  const [emailSearching, setEmailSearching] = useState(false);
  const [invoiceNotifications, setInvoiceNotifications] = useState([]);
  const [unreadNotifCount, setUnreadNotifCount] = useState(0);
  // Quick add vendor modal state
  const [showQuickAddVendor, setShowQuickAddVendor] = useState(false);
  const [quickVendorForm, setQuickVendorForm] = useState({ name: '', email: '', role: 'translator', rate_per_page: '' });
  const [addingVendor, setAddingVendor] = useState(false);
  // Error state for debugging API issues
  const [vendorError, setVendorError] = useState(null);
  // Pages tracking state
  const [pagesLogs, setPagesLogs] = useState([]);
  const [showAddPagesModal, setShowAddPagesModal] = useState(false);
  const [pagesForm, setPagesForm] = useState({ translator_id: '', pages: '', date: new Date().toISOString().split('T')[0], note: '' });
  const [addingPages, setAddingPages] = useState(false);
  const [editingPagesLog, setEditingPagesLog] = useState(null);
  const [editPagesForm, setEditPagesForm] = useState({ pages: '', date: '', note: '' });
  // Expense receipt upload state
  const [expenseReceiptFile, setExpenseReceiptFile] = useState(null);
  const [expenseReceiptPreview, setExpenseReceiptPreview] = useState(null);
  // Vendor expenses state (for showing expenses per vendor)
  const [vendorExpenses, setVendorExpenses] = useState([]);
  // Coupon management state
  const [couponTemplates, setCouponTemplates] = useState([]);
  const [showCouponModal, setShowCouponModal] = useState(false);
  const [selectedPartnerForCoupon, setSelectedPartnerForCoupon] = useState(null);
  const [partnerCoupons, setPartnerCoupons] = useState([]);
  const [selectedCouponToAssign, setSelectedCouponToAssign] = useState('');
  const [couponMaxUses, setCouponMaxUses] = useState(1);
  const [assigningCoupon, setAssigningCoupon] = useState(false);
  const [expenseForm, setExpenseForm] = useState({
    category: 'fixed',
    subcategory: '',
    description: '',
    amount: 0,
    date: new Date().toISOString().split('T')[0],
    is_recurring: false,
    recurring_period: '',
    vendor: '',
    vendor_id: '',
    notes: ''
  });

  const EXPENSE_CATEGORIES = {
    fixed: { label: 'Fixed Expenses', color: '#3B82F6' },
    translators: { label: 'Translators', color: '#10B981' },
    ai: { label: 'AI & Technology', color: '#8B5CF6' },
    marketing: { label: 'Marketing', color: '#F59E0B' },
    office: { label: 'Office', color: '#EF4444' },
    utilities: { label: 'Utilities', color: '#06B6D4' },
    other: { label: 'Other', color: '#6B7280' }
  };

  const REVENUE_SOURCES = {
    website: { label: 'Website', color: '#3B82F6' },
    google: { label: 'Google', color: '#EA4335' },
    instagram: { label: 'Instagram', color: '#E4405F' },
    facebook: { label: 'Facebook', color: '#1877F2' },
    whatsapp: { label: 'WhatsApp', color: '#22C55E' },
    social_media: { label: 'Social Media', color: '#A855F7' },
    referral: { label: 'Referral', color: '#F59E0B' },
    partner: { label: 'Partner', color: '#06B6D4' },
    other: { label: 'Other', color: '#6B7280' }
  };

  const fetchSummary = async () => {
    try {
      const response = await axios.get(`${API}/admin/finances/summary?admin_key=${adminKey}&period=${period}`);
      setSummary(response.data);
    } catch (err) {
      console.error('Error fetching financial summary:', err);
    }
  };

  const fetchExpenses = async () => {
    try {
      const response = await axios.get(`${API}/admin/expenses?admin_key=${adminKey}`);
      setExpenses(response.data.expenses || []);
    } catch (err) {
      console.error('Error fetching expenses:', err);
    }
  };

  // Translator payments functions
  const fetchTranslatorsForPayment = async () => {
    try {
      setVendorError(null);
      console.log('Fetching vendors with adminKey:', adminKey ? 'present' : 'missing');
      const response = await axios.get(`${API}/admin/payments/translators?admin_key=${adminKey}`);
      // API returns { translators: [...], total: X }
      const vendorsList = response.data?.translators || response.data || [];
      console.log('Fetched vendors:', vendorsList.length, response.data);
      setTranslators(vendorsList);
    } catch (err) {
      console.error('Error fetching translators:', err);
      const errorMsg = err.response?.data?.detail || err.message || 'Failed to fetch vendors';
      console.error('Error details:', err.response?.status, errorMsg);
      setVendorError(`Error ${err.response?.status || ''}: ${errorMsg}`);
      setTranslators([]);
    }
  };

  const fetchPaymentReport = async () => {
    try {
      const response = await axios.get(`${API}/admin/payments/report?admin_key=${adminKey}`);
      setPaymentReport(response.data);
    } catch (err) {
      console.error('Error fetching payment report:', err);
    }
  };

  const fetchTranslatorPaymentHistory = async (translatorId) => {
    try {
      const response = await axios.get(`${API}/admin/payments/translator/${translatorId}?admin_key=${adminKey}`);
      setTranslatorPayments(response.data.payments || []);
    } catch (err) {
      console.error('Error fetching translator payments:', err);
    }
  };

  const fetchVendorExpenses = async (vendorId) => {
    try {
      const response = await axios.get(`${API}/admin/expenses?admin_key=${adminKey}&vendor_id=${vendorId}`);
      setVendorExpenses(response.data.expenses || []);
    } catch (err) {
      console.error('Error fetching vendor expenses:', err);
      setVendorExpenses([]);
    }
  };

  const handleRegisterPayment = async () => {
    if (!selectedTranslatorForPayment || !paymentAmount || !paymentMethod) {
      showToast('Please select a vendor, enter amount and payment method');
      return;
    }
    const translatorId = selectedTranslatorForPayment.translator_id || selectedTranslatorForPayment._id;
    try {
      const formData = new FormData();
      formData.append('translator_id', translatorId);
      formData.append('amount', parseFloat(paymentAmount));
      formData.append('note', paymentNote || '');
      formData.append('payment_method', paymentMethod);
      formData.append('payment_type', paymentType);
      if (paymentType === 'sales_commission' && commissionRate) {
        formData.append('commission_rate', parseFloat(commissionRate));
      }
      if (receiptFile) {
        formData.append('receipt_file', receiptFile);
      }

      await axios.post(`${API}/admin/payments/register?admin_key=${adminKey}`, formData, {
        headers: { 'Content-Type': 'multipart/form-data' }
      });
      showToast('Payment registered successfully!');
      setPaymentAmount('');
      setPaymentNote('');
      setPaymentMethod('');
      setPaymentType('translation');
      setCommissionRate('');
      setReceiptFile(null);
      setReceiptPreview(null);
      fetchTranslatorsForPayment();
      fetchPaymentReport();
      if (selectedTranslatorForPayment) {
        fetchTranslatorPaymentHistory(translatorId);
      }
    } catch (err) {
      showToast('Error registering payment: ' + (err.response?.data?.detail || err.message));
    }
  };

  const handleReceiptFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'application/pdf'];
      if (!allowedTypes.includes(file.type)) {
        showToast('Please upload an image (PNG, JPG, GIF) or PDF file');
        return;
      }
      if (file.size > 10 * 1024 * 1024) {
        showToast('File size must be less than 10MB');
        return;
      }
      setReceiptFile(file);
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => setReceiptPreview(e.target.result);
        reader.readAsDataURL(file);
      } else {
        setReceiptPreview(null);
      }
    }
  };

  // QuickBooks functions
  const checkQuickBooksStatus = async () => {
    try {
      const response = await axios.get(`${API}/quickbooks/status?admin_key=${adminKey}`);
      setQbConnected(response.data.connected);
    } catch (err) {
      console.error('Failed to check QuickBooks status:', err);
    }
  };

  const fetchPaidOrders = async () => {
    try {
      const response = await axios.get(`${API}/admin/orders?admin_key=${adminKey}`);
      const orders = response.data.orders || response.data || [];
      // Filter paid orders that haven't been synced to QuickBooks
      const paid = orders.filter(o => o.payment_status === 'paid');
      setPaidOrders(paid);
    } catch (err) {
      console.error('Failed to fetch paid orders:', err);
    }
  };

  const fetchPartnerStats = async () => {
    try {
      const response = await axios.get(`${API}/admin/finances/partners?admin_key=${adminKey}`);
      setPartnerStats(response.data);
    } catch (err) {
      console.error('Failed to fetch partner statistics:', err);
    }
  };

  // Partner Invoice Functions
  const fetchPartnerInvoices = async () => {
    try {
      const response = await axios.get(`${API}/admin/partner-invoices?admin_key=${adminKey}`);
      setPartnerInvoices(response.data.invoices || []);
    } catch (err) {
      console.error('Failed to fetch partner invoices:', err);
    }
  };

  const fetchPartnerOrdersForInvoice = async (partnerId) => {
    try {
      const response = await axios.get(`${API}/admin/partner-orders/${partnerId}?admin_key=${adminKey}`);
      setPartnerOrdersForInvoice(response.data.orders || []);
    } catch (err) {
      console.error('Failed to fetch partner orders:', err);
    }
  };

  const fetchPartnerInvoicesForPartner = async (partnerId) => {
    try {
      const response = await axios.get(`${API}/admin/partner-invoices/partner/${partnerId}?admin_key=${adminKey}`);
      setSelectedPartnerInvoices(response.data.invoices || []);
    } catch (err) {
      console.error('Failed to fetch partner invoices:', err);
    }
  };

  const handleOpenCreateInvoice = async (partner) => {
    setSelectedPartnerForInvoice(partner);
    setSelectedOrdersForInvoice([]);
    setInvoiceDueDays(30);
    setInvoiceNotes('');
    await fetchPartnerOrdersForInvoice(partner.partner_id);
    setShowCreateInvoiceModal(true);
  };

  const handleOpenInvoices = async (partner) => {
    setSelectedPartnerForInvoice(partner);
    await fetchPartnerInvoicesForPartner(partner.partner_id);
    setShowInvoicesModal(true);
  };

  const handleCreateInvoice = async () => {
    if (selectedOrdersForInvoice.length === 0) {
      showToast('Please select at least one order');
      return;
    }
    setCreatingInvoice(true);
    try {
      await axios.post(`${API}/admin/partner-invoices/create?admin_key=${adminKey}`, {
        partner_id: selectedPartnerForInvoice.partner_id,
        order_ids: selectedOrdersForInvoice,
        due_days: invoiceDueDays,
        notes: invoiceNotes
      });
      showToast('Invoice created successfully!');
      setShowCreateInvoiceModal(false);
      fetchPartnerStats();
      fetchPartnerInvoices();
    } catch (err) {
      showToast('Error creating invoice: ' + (err.response?.data?.detail || err.message));
    } finally {
      setCreatingInvoice(false);
    }
  };

  const handleDeleteInvoice = async (invoiceId) => {
    if (!window.confirm('Are you sure you want to delete this invoice?')) return;
    try {
      await axios.delete(`${API}/admin/partner-invoices/${invoiceId}?admin_key=${adminKey}`);
      fetchPartnerInvoicesForPartner(selectedPartnerForInvoice.partner_id);
      fetchPartnerStats();
    } catch (err) {
      showToast('Error deleting invoice: ' + (err.response?.data?.detail || err.message));
    }
  };

  const handleMarkInvoicePaid = async (invoiceId, paymentMethod = 'manual') => {
    try {
      await axios.put(`${API}/admin/partner-invoices/${invoiceId}/mark-paid?admin_key=${adminKey}&payment_method=${paymentMethod}`);
      fetchPartnerInvoicesForPartner(selectedPartnerForInvoice.partner_id);
      fetchPartnerStats();
    } catch (err) {
      showToast('Error marking invoice as paid: ' + (err.response?.data?.detail || err.message));
    }
  };

  const toggleOrderSelection = (orderId) => {
    setSelectedOrdersForInvoice(prev =>
      prev.includes(orderId)
        ? prev.filter(id => id !== orderId)
        : [...prev, orderId]
    );
  };

  const selectAllOrders = () => {
    if (selectedOrdersForInvoice.length === partnerOrdersForInvoice.length) {
      setSelectedOrdersForInvoice([]);
    } else {
      setSelectedOrdersForInvoice(partnerOrdersForInvoice.map(o => o.id));
    }
  };

  // Coupon Management Functions
  const fetchCouponTemplates = async () => {
    try {
      const response = await axios.get(`${API}/admin/coupons?admin_key=${adminKey}`);
      // Show all active coupons that can be assigned to partners
      // Filter out WELCOME coupons (they are auto-generated for specific partners)
      const templates = (response.data || []).filter(c =>
        c.is_active &&
        !c.code.startsWith('WELCOME-') &&
        !c.partner_id  // Exclude coupons already assigned to a specific partner
      );
      setCouponTemplates(templates);
    } catch (err) {
      console.error('Failed to fetch coupon templates:', err);
    }
  };

  const fetchPartnerCoupons = async (partnerId) => {
    try {
      const response = await axios.get(`${API}/admin/partners/${partnerId}/coupons?admin_key=${adminKey}`);
      setPartnerCoupons(response.data || []);
    } catch (err) {
      console.error('Failed to fetch partner coupons:', err);
      setPartnerCoupons([]);
    }
  };

  const handleOpenCouponModal = async (partner) => {
    setSelectedPartnerForCoupon(partner);
    setSelectedCouponToAssign('');
    setCouponMaxUses(1);
    await fetchCouponTemplates();
    await fetchPartnerCoupons(partner.partner_id);
    setShowCouponModal(true);
  };

  const handleAssignCoupon = async () => {
    if (!selectedCouponToAssign) {
      showToast('Please select a coupon to assign');
      return;
    }
    setAssigningCoupon(true);
    try {
      await axios.post(`${API}/admin/coupons/assign?admin_key=${adminKey}`, {
        coupon_code: selectedCouponToAssign,
        partner_id: selectedPartnerForCoupon.partner_id,
        max_uses: couponMaxUses
      });
      showToast(`Coupon ${selectedCouponToAssign} assigned successfully!`);
      await fetchPartnerCoupons(selectedPartnerForCoupon.partner_id);
      setSelectedCouponToAssign('');
    } catch (err) {
      showToast('Error assigning coupon: ' + (err.response?.data?.detail || err.message));
    } finally {
      setAssigningCoupon(false);
    }
  };

  const handleRemovePartnerCoupon = async (couponId) => {
    if (!window.confirm('Are you sure you want to remove this coupon from the partner?')) return;
    try {
      await axios.delete(`${API}/admin/coupons/${couponId}?admin_key=${adminKey}`);
      await fetchPartnerCoupons(selectedPartnerForCoupon.partner_id);
    } catch (err) {
      showToast('Error removing coupon: ' + (err.response?.data?.detail || err.message));
    }
  };

  // Invoice Payment Management Functions
  const fetchPendingZelleInvoices = async () => {
    try {
      const response = await axios.get(`${API}/admin/invoice-payments/pending-zelle?admin_key=${adminKey}`);
      setPendingZelleInvoices(response.data.invoices || []);
    } catch (err) {
      console.error('Failed to fetch pending Zelle invoices:', err);
    }
  };

  const fetchPaymentHistory = async () => {
    try {
      const response = await axios.get(`${API}/admin/invoice-payments/history?admin_key=${adminKey}`);
      setPaymentHistory(response.data.payments || []);
    } catch (err) {
      console.error('Failed to fetch payment history:', err);
    }
  };

  const fetchInvoiceNotifications = async () => {
    try {
      const response = await axios.get(`${API}/admin/invoice-notifications?admin_key=${adminKey}`);
      setInvoiceNotifications(response.data.notifications || []);
      setUnreadNotifCount(response.data.unread_count || 0);
    } catch (err) {
      console.error('Failed to fetch invoice notifications:', err);
    }
  };

  const handleApproveZellePayment = async (invoiceId) => {
    if (!window.confirm('Are you sure you want to approve this Zelle payment?')) return;
    try {
      await axios.put(`${API}/admin/invoice-payments/${invoiceId}/approve-zelle?admin_key=${adminKey}`);
      showToast('Payment approved successfully!');
      fetchPendingZelleInvoices();
      fetchPaymentHistory();
      fetchPartnerStats();
      fetchInvoiceNotifications();
    } catch (err) {
      showToast('Error approving payment: ' + (err.response?.data?.detail || err.message));
    }
  };

  const handleRejectZellePayment = async (invoiceId) => {
    const reason = prompt('Enter rejection reason (optional):');
    if (reason === null) return; // User cancelled
    try {
      await axios.put(`${API}/admin/invoice-payments/${invoiceId}/reject-zelle?admin_key=${adminKey}&reason=${encodeURIComponent(reason)}`);
      showToast('Payment rejected');
      fetchPendingZelleInvoices();
      fetchInvoiceNotifications();
    } catch (err) {
      showToast('Error rejecting payment: ' + (err.response?.data?.detail || err.message));
    }
  };

  // Invoice Reminder Functions
  const [reminderDays, setReminderDays] = useState(3);
  const [sendingReminder, setSendingReminder] = useState(null);

  const sendInvoiceReminder = async (invoiceId, invoiceNumber) => {
    if (!window.confirm(`Send payment reminder for invoice ${invoiceNumber}?`)) return;
    setSendingReminder(invoiceId);
    try {
      const response = await axios.post(`${API}/admin/partner-invoices/${invoiceId}/send-reminder?admin_key=${adminKey}`);
      showToast(response.data.message || 'Reminder sent successfully!');
      fetchPartnerInvoices();
    } catch (err) {
      showToast('Error sending reminder: ' + (err.response?.data?.detail || err.message));
    } finally {
      setSendingReminder(null);
    }
  };

  const sendBulkReminders = async () => {
    const days = prompt(`Send reminders to all partners with invoices due within how many days? (Also includes overdue)`, reminderDays.toString());
    if (!days || isNaN(parseInt(days))) return;

    const daysNum = parseInt(days);
    if (!window.confirm(`This will send reminder emails to all partners with pending invoices due within ${daysNum} days (and overdue invoices).\n\nContinue?`)) return;

    try {
      const response = await axios.post(`${API}/admin/partner-invoices/send-bulk-reminders?admin_key=${adminKey}&days_before_due=${daysNum}&include_overdue=true`);
      const summary = response.data.summary;
      showToast(`Bulk reminders completed!\n\nSent: ${summary.sent}\nSkipped: ${summary.skipped}\nFailed: ${summary.failed}`);
      fetchPartnerInvoices();
    } catch (err) {
      showToast('Error sending bulk reminders: ' + (err.response?.data?.detail || err.message));
    }
  };

  const handleMarkNotificationRead = async (notifId) => {
    try {
      await axios.put(`${API}/admin/invoice-notifications/${notifId}/read?admin_key=${adminKey}`);
      fetchInvoiceNotifications();
    } catch (err) {
      console.error('Error marking notification as read:', err);
    }
  };

  // Quick add vendor
  const handleQuickAddVendor = async () => {
    if (!quickVendorForm.name || !quickVendorForm.email) {
      showToast('Please fill name and email');
      return;
    }
    setAddingVendor(true);
    try {
      await axios.post(`${API}/admin/users/create?admin_key=${adminKey}`, {
        name: quickVendorForm.name,
        email: quickVendorForm.email,
        role: quickVendorForm.role || 'translator',
        rate_per_page: parseFloat(quickVendorForm.rate_per_page) || 0
      });
      showToast('Vendor created successfully!');
      setShowQuickAddVendor(false);
      setQuickVendorForm({ name: '', email: '', role: 'translator', rate_per_page: '' });
      // Small delay to ensure database write completes before refresh
      await new Promise(resolve => setTimeout(resolve, 500));
      fetchTranslatorsForPayment();
    } catch (err) {
      showToast('Error creating vendor: ' + (err.response?.data?.detail || err.message));
    } finally {
      setAddingVendor(false);
    }
  };

  // Pages tracking functions
  const fetchPagesLogs = async () => {
    try {
      const response = await axios.get(`${API}/admin/translator-pages?admin_key=${adminKey}&period=${period}`);
      setPagesLogs(response.data.logs || []);
    } catch (err) {
      console.error('Failed to fetch pages logs:', err);
    }
  };

  const handleAddPagesLog = async () => {
    if (!pagesForm.translator_id || !pagesForm.pages) {
      showToast('Please select translator and enter pages');
      return;
    }
    setAddingPages(true);
    try {
      await axios.post(`${API}/admin/translator-pages?admin_key=${adminKey}`, {
        translator_id: pagesForm.translator_id,
        pages: parseInt(pagesForm.pages),
        date: pagesForm.date,
        note: pagesForm.note || ''
      });
      showToast('Pages registered successfully!');
      setShowAddPagesModal(false);
      setPagesForm({ translator_id: '', pages: '', date: new Date().toISOString().split('T')[0], note: '' });
      fetchPagesLogs();
      fetchTranslatorsForPayment();
    } catch (err) {
      showToast('Error registering pages: ' + (err.response?.data?.detail || err.message));
    } finally {
      setAddingPages(false);
    }
  };

  const handleDeletePagesLog = async (logId) => {
    if (!window.confirm('Are you sure you want to delete this entry?')) return;
    try {
      await axios.delete(`${API}/admin/translator-pages/${logId}?admin_key=${adminKey}`);
      fetchPagesLogs();
    } catch (err) {
      showToast('Error deleting entry: ' + (err.response?.data?.detail || err.message));
    }
  };

  const handleEditPagesLog = (log) => {
    setEditingPagesLog(log);
    setEditPagesForm({
      pages: log.pages || '',
      date: log.date || '',
      note: log.note || ''
    });
  };

  const handleUpdatePagesLog = async () => {
    if (!editingPagesLog) return;
    try {
      await axios.put(`${API}/admin/translator-pages/${editingPagesLog._id}?admin_key=${adminKey}`, {
        pages: parseInt(editPagesForm.pages),
        date: editPagesForm.date,
        note: editPagesForm.note
      });
      setEditingPagesLog(null);
      setEditPagesForm({ pages: '', date: '', note: '' });
      fetchPagesLogs();
      fetchTranslatorsForPayment();
    } catch (err) {
      showToast('Error updating entry: ' + (err.response?.data?.detail || err.message));
    }
  };

  const deletePartner = async (partnerId) => {
    try {
      await axios.delete(`${API}/admin/partners/${partnerId}?admin_key=${adminKey}`);
      showToast('Partner deleted successfully');
      fetchPartnerStats(); // Refresh the list
    } catch (err) {
      showToast('Error deleting partner: ' + (err.response?.data?.detail || err.message));
    }
  };

  const setPartnerPaymentPlan = async (partnerId, plan) => {
    try {
      await axios.post(`${API}/admin/partners/${partnerId}/set-payment-plan?admin_key=${adminKey}&plan=${plan}&send_notification=true`);
      const planNames = { pay_per_order: 'Pay Per Order', biweekly: 'Biweekly Invoice', monthly: 'Monthly Invoice' };
      showToast(`Payment plan set to ${planNames[plan] || plan}`);
      fetchPartnerStats(); // Refresh the list
    } catch (err) {
      showToast('Error setting payment plan: ' + (err.response?.data?.detail || err.message));
    }
  };

  const togglePartnerInvoiceUnlock = async (partnerId, companyName, currentStatus) => {
    const newStatus = !currentStatus;
    const action = newStatus ? 'unlock' : 'lock';
    if (!window.confirm(`Are you sure you want to ${action} invoice payments for "${companyName}"?\n\n${newStatus ? 'This will allow the partner to pay by invoice immediately, bypassing the normal qualification requirements.' : 'This will remove the manual unlock, and the partner will need to qualify normally.'}`)) {
      return;
    }
    try {
      await axios.post(`${API}/admin/partners/${partnerId}/toggle-invoice-unlock?admin_key=${adminKey}&unlock=${newStatus}`);
      showToast(`Invoice payments ${newStatus ? 'unlocked' : 'locked'} for ${companyName}`);
      fetchPartnerStats(); // Refresh the list
    } catch (err) {
      showToast('Error toggling invoice unlock: ' + (err.response?.data?.detail || err.message));
    }
  };

  const findEmailInSystem = async () => {
    if (!emailSearchQuery.trim()) {
      showToast('Please enter an email to search');
      return;
    }
    setEmailSearching(true);
    setEmailSearchResult(null);
    try {
      const response = await axios.get(`${API}/admin/find-email/${encodeURIComponent(emailSearchQuery.trim())}?admin_key=${adminKey}`);
      setEmailSearchResult(response.data);
    } catch (err) {
      if (err.response?.status === 404) {
        setEmailSearchResult({ status: 'not_found', message: `Email '${emailSearchQuery}' not found in any collection` });
      } else {
        showToast('Error searching email: ' + (err.response?.data?.detail || err.message));
      }
    } finally {
      setEmailSearching(false);
    }
  };

  const deleteEmailFromSystem = async (collection = null) => {
    if (!emailSearchQuery.trim()) return;
    const confirmMsg = collection
      ? `Delete email '${emailSearchQuery}' from ${collection}?`
      : `Delete email '${emailSearchQuery}' from ALL collections where it exists?`;
    if (!window.confirm(confirmMsg + '\n\nThis action cannot be undone.')) return;

    try {
      const url = collection
        ? `${API}/admin/delete-email/${encodeURIComponent(emailSearchQuery.trim())}?admin_key=${adminKey}&collection=${collection}`
        : `${API}/admin/delete-email/${encodeURIComponent(emailSearchQuery.trim())}?admin_key=${adminKey}`;
      const response = await axios.delete(url);
      showToast(`Email deleted successfully from: ${response.data.deleted_from.map(d => d.collection).join(', ')}`);
      setEmailSearchResult(null);
      setEmailSearchQuery('');
      fetchPartnerStats(); // Refresh partner list
    } catch (err) {
      showToast('Error deleting email: ' + (err.response?.data?.detail || err.message));
    }
  };

  const syncOrderToQuickBooks = async (order) => {
    setQbSyncing(prev => ({ ...prev, [order.id]: true }));
    try {
      // For Partner orders, use Sales Receipt (already paid) and send to Partner
      // For direct client orders, use Invoice and send to client
      const isPartnerOrder = order.partner_id && order.partner_id !== 'manual' && order.partner_id !== 'direct_client' && order.partner_id !== 'admin_quote';

      const response = await axios.post(`${API}/quickbooks/sync/receipt?admin_key=${adminKey}`, {
        order_id: order.id,
        // Use partner info for B2B orders, client info for direct orders
        customer_name: isPartnerOrder ? (order.partner_company || order.partner_name) : order.client_name,
        customer_email: isPartnerOrder ? order.partner_email : order.client_email,
        send_email: true,
        is_partner_order: isPartnerOrder
      });

      if (response.data.success) {
        const recipient = isPartnerOrder ? (order.partner_company || 'partner') : (order.client_email || 'client');
        showToast(`Receipt #${response.data.receipt_number} created and sent to ${recipient}!`);
        fetchPaidOrders(); // Refresh the list
      }
    } catch (err) {
      console.error('Failed to sync to QuickBooks:', err);
      showToast('Failed to sync: ' + (err.response?.data?.detail || err.message));
    } finally {
      setQbSyncing(prev => ({ ...prev, [order.id]: false }));
    }
  };

  const syncTranslatorPaymentToQuickBooks = async (translator, amount, description) => {
    try {
      const response = await axios.post(`${API}/quickbooks/sync/contractor-payment?admin_key=${adminKey}`, {
        translator_id: translator._id || translator.id,
        translator_name: translator.name,
        translator_email: translator.email,
        amount: amount,
        description: description
      });

      if (response.data.success) {
        showToast(`Contractor payment recorded in QuickBooks!`);
      }
    } catch (err) {
      console.error('Failed to sync contractor payment:', err);
      showToast('Failed to sync: ' + (err.response?.data?.detail || err.message));
    }
  };

  const syncPartnerInvoiceToQuickBooks = async (invoice) => {
    setQbSyncing(prev => ({ ...prev, [`inv_${invoice.id}`]: true }));
    try {
      const response = await axios.post(`${API}/quickbooks/sync/partner-invoice?admin_key=${adminKey}`, {
        invoice_id: invoice.id,
        send_email: true
      });

      if (response.data.success) {
        if (response.data.already_synced) {
          showToast(`Invoice already synced to QuickBooks as #${response.data.invoice_number}`);
        } else {
          const emailMsg = response.data.email_sent ? ` and sent to ${response.data.sent_to}` : '';
          showToast(`Invoice created in QuickBooks as #${response.data.invoice_number}${emailMsg}!`);
        }
        // Refresh the invoices list
        if (selectedPartnerForInvoice) {
          fetchPartnerInvoicesForPartner(selectedPartnerForInvoice.partner_id);
        }
      }
    } catch (err) {
      console.error('Failed to sync partner invoice to QuickBooks:', err);
      showToast('Failed to sync: ' + (err.response?.data?.detail || err.message));
    } finally {
      setQbSyncing(prev => ({ ...prev, [`inv_${invoice.id}`]: false }));
    }
  };

  useEffect(() => {
    const loadData = async () => {
      setLoading(true);
      await Promise.all([fetchSummary(), fetchExpenses(), checkQuickBooksStatus()]);
      setLoading(false);
    };
    loadData();
  }, [adminKey, period]);

  useEffect(() => {
    if (activeView === 'quickbooks') {
      fetchPaidOrders();
    }
    if (activeView === 'partners') {
      fetchPartnerStats();
      fetchPartnerInvoices();
      fetchPendingZelleInvoices();
      fetchPaymentHistory();
      fetchInvoiceNotifications();
    }
    if (activeView === 'pages') {
      fetchPagesLogs();
      fetchTranslatorsForPayment();
    }
    if (activeView === 'expenses') {
      fetchTranslatorsForPayment(); // Fetch vendors for dropdown
      fetchExpenses();
    }
  }, [activeView]);

  const handleExpenseReceiptChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'application/pdf'];
      if (!allowedTypes.includes(file.type)) {
        showToast('Please upload an image (PNG, JPG, GIF) or PDF file');
        return;
      }
      if (file.size > 10 * 1024 * 1024) {
        showToast('File size must be less than 10MB');
        return;
      }
      setExpenseReceiptFile(file);
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => setExpenseReceiptPreview(e.target.result);
        reader.readAsDataURL(file);
      } else {
        setExpenseReceiptPreview(null);
      }
    }
  };

  const handleCreateExpense = async (e) => {
    e.preventDefault();
    try {
      const formData = new FormData();
      formData.append('category', expenseForm.category);
      formData.append('subcategory', expenseForm.subcategory || '');
      formData.append('description', expenseForm.description);
      formData.append('amount', parseFloat(expenseForm.amount) || 0);
      formData.append('date', expenseForm.date);
      formData.append('is_recurring', expenseForm.is_recurring);
      formData.append('recurring_period', expenseForm.recurring_period || '');
      formData.append('vendor', expenseForm.vendor);
      formData.append('vendor_id', expenseForm.vendor_id || '');
      formData.append('notes', expenseForm.notes || '');
      if (expenseReceiptFile) {
        formData.append('receipt_file', expenseReceiptFile);
      }

      await axios.post(`${API}/admin/expenses?admin_key=${adminKey}`, formData, {
        headers: { 'Content-Type': 'multipart/form-data' }
      });
      setShowExpenseModal(false);
      setExpenseForm({
        category: 'fixed', subcategory: '', description: '', amount: 0,
        date: new Date().toISOString().split('T')[0], is_recurring: false,
        recurring_period: '', vendor: '', vendor_id: '', notes: ''
      });
      setExpenseReceiptFile(null);
      setExpenseReceiptPreview(null);
      fetchExpenses();
      fetchSummary();
      showToast('Expense created successfully!');
    } catch (err) {
      console.error('Error creating expense:', err);
      showToast('Error creating expense: ' + (err.response?.data?.detail || err.message));
    }
  };

  const handleDeleteExpense = async (expenseId) => {
    if (!window.confirm('Delete this expense?')) return;
    try {
      await axios.delete(`${API}/admin/expenses/${expenseId}?admin_key=${adminKey}`);
      fetchExpenses();
      fetchSummary();
    } catch (err) {
      showToast('Error deleting expense');
    }
  };

  const handleViewExpenseReceipt = async (expenseId, filename) => {
    try {
      const response = await axios.get(`${API}/admin/expenses/${expenseId}/receipt?admin_key=${adminKey}`);
      const { receipt_file_data, receipt_file_type, receipt_filename } = response.data;

      // Create blob and open in new window
      const byteCharacters = atob(receipt_file_data);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      const blob = new Blob([byteArray], { type: receipt_file_type });
      const url = URL.createObjectURL(blob);

      // Open in new window for viewing/printing
      const newWindow = window.open(url, '_blank');
      if (newWindow) {
        newWindow.document.title = receipt_filename || 'Receipt';
      }
    } catch (err) {
      console.error('Error fetching receipt:', err);
      showToast('Error loading receipt: ' + (err.response?.data?.detail || err.message));
    }
  };

  const handleDownloadExpenseReceipt = async (expenseId) => {
    try {
      const response = await axios.get(`${API}/admin/expenses/${expenseId}/receipt?admin_key=${adminKey}`);
      const { receipt_file_data, receipt_file_type, receipt_filename } = response.data;

      // Create download link
      const link = document.createElement('a');
      link.href = `data:${receipt_file_type};base64,${receipt_file_data}`;
      link.download = receipt_filename || 'receipt';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (err) {
      console.error('Error downloading receipt:', err);
      showToast('Error downloading receipt: ' + (err.response?.data?.detail || err.message));
    }
  };

  const handleUploadExpenseReceipt = async (expenseId, file) => {
    if (!file) return;

    const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'application/pdf'];
    if (!allowedTypes.includes(file.type)) {
      showToast('Please upload an image (PNG, JPG, GIF) or PDF file');
      return;
    }
    if (file.size > 10 * 1024 * 1024) {
      showToast('File size must be less than 10MB');
      return;
    }

    try {
      const formData = new FormData();
      formData.append('receipt', file);

      await axios.post(
        `${API}/admin/expenses/${expenseId}/upload-receipt?admin_key=${adminKey}`,
        formData,
        { headers: { 'Content-Type': 'multipart/form-data' } }
      );

      showToast('Receipt uploaded successfully!');
      fetchExpenses(); // Refresh the list
    } catch (err) {
      console.error('Error uploading receipt:', err);
      showToast('Error uploading receipt: ' + (err.response?.data?.detail || err.message));
    }
  };

  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
  };

  const formatDate = (dateStr) => {
    return formatDateLocal(dateStr);
  };

  // Simple Donut Chart Component
  const DonutChart = ({ data, total }) => {
    const items = Object.entries(data).filter(([_, v]) => v.amount > 0);
    if (items.length === 0) return <div className="text-center text-gray-500 py-8">Without dados</div>;

    let currentAngle = 0;
    const segments = items.map(([key, value]) => {
      const percentage = total > 0 ? (value.amount / total) * 100 : 0;
      const angle = (percentage / 100) * 360;
      const segment = { key, ...value, percentage, startAngle: currentAngle, angle };
      currentAngle += angle;
      return segment;
    });

    return (
      <div className="flex items-center justify-center space-x-4">
        <div className="relative w-32 h-32">
          <svg viewBox="0 0 100 100" className="w-full h-full transform -rotate-90">
            {segments.map((seg, i) => {
              const radius = 40;
              const circumference = 2 * Math.PI * radius;
              const strokeDasharray = (seg.angle / 360) * circumference;
              const strokeDashoffset = -(seg.startAngle / 360) * circumference;
              const color = EXPENSE_CATEGORIES[seg.key]?.color || REVENUE_SOURCES[seg.key]?.color || '#6B7280';
              return (
                <circle
                  key={seg.key}
                  cx="50" cy="50" r={radius}
                  fill="none"
                  stroke={color}
                  strokeWidth="20"
                  strokeDasharray={`${strokeDasharray} ${circumference}`}
                  strokeDashoffset={strokeDashoffset}
                />
              );
            })}
          </svg>
          <div className="absolute inset-0 flex items-center justify-center">
            <span className="text-sm font-bold text-gray-700">{formatCurrency(total)}</span>
          </div>
        </div>
        <div className="space-y-1 text-xs">
          {segments.map((seg) => {
            const catInfo = EXPENSE_CATEGORIES[seg.key] || REVENUE_SOURCES[seg.key] || { label: seg.key, color: '#6B7280' };
            return (
              <div key={seg.key} className="flex items-center">
                <div className="w-3 h-3 rounded-full mr-2" style={{ backgroundColor: catInfo.color }}></div>
                <span className="text-gray-600">{catInfo.label}: {formatCurrency(seg.amount)}</span>
                <span className="ml-1 text-gray-400">({seg.percentage.toFixed(0)}%)</span>
              </div>
            );
          })}
        </div>
      </div>
    );
  };

  if (loading) return <div className="p-6 text-center">Loading financial data...</div>;

  return (
    <div className="p-6">
      {/* Header */}
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-xl font-bold text-gray-800">üí∞ Finances</h1>
        <div className="flex items-center space-x-4">
          <select
            value={period}
            onChange={(e) => setPeriod(e.target.value)}
            className="px-3 py-2 border rounded text-sm"
          >
            <option value="month">This Month</option>
            <option value="last30">Last 30 days</option>
            <option value="year">This Year</option>
            <option value="last365">Last 365 days</option>
          </select>
          <div className="flex space-x-2">
            <button
              onClick={() => setActiveView('overview')}
              className={`px-4 py-2 rounded text-sm ${activeView === 'overview' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
            >
              Overview
            </button>
            <button
              onClick={() => setActiveView('expenses')}
              className={`px-4 py-2 rounded text-sm ${activeView === 'expenses' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
            >
              Expenses
            </button>
            <button
              onClick={() => setActiveView('quickbooks')}
              className={`px-4 py-2 rounded text-sm flex items-center gap-1 ${activeView === 'quickbooks' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
            >
              üìä QuickBooks
              {qbConnected && <span className="w-2 h-2 bg-green-400 rounded-full"></span>}
            </button>
            <button
              onClick={() => setActiveView('partners')}
              className={`px-4 py-2 rounded text-sm ${activeView === 'partners' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
            >
              ü§ù Partners
            </button>
            <button
              onClick={() => setActiveView('pages')}
              className={`px-4 py-2 rounded text-sm ${activeView === 'pages' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
            >
              üìÑ Pages
            </button>
          </div>
        </div>
      </div>

      {activeView === 'overview' && summary && (
        <>
          {/* Summary Cards */}
          <div className="grid grid-cols-3 gap-6 mb-6">
            {/* Profit & Loss */}
            <div className="bg-white rounded-lg shadow p-4">
              <div className="flex justify-between items-center mb-2">
                <h3 className="text-sm font-medium text-gray-500 uppercase">Profit & Loss</h3>
              </div>
              <div className={`text-2xl font-bold ${summary.profit_loss.net_profit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                {formatCurrency(summary.profit_loss.net_profit)}
              </div>
              <div className="mt-4 space-y-2">
                <div className="flex justify-between text-sm">
                  <span className="text-gray-500">Revenue</span>
                  <span className="font-medium text-green-600">{formatCurrency(summary.profit_loss.total_revenue)}</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div className="bg-green-500 h-2 rounded-full" style={{ width: `${Math.min(100, (summary.profit_loss.total_revenue / (summary.profit_loss.total_revenue + summary.profit_loss.total_expenses)) * 100)}%` }}></div>
                </div>
                <div className="flex justify-between text-sm">
                  <span className="text-gray-500">Expenses</span>
                  <span className="font-medium text-red-600">{formatCurrency(summary.profit_loss.total_expenses)}</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div className="bg-red-500 h-2 rounded-full" style={{ width: `${Math.min(100, (summary.profit_loss.total_expenses / (summary.profit_loss.total_revenue + summary.profit_loss.total_expenses)) * 100)}%` }}></div>
                </div>
              </div>
              {summary.profit_loss.revenue_change_percent !== 0 && (
                <div className={`mt-3 text-xs ${summary.profit_loss.revenue_change_percent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                  {summary.profit_loss.revenue_change_percent >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(summary.profit_loss.revenue_change_percent)}% vs previous period
                </div>
              )}
            </div>

            {/* Expenses Breakdown */}
            <div className="bg-white rounded-lg shadow p-4">
              <div className="flex justify-between items-center mb-2">
                <h3 className="text-sm font-medium text-gray-500 uppercase">Expenses</h3>
                <span className="text-lg font-bold text-gray-800">{formatCurrency(summary.expenses.total)}</span>
              </div>
              <DonutChart data={summary.expenses.by_category} total={summary.expenses.total} />
            </div>

            {/* Invoices */}
            <div className="bg-white rounded-lg shadow p-4">
              <h3 className="text-sm font-medium text-gray-500 uppercase mb-2">Invoices</h3>
              <div className="space-y-3">
                <div className="flex justify-between items-center">
                  <span className="text-sm text-gray-600">Pending</span>
                  <span className="font-bold text-yellow-600">{formatCurrency(summary.invoices.pending)}</span>
                </div>
                <div className="flex justify-between items-center">
                  <span className="text-sm text-gray-600">Overdue</span>
                  <span className="font-bold text-red-600">{formatCurrency(summary.invoices.overdue)}</span>
                </div>
                <div className="border-t pt-3">
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-gray-600">Paid (period)</span>
                    <span className="font-bold text-green-600">{formatCurrency(summary.invoices.paid)}</span>
                  </div>
                </div>
                <div className="mt-2 flex space-x-1">
                  <div className="h-2 bg-red-500 rounded" style={{ width: `${(summary.invoices.overdue / (summary.invoices.paid + summary.invoices.pending + summary.invoices.overdue || 1)) * 100}%` }}></div>
                  <div className="h-2 bg-yellow-500 rounded" style={{ width: `${(summary.invoices.pending / (summary.invoices.paid + summary.invoices.pending + summary.invoices.overdue || 1)) * 100}%` }}></div>
                  <div className="h-2 bg-green-500 rounded flex-1"></div>
                </div>
              </div>
            </div>
          </div>

          {/* Revenue Sources & Languages */}
          <div className="grid grid-cols-2 gap-6">
            {/* Revenue by Source */}
            <div className="bg-white rounded-lg shadow p-4">
              <h3 className="text-sm font-medium text-gray-500 uppercase mb-4">Revenue by Source</h3>
              <div className="space-y-3">
                {Object.entries(summary.revenue.by_source).map(([key, value]) => {
                  const sourceInfo = REVENUE_SOURCES[key] || { label: key, color: '#6B7280' };
                  const percentage = summary.revenue.total > 0 ? (value.amount / summary.revenue.total) * 100 : 0;
                  return (
                    <div key={key}>
                      <div className="flex justify-between text-sm mb-1">
                        <span className="text-gray-600">{sourceInfo.label}</span>
                        <span className="font-medium">{formatCurrency(value.amount)} ({value.count})</span>
                      </div>
                      <div className="w-full bg-gray-200 rounded-full h-2">
                        <div className="h-2 rounded-full" style={{ width: `${percentage}%`, backgroundColor: sourceInfo.color }}></div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Revenue by Language */}
            <div className="bg-white rounded-lg shadow p-4">
              <h3 className="text-sm font-medium text-gray-500 uppercase mb-4">Revenue by Language</h3>
              <div className="space-y-2 max-h-64 overflow-y-auto">
                {Object.entries(summary.revenue.by_language).map(([langPair, value]) => {
                  const percentage = summary.revenue.total > 0 ? (value.amount / summary.revenue.total) * 100 : 0;
                  return (
                    <div key={langPair} className="flex justify-between items-center text-sm">
                      <span className="text-gray-600">{langPair}</span>
                      <div className="flex items-center">
                        <div className="w-24 bg-gray-200 rounded-full h-2 mr-2">
                          <div className="h-2 rounded-full bg-blue-500" style={{ width: `${percentage}%` }}></div>
                        </div>
                        <span className="font-medium w-20 text-right">{formatCurrency(value.amount)}</span>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        </>
      )}

      {activeView === 'expenses' && (
        <div className="bg-white rounded-lg shadow">
          <div className="p-4 border-b flex justify-between items-center">
            <h3 className="font-bold text-gray-800">Expenses List</h3>
            <button
              onClick={() => setShowExpenseModal(true)}
              className="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
            >
              + New Expense
            </button>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-xs">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left font-medium text-gray-600">Date</th>
                  <th className="px-4 py-3 text-left font-medium text-gray-600">Category</th>
                  <th className="px-4 py-3 text-left font-medium text-gray-600">Description</th>
                  <th className="px-4 py-3 text-left font-medium text-gray-600">Vendor</th>
                  <th className="px-4 py-3 text-right font-medium text-gray-600">Amount</th>
                  <th className="px-4 py-3 text-center font-medium text-gray-600">Receipt</th>
                  <th className="px-4 py-3 text-center font-medium text-gray-600">Actions</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {expenses.length === 0 ? (
                  <tr><td colSpan="7" className="px-4 py-8 text-center text-gray-500">No expenses registered</td></tr>
                ) : (
                  expenses.map((expense) => (
                    <tr key={expense.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3">{formatDate(expense.date)}</td>
                      <td className="px-4 py-3">
                        <span className="px-2 py-1 rounded text-xs" style={{
                          backgroundColor: `${EXPENSE_CATEGORIES[expense.category]?.color}20`,
                          color: EXPENSE_CATEGORIES[expense.category]?.color
                        }}>
                          {EXPENSE_CATEGORIES[expense.category]?.label || expense.category}
                        </span>
                      </td>
                      <td className="px-4 py-3">{expense.description}</td>
                      <td className="px-4 py-3 text-gray-500">{expense.vendor || '-'}</td>
                      <td className="px-4 py-3 text-right font-medium text-red-600">{formatCurrency(expense.amount)}</td>
                      <td className="px-4 py-3 text-center">
                        {expense.has_receipt ? (
                          <div className="flex items-center justify-center gap-2">
                            <button
                              onClick={() => handleViewExpenseReceipt(expense.id, expense.receipt_filename)}
                              className="text-blue-600 hover:text-blue-800 text-xs"
                              title="View receipt"
                            >
                              üëÅÔ∏è View
                            </button>
                            <button
                              onClick={() => handleDownloadExpenseReceipt(expense.id)}
                              className="text-green-600 hover:text-green-800 text-xs"
                              title="Download receipt"
                            >
                              ‚¨áÔ∏è Download
                            </button>
                          </div>
                        ) : (
                          <label className="cursor-pointer text-blue-600 hover:text-blue-800 text-xs">
                            üìé Upload
                            <input
                              type="file"
                              accept="image/*,.pdf"
                              className="hidden"
                              onChange={(e) => handleUploadExpenseReceipt(expense.id, e.target.files[0])}
                            />
                          </label>
                        )}
                      </td>
                      <td className="px-4 py-3 text-center">
                        <button onClick={() => handleDeleteExpense(expense.id)} className="text-red-600 hover:text-red-800">Delete</button>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Expense Modal */}
      {showExpenseModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div className="p-4 border-b flex justify-between items-center flex-shrink-0">
              <h3 className="font-bold text-gray-800">New Expense</h3>
              <button onClick={() => setShowExpenseModal(false)} className="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <form onSubmit={handleCreateExpense} className="p-4 space-y-4 overflow-y-auto flex-1">
              <div>
                <label className="block text-xs text-gray-600 mb-1">Category</label>
                <select
                  value={expenseForm.category}
                  onChange={(e) => setExpenseForm({...expenseForm, category: e.target.value})}
                  className="w-full px-3 py-2 border rounded text-sm"
                  required
                >
                  {Object.entries(EXPENSE_CATEGORIES).map(([key, { label }]) => (
                    <option key={key} value={key}>{label}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-xs text-gray-600 mb-1">Description</label>
                <input
                  type="text"
                  value={expenseForm.description}
                  onChange={(e) => setExpenseForm({...expenseForm, description: e.target.value})}
                  className="w-full px-3 py-2 border rounded text-sm"
                  required
                />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs text-gray-600 mb-1">Amount ($)</label>
                  <input
                    type="number"
                    step="0.01"
                    value={expenseForm.amount}
                    onChange={(e) => setExpenseForm({...expenseForm, amount: parseFloat(e.target.value) || 0})}
                    className="w-full px-3 py-2 border rounded text-sm"
                    required
                  />
                </div>
                <div>
                  <label className="block text-xs text-gray-600 mb-1">Date</label>
                  <input
                    type="date"
                    value={expenseForm.date}
                    onChange={(e) => setExpenseForm({...expenseForm, date: e.target.value})}
                    className="w-full px-3 py-2 border rounded text-sm"
                    required
                  />
                </div>
              </div>
              <div>
                <label className="block text-xs text-gray-600 mb-1">Vendor (optional)</label>
                <select
                  value={expenseForm.vendor_id}
                  onChange={(e) => {
                    const selectedVendor = translators.find(t => (t.translator_id || t._id) === e.target.value);
                    setExpenseForm({
                      ...expenseForm,
                      vendor_id: e.target.value,
                      vendor: selectedVendor ? selectedVendor.name : ''
                    });
                  }}
                  className="w-full px-3 py-2 border rounded text-sm"
                >
                  <option value="">Select vendor...</option>
                  {translators.map(t => (
                    <option key={t.translator_id || t._id} value={t.translator_id || t._id}>
                      {t.name} ({t.role === 'translator' ? 'Translator' : t.role === 'pm' ? 'PM' : t.role === 'admin' ? 'Admin' : t.role || 'Vendor'})
                    </option>
                  ))}
                </select>
                {/* Option to type manually if vendor not in list */}
                {!expenseForm.vendor_id && (
                  <input
                    type="text"
                    value={expenseForm.vendor}
                    onChange={(e) => setExpenseForm({...expenseForm, vendor: e.target.value})}
                    className="w-full px-3 py-2 border rounded text-sm mt-2"
                    placeholder="Or type vendor name manually..."
                  />
                )}
              </div>
              <div className="flex items-center">
                <input
                  type="checkbox"
                  checked={expenseForm.is_recurring}
                  onChange={(e) => setExpenseForm({...expenseForm, is_recurring: e.target.checked})}
                  className="mr-2"
                />
                <label className="text-sm text-gray-600">Recurring expense</label>
              </div>
              {expenseForm.is_recurring && (
                <div>
                  <label className="block text-xs text-gray-600 mb-1">Period</label>
                  <select
                    value={expenseForm.recurring_period}
                    onChange={(e) => setExpenseForm({...expenseForm, recurring_period: e.target.value})}
                    className="w-full px-3 py-2 border rounded text-sm"
                  >
                    <option value="">Select...</option>
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                  </select>
                </div>
              )}
              {/* Notes field */}
              <div>
                <label className="block text-xs text-gray-600 mb-1">Notes (optional)</label>
                <textarea
                  value={expenseForm.notes}
                  onChange={(e) => setExpenseForm({...expenseForm, notes: e.target.value})}
                  className="w-full px-3 py-2 border rounded text-sm"
                  rows={2}
                  placeholder="Additional notes..."
                />
              </div>
              {/* Receipt Upload */}
              <div>
                <label className="block text-xs text-gray-600 mb-1">Receipt (optional)</label>
                <div className="border-2 border-dashed border-gray-300 rounded-lg p-3 text-center hover:border-blue-400 transition-colors">
                  <input
                    type="file"
                    accept="image/*,.pdf"
                    onChange={handleExpenseReceiptChange}
                    className="hidden"
                    id="expense-receipt-input"
                  />
                  <label htmlFor="expense-receipt-input" className="cursor-pointer">
                    {expenseReceiptFile ? (
                      <div className="space-y-2">
                        {expenseReceiptPreview ? (
                          <img src={expenseReceiptPreview} alt="Receipt preview" className="max-h-24 mx-auto rounded" />
                        ) : (
                          <div className="text-3xl">üìÑ</div>
                        )}
                        <div className="text-sm text-gray-700">{expenseReceiptFile.name}</div>
                        <button
                          type="button"
                          onClick={(e) => {
                            e.preventDefault();
                            setExpenseReceiptFile(null);
                            setExpenseReceiptPreview(null);
                          }}
                          className="text-xs text-red-600 hover:text-red-800"
                        >
                          Remove
                        </button>
                      </div>
                    ) : (
                      <div className="space-y-1">
                        <div className="text-2xl text-gray-400">üìé</div>
                        <div className="text-xs text-gray-500">Clique para fazer upload do comprovante</div>
                        <div className="text-xs text-gray-400">PNG, JPG, GIF ou PDF (max 10MB)</div>
                      </div>
                    )}
                  </label>
                </div>
              </div>
              <div className="flex justify-end space-x-2 pt-2">
                <button type="button" onClick={() => { setShowExpenseModal(false); setExpenseReceiptFile(null); setExpenseReceiptPreview(null); }} className="px-4 py-2 border rounded text-sm text-gray-600">Cancel</button>
                <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Save</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Pages Tracking View */}
      {activeView === 'pages' && (
        <div className="space-y-6">
          {/* Summary */}
          <div className="grid grid-cols-3 gap-6">
            <div className="bg-white rounded-lg shadow p-4">
              <div className="text-xs text-gray-500 uppercase mb-1">Total Pages This Month</div>
              <div className="text-2xl font-bold text-blue-600">
                {pagesLogs
                  .filter(log => {
                    const logDate = new Date(log.date);
                    const now = new Date();
                    return logDate.getMonth() === now.getMonth() && logDate.getFullYear() === now.getFullYear();
                  })
                  .reduce((sum, log) => sum + (log.pages || 0), 0)}
              </div>
            </div>
            <div className="bg-white rounded-lg shadow p-4">
              <div className="text-xs text-gray-500 uppercase mb-1">Active Translators</div>
              <div className="text-2xl font-bold text-green-600">
                {new Set(pagesLogs.map(log => log.translator_id)).size}
              </div>
            </div>
            <div className="bg-white rounded-lg shadow p-4">
              <div className="text-xs text-gray-500 uppercase mb-1">Entries This Month</div>
              <div className="text-2xl font-bold text-gray-800">
                {pagesLogs.filter(log => {
                  const logDate = new Date(log.date);
                  const now = new Date();
                  return logDate.getMonth() === now.getMonth() && logDate.getFullYear() === now.getFullYear();
                }).length}
              </div>
            </div>
          </div>

          {/* Add Pages Form */}
          <div className="bg-white rounded-lg shadow p-4">
            <h2 className="text-sm font-bold text-gray-700 mb-3">üìù Log Translated Pages</h2>
            <div className="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
              <div>
                <label className="block text-xs text-gray-500 mb-1">Translator</label>
                <select
                  value={pagesForm.translator_id}
                  onChange={(e) => setPagesForm({...pagesForm, translator_id: e.target.value})}
                  className="w-full border rounded p-2 text-sm"
                >
                  <option value="">Select translator...</option>
                  {translators.map(t => (
                    <option key={t.translator_id || t._id} value={t.translator_id || t._id}>
                      {t.name} {t.role ? `(${t.role})` : ''}
                    </option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-xs text-gray-500 mb-1">Date</label>
                <input
                  type="date"
                  value={pagesForm.date}
                  onChange={(e) => setPagesForm({...pagesForm, date: e.target.value})}
                  className="w-full border rounded p-2 text-sm"
                />
              </div>
              <div>
                <label className="block text-xs text-gray-500 mb-1">Pages</label>
                <input
                  type="number"
                  value={pagesForm.pages}
                  onChange={(e) => setPagesForm({...pagesForm, pages: e.target.value})}
                  className="w-full border rounded p-2 text-sm"
                  placeholder="Number of pages"
                />
              </div>
              <div>
                <label className="block text-xs text-gray-500 mb-1">Note (optional)</label>
                <input
                  type="text"
                  value={pagesForm.note}
                  onChange={(e) => setPagesForm({...pagesForm, note: e.target.value})}
                  className="w-full border rounded p-2 text-sm"
                  placeholder="Project or comment"
                />
              </div>
              <div>
                <button
                  onClick={handleAddPagesLog}
                  disabled={addingPages || !pagesForm.translator_id || !pagesForm.pages}
                  className="w-full py-2 bg-green-600 text-white rounded text-sm font-medium hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                >
                  {addingPages ? 'Adding...' : '+ Add Entry'}
                </button>
              </div>
            </div>
          </div>

          {/* Pages Log Table */}
          <div className="bg-white rounded-lg shadow">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
              <h2 className="text-sm font-bold text-gray-700">üìä Monthly Pages Summary</h2>
              <button
                onClick={fetchPagesLogs}
                className="px-3 py-1 bg-gray-200 text-gray-700 rounded text-xs hover:bg-gray-300"
              >
                Refresh
              </button>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="text-left p-3 font-medium text-gray-600">Translator</th>
                    <th className="text-left p-3 font-medium text-gray-600">Date</th>
                    <th className="text-right p-3 font-medium text-gray-600">Pages</th>
                    <th className="text-left p-3 font-medium text-gray-600">Note</th>
                    <th className="text-center p-3 font-medium text-gray-600">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {pagesLogs.length === 0 ? (
                    <tr>
                      <td colSpan="5" className="p-8 text-center text-gray-500">
                        No pages logged yet. Use the form above to add entries.
                      </td>
                    </tr>
                  ) : (
                    pagesLogs.map((log, idx) => (
                      <tr key={log._id || idx} className="border-t hover:bg-gray-50">
                        <td className="p-3 font-medium text-gray-800">
                          {log.translator_name || log.translator_id}
                          {log.auto_generated && <span className="ml-1 text-xs text-green-600">‚úì Auto</span>}
                        </td>
                        <td className="p-3 text-gray-600">{new Date(log.date).toLocaleDateString('en-US', { timeZone: 'America/New_York' })}</td>
                        <td className="p-3 text-right font-bold text-blue-600">{log.pages}</td>
                        <td className="p-3 text-gray-500 text-xs">
                          {log.note || '-'}
                          {log.order_number && <span className="ml-1 text-blue-500">({log.order_number})</span>}
                        </td>
                        <td className="p-3 text-center space-x-2">
                          <button
                            onClick={() => handleEditPagesLog(log)}
                            className="text-blue-500 hover:text-blue-700 text-xs"
                          >
                            Edit
                          </button>
                          <button
                            onClick={() => handleDeletePagesLog(log._id)}
                            className="text-red-500 hover:text-red-700 text-xs"
                          >
                            Delete
                          </button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>

            {/* Monthly Totals by Translator */}
            {pagesLogs.length > 0 && (
              <div className="p-4 border-t bg-gray-50">
                <h3 className="text-sm font-bold text-gray-700 mb-3">üìà Totals by Translator (This Month)</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  {Object.entries(
                    pagesLogs
                      .filter(log => {
                        const logDate = new Date(log.date);
                        const now = new Date();
                        return logDate.getMonth() === now.getMonth() && logDate.getFullYear() === now.getFullYear();
                      })
                      .reduce((acc, log) => {
                        const name = log.translator_name || log.translator_id;
                        acc[name] = (acc[name] || 0) + (log.pages || 0);
                        return acc;
                      }, {})
                  )
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, total]) => (
                      <div key={name} className="bg-white rounded border p-3">
                        <div className="text-xs text-gray-500 truncate">{name}</div>
                        <div className="text-lg font-bold text-blue-600">{total} pages</div>
                      </div>
                    ))}
                </div>
              </div>
            )}
          </div>

          {/* Edit Pages Modal */}
          {editingPagesLog && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-bold text-gray-800">Edit Pages Entry</h3>
                  <button
                    onClick={() => setEditingPagesLog(null)}
                    className="text-gray-500 hover:text-gray-700"
                  >
                    ‚úï
                  </button>
                </div>
                <div className="space-y-4">
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">Translator</label>
                    <input
                      type="text"
                      value={editingPagesLog.translator_name || editingPagesLog.translator_id}
                      disabled
                      className="w-full border rounded p-2 text-sm bg-gray-100"
                    />
                  </div>
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">Date</label>
                    <input
                      type="date"
                      value={editPagesForm.date}
                      onChange={(e) => setEditPagesForm({...editPagesForm, date: e.target.value})}
                      className="w-full border rounded p-2 text-sm"
                    />
                  </div>
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">Pages *</label>
                    <input
                      type="number"
                      value={editPagesForm.pages}
                      onChange={(e) => setEditPagesForm({...editPagesForm, pages: e.target.value})}
                      className="w-full border rounded p-2 text-sm"
                    />
                  </div>
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">Note</label>
                    <input
                      type="text"
                      value={editPagesForm.note}
                      onChange={(e) => setEditPagesForm({...editPagesForm, note: e.target.value})}
                      className="w-full border rounded p-2 text-sm"
                    />
                  </div>
                  <div className="flex space-x-3 mt-4">
                    <button
                      onClick={() => setEditingPagesLog(null)}
                      className="flex-1 py-2 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={handleUpdatePagesLog}
                      disabled={!editPagesForm.pages}
                      className="flex-1 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:bg-gray-300"
                    >
                      Save Changes
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      )}

      {/* QuickBooks Integration View */}
      {activeView === 'quickbooks' && (
        <div className="space-y-6">
          {/* Connection Status */}
          <div className="bg-white rounded-lg shadow p-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center">
                <span className="text-2xl mr-3">üìä</span>
                <div>
                  <h2 className="text-sm font-bold text-gray-700">QuickBooks Online</h2>
                  <p className="text-xs text-gray-500">Sync invoices and payments with QuickBooks</p>
                </div>
              </div>
              <div className="flex items-center space-x-2">
                {qbConnected ? (
                  <>
                    <span className="flex items-center px-3 py-1 bg-green-100 text-green-700 rounded text-sm">
                      <span className="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                      Connected
                    </span>
                  </>
                ) : (
                  <span className="flex items-center px-3 py-1 bg-gray-100 text-gray-600 rounded text-sm">
                    <span className="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>
                    Not Connected - Go to Settings to connect
                  </span>
                )}
              </div>
            </div>
          </div>

          {qbConnected ? (
            <>
              {/* Paid Orders - Send Receipts */}
              <div className="bg-white rounded-lg shadow">
                <div className="p-4 border-b bg-gray-50">
                  <h2 className="text-sm font-bold text-gray-700">üßæ Paid Orders - Send Receipts</h2>
                  <p className="text-xs text-gray-500 mt-1">Send payment receipts to Partners via QuickBooks</p>
                </div>
                <div className="p-4">
                  {paidOrders.length === 0 ? (
                    <p className="text-gray-500 text-sm text-center py-4">No paid orders found</p>
                  ) : (
                    <div className="space-y-2">
                      {paidOrders.map(order => {
                        const isPartnerOrder = order.partner_id && order.partner_id !== 'manual' && order.partner_id !== 'direct_client' && order.partner_id !== 'admin_quote';
                        return (
                        <div key={order.id} className="flex items-center justify-between p-3 border rounded hover:bg-gray-50">
                          <div className="flex-1">
                            <div className="flex items-center space-x-3">
                              <span className="font-medium text-sm text-gray-800">#{order.order_number}</span>
                              {isPartnerOrder ? (
                                <>
                                  <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">Partner</span>
                                  <span className="text-xs text-gray-500">{order.partner_company || order.client_name}</span>
                                  <span className="text-xs text-gray-400">{order.partner_email || order.client_email}</span>
                                </>
                              ) : (
                                <>
                                  <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">Direct</span>
                                  <span className="text-xs text-gray-500">{order.client_name}</span>
                                  <span className="text-xs text-gray-400">{order.client_email}</span>
                                </>
                              )}
                            </div>
                            <div className="flex items-center space-x-3 mt-1">
                              <span className="text-sm font-bold text-green-600">{formatCurrency(order.total_price)}</span>
                              <span className="text-xs text-gray-500">{order.document_type || order.service_type}</span>
                              {order.quickbooks_invoice_id && (
                                <span className="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">
                                  QB Receipt #{order.quickbooks_invoice_number}
                                </span>
                              )}
                            </div>
                          </div>
                          <div className="flex items-center space-x-2">
                            {order.quickbooks_invoice_id ? (
                              <span className="px-3 py-1 bg-green-100 text-green-700 text-xs rounded">
                                ‚úì Synced
                              </span>
                            ) : (
                              <button
                                onClick={() => syncOrderToQuickBooks(order)}
                                disabled={qbSyncing[order.id]}
                                className="px-4 py-2 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:bg-gray-300 flex items-center"
                              >
                                {qbSyncing[order.id] ? (
                                  <>
                                    <svg className="animate-spin h-4 w-4 mr-2" viewBox="0 0 24 24">
                                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"></circle>
                                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Syncing...
                                  </>
                                ) : (
                                  <>üßæ Send Receipt</>
                                )}
                              </button>
                            )}
                          </div>
                        </div>
                      );})}
                    </div>
                  )}
                </div>
              </div>

              {/* Info Box */}
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 className="text-sm font-medium text-blue-800 mb-2">How Partner Receipts Work</h3>
                <ul className="text-xs text-blue-700 space-y-1">
                  <li>‚Ä¢ Click "Send Receipt" to create a sales receipt in QuickBooks for paid orders</li>
                  <li>‚Ä¢ The receipt confirms payment and is sent to the Partner (not the end client)</li>
                  <li>‚Ä¢ Partners receive payments from their clients and remit to Legacy Translations</li>
                  <li>‚Ä¢ Receipts are for record-keeping only - the payment has already been received</li>
                </ul>
              </div>
            </>
          ) : (
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
              <span className="text-4xl mb-3 block">üîó</span>
              <h3 className="text-lg font-medium text-yellow-800 mb-2">QuickBooks Not Connected</h3>
              <p className="text-sm text-yellow-700 mb-4">
                Connect your QuickBooks account to automatically create and send invoices to clients.
              </p>
              <p className="text-xs text-yellow-600">
                Go to <strong>Settings ‚Üí Integrations</strong> to connect QuickBooks
              </p>
            </div>
          )}
        </div>
      )}

      {/* Partners View */}
      {activeView === 'partners' && (
        <div className="space-y-6">
          {/* Summary Cards */}
          <div className="grid grid-cols-3 gap-6">
            <div className="bg-white rounded-lg shadow p-4">
              <div className="text-xs text-gray-500 uppercase mb-1">Total Partners</div>
              <div className="text-2xl font-bold text-gray-800">{partnerStats.summary?.total_partners || 0}</div>
            </div>
            <div className="bg-white rounded-lg shadow p-4">
              <div className="text-xs text-gray-500 uppercase mb-1">Total Received</div>
              <div className="text-2xl font-bold text-green-600">{formatCurrency(partnerStats.summary?.total_received || 0)}</div>
            </div>
            <div className="bg-white rounded-lg shadow p-4">
              <div className="text-xs text-gray-500 uppercase mb-1">Total Pending</div>
              <div className="text-2xl font-bold text-yellow-600">{formatCurrency(partnerStats.summary?.total_pending || 0)}</div>
            </div>
          </div>

          {/* Email Search Tool */}
          <div className="bg-white rounded-lg shadow">
            <div className="p-4 border-b bg-blue-50">
              <h2 className="text-sm font-bold text-gray-700">üîç Find Email in System</h2>
              <p className="text-xs text-gray-500 mt-1">Search where an email is registered (partners, customers, admin users, salespersons)</p>
            </div>
            <div className="p-4">
              <div className="flex gap-2 mb-3">
                <input
                  type="email"
                  value={emailSearchQuery}
                  onChange={(e) => setEmailSearchQuery(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && findEmailInSystem()}
                  placeholder="Enter email to search..."
                  className="flex-1 px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <button
                  onClick={findEmailInSystem}
                  disabled={emailSearching}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 disabled:opacity-50"
                >
                  {emailSearching ? 'Searching...' : 'Search'}
                </button>
              </div>

              {emailSearchResult && (
                <div className={`p-3 rounded-lg ${emailSearchResult.status === 'found' ? 'bg-yellow-50 border border-yellow-200' : 'bg-green-50 border border-green-200'}`}>
                  {emailSearchResult.status === 'not_found' ? (
                    <p className="text-sm text-green-700">{emailSearchResult.message}</p>
                  ) : (
                    <div>
                      <p className="text-sm font-medium text-yellow-800 mb-2">Email found in {emailSearchResult.found_in.length} collection(s):</p>
                      <div className="space-y-2">
                        {emailSearchResult.found_in.map((item, idx) => (
                          <div key={idx} className="flex items-center justify-between bg-white p-2 rounded border">
                            <div>
                              <span className="text-xs font-medium px-2 py-1 rounded bg-gray-100 text-gray-700">{item.collection}</span>
                              <span className="ml-2 text-sm text-gray-600">{item.name || 'N/A'}</span>
                              {item.role && <span className="ml-2 text-xs text-gray-500">({item.role})</span>}
                            </div>
                            <button
                              onClick={() => deleteEmailFromSystem(item.collection)}
                              className="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200"
                            >
                              Delete from {item.collection}
                            </button>
                          </div>
                        ))}
                      </div>
                      {emailSearchResult.found_in.length > 1 && (
                        <button
                          onClick={() => deleteEmailFromSystem()}
                          className="mt-3 px-3 py-1.5 text-xs bg-red-600 text-white rounded hover:bg-red-700"
                        >
                          Delete from ALL collections
                        </button>
                      )}
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>

          {/* Partners Table */}
          <div className="bg-white rounded-lg shadow">
            <div className="p-4 border-b bg-gray-50">
              <h2 className="text-sm font-bold text-gray-700">ü§ù Partner Companies</h2>
              <p className="text-xs text-gray-500 mt-1">Revenue from Partner Portal orders</p>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Company Name</th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contact</th>
                    <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Orders Paid</th>
                    <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Orders Pending</th>
                    <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Payment Plan</th>
                    <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total Received</th>
                    <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total Pending</th>
                    <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                    <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {partnerStats.partners?.length === 0 ? (
                    <tr>
                      <td colSpan="9" className="px-4 py-8 text-center text-gray-500">
                        No partner orders found
                      </td>
                    </tr>
                  ) : (
                    partnerStats.partners?.map((partner) => (
                      <tr key={partner.partner_id} className={`hover:bg-gray-50 ${!partner.is_real_partner ? 'bg-orange-50' : ''}`}>
                        <td className="px-4 py-3">
                          <div className="font-medium text-gray-800">
                            {partner.company_name}
                            {!partner.is_real_partner && (
                              <span className="ml-2 px-1.5 py-0.5 text-xs bg-orange-200 text-orange-700 rounded" title="This is not a registered partner - orders created manually or from other sources">
                                Not Registered
                              </span>
                            )}
                          </div>
                          {partner.contact_name && (
                            <div className="text-xs text-gray-500">{partner.contact_name}</div>
                          )}
                        </td>
                        <td className="px-4 py-3">
                          {partner.email ? (
                            <div className="space-y-1">
                              <a
                                href={`mailto:${partner.email}`}
                                className="text-blue-600 hover:text-blue-800 text-xs flex items-center gap-1"
                                title={`Send email to ${partner.email}`}
                              >
                                üìß {partner.email}
                              </a>
                              {partner.phone && (
                                <a
                                  href={`tel:${partner.phone}`}
                                  className="text-green-600 hover:text-green-800 text-xs flex items-center gap-1"
                                >
                                  üìû {partner.phone}
                                </a>
                              )}
                            </div>
                          ) : (
                            <span className="text-gray-400 text-xs">No contact info</span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-center">
                          <span className="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700">
                            {partner.orders_paid}
                          </span>
                        </td>
                        <td className="px-4 py-3 text-center">
                          <span className="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-700">
                            {partner.orders_pending}
                          </span>
                        </td>
                        <td className="px-4 py-3 text-center">
                          {partner.is_real_partner ? (
                            <select
                              value={partner.payment_plan || 'pay_per_order'}
                              onChange={(e) => {
                                if (window.confirm(`Change payment plan for ${partner.company_name} to ${e.target.options[e.target.selectedIndex].text}?`)) {
                                  setPartnerPaymentPlan(partner.partner_id, e.target.value);
                                }
                              }}
                              className={`text-xs px-2 py-1 rounded border ${
                                partner.payment_plan === 'monthly' ? 'bg-purple-100 border-purple-300 text-purple-700' :
                                partner.payment_plan === 'biweekly' ? 'bg-blue-100 border-blue-300 text-blue-700' :
                                'bg-gray-100 border-gray-300 text-gray-700'
                              }`}
                            >
                              <option value="pay_per_order">Pay Per Order</option>
                              <option value="biweekly">Biweekly Invoice</option>
                              <option value="monthly">Monthly Invoice</option>
                            </select>
                          ) : (
                            <span className="text-xs text-gray-400">N/A</span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-right font-medium text-green-600">
                          {formatCurrency(partner.total_received)}
                        </td>
                        <td className="px-4 py-3 text-right font-medium text-yellow-600">
                          {formatCurrency(partner.total_pending)}
                        </td>
                        <td className="px-4 py-3 text-right font-bold text-gray-800">
                          {formatCurrency(partner.total_received + partner.total_pending)}
                        </td>
                        <td className="px-4 py-3 text-center">
                          <div className="flex items-center justify-center space-x-1">
                            {partner.is_real_partner ? (
                              <>
                                <button
                                  onClick={() => handleOpenCreateInvoice(partner)}
                                  className="p-1.5 text-blue-600 hover:bg-blue-50 rounded transition-colors"
                                  title="Create Invoice"
                                  disabled={partner.orders_pending === 0}
                                >
                                  üìÑ
                                </button>
                                <button
                                  onClick={() => handleOpenInvoices(partner)}
                                  className="p-1.5 text-teal-600 hover:bg-teal-50 rounded transition-colors"
                                  title="View Invoices"
                                >
                                  üìã
                                </button>
                                <button
                                  onClick={() => handleOpenCouponModal(partner)}
                                  className="p-1.5 text-purple-600 hover:bg-purple-50 rounded transition-colors"
                                  title="Manage Discounts"
                                >
                                  üè∑Ô∏è
                                </button>
                                <button
                                  onClick={() => togglePartnerInvoiceUnlock(partner.partner_id, partner.company_name, partner.payment_plan_approved)}
                                  className={`p-1.5 rounded transition-colors ${
                                    partner.payment_plan_approved
                                      ? 'text-green-600 hover:bg-green-50'
                                      : 'text-amber-600 hover:bg-amber-50'
                                  }`}
                                  title={partner.payment_plan_approved ? 'Invoice payments unlocked - Click to lock' : 'Invoice payments locked - Click to unlock'}
                                >
                                  {partner.payment_plan_approved ? 'üîì' : 'üîí'}
                                </button>
                                <button
                                  onClick={() => {
                                    if (window.confirm(`Are you sure you want to delete partner "${partner.company_name}"?\n\nThis action cannot be undone.`)) {
                                      deletePartner(partner.partner_id);
                                    }
                                  }}
                                  className="p-1.5 text-red-600 hover:bg-red-50 rounded transition-colors"
                                  title="Delete partner"
                                >
                                  üóëÔ∏è
                                </button>
                              </>
                            ) : (
                              <span className="text-xs text-gray-400" title="Actions not available for non-registered entries">
                                -
                              </span>
                            )}
                          </div>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>

          {/* All Invoices Summary */}
          {partnerInvoices.length > 0 && (
            <div className="bg-white rounded-lg shadow">
              <div className="p-4 border-b bg-gray-50 flex items-center justify-between">
                <div>
                  <h2 className="text-sm font-bold text-gray-700">üìã Recent Invoices</h2>
                  <p className="text-xs text-gray-500 mt-1">All partner invoices</p>
                </div>
                <button
                  onClick={sendBulkReminders}
                  className="px-3 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 flex items-center gap-1"
                  title="Send reminders to all partners with invoices due soon"
                >
                  üìß Send Bulk Reminders
                </button>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Invoice #</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Partner</th>
                      <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Orders</th>
                      <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                      <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Due Date</th>
                      <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {partnerInvoices.slice(0, 10).map((invoice) => {
                      const dueDate = invoice.due_date ? new Date(invoice.due_date) : null;
                      const now = new Date();
                      const daysUntilDue = dueDate ? Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24)) : null;
                      const isOverdue = daysUntilDue !== null && daysUntilDue < 0;
                      const isDueSoon = daysUntilDue !== null && daysUntilDue >= 0 && daysUntilDue <= 3;

                      return (
                        <tr key={invoice.id} className={`hover:bg-gray-50 ${isOverdue ? 'bg-red-50' : isDueSoon && invoice.status !== 'paid' ? 'bg-yellow-50' : ''}`}>
                          <td className="px-4 py-3 font-mono text-xs">{invoice.invoice_number}</td>
                          <td className="px-4 py-3">{invoice.partner_company}</td>
                          <td className="px-4 py-3 text-center">{invoice.order_ids?.length || 0}</td>
                          <td className="px-4 py-3 text-right font-medium">{formatCurrency(invoice.total_amount)}</td>
                          <td className="px-4 py-3 text-center">
                            <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-medium ${
                              invoice.status === 'paid' ? 'bg-green-100 text-green-700' :
                              invoice.status === 'overdue' || isOverdue ? 'bg-red-100 text-red-700' :
                              'bg-yellow-100 text-yellow-700'
                            }`}>
                              {invoice.status === 'pending' && isOverdue ? 'overdue' : invoice.status}
                            </span>
                          </td>
                          <td className="px-4 py-3 text-xs">
                            <div>
                              {dueDate ? dueDate.toLocaleDateString() : '-'}
                              {daysUntilDue !== null && invoice.status !== 'paid' && (
                                <div className={`text-xs ${isOverdue ? 'text-red-600 font-medium' : isDueSoon ? 'text-yellow-600' : 'text-gray-400'}`}>
                                  {isOverdue ? `${Math.abs(daysUntilDue)} days overdue` : daysUntilDue === 0 ? 'Due today' : `${daysUntilDue} days left`}
                                </div>
                              )}
                            </div>
                          </td>
                          <td className="px-4 py-3 text-center">
                            {invoice.status !== 'paid' && (
                              <button
                                onClick={() => sendInvoiceReminder(invoice.id, invoice.invoice_number)}
                                disabled={sendingReminder === invoice.id}
                                className="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded hover:bg-blue-200 disabled:opacity-50"
                                title={`Send reminder${invoice.reminder_sent_count ? ` (${invoice.reminder_sent_count} sent)` : ''}`}
                              >
                                {sendingReminder === invoice.id ? '...' : 'üìß'}
                                {invoice.reminder_sent_count > 0 && (
                                  <span className="ml-1 text-gray-500">({invoice.reminder_sent_count})</span>
                                )}
                              </button>
                            )}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Pending Zelle Verifications */}
          {pendingZelleInvoices.length > 0 && (
            <div className="bg-white rounded-lg shadow border-l-4 border-purple-500">
              <div className="p-4 border-b bg-purple-50">
                <div className="flex items-center justify-between">
                  <div>
                    <h2 className="text-sm font-bold text-purple-800">üè¶ Pending Zelle Verifications</h2>
                    <p className="text-xs text-purple-600 mt-1">Invoices awaiting Zelle payment verification</p>
                  </div>
                  <span className="bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded-full">
                    {pendingZelleInvoices.length}
                  </span>
                </div>
              </div>
              <div className="divide-y">
                {pendingZelleInvoices.map((invoice) => (
                  <div key={invoice.id} className="p-4 hover:bg-gray-50">
                    <div className="flex items-center justify-between">
                      <div>
                        <div className="font-mono font-medium text-sm">{invoice.invoice_number}</div>
                        <div className="text-sm text-gray-600">{invoice.partner_company}</div>
                        <div className="text-xs text-gray-500">
                          Submitted: {invoice.zelle_submitted_at ? new Date(invoice.zelle_submitted_at).toLocaleString() : '-'}
                        </div>
                      </div>
                      <div className="flex items-center space-x-3">
                        <div className="text-right">
                          <div className="font-bold text-lg">{formatCurrency(invoice.total_amount)}</div>
                          {invoice.zelle_receipt_url && (
                            <a
                              href={invoice.zelle_receipt_url}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="text-xs text-blue-600 hover:underline"
                            >
                              View Receipt
                            </a>
                          )}
                        </div>
                        <div className="flex flex-col space-y-1">
                          <button
                            onClick={() => handleApproveZellePayment(invoice.id)}
                            className="px-3 py-1.5 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                          >
                            Approve
                          </button>
                          <button
                            onClick={() => handleRejectZellePayment(invoice.id)}
                            className="px-3 py-1.5 bg-red-600 text-white text-xs rounded hover:bg-red-700"
                          >
                            Reject
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Invoice Notifications */}
          {invoiceNotifications.length > 0 && (
            <div className="bg-white rounded-lg shadow">
              <div className="p-4 border-b bg-gray-50">
                <div className="flex items-center justify-between">
                  <div>
                    <h2 className="text-sm font-bold text-gray-700">üîî Payment Notifications</h2>
                    <p className="text-xs text-gray-500 mt-1">Recent invoice payment activity</p>
                  </div>
                  {unreadNotifCount > 0 && (
                    <span className="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                      {unreadNotifCount} new
                    </span>
                  )}
                </div>
              </div>
              <div className="divide-y max-h-64 overflow-y-auto">
                {invoiceNotifications.slice(0, 10).map((notif) => (
                  <div
                    key={notif.id}
                    className={`p-3 hover:bg-gray-50 ${!notif.is_read ? 'bg-blue-50' : ''}`}
                    onClick={() => !notif.is_read && handleMarkNotificationRead(notif.id)}
                  >
                    <div className="flex items-center justify-between">
                      <div>
                        <div className="text-sm font-medium flex items-center">
                          {notif.type === 'invoice_stripe_paid' && <span className="mr-2">üí≥</span>}
                          {notif.type === 'invoice_zelle_receipt' && <span className="mr-2">üè¶</span>}
                          {notif.type === 'invoice_payment_approved' && <span className="mr-2">‚úÖ</span>}
                          {notif.title}
                        </div>
                        <div className="text-xs text-gray-500">{notif.message}</div>
                      </div>
                      <div className="text-xs text-gray-400">
                        {new Date(notif.created_at).toLocaleString()}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Payment History */}
          {paymentHistory.length > 0 && (
            <div className="bg-white rounded-lg shadow">
              <div className="p-4 border-b bg-gray-50">
                <h2 className="text-sm font-bold text-gray-700">üí∞ Payment History</h2>
                <p className="text-xs text-gray-500 mt-1">Completed invoice payments</p>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Invoice #</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Partner</th>
                      <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Method</th>
                      <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                      <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Orders</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {paymentHistory.slice(0, 15).map((payment) => (
                      <tr key={payment.id} className="hover:bg-gray-50">
                        <td className="px-4 py-3 text-xs">
                          {payment.paid_at ? new Date(payment.paid_at).toLocaleDateString() : '-'}
                        </td>
                        <td className="px-4 py-3 font-mono text-xs">{payment.invoice_number}</td>
                        <td className="px-4 py-3">{payment.partner_company}</td>
                        <td className="px-4 py-3 text-center">
                          <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-medium ${
                            payment.payment_method === 'stripe' ? 'bg-blue-100 text-blue-700' :
                            payment.payment_method === 'zelle' ? 'bg-purple-100 text-purple-700' :
                            'bg-gray-100 text-gray-700'
                          }`}>
                            {payment.payment_method === 'stripe' ? 'üí≥ Card' :
                             payment.payment_method === 'zelle' ? 'üè¶ Zelle' :
                             payment.payment_method}
                          </span>
                        </td>
                        <td className="px-4 py-3 text-right font-medium text-green-600">
                          {formatCurrency(payment.amount)}
                        </td>
                        <td className="px-4 py-3 text-center text-gray-500">{payment.order_count}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </div>
      )}

      {/* Create Invoice Modal */}
      {showCreateInvoiceModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
              <div>
                <h2 className="font-bold text-gray-800">Create Invoice</h2>
                <p className="text-sm text-gray-500">{selectedPartnerForInvoice?.company_name}</p>
              </div>
              <button onClick={() => setShowCreateInvoiceModal(false)} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div className="p-4 overflow-y-auto max-h-[60vh]">
              {partnerOrdersForInvoice.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                  No pending orders available for invoicing
                </div>
              ) : (
                <>
                  <div className="mb-4 flex items-center justify-between">
                    <label className="flex items-center text-sm">
                      <input
                        type="checkbox"
                        checked={selectedOrdersForInvoice.length === partnerOrdersForInvoice.length}
                        onChange={selectAllOrders}
                        className="mr-2"
                      />
                      Select All ({partnerOrdersForInvoice.length} orders)
                    </label>
                    <div className="text-sm font-medium">
                      Selected: {formatCurrency(partnerOrdersForInvoice.filter(o => selectedOrdersForInvoice.includes(o.id)).reduce((sum, o) => sum + (o.total_price || 0), 0))}
                    </div>
                  </div>
                  <div className="space-y-2 mb-4">
                    {partnerOrdersForInvoice.map((order) => (
                      <div
                        key={order.id}
                        className={`p-3 border rounded-lg cursor-pointer transition-colors ${
                          selectedOrdersForInvoice.includes(order.id) ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:bg-gray-50'
                        }`}
                        onClick={() => toggleOrderSelection(order.id)}
                      >
                        <div className="flex items-center justify-between">
                          <div className="flex items-center">
                            <input
                              type="checkbox"
                              checked={selectedOrdersForInvoice.includes(order.id)}
                              onChange={() => toggleOrderSelection(order.id)}
                              className="mr-3"
                              onClick={(e) => e.stopPropagation()}
                            />
                            <div>
                              <div className="font-medium text-sm">{order.order_number}</div>
                              <div className="text-xs text-gray-500">
                                {order.client_name} - {order.translate_from} to {order.translate_to}
                              </div>
                              <div className="text-xs text-gray-400">
                                {new Date(order.created_at).toLocaleDateString()}
                              </div>
                            </div>
                          </div>
                          <div className="font-medium text-sm">{formatCurrency(order.total_price)}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                  <div className="grid grid-cols-2 gap-4 mb-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Due in (days)</label>
                      <select
                        value={invoiceDueDays}
                        onChange={(e) => setInvoiceDueDays(parseInt(e.target.value))}
                        className="w-full border rounded-md px-3 py-2 text-sm"
                      >
                        <option value={7}>7 days</option>
                        <option value={15}>15 days</option>
                        <option value={30}>30 days</option>
                        <option value={45}>45 days</option>
                        <option value={60}>60 days</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Notes (optional)</label>
                      <input
                        type="text"
                        value={invoiceNotes}
                        onChange={(e) => setInvoiceNotes(e.target.value)}
                        className="w-full border rounded-md px-3 py-2 text-sm"
                        placeholder="Invoice notes..."
                      />
                    </div>
                  </div>
                </>
              )}
            </div>
            <div className="p-4 border-t bg-gray-50 flex justify-between items-center">
              <div className="text-sm">
                <span className="font-medium">{selectedOrdersForInvoice.length}</span> orders selected
              </div>
              <div className="flex space-x-2">
                <button
                  onClick={() => setShowCreateInvoiceModal(false)}
                  className="px-4 py-2 border rounded-md text-sm hover:bg-gray-100"
                >
                  Cancel
                </button>
                <button
                  onClick={handleCreateInvoice}
                  disabled={creatingInvoice || selectedOrdersForInvoice.length === 0}
                  className="px-4 py-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                >
                  {creatingInvoice ? 'Creating...' : 'Create Invoice'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* View Invoices Modal */}
      {showInvoicesModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
              <div>
                <h2 className="font-bold text-gray-800">Invoices</h2>
                <p className="text-sm text-gray-500">{selectedPartnerForInvoice?.company_name}</p>
              </div>
              <button onClick={() => setShowInvoicesModal(false)} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div className="p-4 overflow-y-auto max-h-[70vh]">
              {selectedPartnerInvoices.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                  No invoices found for this partner
                </div>
              ) : (
                <div className="space-y-4">
                  {selectedPartnerInvoices.map((invoice) => (
                    <div key={invoice.id} className="border rounded-lg p-4">
                      <div className="flex items-center justify-between mb-3">
                        <div>
                          <div className="font-mono font-medium">{invoice.invoice_number}</div>
                          <div className="text-xs text-gray-500">
                            Created: {new Date(invoice.created_at).toLocaleDateString()} |
                            Due: {invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : '-'}
                          </div>
                        </div>
                        <div className="flex items-center space-x-2">
                          <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-medium ${
                            invoice.status === 'paid' ? 'bg-green-100 text-green-700' :
                            invoice.status === 'overdue' ? 'bg-red-100 text-red-700' :
                            'bg-yellow-100 text-yellow-700'
                          }`}>
                            {invoice.status}
                          </span>
                          <span className="font-bold text-lg">{formatCurrency(invoice.total_amount)}</span>
                        </div>
                      </div>
                      <div className="text-xs text-gray-500 mb-2">
                        {invoice.order_ids?.length || 0} orders |
                        {invoice.payment_method && ` Payment: ${invoice.payment_method}`}
                        {invoice.zelle_receipt_url && (
                          <a href={invoice.zelle_receipt_url} target="_blank" rel="noopener noreferrer" className="ml-2 text-blue-600 hover:underline">
                            View Receipt
                          </a>
                        )}
                      </div>
                      {invoice.notes && (
                        <div className="text-xs text-gray-600 mb-2">Notes: {invoice.notes}</div>
                      )}
                      {/* QuickBooks Integration */}
                      {qbConnected && (
                        <div className="flex items-center space-x-2 mb-2">
                          {invoice.quickbooks_invoice_id ? (
                            <span className="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700">
                              QB Invoice #{invoice.quickbooks_invoice_number}
                            </span>
                          ) : (
                            <button
                              onClick={() => syncPartnerInvoiceToQuickBooks(invoice)}
                              disabled={qbSyncing[`inv_${invoice.id}`]}
                              className="px-3 py-1.5 bg-emerald-600 text-white text-xs rounded hover:bg-emerald-700 disabled:opacity-50 flex items-center space-x-1"
                            >
                              {qbSyncing[`inv_${invoice.id}`] ? (
                                <>
                                  <svg className="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                  </svg>
                                  <span>Syncing...</span>
                                </>
                              ) : (
                                <>
                                  <span>Send to QuickBooks</span>
                                </>
                              )}
                            </button>
                          )}
                        </div>
                      )}
                      {invoice.status !== 'paid' && (
                        <div className="flex space-x-2 mt-3">
                          <button
                            onClick={() => handleMarkInvoicePaid(invoice.id, 'zelle')}
                            className="px-3 py-1.5 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                          >
                            Mark as Paid (Zelle)
                          </button>
                          <button
                            onClick={() => handleMarkInvoicePaid(invoice.id, 'card')}
                            className="px-3 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700"
                          >
                            Mark as Paid (Card)
                          </button>
                          <button
                            onClick={() => handleDeleteInvoice(invoice.id)}
                            className="px-3 py-1.5 bg-red-600 text-white text-xs rounded hover:bg-red-700"
                          >
                            Delete
                          </button>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
            <div className="p-4 border-t bg-gray-50 flex justify-end">
              <button
                onClick={() => setShowInvoicesModal(false)}
                className="px-4 py-2 border rounded-md text-sm hover:bg-gray-100"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Coupon Management Modal */}
      {showCouponModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
              <div>
                <h2 className="font-bold text-gray-800">Manage Discount</h2>
                <p className="text-sm text-gray-500">{selectedPartnerForCoupon?.company_name}</p>
              </div>
              <button onClick={() => setShowCouponModal(false)} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div className="p-4">
              {/* Current Partner Coupon */}
              {partnerCoupons.length > 0 ? (
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Current Discount</label>
                  <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                    {partnerCoupons.map((coupon) => (
                      <div key={coupon.id} className="flex items-center justify-between">
                        <div>
                          <span className="text-green-700 font-medium">{coupon.code}</span>
                          <span className="text-green-600 text-sm ml-2">
                            ({coupon.discount_type === 'percentage' ? `${coupon.discount_value}% off` : `$${coupon.discount_value} off`})
                          </span>
                        </div>
                        <button
                          onClick={() => handleRemovePartnerCoupon(coupon.id)}
                          className="text-red-500 hover:text-red-700 text-sm"
                        >
                          Remove
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              ) : (
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Current Discount</label>
                  <div className="bg-gray-50 border border-gray-200 rounded-lg p-3 text-gray-500 text-sm">
                    No discount assigned to this partner
                  </div>
                </div>
              )}

              {/* Assign New Coupon */}
              <div className="border-t pt-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">Assign Discount</label>
                <div className="flex gap-2">
                  <select
                    value={selectedCouponToAssign}
                    onChange={(e) => setSelectedCouponToAssign(e.target.value)}
                    className="flex-1 border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                  >
                    {couponTemplates.length > 0 ? (
                      <>
                        <option value="">Select discount...</option>
                        {couponTemplates.map((coupon) => (
                          <option key={coupon.id} value={coupon.code}>
                            {coupon.code} ({coupon.discount_type === 'percentage' ? `${coupon.discount_value}% off` : coupon.discount_type === 'certified_page' ? `${coupon.discount_value} free page${coupon.discount_value > 1 ? 's' : ''}` : `$${coupon.discount_value} off`})
                          </option>
                        ))}
                      </>
                    ) : (
                      <option value="">No discounts available</option>
                    )}
                  </select>
                  <button
                    onClick={handleAssignCoupon}
                    disabled={!selectedCouponToAssign || assigningCoupon || couponTemplates.length === 0}
                    className="px-4 py-2 bg-purple-600 text-white rounded-md text-sm hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                  >
                    {assigningCoupon ? 'Assigning...' : 'Assign'}
                  </button>
                </div>
                <p className="text-xs text-gray-500 mt-2">
                  Available discounts: MASS5 (5%), MASS10 (10%), MASS15 (15%), MASS20 (20%), MASS25 (25%), MASS30 (30%), MASS35 (35%)
                </p>
              </div>
            </div>
            <div className="p-4 border-t bg-gray-50 flex justify-end">
              <button
                onClick={() => setShowCouponModal(false)}
                className="px-4 py-2 border rounded-md text-sm hover:bg-gray-100"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ==================== SET PASSWORD PAGE (Invitation Acceptance) ====================
const SetPasswordPage = ({ inviteToken, onComplete }) => {
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  const [loading, setLoading] = useState(false);
  const [userInfo, setUserInfo] = useState(null);
  const [verifying, setVerifying] = useState(true);
  const [step, setStep] = useState(1); // 1: password, 2: translator info (if translator)

  // Translator-specific fields
  const [languagePairs, setLanguagePairs] = useState('');
  const [ratePerPage, setRatePerPage] = useState('');
  const [ratePerWord, setRatePerWord] = useState('');
  const [paymentMethod, setPaymentMethod] = useState('');
  const [bankName, setBankName] = useState('');
  const [accountHolder, setAccountHolder] = useState('');
  const [accountNumber, setAccountNumber] = useState('');
  const [routingNumber, setRoutingNumber] = useState('');
  const [paypalEmail, setPaypalEmail] = useState('');
  const [zelleEmail, setZelleEmail] = useState('');
  const [acceptedTerms, setAcceptedTerms] = useState(false);
  const [acceptedEthics, setAcceptedEthics] = useState(false);
  const [acceptedProhibitedUse, setAcceptedProhibitedUse] = useState(false);

  const isTranslator = userInfo?.role === 'translator';
  const isPM = userInfo?.role === 'pm';
  const requiresTerms = isTranslator || isPM; // Both translators and PMs must accept terms

  useEffect(() => {
    const verifyToken = async () => {
      try {
        const response = await axios.get(`${API}/admin/auth/verify-invitation?token=${inviteToken}`);
        setUserInfo(response.data.user);
      } catch (err) {
        setError(err.response?.data?.detail || 'Invalid or expired invitation link');
      } finally {
        setVerifying(false);
      }
    };
    verifyToken();
  }, [inviteToken]);

  const handlePasswordStep = (e) => {
    e.preventDefault();
    setError('');

    if (password !== confirmPassword) {
      setError('Passwords do not match');
      return;
    }

    if (password.length < 6) {
      setError('Password must be at least 6 characters');
      return;
    }

    // If translator or PM, go to step 2 for terms acceptance, otherwise submit directly
    if (requiresTerms) {
      setStep(2);
    } else {
      handleFinalSubmit();
    }
  };

  const handleFinalSubmit = async () => {
    setError('');

    // Validate terms acceptance for translators and PMs
    if (requiresTerms) {
      if (!acceptedTerms) {
        setError('You must accept the terms and conditions');
        return;
      }
      if (!acceptedProhibitedUse) {
        setError('You must accept the prohibited use clause');
        return;
      }
      // Ethics only required for translators
      if (isTranslator && !acceptedEthics) {
        setError('You must accept the translator ethics guidelines');
        return;
      }
    }

    setLoading(true);
    try {
      const data = {
        token: inviteToken,
        password: password
      };

      // Add terms acceptance data for translators and PMs
      if (requiresTerms) {
        data.accepted_terms = acceptedTerms;
        data.accepted_prohibited_use = acceptedProhibitedUse;
      }

      // Add translator-specific data
      if (isTranslator) {
        data.language_pairs = languagePairs || null;
        data.rate_per_page = ratePerPage ? parseFloat(ratePerPage) : null;
        data.rate_per_word = ratePerWord ? parseFloat(ratePerWord) : null;
        data.payment_method = paymentMethod || null;
        data.bank_name = bankName || null;
        data.account_holder = accountHolder || null;
        data.account_number = accountNumber || null;
        data.routing_number = routingNumber || null;
        data.paypal_email = paypalEmail || null;
        data.zelle_email = zelleEmail || null;
        data.accepted_ethics = acceptedEthics;
      }

      await axios.post(`${API}/admin/auth/accept-invitation`, data);
      // Clear any existing session to force fresh login with new credentials
      localStorage.removeItem('admin_key');
      localStorage.removeItem('admin_user');
      setSuccess('Account set up successfully! You can now log in.');
      setTimeout(() => onComplete(), 2000);
    } catch (err) {
      setError(err.response?.data?.detail || 'Failed to set up account');
    } finally {
      setLoading(false);
    }
  };

  if (verifying) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center">
        <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
          <p className="text-gray-600">Verifying invitation...</p>
        </div>
      </div>
    );
  }

  if (error && !userInfo) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center">
        <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
          <div className="text-center mb-6">
            <div className="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center mx-auto mb-3">
              <span className="text-xl text-white">!</span>
            </div>
            <h1 className="text-xl font-bold text-gray-800">Invalid Link</h1>
          </div>
          <div className="mb-4 p-3 bg-red-100 text-red-700 rounded text-sm text-center">
            {error}
          </div>
          <button
            onClick={onComplete}
            className="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium"
          >
            Go to Login
          </button>
        </div>
      </div>
    );
  }

  // Step 2: Terms acceptance form (for translators and PMs)
  if (step === 2 && requiresTerms) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center py-8">
        <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg mx-4">
          <div className="text-center mb-6">
            <div className="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-3">
              <span className="text-xl text-white">üìã</span>
            </div>
            <h1 className="text-xl font-bold text-gray-800">Complete Your Profile</h1>
            <p className="text-xs text-gray-500 mt-1">Welcome, {userInfo?.name}!</p>
            <p className="text-xs text-blue-600">Step 2 of 2 - {isTranslator ? 'Translator Information' : 'Terms Acceptance'}</p>
          </div>

          {error && (
            <div className="mb-3 p-2 bg-red-100 text-red-700 rounded text-xs text-center">
              {error}
            </div>
          )}

          {success && (
            <div className="mb-3 p-2 bg-green-100 text-green-700 rounded text-xs text-center">
              {success}
            </div>
          )}

          <div className="space-y-4">
            {/* Language & Rates Section - Translator only */}
            {isTranslator && (
            <div className="border rounded p-3 bg-gray-50">
              <h3 className="text-sm font-medium text-gray-700 mb-3">Language & Rates</h3>
              <div className="space-y-3">
                <div>
                  <label className="block text-xs font-medium text-gray-700 mb-1">Language Pairs *</label>
                  <input
                    type="text"
                    className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                    value={languagePairs}
                    onChange={(e) => setLanguagePairs(e.target.value)}
                    placeholder="e.g. EN-PT, EN-ES, PT-EN"
                  />
                  <p className="text-xs text-gray-500 mt-1">Setote multiple pairs with commas</p>
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">Rate per Page ($)</label>
                    <input
                      type="number"
                      step="0.01"
                      className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                      value={ratePerPage}
                      onChange={(e) => setRatePerPage(e.target.value)}
                      placeholder="e.g. 15.00"
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">Rate per Word ($)</label>
                    <input
                      type="number"
                      step="0.001"
                      className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                      value={ratePerWord}
                      onChange={(e) => setRatePerWord(e.target.value)}
                      placeholder="e.g. 0.08"
                    />
                  </div>
                </div>
              </div>
            </div>
            )}

            {/* Payment Section - Translator only */}
            {isTranslator && (
            <div className="border rounded p-3 bg-gray-50">
              <h3 className="text-sm font-medium text-gray-700 mb-3">Payment Information</h3>
              <div className="space-y-3">
                <div>
                  <label className="block text-xs font-medium text-gray-700 mb-1">Payment Method</label>
                  <select
                    className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                    value={paymentMethod}
                    onChange={(e) => setPaymentMethod(e.target.value)}
                  >
                    <option value="">Select payment method</option>
                    <option value="bank_transfer">Bank Transfer (ACH)</option>
                    <option value="wire_transfer">Wire Transfer</option>
                    <option value="paypal">PayPal</option>
                    <option value="zelle">Zelle</option>
                  </select>
                </div>

                {(paymentMethod === 'bank_transfer' || paymentMethod === 'wire_transfer') && (
                  <div className="space-y-3 pt-2 border-t">
                    <div>
                      <label className="block text-xs font-medium text-gray-700 mb-1">Bank Name</label>
                      <input
                        type="text"
                        className="w-full px-3 py-2 text-sm border border-gray-300 rounded"
                        value={bankName}
                        onChange={(e) => setBankName(e.target.value)}
                        placeholder="Bank name"
                      />
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-gray-700 mb-1">Account Holder Name</label>
                      <input
                        type="text"
                        className="w-full px-3 py-2 text-sm border border-gray-300 rounded"
                        value={accountHolder}
                        onChange={(e) => setAccountHolder(e.target.value)}
                        placeholder="Full name on account"
                      />
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className="block text-xs font-medium text-gray-700 mb-1">Account Number</label>
                        <input
                          type="text"
                          className="w-full px-3 py-2 text-sm border border-gray-300 rounded"
                          value={accountNumber}
                          onChange={(e) => setAccountNumber(e.target.value)}
                          placeholder="Account number"
                        />
                      </div>
                      <div>
                        <label className="block text-xs font-medium text-gray-700 mb-1">Routing Number</label>
                        <input
                          type="text"
                          className="w-full px-3 py-2 text-sm border border-gray-300 rounded"
                          value={routingNumber}
                          onChange={(e) => setRoutingNumber(e.target.value)}
                          placeholder="9-digit routing"
                        />
                      </div>
                    </div>
                  </div>
                )}

                {paymentMethod === 'paypal' && (
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">PayPal Email</label>
                    <input
                      type="email"
                      className="w-full px-3 py-2 text-sm border border-gray-300 rounded"
                      value={paypalEmail}
                      onChange={(e) => setPaypalEmail(e.target.value)}
                      placeholder="your@paypal.com"
                    />
                  </div>
                )}

                {paymentMethod === 'zelle' && (
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">Zelle Email/Phone</label>
                    <input
                      type="text"
                      className="w-full px-3 py-2 text-sm border border-gray-300 rounded"
                      value={zelleEmail}
                      onChange={(e) => setZelleEmail(e.target.value)}
                      placeholder="Email or phone for Zelle"
                    />
                  </div>
                )}
              </div>
            </div>
            )}

            {/* Terms & Ethics Section */}
            <div className="border rounded p-3 bg-gray-50">
              <h3 className="text-sm font-medium text-gray-700 mb-3">Terms Agreement</h3>

              <div className="space-y-3">
                {/* Ethics Guidelines - Translator only */}
                {isTranslator && (
                  <>
                    <div className="bg-white p-3 rounded border text-xs text-gray-600 max-h-32 overflow-y-auto">
                      <strong>Translator Ethics Guidelines (ATA Standards)</strong>
                      <ul className="list-disc ml-4 mt-2 space-y-1">
                        <li>Maintain strict confidentiality of all client documents and information</li>
                        <li>Provide accurate and faithful translations without additions or omissions</li>
                        <li>Only accept work within your area of competence and language expertise</li>
                        <li>Disclose any conflicts of interest before accepting assignments</li>
                        <li>Meet agreed deadlines and communicate promptly about any delays</li>
                        <li>Respect intellectual property rights and copyright laws</li>
                        <li>Maintain professional development and stay current in your field</li>
                        <li>Never use client materials for personal gain or share with third parties</li>
                      </ul>
                    </div>
                    <label className="flex items-start gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={acceptedEthics}
                        onChange={(e) => setAcceptedEthics(e.target.checked)}
                        className="mt-1"
                      />
                      <span className="text-xs text-gray-700">
                        I have read and agree to follow the Translator Ethics Guidelines based on ATA (American Translators Association) standards *
                      </span>
                    </label>
                  </>
                )}

                {/* Terms and Conditions */}
                <div className="bg-white p-3 rounded border text-xs text-gray-600 max-h-32 overflow-y-auto">
                  <strong>Terms and Conditions</strong>
                  <ul className="list-disc ml-4 mt-2 space-y-1">
                    <li>Translations remain property of Legacy Translations until delivered to client</li>
                    <li>Payment is processed within 30 days of approved work completion</li>
                    <li>Work quality is subject to review and revision requests</li>
                    <li>Contractor is responsible for their own taxes (1099 contractor status)</li>
                    <li>Non-compete for direct contact with clients for 12 months</li>
                    <li>Confidentiality obligations continue after contract termination</li>
                  </ul>
                </div>
                <label className="flex items-start gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={acceptedTerms}
                    onChange={(e) => setAcceptedTerms(e.target.checked)}
                    className="mt-1"
                  />
                  <span className="text-xs text-gray-700">
                    I accept the Terms and Conditions for working as a contractor with Legacy Translations *
                  </span>
                </label>

                {/* Prohibited Use Clause */}
                <div className="bg-red-50 p-3 rounded border border-red-200 text-xs text-gray-700 max-h-48 overflow-y-auto">
                  <strong className="text-red-700">Prohibited Use Clause</strong>
                  <p className="mt-2">
                    It is expressly <strong>PROHIBITED</strong> to use the Legacy Translations platform, its tools,
                    templates, and any company resources for any purposes other than those directly related to
                    authorized work within the Legacy Translations system. This includes, but is not limited to:
                  </p>
                  <ul className="list-disc ml-4 mt-2 space-y-1">
                    <li>Using company tools, templates, or resources for personal or third-party projects</li>
                    <li>Sharing login credentials or access links with unauthorized persons</li>
                    <li>Copying or distributing proprietary templates, formats, or methodologies</li>
                    <li>Using the platform to conduct business outside of Legacy Translations</li>
                    <li>Unauthorized access or sharing of client information</li>
                  </ul>
                  <div className="mt-3 p-2 bg-red-100 border border-red-300 rounded">
                    <strong className="text-red-800">‚ö†Ô∏è IMMEDIATE TERMINATION CLAUSE:</strong>
                    <p className="mt-1 text-red-800">
                      If any unauthorized use of the platform is detected, the contractor will be <strong>IMMEDIATELY TERMINATED</strong> without
                      prior notice or any notice period requirement. Legacy Translations reserves the right to pursue legal action for any
                      damages or losses resulting from such violations.
                    </p>
                  </div>
                  <p className="mt-2 font-medium text-red-700">
                    All rights reserved. ¬© {new Date().getFullYear()} Legacy Translations LLC - legacytranslations.com
                  </p>
                </div>
                <label className="flex items-start gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={acceptedProhibitedUse}
                    onChange={(e) => setAcceptedProhibitedUse(e.target.checked)}
                    className="mt-1"
                  />
                  <span className="text-xs text-gray-700">
                    I understand and accept the Prohibited Use Clause, including the Immediate Termination Clause. I acknowledge that unauthorized
                    use of the platform will result in immediate termination without notice. *
                  </span>
                </label>
              </div>
            </div>

            <div className="flex gap-3">
              <button
                type="button"
                onClick={() => setStep(1)}
                className="flex-1 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 text-sm font-medium"
              >
                Back
              </button>
              <button
                type="button"
                onClick={handleFinalSubmit}
                disabled={loading || success || !acceptedTerms || !acceptedProhibitedUse || (isTranslator && !acceptedEthics)}
                className="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400 text-sm font-medium"
              >
                {loading ? 'Setting up...' : 'Complete Setup'}
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Step 1: Password setup
  return (
    <div className="min-h-screen bg-slate-900 flex items-center justify-center">
      <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
        <div className="text-center mb-6">
          <div className="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-3">
            <span className="text-xl text-white">üîê</span>
          </div>
          <h1 className="text-xl font-bold text-gray-800">Set Up Your Account</h1>
          <p className="text-xs text-gray-500 mt-1">Welcome, {userInfo?.name}!</p>
          <p className="text-xs text-blue-600 mt-1">{userInfo?.role?.toUpperCase()}</p>
          {requiresTerms && <p className="text-xs text-gray-400">Step 1 of 2 - Create Password</p>}
        </div>

        {error && (
          <div className="mb-3 p-2 bg-red-100 text-red-700 rounded text-xs text-center">
            {error}
          </div>
        )}

        {success && (
          <div className="mb-3 p-2 bg-green-100 text-green-700 rounded text-xs text-center">
            {success}
          </div>
        )}

        <form onSubmit={handlePasswordStep} className="space-y-3">
          <div>
            <label className="block text-xs font-medium text-gray-700 mb-1">Create Password</label>
            <input
              type="password"
              required
              minLength={6}
              className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="Minimum 6 characters"
            />
          </div>
          <div>
            <label className="block text-xs font-medium text-gray-700 mb-1">Confirm Password</label>
            <input
              type="password"
              required
              className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              value={confirmPassword}
              onChange={(e) => setConfirmPassword(e.target.value)}
              placeholder="Re-enter password"
            />
          </div>

          <button
            type="submit"
            disabled={loading || success}
            className="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400 text-sm font-medium"
          >
            {requiresTerms ? 'Next Step' : (loading ? 'Setting up...' : 'Set Up Account')}
          </button>
        </form>
      </div>
    </div>
  );
};

// ==================== RESET PASSWORD PAGE ====================
const ResetPasswordPage = ({ resetToken, onComplete }) => {
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  const [loading, setLoading] = useState(false);
  const [verifying, setVerifying] = useState(true);
  const [tokenValid, setTokenValid] = useState(false);

  useEffect(() => {
    const verifyToken = async () => {
      try {
        await axios.get(`${API}/admin/auth/verify-reset-token?token=${resetToken}`);
        setTokenValid(true);
      } catch (err) {
        setError(err.response?.data?.detail || 'Invalid or expired reset link');
      } finally {
        setVerifying(false);
      }
    };
    verifyToken();
  }, [resetToken]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');

    if (password !== confirmPassword) {
      setError('Passwords do not match');
      return;
    }

    if (password.length < 6) {
      setError('Password must be at least 6 characters');
      return;
    }

    setLoading(true);
    try {
      await axios.post(`${API}/admin/auth/reset-password`, {
        token: resetToken,
        new_password: password
      });
      // Clear any existing session to force fresh login with new credentials
      localStorage.removeItem('admin_key');
      localStorage.removeItem('admin_user');
      setSuccess('Password reset successfully! You can now log in.');
      setTimeout(() => onComplete(), 2000);
    } catch (err) {
      setError(err.response?.data?.detail || 'Failed to reset password');
    } finally {
      setLoading(false);
    }
  };

  if (verifying) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center">
        <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
          <p className="text-gray-600">Verifying link...</p>
        </div>
      </div>
    );
  }

  if (error && !tokenValid) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center">
        <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
          <div className="text-center mb-6">
            <div className="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center mx-auto mb-3">
              <span className="text-xl text-white">!</span>
            </div>
            <h1 className="text-xl font-bold text-gray-800">Invalid Link</h1>
          </div>
          <div className="mb-4 p-3 bg-red-100 text-red-700 rounded text-sm text-center">
            {error}
          </div>
          <button
            onClick={onComplete}
            className="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium"
          >
            Go to Login
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-900 flex items-center justify-center">
      <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
        <div className="text-center mb-6">
          <div className="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-3">
            <span className="text-xl text-white">üîë</span>
          </div>
          <h1 className="text-xl font-bold text-gray-800">Reset Password</h1>
          <p className="text-xs text-gray-500 mt-1">Create your new password</p>
        </div>

        {error && (
          <div className="mb-3 p-2 bg-red-100 text-red-700 rounded text-xs text-center">
            {error}
          </div>
        )}

        {success && (
          <div className="mb-3 p-2 bg-green-100 text-green-700 rounded text-xs text-center">
            {success}
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-3">
          <div>
            <label className="block text-xs font-medium text-gray-700 mb-1">New Password</label>
            <input
              type="password"
              required
              minLength={6}
              className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="Minimum 6 characters"
            />
          </div>
          <div>
            <label className="block text-xs font-medium text-gray-700 mb-1">Confirm Password</label>
            <input
              type="password"
              required
              className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              value={confirmPassword}
              onChange={(e) => setConfirmPassword(e.target.value)}
              placeholder="Re-enter password"
            />
          </div>

          <button
            type="submit"
            disabled={loading || success}
            className="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400 text-sm font-medium"
          >
            {loading ? 'Resetting...' : 'Reset Password'}
          </button>
        </form>
      </div>
    </div>
  );
};

// ==================== PM DASHBOARD (EXCLUSIVE FOR PROJECT MANAGERS) ====================
const PMDashboard = ({ adminKey, user, onNavigateToTranslation }) => {
  // State
  const [activeSection, setActiveSection] = useState('overview');
  const [orders, setOrders] = useState([]);
  const [translators, setTranslators] = useState([]);
  const [loading, setLoading] = useState(true);
  const [messages, setMessages] = useState([]);

  // Project files viewing state
  const [selectedProject, setSelectedProject] = useState(null);
  const [projectDocuments, setProjectDocuments] = useState([]);
  const [loadingProjectDocs, setLoadingProjectDocs] = useState(false);
  const [fileAssignments, setFileAssignments] = useState({});

  // Send Complete Project state
  const [projectTranslatorId, setProjectTranslatorId] = useState('');
  const [sendingCompleteProject, setSendingCompleteProject] = useState(false);
  const [projectTrDeadline, setProjectTrDeadline] = useState({ date: '', time: '17:00' });

  const [newMessage, setNewMessage] = useState('');
  const [selectedTranslator, setSelectedTranslator] = useState(null);
  const [reviewQueue, setReviewQueue] = useState([]);
  const [selectedReview, setSelectedReview] = useState(null);
  const [originalContents, setOriginalContents] = useState([]);  // Array for multiple documents
  const [currentDocIndex, setCurrentDocIndex] = useState(0);  // Current document index
  const [translatedContent, setTranslatedContent] = useState(null);
  const [correctionNotes, setCorrectionNotes] = useState('');
  const [sendingAction, setSendingAction] = useState(false);

  // PM Package Generation state
  const [pmTranslationFiles, setPmTranslationFiles] = useState([]);  // Images for translation
  const [pmTranslationHtml, setPmTranslationHtml] = useState('');    // HTML content for translation
  const [pmPackageGenerating, setPmPackageGenerating] = useState(false);

  // Proofreading state
  const [proofreadingResult, setProofreadingResult] = useState(null);
  const [isProofreading, setIsProofreading] = useState(false);
  const [proofreadingError, setProofreadingError] = useState('');

  // PM Approval state - PM must approve after proofreading before sending to Admin
  const [pmApprovalStatus, setPmApprovalStatus] = useState(null); // null, 'approved', 'rejected'
  const [processingStatus, setProcessingStatus] = useState('');

  // Translator Assignment Modal state (for email invites)
  const [assigningTranslatorModal, setAssigningTranslatorModal] = useState(null);
  const [assignmentDetails, setAssignmentDetails] = useState({
    translator_id: '',
    due_date: '',
    due_time: '17:00',
    project_notes: '',
    language_pair: ''
  });
  const [sendingAssignment, setSendingAssignment] = useState(false);

  // TR Deadline editing state
  const [editingTrDeadline, setEditingTrDeadline] = useState(null);
  const [tempTrDeadline, setTempTrDeadline] = useState({ date: '', time: '17:00' });
  const [savingTrDeadline, setSavingTrDeadline] = useState(false);

  // Download package state
  const [downloadingPackagePM, setDownloadingPackagePM] = useState(null); // Order ID being downloaded

  const [stats, setStats] = useState({
    totalProjects: 0,
    inProgress: 0,
    awaitingReview: 0,
    completed: 0,
    onTime: 0,
    delayed: 0
  });

  // Quote generation state
  const [quoteForm, setQuoteForm] = useState({
    clientName: '',
    clientEmail: '',
    documentType: '',
    sourceLanguage: 'Portuguese',
    targetLanguage: 'English',
    serviceType: 'standard',
    pageCount: 1,
    pricePerPage: 24.99,
    discount: 0,
    urgency: 'no',
    deliveryMethod: 'digital',
    notes: ''
  });

  const PM_DELIVERY_OPTIONS = {
    digital: { name: 'Digital (Email/Download)', price: 0 },
    usps_standard: { name: 'USPS Standard (5-7 days)', price: 5.99 },
    usps_priority: { name: 'USPS Priority (2-3 days)', price: 12.99 },
    usps_express: { name: 'USPS Express (1-2 days)', price: 29.99 },
    fedex_overnight: { name: 'FedEx Overnight', price: 39.99 }
  };
  const [quoteLanguage, setQuoteLanguage] = useState('en'); // en, pt, es
  const [showQuotePreview, setShowQuotePreview] = useState(false);
  const [sendingQuote, setSendingQuote] = useState(false);

  // Quote translations
  const quoteTranslations = {
    en: {
      title: 'TRANSLATION QUOTE',
      company: 'Legacy Translation Services',
      tagline: 'Professional Certified Translation Services',
      quoteNumber: 'Quote #',
      date: 'Date',
      validUntil: 'Valid Until',
      clientInfo: 'Client Information',
      name: 'Name',
      email: 'Email',
      serviceDetails: 'Service Details',
      documentType: 'Document Type',
      sourceLanguage: 'Source Language',
      targetLanguage: 'Target Language',
      serviceType: 'Service Type',
      certified: 'Certified Translation',
      professional: 'Professional Translation',
      urgency: 'Urgency',
      normal: 'Standard (2-3 business days)',
      priority: 'Priority (24 hours)',
      urgent: 'Urgent (12 hours)',
      pricing: 'Pricing',
      pages: 'Number of Pages',
      pricePerPage: 'Price per Page',
      subtotal: 'Subtotal',
      urgencyFee: 'Urgency Fee',
      discount: 'Discount',
      total: 'TOTAL',
      notes: 'Notes',
      terms: 'Terms & Conditions',
      termsText: 'This quote is valid for 30 days. Payment is due upon completion. Certified translations include notarization.',
      thankYou: 'Thank you for choosing Legacy Translation Services!',
      contact: 'Contact us',
      phone: 'Phone',
      website: 'Website'
    },
    pt: {
      title: 'OR√áAMENTO DE TRADU√á√ÉO',
      company: 'Legacy Translation Services',
      tagline: 'Servi√ßos Profissionais de Tradu√ß√£o Juramentada',
      quoteNumber: 'Or√ßamento #',
      date: 'Data',
      validUntil: 'Golido At√©',
      clientInfo: 'Informa√ß√µes do Cliente',
      name: 'Nome',
      email: 'E-mail',
      serviceDetails: 'Detalhes do Servi√ßo',
      documentType: 'Tipo de Documento',
      sourceLanguage: 'Idioma de Origem',
      targetLanguage: 'Idioma de Destino',
      serviceType: 'Tipo de Servi√ßo',
      certified: 'Tradu√ß√£o Juramentada',
      professional: 'Tradu√ß√£o Profissional',
      urgency: 'Urg√™ncia',
      normal: 'Normal (2-3 dias √∫teis)',
      priority: 'Priorit√°rio (24 horas)',
      urgent: 'Urgente (12 horas)',
      pricing: 'Amountes',
      pages: 'N√∫mero de P√°ginas',
      pricePerPage: 'Pre√ßo por P√°gina',
      subtotal: 'Subtotal',
      urgencyFee: 'Urgency Fee',
      discount: 'Desconto',
      total: 'TOTAL',
      notes: 'Observa√ß√µes',
      terms: 'Termos e Condi√ß√µes',
      termsText: 'Este or√ßamento √© v√°lido por 30 dias. O pagamento √© devido ap√≥s a conclus√£o. Tradu√ß√µes juramentadas incluem reconhecimento de firma.',
      thankYou: 'Obrigado por escolher a Legacy Translation Services!',
      contact: 'Entre em contato',
      phone: 'Telefone',
      website: 'Website'
    },
    es: {
      title: 'COTIZACI√ìN DE TRADUCCI√ìN',
      company: 'Legacy Translation Services',
      tagline: 'Servicios Profesionales de Traducci√≥n Certificada',
      quoteNumber: 'Cotizaci√≥n #',
      date: 'Fecha',
      validUntil: 'Golido Hasta',
      clientInfo: 'Informaci√≥n del Cliente',
      name: 'Nombre',
      email: 'Correo Electr√≥nico',
      serviceDetails: 'Detalles del Servicio',
      documentType: 'Tipo de Documento',
      sourceLanguage: 'Idioma de Origen',
      targetLanguage: 'Idioma de Destino',
      serviceType: 'Tipo de Servicio',
      certified: 'Traducci√≥n Certificada',
      professional: 'Traducci√≥n Profesional',
      urgency: 'Urgencia',
      normal: 'Est√°ndar (2-3 d√≠as h√°biles)',
      priority: 'Prioritario (24 horas)',
      urgent: 'Urgente (12 horas)',
      pricing: 'Precios',
      pages: 'N√∫mero de P√°ginas',
      pricePerPage: 'Precio por P√°gina',
      subtotal: 'Subtotal',
      urgencyFee: 'Tarifa de Urgencia',
      discount: 'Descuento',
      total: 'TOTAL',
      notes: 'Notas',
      terms: 'T√©rminos y Condiciones',
      termsText: 'Esta cotizaci√≥n es v√°lida por 30 d√≠as. El pago se realiza al finalizar. Las traducciones certificadas incluyen notarizaci√≥n.',
      thankYou: '¬°Gracias por elegir Legacy Translation Services!',
      contact: 'Cont√°ctenos',
      phone: 'Tel√©fono',
      website: 'Sitio Web'
    }
  };

  // Calculate quote totals
  const calculateQuote = () => {
    const basePrice = quoteForm.pageCount * quoteForm.pricePerPage;
    let urgencyFee = 0;
    if (quoteForm.urgency === 'priority') urgencyFee = basePrice * 0.25;
    if (quoteForm.urgency === 'urgent') urgencyFee = basePrice * 1.0;
    const deliveryFee = PM_DELIVERY_OPTIONS[quoteForm.deliveryMethod]?.price || 0;
    const discountAmount = (basePrice + urgencyFee) * (quoteForm.discount / 100);
    const total = basePrice + urgencyFee + deliveryFee - discountAmount;
    return { basePrice, urgencyFee, deliveryFee, discountAmount, total };
  };

  // Send quote via email
  const sendQuoteEmail = async () => {
    if (!quoteForm.clientEmail) {
      showToast('Please enter the client email.');
      return;
    }
    setSendingQuote(true);
    try {
      const t = quoteTranslations[quoteLanguage];
      const prices = calculateQuote();
      const quoteNumber = `LT-${Date.now().toString().slice(-6)}`;

      await axios.post(`${API}/admin/send-quote-email?admin_key=${adminKey}`, {
        to_email: quoteForm.clientEmail,
        client_name: quoteForm.clientName,
        quote_number: quoteNumber,
        language: quoteLanguage,
        quote_data: {
          ...quoteForm,
          ...prices,
          quoteNumber,
          date: new Date().toLocaleDateString('en-US', { timeZone: 'America/New_York' }),
          validUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString('en-US', { timeZone: 'America/New_York' })
        }
      });

      showToast(`‚úÖ Or√ßamento sent successfully to ${quoteForm.clientEmail}!`);
      setShowQuotePreview(false);
    } catch (err) {
      console.error('Failed to send quote:', err);
      showToast('‚ùå Error sending quote. Please try again.');
    } finally {
      setSendingQuote(false);
    }
  };

  // Fetch data on mount
  useEffect(() => {
    fetchDashboardData();
  }, []);

  const fetchDashboardData = async () => {
    setLoading(true);
    try {
      // Fetch orders assigned to this PM using the proper endpoint that filters by role
      const ordersRes = await axios.get(`${API}/admin/orders/my-projects?admin_key=${adminKey}&token=${user?.token}`);
      const myOrders = ordersRes.data.orders || [];
      setOrders(myOrders);

      // Fetch translators
      const usersRes = await axios.get(`${API}/admin/users?admin_key=${adminKey}&token=`);
      const allUsers = usersRes.data || [];
      const translatorsList = allUsers.filter(u => u.role === 'translator');
      setTranslators(translatorsList);

      // Build review queue - orders with translation_status 'review' or 'pending_pm_review'
      const reviewOrders = myOrders.filter(o =>
        ['review', 'pending_pm_review'].includes(o.translation_status)
      );
      setReviewQueue(reviewOrders);

      // Calculate stats
      const now = new Date();
      let onTime = 0;
      let delayed = 0;
      myOrders.forEach(o => {
        if (o.deadline) {
          const deadline = new Date(o.deadline);
          if (deadline >= now || o.translation_status === 'delivered') {
            onTime++;
          } else {
            delayed++;
          }
        }
      });

      setStats({
        totalProjects: myOrders.length,
        inProgress: myOrders.filter(o => o.translation_status === 'in_translation').length,
        awaitingReview: reviewOrders.length,
        completed: myOrders.filter(o => ['ready', 'delivered'].includes(o.translation_status)).length,
        onTime,
        delayed
      });

      // Load messages from localStorage (simulated)
      const savedMessages = localStorage.getItem(`pm_messages_${user?.id}`);
      if (savedMessages) setMessages(JSON.parse(savedMessages));

    } catch (err) {
      console.error('Failed to fetch dashboard data:', err);
    } finally {
      setLoading(false);
    }
  };

  // Send message to translator
  const sendMessage = () => {
    if (!newMessage.trim() || !selectedTranslator) return;

    const msg = {
      id: Date.now(),
      from: user?.name,
      to: selectedTranslator.name,
      toId: selectedTranslator.id,
      content: newMessage,
      timestamp: new Date().toISOString(),
      read: false
    };

    const updatedMessages = [...messages, msg];
    setMessages(updatedMessages);
    localStorage.setItem(`pm_messages_${user?.id}`, JSON.stringify(updatedMessages));
    setNewMessage('');
  };

  // Download complete translation package (PDF/Print) for PM Dashboard
  const downloadOrderPackagePM = async (order) => {
    setDownloadingPackagePM(order.id);
    try {
      // Fetch complete order data with translation
      const orderResponse = await axios.get(`${API}/admin/orders/${order.id}?admin_key=${adminKey}`);
      const orderData = orderResponse.data.order || orderResponse.data;

      // Check for any form of completed translation
      const hasTranslation = orderData.translation_html ||
                            orderData.translation_ready ||
                            orderData.translated_file ||
                            orderData.translated_gridfs_id ||
                            orderData.translated_filename ||
                            orderData.has_translated_documents;

      if (!hasTranslation) {
        showToast('This order does not have a completed translation yet.');
        setDownloadingPackagePM(null);
        return;
      }

      // Fetch order documents for originals
      let originalDocuments = [];
      try {
        const docsResponse = await axios.get(`${API}/admin/order-documents?order_id=${order.id}&admin_key=${adminKey}`);
        const docs = docsResponse.data.documents || docsResponse.data || [];

        // Load original documents (not translations)
        for (const doc of docs.filter(d => d.document_type !== 'translation')) {
          try {
            const docData = await axios.get(`${API}/admin/order-documents/${doc.id}/download?admin_key=${adminKey}`);
            if (docData.data.file_data) {
              originalDocuments.push({
                filename: doc.filename,
                data: docData.data.file_data,
                type: docData.data.content_type || 'image/png'
              });
            }
          } catch (docErr) {
            console.warn('Failed to load document:', doc.id);
          }
        }
      } catch (docsErr) {
        console.warn('Failed to fetch documents:', docsErr);
      }

      // Build package HTML
      const translatorName = orderData.translation_translator_name || orderData.assigned_translator_name || orderData.assigned_translator || 'Beatriz Paiva';
      const documentType = DOCUMENT_TYPES.find(d => d.value === orderData.document_type)?.label || orderData.document_type || 'Document';
      const sourceLanguage = orderData.translate_from || orderData.source_language || 'Portuguese';
      const targetLanguage = orderData.translate_to || orderData.target_language || 'English';
      const translationDateStr = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

      // Letterhead HTML
      const letterheadHTML = `
        <div class="header">
          <div class="logo-left">
            <div class="logo-placeholder"><span style="text-align:center;">LEGACY<br/>TRANSLATIONS</span></div>
          </div>
          <div class="header-center">
            <div class="company-name">Legacy Translations</div>
            <div class="company-address">
              867 Boylston Street ¬∑ 5th Floor ¬∑ #2073 ¬∑ Boston, MA ¬∑ 02116<br>
              (857) 316-7770 ¬∑ contact@legacytranslations.com
            </div>
          </div>
          <div class="logo-right">
            <div class="logo-placeholder-right"><span>ata<br/>Member #275993</span></div>
          </div>
        </div>
        <div class="header-line"></div>`;

      // Cover Letter
      const coverLetterHTML = `
      <div class="cover-page">
        ${letterheadHTML}
        ${orderData.order_number ? `<div class="order-number">Order # <strong>${orderData.order_number}</strong></div>` : ''}
        <h1 class="main-title">Certification of Translation Accuracy</h1>
        <div class="subtitle">
          Translation of a <strong>${documentType}</strong> from <strong>${sourceLanguage}</strong> to<br>
          <strong>${targetLanguage}</strong>
        </div>
        <p class="body-text">I, the undersigned, hereby certify that the attached document is, to the best of my knowledge and belief, a true and accurate translation of the original document from ${sourceLanguage} to ${targetLanguage}.</p>
        <p class="body-text">I am competent to translate from ${sourceLanguage} to ${targetLanguage}, and this translation is complete and accurate.</p>
        <p class="body-text">This certification is valid for official use, including immigration, legal, and academic purposes.</p>
        <div class="footer-section">
          <div class="signature-block">
            <div style="font-family: 'Times New Roman', serif; font-size: 18px; font-style: italic; color: #1a365d; margin-bottom: 2px;">${translatorName}</div>
            <div class="signature-name">Authorized Representative</div>
            <div class="signature-title">Legacy Translations Inc.</div>
            <div class="signature-date">Dated: ${translationDateStr}</div>
          </div>
          <div class="stamp-container">
            <div class="stamp">
              <div class="stamp-text-top">CERTIFIED TRANSLATOR</div>
              <div class="stamp-center">
                <div class="stamp-company">LEGACY TRANSLATIONS</div>
                <div class="stamp-ata">ATA # 275993</div>
              </div>
            </div>
          </div>
        </div>
      </div>`;

      // Translation pages HTML
      let translationPagesHTML = '';
      if (orderData.translation_html) {
        translationPagesHTML = `
        <div class="translation-text-page">
          <div class="running-header">${letterheadHTML}</div>
          <div class="running-header-spacer"></div>
          <div class="translation-content translation-text">${orderData.translation_html}</div>
        </div>`;
      }

      // Original documents pages
      const originalPagesHTML = originalDocuments.length > 0 ? originalDocuments.map((file, idx) => `
      <div class="original-documents-page">
        ${letterheadHTML}
        ${idx === 0 ? '<div class="page-title">Original Document</div>' : ''}
        <div class="original-image-container">
          <img src="data:${file.type};base64,${file.data}" alt="Original page ${idx + 1}" class="original-image" />
        </div>
      </div>`).join('') : '';

      // Complete HTML document
      const fullHTML = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Certified Translation - ${orderData.order_number || 'Document'}</title>
  <style>
    @page { size: Letter; margin: 0.5in 0.6in 0.6in 0.6in; }
    @page cover { size: Letter; margin: 0.75in; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Times New Roman', Georgia, serif; font-size: 13px; line-height: 1.5; color: #333; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; }
    .header-line { height: 3px; background: linear-gradient(to right, #3B82F6, #60A5FA); margin-bottom: 12px; }
    .logo-left { width: 130px; height: 55px; display: flex; align-items: center; }
    .logo-placeholder { width: 130px; height: 55px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #999; background: #fafafa; }
    .header-center { text-align: center; flex: 1; padding: 0 15px; }
    .company-name { font-size: 15px; font-weight: bold; color: #2563eb; margin-bottom: 2px; }
    .company-address { font-size: 9px; line-height: 1.3; color: #333; }
    .logo-right { width: 85px; height: 55px; display: flex; align-items: center; justify-content: flex-end; }
    .logo-placeholder-right { width: 85px; height: 55px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; font-size: 9px; color: #1a365d; background: #fafafa; text-align: center; font-style: italic; }
    .order-number { text-align: right; margin-bottom: 20px; font-size: 12px; margin-top: 5px; }
    .main-title { text-align: center; font-size: 26px; font-weight: normal; margin-bottom: 20px; color: #1a365d; line-height: 1.2; }
    .subtitle { text-align: center; font-size: 13px; margin-bottom: 25px; line-height: 1.5; }
    .body-text { text-align: justify; margin-bottom: 14px; line-height: 1.6; font-size: 12px; }
    .footer-section { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; padding-top: 20px; }
    .signature-block { line-height: 1.3; }
    .signature-name { font-weight: bold; font-size: 13px; }
    .signature-title { font-weight: bold; font-size: 12px; }
    .signature-date { font-size: 12px; }
    .stamp-container { width: 130px; height: 130px; }
    .stamp { width: 130px; height: 130px; border: 3px solid #2563eb; border-radius: 50%; position: relative; display: flex; align-items: center; justify-content: center; background: white; }
    .stamp::before { content: ''; position: absolute; top: 7px; left: 7px; right: 7px; bottom: 7px; border: 1px solid #2563eb; border-radius: 50%; }
    .stamp-text-top { position: absolute; top: 14px; left: 50%; transform: translateX(-50%); font-size: 8px; font-weight: bold; color: #2563eb; letter-spacing: 1.5px; }
    .stamp-center { text-align: center; padding: 0 12px; }
    .stamp-company { font-size: 10px; font-weight: bold; color: #2563eb; margin-bottom: 2px; }
    .stamp-ata { font-size: 8px; color: #2563eb; }
    .cover-page { page: cover; page-break-after: always; min-height: 100%; display: flex; flex-direction: column; }
    .translation-text-page { page-break-before: always; }
    .translation-content.translation-text { text-align: left; font-family: 'Times New Roman', Georgia, serif; font-size: 11pt; line-height: 1.5; color: #333; }
    .translation-content.translation-text p { margin-bottom: 10px; text-align: justify; }
    .translation-content.translation-text table { width: 100%; border-collapse: collapse; margin: 10px 0; }
    .translation-content.translation-text td, .translation-content.translation-text th { border: 1px solid #333; padding: 6px; font-size: 10pt; }
    .page-title { font-size: 13px; font-weight: bold; text-align: center; margin: 10px 0 8px 0; color: #1a365d; text-transform: uppercase; letter-spacing: 2px; }
    .original-documents-page { page-break-after: always; page-break-inside: avoid; padding-top: 15px; }
    .original-documents-page:last-of-type { page-break-after: auto; }
    .original-image-container { text-align: center; margin-bottom: 5px; }
    .original-image { max-width: 100%; max-height: 630px; border: 1px solid #ddd; object-fit: contain; display: block; margin: 0 auto; }
    @media print {
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .running-header { position: fixed; top: 0; left: 0; right: 0; background: white; padding: 20px 50px 10px; }
      .running-header-spacer { height: 100px; }
    }
  </style>
</head>
<body>
  ${coverLetterHTML}
  ${translationPagesHTML}
  ${originalPagesHTML}
</body>
</html>`;

      // Generate PDF with hash tracking
      const filename = `${orderData.order_number || 'Order'}_Certified_Translation.pdf`;

      try {
        const { blob: pdfBlob, hash: pdfHash } = await generatePdfWithHash(fullHTML, filename, {
          margin: [5, 5, 5, 5],
          image: { type: 'jpeg', quality: 0.95 },
          html2canvas: { scale: 2, useCORS: true, allowTaint: true },
          jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' }
        });

        // Download the PDF
        const downloadUrl = URL.createObjectURL(pdfBlob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(downloadUrl);
      } catch (pdfErr) {
        console.error('PDF generation failed, falling back to print:', pdfErr);
        // Fallback to print window if PDF generation fails
        const printWindow = window.open('', '_blank');
        if (printWindow) {
          printWindow.document.write(fullHTML);
          printWindow.document.close();
          printWindow.focus();
          setTimeout(() => { printWindow.print(); }, 500);
        } else {
          showToast('Please allow popups to download the translation package.');
        }
      }
    } catch (err) {
      console.error('Failed to download package:', err);
      showToast('Error generating translation package: ' + (err.message || 'Unknown error'));
    } finally {
      setDownloadingPackagePM(null);
    }
  };

  // View project files and assign translators
  const viewProjectFiles = async (order) => {
    setSelectedProject(order);
    setLoadingProjectDocs(true);
    setProjectDocuments([]);
    // Pre-populate TR deadline if already set on the order
    if (order.translator_deadline) {
      const trDate = order.translator_deadline.split('T')[0];
      const trTime = order.translator_deadline.split('T')[1]?.substring(0, 5) || '17:00';
      setProjectTrDeadline({ date: trDate, time: trTime });
    } else {
      setProjectTrDeadline({ date: '', time: '17:00' });
    }
    try {
      const response = await axios.get(`${API}/admin/orders/${order.id}/documents?admin_key=${adminKey}`);
      setProjectDocuments(response.data.documents || []);
    } catch (err) {
      console.error('Failed to fetch project documents:', err);
    } finally {
      setLoadingProjectDocs(false);
    }
  };

  // Assign translator to specific document
  const assignTranslatorToFile = async (docId, translatorId, translatorName) => {
    try {
      setFileAssignments(prev => ({
        ...prev,
        [docId]: { id: translatorId, name: translatorName }
      }));

      await axios.patch(`${API}/admin/order-documents/${docId}?admin_key=${adminKey}`, {
        assigned_translator_id: translatorId,
        assigned_translator_name: translatorName
      });
    } catch (err) {
      console.error('Failed to assign translator:', err);
      setFileAssignments(prev => {
        const newState = { ...prev };
        delete newState[docId];
        return newState;
      });
    }
  };

  // Send email invite for file-level translator assignment
  const [sendingFileInvite, setSendingFileInvite] = useState({});
  const sendFileTranslatorInvite = async (doc, translatorId, translatorName) => {
    if (!translatorId) {
      showToast('Please select a translator first');
      return;
    }

    // Find translator - compare as strings to handle type mismatch
    const translator = translators.find(t => String(t.id) === String(translatorId));

    if (!translator) {
      console.error('Translator not found for file invite:', { translatorId, translators });
      showToast('Error: Translator not found. Please try selecting again.');
      return;
    }

    if (!translator.email) {
      showToast('Error: Selected translator has no email address configured.');
      return;
    }

    setSendingFileInvite(prev => ({ ...prev, [doc.id]: true }));
    try {
      // Send email invite via the file assignment endpoint
      await axios.post(`${API}/admin/send-file-assignment-email?admin_key=${adminKey}`, {
        document_id: doc.id,
        document_name: doc.filename,
        translator_id: translator.id,
        translator_name: translator.name,
        translator_email: translator.email,
        order_id: selectedProject?.id,
        order_number: selectedProject?.order_number,
        language_pair: `${selectedProject?.translate_from} ‚Üí ${selectedProject?.translate_to}`,
        pm_name: user?.name || 'PM'
      });

      showToast(`üìß Email invitation sent to ${translator.name}!`);
    } catch (err) {
      console.error('Failed to send invite:', err);
      const errorMsg = err.response?.data?.detail || err.message || 'Unknown error';
      showToast(`Error sending email invitation: ${errorMsg}`);
    } finally {
      setSendingFileInvite(prev => ({ ...prev, [doc.id]: false }));
    }
  };

  // Send complete project to translator (all files at once)
  const sendCompleteProject = async () => {
    if (!projectTranslatorId) {
      showToast('Please select a translator first');
      return;
    }

    if (projectDocuments.length === 0) {
      showToast('No files in this project');
      return;
    }

    // Find translator - compare as strings to handle type mismatch
    const translator = translators.find(t => String(t.id) === String(projectTranslatorId));

    if (!translator) {
      console.error('Translator not found:', { projectTranslatorId, translators });
      showToast('Error: Translator not found. Please try selecting again.');
      return;
    }

    if (!translator.email) {
      showToast('Error: Selected translator has no email address configured.');
      return;
    }

    setSendingCompleteProject(true);
    try {
      const fileList = projectDocuments.map(d => d.filename).join(', ');

      // Build the translator deadline if provided
      const newTrDeadline = projectTrDeadline.date
        ? `${projectTrDeadline.date}T${projectTrDeadline.time || '17:00'}:00`
        : null;

      // 1. Update all documents with the same translator
      for (const doc of projectDocuments) {
        await axios.patch(`${API}/admin/order-documents/${doc.id}?admin_key=${adminKey}`, {
          assigned_translator_id: translator.id,
          assigned_translator_name: translator.name
        });
      }

      // 2. Update the order with the translator assignment and TR deadline (if set)
      // skip_email: true to avoid duplicate email (we send via dedicated endpoint below)
      const orderUpdate = {
        assigned_translator_id: translator.id,
        assigned_translator: translator.name,
        skip_email: true
      };
      if (newTrDeadline) {
        orderUpdate.translator_deadline = newTrDeadline;
      }
      await axios.put(`${API}/admin/orders/${selectedProject.id}?admin_key=${adminKey}`, orderUpdate);

      // Update local state for orders (if TR deadline was set)
      if (newTrDeadline) {
        setOrders(prev => prev.map(o =>
          o.id === selectedProject.id ? { ...o, translator_deadline: newTrDeadline } : o
        ));
      }

      // 3. Send single email with all files
      // Use the new TR deadline if set, otherwise fall back to existing deadline
      const deadlineForEmail = newTrDeadline || selectedProject?.translator_deadline || selectedProject?.deadline;

      await axios.post(`${API}/admin/send-project-assignment-email?admin_key=${adminKey}`, {
        translator_id: translator.id,
        translator_name: translator.name,
        translator_email: translator.email,
        order_id: selectedProject?.id,
        order_number: selectedProject?.order_number,
        language_pair: `${selectedProject?.translate_from} ‚Üí ${selectedProject?.translate_to}`,
        documents: projectDocuments.map(d => ({
          id: d.id,
          filename: d.filename,
          content_type: d.content_type
        })),
        total_files: projectDocuments.length,
        pm_name: user?.name || 'PM',
        deadline: deadlineForEmail
      });

      // Update local state
      setFileAssignments(prev => {
        const newState = { ...prev };
        projectDocuments.forEach(doc => {
          newState[doc.id] = { id: translator.id, name: translator.name };
        });
        return newState;
      });

      showToast(`Project invitation sent to ${translator.name}!\n\n${projectDocuments.length} file(s) assigned:\n${fileList}`);
      setProjectTranslatorId('');
      setProjectTrDeadline({ date: '', time: '17:00' });
    } catch (err) {
      console.error('Failed to send complete project:', err);
      const errorMsg = err.response?.data?.detail || err.message || 'Unknown error';
      showToast(`Error sending project invitation: ${errorMsg}`);
    } finally {
      setSendingCompleteProject(false);
    }
  };

  // Open translator assignment modal (for email invites)
  const openAssignTranslatorModal = (order) => {
    setAssigningTranslatorModal(order);
    setAssignmentDetails({
      translator_id: '',
      due_date: order.deadline ? order.deadline.split('T')[0] : '',
      due_time: '17:00',
      project_notes: order.internal_notes || '',
      language_pair: `${order.translate_from} ‚Üí ${order.translate_to}`
    });
  };

  // Send translator assignment with email invitation
  const sendTranslatorAssignment = async () => {
    if (!assignmentDetails.translator_id) {
      showToast('Please select a translator');
      return;
    }
    setSendingAssignment(true);
    try {
      const selectedTranslator = translators.find(t => t.id === assignmentDetails.translator_id);

      let translatorDeadline = null;
      if (assignmentDetails.due_date) {
        translatorDeadline = `${assignmentDetails.due_date}T${assignmentDetails.due_time}:00`;
      }

      // Update order with translator assignment (triggers email in backend)
      await axios.put(`${API}/admin/orders/${assigningTranslatorModal.id}?admin_key=${adminKey}`, {
        assigned_translator_id: assignmentDetails.translator_id,
        assigned_translator: selectedTranslator?.name,
        translator_deadline: translatorDeadline,
        internal_notes: assignmentDetails.project_notes
      });

      showToast(`üìß Email invitation sent to ${selectedTranslator?.name || 'translator'}! They will receive an email to accept or decline the project.`);
      setAssigningTranslatorModal(null);
      fetchDashboardData();
    } catch (err) {
      console.error('Failed to send translator assignment:', err);
      showToast('Error sending assignment. Please try again.');
    } finally {
      setSendingAssignment(false);
    }
  };

  // Handle PM original document upload (with PDF to image conversion)
  const handlePmOriginalUpload = async (event) => {
    const selectedFiles = Array.from(event.target.files);
    if (selectedFiles.length === 0) return;

    setProcessingStatus('Processing uploaded documents...');
    const allDocs = [];

    for (const file of selectedFiles) {
      const fileName = file.name.toLowerCase();

      // PDF - store directly
      if (fileName.endsWith('.pdf')) {
        setProcessingStatus(`Loading PDF: ${file.name}`);
        const reader = new FileReader();
        const result = await new Promise((resolve, reject) => {
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        allDocs.push({
          filename: file.name,
          data: result,
          contentType: 'application/pdf'
        });
      }
      // Image - read directly
      else if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        const result = await new Promise((resolve, reject) => {
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        allDocs.push({
          filename: file.name,
          data: result,
          contentType: file.type
        });
      }
    }

    if (allDocs.length > 0) {
      // Replace all original contents with newly uploaded documents
      setOriginalContents(allDocs);
      setCurrentDocIndex(0);
      setProcessingStatus('');
      showToast(`‚úÖ ${allDocs.length} document(s) uploaded successfully!`);
    } else {
      setProcessingStatus('');
    }

    // Reset file input
    event.target.value = '';
  };

  // Handle PM translation upload (with PDF to image conversion and HTML/Word support)
  const handlePmTranslationUpload = async (event) => {
    const selectedFiles = Array.from(event.target.files);
    if (selectedFiles.length === 0) return;

    setProcessingStatus('Processing translation files...');
    const allImages = [];
    let htmlContent = '';

    for (const file of selectedFiles) {
      const fileName = file.name.toLowerCase();

      // PDF - store directly
      if (fileName.endsWith('.pdf')) {
        setProcessingStatus(`Loading PDF: ${file.name}`);
        const reader = new FileReader();
        const result = await new Promise((resolve, reject) => {
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        const base64 = result.split(',')[1] || result;
        allImages.push({
          filename: file.name,
          data: base64,
          type: 'application/pdf'
        });
      }
      // HTML file
      else if (fileName.endsWith('.html') || fileName.endsWith('.htm')) {
        const reader = new FileReader();
        const content = await new Promise((resolve, reject) => {
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsText(file);
        });
        htmlContent = content;
      }
      // Word document
      else if (fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
        try {
          setProcessingStatus(`Converting Word document: ${file.name}`);
          const arrayBuffer = await file.arrayBuffer();
          const result = await mammoth.convertToHtml({ arrayBuffer });
          htmlContent = result.value;
        } catch (err) {
          console.error('Word conversion error:', err);
          showToast(`Error converting Word document: ${file.name}`);
        }
      }
      // Plain text
      else if (fileName.endsWith('.txt')) {
        const reader = new FileReader();
        const content = await new Promise((resolve, reject) => {
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsText(file);
        });
        htmlContent = `<pre style="white-space: pre-wrap; font-family: 'Times New Roman', serif;">${content}</pre>`;
      }
      // Image files
      else if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        const result = await new Promise((resolve, reject) => {
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        const base64 = result.split(',')[1];
        allImages.push({
          filename: file.name,
          data: base64,
          type: file.type
        });
      }
    }

    setPmTranslationFiles(allImages);
    setPmTranslationHtml(htmlContent);

    // Also populate translationResults for the REVIEW editor
    const newResults = [];
    if (htmlContent) {
      newResults.push({
        translatedText: htmlContent,
        originalText: '',
        filename: 'uploaded_translation'
      });
    }
    if (allImages.length > 0) {
      allImages.forEach((img, idx) => {
        const imgHtml = `<div style="text-align:center;"><img src="data:${img.type || 'image/png'};base64,${img.data}" style="max-width:100%; height:auto;" alt="Translation page ${idx + 1}" /></div>`;
        newResults.push({
          translatedText: imgHtml,
          originalText: '',
          filename: img.filename || `page_${idx + 1}`
        });
      });
    }
    if (newResults.length > 0) {
      setTranslationResults(newResults);
    }

    // Also populate Quick Package variables for DELIVER tab
    setQuickTranslationFiles(allImages);
    if (htmlContent) {
      setQuickTranslationHtml(htmlContent);
      setQuickTranslationType('html');
    } else if (allImages.length > 0) {
      setQuickTranslationType('images');
    }

    setProcessingStatus('‚úÖ Translation uploaded successfully!');
    setTimeout(() => setProcessingStatus(''), 3000);

    event.target.value = '';
  };

  // Generate PM Package (same format as Quick Package)
  const handlePmPackageDownload = async () => {
    // Check for any translation source: pmTranslationFiles, pmTranslationHtml, translatedContent, or translationResults
    const hasTranslation = pmTranslationFiles.length > 0 || pmTranslationHtml || translatedContent || translationResults.length > 0;
    // Check for any original source: originalContents or originalImages
    const hasOriginal = originalContents.length > 0 || originalImages.length > 0;

    if (!hasTranslation) {
      showToast('Please upload or create a translation first');
      return;
    }

    setPmPackageGenerating(true);
    setProcessingStatus('Generating package...');

    await new Promise(resolve => setTimeout(resolve, 100));

    const order = selectedReview;
    const pageSizeCSS = pageFormat === 'a4' ? 'A4' : 'Letter';
    const certTitle = translationType === 'sworn' ? 'Sworn Translation Certificate' : 'Certification of Translation Accuracy';

    // Cover Letter HTML (same as Quick Package)
    const coverLetterHTML = `
    <!-- COVER LETTER PAGE -->
    <div class="cover-page">
        <div class="header">
            <div class="logo-left">
                ${logoLeft
                  ? `<img src="${logoLeft}" alt="Logo" style="max-width: 120px; max-height: 50px; object-fit: contain;" />`
                  : `<div class="logo-placeholder"><span style="text-align:center;">LEGACY<br/>TRANSLATIONS</span></div>`}
            </div>
            <div class="header-center">
                <div class="company-name">Legacy Translations</div>
                <div class="company-address">
                    867 Boylston Street ¬∑ 5th Floor ¬∑ #2073 ¬∑ Boston, MA ¬∑ 02116<br>
                    (857) 316-7770 ¬∑ contact@legacytranslations.com
                </div>
            </div>
            <div class="logo-right">
                ${logoRight
                  ? `<img src="${logoRight}" alt="ATA Logo" style="max-width: 80px; max-height: 50px; object-fit: contain;" />`
                  : `<div class="logo-placeholder-right"><span>ata<br/>Member #275993</span></div>`}
            </div>
        </div>
        <div class="header-line"></div>

        ${(() => {
          const displayOrderNumber = order?.order_number || orderNumber;
          return displayOrderNumber && !displayOrderNumber.toLowerCase().includes('order0') && displayOrderNumber !== 'P0000'
            ? `<div class="order-number">Order # <strong>${displayOrderNumber}</strong></div>`
            : '';
        })()}
        <h1 class="main-title">${certTitle}</h1>
        <div class="subtitle">
            Translation of a <strong>${order?.document_type || documentType || 'Document'}</strong> from <strong>${order?.source_language || sourceLanguage || 'Portuguese'}</strong> to<br>
            <strong>${order?.target_language || targetLanguage || 'English'}</strong>
        </div>

        ${(() => {
          let templateParagraphs;
          if (selectedCertificateTemplate.startsWith('custom-')) {
            const customTemplate = customCertificateTemplates.find(t => `custom-${t.id}` === selectedCertificateTemplate);
            templateParagraphs = customTemplate?.bodyParagraphs || CERTIFICATE_TEMPLATES['default'].bodyParagraphs;
          } else {
            templateParagraphs = CERTIFICATE_TEMPLATES[selectedCertificateTemplate]?.bodyParagraphs || CERTIFICATE_TEMPLATES['default'].bodyParagraphs;
          }
          return templateParagraphs.map(tograph => {
            const processedParagraph = tograph
              .replace(/\{\{sourceLanguage\}\}/g, order?.source_language || sourceLanguage || 'Portuguese')
              .replace(/\{\{targetLanguage\}\}/g, order?.target_language || targetLanguage || 'English');
            return `<p class="body-text">${processedParagraph}</p>`;
          }).join('\n        ');
        })()}

        <div class="footer-section">
            <div class="signature-block">
                ${signatureImage
                  ? `<img src="${signatureImage}" alt="Signature" style="max-height: 45px; max-width: 210px; object-fit: contain; margin-bottom: 2px;" />`
                  : `<div style="font-family: 'Rage Italic', cursive; font-size: 20px; color: #1a365d; margin-bottom: 2px;">Beatriz Paiva</div>`}
                <div class="signature-name">Authorized Representative</div>
                <div class="signature-title">Legacy Translations Inc.</div>
                <div class="signature-date">Dated: ${translationDate}</div>
            </div>
            <div class="stamp-container">
                ${logoStamp
                  ? `<img src="${logoStamp}" alt="Stamp" style="width: 140px; height: 140px; object-fit: contain;" />`
                  : `<div class="stamp">
                    <div class="stamp-text-top">CERTIFIED TRANSLATOR</div>
                    <div class="stamp-center">
                        <div class="stamp-company">LEGACY TRANSLATIONS</div>
                        <div class="stamp-ata">ATA # 275993</div>
                    </div>
                </div>`}
            </div>
        </div>
    </div>`;

    // Letterhead for all pages
    const letterheadHTML = `
        <div class="header">
            <div class="logo-left">
                ${logoLeft
                  ? `<img src="${logoLeft}" alt="Logo" style="max-width: 120px; max-height: 50px; object-fit: contain;" />`
                  : `<div class="logo-placeholder"><span style="text-align:center;">LEGACY<br/>TRANSLATIONS</span></div>`}
            </div>
            <div class="header-center">
                <div class="company-name">Legacy Translations</div>
                <div class="company-address">
                    867 Boylston Street ¬∑ 5th Floor ¬∑ #2073 ¬∑ Boston, MA ¬∑ 02116<br>
                    (857) 316-7770 ¬∑ contact@legacytranslations.com
                </div>
            </div>
            <div class="logo-right">
                ${logoRight
                  ? `<img src="${logoRight}" alt="ATA Logo" style="max-width: 80px; max-height: 50px; object-fit: contain;" />`
                  : `<div class="logo-placeholder-right"><span>ata<br/>Member #275993</span></div>`}
            </div>
        </div>
        <div class="header-line"></div>`;

    // Translation pages - use pmTranslationHtml, pmTranslationFiles, or translationResults
    let translationPagesHTML = '';

    // Priority 1: PM uploaded HTML content
    if (pmTranslationHtml) {
      translationPagesHTML = `
    <div class="translation-text-page">
        ${includeLetterhead ? `
        <div class="running-header">
            ${letterheadHTML}
        </div>
        <div class="running-header-spacer"></div>
        ` : ''}
        <div class="translation-content translation-text">
            ${pmTranslationHtml}
        </div>
    </div>`;
    }
    // Priority 2: translatedContent from PM Dashboard (loaded from dattabse)
    else if (translatedContent && pmTranslationFiles.length === 0) {
      const translationHTML = translatedContent.html || translatedContent.data || '';
      translationPagesHTML = `
    <div class="translation-text-page">
        ${includeLetterhead ? `
        <div class="running-header">
            ${letterheadHTML}
        </div>
        <div class="running-header-spacer"></div>
        ` : ''}
        <div class="translation-content translation-text">
            ${translationHTML}
        </div>
    </div>`;
    }
    // Priority 3: translationResults from Translation Workspace
    else if (translationResults.length > 0 && pmTranslationFiles.length === 0) {
      const translationHTML = translationResults.map(r => r.translatedText).join('\n\n');
      translationPagesHTML = `
    <div class="translation-text-page">
        ${includeLetterhead ? `
        <div class="running-header">
            ${letterheadHTML}
        </div>
        <div class="running-header-spacer"></div>
        ` : ''}
        <div class="translation-content translation-text">
            ${translationHTML}
        </div>
    </div>`;
    }

    // Add PM uploaded translation images
    if (pmTranslationFiles.length > 0) {
      translationPagesHTML += pmTranslationFiles.map((file, idx) => `
    <div class="translation-page">
        ${includeLetterhead ? letterheadHTML : ''}
        <div class="translation-content">
            <img src="data:${file.type || 'image/png'};base64,${file.data}" alt="Translation page ${idx + 1}" class="translation-image" />
        </div>
    </div>`).join('');
    }

    // Original document pages - use originalContents or originalImages
    let originalPagesHTML = '';
    const origDocs = originalContents.length > 0 ? originalContents : originalImages;

    if (includeOriginal && origDocs.length > 0) {
      originalPagesHTML = origDocs.map((doc, idx) => {
        const imgSrc = doc.data?.startsWith('data:') ? doc.data : `data:${doc.contentType || doc.type || 'image/png'};base64,${doc.data}`;
        return `
    <div class="original-documents-page">
        ${includeLetterhead ? letterheadHTML : ''}
        ${idx === 0 ? '<div class="page-title">ORIGINAL DOCUMENT</div>' : ''}
        <div class="original-image-container">
            <img src="${imgSrc}" alt="Original page ${idx + 1}" class="original-image" />
        </div>
    </div>`;
      }).join('');
    }

    // Verification page HTML (with QR code) - Create certification in backend
    let verificationPageHTML = '';
    let pmCertificationId = null; // Store certification ID for hash update
    if (includeVerificationPage) {
      try {
        setProcessingStatus('Creating document certification...');

        // Get translation content for hashing
        const translationContent = translatedContent || pmTranslationHtml ||
          translationResults.map(r => r.translatedText).join('\n');

        // Create certification in backend
        const certResponse = await axios.post(`${API}/certifications/create?admin_key=${adminKey}`, {
          order_id: order?.id || selectedOrderId,
          order_number: order?.order_number || orderNumber,
          document_type: order?.document_type || documentType || 'Translation',
          source_language: sourceLanguage,
          target_language: targetLanguage,
          page_count: origDocs.length || 1,
          document_content: translationContent || 'Certified Translation',
          certifier_name: savedTranslatorName || 'Beatriz Paiva',
          certifier_title: 'Certified Translator',
          certifier_credentials: 'ATA Member #275993',
          company_name: 'Legacy Translations Inc.',
          company_address: '867 Boylston Street, 5th Floor, #2073, Boston, MA 02116',
          company_phone: '(857) 316-7770',
          company_email: 'contact@legacytranslations.com',
          client_name: order?.client_name || ''
        });

        if (certResponse.data.success) {
          const certData = certResponse.data;
          const verificationId = certData.certification_id;
          pmCertificationId = verificationId; // Store for PDF hash update
          const verificationUrl = certData.verification_url;
          const qrCodeData = certData.qr_code_data;

          verificationPageHTML = `
    <div class="verification-page">
        ${includeLetterhead ? letterheadHTML : ''}
        <div class="verification-box">
            <div class="verification-header">
                <div class="verification-icon">üîê</div>
                <h2 class="verification-title">Translation Verification</h2>
                <p class="verification-subtitle">This document can be verified for authenticity</p>
            </div>

            <div class="verification-content">
                <div class="verification-info">
                    <div class="verification-row">
                        <span class="verification-label">Verification ID:</span>
                        <span class="verification-value verification-id">${verificationId}</span>
                    </div>
                    <div class="verification-row">
                        <span class="verification-label">Order Reference:</span>
                        <span class="verification-value">${order?.order_number || orderNumber || 'N/A'}</span>
                    </div>
                    <div class="verification-row">
                        <span class="verification-label">Document Type:</span>
                        <span class="verification-value">${order?.document_type || documentType || 'Translation'}</span>
                    </div>
                    <div class="verification-row">
                        <span class="verification-label">Languages:</span>
                        <span class="verification-value">${sourceLanguage} ‚Üí ${targetLanguage}</span>
                    </div>
                    <div class="verification-row">
                        <span class="verification-label">Issue Date:</span>
                        <span class="verification-value">${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                    </div>
                    <div class="verification-row">
                        <span class="verification-label">Page Count:</span>
                        <span class="verification-value">${origDocs.length || 1} page(s)</span>
                    </div>
                    <div class="verification-row">
                        <span class="verification-label">Certified By:</span>
                        <span class="verification-value">${savedTranslatorName || 'Beatriz Paiva'}</span>
                    </div>
                </div>

                <div class="verification-qr">
                    ${qrCodeData
                      ? `<img src="${qrCodeData}" alt="QR Code" style="width: 120px; height: 120px;" />`
                      : `<div class="qr-placeholder" style="width: 120px; height: 120px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666;">QR Code</div>`
                    }
                    <p class="qr-instruction">Scan to verify authenticity</p>
                </div>
            </div>

            <div class="verification-footer">
                <p class="verification-url">Verify at: <strong>${verificationUrl || `portal.legacytranslations.com/#/verify/${verificationId}`}</strong></p>
                <p class="verification-notice">This translation has been prepared by Legacy Translations Inc., a professional translation company and ATA Member #275993. For verification, please contact us at contact@legacytranslations.com or call (857) 316-7770.</p>
            </div>
        </div>
    </div>`;
        } else {
          console.error('Failed to create certification:', certResponse.data);
          // Fallback to basic verification page without backend storage
          const fallbackId = `LT-${Date.now().toString(36).toUpperCase()}-${Math.random().toString(36).substring(2, 6).toUpperCase()}`;
          verificationPageHTML = `
    <div class="verification-page">
        ${includeLetterhead ? letterheadHTML : ''}
        <div class="verification-box">
            <div class="verification-header">
                <div class="verification-icon">üîê</div>
                <h2 class="verification-title">Translation Verification</h2>
                <p class="verification-subtitle">Contact Legacy Translations to verify this document</p>
            </div>
            <div class="verification-content">
                <div class="verification-info">
                    <div class="verification-row">
                        <span class="verification-label">Reference ID:</span>
                        <span class="verification-value verification-id">${fallbackId}</span>
                    </div>
                    <div class="verification-row">
                        <span class="verification-label">Document Type:</span>
                        <span class="verification-value">${order?.document_type || documentType || 'Translation'}</span>
                    </div>
                    <div class="verification-row">
                        <span class="verification-label">Languages:</span>
                        <span class="verification-value">${sourceLanguage} ‚Üí ${targetLanguage}</span>
                    </div>
                    <div class="verification-row">
                        <span class="verification-label">Issue Date:</span>
                        <span class="verification-value">${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                    </div>
                </div>
            </div>
            <div class="verification-footer">
                <p class="verification-notice">For verification, please contact Legacy Translations Inc. at contact@legacytranslations.com or call (857) 316-7770.</p>
            </div>
        </div>
    </div>`;
        }
      } catch (certError) {
        console.error('Error creating certification:', certError);
        // Fallback
        const fallbackId = `LT-${Date.now().toString(36).toUpperCase()}-${Math.random().toString(36).substring(2, 6).toUpperCase()}`;
        verificationPageHTML = `
    <div class="verification-page">
        ${includeLetterhead ? letterheadHTML : ''}
        <div class="verification-box">
            <div class="verification-header">
                <div class="verification-icon">üîê</div>
                <h2 class="verification-title">Translation Verification</h2>
                <p class="verification-subtitle">Contact Legacy Translations to verify this document</p>
            </div>
            <div class="verification-content">
                <div class="verification-info">
                    <div class="verification-row">
                        <span class="verification-label">Reference ID:</span>
                        <span class="verification-value verification-id">${fallbackId}</span>
                    </div>
                    <div class="verification-row">
                        <span class="verification-label">Document Type:</span>
                        <span class="verification-value">${order?.document_type || documentType || 'Translation'}</span>
                    </div>
                    <div class="verification-row">
                        <span class="verification-label">Issue Date:</span>
                        <span class="verification-value">${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                    </div>
                </div>
            </div>
            <div class="verification-footer">
                <p class="verification-notice">For verification, please contact Legacy Translations Inc. at contact@legacytranslations.com or call (857) 316-7770.</p>
            </div>
        </div>
    </div>`;
      }
    }

    setProcessingStatus('Generating package...');

    // Complete HTML
    const fullHTML = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>${certTitle} - ${order?.order_number || 'Document'}</title>
    <style>
        @page { size: ${pageSizeCSS}; margin: 0.5in 0.6in 0.6in 0.6in; }
        @page cover { size: ${pageSizeCSS}; margin: 0.75in; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Times New Roman', Georgia, serif;
            font-size: 13px;
            line-height: 1.5;
            color: #333;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border: none;
        }
        .header-line {
            height: 3px;
            background: linear-gradient(to right, #3B82F6, #60A5FA);
            margin-bottom: 12px;
            border: none;
        }
        .logo-left { width: 130px; height: 55px; display: flex; align-items: center; }
        .logo-left img { max-width: 100%; max-height: 100%; }
        .logo-placeholder {
            width: 130px; height: 55px; border: 1px dashed #ccc;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: #999; background: #fafafa;
        }
        .header-center { text-align: center; flex: 1; padding: 0 15px; }
        .company-name { font-size: 15px; font-weight: bold; color: #2563eb; margin-bottom: 2px; }
        .company-address { font-size: 9px; line-height: 1.3; color: #333; }
        .logo-right { width: 85px; height: 55px; display: flex; align-items: center; justify-content: flex-end; }
        .logo-right img { max-width: 100%; max-height: 100%; }
        .logo-placeholder-right {
            width: 85px; height: 55px; border: 1px dashed #ccc;
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; color: #1a365d; background: #fafafa; text-align: center; font-style: italic;
        }
        .order-number { text-align: right; margin-bottom: 20px; font-size: 12px; margin-top: 5px; }
        .main-title { text-align: center; font-size: 26px; font-weight: normal; margin-bottom: 20px; color: #1a365d; line-height: 1.2; }
        .subtitle { text-align: center; font-size: 13px; margin-bottom: 25px; line-height: 1.5; }
        .body-text { text-align: justify; margin-bottom: 14px; line-height: 1.6; font-size: 12px; }
        .footer-section { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; padding-top: 20px; }
        .signature-block { text-align: left; line-height: 1.3; }
        .signature-name { font-size: 13px; font-weight: bold; margin-top: 5px; }
        .signature-title { font-size: 11px; color: #666; }
        .signature-date { font-size: 11px; color: #666; margin-top: 5px; }
        .stamp-container { width: 130px; height: 130px; position: relative; }
        .stamp {
            width: 130px; height: 130px; border: 3px solid #2563eb; border-radius: 50%;
            position: relative; display: flex; align-items: center; justify-content: center; background: white;
        }
        .stamp::before {
            content: ''; position: absolute; top: 7px; left: 7px; right: 7px; bottom: 7px;
            border: 1px solid #2563eb; border-radius: 50%;
        }
        .stamp-text-top {
            position: absolute; top: 14px; left: 50%; transform: translateX(-50%);
            font-size: 8px; font-weight: bold; color: #2563eb; letter-spacing: 1.5px;
        }
        .stamp-center { text-align: center; padding: 0 12px; }
        .stamp-company { font-size: 10px; font-weight: bold; color: #2563eb; margin-bottom: 2px; }
        .stamp-ata { font-size: 8px; color: #2563eb; }
        .cover-page { page: cover; page-break-after: always; min-height: 100%; display: flex; flex-direction: column; }
        .translation-page { page-break-before: always; padding-top: 15px; }
        .cover-page + .translation-page { page-break-before: auto; }
        .translation-text-page { page-break-after: always; }
        .original-documents-page { page-break-before: always; padding-top: 15px; }
        .translation-content { margin-top: 10px; }
        .translation-image { width: 100%; height: auto; max-height: none; border: none; object-fit: contain; }
        .translation-text { font-size: 12px; line-height: 1.6; }
        .translation-text p { margin-bottom: 12px; text-align: justify; orphans: 4; widows: 4; }
        .translation-text table { width: 100%; max-width: 100%; border-collapse: collapse; margin: 15px 0; table-layout: fixed; page-break-inside: auto; }
        .translation-text td, .translation-text th { border: 1px solid #ccc; padding: 6px 8px; font-size: 11px; word-wrap: break-word; overflow-wrap: break-word; }
        .translation-text tr { page-break-inside: avoid; page-break-after: auto; }
        .translation-text thead { display: table-header-group; }
        .page-title { font-size: 13px; font-weight: bold; text-align: center; margin: 15px 0 10px 0; color: #1a365d; text-transform: uppercase; letter-spacing: 2px; page-break-after: avoid; }
        .original-image-container { text-align: center; margin-bottom: 10px; }
        .original-image { width: 100%; height: auto; max-height: none; border: none; object-fit: contain; }
        .running-header { position: running(header); }
        .running-header-spacer { height: 80px; }
        @page { @top-center { content: element(header); } }
        /* Verification Page Styles */
        .verification-page { page-break-before: always; padding-top: 20px; }
        .verification-box {
            max-width: 550px; margin: 40px auto; padding: 30px;
            border: 2px solid #2563eb; border-radius: 12px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }
        .verification-header { text-align: center; margin-bottom: 25px; }
        .verification-icon { font-size: 48px; margin-bottom: 10px; }
        .verification-title { font-size: 22px; font-weight: bold; color: #1e40af; margin: 0 0 5px 0; }
        .verification-subtitle { font-size: 12px; color: #64748b; margin: 0; }
        .verification-content { display: flex; gap: 30px; align-items: flex-start; }
        .verification-info { flex: 1; }
        .verification-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #cbd5e1; }
        .verification-row:last-child { border-bottom: none; }
        .verification-label { font-size: 11px; color: #64748b; font-weight: 500; }
        .verification-value { font-size: 12px; color: #1e293b; font-weight: 600; text-align: right; }
        .verification-id { font-family: 'Courier New', monospace; color: #2563eb; font-size: 13px; letter-spacing: 1px; }
        .verification-qr { text-align: center; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .verification-qr .qr-placeholder { width: 100px; height: 100px; margin: 0 auto; }
        .qr-instruction { font-size: 10px; color: #64748b; margin-top: 8px; }
        .verification-footer { margin-top: 25px; text-align: center; padding-top: 20px; border-top: 1px solid #cbd5e1; }
        .verification-url { font-size: 11px; color: #1e40af; margin-bottom: 12px; }
        .verification-notice { font-size: 9px; color: #64748b; line-height: 1.5; max-width: 480px; margin: 0 auto; }
        @media print {
            body { padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; orphans: 4; widows: 4; }
            .cover-page { page: cover; page-break-after: always; }
            .translation-page { page-break-before: always; }
            .cover-page + .translation-page { page-break-before: auto; }
            .translation-text-page { page-break-before: always; }
            .translation-text-page:first-child { page-break-before: auto; }
            .original-documents-page { page-break-before: always; }
            .verification-page { page-break-before: always; }
            .verification-box { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .running-header { position: fixed; top: 0; left: 0; right: 0; background: white; padding: 20px 50px 10px; }
            .running-header-spacer { height: 100px; }
        }
    </style>
</head>
<body>
    ${includeCover ? coverLetterHTML : ''}
    ${translationPagesHTML}
    ${originalPagesHTML}
    ${verificationPageHTML}
</body>
</html>`;

    // Generate PDF with hash tracking for verification
    setProcessingStatus('Generating PDF...');
    const filename = `${order?.order_number || orderNumber || 'PM'}_Certified_Translation.pdf`;

    try {
      const { blob: pdfBlob, hash: pdfHash } = await generatePdfWithHash(fullHTML, filename, {
        margin: [5, 5, 5, 5],
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: { scale: 2, useCORS: true, allowTaint: true },
        jsPDF: { unit: 'mm', format: pageFormat === 'a4' ? 'a4' : 'letter', orientation: 'portrait' }
      });

      // Update PDF hash in backend if we have a certification
      if (pmCertificationId) {
        setProcessingStatus('Registering document hash for verification...');
        await updatePdfHashInBackend(pmCertificationId, pdfHash, adminKey);
      }

      // Download the PDF
      setProcessingStatus('Package ready! Starting download...');
      const downloadUrl = URL.createObjectURL(pdfBlob);
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(downloadUrl);
    } catch (pdfErr) {
      console.error('PDF generation failed, falling back to print:', pdfErr);
      // Fallback to print window if PDF generation fails
      const printWindow = window.open('', '_blank');
      if (printWindow) {
        printWindow.document.write(fullHTML);
        printWindow.document.close();
        printWindow.onload = () => { setTimeout(() => { printWindow.print(); }, 500); };
      }
    }

    setPmPackageGenerating(false);
    setProcessingStatus('');
  };

  // Load review content
  const loadReviewContent = async (order) => {
    setSelectedReview(order);
    setCorrectionNotes('');
    setCurrentDocIndex(0);
    setOriginalContents([]);
    // Reset PM package state
    setPmTranslationFiles([]);
    setPmTranslationHtml('');

    try {
      // Fetch documents for this order
      const docsRes = await axios.get(`${API}/admin/orders/${order.id}/documents?admin_key=${adminKey}`);
      const docs = docsRes.data.documents || [];

      // Load ALL original documents (not just the first one)
      const originalDocs = docs.filter(d => d.document_type === 'original' || !d.document_type || d.source === 'manual_upload' || d.source === 'partner_upload');
      const loadedDocs = [];

      for (const doc of originalDocs) {
        try {
          const origData = await axios.get(`${API}/admin/order-documents/${doc.id}/download?admin_key=${adminKey}`);
          if (origData.data.file_data) {
            const contentType = origData.data.content_type || 'application/pdf';
            const filename = doc.filename || origData.data.filename || 'document';
            const fileData = origData.data.file_data;

            // Check if it's a PDF and convert to images
            if (contentType === 'application/pdf' || filename.toLowerCase().endsWith('.pdf')) {
              try {
                // Convert base64 PDF to images
                const pdfData = fileData.startsWith('data:') ? fileData : `data:application/pdf;base64,${fileData}`;
                const base64Content = pdfData.split(',')[1] || fileData;
                const binaryString = atob(base64Content);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                  bytes[i] = binaryString.charCodeAt(i);
                }

                const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                  const page = await pdf.getPage(pageNum);
                  const scale = 2;
                  const viewport = page.getViewport({ scale });
                  const canvas = document.createElement('canvas');
                  const context = canvas.getContext('2d');
                  canvas.height = viewport.height;
                  canvas.width = viewport.width;
                  await page.render({ canvasContext: context, viewport }).promise;
                  const imageData = canvas.toDataURL('image/png');

                  loadedDocs.push({
                    id: `${doc.id}_page_${pageNum}`,
                    filename: `${filename}_page_${pageNum}.png`,
                    data: imageData,
                    contentType: 'image/png'
                  });
                }
              } catch (pdfErr) {
                console.error('PDF conversion error:', pdfErr);
                // Fallback: add as PDF if conversion fails
                loadedDocs.push({
                  id: doc.id,
                  filename: filename,
                  data: fileData,
                  contentType: contentType
                });
              }
            } else {
              // Not a PDF, add as-is
              loadedDocs.push({
                id: doc.id,
                filename: filename,
                data: fileData,
                contentType: contentType
              });
            }
          }
        } catch (e) {
          console.error('Failed to load document:', doc.id, e);
        }
      }
      setOriginalContents(loadedDocs);

      // Find and load translated document
      const translatedDoc = docs.find(d => d.document_type === 'translation' || d.filename?.includes('translation'));
      if (translatedDoc) {
        const transData = await axios.get(`${API}/admin/order-documents/${translatedDoc.id}/download?admin_key=${adminKey}`);
        setTranslatedContent({
          filename: translatedDoc.filename,
          data: transData.data.file_data,
          contentType: transData.data.content_type,
          html: transData.data.html_content
        });
      } else if (order.translation_html) {
        // Load translation from order's translation_html field
        // Check for corrupted binary content
        if (order.translation_html.startsWith('PK') || (order.translation_html.slice(0, 100).split('').filter(c => c.charCodeAt(0) < 32 && ![9,10,13].includes(c.charCodeAt(0))).length > 10)) {
          console.warn('Binary content detected in translation_html');
          showToast('‚ö†Ô∏è Translation data appears corrupted. Please re-upload the translation file.');
        } else {
          setTranslatedContent({
            filename: 'Translation',
            html: order.translation_html,
            contentType: 'text/html'
          });
        }
      } else {
        // Try to fetch order details to get translation_html
        try {
          const orderRes = await axios.get(`${API}/admin/orders/${order.id}?admin_key=${adminKey}`);
          const orderData = orderRes.data.order || orderRes.data;
          if (orderData.translation_html) {
            // Check for corrupted binary content
            if (orderData.translation_html.startsWith('PK') || (orderData.translation_html.slice(0, 100).split('').filter(c => c.charCodeAt(0) < 32 && ![9,10,13].includes(c.charCodeAt(0))).length > 10)) {
              console.warn('Binary content detected in translation_html');
              showToast('‚ö†Ô∏è Translation data appears corrupted. Please re-upload the translation file.');
            } else {
              setTranslatedContent({
                filename: 'Translation',
                html: orderData.translation_html,
                contentType: 'text/html'
              });
            }
          }
        } catch (orderErr) {
          console.error('Failed to fetch order details:', orderErr);
        }
      }
    } catch (err) {
      console.error('Failed to load review content:', err);
    }
  };

  // Approve translation - PM can ONLY send to Admin
  const approveTranslation = async (sendTo) => {
    if (!selectedReview) return;

    // PM can only send to Admin - enforce this
    if (!isAdmin && sendTo !== 'pending_admin_approval') {
      showToast('PM can only send translations to Admin for approval');
      return;
    }

    setSendingAction(true);

    try {
      let newStatus;
      let alertMessage;
      let translationReady = false;

      if (sendTo === 'pending_admin_approval') {
        newStatus = 'pending_admin_approval';
        alertMessage = '‚úÖ Translation sent to Admin for approval!';
        translationReady = true; // Now ready for Admin to review and send to client
      } else if (isAdmin && sendTo === 'client_review') {
        // Admin only
        newStatus = 'client_review';
        alertMessage = '‚úÖ Sent to client for review!';
        translationReady = true;
      } else if (isAdmin) {
        // Admin only - mark as ready
        newStatus = 'ready';
        alertMessage = '‚úÖ Translation approved and ready!';
        translationReady = true;
      } else {
        // Fallback for PM - always send to admin
        newStatus = 'pending_admin_approval';
        alertMessage = '‚úÖ Translation sent to Admin for approval!';
        translationReady = true;
      }

      await axios.put(`${API}/admin/orders/${selectedReview.id}?admin_key=${adminKey}`, {
        translation_status: newStatus,
        translation_ready: translationReady,
        pm_approved_at: new Date().toISOString(),
        pm_approved_by: user?.name || 'PM'
      });

      // Update local state
      setOrders(prev => prev.map(o =>
        o.id === selectedReview.id ? { ...o, translation_status: newStatus } : o
      ));
      setReviewQueue(prev => prev.filter(o => o.id !== selectedReview.id));
      setSelectedReview(null);
      setOriginalContents([]);
      setTranslatedContent(null);
      setPmApprovalStatus(null);
      setProofreadingResult(null);
      setProofreadingError('');

      showToast(alertMessage);
    } catch (err) {
      console.error('Failed to approve:', err);
      showToast('‚ùå Error approving translation');
    } finally {
      setSendingAction(false);
    }
  };

  // Request correction
  const requestCorrection = async () => {
    if (!selectedReview || !correctionNotes.trim()) {
      showToast('Please add correction notes.');
      return;
    }
    setSendingAction(true);

    try {
      await axios.put(`${API}/admin/orders/${selectedReview.id}?admin_key=${adminKey}`, {
        translation_status: 'in_translation',
        pm_notes: correctionNotes
      });

      // Add message to translator
      const translator = translators.find(t =>
        t.id === selectedReview.assigned_translator_id ||
        t.name === selectedReview.assigned_translator
      );

      if (translator) {
        const msg = {
          id: Date.now(),
          from: user?.name,
          to: translator.name,
          toId: translator.id,
          content: `üìù Correction needed for ${selectedReview.order_number}:\n${correctionNotes}`,
          timestamp: new Date().toISOString(),
          read: false,
          type: 'correction'
        };
        const updatedMessages = [...messages, msg];
        setMessages(updatedMessages);
        localStorage.setItem(`pm_messages_${user?.id}`, JSON.stringify(updatedMessages));
      }

      // Update local state
      setOrders(prev => prev.map(o =>
        o.id === selectedReview.id ? { ...o, translation_status: 'in_translation' } : o
      ));
      setReviewQueue(prev => prev.filter(o => o.id !== selectedReview.id));
      setSelectedReview(null);
      setOriginalContents([]);
      setTranslatedContent(null);
      setCorrectionNotes('');
      setPmApprovalStatus(null);
      setProofreadingResult(null);
      setProofreadingError('');

      showToast('üì® Correction request sent to translator!');
    } catch (err) {
      console.error('Failed to request correction:', err);
      showToast('‚ùå Error requesting correction');
    } finally {
      setSendingAction(false);
    }
  };

  // Save TR Deadline
  const saveTrDeadline = async (orderId) => {
    if (!tempTrDeadline.date) {
      showToast('Please select a date');
      return;
    }

    setSavingTrDeadline(true);
    try {
      const translatorDeadline = `${tempTrDeadline.date}T${tempTrDeadline.time || '17:00'}:00`;

      await axios.put(`${API}/admin/orders/${orderId}?admin_key=${adminKey}`, {
        translator_deadline: translatorDeadline
      });

      // Update local state
      setOrders(prev => prev.map(o =>
        o.id === orderId ? { ...o, translator_deadline: translatorDeadline } : o
      ));

      setEditingTrDeadline(null);
      setTempTrDeadline({ date: '', time: '17:00' });
    } catch (err) {
      console.error('Failed to save TR deadline:', err);
      showToast('‚ùå Error saving TR deadline');
    } finally {
      setSavingTrDeadline(false);
    }
  };

  // Execute automatic proofreading
  const executeProofreading = async () => {
    if (!selectedReview || !translatedContent) {
      setProofreadingError('No translation selected to review.');
      return;
    }

    // Get original text from the first original document
    const originalText = originalContents.length > 0
      ? (originalContents[0].text || 'Texto original n√£o dispon√≠vel em formato texto')
      : 'Texto original n√£o dispon√≠vel';

    // Get translated text (extract from HTML if needed)
    let translatedText = '';
    if (translatedContent.html) {
      // Strip HTML tags for proofreading
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = translatedContent.html;
      translatedText = tempDiv.textContent || tempDiv.innerText || '';
    } else if (translatedContent.data) {
      try {
        translatedText = atob(translatedContent.data);
      } catch (e) {
        translatedText = 'N√£o foi poss√≠vel extrair texto da translation';
      }
    }

    if (!translatedText.trim()) {
      setProofreadingError('N√£o foi poss√≠vel extrair o texto da translation to review.');
      return;
    }

    setIsProofreading(true);
    setProofreadingError('');
    setProofreadingResult(null);

    try {
      // Get Claude API key from localStorage or settings
      const claudeApiKey = localStorage.getItem('claude_api_key') || '';

      if (!claudeApiKey) {
        setProofreadingError('Chave API do Claude n√£o configurada. Configure em Configura√ß√µes.');
        setIsProofreading(false);
        return;
      }

      const response = await axios.post(`${API}/admin/proofread?admin_key=${adminKey}`, {
        original_text: originalText,
        translated_text: translatedText.substring(0, 10000), // Limit text size
        source_language: selectedReview.translate_from || 'Portuguese (Brazil)',
        target_language: selectedReview.translate_to || 'English',
        document_type: selectedReview.document_type || 'General Document',
        claude_api_key: claudeApiKey
      });

      if (response.data.proofreading_result) {
        setProofreadingResult(response.data.proofreading_result);
      } else if (response.data.raw_response) {
        setProofreadingError(`Resposta da IA:\n${response.data.raw_response.substring(0, 500)}...`);
      }
    } catch (error) {
      console.error('Proofreading error:', error);
      setProofreadingError(error.response?.data?.detail || error.message || 'Error running automatic review');
    } finally {
      setIsProofreading(false);
    }
  };

  // Get upcoming deadlines for calendar (both client and translator deadlines)
  const getUpcomingDeadlines = () => {
    const now = new Date();
    const allDeadlines = [];

    orders.forEach(o => {
      if (['delivered', 'ready'].includes(o.translation_status)) return;

      // Client deadline
      if (o.deadline) {
        allDeadlines.push({
          ...o,
          deadlineType: 'client',
          deadlineLabel: 'Client Deadline',
          deadlineDate: new Date(o.deadline),
          daysLeft: Math.ceil((new Date(o.deadline) - now) / (1000 * 60 * 60 * 24))
        });
      }

      // Translator deadline (TR deadline)
      if (o.translator_deadline) {
        allDeadlines.push({
          ...o,
          deadlineType: 'translator',
          deadlineLabel: 'TR Deadline',
          deadlineDate: new Date(o.translator_deadline),
          daysLeft: Math.ceil((new Date(o.translator_deadline) - now) / (1000 * 60 * 60 * 24))
        });
      }
    });

    return allDeadlines.sort((a, b) => a.deadlineDate - b.deadlineDate);
  };

  // Get orders with TR deadlines for the dedicated section
  const getOrdersWithTrDeadlines = () => {
    const now = new Date();
    return orders
      .filter(o => !['delivered', 'ready'].includes(o.translation_status))
      .map(o => ({
        ...o,
        trDeadlineDate: o.translator_deadline ? new Date(o.translator_deadline) : null,
        trDaysLeft: o.translator_deadline
          ? Math.ceil((new Date(o.translator_deadline) - now) / (1000 * 60 * 60 * 24))
          : null,
        clientDeadlineDate: o.deadline ? new Date(o.deadline) : null,
        clientDaysLeft: o.deadline
          ? Math.ceil((new Date(o.deadline) - now) / (1000 * 60 * 60 * 24))
          : null
      }))
      .sort((a, b) => {
        // Sort by TR deadline first, then by orders without TR deadline
        if (a.trDeadlineDate && b.trDeadlineDate) return a.trDeadlineDate - b.trDeadlineDate;
        if (a.trDeadlineDate) return -1;
        if (b.trDeadlineDate) return 1;
        return 0;
      });
  };

  // Section navigation
  const sections = [
    { id: 'overview', label: 'Overview', icon: 'üìä' },
    { id: 'review', label: 'Review Translations', icon: '‚úÖ' },
    { id: 'tr-deadlines', label: 'TR Deadlines', icon: '‚è∞' },
    { id: 'team', label: 'My Team', icon: 'üë•' },
    { id: 'calendar', label: 'Calendar', icon: 'üìÖ' },
    { id: 'reports', label: 'Reports', icon: 'üìà' },
    { id: 'messages', label: 'Messages', icon: 'üí¨' }
  ];

  if (loading) {
    return (
      <div className="p-6 flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
        <span className="ml-3 text-gray-600">Loading dashboard...</span>
      </div>
    );
  }

  return (
    <div className="p-4">
      {/* Header */}
      <div className="mb-4 flex justify-between items-center">
        <div>
          <h1 className="text-xl font-bold text-gray-800">üéØ PM Dashboard</h1>
          <p className="text-sm text-gray-500">Welcome, {user?.name}</p>
        </div>
        <button
          onClick={fetchDashboardData}
          className="px-3 py-1.5 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 text-xs flex items-center gap-1"
        >
          <RefreshIcon className="w-3 h-3" /> Refresh
        </button>
      </div>

      {/* Section Navigation */}
      <div className="flex space-x-1 mb-4 bg-white rounded-lg shadow p-1">
        {sections.map(section => (
          <button
            key={section.id}
            onClick={() => setActiveSection(section.id)}
            className={`flex-1 px-3 py-2 rounded text-xs font-medium transition-colors ${
              activeSection === section.id
                ? 'bg-blue-500 text-white'
                : 'text-gray-600 hover:bg-gray-100'
            }`}
          >
            <span className="mr-1">{section.icon}</span>
            {section.label}
            {section.id === 'review' && reviewQueue.length > 0 && (
              <span className="ml-1 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">
                {reviewQueue.length}
              </span>
            )}
          </button>
        ))}
      </div>

      {/* OVERVIEW SECTION */}
      {activeSection === 'overview' && (
        <div className="space-y-4">
          {/* Stats Cards */}
          <div className="grid grid-cols-6 gap-3">
            <div className="bg-white rounded-lg shadow p-4">
              <div className="text-[10px] text-gray-500 uppercase">Total Projects</div>
              <div className="text-2xl font-bold text-gray-800">{stats.totalProjects}</div>
            </div>
            <div className="bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-lg shadow p-4 text-white">
              <div className="text-[10px] uppercase opacity-80">In Progress</div>
              <div className="text-2xl font-bold">{stats.inProgress}</div>
            </div>
            <div className="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg shadow p-4 text-white">
              <div className="text-[10px] uppercase opacity-80">Awaiting Review</div>
              <div className="text-2xl font-bold">{stats.awaitingReview}</div>
            </div>
            <div className="bg-gradient-to-r from-green-500 to-green-600 rounded-lg shadow p-4 text-white">
              <div className="text-[10px] uppercase opacity-80">Completed</div>
              <div className="text-2xl font-bold">{stats.completed}</div>
            </div>
            <div className="bg-gradient-to-r from-blue-500 to-blue-700 rounded-lg shadow p-4 text-white">
              <div className="text-[10px] uppercase opacity-80">On Time</div>
              <div className="text-2xl font-bold">{stats.onTime}</div>
            </div>
            <div className="bg-gradient-to-r from-red-500 to-red-600 rounded-lg shadow p-4 text-white">
              <div className="text-[10px] uppercase opacity-80">Delayed</div>
              <div className="text-2xl font-bold">{stats.delayed}</div>
            </div>
          </div>

          {/* Quick Actions */}
          <div className="bg-white rounded-lg shadow p-4">
            <h3 className="text-sm font-bold text-gray-800 mb-3">‚ö° Quick Actions</h3>
            <div className="flex gap-2">
              <button
                onClick={() => setActiveSection('review')}
                className="px-4 py-2 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 flex items-center gap-2"
              >
                ‚úÖ Review Translations ({reviewQueue.length})
              </button>
              <button
                onClick={() => setActiveSection('team')}
                className="px-4 py-2 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 flex items-center gap-2"
              >
                üë• View Team
              </button>
              <button
                onClick={() => setActiveSection('calendar')}
                className="px-4 py-2 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 flex items-center gap-2"
              >
                üìÖ View Deadlines
              </button>
            </div>
          </div>

          {/* Recent Projects */}
          <div className="bg-white rounded-lg shadow p-4">
            <h3 className="text-sm font-bold text-gray-800 mb-3">üìã Recent Projects</h3>
            <div className="overflow-x-auto">
              <table className="w-full text-xs">
                <thead>
                  <tr className="border-b">
                    <th className="text-left py-2 px-2">Code</th>
                    <th className="text-left py-2 px-2">Client</th>
                    <th className="text-left py-2 px-2">Languages</th>
                    <th className="text-left py-2 px-2">Translator</th>
                    <th className="text-left py-2 px-2">Status</th>
                    <th className="text-left py-2 px-2">Deadline</th>
                    <th className="text-center py-2 px-2">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {orders.slice(0, 10).map(order => (
                    <tr key={order.id} className="border-b hover:bg-gray-50">
                      <td className="py-2 px-2">
                        <button
                          onClick={() => viewProjectFiles(order)}
                          className="font-mono text-blue-600 hover:text-blue-800 hover:underline cursor-pointer"
                        >
                          {order.order_number}
                        </button>
                      </td>
                      <td className="py-2 px-2">{order.client_name}</td>
                      <td className="py-2 px-2">{order.translate_from} ‚Üí {order.translate_to}</td>
                      <td className="py-2 px-2">
                        {(order.assigned_translator_name || order.assigned_translator) ? (
                          <div className="flex flex-col gap-1">
                            <span
                              onClick={() => openAssignTranslatorModal(order)}
                              className="text-xs text-green-700 font-medium cursor-pointer hover:text-green-900 hover:underline"
                              title="Click to change translator"
                            >
                              {order.assigned_translator_name || order.assigned_translator}
                            </span>
                            {order.translator_assignment_status === 'pending' && (
                              <span
                                onClick={(e) => {
                                  e.stopPropagation();
                                  if (confirm('Mark translator as Accepted?')) {
                                    updateTranslatorAssignmentStatus(order.id, 'accepted');
                                  }
                                }}
                                className="text-[10px] px-1.5 py-0.5 bg-yellow-50 text-yellow-600 rounded w-fit border border-yellow-200 cursor-pointer hover:bg-yellow-100"
                                title="Click to mark as Accepted"
                              >
                                Pending
                              </span>
                            )}
                            {order.translator_assignment_status === 'accepted' && (
                              <span
                                onClick={(e) => {
                                  e.stopPropagation();
                                  if (confirm('Change status back to Pending?')) {
                                    updateTranslatorAssignmentStatus(order.id, 'pending');
                                  }
                                }}
                                className="text-[10px] px-1.5 py-0.5 bg-green-100 text-green-700 rounded w-fit cursor-pointer hover:bg-green-200"
                                title="Click to change status"
                              >
                                ‚úì Accepted
                              </span>
                            )}
                            {order.translator_assignment_status === 'declined' && (
                              <div className="flex flex-col gap-1">
                                <span className="text-[10px] px-1.5 py-0.5 bg-red-100 text-red-700 rounded w-fit">‚úï Declined</span>
                                <button
                                  onClick={() => openAssignTranslatorModal(order)}
                                  className="text-[10px] px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 flex items-center gap-1 w-fit"
                                >
                                  üîÑ Reassign
                                </button>
                              </div>
                            )}
                          </div>
                        ) : (
                          <button
                            onClick={() => openAssignTranslatorModal(order)}
                            className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-[10px] hover:bg-blue-200 flex items-center gap-1"
                          >
                            üìß Email Invite
                          </button>
                        )}
                      </td>
                      <td className="py-2 px-2">
                        <span className={`px-2 py-0.5 rounded text-[10px] ${STATUS_COLORS[order.translation_status] || 'bg-gray-100'}`}>
                          {order.translation_status}
                        </span>
                      </td>
                      <td className="py-2 px-2">
                        {order.deadline ? formatDateLocal(order.deadline) : '-'}
                      </td>
                      <td className="py-2 px-2 text-center">
                        {(order.translation_ready || ['ready', 'delivered', 'final', 'pending_admin_approval', 'pending_admin_review', 'finalized_pending_admin', 'review', 'pending_pm_review'].includes(order.translation_status)) && (
                          <button
                            onClick={() => downloadOrderPackagePM(order)}
                            disabled={downloadingPackagePM === order.id}
                            className="px-2 py-1 bg-purple-500 text-white rounded text-[10px] hover:bg-purple-600 disabled:bg-gray-400 flex items-center gap-1 mx-auto"
                            title="Download complete translation package"
                          >
                            {downloadingPackagePM === order.id ? '...' : 'üì• Package'}
                          </button>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      )}

      {/* QUOTE SECTION - Professional Quote Generator */}
      {activeSection === 'quote' && (
        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            {/* Quote Form */}
            <div className="bg-white rounded-lg shadow p-4">
              <h3 className="text-sm font-bold text-gray-800 mb-4">üí∞ Generate Professional Quote</h3>

              <div className="space-y-3">
                {/* Client Info */}
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-[10px] font-medium text-gray-600 mb-1">Client Name *</label>
                    <input
                      type="text"
                      value={quoteForm.clientName}
                      onChange={(e) => setQuoteForm({...quoteForm, clientName: e.target.value})}
                      className="w-full px-2 py-1.5 text-xs border rounded"
                      placeholder="John Doe"
                    />
                  </div>
                  <div>
                    <label className="block text-[10px] font-medium text-gray-600 mb-1">Client Email *</label>
                    <input
                      type="email"
                      value={quoteForm.clientEmail}
                      onChange={(e) => setQuoteForm({...quoteForm, clientEmail: e.target.value})}
                      className="w-full px-2 py-1.5 text-xs border rounded"
                      placeholder="client@email.com"
                    />
                  </div>
                </div>

                {/* Document Type */}
                <div>
                  <label className="block text-[10px] font-medium text-gray-600 mb-1">Document Type</label>
                  <select
                    value={quoteForm.documentType}
                    onChange={(e) => setQuoteForm({...quoteForm, documentType: e.target.value})}
                    className="w-full px-2 py-1.5 text-xs border rounded"
                  >
                    {DOCUMENT_TYPES.map(doc => <option key={doc.value} value={doc.value}>{doc.label}</option>)}
                  </select>
                </div>

                {/* Languages */}
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-[10px] font-medium text-gray-600 mb-1">Source Language</label>
                    <select
                      value={quoteForm.sourceLanguage}
                      onChange={(e) => setQuoteForm({...quoteForm, sourceLanguage: e.target.value})}
                      className="w-full px-2 py-1.5 text-xs border rounded"
                    >
                      {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-[10px] font-medium text-gray-600 mb-1">Target Language</label>
                    <select
                      value={quoteForm.targetLanguage}
                      onChange={(e) => setQuoteForm({...quoteForm, targetLanguage: e.target.value})}
                      className="w-full px-2 py-1.5 text-xs border rounded"
                    >
                      {LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                    </select>
                  </div>
                </div>

                {/* Service Type & Urgency */}
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-[10px] font-medium text-gray-600 mb-1">Service Type</label>
                    <select
                      value={quoteForm.serviceType}
                      onChange={(e) => {
                        const prices = { certified: 24.99, sworn: 34.99, apostille: 85.00, standard: 19.50 };
                        setQuoteForm({
                          ...quoteForm,
                          serviceType: e.target.value,
                          pricePerPage: prices[e.target.value] || 24.99
                        });
                      }}
                      className="w-full px-2 py-1.5 text-xs border rounded"
                    >
                      <option value="certified">Tradu√ß√£o Certificada (Certified)</option>
                      <option value="sworn">Tradu√ß√£o Juramentada (Sworn)</option>
                      <option value="apostille" disabled>Apostila (Apostille) - Coming Soon</option>
                      <option value="standard">Tradu√ß√£o Profissional (Standard)</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-[10px] font-medium text-gray-600 mb-1">Urg√™ncia</label>
                    <select
                      value={quoteForm.urgency}
                      onChange={(e) => setQuoteForm({...quoteForm, urgency: e.target.value})}
                      className="w-full px-2 py-1.5 text-xs border rounded"
                    >
                      <option value="no">Normal (2-3 dias √∫teis)</option>
                      <option value="priority">Priorit√°rio (24 horas) +25%</option>
                      <option value="urgent">Urgente (12 horas) +100%</option>
                    </select>
                  </div>
                </div>

                {/* Delivery Method */}
                <div>
                  <label className="block text-[10px] font-medium text-gray-600 mb-1">M√©todo de Entrega</label>
                  <select
                    value={quoteForm.deliveryMethod}
                    onChange={(e) => setQuoteForm({...quoteForm, deliveryMethod: e.target.value})}
                    className="w-full px-2 py-1.5 text-xs border rounded"
                  >
                    {Object.entries(PM_DELIVERY_OPTIONS).map(([key, opt]) => (
                      <option key={key} value={key}>
                        {opt.name} {opt.price > 0 ? `(+$${opt.price.toFixed(2)})` : ''}
                      </option>
                    ))}
                  </select>
                </div>

                {/* Pricing */}
                <div className="grid grid-cols-3 gap-3">
                  <div>
                    <label className="block text-[10px] font-medium text-gray-600 mb-1">N¬∫ de P√°ginas</label>
                    <input
                      type="number"
                      value={quoteForm.pageCount}
                      onChange={(e) => setQuoteForm({...quoteForm, pageCount: parseInt(e.target.value) || 1})}
                      min="1"
                      className="w-full px-2 py-1.5 text-xs border rounded"
                    />
                  </div>
                  <div>
                    <label className="block text-[10px] font-medium text-gray-600 mb-1">Pre√ßo por P√°gina ($)</label>
                    <input
                      type="number"
                      value={quoteForm.pricePerPage}
                      onChange={(e) => setQuoteForm({...quoteForm, pricePerPage: parseFloat(e.target.value) || 0})}
                      min="0"
                      step="0.01"
                      className="w-full px-2 py-1.5 text-xs border rounded"
                    />
                  </div>
                  <div>
                    <label className="block text-[10px] font-medium text-gray-600 mb-1">Desconto (%)</label>
                    <input
                      type="number"
                      value={quoteForm.discount}
                      onChange={(e) => setQuoteForm({...quoteForm, discount: parseFloat(e.target.value) || 0})}
                      min="0"
                      max="100"
                      className="w-full px-2 py-1.5 text-xs border rounded"
                    />
                  </div>
                </div>

                {/* Notes */}
                <div>
                  <label className="block text-[10px] font-medium text-gray-600 mb-1">Notes</label>
                  <textarea
                    value={quoteForm.notes}
                    onChange={(e) => setQuoteForm({...quoteForm, notes: e.target.value})}
                    className="w-full px-2 py-1.5 text-xs border rounded"
                    rows="2"
                    placeholder="Additional notes for the quote..."
                  />
                </div>

                {/* Quote Language Selection */}
                <div>
                  <label className="block text-[10px] font-medium text-gray-600 mb-1">Quote Language</label>
                  <div className="flex gap-2">
                    {[
                      { value: 'en', label: 'üá∫üá∏ English' },
                      { value: 'pt', label: 'üáßüá∑ Portugu√™s' },
                      { value: 'es', label: 'üá™üá∏ Espa√±ol' }
                    ].map(lang => (
                      <button
                        key={lang.value}
                        onClick={() => setQuoteLanguage(lang.value)}
                        className={`px-3 py-1.5 text-xs rounded ${
                          quoteLanguage === lang.value
                            ? 'bg-blue-500 text-white'
                            : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                        }`}
                      >
                        {lang.label}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Preview Button */}
                <div className="pt-2">
                  <button
                    onClick={() => setShowQuotePreview(true)}
                    className="w-full px-4 py-2 bg-blue-500 text-white rounded text-sm font-medium hover:bg-blue-600"
                  >
                    üëÅÔ∏è Preview Quote
                  </button>
                </div>
              </div>
            </div>

            {/* Quick Summary Card */}
            <div className="space-y-4">
              {/* Price Summary */}
              <div className="bg-white rounded-lg shadow p-4">
                <h3 className="text-sm font-bold text-gray-800 mb-3">üìä Quote Summary</h3>
                {(() => {
                  const prices = calculateQuote();
                  return (
                    <div className="space-y-2">
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">{quoteForm.pageCount} page(s) √ó ${quoteForm.pricePerPage.toFixed(2)}</span>
                        <span className="font-medium">${prices.basePrice.toFixed(2)}</span>
                      </div>
                      {prices.urgencyFee > 0 && (
                        <div className="flex justify-between text-sm text-blue-600">
                          <span>Urgency Fee ({quoteForm.urgency === 'priority' ? '+25%' : '+100%'})</span>
                          <span>+${prices.urgencyFee.toFixed(2)}</span>
                        </div>
                      )}
                      {prices.deliveryFee > 0 && (
                        <div className="flex justify-between text-sm text-blue-600">
                          <span>Delivery Fee ({PM_DELIVERY_OPTIONS[quoteForm.deliveryMethod]?.name})</span>
                          <span>+${prices.deliveryFee.toFixed(2)}</span>
                        </div>
                      )}
                      {prices.discountAmount > 0 && (
                        <div className="flex justify-between text-sm text-green-600">
                          <span>Desconto ({quoteForm.discount}%)</span>
                          <span>-${prices.discountAmount.toFixed(2)}</span>
                        </div>
                      )}
                      <div className="border-t pt-2 mt-2">
                        <div className="flex justify-between text-lg font-bold">
                          <span>TOTAL</span>
                          <span className="text-blue-600">${prices.total.toFixed(2)}</span>
                        </div>
                      </div>
                    </div>
                  );
                })()}
              </div>

              {/* Recent Clients */}
              <div className="bg-white rounded-lg shadow p-4">
                <h3 className="text-sm font-bold text-gray-800 mb-3">üë§ Recent Clients</h3>
                <div className="space-y-2 max-h-40 overflow-auto">
                  {orders.slice(0, 5).map(order => (
                    <div
                      key={order.id}
                      onClick={() => setQuoteForm({
                        ...quoteForm,
                        clientName: order.client_name,
                        clientEmail: order.client_email
                      })}
                      className="p-2 border rounded cursor-pointer hover:bg-blue-50 text-xs"
                    >
                      <div className="font-medium">{order.client_name}</div>
                      <div className="text-gray-500">{order.client_email}</div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>

          {/* Quote Preview Modal */}
          {showQuotePreview && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-auto">
                {/* Quote Document */}
                <div className="p-8" id="quote-preview">
                  {(() => {
                    const t = quoteTranslations[quoteLanguage];
                    const prices = calculateQuote();
                    const quoteNumber = `LT-${Date.now().toString().slice(-6)}`;
                    const today = new Date().toLocaleDateString(quoteLanguage === 'pt' ? 'pt-BR' : quoteLanguage === 'es' ? 'es-ES' : 'en-US');
                    const validUntil = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString(quoteLanguage === 'pt' ? 'pt-BR' : quoteLanguage === 'es' ? 'es-ES' : 'en-US');

                    return (
                      <>
                        {/* Header with Logo */}
                        <div className="text-center border-b pb-4 mb-6">
                          <div className="text-3xl font-bold text-blue-600 mb-1">LEGACY</div>
                          <div className="text-sm text-gray-500">{t.tagline}</div>
                        </div>

                        {/* Quote Title */}
                        <div className="text-center mb-6">
                          <h1 className="text-2xl font-bold text-gray-800">{t.title}</h1>
                          <div className="grid grid-cols-3 gap-4 mt-4 text-sm">
                            <div>
                              <span className="text-gray-500">{t.quoteNumber}</span>
                              <div className="font-bold text-blue-600">{quoteNumber}</div>
                            </div>
                            <div>
                              <span className="text-gray-500">{t.date}</span>
                              <div className="font-medium">{today}</div>
                            </div>
                            <div>
                              <span className="text-gray-500">{t.validUntil}</span>
                              <div className="font-medium">{validUntil}</div>
                            </div>
                          </div>
                        </div>

                        {/* Client Info */}
                        <div className="bg-gray-50 rounded-lg p-4 mb-6">
                          <h3 className="font-bold text-gray-700 mb-2">{t.clientInfo}</h3>
                          <div className="grid grid-cols-2 gap-2 text-sm">
                            <div>
                              <span className="text-gray-500">{t.name}:</span>
                              <span className="ml-2 font-medium">{quoteForm.clientName || '-'}</span>
                            </div>
                            <div>
                              <span className="text-gray-500">{t.email}:</span>
                              <span className="ml-2 font-medium">{quoteForm.clientEmail || '-'}</span>
                            </div>
                          </div>
                        </div>

                        {/* Service Details */}
                        <div className="mb-6">
                          <h3 className="font-bold text-gray-700 mb-3">{t.serviceDetails}</h3>
                          <div className="grid grid-cols-2 gap-3 text-sm">
                            <div className="flex justify-between border-b pb-2">
                              <span className="text-gray-500">{t.documentType}:</span>
                              <span className="font-medium">{DOCUMENT_TYPES.find(d => d.value === quoteForm.documentType)?.label || '-'}</span>
                            </div>
                            <div className="flex justify-between border-b pb-2">
                              <span className="text-gray-500">{t.serviceType}:</span>
                              <span className="font-medium">{quoteForm.serviceType === 'standard' ? t.certified : t.professional}</span>
                            </div>
                            <div className="flex justify-between border-b pb-2">
                              <span className="text-gray-500">{t.sourceLanguage}:</span>
                              <span className="font-medium">{quoteForm.sourceLanguage}</span>
                            </div>
                            <div className="flex justify-between border-b pb-2">
                              <span className="text-gray-500">{t.targetLanguage}:</span>
                              <span className="font-medium">{quoteForm.targetLanguage}</span>
                            </div>
                            <div className="flex justify-between border-b pb-2 col-span-2">
                              <span className="text-gray-500">{t.urgency}:</span>
                              <span className="font-medium">
                                {quoteForm.urgency === 'no' ? t.normal : quoteForm.urgency === 'priority' ? t.priority : t.urgent}
                              </span>
                            </div>
                          </div>
                        </div>

                        {/* Pricing Table */}
                        <div className="mb-6">
                          <h3 className="font-bold text-gray-700 mb-3">{t.pricing}</h3>
                          <table className="w-full text-sm">
                            <tbody>
                              <tr className="border-b">
                                <td className="py-2 text-gray-600">{t.pages}</td>
                                <td className="py-2 text-right">{quoteForm.pageCount}</td>
                              </tr>
                              <tr className="border-b">
                                <td className="py-2 text-gray-600">{t.pricePerPage}</td>
                                <td className="py-2 text-right">${quoteForm.pricePerPage.toFixed(2)}</td>
                              </tr>
                              <tr className="border-b">
                                <td className="py-2 text-gray-600">{t.subtotal}</td>
                                <td className="py-2 text-right">${prices.basePrice.toFixed(2)}</td>
                              </tr>
                              {prices.urgencyFee > 0 && (
                                <tr className="border-b text-blue-600">
                                  <td className="py-2">{t.urgencyFee}</td>
                                  <td className="py-2 text-right">+${prices.urgencyFee.toFixed(2)}</td>
                                </tr>
                              )}
                              {prices.deliveryFee > 0 && (
                                <tr className="border-b text-blue-600">
                                  <td className="py-2">{quoteLanguage === 'pt' ? 'Delivery Fee' : quoteLanguage === 'es' ? 'Tarifa de Env√≠o' : 'Delivery Fee'}</td>
                                  <td className="py-2 text-right">+${prices.deliveryFee.toFixed(2)}</td>
                                </tr>
                              )}
                              {prices.discountAmount > 0 && (
                                <tr className="border-b text-green-600">
                                  <td className="py-2">{t.discount} ({quoteForm.discount}%)</td>
                                  <td className="py-2 text-right">-${prices.discountAmount.toFixed(2)}</td>
                                </tr>
                              )}
                              <tr className="bg-blue-50 font-bold text-lg">
                                <td className="py-3 text-blue-700">{t.total}</td>
                                <td className="py-3 text-right text-blue-700">${prices.total.toFixed(2)}</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>

                        {/* Notes */}
                        {quoteForm.notes && (
                          <div className="mb-6 bg-yellow-50 rounded-lg p-4">
                            <h3 className="font-bold text-gray-700 mb-2">{t.notes}</h3>
                            <p className="text-sm text-gray-600">{quoteForm.notes}</p>
                          </div>
                        )}

                        {/* Terms */}
                        <div className="mb-6 text-xs text-gray-500 border-t pt-4">
                          <h4 className="font-bold mb-1">{t.terms}</h4>
                          <p>{t.termsText}</p>
                        </div>

                        {/* Footer */}
                        <div className="text-center border-t pt-4">
                          <p className="font-medium text-blue-600 mb-3 text-base">{t.thankYou}</p>
                          <div className="bg-gray-50 rounded-lg p-4 inline-block">
                            <p className="text-gray-700 font-medium mb-1">Legacy Translation Services</p>
                            <p className="text-gray-600 text-sm">legacytranslations.com | {t.phone}: +1(857)316-7770</p>
                            <p className="text-gray-600 text-sm">{t.website}: www.legacytranslation.com</p>
                          </div>
                        </div>
                      </>
                    );
                  })()}
                </div>

                {/* Modal Actions */}
                <div className="border-t p-4 flex justify-between items-center bg-gray-50">
                  <button
                    onClick={() => setShowQuotePreview(false)}
                    className="px-4 py-2 text-gray-600 hover:text-gray-800"
                  >
                    ‚Üê Voltar
                  </button>
                  <div className="flex gap-2">
                    <button
                      onClick={() => window.print()}
                      className="px-4 py-2 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300 flex items-center gap-1"
                    >
                      üñ®Ô∏è Print
                    </button>
                    <button
                      onClick={sendQuoteEmail}
                      disabled={sendingQuote || !quoteForm.clientEmail}
                      className="px-4 py-2 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 disabled:bg-gray-400 flex items-center gap-1"
                    >
                      {sendingQuote ? '‚è≥ Sending...' : 'üìß Send by Email'}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      )}

      {/* REVIEW SECTION - Side by Side View */}
      {activeSection === 'review' && (
        <div className="space-y-4">
          {!selectedReview ? (
            /* Review Queue List */
            <div className="bg-white rounded-lg shadow p-4">
              <h3 className="text-sm font-bold text-gray-800 mb-3">üì• Review Queue ({reviewQueue.length})</h3>
              {reviewQueue.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                  <div className="text-4xl mb-2">‚úÖ</div>
                  <p>No translations awaiting review</p>
                </div>
              ) : (
                <div className="space-y-2">
                  {reviewQueue.map(order => (
                    <div
                      key={order.id}
                      onClick={() => loadReviewContent(order)}
                      className="p-3 border rounded-lg hover:bg-blue-50 cursor-pointer transition-colors flex justify-between items-center"
                    >
                      <div>
                        <div className="font-mono text-blue-600 font-medium">{order.order_number}</div>
                        <div className="text-xs text-gray-500">{order.client_name}</div>
                        <div className="text-[10px] text-gray-400">
                          {order.translate_from} ‚Üí {order.translate_to} ‚Ä¢ Translator: {order.assigned_translator || 'N/A'}
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="text-xs text-gray-600">
                          {order.deadline ? formatDateLocal(order.deadline) : 'No deadline'}
                        </div>
                        <button className="mt-1 px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                          Review ‚Üí
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          ) : (
            /* Side-by-Side Review View */
            <div className="bg-white rounded-lg shadow">
              {/* Review Header */}
              <div className="p-4 border-b">
                <div className="flex justify-between items-center mb-2">
                  <div>
                    <button
                      onClick={() => { setSelectedReview(null); setOriginalContents([]); setTranslatedContent(null); setPmApprovalStatus(null); setProofreadingResult(null); setProofreadingError(''); }}
                      className="text-gray-500 hover:text-gray-700 text-sm mb-1"
                    >
                      ‚Üê Back to queue
                    </button>
                    <h3 className="text-lg font-bold text-gray-800">
                      Review: {selectedReview.order_number}
                    </h3>
                    <p className="text-xs text-gray-500">
                      Client: {selectedReview.client_name} ‚Ä¢ {selectedReview.translate_from} ‚Üí {selectedReview.translate_to}
                    </p>
                  </div>
                  {/* Workflow Status Indicator */}
                  <div className="flex flex-col items-end gap-2">
                    {/* Workflow Steps */}
                    <div className="flex items-center gap-1 text-[10px] text-gray-500 bg-gray-100 px-2 py-1 rounded">
                      <span className={`px-1 py-0.5 rounded ${!proofreadingResult ? 'bg-blue-500 text-white' : 'bg-green-100 text-green-700'}`}>
                        1. Review
                      </span>
                      <span>‚Üí</span>
                      <span className={`px-1 py-0.5 rounded ${proofreadingResult && !pmApprovalStatus ? 'bg-blue-500 text-white' : proofreadingResult ? 'bg-green-100 text-green-700' : 'bg-gray-200'}`}>
                        2. Proofreading
                      </span>
                      <span>‚Üí</span>
                      <span className={`px-1 py-0.5 rounded ${pmApprovalStatus === 'approved' ? 'bg-green-500 text-white' : pmApprovalStatus === 'rejected' ? 'bg-red-500 text-white' : proofreadingResult ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}>
                        3. PM Approve
                      </span>
                      <span>‚Üí</span>
                      <span className={`px-1 py-0.5 rounded ${pmApprovalStatus === 'approved' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}>
                        4. Send to Admin
                      </span>
                    </div>

                    {/* Action Buttons */}
                    <div className="flex gap-2">
                      <button
                        onClick={requestCorrection}
                        disabled={sendingAction}
                        className="px-3 py-2 bg-red-500 text-white rounded text-xs hover:bg-red-600 disabled:bg-gray-400 flex items-center gap-1"
                        title="Send back to translator for corrections"
                      >
                        ‚ùå Reject & Request Correction
                      </button>
                      <button
                        onClick={handlePmPackageDownload}
                        disabled={pmPackageGenerating || (!translatedContent && pmTranslationFiles.length === 0 && !pmTranslationHtml)}
                        className="px-3 py-2 bg-gray-600 text-white rounded text-xs hover:bg-gray-700 disabled:bg-gray-400 flex items-center gap-1"
                      >
                        {pmPackageGenerating ? '‚è≥...' : 'üì¶ Package'}
                      </button>
                      {/* Send to Admin - Only enabled after PM approval */}
                      <button
                        onClick={() => approveTranslation('pending_admin_approval')}
                        disabled={sendingAction || pmApprovalStatus !== 'approved'}
                        className={`px-4 py-2 rounded text-xs flex items-center gap-1 ${
                          pmApprovalStatus === 'approved'
                            ? 'bg-green-600 text-white hover:bg-green-700'
                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                        }`}
                        title={pmApprovalStatus !== 'approved' ? 'Run proofreading and approve first' : 'Send approved translation to Admin'}
                      >
                        {sendingAction ? '‚è≥ Sending...' : 'üì§ Send to Admin'}
                      </button>
                    </div>
                  </div>
                </div>
                {/* Processing Status for PM */}
                {(sendingAction || processingStatus) && (
                  <div className={`mx-4 mb-2 p-2 rounded text-sm ${
                    processingStatus?.includes('‚ùå') ? 'bg-red-100 text-red-700' :
                    processingStatus?.includes('‚úÖ') ? 'bg-green-100 text-green-700' :
                    'bg-blue-100 text-blue-700'
                  }`}>
                    {sendingAction && !processingStatus ? '‚è≥ Processing...' : processingStatus}
                  </div>
                )}
              </div>

              {/* Side by Side Content */}
              <div className="grid grid-cols-2 divide-x" style={{ height: 'calc(100vh - 300px)' }}>
                {/* Original Document(s) */}
                <div className="p-4 overflow-auto">
                  <div className="sticky top-0 bg-white py-1 z-10">
                    <div className="flex items-center justify-between mb-2">
                      <h4 className="text-sm font-bold text-gray-700">
                        üìÑ Original Documents ({originalContents.length})
                      </h4>
                      <label className="px-2 py-1 bg-blue-500 text-white text-xs rounded cursor-pointer hover:bg-blue-600">
                        üì§ Upload
                        <input
                          type="file"
                          accept="image/*,.pdf"
                          multiple
                          onChange={handlePmOriginalUpload}
                          className="hidden"
                        />
                      </label>
                    </div>
                    {originalContents.length > 1 && (
                      <div className="flex items-center justify-between mb-2 bg-gray-100 rounded p-2">
                        <button
                          onClick={() => setCurrentDocIndex(Math.max(0, currentDocIndex - 1))}
                          disabled={currentDocIndex === 0}
                          className="px-2 py-1 text-xs bg-white rounded border disabled:opacity-50"
                        >
                          ‚óÄ Previous
                        </button>
                        <span className="text-xs font-medium">
                          {currentDocIndex + 1} / {originalContents.length}
                        </span>
                        <button
                          onClick={() => setCurrentDocIndex(Math.min(originalContents.length - 1, currentDocIndex + 1))}
                          disabled={currentDocIndex >= originalContents.length - 1}
                          className="px-2 py-1 text-xs bg-white rounded border disabled:opacity-50"
                        >
                          Next ‚ñ∂
                        </button>
                      </div>
                    )}
                    {originalContents[currentDocIndex] && (
                      <p className="text-xs text-gray-500 mb-2 truncate">
                        üìé {originalContents[currentDocIndex].filename}
                      </p>
                    )}
                  </div>
                  {originalContents.length > 0 && originalContents[currentDocIndex] ? (
                    originalContents[currentDocIndex].contentType?.includes('image') || originalContents[currentDocIndex].data?.startsWith('data:image') ? (
                      <img
                        src={originalContents[currentDocIndex].data?.startsWith('data:')
                          ? originalContents[currentDocIndex].data
                          : `data:${originalContents[currentDocIndex].contentType};base64,${originalContents[currentDocIndex].data}`}
                        alt="Original"
                        className="max-w-full border rounded"
                      />
                    ) : originalContents[currentDocIndex].contentType?.includes('pdf') ? (
                      <iframe
                        src={originalContents[currentDocIndex].data?.startsWith('data:')
                          ? originalContents[currentDocIndex].data
                          : `data:application/pdf;base64,${originalContents[currentDocIndex].data}`}
                        className="w-full h-full border rounded"
                        title="Original PDF"
                      />
                    ) : (
                      <div className="p-4 bg-gray-50 rounded border text-sm whitespace-pre-wrap">
                        {atob(originalContents[currentDocIndex].data)}
                      </div>
                    )
                  ) : (
                    <div className="text-center py-8 text-gray-400">
                      <div className="text-2xl mb-2">üìÑ</div>
                      <p className="text-xs">Original document not found</p>
                    </div>
                  )}
                </div>

                {/* Translated Document */}
                <div className="p-4 overflow-auto">
                  <div className="sticky top-0 bg-white py-1 z-10">
                    <div className="flex items-center justify-between mb-2">
                      <h4 className="text-sm font-bold text-gray-700">
                        ‚úçÔ∏è Translation {(pmTranslationFiles.length > 0 || pmTranslationHtml) &&
                          <span className="text-green-600 text-xs ml-2">
                            ({pmTranslationFiles.length} images{pmTranslationHtml ? ' + HTML' : ''})
                          </span>
                        }
                      </h4>
                      <label className="px-2 py-1 bg-green-500 text-white text-xs rounded cursor-pointer hover:bg-green-600">
                        üì§ Upload Translation
                        <input
                          type="file"
                          accept="image/*,.pdf,.docx,.html,.htm,.txt"
                          multiple
                          onChange={handlePmTranslationUpload}
                          className="hidden"
                        />
                      </label>
                    </div>
                  </div>
                  {translatedContent ? (
                    translatedContent.html ? (
                      <div
                        className="border rounded p-4 bg-white pm-translation-preview"
                        dangerouslySetInnerHTML={{ __html: translatedContent.html }}
                      />
                    ) : translatedContent.contentType?.includes('image') ? (
                      <img
                        src={translatedContent.data?.startsWith('data:')
                          ? translatedContent.data
                          : `data:${translatedContent.contentType};base64,${translatedContent.data}`}
                        alt="Translation"
                        className="max-w-full border rounded"
                      />
                    ) : translatedContent.contentType?.includes('pdf') ? (
                      <iframe
                        src={translatedContent.data?.startsWith('data:')
                          ? translatedContent.data
                          : `data:application/pdf;base64,${translatedContent.data}`}
                        className="w-full h-full border rounded"
                        title="Translation PDF"
                      />
                    ) : (
                      <div className="p-4 bg-gray-50 rounded border text-sm whitespace-pre-wrap">
                        {atob(translatedContent.data)}
                      </div>
                    )
                  ) : (pmTranslationFiles.length > 0 || pmTranslationHtml) ? (
                    <div>
                      {/* Show PM uploaded HTML content */}
                      {pmTranslationHtml && (
                        <div
                          className="border rounded p-4 bg-white mb-4 pm-translation-preview"
                          dangerouslySetInnerHTML={{ __html: pmTranslationHtml }}
                        />
                      )}
                      {/* Show PM uploaded images */}
                      {pmTranslationFiles.map((file, idx) => (
                        <div key={idx} className="mb-4">
                          <p className="text-xs text-gray-500 mb-1">üìé {file.filename}</p>
                          <img
                            src={`data:${file.type || 'image/png'};base64,${file.data}`}
                            alt={`Translation page ${idx + 1}`}
                            className="max-w-full border rounded"
                          />
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-8 text-gray-400">
                      <div className="text-2xl mb-2">‚úçÔ∏è</div>
                      <p className="text-xs">Translation not found</p>
                      <p className="text-xs mt-2">Use "Upload Translation" to add files</p>
                    </div>
                  )}
                </div>
              </div>

              {/* Correction Notes */}
              <div className="p-4 border-t bg-gray-50">
                <label className="block text-xs font-medium text-gray-600 mb-1">
                  üìù Correction Notes (to send to translator):
                </label>
                <textarea
                  value={correctionNotes}
                  onChange={(e) => setCorrectionNotes(e.target.value)}
                  placeholder="Describe necessary corrections..."
                  className="w-full p-2 border rounded text-xs h-20 resize-none"
                />
              </div>

              {/* Proofreading Section - Step 2: Required before PM Approval */}
              <div className={`p-4 border-t ${!proofreadingResult ? 'bg-yellow-50 border-l-4 border-l-yellow-400' : 'bg-white'}`}>
                <div className="flex items-center justify-between mb-3">
                  <div>
                    <h4 className="text-sm font-bold text-blue-700 flex items-center gap-2">
                      üîç Step 2: Proofreading Analysis
                      {proofreadingResult && <span className="text-green-600 text-xs">‚úì Complete</span>}
                    </h4>
                    {!proofreadingResult && (
                      <p className="text-xs text-yellow-700 mt-1">
                        ‚ö†Ô∏è Required: Run proofreading before you can approve the translation
                      </p>
                    )}
                  </div>
                  <button
                    onClick={executeProofreading}
                    disabled={isProofreading || !translatedContent}
                    className={`px-4 py-2 rounded text-xs flex items-center gap-2 ${
                      !proofreadingResult
                        ? 'bg-yellow-500 text-white hover:bg-yellow-600 animate-pulse'
                        : 'bg-blue-600 text-white hover:bg-blue-700'
                    } disabled:bg-gray-400 disabled:animate-none`}
                  >
                    {isProofreading ? (
                      <>
                        <div className="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        Analyzing...
                      </>
                    ) : proofreadingResult ? (
                      <>üîÑ Re-run Proofreading</>
                    ) : (
                      <>üîç Run Proofreading (Next Step)</>
                    )}
                  </button>
                </div>

                {/* Error Message */}
                {proofreadingError && (
                  <div className="p-3 bg-red-50 border border-red-200 rounded mb-3">
                    <p className="text-xs text-red-600">‚ùå {proofreadingError}</p>
                  </div>
                )}

                {/* Results */}
                {proofreadingResult && (
                  <div className="space-y-3">
                    {/* Summary */}
                    <div className={`p-3 rounded border ${
                      proofreadingResult.resumo?.qualidade === 'APROVADO' ? 'bg-green-50 border-green-200' :
                      proofreadingResult.resumo?.qualidade === 'APROVADO_COM_OBSERVACOES' ? 'bg-yellow-50 border-yellow-200' :
                      'bg-red-50 border-red-200'
                    }`}>
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-xs font-bold">
                          {proofreadingResult.resumo?.qualidade === 'APROVADO' ? '‚úÖ APROVADO' :
                           proofreadingResult.resumo?.qualidade === 'APROVADO_COM_OBSERVACOES' ? '‚ö†Ô∏è APROVADO COM OBSERVA√á√ïES' :
                           '‚ùå REPROVADO'}
                        </span>
                        <span className="text-xs text-gray-600">
                          {proofreadingResult.resumo?.total_erros || 0} erro(s) found(s)
                        </span>
                      </div>
                      <div className="grid grid-cols-4 gap-2 text-[10px]">
                        <div className="text-center p-1 bg-red-100 rounded">
                          <div className="font-bold text-red-600">{proofreadingResult.resumo?.criticos || 0}</div>
                          <div className="text-gray-600">Cr√≠ticos</div>
                        </div>
                        <div className="text-center p-1 bg-blue-100 rounded">
                          <div className="font-bold text-blue-600">{proofreadingResult.resumo?.altos || 0}</div>
                          <div className="text-gray-600">Altos</div>
                        </div>
                        <div className="text-center p-1 bg-yellow-100 rounded">
                          <div className="font-bold text-yellow-600">{proofreadingResult.resumo?.medios || 0}</div>
                          <div className="text-gray-600">M√©dios</div>
                        </div>
                        <div className="text-center p-1 bg-blue-100 rounded">
                          <div className="font-bold text-blue-600">{proofreadingResult.resumo?.baixos || 0}</div>
                          <div className="text-gray-600">Baixos</div>
                        </div>
                      </div>
                    </div>

                    {/* Error List */}
                    {proofreadingResult.erros && proofreadingResult.erros.length > 0 && (
                      <div className="max-h-60 overflow-y-auto border rounded">
                        <table className="w-full text-[10px]">
                          <thead className="bg-gray-100 sticky top-0">
                            <tr>
                              <th className="p-2 text-left">Tipo</th>
                              <th className="p-2 text-left">Original</th>
                              <th className="p-2 text-left">Encontrado</th>
                              <th className="p-2 text-left">Sugerido</th>
                              <th className="p-2 text-center">Gravidade</th>
                            </tr>
                          </thead>
                          <tbody>
                            {proofreadingResult.erros.map((erro, idx) => {
                              const severity = erro.severidade || erro.gravidade || 'M√âDIO';
                              const foundText = erro.traducao_errada || erro.found || '';
                              const suggestionText = erro.correcao || erro.sugestao || '';
                              return (
                              <tr
                                key={idx}
                                data-pm-error-row={idx}
                                onClick={() => handlePmErrorRowClick(idx, foundText)}
                                className={`border-t cursor-pointer hover:ring-2 hover:ring-indigo-300 transition-all ${
                                  highlightedPmErrorIndex === idx ? 'ring-2 ring-indigo-500 ring-inset shadow-lg' :
                                  severity === 'CR√çTICO' ? 'bg-red-50' :
                                  severity === 'ALTO' ? 'bg-blue-50' :
                                  severity === 'M√âDIO' ? 'bg-yellow-50' :
                                  'bg-blue-50'
                                }`}
                                title="Click to highlight in translation"
                              >
                                <td className="p-2">{erro.tipo}</td>
                                <td className="p-2 font-mono">{erro.original || '-'}</td>
                                <td className="p-2 font-mono text-red-600">{foundText || '-'}</td>
                                <td className="p-2 font-mono text-green-600">{suggestionText || '-'}</td>
                                <td className="p-2 text-center">
                                  <span className={`px-1 py-0.5 rounded text-white ${
                                    severity === 'CR√çTICO' ? 'bg-red-500' :
                                    severity === 'ALTO' ? 'bg-blue-500' :
                                    severity === 'M√âDIO' ? 'bg-yellow-500' :
                                    'bg-blue-500'
                                  }`}>
                                    {severity}
                                  </span>
                                </td>
                              </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    )}

                    {/* Observations */}
                    {proofreadingResult.observacoes && proofreadingResult.observacoes.length > 0 && (
                      <div className="p-3 bg-blue-50 border border-blue-200 rounded">
                        <h5 className="text-xs font-bold text-blue-700 mb-2">üìå Observa√ß√µes:</h5>
                        <ul className="text-[10px] text-gray-700 space-y-1">
                          {proofreadingResult.observacoes.map((obs, idx) => (
                            <li key={idx}>‚Ä¢ {obs}</li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {/* PM APPROVAL SECTION - Required step after proofreading */}
                    <div className={`mt-4 p-4 rounded-lg border-2 ${
                      pmApprovalStatus === 'approved' ? 'bg-green-50 border-green-400' :
                      pmApprovalStatus === 'rejected' ? 'bg-red-50 border-red-400' :
                      'bg-yellow-50 border-yellow-400'
                    }`}>
                      <h5 className="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                        ‚úÖ PM Approval Decision
                        {pmApprovalStatus === 'approved' && <span className="text-green-600 text-xs font-normal">(Approved - Ready to send)</span>}
                        {pmApprovalStatus === 'rejected' && <span className="text-red-600 text-xs font-normal">(Rejected - Send back to translator)</span>}
                      </h5>

                      {!pmApprovalStatus ? (
                        <div>
                          <p className="text-xs text-gray-600 mb-3">
                            Review the proofreading analysis above. As PM, you must approve or reject this translation before it can be sent to Admin.
                          </p>
                          <div className="flex gap-3">
                            <button
                              onClick={() => {
                                setPmApprovalStatus('approved');
                                setProcessingStatus('‚úÖ Translation APPROVED by PM. Ready to send to Admin.');
                                setTimeout(() => setProcessingStatus(''), 3000);
                              }}
                              disabled={(proofreadingResult.resumo?.criticos || 0) > 0}
                              className={`flex-1 py-3 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${
                                (proofreadingResult.resumo?.criticos || 0) > 0
                                  ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                  : 'bg-green-600 text-white hover:bg-green-700'
                              }`}
                              title={(proofreadingResult.resumo?.criticos || 0) > 0 ? 'Cannot approve - Critical errors found' : 'Approve translation'}
                            >
                              ‚úÖ APPROVE TRANSLATION
                            </button>
                            <button
                              onClick={() => {
                                setPmApprovalStatus('rejected');
                                setProcessingStatus('‚ùå Translation REJECTED by PM. Use "Request Correction" to send back to translator.');
                                setTimeout(() => setProcessingStatus(''), 5000);
                              }}
                              className="flex-1 py-3 bg-red-600 text-white rounded-lg text-sm font-bold hover:bg-red-700 flex items-center justify-center gap-2"
                            >
                              ‚ùå REJECT TRANSLATION
                            </button>
                          </div>
                          {(proofreadingResult.resumo?.criticos || 0) > 0 && (
                            <p className="text-xs text-red-600 mt-2">
                              ‚ö†Ô∏è Cannot approve: {proofreadingResult.resumo?.criticos} critical error(s) found. Request corrections or review manually.
                            </p>
                          )}
                        </div>
                      ) : pmApprovalStatus === 'approved' ? (
                        <div className="text-center">
                          <div className="text-3xl mb-2">‚úÖ</div>
                          <p className="text-green-700 font-medium">Translation Approved by PM</p>
                          <p className="text-xs text-gray-600 mt-1">Click "Send to Admin" button above to proceed.</p>
                          <button
                            onClick={() => setPmApprovalStatus(null)}
                            className="mt-3 text-xs text-gray-500 hover:text-gray-700 underline"
                          >
                            ‚Ü© Undo approval
                          </button>
                        </div>
                      ) : (
                        <div className="text-center">
                          <div className="text-3xl mb-2">‚ùå</div>
                          <p className="text-red-700 font-medium">Translation Rejected by PM</p>
                          <p className="text-xs text-gray-600 mt-1">Use "Request Correction" button to send feedback to translator.</p>
                          <button
                            onClick={() => setPmApprovalStatus(null)}
                            className="mt-3 text-xs text-gray-500 hover:text-gray-700 underline"
                          >
                            ‚Ü© Undo rejection
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* No review yet message */}
                {!proofreadingResult && !proofreadingError && !isProofreading && (
                  <div className="text-center py-6 bg-yellow-50 rounded-lg border border-yellow-200">
                    <div className="text-3xl mb-2">üîç</div>
                    <p className="text-sm text-yellow-800 font-medium">Proofreading Required</p>
                    <p className="text-xs text-yellow-600 mt-1">
                      Click "Run Proofreading" above to analyze the translation quality.
                      <br />
                      You must complete this step before you can approve the translation.
                    </p>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      )}

      {/* TR DEADLINES SECTION - Translator Deadline Management */}
      {activeSection === 'tr-deadlines' && (
        <div className="space-y-4">
          <div className="bg-white rounded-lg shadow p-4">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-sm font-bold text-gray-800">‚è∞ Translator Deadlines (TR Deadlines)</h3>
              <div className="text-xs text-gray-500">
                Manage when translators must return their work
              </div>
            </div>

            {/* Stats Cards */}
            <div className="grid grid-cols-4 gap-3 mb-4">
              <div className="bg-red-50 p-3 rounded-lg border border-red-200">
                <div className="text-2xl font-bold text-red-600">
                  {getOrdersWithTrDeadlines().filter(o => o.trDaysLeft !== null && o.trDaysLeft < 0).length}
                </div>
                <div className="text-xs text-red-700">Overdue</div>
              </div>
              <div className="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                <div className="text-2xl font-bold text-yellow-600">
                  {getOrdersWithTrDeadlines().filter(o => o.trDaysLeft !== null && o.trDaysLeft >= 0 && o.trDaysLeft <= 2).length}
                </div>
                <div className="text-xs text-yellow-700">Due in 2 days</div>
              </div>
              <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                <div className="text-2xl font-bold text-blue-600">
                  {getOrdersWithTrDeadlines().filter(o => o.trDaysLeft !== null && o.trDaysLeft > 2).length}
                </div>
                <div className="text-xs text-blue-700">On Track</div>
              </div>
              <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                <div className="text-2xl font-bold text-gray-600">
                  {getOrdersWithTrDeadlines().filter(o => o.trDaysLeft === null).length}
                </div>
                <div className="text-xs text-gray-700">No TR Deadline</div>
              </div>
            </div>

            {/* Orders Table */}
            <div className="overflow-x-auto">
              <table className="w-full text-xs">
                <thead className="bg-gray-100">
                  <tr>
                    <th className="p-2 text-left">Order</th>
                    <th className="p-2 text-left">Client</th>
                    <th className="p-2 text-left">Translator</th>
                    <th className="p-2 text-left">Status</th>
                    <th className="p-2 text-left">TR Deadline</th>
                    <th className="p-2 text-left">Client Deadline</th>
                    <th className="p-2 text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {getOrdersWithTrDeadlines().map(order => (
                    <tr key={order.id} className={`border-t hover:bg-gray-50 ${
                      order.trDaysLeft !== null && order.trDaysLeft < 0 ? 'bg-red-50' :
                      order.trDaysLeft !== null && order.trDaysLeft <= 2 ? 'bg-yellow-50' : ''
                    }`}>
                      <td className="p-2">
                        <span className="font-mono text-blue-600">{order.order_number}</span>
                      </td>
                      <td className="p-2">{order.client_name}</td>
                      <td className="p-2">
                        {order.assigned_translator || order.assigned_translator_name || (
                          <span className="text-gray-400 italic">Not assigned</span>
                        )}
                      </td>
                      <td className="p-2">
                        <span className={`px-2 py-0.5 rounded text-[10px] ${
                          order.translation_status === 'in_translation' ? 'bg-yellow-100 text-yellow-800' :
                          order.translation_status === 'review' ? 'bg-blue-100 text-blue-800' :
                          order.translation_status === 'pending_pm_review' ? 'bg-purple-100 text-purple-800' :
                          'bg-gray-100 text-gray-800'
                        }`}>
                          {order.translation_status}
                        </span>
                      </td>
                      <td className="p-2">
                        {editingTrDeadline === order.id ? (
                          <div className="flex gap-1">
                            <input
                              type="date"
                              value={tempTrDeadline.date}
                              onChange={(e) => setTempTrDeadline(prev => ({ ...prev, date: e.target.value }))}
                              className="border rounded px-1 py-0.5 text-xs w-28"
                            />
                            <input
                              type="time"
                              value={tempTrDeadline.time}
                              onChange={(e) => setTempTrDeadline(prev => ({ ...prev, time: e.target.value }))}
                              className="border rounded px-1 py-0.5 text-xs w-20"
                            />
                            <button
                              onClick={() => saveTrDeadline(order.id)}
                              disabled={savingTrDeadline}
                              className="px-2 py-0.5 bg-green-500 text-white rounded text-xs hover:bg-green-600"
                            >
                              {savingTrDeadline ? '...' : '‚úì'}
                            </button>
                            <button
                              onClick={() => setEditingTrDeadline(null)}
                              className="px-2 py-0.5 bg-gray-300 text-gray-700 rounded text-xs hover:bg-gray-400"
                            >
                              ‚úï
                            </button>
                          </div>
                        ) : (
                          <div className="flex items-center gap-2">
                            {order.translator_deadline ? (
                              <>
                                <span className={`font-medium ${
                                  order.trDaysLeft < 0 ? 'text-red-600' :
                                  order.trDaysLeft <= 2 ? 'text-yellow-600' : 'text-gray-700'
                                }`}>
                                  {formatDateLocal(order.translator_deadline)}
                                </span>
                                <span className={`text-[10px] px-1 py-0.5 rounded ${
                                  order.trDaysLeft < 0 ? 'bg-red-100 text-red-700' :
                                  order.trDaysLeft <= 2 ? 'bg-yellow-100 text-yellow-700' :
                                  'bg-green-100 text-green-700'
                                }`}>
                                  {order.trDaysLeft < 0 ? `${Math.abs(order.trDaysLeft)}d overdue` :
                                   order.trDaysLeft === 0 ? 'Today' :
                                   `${order.trDaysLeft}d left`}
                                </span>
                              </>
                            ) : (
                              <span className="text-gray-400 italic">Not set</span>
                            )}
                          </div>
                        )}
                      </td>
                      <td className="p-2">
                        {order.deadline ? (
                          <span className="text-gray-600">{formatDateLocal(order.deadline)}</span>
                        ) : (
                          <span className="text-gray-400 italic">Not set</span>
                        )}
                      </td>
                      <td className="p-2 text-center">
                        {editingTrDeadline !== order.id && (
                          <button
                            onClick={() => {
                              setEditingTrDeadline(order.id);
                              if (order.translator_deadline) {
                                const dt = new Date(order.translator_deadline);
                                setTempTrDeadline({
                                  date: dt.toISOString().split('T')[0],
                                  time: dt.toTimeString().slice(0, 5)
                                });
                              } else {
                                // Default to 2 days before client deadline if set, otherwise tomorrow at 5pm
                                if (order.deadline) {
                                  const clientDeadline = new Date(order.deadline);
                                  clientDeadline.setDate(clientDeadline.getDate() - 2);
                                  setTempTrDeadline({
                                    date: clientDeadline.toISOString().split('T')[0],
                                    time: '17:00'
                                  });
                                } else {
                                  const tomorrow = new Date();
                                  tomorrow.setDate(tomorrow.getDate() + 1);
                                  setTempTrDeadline({
                                    date: tomorrow.toISOString().split('T')[0],
                                    time: '17:00'
                                  });
                                }
                              }
                            }}
                            className="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600"
                          >
                            {order.translator_deadline ? '‚úèÔ∏è Edit' : '‚ûï Set Deadline'}
                          </button>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {getOrdersWithTrDeadlines().length === 0 && (
              <div className="text-center py-8 text-gray-500">
                <div className="text-3xl mb-2">üì≠</div>
                <p>No active orders to manage</p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* TEAM SECTION */}
      {activeSection === 'team' && (
        <div className="space-y-4">
          <div className="bg-white rounded-lg shadow p-4">
            <h3 className="text-sm font-bold text-gray-800 mb-3">üë• My Translator Team</h3>
            <div className="grid grid-cols-3 gap-3">
              {translators.map(translator => {
                const translatorOrders = orders.filter(o =>
                  o.assigned_translator_id === translator.id ||
                  o.assigned_translator === translator.name
                );
                const activeOrders = translatorOrders.filter(o =>
                  ['in_translation', 'review'].includes(o.translation_status)
                );
                const completedOrders = translatorOrders.filter(o =>
                  ['ready', 'delivered'].includes(o.translation_status)
                );
                const isBusy = activeOrders.length > 0;

                return (
                  <div
                    key={translator.id}
                    className={`p-4 rounded-lg border-2 ${isBusy ? 'border-yellow-200 bg-yellow-50' : 'border-green-200 bg-green-50'}`}
                  >
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center">
                        <div className={`w-3 h-3 rounded-full mr-2 ${isBusy ? 'bg-yellow-500' : 'bg-green-500'}`}></div>
                        <span className="font-medium text-sm">{translator.name}</span>
                      </div>
                      <span className={`text-[10px] px-2 py-0.5 rounded-full ${isBusy ? 'bg-yellow-500 text-white' : 'bg-green-500 text-white'}`}>
                        {isBusy ? 'Ocupado' : 'Dispon√≠vel'}
                      </span>
                    </div>
                    <div className="text-[10px] text-gray-500 mb-2">{translator.email}</div>

                    <div className="grid grid-cols-2 gap-2 text-center mt-3">
                      <div className="bg-white rounded p-2">
                        <div className="text-lg font-bold text-yellow-600">{activeOrders.length}</div>
                        <div className="text-[9px] text-gray-500">In Progress</div>
                      </div>
                      <div className="bg-white rounded p-2">
                        <div className="text-lg font-bold text-green-600">{completedOrders.length}</div>
                        <div className="text-[9px] text-gray-500">Completed</div>
                      </div>
                    </div>

                    {activeOrders.length > 0 && (
                      <div className="mt-3 pt-2 border-t">
                        <div className="text-[10px] font-medium text-gray-600 mb-1">Active Projects:</div>
                        {activeOrders.slice(0, 3).map((order, idx) => (
                          <div key={idx} className="flex justify-between text-[10px] py-0.5">
                            <span className="text-blue-600 font-mono">{order.order_number}</span>
                            <span className="text-gray-500">
                              {order.deadline ? formatDateLocal(order.deadline) : '-'}
                            </span>
                          </div>
                        ))}
                      </div>
                    )}

                    <button
                      onClick={() => { setSelectedTranslator(translator); setActiveSection('messages'); }}
                      className="mt-3 w-full px-2 py-1 bg-blue-500 text-white text-[10px] rounded hover:bg-blue-600"
                    >
                      üí¨ Send Message
                    </button>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      )}

      {/* CALENDAR SECTION */}
      {activeSection === 'calendar' && (
        <div className="space-y-4">
          <div className="bg-white rounded-lg shadow p-4">
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-sm font-bold text-gray-800">üìÖ Deadline Calendar</h3>
              <div className="flex gap-2 text-[10px]">
                <span className="px-2 py-1 bg-purple-100 text-purple-700 rounded">‚è∞ TR = Translator</span>
                <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded">üì¶ Client = Delivery</span>
              </div>
            </div>
            <div className="space-y-2">
              {getUpcomingDeadlines().map((item, idx) => (
                <div
                  key={`${item.id}-${item.deadlineType}-${idx}`}
                  className={`p-3 rounded-lg border flex justify-between items-center ${
                    item.daysLeft < 0 ? 'bg-red-50 border-red-200' :
                    item.daysLeft <= 2 ? (item.deadlineType === 'translator' ? 'bg-purple-50 border-purple-200' : 'bg-blue-50 border-blue-200') :
                    item.daysLeft <= 5 ? 'bg-yellow-50 border-yellow-200' :
                    'bg-green-50 border-green-200'
                  }`}
                >
                  <div>
                    <div className="flex items-center gap-2">
                      <span className={`px-2 py-0.5 rounded text-[10px] font-bold ${
                        item.deadlineType === 'translator'
                          ? 'bg-purple-500 text-white'
                          : 'bg-blue-500 text-white'
                      }`}>
                        {item.deadlineType === 'translator' ? '‚è∞ TR' : 'üì¶ CLIENT'}
                      </span>
                      <span className="font-mono text-blue-600 font-medium">{item.order_number}</span>
                    </div>
                    <div className="text-xs text-gray-600 mt-1">{item.client_name}</div>
                    <div className="text-[10px] text-gray-500">
                      {item.translate_from} ‚Üí {item.translate_to} ‚Ä¢ {item.assigned_translator || item.assigned_translator_name || 'No translator'}
                    </div>
                  </div>
                  <div className="text-right">
                    <div className={`text-lg font-bold ${
                      item.daysLeft < 0 ? 'text-red-600' :
                      item.daysLeft <= 2 ? (item.deadlineType === 'translator' ? 'text-purple-600' : 'text-blue-600') :
                      item.daysLeft <= 5 ? 'text-yellow-600' :
                      'text-green-600'
                    }`}>
                      {item.daysLeft < 0
                        ? `${Math.abs(item.daysLeft)}d overdue`
                        : item.daysLeft === 0
                        ? 'TODAY'
                        : `${item.daysLeft}d left`
                      }
                    </div>
                    <div className="text-xs text-gray-500">
                      {item.deadlineDate.toLocaleDateString('en-US')} {item.deadlineDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                    <span className={`mt-1 inline-block px-2 py-0.5 rounded text-[10px] ${STATUS_COLORS[item.translation_status] || 'bg-gray-100'}`}>
                      {item.translation_status}
                    </span>
                  </div>
                </div>
              ))}
              {getUpcomingDeadlines().length === 0 && (
                <div className="text-center py-8 text-gray-500">
                  <div className="text-4xl mb-2">üìÖ</div>
                  <p>No deadlines pending</p>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* REPORTS SECTION */}
      {activeSection === 'reports' && (
        <div className="space-y-4">
          <div className="bg-white rounded-lg shadow p-4">
            <h3 className="text-sm font-bold text-gray-800 mb-3">üìà PM Reports</h3>

            {/* Summary Stats */}
            <div className="grid grid-cols-4 gap-4 mb-6">
              <div className="bg-blue-50 rounded-lg p-4 text-center">
                <div className="text-3xl font-bold text-blue-600">{stats.totalProjects}</div>
                <div className="text-xs text-gray-600">Total de Projetos</div>
              </div>
              <div className="bg-green-50 rounded-lg p-4 text-center">
                <div className="text-3xl font-bold text-green-600">
                  {stats.totalProjects > 0 ? Math.round((stats.completed / stats.totalProjects) * 100) : 0}%
                </div>
                <div className="text-xs text-gray-600">Taxa de Conclus√£o</div>
              </div>
              <div className="bg-blue-50 rounded-lg p-4 text-center">
                <div className="text-3xl font-bold text-blue-600">
                  {stats.totalProjects > 0 ? Math.round((stats.onTime / stats.totalProjects) * 100) : 0}%
                </div>
                <div className="text-xs text-gray-600">On-Time Delivery</div>
              </div>
              <div className="bg-blue-50 rounded-lg p-4 text-center">
                <div className="text-3xl font-bold text-blue-600">{translators.length}</div>
                <div className="text-xs text-gray-600">Team Translators</div>
              </div>
            </div>

            {/* Status Distribution */}
            <div className="mb-6">
              <h4 className="text-xs font-medium text-gray-600 mb-2">Status Distribution</h4>
              <div className="flex h-6 rounded-lg overflow-hidden">
                {[
                  { status: 'received', color: 'bg-gray-400', count: orders.filter(o => o.translation_status === 'received').length },
                  { status: 'in_translation', color: 'bg-yellow-500', count: stats.inProgress },
                  { status: 'review', color: 'bg-blue-500', count: stats.awaitingReview },
                  { status: 'ready', color: 'bg-green-500', count: orders.filter(o => o.translation_status === 'ready').length },
                  { status: 'delivered', color: 'bg-blue-500', count: orders.filter(o => o.translation_status === 'delivered').length }
                ].map(item => (
                  item.count > 0 && (
                    <div
                      key={item.status}
                      className={`${item.color} flex items-center justify-center text-white text-[10px]`}
                      style={{ width: `${(item.count / stats.totalProjects) * 100}%` }}
                      title={`${item.status}: ${item.count}`}
                    >
                      {item.count}
                    </div>
                  )
                ))}
              </div>
              <div className="flex justify-between text-[9px] text-gray-500 mt-1">
                <span>Received</span>
                <span>In Translation</span>
                <span>Review</span>
                <span>Ready</span>
                <span>Delivered</span>
              </div>
            </div>

            {/* Translator Performance */}
            <div>
              <h4 className="text-xs font-medium text-gray-600 mb-2">Translator Performance</h4>
              <table className="w-full text-xs">
                <thead>
                  <tr className="border-b bg-gray-50">
                    <th className="text-left py-2 px-2">Translator</th>
                    <th className="text-center py-2 px-2">Active</th>
                    <th className="text-center py-2 px-2">Completed</th>
                    <th className="text-center py-2 px-2">On Time</th>
                  </tr>
                </thead>
                <tbody>
                  {translators.map(translator => {
                    const tOrders = orders.filter(o =>
                      o.assigned_translator_id === translator.id ||
                      o.assigned_translator === translator.name
                    );
                    const active = tOrders.filter(o => ['in_translation', 'review'].includes(o.translation_status)).length;
                    const completed = tOrders.filter(o => ['ready', 'delivered'].includes(o.translation_status)).length;
                    const onTimeCount = tOrders.filter(o => {
                      if (!o.deadline) return true;
                      return new Date(o.deadline) >= new Date() || ['ready', 'delivered'].includes(o.translation_status);
                    }).length;

                    return (
                      <tr key={translator.id} className="border-b hover:bg-gray-50">
                        <td className="py-2 px-2">{translator.name}</td>
                        <td className="py-2 px-2 text-center">
                          <span className="px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded">{active}</span>
                        </td>
                        <td className="py-2 px-2 text-center">
                          <span className="px-2 py-0.5 bg-green-100 text-green-700 rounded">{completed}</span>
                        </td>
                        <td className="py-2 px-2 text-center">
                          <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded">
                            {tOrders.length > 0 ? Math.round((onTimeCount / tOrders.length) * 100) : 100}%
                          </span>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      )}

      {/* MESSAGES SECTION */}
      {activeSection === 'messages' && (
        <div className="space-y-4">
          <div className="bg-white rounded-lg shadow p-4">
            <h3 className="text-sm font-bold text-gray-800 mb-3">üí¨ Communication with Translators</h3>

            <div className="grid grid-cols-3 gap-4">
              {/* Translator List */}
              <div className="border rounded-lg p-3">
                <h4 className="text-xs font-medium text-gray-600 mb-2">Select Translator</h4>
                <div className="space-y-1 max-h-80 overflow-y-auto">
                  {translators.length > 0 ? (
                    translators.map(translator => (
                      <button
                        key={translator.id}
                        onClick={() => setSelectedTranslator(translator)}
                        className={`w-full text-left px-3 py-2 rounded text-xs transition-colors ${
                          selectedTranslator?.id === translator.id
                            ? 'bg-blue-500 text-white'
                            : 'hover:bg-gray-100 border border-gray-100'
                        }`}
                      >
                        <div className="font-medium">{translator.name}</div>
                        <div className="text-[10px] opacity-70">{translator.email}</div>
                      </button>
                    ))
                  ) : (
                    <div className="text-center py-4 text-gray-400 text-xs">
                      <p>No translator registered.</p>
                      <p className="mt-1">Register translators in the "Translators" tab.</p>
                    </div>
                  )}
                </div>
              </div>

              {/* Message Area */}
              <div className="col-span-2 border rounded-lg p-3">
                {selectedTranslator ? (
                  <>
                    <h4 className="text-xs font-medium text-gray-600 mb-2">
                      Conversation with {selectedTranslator.name}
                    </h4>

                    {/* Messages */}
                    <div className="h-64 overflow-y-auto border rounded p-2 mb-2 bg-gray-50">
                      {messages
                        .filter(m => m.toId === selectedTranslator.id || m.from === selectedTranslator.name)
                        .map(msg => (
                          <div
                            key={msg.id}
                            className={`mb-2 p-2 rounded text-xs ${
                              msg.from === user?.name
                                ? 'bg-blue-100 ml-8'
                                : 'bg-white mr-8 border'
                            }`}
                          >
                            <div className="font-medium text-[10px] text-gray-500 mb-1">
                              {msg.from} ‚Ä¢ {new Date(msg.timestamp).toLocaleString('en-US', { timeZone: 'America/New_York' })}
                            </div>
                            <div className="whitespace-pre-wrap">{msg.content}</div>
                          </div>
                        ))}
                      {messages.filter(m => m.toId === selectedTranslator.id || m.from === selectedTranslator.name).length === 0 && (
                        <div className="text-center py-8 text-gray-400 text-xs">
                          No messages yet
                        </div>
                      )}
                    </div>

                    {/* Send Message */}
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={newMessage}
                        onChange={(e) => setNewMessage(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                        placeholder="Type your message..."
                        className="flex-1 px-3 py-2 border rounded text-xs"
                      />
                      <button
                        onClick={sendMessage}
                        className="px-4 py-2 bg-blue-500 text-white rounded text-xs hover:bg-blue-600"
                      >
                        Send
                      </button>
                    </div>
                  </>
                ) : (
                  <div className="h-full flex items-center justify-center text-gray-400">
                    <div className="text-center">
                      <div className="text-3xl mb-2">üëà</div>
                      <p className="text-xs">Select a translator to start a conversation</p>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* TRANSLATOR ASSIGNMENT MODAL - For sending email invites */}
      {assigningTranslatorModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div className="p-4 border-b flex justify-between items-center bg-blue-600 text-white rounded-t-lg">
              <div>
                <h3 className="font-bold">üìß Email Invite to Translator</h3>
                <p className="text-xs opacity-80">{assigningTranslatorModal.order_number} - {assigningTranslatorModal.client_name}</p>
              </div>
              <button onClick={() => setAssigningTranslatorModal(null)} className="text-white hover:text-gray-200 text-xl">√ó</button>
            </div>

            <div className="p-4 space-y-4">
              {/* Project Info */}
              <div className="p-3 bg-gray-50 rounded border text-xs">
                <div className="grid grid-cols-2 gap-2">
                  <div>
                    <span className="text-gray-500">Language:</span>
                    <span className="ml-1 font-medium">{assignmentDetails.language_pair}</span>
                  </div>
                  <div>
                    <span className="text-gray-500">Pages:</span>
                    <span className="ml-1 font-medium">{assigningTranslatorModal.page_count || 1}</span>
                  </div>
                </div>
              </div>

              {/* Select Translator */}
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Select Translator *</label>
                <select
                  value={assignmentDetails.translator_id}
                  onChange={(e) => setAssignmentDetails({...assignmentDetails, translator_id: e.target.value})}
                  className="w-full px-3 py-2 border rounded text-sm"
                >
                  <option value="">-- Choose Translator --</option>
                  {translators.filter(t => t.is_active !== false).map(t => (
                    <option key={t.id} value={t.id}>
                      {t.name} {t.language_pairs ? `(${t.language_pairs})` : ''} {t.rate_per_page ? `- $${t.rate_per_page}/pg` : ''}
                    </option>
                  ))}
                </select>
                {translators.length === 0 && (
                  <p className="text-[10px] text-blue-600 mt-1">No translators found. Register translators in the Users tab first.</p>
                )}
              </div>

              {/* Translator Deadline */}
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-medium text-gray-700 mb-1">Translator Deadline</label>
                  <input
                    type="date"
                    value={assignmentDetails.due_date}
                    onChange={(e) => setAssignmentDetails({...assignmentDetails, due_date: e.target.value})}
                    className="w-full px-3 py-2 border rounded text-sm"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-700 mb-1">Time</label>
                  <input
                    type="time"
                    value={assignmentDetails.due_time}
                    onChange={(e) => setAssignmentDetails({...assignmentDetails, due_time: e.target.value})}
                    className="w-full px-3 py-2 border rounded text-sm"
                  />
                </div>
              </div>

              {/* Notes */}
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Notes for Translator</label>
                <textarea
                  value={assignmentDetails.project_notes}
                  onChange={(e) => setAssignmentDetails({...assignmentDetails, project_notes: e.target.value})}
                  className="w-full px-3 py-2 border rounded text-sm"
                  rows="2"
                  placeholder="Special instructions for the translator..."
                />
              </div>

              {/* Info */}
              <div className="p-2 bg-blue-50 rounded text-xs text-blue-700">
                <span className="font-medium">üìß Email Invitation:</span> The translator will receive an email with accept/decline links. You will be notified of their response.
              </div>
            </div>

            <div className="p-3 border-t bg-gray-50 flex justify-end gap-2 rounded-b-lg">
              <button
                onClick={() => setAssigningTranslatorModal(null)}
                className="px-4 py-1.5 text-gray-600 text-sm hover:text-gray-800"
              >
                Cancel
              </button>
              <button
                onClick={sendTranslatorAssignment}
                disabled={sendingAssignment || !assignmentDetails.translator_id}
                className="px-4 py-1.5 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:bg-gray-400"
              >
                {sendingAssignment ? 'Sending...' : 'üì§ Send Invitation'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* PROJECT FILES MODAL - For assigning translators to files */}
      {selectedProject && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[80vh] flex flex-col">
            {/* Header */}
            <div className="p-4 border-b flex justify-between items-center bg-gradient-to-r from-teal-600 to-teal-700 text-white rounded-t-lg">
              <div>
                <h3 className="font-bold">üìÅ Project Files {selectedProject.order_number}</h3>
                <p className="text-xs opacity-80">{selectedProject.client_name} ‚Ä¢ {selectedProject.translate_from} ‚Üí {selectedProject.translate_to}</p>
              </div>
              <button onClick={() => { setSelectedProject(null); setProjectTrDeadline({ date: '', time: '17:00' }); }} className="text-white hover:text-gray-200 text-xl">√ó</button>
            </div>

            {/* Content */}
            <div className="p-4 overflow-y-auto flex-1">
              {/* SEND COMPLETE PROJECT - Single invitation for all files */}
              {!loadingProjectDocs && projectDocuments.length > 0 && (
                <div className="mb-4 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg">
                  <div className="flex items-center gap-2 mb-2">
                    <span className="text-xl">üì¶</span>
                    <h4 className="font-bold text-green-800">Send Complete Project</h4>
                    <span className="text-xs bg-green-600 text-white px-2 py-0.5 rounded">Recommended</span>
                  </div>
                  <p className="text-xs text-green-700 mb-3">
                    Send all {projectDocuments.length} file(s) to a single translator with ONE invitation.
                    The translator will receive a single email with all files listed.
                  </p>
                  <div className="space-y-3">
                    {/* Translator Selection */}
                    <div className="flex items-center gap-2">
                      <select
                        value={projectTranslatorId}
                        onChange={(e) => setProjectTranslatorId(e.target.value)}
                        className="flex-1 px-3 py-2 text-sm border-2 border-green-300 rounded-lg bg-white focus:border-green-500 focus:outline-none"
                      >
                        <option value="">-- Select Translator for Entire Project --</option>
                        {translators.map(t => (
                          <option key={t.id} value={t.id}>{t.name} ({t.email})</option>
                        ))}
                      </select>
                    </div>

                    {/* TR Deadline Selection */}
                    <div className="flex items-center gap-2 p-2 bg-white rounded-lg border border-green-200">
                      <span className="text-sm text-green-700 font-medium whitespace-nowrap">TR Deadline:</span>
                      <input
                        type="date"
                        value={projectTrDeadline.date}
                        onChange={(e) => setProjectTrDeadline(prev => ({ ...prev, date: e.target.value }))}
                        className="flex-1 px-2 py-1.5 text-sm border border-green-300 rounded bg-white focus:border-green-500 focus:outline-none"
                        placeholder="Select date"
                      />
                      <input
                        type="time"
                        value={projectTrDeadline.time}
                        onChange={(e) => setProjectTrDeadline(prev => ({ ...prev, time: e.target.value }))}
                        className="w-24 px-2 py-1.5 text-sm border border-green-300 rounded bg-white focus:border-green-500 focus:outline-none"
                      />
                      <span className="text-xs text-gray-500">(Optional)</span>
                    </div>

                    {/* Send Button */}
                    <button
                      onClick={sendCompleteProject}
                      disabled={!projectTranslatorId || sendingCompleteProject}
                      className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                      {sendingCompleteProject ? (
                        <>
                          <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                          Sending...
                        </>
                      ) : (
                        <>Send All {projectDocuments.length} Files</>
                      )}
                    </button>
                  </div>
                </div>
              )}

              {/* Divider */}
              {!loadingProjectDocs && projectDocuments.length > 0 && (
                <div className="flex items-center gap-3 mb-4">
                  <div className="flex-1 border-t border-gray-300"></div>
                  <span className="text-xs text-gray-400 font-medium">OR assign files individually</span>
                  <div className="flex-1 border-t border-gray-300"></div>
                </div>
              )}

              <p className="text-xs text-gray-500 mb-3">Select a translator for each file. Different files can be assigned to different translators.</p>

              {loadingProjectDocs ? (
                <div className="text-center py-8 text-gray-500">
                  <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
                  Loading files...
                </div>
              ) : projectDocuments.length > 0 ? (
                <div className="space-y-3">
                  {projectDocuments.map((doc, idx) => (
                    <div key={doc.id || idx} className="p-3 bg-gray-50 rounded-lg border">
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-2">
                          <span className="text-xl">
                            {doc.filename?.endsWith('.pdf') ? 'üìï' : doc.filename?.match(/\.(jpg|jpeg|png)$/i) ? 'üñºÔ∏è' : 'üìÑ'}
                          </span>
                          <div>
                            <div className="text-sm font-medium">{doc.filename || 'Document'}</div>
                            <div className="text-[10px] text-gray-500">
                              {doc.source === 'manual_upload' ? 'Manual upload' : 'Partner portal'}
                            </div>
                          </div>
                        </div>
                        <div className="flex items-center gap-2">
                          <button
                            onClick={() => downloadProjectDocument(doc.id, doc.filename)}
                            className="px-3 py-1.5 bg-blue-600 text-white rounded text-xs hover:bg-blue-700"
                          >
                            ‚¨áÔ∏è Download
                          </button>
                          <button
                            onClick={() => deleteProjectDocument(doc.id, doc.filename)}
                            className="px-2 py-1.5 bg-red-500 text-white rounded text-xs hover:bg-red-600"
                            title="Excluir documento"
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                      </div>

                      {/* Translator Assignment */}
                      <div className="flex items-center gap-2 pt-2 border-t border-gray-200">
                        <span className="text-xs text-gray-500">Atribuir to:</span>
                        <select
                          value={fileAssignments[doc.id]?.id || doc.assigned_translator_id || ''}
                          onChange={(e) => {
                            // Compare as strings to handle type mismatch
                            const selected = translators.find(t => String(t.id) === String(e.target.value));
                            if (selected) {
                              assignTranslatorToFile(doc.id, selected.id, selected.name);
                            }
                          }}
                          className="flex-1 px-2 py-1.5 text-xs border rounded bg-white"
                        >
                          <option value="">-- Select o Translator --</option>
                          {translators.map(t => (
                            <option key={t.id} value={t.id}>{t.name}</option>
                          ))}
                        </select>
                        {(fileAssignments[doc.id]?.id || doc.assigned_translator_id) && (
                          <>
                            <button
                              onClick={() => sendFileTranslatorInvite(
                                doc,
                                fileAssignments[doc.id]?.id || doc.assigned_translator_id,
                                fileAssignments[doc.id]?.name || doc.assigned_translator_name
                              )}
                              disabled={sendingFileInvite[doc.id]}
                              className="px-2 py-1 bg-blue-600 text-white rounded text-[10px] hover:bg-blue-700 disabled:bg-gray-400 flex items-center gap-1"
                              title="Send email invitation to translator"
                            >
                              {sendingFileInvite[doc.id] ? '...' : 'üìß Send'}
                            </button>
                            <span className="text-xs text-green-600 font-medium">‚úì Atribu√≠do</span>
                          </>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8 text-gray-400">
                  <div className="text-4xl mb-2">üì≠</div>
                  <p className="text-sm">No file found in this project</p>
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end">
              <button
                onClick={() => { setSelectedProject(null); setProjectTrDeadline({ date: '', time: '17:00' }); }}
                className="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
              >
                Fechar
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ==================== SALES CONTROL PAGE ====================
const SalesControlPage = ({ adminKey }) => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [salespeople, setSalespeople] = useState([]);
  const [acquisitions, setAcquisitions] = useState([]);
  const [goals, setGoals] = useState([]);
  const [dashboard, setDashboard] = useState({
    total_salespeople: 0,
    month_acquisitions: 0,
    total_acquisitions: 0,
    pending_commissions: 0,
    paid_commissions: 0,
    top_performers: [],
    monthly_trend: [],
    tier_distribution: { bronze: 0, silver: 0, gold: 0, platinum: 0 }
  });
  const [loading, setLoading] = useState(true);
  const [showAddSalesperson, setShowAddSalesperson] = useState(false);
  const [showAddAcquisition, setShowAddAcquisition] = useState(false);
  const [showSetGoal, setShowSetGoal] = useState(false);
  const [editingSalesperson, setEditingSalesperson] = useState(null);
  const [ranking, setRanking] = useState([]);
  const [pendingPayments, setPendingPayments] = useState([]);
  const [paymentHistory, setPaymentHistory] = useState([]);
  const [showPaymentModal, setShowPaymentModal] = useState(null);
  const [paymentForm, setPaymentForm] = useState({ method: 'bank_transfer', reference: '', notes: '' });

  // Form states
  const [newSalesperson, setNewSalesperson] = useState({
    name: '', email: '', phone: '', country_code: '+1', commission_type: 'tier', commission_rate: 0, base_salary: 0, monthly_target: 10, referral_bonus: 0, preferred_language: 'en'
  });
  const [createdSalesperson, setCreatedSalesperson] = useState(null); // For success modal with referral link
  const [newAcquisition, setNewAcquisition] = useState({
    salesperson_id: '', partner_id: '', partner_name: '', partner_tier: 'bronze', notes: ''
  });
  const [newGoal, setNewGoal] = useState({
    salesperson_id: '', month: new Date().toISOString().slice(0, 7), target_partners: 10, target_revenue: 5000
  });

  // Strip trailing /api if present to avoid double /api in endpoint paths
  const API_URL = (process.env.REACT_APP_API_URL || '').replace(/\/api\/?$/, '');

  useEffect(() => {
    fetchAllData();
  }, []);

  const fetchAllData = async () => {
    setLoading(true);
    try {
      const [spRes, acqRes, goalsRes, dashRes, rankRes, pendingRes, historyRes] = await Promise.all([
        fetch(`${API_URL}/api/admin/salespeople`, { headers: { 'admin-key': adminKey } }),
        fetch(`${API_URL}/api/admin/partner-acquisitions`, { headers: { 'admin-key': adminKey } }),
        fetch(`${API_URL}/api/admin/sales-goals`, { headers: { 'admin-key': adminKey } }),
        fetch(`${API_URL}/api/admin/sales-dashboard`, { headers: { 'admin-key': adminKey } }),
        fetch(`${API_URL}/api/admin/salesperson-ranking`, { headers: { 'admin-key': adminKey } }),
        fetch(`${API_URL}/api/admin/pending-commissions`, { headers: { 'admin-key': adminKey } }),
        fetch(`${API_URL}/api/admin/payment-history`, { headers: { 'admin-key': adminKey } })
      ]);

      if (spRes.ok) setSalespeople(await spRes.json());
      if (acqRes.ok) setAcquisitions(await acqRes.json());
      if (goalsRes.ok) setGoals(await goalsRes.json());
      if (dashRes.ok) setDashboard(await dashRes.json());
      if (rankRes.ok) {
        const rankData = await rankRes.json();
        setRanking(rankData.rankings || []);
      }
      if (pendingRes.ok) {
        const pendingData = await pendingRes.json();
        setPendingPayments(pendingData.pending_by_salesperson || []);
      }
      if (historyRes.ok) {
        const historyData = await historyRes.json();
        setPaymentHistory(historyData.payments || []);
      }
    } catch (error) {
      console.error('Error fetching sales data:', error);
    }
    setLoading(false);
  };

  const handleAddSalesperson = async () => {
    try {
      // Combine country code with phone number
      const phoneWithCode = newSalesperson.phone ? `${newSalesperson.country_code} ${newSalesperson.phone}` : '';
      const salespersonData = { ...newSalesperson, phone: phoneWithCode };
      delete salespersonData.country_code; // Remove country_code field before sending

      const res = await fetch(`${API_URL}/api/admin/salespeople`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'admin-key': adminKey },
        body: JSON.stringify(salespersonData)
      });
      const data = await res.json();
      if (res.ok) {
        setShowAddSalesperson(false);
        setCreatedSalesperson(data.salesperson); // Show success modal with referral link
        setNewSalesperson({ name: '', email: '', phone: '', country_code: '+1', commission_type: 'tier', commission_rate: 0, base_salary: 0, monthly_target: 10, referral_bonus: 0, preferred_language: 'en' });
        fetchAllData();
      } else {
        showToast(`Error: ${data.detail || 'Failed to add salesperson'}`);
      }
    } catch (error) {
      console.error('Error adding salesperson:', error);
      showToast('Error adding salesperson. Please try again.');
    }
  };

  const handleUpdateSalesperson = async () => {
    try {
      const res = await fetch(`${API_URL}/api/admin/salespeople/${editingSalesperson.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'admin-key': adminKey },
        body: JSON.stringify(editingSalesperson)
      });
      const data = await res.json();
      if (res.ok) {
        showToast('Salesperson updated successfully!');
        setEditingSalesperson(null);
        fetchAllData();
      } else {
        showToast(`Error: ${data.detail || 'Failed to update salesperson'}`);
      }
    } catch (error) {
      console.error('Error updating salesperson:', error);
      showToast('Error updating salesperson. Please try again.');
    }
  };

  const handleDeleteSalesperson = async (id) => {
    if (!window.confirm('Are you sure you want to delete this salesperson?')) return;
    try {
      const res = await fetch(`${API_URL}/api/admin/salespeople/${id}`, {
        method: 'DELETE',
        headers: { 'admin-key': adminKey }
      });
      if (res.ok) fetchAllData();
    } catch (error) {
      console.error('Error deleting salesperson:', error);
    }
  };

  const handleInviteSalesperson = async (id) => {
    if (!window.confirm('Enviar email de convite para este vendedor?')) return;
    try {
      const res = await fetch(`${API_URL}/api/admin/salespeople/${id}/invite`, {
        method: 'POST',
        headers: { 'admin-key': adminKey }
      });
      const data = await res.json();
      if (res.ok) {
        showToast(`Convite enviado! Link: ${data.invite_link}`);
        fetchAllData();
      } else {
        showToast(data.detail || 'Falha ao enviar convite');
      }
    } catch (error) {
      console.error('Error inviting salesperson:', error);
      showToast('Erro ao enviar convite');
    }
  };

  const handleApproveCommission = async (acquisitionId) => {
    try {
      const res = await fetch(`${API_URL}/api/admin/acquisitions/${acquisitionId}/approve`, {
        method: 'PUT',
        headers: { 'admin-key': adminKey }
      });
      if (res.ok) {
        showToast('Comiss√£o aprovada! Vendedor ser√° notificado.');
        fetchAllData();
      }
    } catch (error) {
      console.error('Error approving commission:', error);
      showToast('Erro ao aprovar comiss√£o');
    }
  };

  const handleProcessPayment = async (spData) => {
    try {
      const formData = new FormData();
      formData.append('salesperson_id', spData.salesperson_id);
      formData.append('acquisition_ids', spData.acquisitions.map(a => a.id).join(','));
      formData.append('payment_method', paymentForm.method);
      formData.append('payment_reference', paymentForm.reference);
      formData.append('notes', paymentForm.notes);

      const res = await fetch(`${API_URL}/api/admin/commission-payments`, {
        method: 'POST',
        headers: { 'admin-key': adminKey },
        body: formData
      });

      if (res.ok) {
        showToast(`Pagamento de $${spData.total_amount.toFixed(2)} processado! Vendedor notificado.`);
        setShowPaymentModal(null);
        setPaymentForm({ method: 'bank_transfer', reference: '', notes: '' });
        fetchAllData();
      }
    } catch (error) {
      console.error('Error processing payment:', error);
      showToast('Erro ao processar pagamento');
    }
  };

  const handleAddAcquisition = async () => {
    try {
      const res = await fetch(`${API_URL}/api/admin/partner-acquisitions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'admin-key': adminKey },
        body: JSON.stringify(newAcquisition)
      });
      if (res.ok) {
        setShowAddAcquisition(false);
        setNewAcquisition({ salesperson_id: '', partner_id: '', partner_name: '', partner_tier: 'bronze', notes: '' });
        fetchAllData();
      }
    } catch (error) {
      console.error('Error adding acquisition:', error);
    }
  };

  const handleSetGoal = async () => {
    try {
      const res = await fetch(`${API_URL}/api/admin/sales-goals`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'admin-key': adminKey },
        body: JSON.stringify(newGoal)
      });
      if (res.ok) {
        setShowSetGoal(false);
        setNewGoal({ salesperson_id: '', month: new Date().toISOString().slice(0, 7), target_partners: 10, target_revenue: 5000 });
        fetchAllData();
      }
    } catch (error) {
      console.error('Error setting goal:', error);
    }
  };

  const handleUpdateCommissionStatus = async (acquisitionId, status) => {
    try {
      const res = await fetch(`${API_URL}/api/admin/partner-acquisitions/${acquisitionId}/status?status=${status}`, {
        method: 'PUT',
        headers: { 'admin-key': adminKey }
      });
      if (res.ok) fetchAllData();
    } catch (error) {
      console.error('Error updating commission status:', error);
    }
  };

  const tierColors = {
    bronze: 'bg-amber-600',
    silver: 'bg-gray-400',
    gold: 'bg-yellow-500',
    platinum: 'bg-purple-500'
  };

  const statusColors = {
    pending: 'bg-yellow-100 text-yellow-800',
    approved: 'bg-blue-100 text-blue-800',
    paid: 'bg-green-100 text-green-800'
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-full">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
      </div>
    );
  }

  return (
    <div className="p-6 bg-gray-50 min-h-full">
      {/* Header */}
      <div className="mb-6 flex justify-between items-start">
        <div>
          <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
            <span className="text-3xl">üìà</span> Sales Control & Goals
          </h1>
          <p className="text-gray-500 mt-1">Manage salespeople, track acquisitions, and monitor goals</p>
        </div>
        <div className="flex gap-2">
          <a
            href="/docs/PARTNER_PROGRAM_PRESENTATION.html"
            target="_blank"
            rel="noopener noreferrer"
            className="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all flex items-center gap-2 shadow-md"
          >
            <span>üìä</span> Partner Program Presentation
          </a>
          <a
            href="/docs/COMMISSION_GUIDE.html"
            target="_blank"
            rel="noopener noreferrer"
            className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-2"
          >
            <span>üìã</span> Commission Docs
          </a>
        </div>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 mb-6 border-b border-gray-200 overflow-x-auto">
        {[
          { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
          { id: 'salespeople', label: 'Vendedores', icon: 'üë•' },
          { id: 'acquisitions', label: 'Aquisi√ß√µes', icon: 'ü§ù' },
          { id: 'goals', label: 'Metas', icon: 'üéØ' },
          { id: 'ranking', label: 'Ranking', icon: 'üèÜ' },
          { id: 'payments', label: 'Pagamentos', icon: 'üí≥' }
        ].map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`px-4 py-2 font-medium transition-colors border-b-2 -mb-px ${
              activeTab === tab.id
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            <span className="mr-1">{tab.icon}</span> {tab.label}
          </button>
        ))}
      </div>

      {/* Dashboard Tab */}
      {activeTab === 'dashboard' && dashboard && (
        <div className="space-y-6">
          {/* Stats Cards */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <div className="bg-white rounded-xl shadow-sm p-5 border-l-4 border-blue-500">
              <p className="text-gray-500 text-sm">Active Salespeople</p>
              <p className="text-3xl font-bold text-gray-800">{dashboard.total_salespeople}</p>
            </div>
            <div className="bg-white rounded-xl shadow-sm p-5 border-l-4 border-green-500">
              <p className="text-gray-500 text-sm">This Month</p>
              <p className="text-3xl font-bold text-green-600">{dashboard.month_acquisitions}</p>
              <p className="text-xs text-gray-400">partners acquired</p>
            </div>
            <div className="bg-white rounded-xl shadow-sm p-5 border-l-4 border-purple-500">
              <p className="text-gray-500 text-sm">Total Acquisitions</p>
              <p className="text-3xl font-bold text-gray-800">{dashboard.total_acquisitions}</p>
            </div>
            <div className="bg-white rounded-xl shadow-sm p-5 border-l-4 border-yellow-500">
              <p className="text-gray-500 text-sm">Pending Commissions</p>
              <p className="text-3xl font-bold text-yellow-600">${dashboard.pending_commissions}</p>
            </div>
            <div className="bg-white rounded-xl shadow-sm p-5 border-l-4 border-emerald-500">
              <p className="text-gray-500 text-sm">Paid This Month</p>
              <p className="text-3xl font-bold text-emerald-600">${dashboard.paid_commissions}</p>
            </div>
          </div>

          {/* Charts Row */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Top Performers */}
            <div className="bg-white rounded-xl shadow-sm p-5">
              <h3 className="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <span>üèÜ</span> Top Performers This Month
              </h3>
              {dashboard.top_performers.length > 0 ? (
                <div className="space-y-3">
                  {dashboard.top_performers.map((performer, idx) => (
                    <div key={performer.salesperson_id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <div className="flex items-center gap-3">
                        <span className="text-2xl">{idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : 'üèÖ'}</span>
                        <div>
                          <p className="font-medium text-gray-800">{performer.name}</p>
                          <p className="text-sm text-gray-500">{performer.count} partners</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <p className="font-semibold text-green-600">${performer.commission}</p>
                        <p className="text-xs text-gray-400">commission</p>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-gray-400 text-center py-8">No acquisitions this month yet</p>
              )}
            </div>

            {/* Tier Distribution */}
            <div className="bg-white rounded-xl shadow-sm p-5">
              <h3 className="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <span>üìä</span> Partner Tiers Distribution
              </h3>
              <div className="space-y-4">
                {['platinum', 'gold', 'silver', 'bronze'].map(tier => {
                  const count = dashboard.tier_distribution[tier] || 0;
                  const total = Object.values(dashboard.tier_distribution).reduce((a, b) => a + b, 0) || 1;
                  const percentage = Math.round((count / total) * 100);
                  return (
                    <div key={tier}>
                      <div className="flex justify-between text-sm mb-1">
                        <span className="capitalize font-medium flex items-center gap-2">
                          {tier === 'platinum' ? 'üíé' : tier === 'gold' ? 'ü•á' : tier === 'silver' ? 'ü•à' : 'ü•â'}
                          {tier}
                        </span>
                        <span className="text-gray-500">{count} partners ({percentage}%)</span>
                      </div>
                      <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                        <div
                          className={`h-full ${tierColors[tier]} transition-all duration-500`}
                          style={{ width: `${percentage}%` }}
                        />
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>

          {/* Monthly Trend */}
          <div className="bg-white rounded-xl shadow-sm p-5">
            <h3 className="font-semibold text-gray-800 mb-4 flex items-center gap-2">
              <span>üìà</span> Monthly Acquisition Trend
            </h3>
            {dashboard.monthly_trend.length > 0 ? (
              <div className="flex items-end justify-between h-40 gap-2">
                {dashboard.monthly_trend.map(month => {
                  const maxAcq = Math.max(...dashboard.monthly_trend.map(m => m.acquisitions), 1);
                  const heightPercent = (month.acquisitions / maxAcq) * 100;
                  return (
                    <div key={month.month} className="flex-1 flex flex-col items-center">
                      <div className="w-full bg-gray-100 rounded-t-lg relative" style={{ height: '120px' }}>
                        <div
                          className="absolute bottom-0 w-full bg-gradient-to-t from-blue-500 to-blue-400 rounded-t-lg transition-all duration-500"
                          style={{ height: `${heightPercent}%` }}
                        />
                      </div>
                      <p className="text-xs text-gray-500 mt-2">{month.month.slice(5)}</p>
                      <p className="text-sm font-semibold text-gray-700">{month.acquisitions}</p>
                    </div>
                  );
                })}
              </div>
            ) : (
              <div className="text-center py-8 text-gray-400">
                <p>No data yet. Add salespeople and record acquisitions to see trends.</p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Salespeople Tab */}
      {activeTab === 'salespeople' && (
        <div>
          <div className="flex justify-between items-center mb-4">
            <h3 className="font-semibold text-gray-700">Salespeople ({salespeople.length})</h3>
            <button
              onClick={() => setShowAddSalesperson(true)}
              className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-2"
            >
              <span>‚ûï</span> Add Salesperson
            </button>
          </div>

          <div className="bg-white rounded-xl shadow-sm overflow-hidden">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Name</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Contact</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Commission Type</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Monthly Target</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">This Month</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Total</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {salespeople.map(sp => (
                  <tr key={sp.id} className="hover:bg-gray-50">
                    <td className="px-4 py-3">
                      <p className="font-medium text-gray-800">{sp.name}</p>
                      <p className="text-xs text-gray-400">Since {sp.hired_date}</p>
                    </td>
                    <td className="px-4 py-3">
                      <p className="text-sm text-gray-600">{sp.email}</p>
                      <p className="text-xs text-gray-400">{sp.phone}</p>
                      {sp.referral_code && (
                        <div className="flex items-center gap-1 mt-1">
                          <span className="text-xs text-purple-600 font-mono bg-purple-50 px-1 rounded">
                            {sp.referral_code}
                          </span>
                          <button
                            onClick={() => {
                              const link = `${window.location.origin}/#/partner?ref=${sp.referral_code}`;
                              navigator.clipboard.writeText(link);
                              showToast('Link copiado!\n' + link);
                            }}
                            className="text-xs text-purple-500 hover:text-purple-700"
                            title="Copiar link de referral"
                          >
                            üìã
                          </button>
                        </div>
                      )}
                    </td>
                    <td className="px-4 py-3">
                      <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium capitalize">
                        {sp.commission_type}
                      </span>
                      {sp.commission_type === 'fixed' && (
                        <span className="ml-2 text-sm text-gray-500">${sp.commission_rate}/partner</span>
                      )}
                      {sp.base_salary > 0 && (
                        <span className="ml-2 text-xs text-gray-400">Base: ${sp.base_salary}</span>
                      )}
                    </td>
                    <td className="px-4 py-3 text-center">
                      <span className="text-lg font-semibold text-gray-700">{sp.monthly_target}</span>
                    </td>
                    <td className="px-4 py-3 text-center">
                      <span className={`text-lg font-semibold ${sp.month_acquisitions >= sp.monthly_target ? 'text-green-600' : 'text-gray-700'}`}>
                        {sp.month_acquisitions}
                      </span>
                      {sp.month_acquisitions >= sp.monthly_target && <span className="ml-1">üéâ</span>}
                    </td>
                    <td className="px-4 py-3 text-center">
                      <span className="text-lg font-semibold text-purple-600">{sp.total_acquisitions}</span>
                    </td>
                    <td className="px-4 py-3">
                      <span className={`px-2 py-1 rounded text-xs font-medium ${sp.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>
                        {sp.status}
                      </span>
                    </td>
                    <td className="px-4 py-3">
                      <div className="flex gap-2">
                        {(!sp.password_hash || sp.status === 'pending') && (
                          <button
                            onClick={() => handleInviteSalesperson(sp.id)}
                            className="p-1 text-purple-500 hover:bg-purple-50 rounded"
                            title={sp.password_hash ? "Resend Invite" : "Send Invite"}
                          >
                            üìß
                          </button>
                        )}
                        {sp.password_hash && sp.status === 'active' && (
                          <span className="p-1 text-green-500" title="Account Active">
                            ‚úÖ
                          </span>
                        )}
                        <button
                          onClick={() => setEditingSalesperson(sp)}
                          className="p-1 text-blue-500 hover:bg-blue-50 rounded"
                          title="Edit"
                        >
                          ‚úèÔ∏è
                        </button>
                        <button
                          onClick={() => handleDeleteSalesperson(sp.id)}
                          className="p-1 text-red-500 hover:bg-red-50 rounded"
                          title="Delete"
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
            {salespeople.length === 0 && (
              <div className="text-center py-12 text-gray-400">
                <p className="text-4xl mb-2">üë•</p>
                <p>No salespeople yet. Add your first salesperson!</p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Acquisitions Tab */}
      {activeTab === 'acquisitions' && (
        <div>
          <div className="flex justify-between items-center mb-4">
            <h3 className="font-semibold text-gray-700">Aquisi√ß√µes de Parceiros ({acquisitions.length})</h3>
            <button
              onClick={() => setShowAddAcquisition(true)}
              className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2"
              disabled={salespeople.length === 0}
            >
              <span>ü§ù</span> Registrar Aquisi√ß√£o
            </button>
          </div>

          <div className="bg-white rounded-xl shadow-sm overflow-hidden">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Data</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Parceiro</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Tier</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Vendedor</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Comiss√£o</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">A√ß√µes</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {acquisitions.map(acq => (
                  <tr key={acq.id} className="hover:bg-gray-50">
                    <td className="px-4 py-3 text-sm text-gray-600">{acq.acquisition_date}</td>
                    <td className="px-4 py-3">
                      <p className="font-medium text-gray-800">{acq.partner_name}</p>
                      <p className="text-xs text-gray-400">ID: {acq.partner_id}</p>
                    </td>
                    <td className="px-4 py-3">
                      <span className={`px-3 py-1 rounded-full text-white text-xs font-medium ${tierColors[acq.partner_tier]}`}>
                        {acq.partner_tier === 'platinum' ? 'üíé' : acq.partner_tier === 'gold' ? 'ü•á' : acq.partner_tier === 'silver' ? 'ü•à' : 'ü•â'} {acq.partner_tier}
                      </span>
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-600">{acq.salesperson_name}</td>
                    <td className="px-4 py-3">
                      <span className="font-semibold text-green-600">${acq.commission_paid}</span>
                    </td>
                    <td className="px-4 py-3">
                      <span className={`px-2 py-1 rounded text-xs font-medium ${statusColors[acq.commission_status]}`}>
                        {acq.commission_status === 'pending' ? 'Pendente' : acq.commission_status === 'approved' ? 'Aprovado' : 'Pago'}
                      </span>
                    </td>
                    <td className="px-4 py-3">
                      <div className="flex gap-1">
                        {acq.commission_status === 'pending' && (
                          <button
                            onClick={() => handleApproveCommission(acq.id)}
                            className="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600"
                            title="Aprovar e notificar vendedor"
                          >
                            ‚úì Aprovar
                          </button>
                        )}
                        {acq.commission_status === 'approved' && (
                          <span className="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded">
                            Aguardando pagamento
                          </span>
                        )}
                        {acq.commission_status === 'paid' && (
                          <span className="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">
                            ‚úì Pago
                          </span>
                        )}
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
            {acquisitions.length === 0 && (
              <div className="text-center py-12 text-gray-400">
                <p className="text-4xl mb-2">ü§ù</p>
                <p>Nenhuma aquisi√ß√£o registrada ainda</p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Goals Tab */}
      {activeTab === 'goals' && (
        <div>
          <div className="flex justify-between items-center mb-4">
            <h3 className="font-semibold text-gray-700">Sales Goals</h3>
            <button
              onClick={() => setShowSetGoal(true)}
              className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors flex items-center gap-2"
              disabled={salespeople.length === 0}
            >
              <span>üéØ</span> Set Goal
            </button>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {goals.map(goal => {
              const progress = Math.min((goal.achieved_partners / goal.target_partners) * 100, 100);
              const isAchieved = goal.achieved_partners >= goal.target_partners;
              return (
                <div key={goal.id} className={`bg-white rounded-xl shadow-sm p-5 border-2 ${isAchieved ? 'border-green-500' : 'border-transparent'}`}>
                  <div className="flex justify-between items-start mb-4">
                    <div>
                      <p className="font-semibold text-gray-800">{goal.salesperson_name}</p>
                      <p className="text-sm text-gray-500">{goal.month}</p>
                    </div>
                    {isAchieved && <span className="text-2xl">üèÜ</span>}
                  </div>

                  <div className="mb-4">
                    <div className="flex justify-between text-sm mb-1">
                      <span className="text-gray-500">Progress</span>
                      <span className="font-medium">{goal.achieved_partners} / {goal.target_partners}</span>
                    </div>
                    <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                      <div
                        className={`h-full transition-all duration-500 ${isAchieved ? 'bg-green-500' : 'bg-blue-500'}`}
                        style={{ width: `${progress}%` }}
                      />
                    </div>
                  </div>

                  <div className="flex justify-between text-sm">
                    <span className="text-gray-500">Target Revenue</span>
                    <span className="font-medium text-gray-700">${goal.target_revenue}</span>
                  </div>
                </div>
              );
            })}
          </div>
          {goals.length === 0 && (
            <div className="text-center py-12 text-gray-400 bg-white rounded-xl">
              <p className="text-4xl mb-2">üéØ</p>
              <p>Nenhuma meta definida. Defina metas para seus vendedores!</p>
            </div>
          )}
        </div>
      )}

      {/* Ranking Tab */}
      {activeTab === 'ranking' && (
        <div className="space-y-6">
          <div className="bg-gradient-to-r from-yellow-500 via-yellow-400 to-amber-500 rounded-xl p-6 text-white">
            <h2 className="text-2xl font-bold flex items-center gap-3">
              <span className="text-4xl">üèÜ</span> Ranking de Vendedores
            </h2>
            <p className="text-yellow-100 mt-2">Desempenho do m√™s atual</p>
          </div>

          <div className="bg-white rounded-xl shadow-sm overflow-hidden">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Posi√ß√£o</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Vendedor</th>
                  <th className="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Este M√™s</th>
                  <th className="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Meta</th>
                  <th className="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Progresso</th>
                  <th className="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Total Ganho</th>
                  <th className="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Pendente</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {ranking.map((r, idx) => (
                  <tr key={r.id} className={`hover:bg-gray-50 ${idx < 3 ? 'bg-yellow-50' : ''}`}>
                    <td className="px-4 py-4">
                      <span className="text-2xl">
                        {r.rank === 1 ? 'ü•á' : r.rank === 2 ? 'ü•à' : r.rank === 3 ? 'ü•â' : `#${r.rank}`}
                      </span>
                    </td>
                    <td className="px-4 py-4">
                      <p className="font-semibold text-gray-800">{r.name}</p>
                      <p className="text-xs text-gray-400">{r.email}</p>
                      <span className="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded capitalize">{r.commission_type}</span>
                    </td>
                    <td className="px-4 py-4 text-center">
                      <span className="text-2xl font-bold text-indigo-600">{r.month_acquisitions}</span>
                    </td>
                    <td className="px-4 py-4 text-center">
                      <span className="text-lg text-gray-600">{r.monthly_target}</span>
                    </td>
                    <td className="px-4 py-4">
                      <div className="w-full bg-gray-200 rounded-full h-3">
                        <div
                          className={`h-3 rounded-full transition-all ${r.target_progress >= 100 ? 'bg-green-500' : 'bg-indigo-500'}`}
                          style={{ width: `${Math.min(r.target_progress, 100)}%` }}
                        />
                      </div>
                      <p className="text-xs text-center mt-1 text-gray-500">{r.target_progress}%</p>
                    </td>
                    <td className="px-4 py-4 text-center">
                      <span className="text-lg font-semibold text-green-600">${r.total_earned}</span>
                    </td>
                    <td className="px-4 py-4 text-center">
                      <span className="text-lg font-semibold text-yellow-600">${r.pending_amount}</span>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
            {ranking.length === 0 && (
              <div className="text-center py-12 text-gray-400">
                <p className="text-4xl mb-2">üèÜ</p>
                <p>Nenhum vendedor ativo ainda.</p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Payments Tab */}
      {activeTab === 'payments' && (
        <div className="space-y-6">
          {/* Pending Payments Section */}
          <div className="bg-white rounded-xl shadow-sm p-6">
            <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
              <span>‚è≥</span> Comiss√µes Pendentes de Pagamento
            </h3>
            {pendingPayments.length > 0 ? (
              <div className="space-y-4">
                {pendingPayments.map(sp => (
                  <div key={sp.salesperson_id} className="border rounded-lg p-4 hover:bg-gray-50">
                    <div className="flex justify-between items-center mb-3">
                      <div>
                        <p className="font-semibold text-gray-800">{sp.salesperson_name}</p>
                        <p className="text-sm text-gray-500">{sp.salesperson_email}</p>
                      </div>
                      <div className="text-right">
                        <p className="text-2xl font-bold text-green-600">${sp.total_amount.toFixed(2)}</p>
                        <p className="text-xs text-gray-400">{sp.acquisitions.length} parceiros</p>
                      </div>
                    </div>
                    <div className="flex gap-2 flex-wrap mb-3">
                      {sp.acquisitions.map(acq => (
                        <span key={acq.id} className="px-2 py-1 bg-gray-100 rounded text-xs">
                          {acq.partner_name} - ${acq.commission_paid}
                        </span>
                      ))}
                    </div>
                    <button
                      onClick={() => setShowPaymentModal(sp)}
                      className="w-full py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-medium"
                    >
                      üí≥ Processar Pagamento
                    </button>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center py-8 text-gray-400">
                <p className="text-4xl mb-2">‚úÖ</p>
                <p>Nenhuma comiss√£o pendente de pagamento!</p>
                <p className="text-sm">Aprove comiss√µes na aba Aquisi√ß√µes primeiro.</p>
              </div>
            )}
          </div>

          {/* Payment History Section */}
          <div className="bg-white rounded-xl shadow-sm p-6">
            <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
              <span>üìú</span> Hist√≥rico de Pagamentos
            </h3>
            {paymentHistory.length > 0 ? (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Data</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Vendedor</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Valor</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">M√©todo</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Refer√™ncia</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-100">
                    {paymentHistory.map(payment => (
                      <tr key={payment.id} className="hover:bg-gray-50">
                        <td className="px-4 py-3 text-sm text-gray-600">
                          {new Date(payment.paid_at).toLocaleDateString('pt-BR')}
                        </td>
                        <td className="px-4 py-3 font-medium text-gray-800">{payment.salesperson_name}</td>
                        <td className="px-4 py-3 font-semibold text-green-600">${payment.total_amount.toFixed(2)}</td>
                        <td className="px-4 py-3">
                          <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs capitalize">
                            {payment.payment_method.replace('_', ' ')}
                          </span>
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-500">{payment.payment_reference || '-'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            ) : (
              <div className="text-center py-8 text-gray-400">
                <p className="text-4xl mb-2">üìú</p>
                <p>Nenhum pagamento realizado ainda.</p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Payment Modal */}
      {showPaymentModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl p-6 w-full max-w-md">
            <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
              <span>üí≥</span> Processar Pagamento
            </h3>
            <div className="bg-green-50 rounded-lg p-4 mb-4">
              <p className="text-sm text-gray-600">Vendedor:</p>
              <p className="font-semibold text-gray-800">{showPaymentModal.salesperson_name}</p>
              <p className="text-3xl font-bold text-green-600 mt-2">${showPaymentModal.total_amount.toFixed(2)}</p>
              <p className="text-xs text-gray-500">{showPaymentModal.acquisitions.length} comiss√µes</p>
            </div>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">M√©todo de Pagamento</label>
                <select
                  value={paymentForm.method}
                  onChange={(e) => setPaymentForm({...paymentForm, method: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"
                >
                  <option value="bank_transfer">Transfer√™ncia Banc√°ria</option>
                  <option value="zelle">Zelle</option>
                  <option value="paypal">PayPal</option>
                  <option value="check">Cheque</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Refer√™ncia/Comprovante</label>
                <input
                  type="text"
                  value={paymentForm.reference}
                  onChange={(e) => setPaymentForm({...paymentForm, reference: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"
                  placeholder="ID da transa√ß√£o, n√∫mero do cheque, etc."
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes</label>
                <textarea
                  value={paymentForm.notes}
                  onChange={(e) => setPaymentForm({...paymentForm, notes: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"
                  rows={2}
                  placeholder="Notas adicionais..."
                />
              </div>
            </div>
            <div className="flex justify-end gap-3 mt-6">
              <button
                onClick={() => setShowPaymentModal(null)}
                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
              >
                Cancelar
              </button>
              <button
                onClick={() => handleProcessPayment(showPaymentModal)}
                className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
              >
                Confirmar Pagamento
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Add Salesperson Modal */}
      {showAddSalesperson && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto">
          <div className="bg-white rounded-xl w-full max-w-md max-h-[90vh] flex flex-col my-auto">
            <div className="p-3 border-b">
              <h3 className="text-base font-semibold flex items-center gap-2">
                <span>üë§</span> Add Salesperson
              </h3>
            </div>
            <div className="p-3 overflow-y-auto flex-1 space-y-1.5">
              <div className="grid grid-cols-2 gap-2">
                <div>
                  <label className="block text-xs font-medium text-gray-700 mb-0.5">Name *</label>
                  <input
                    type="text"
                    value={newSalesperson.name}
                    onChange={(e) => setNewSalesperson({...newSalesperson, name: e.target.value})}
                    className="w-full px-2 py-1.5 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                    placeholder="John Doe"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-700 mb-0.5">Email *</label>
                  <input
                    type="email"
                    value={newSalesperson.email}
                    onChange={(e) => setNewSalesperson({...newSalesperson, email: e.target.value})}
                    className="w-full px-2 py-1.5 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                    placeholder="john@example.com"
                  />
                </div>
                <div className="col-span-2">
                  <label className="block text-xs font-medium text-gray-700 mb-0.5">Phone</label>
                  <div className="flex gap-1">
                    <select
                      value={newSalesperson.country_code}
                      onChange={(e) => setNewSalesperson({...newSalesperson, country_code: e.target.value})}
                      className="px-1 py-1.5 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm w-20"
                    >
                      <option value="+1">üá∫üá∏ +1</option>
                      <option value="+55">üáßüá∑ +55</option>
                    </select>
                    <input
                      type="text"
                      value={newSalesperson.phone}
                      onChange={(e) => setNewSalesperson({...newSalesperson, phone: e.target.value})}
                      className="flex-1 px-2 py-1.5 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                      placeholder="(555) 123-4567"
                    />
                  </div>
                </div>
                <div className="col-span-2">
                  <label className="block text-xs font-medium text-gray-700 mb-0.5">Tipo de Comiss√£o</label>
                  <select
                    value={newSalesperson.commission_type}
                    onChange={(e) => setNewSalesperson({...newSalesperson, commission_type: e.target.value})}
                    className="w-full px-2 py-1.5 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                  >
                    <option value="tier">Por Tier ($50-150/parceiro)</option>
                    <option value="fixed">Valor Fixo por Parceiro</option>
                    <option value="percentage">Percentual sobre Vendas</option>
                    <option value="referral_plus_commission">B√¥nus Referral + Comiss√£o %</option>
                  </select>
                </div>
                {newSalesperson.commission_type === 'fixed' && (
                  <div className="col-span-2">
                    <label className="block text-xs font-medium text-gray-700 mb-0.5">Comiss√£o Fixa ($)</label>
                    <input
                      type="number"
                      value={newSalesperson.commission_rate}
                      onChange={(e) => setNewSalesperson({...newSalesperson, commission_rate: parseFloat(e.target.value) || 0})}
                      className="w-full px-2 py-1.5 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                      placeholder="50"
                    />
                  </div>
                )}
                {newSalesperson.commission_type === 'percentage' && (
                  <div className="col-span-2">
                    <label className="block text-xs font-medium text-gray-700 mb-0.5">Comiss√£o (%)</label>
                    <input
                      type="number"
                      value={newSalesperson.commission_rate}
                      onChange={(e) => setNewSalesperson({...newSalesperson, commission_rate: parseFloat(e.target.value) || 0})}
                      className="w-full px-2 py-1.5 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                      placeholder="10"
                      min="0"
                      max="100"
                      step="0.5"
                    />
                  </div>
                )}
                {newSalesperson.commission_type === 'referral_plus_commission' && (
                  <>
                    <div>
                      <label className="block text-xs font-medium text-gray-700 mb-0.5">B√¥nus Referral ($)</label>
                      <input
                        type="number"
                        value={newSalesperson.referral_bonus}
                        onChange={(e) => setNewSalesperson({...newSalesperson, referral_bonus: parseFloat(e.target.value) || 0})}
                        className="w-full px-2 py-1.5 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                        placeholder="50"
                      />
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-gray-700 mb-0.5">Comiss√£o (%)</label>
                      <input
                        type="number"
                        value={newSalesperson.commission_rate}
                        onChange={(e) => setNewSalesperson({...newSalesperson, commission_rate: parseFloat(e.target.value) || 0})}
                        className="w-full px-2 py-1.5 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                        placeholder="5"
                        min="0"
                        max="100"
                        step="0.5"
                      />
                    </div>
                  </>
                )}
                <div>
                  <label className="block text-xs font-medium text-gray-700 mb-0.5">Base Salary ($)</label>
                  <input
                    type="number"
                    value={newSalesperson.base_salary}
                    onChange={(e) => setNewSalesperson({...newSalesperson, base_salary: parseFloat(e.target.value) || 0})}
                    className="w-full px-2 py-1.5 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                    placeholder="0"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-700 mb-0.5">Meta Mensal</label>
                  <input
                    type="number"
                    value={newSalesperson.monthly_target}
                    onChange={(e) => setNewSalesperson({...newSalesperson, monthly_target: parseInt(e.target.value) || 10})}
                    className="w-full px-2 py-1.5 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                    placeholder="10"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-700 mb-0.5">Idioma</label>
                  <select
                    value={newSalesperson.preferred_language}
                    onChange={(e) => setNewSalesperson({...newSalesperson, preferred_language: e.target.value})}
                    className="w-full px-2 py-1.5 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                  >
                    <option value="en">üá∫üá∏ English</option>
                    <option value="pt">üáßüá∑ Portugu√™s</option>
                    <option value="es">üá™üá∏ Espa√±ol</option>
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-700 mb-0.5">Status</label>
                  <select
                    value={newSalesperson.status || 'active'}
                    onChange={(e) => setNewSalesperson({...newSalesperson, status: e.target.value})}
                    className="w-full px-2 py-1.5 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                  >
                    <option value="active">Active</option>
                    <option value="pending">Pending</option>
                    <option value="inactive">Inactive</option>
                  </select>
                </div>
              </div>
            </div>
            <div className="p-3 border-t flex justify-end gap-2">
              <button
                onClick={() => setShowAddSalesperson(false)}
                className="px-3 py-1.5 text-gray-600 hover:bg-gray-100 rounded-lg text-sm"
              >
                Cancelar
              </button>
              <button
                onClick={handleAddSalesperson}
                disabled={!newSalesperson.name || !newSalesperson.email}
                className="px-3 py-1.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 text-sm"
              >
                Adicionar
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Success Modal - Show Referral Link */}
      {createdSalesperson && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl p-6 w-full max-w-md">
            <div className="text-center mb-4">
              <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <span className="text-3xl">‚úÖ</span>
              </div>
              <h3 className="text-lg font-semibold text-gray-900">Salesperson Criado!</h3>
              <p className="text-gray-600 mt-1">{createdSalesperson.name} foi cadastrado com sucesso.</p>
            </div>

            <div className="bg-gray-50 rounded-lg p-4 mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">C√≥digo de Referral</label>
              <div className="flex items-center gap-2">
                <code className="flex-1 bg-white px-3 py-2 rounded border text-lg font-mono font-bold text-blue-600">
                  {createdSalesperson.referral_code}
                </code>
                <button
                  onClick={() => {
                    navigator.clipboard.writeText(createdSalesperson.referral_code);
                    showToast('C√≥digo copiado!');
                  }}
                  className="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm"
                >
                  üìã
                </button>
              </div>
            </div>

            <div className="bg-blue-50 rounded-lg p-4 mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">Link de Referral para Parceiros</label>
              <div className="flex items-center gap-2">
                <input
                  type="text"
                  readOnly
                  value={`${window.location.origin}/#/partner/login?ref=${createdSalesperson.referral_code}`}
                  className="flex-1 bg-white px-3 py-2 rounded border text-sm"
                />
                <button
                  onClick={() => {
                    navigator.clipboard.writeText(`${window.location.origin}/#/partner/login?ref=${createdSalesperson.referral_code}`);
                    showToast('Link copiado!');
                  }}
                  className="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm"
                >
                  üìã Copiar
                </button>
              </div>
              <p className="text-xs text-gray-500 mt-2">
                Envie este link para o salesperson. Quando um parceiro se cadastrar usando este link, ser√° automaticamente vinculado a {createdSalesperson.name}.
              </p>
            </div>

            <button
              onClick={() => setCreatedSalesperson(null)}
              className="w-full px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900"
            >
              Fechar
            </button>
          </div>
        </div>
      )}

      {/* Edit Salesperson Modal */}
      {editingSalesperson && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl p-6 w-full max-w-md">
            <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
              <span>‚úèÔ∏è</span> Edit Salesperson
            </h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                <input
                  type="text"
                  value={editingSalesperson.name}
                  onChange={(e) => setEditingSalesperson({...editingSalesperson, name: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                <input
                  type="email"
                  value={editingSalesperson.email}
                  onChange={(e) => setEditingSalesperson({...editingSalesperson, email: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                <input
                  type="text"
                  value={editingSalesperson.phone}
                  onChange={(e) => setEditingSalesperson({...editingSalesperson, phone: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Commission Type</label>
                <select
                  value={editingSalesperson.commission_type}
                  onChange={(e) => setEditingSalesperson({...editingSalesperson, commission_type: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="tier">By Tier ($50-150/partner)</option>
                  <option value="fixed">Fixed Amount</option>
                  <option value="percentage">Percentage</option>
                  <option value="referral_plus_commission">Referral Bonus + Commission %</option>
                </select>
              </div>
              {editingSalesperson.commission_type === 'fixed' && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Fixed Commission ($)</label>
                  <input
                    type="number"
                    value={editingSalesperson.commission_rate}
                    onChange={(e) => setEditingSalesperson({...editingSalesperson, commission_rate: parseFloat(e.target.value)})}
                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              )}
              {editingSalesperson.commission_type === 'percentage' && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Commission Rate (%)</label>
                  <input
                    type="number"
                    value={editingSalesperson.commission_rate}
                    onChange={(e) => setEditingSalesperson({...editingSalesperson, commission_rate: parseFloat(e.target.value)})}
                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                    min="0"
                    max="100"
                    step="0.5"
                  />
                </div>
              )}
              {editingSalesperson.commission_type === 'referral_plus_commission' && (
                <>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Referral Bonus ($)</label>
                    <input
                      type="number"
                      value={editingSalesperson.referral_bonus || 0}
                      onChange={(e) => setEditingSalesperson({...editingSalesperson, referral_bonus: parseFloat(e.target.value) || 0})}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                      placeholder="50"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Commission Rate (%)</label>
                    <input
                      type="number"
                      value={editingSalesperson.commission_rate}
                      onChange={(e) => setEditingSalesperson({...editingSalesperson, commission_rate: parseFloat(e.target.value) || 0})}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                      placeholder="5"
                      min="0"
                      max="100"
                      step="0.5"
                    />
                  </div>
                </>
              )}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Base Salary ($)</label>
                <input
                  type="number"
                  value={editingSalesperson.base_salary}
                  onChange={(e) => setEditingSalesperson({...editingSalesperson, base_salary: parseFloat(e.target.value)})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Monthly Target</label>
                <input
                  type="number"
                  value={editingSalesperson.monthly_target}
                  onChange={(e) => setEditingSalesperson({...editingSalesperson, monthly_target: parseInt(e.target.value)})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select
                  value={editingSalesperson.status}
                  onChange={(e) => setEditingSalesperson({...editingSalesperson, status: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Preferred Language</label>
                <select
                  value={editingSalesperson.preferred_language || 'en'}
                  onChange={(e) => setEditingSalesperson({...editingSalesperson, preferred_language: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="en">English</option>
                  <option value="pt">Portugu√™s</option>
                  <option value="es">Espa√±ol</option>
                </select>
              </div>
            </div>
            <div className="flex justify-end gap-3 mt-6">
              <button
                onClick={() => setEditingSalesperson(null)}
                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
              >
                Cancel
              </button>
              <button
                onClick={handleUpdateSalesperson}
                className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
              >
                Save Changes
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Add Acquisition Modal */}
      {showAddAcquisition && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl p-6 w-full max-w-md">
            <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
              <span>ü§ù</span> Record Partner Acquisition
            </h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Salesperson *</label>
                <select
                  value={newAcquisition.salesperson_id}
                  onChange={(e) => setNewAcquisition({...newAcquisition, salesperson_id: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">Select salesperson...</option>
                  {salespeople.filter(sp => sp.status === 'active' || sp.status === 'pending').map(sp => (
                    <option key={sp.id} value={sp.id}>{sp.name} {sp.status === 'pending' ? '(Pending Setup)' : ''}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Partner Name *</label>
                <input
                  type="text"
                  value={newAcquisition.partner_name}
                  onChange={(e) => setNewAcquisition({...newAcquisition, partner_name: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="Immigration Law Office LLC"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Partner ID</label>
                <input
                  type="text"
                  value={newAcquisition.partner_id}
                  onChange={(e) => setNewAcquisition({...newAcquisition, partner_id: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="Optional - Partner system ID"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Partner Tier *</label>
                <select
                  value={newAcquisition.partner_tier}
                  onChange={(e) => setNewAcquisition({...newAcquisition, partner_tier: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="bronze">ü•â Bronze (10-29 pages/month) - $50 commission</option>
                  <option value="silver">ü•à Silver (30-59 pages/month) - $75 commission</option>
                  <option value="gold">ü•á Gold (60-99 pages/month) - $100 commission</option>
                  <option value="platinum">üíé Platinum (100+ pages/month) - $150 commission</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                <textarea
                  value={newAcquisition.notes}
                  onChange={(e) => setNewAcquisition({...newAcquisition, notes: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  rows={2}
                  placeholder="Optional notes..."
                />
              </div>
            </div>
            <div className="flex justify-end gap-3 mt-6">
              <button
                onClick={() => setShowAddAcquisition(false)}
                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
              >
                Cancel
              </button>
              <button
                onClick={handleAddAcquisition}
                disabled={!newAcquisition.salesperson_id || !newAcquisition.partner_name}
                className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50"
              >
                Record Acquisition
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Set Goal Modal */}
      {showSetGoal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl p-6 w-full max-w-md">
            <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
              <span>üéØ</span> Set Sales Goal
            </h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Salesperson *</label>
                <select
                  value={newGoal.salesperson_id}
                  onChange={(e) => setNewGoal({...newGoal, salesperson_id: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">Select salesperson...</option>
                  {salespeople.filter(sp => sp.status === 'active' || sp.status === 'pending').map(sp => (
                    <option key={sp.id} value={sp.id}>{sp.name} {sp.status === 'pending' ? '(Pending Setup)' : ''}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Month *</label>
                <input
                  type="month"
                  value={newGoal.month}
                  onChange={(e) => setNewGoal({...newGoal, month: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Target Partners</label>
                <input
                  type="number"
                  value={newGoal.target_partners}
                  onChange={(e) => setNewGoal({...newGoal, target_partners: parseInt(e.target.value)})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="10"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Target Revenue ($)</label>
                <input
                  type="number"
                  value={newGoal.target_revenue}
                  onChange={(e) => setNewGoal({...newGoal, target_revenue: parseFloat(e.target.value)})}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="5000"
                />
              </div>
            </div>
            <div className="flex justify-end gap-3 mt-6">
              <button
                onClick={() => setShowSetGoal(false)}
                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
              >
                Cancel
              </button>
              <button
                onClick={handleSetGoal}
                disabled={!newGoal.salesperson_id}
                className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 disabled:opacity-50"
              >
                Set Goal
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ==================== FLOATING CHAT WIDGET ====================
const FloatingChatWidget = ({ adminKey, user }) => {
  const [isOpen, setIsOpen] = useState(false);
  const [recipientType, setRecipientType] = useState('translator'); // 'translator' or 'partner'
  const [selectedRecipient, setSelectedRecipient] = useState('');
  const [messageContent, setMessageContent] = useState('');
  const [sending, setSending] = useState(false);
  const [translators, setTranslators] = useState([]);
  const [partners, setPartners] = useState([]);
  const [partnerUnreadCount, setPartnerUnreadCount] = useState(0);
  const [externalUnreadCount, setExternalUnreadCount] = useState(0);

  useEffect(() => {
    if (isOpen) {
      fetchRecipients();
    }
  }, [isOpen, recipientType]);

  useEffect(() => {
    // Fetch unread partner messages count
    const fetchUnread = async () => {
      try {
        // Partner messages
        const partnerResponse = await axios.get(`${API}/admin/partner-messages?admin_key=${adminKey}&limit=100`);
        const partnerUnread = (partnerResponse.data.messages || []).filter(m => !m.read).length;
        setPartnerUnreadCount(partnerUnread);

        // External messages (WhatsApp bot quotes pending review)
        const botResponse = await axios.get(`${API}/bot/quotes?admin_key=${adminKey}&status=pending`);
        const externalUnread = (botResponse.data.quotes || []).length;
        setExternalUnreadCount(externalUnread);
      } catch (err) {
        console.error('Failed to fetch unread count:', err);
      }
    };
    fetchUnread();
    const interval = setInterval(fetchUnread, 30000);
    return () => clearInterval(interval);
  }, [adminKey]);

  const fetchRecipients = async () => {
    try {
      if (recipientType === 'translator') {
        const response = await axios.get(`${API}/admin/users/by-role/translator?admin_key=${adminKey}`);
        setTranslators(response.data || []);
      } else {
        const response = await axios.get(`${API}/admin/partners?admin_key=${adminKey}`);
        setPartners(response.data.partners || []);
      }
    } catch (err) {
      console.error('Failed to fetch recipients:', err);
    }
  };

  const sendMessage = async () => {
    if (!selectedRecipient || !messageContent.trim()) return;
    setSending(true);
    try {
      if (recipientType === 'translator') {
        const translator = translators.find(t => t.id === selectedRecipient);
        await axios.post(`${API}/admin/translator-messages?admin_key=${adminKey}`, {
          translator_id: selectedRecipient,
          translator_name: translator?.name || 'Translator',
          translator_email: translator?.email || '',
          content: messageContent,
          admin_name: user?.name || 'Admin'
        });
      } else {
        // For partners, we'll create a notification/message
        const partner = partners.find(p => p.id === selectedRecipient);
        await axios.post(`${API}/admin/send-partner-notification?admin_key=${adminKey}`, {
          partner_id: selectedRecipient,
          partner_email: partner?.email || '',
          partner_name: partner?.company_name || partner?.contact_name || 'Partner',
          subject: 'Message from Legacy Translations',
          content: messageContent,
          admin_name: user?.name || 'Admin'
        });
      }
      showToast('Message sent successfully!');
      setMessageContent('');
      setSelectedRecipient('');
      setIsOpen(false);
    } catch (err) {
      console.error('Failed to send message:', err);
      showToast('Failed to send message. Please try again.');
    } finally {
      setSending(false);
    }
  };

  // Don't show for translators
  if (user?.role === 'translator') return null;

  return (
    <>
      {/* Floating Button */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-full shadow-lg hover:from-blue-700 hover:to-blue-800 flex items-center justify-center z-50 transition-all hover:scale-105"
      >
        {isOpen ? (
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        ) : (
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
        )}
        {/* Partner messages badge - top right (red) */}
        {partnerUnreadCount > 0 && !isOpen && (
          <span className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center shadow-lg border-2 border-white" title="Partner Messages">
            {partnerUnreadCount > 9 ? '9+' : partnerUnreadCount}
          </span>
        )}
        {/* External/WhatsApp messages badge - bottom right (green) - separated from partner badge */}
        {externalUnreadCount > 0 && !isOpen && (
          <span className="absolute -bottom-2 -right-2 w-6 h-6 bg-green-500 text-white text-xs font-bold rounded-full flex items-center justify-center shadow-lg border-2 border-white" title="WhatsApp Quotes">
            {externalUnreadCount > 9 ? '9+' : externalUnreadCount}
          </span>
        )}
      </button>

      {/* Chat Panel */}
      {isOpen && (
        <div className="fixed bottom-24 right-6 w-80 bg-white rounded-lg shadow-2xl z-50 overflow-hidden border border-gray-200">
          {/* Header */}
          <div className="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4">
            <h3 className="font-bold text-lg">Send Message</h3>
            <p className="text-xs text-blue-100">Contact translators or partners</p>
          </div>

          {/* Content */}
          <div className="p-4 space-y-4">
            {/* Recipient Type Toggle */}
            <div className="flex rounded-lg overflow-hidden border border-gray-200">
              <button
                onClick={() => { setRecipientType('translator'); setSelectedRecipient(''); }}
                className={`flex-1 py-2 text-sm font-medium transition-colors ${
                  recipientType === 'translator'
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-50 text-gray-600 hover:bg-gray-100'
                }`}
              >
                Translator
              </button>
              <button
                onClick={() => { setRecipientType('partner'); setSelectedRecipient(''); }}
                className={`flex-1 py-2 text-sm font-medium transition-colors ${
                  recipientType === 'partner'
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-50 text-gray-600 hover:bg-gray-100'
                }`}
              >
                Partner
              </button>
            </div>

            {/* Recipient Select */}
            <div>
              <label className="block text-xs font-medium text-gray-600 mb-1">
                Select {recipientType === 'translator' ? 'Translator' : 'Partner'}:
              </label>
              <select
                value={selectedRecipient}
                onChange={(e) => setSelectedRecipient(e.target.value)}
                className="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="">-- Select --</option>
                {recipientType === 'translator'
                  ? translators.map(t => (
                      <option key={t.id} value={t.id}>{t.name}</option>
                    ))
                  : partners.map(p => (
                      <option key={p.id} value={p.id}>{p.company_name || p.contact_name}</option>
                    ))
                }
              </select>
            </div>

            {/* Message */}
            <div>
              <label className="block text-xs font-medium text-gray-600 mb-1">Message:</label>
              <textarea
                value={messageContent}
                onChange={(e) => setMessageContent(e.target.value)}
                placeholder="Type your message..."
                className="w-full border rounded-lg px-3 py-2 text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                rows={4}
              />
            </div>

            {/* Send Button */}
            <button
              onClick={sendMessage}
              disabled={sending || !selectedRecipient || !messageContent.trim()}
              className="w-full py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
              {sending ? (
                <>
                  <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                  Sending...
                </>
              ) : (
                <>
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                  </svg>
                  Send Message
                </>
              )}
            </button>
          </div>
        </div>
      )}
    </>
  );
};

// ==================== MAIN APP ====================
function AdminApp() {
  const [adminKey, setAdminKey] = useState(null);
  const [user, setUser] = useState(null); // User info: { name, email, role, id }
  const [activeTab, setActiveTab] = useState('projects');
  const [selectedOrder, setSelectedOrder] = useState(null); // Order selected for translation

  // Multi-brand theme support (Legacy vs TRADUX)
  const [currentTheme, setCurrentTheme] = useState(() => {
    const savedTheme = localStorage.getItem('admin_theme');
    return savedTheme || 'legacy';
  });
  const theme = getTheme(currentTheme);

  // Save theme to localStorage when changed
  useEffect(() => {
    localStorage.setItem('admin_theme', currentTheme);
  }, [currentTheme]);

  // Global invoice notifications state
  const [globalInvoiceNotifications, setGlobalInvoiceNotifications] = useState([]);
  const [globalPendingZelle, setGlobalPendingZelle] = useState([]);
  const [globalUnreadCount, setGlobalUnreadCount] = useState(0);

  // Check for invite_token or reset_token in URL
  const urlParams = new URLSearchParams(window.location.search);
  const inviteToken = urlParams.get('invite_token');
  const resetToken = urlParams.get('reset_token');

  // Clear URL tometers after reading, but keep the #/admin hash
  const clearUrlParams = () => {
    window.history.replaceState({}, document.title, window.location.pathname + '#/admin');
  };

  // Get current path
  const isTranslationTool = window.location.pathname.includes('/admin/translation-tool');

  useEffect(() => {
    const savedKey = localStorage.getItem('admin_key');
    const savedUser = localStorage.getItem('admin_user');
    if (savedKey) {
      setAdminKey(savedKey);
      if (savedUser) {
        try {
          const parsedUser = JSON.parse(savedUser);
          setUser(parsedUser);
          // Set default tab based on role
          if (parsedUser.role === 'translator') {
            setActiveTab('translation');
          }
        } catch (e) {
          console.error('Error parsing saved user:', e);
        }
      }
    }
  }, []);

  const handleLogin = (userData) => {
    // userData can be: { adminKey, role, name, email, id, token }
    const key = userData.adminKey || userData.token;
    setAdminKey(key);
    setUser(userData);
    localStorage.setItem('admin_key', key);
    localStorage.setItem('admin_user', JSON.stringify(userData));

    // Set default tab based on role
    if (userData.role === 'translator') {
      setActiveTab('translation');
    } else if (userData.role === 'pm') {
      setActiveTab('pm-dashboard');
    }
  };

  const handleLogout = () => {
    // Clear local state immediately (don't wait for server)
    setAdminKey(null);
    setUser(null);
    localStorage.removeItem('admin_key');
    localStorage.removeItem('admin_user');

    // Try to notify server in background (fire and forget)
    if (user?.token) {
      axios.post(`${API}/admin/auth/logout?token=${user.token}`).catch(() => {});
    }

    window.location.href = '/#/admin';
  };

  // Global invoice notifications fetch
  const fetchGlobalInvoiceNotifications = async () => {
    if (!adminKey) return;
    try {
      const [notifRes, zelleRes] = await Promise.all([
        axios.get(`${API}/admin/invoice-notifications?admin_key=${adminKey}&unread_only=false`),
        axios.get(`${API}/admin/invoice-payments/pending-zelle?admin_key=${adminKey}`)
      ]);
      setGlobalInvoiceNotifications(notifRes.data.notifications || []);
      setGlobalUnreadCount(notifRes.data.unread_count || 0);
      setGlobalPendingZelle(zelleRes.data.invoices || []);
    } catch (err) {
      console.error('Failed to fetch global invoice notifications:', err);
    }
  };

  // Fetch notifications on login and periodically
  useEffect(() => {
    if (adminKey && user?.role === 'admin') {
      fetchGlobalInvoiceNotifications();
      // Refresh every 30 seconds
      const interval = setInterval(fetchGlobalInvoiceNotifications, 30000);
      return () => clearInterval(interval);
    }
  }, [adminKey, user]);

  // Navigate to translation with order
  const navigateToTranslation = (order) => {
    setSelectedOrder(order);
    setActiveTab('translation');
  };

  // Navigate back to projects
  const navigateToProjects = () => {
    setSelectedOrder(null);
    setActiveTab('projects');
  };

  const renderContent = () => {
    const userRole = user?.role || 'admin';

    switch (activeTab) {
      case 'pm-dashboard':
        return ['admin', 'pm'].includes(userRole)
          ? <PMDashboard adminKey={adminKey} user={user} onNavigateToTranslation={navigateToTranslation} />
          : <div className="p-6 text-center text-gray-500">Access denied</div>;
      case 'projects':
        return userRole !== 'translator'
          ? <ProjectsPage adminKey={adminKey} onTranslate={navigateToTranslation} user={user} />
          : <div className="p-6 text-center text-gray-500">Access denied</div>;
      case 'new-quote':
        return userRole !== 'translator'
          ? <NewQuotePage adminKey={adminKey} user={user} />
          : <div className="p-6 text-center text-gray-500">Access denied</div>;
      case 'translation':
        return <TranslationWorkspace adminKey={adminKey} selectedOrder={selectedOrder} onBack={navigateToProjects} user={user} />;
      case 'production':
        return userRole === 'admin'
          ? <ProductionPage adminKey={adminKey} />
          : <div className="p-6 text-center text-gray-500">Access denied</div>;
      case 'finances':
        return userRole === 'admin'
          ? <FinancesPage adminKey={adminKey} />
          : <div className="p-6 text-center text-gray-500">Access denied</div>;
      case 'followups':
        return ['admin', 'pm'].includes(userRole)
          ? <FollowupsPage adminKey={adminKey} />
          : <div className="p-6 text-center text-gray-500">Access denied</div>;
      case 'users':
        return ['admin', 'pm'].includes(userRole)
          ? <UsersPage adminKey={adminKey} user={user} />
          : <div className="p-6 text-center text-gray-500">Access denied</div>;
      case 'settings':
        return userRole === 'admin'
          ? <SettingsPage adminKey={adminKey} />
          : <div className="p-6 text-center text-gray-500">Access denied</div>;
      case 'sales-control':
        return userRole === 'admin'
          ? <SalesControlPage adminKey={adminKey} />
          : <div className="p-6 text-center text-gray-500">Access denied</div>;
      case 'mia-bot':
        return userRole === 'admin'
          ? (
            <div className="h-full flex flex-col bg-gray-100">
              <div className="bg-gradient-to-r from-purple-600 to-purple-700 text-white px-6 py-4 shadow-md">
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-3">
                    <span className="text-2xl">ü§ñ</span>
                    <div>
                      <h1 className="text-xl font-bold">MIA Bot - Assistente Virtual</h1>
                      <p className="text-purple-200 text-sm">Painel de controle e chat integrado</p>
                    </div>
                  </div>
                  <a
                    href="https://mia-atendimento-1.onrender.com/admin/controle/"
                    target="_blank"
                    rel="noopener noreferrer"
                    className="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm transition-colors"
                  >
                    Abrir em nova tab ‚Üó
                  </a>
                </div>
              </div>
              <div className="flex-1 p-4">
                <iframe
                  src="https://mia-atendimento-1.onrender.com/admin/controle/"
                  className="w-full h-full min-h-[600px] rounded-lg shadow-lg border-0"
                  title="MIA Bot Control Panel"
                  allow="microphone; camera"
                />
              </div>
            </div>
          )
          : <div className="p-6 text-center text-gray-500">Access denied</div>;
      default:
        return userRole !== 'translator'
          ? <ProjectsPage adminKey={adminKey} onTranslate={navigateToTranslation} user={user} />
          : <TranslationWorkspace adminKey={adminKey} selectedOrder={selectedOrder} onBack={navigateToProjects} user={user} />;
    }
  };

  // Handle invitation token - show set password page
  if (inviteToken) {
    return <SetPasswordPage inviteToken={inviteToken} onComplete={clearUrlParams} />;
  }

  // Handle reset token - show reset password page
  if (resetToken) {
    return <ResetPasswordPage resetToken={resetToken} onComplete={clearUrlParams} />;
  }

  // If not logged in
  if (!adminKey) {
    // Use TranslatorLogin for translation-tool route
    if (isTranslationTool) {
      return <TranslatorLogin onLogin={handleLogin} />;
    }
    return <AdminLogin onLogin={handleLogin} />;
  }

  // If translation-tool route, render standalone page
  if (isTranslationTool) {
    return <TranslationToolPage adminKey={adminKey} onLogout={handleLogout} user={user} />;
  }

  // If in translation workspace, render as full page without admin header
  if (activeTab === 'translation') {
    return <TranslationWorkspace adminKey={adminKey} selectedOrder={selectedOrder} onBack={navigateToProjects} user={user} />;
  }

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col">
      <TopBar
        activeTab={activeTab}
        setActiveTab={setActiveTab}
        onLogout={handleLogout}
        user={user}
        adminKey={adminKey}
        pendingZelleCount={globalPendingZelle.length}
        unreadNotifCount={globalUnreadCount}
        pendingZelleInvoices={globalPendingZelle}
        invoiceNotifications={globalInvoiceNotifications}
        onRefreshNotifications={fetchGlobalInvoiceNotifications}
        currentTheme={currentTheme}
        setCurrentTheme={setCurrentTheme}
        theme={theme}
      />
      <div className="flex-1 overflow-auto">{renderContent()}</div>
      <FloatingChatWidget adminKey={adminKey} user={user} />
      <ToastContainer />
    </div>
  );
}

export default AdminApp;
